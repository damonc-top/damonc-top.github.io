<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.4">Jekyll</generator><link href="https://www.damonc.top/feed.xml" rel="self" type="application/atom+xml" /><link href="https://www.damonc.top/" rel="alternate" type="text/html" /><updated>2025-09-25T04:06:16+00:00</updated><id>https://www.damonc.top/feed.xml</id><title type="html">ç¼–ç¨‹æ•£è®°</title><subtitle>ä¸ªäººçš„ä¸€ä¸ªæŠ€æœ¯åšå®¢ç«™ç‚¹ï¼Œè®°å½•ç”Ÿæ´»ã€å·¥ä½œã€å­¦ä¹ ä¸­çš„ä¸€äº›å°äº‹ï¼Œä»¥åŠä¸€äº›æ¯”è¾ƒæœ‰è¶£çš„äº‹æƒ…ï¼Œç•™ç‚¹ä»€ä¹ˆä¸œè¥¿ä¹ŸæŒºä¸é”™çš„ï¼Œå¶å°”ä¼šåœ¨è¿™é‡Œåœç•™ã€‚</subtitle><author><name>ç¼–ç¨‹æ•£è®°</name></author><entry><title type="html">æ”¹è¿›æˆ‘çš„æ€è€ƒæ¨¡å¼</title><link href="https://www.damonc.top/other/thinking_model.html" rel="alternate" type="text/html" title="æ”¹è¿›æˆ‘çš„æ€è€ƒæ¨¡å¼" /><published>2025-09-01T20:00:00+00:00</published><updated>2025-09-01T20:00:00+00:00</updated><id>https://www.damonc.top/other/thinking_model</id><content type="html" xml:base="https://www.damonc.top/other/thinking_model.html"><![CDATA[<p>â€ƒâ€ƒæœ€è¿‘æˆ‘åœ¨unity3dç¯å¢ƒå®ç°ä¸€å¥—å¤šçº¿ç¨‹ä¸‹è½½ä»£ç ã€‚æˆ‘æƒ³æˆ‘ä¸ºä»€ä¹ˆä¸€å¼€å§‹å°±æ²¡æœ‰è€ƒè™‘åˆ°åºåˆ—åŒ–æ–¹æ¡ˆçš„æ½œåœ¨é—®é¢˜å‘¢ï¼Œæˆ‘åªæ˜¯ä¸€å‘³çš„æå‡ºä¸€ä¸ªæ–¹æ¡ˆç„¶åæµ…æµ…çš„æ€è€ƒï¼Œå½“æˆ‘å†™åˆ°ä¸€åŠæ—¶å°±å‘ç°äº†å¼‚å¸¸é€€å‡ºå¯¼è‡´åºåˆ—åŒ–ä¿¡æ¯ä¸¢å¤±ï¼Œå½“å†æ¬¡æ–­ç‚¹ä¸‹è½½æ—¶åºåˆ—åŒ–ä¿¡æ¯æ˜¯æ—§çš„é”™è¯¯çš„é—®é¢˜ï¼Œè¿™ç§æ€è€ƒæ¨¡å¼æœ‰å¾ˆå¤§çš„å¼Šç«¯ã€‚</p>

<h2 id="é—®é¢˜å¤ç›˜">é—®é¢˜å¤ç›˜</h2>

<p>â€ƒâ€ƒğŸ¯è¯¦ç»†é—®é¢˜å¤ç›˜ï¼Œæˆ‘æœ€è¿‘åœ¨å®ç°ä¸€å¥—å¤šçº¿ç¨‹ä¸‹è½½ä»£ç ï¼Œéœ€è¦æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œå¯¹äºè¶…è¿‡ä¸€å®šsizeçš„å¤§æ–‡ä»¶è¿˜è¦æ”¯æŒåˆ†æ®µä¸‹è½½ã€‚OKï¼Œæˆ‘å°±æƒ³åˆ°äº†ä¸€ä¸ªæ–¹æ¡ˆï¼šä½¿ç”¨ç‰ˆæœ¬éš”ç¦»â•åˆ†æ®µä¸‹è½½â•åŠ åˆ†æ®µæ–­ç‚¹ç»­ä¼ ã€‚</p>

<ol>
  <li>ç‰ˆæœ¬éš”ç¦»ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰å®ƒå¯¹åº”çš„å½“å‰ç‰ˆæœ¬å·ï¼Œå¦‚æœç‰ˆæœ¬å·ä¸ä¸€è‡´è¯¥æ¬¡ä¸‹è½½æ–­ç‚¹æ–‡ä»¶æ˜¯è¿‡æ—¶çš„ã€‚</li>
  <li>åˆ†æ®µä¸‹è½½ï¼Œç¬¦å·å½“å‰ç‰ˆæœ¬å·åï¼Œæ¯ä¸ªæ–‡ä»¶åˆ†æ®µä¸‹è½½ï¼Œå¦‚æœæ²¡æœ‰ä¸‹è½½å®Œæˆè¦æŠŠæ–­ç‚¹ä¿¡æ¯Infoåºåˆ—åŒ–åˆ°ç¡¬ç›˜ã€‚</li>
  <li>åˆ†æ®µæ–­ç‚¹ç»­ä¼ ï¼Œç¬¦åˆå½“å‰ç‰ˆæœ¬å·ï¼Œä»ç¡¬ç›˜ååºåˆ—åŒ–æ–­ç‚¹ä¿¡æ¯æ‹¿åˆ°startRangeï¼ŒendRangeï¼Œç»§ç»­æ–­ç‚¹ä¸‹è½½ã€‚</li>
</ol>

<p>â€ƒâ€ƒæˆ‘å¼€å§‹æƒ³åˆ°â€åºåˆ—åŒ–infoæ–‡ä»¶â€è¿™ä¸ªæ–¹æ¡ˆåï¼Œè§‰å¾—å¯è¡Œç„¶åå°±å¼€å§‹å®ç°ä»£ç ï¼Œä½†æ˜¯ç°åœ¨é‡åˆ°äº†éå¸¸ä¸¥é‡çš„é—®é¢˜ã€‚ç°åœ¨æ¥çœ‹è¿™æ˜¯å…¸å‹çš„â€è§£å†³æ–¹æ¡ˆä¼˜å…ˆâ€æ€ç»´,å¦‚ä¸‹å›¾ã€‚</p>

<pre><code class="language-mermaid2">flowchart LR
    A[é—®é¢˜] --&gt; B[ç«‹å³æƒ³æ–¹æ¡ˆ]
    B --&gt; C[å¼€å§‹å®ç°]
    C --&gt; D[å‘ç°é—®é¢˜]
    D --&gt; E[ä¿®è¡¥]

    style A fill:#ffcccc
    style B fill:#ffe5cc
    style C fill:#ffffcc
    style D fill:#e5ffcc
    style E fill:#ccffe5
</code></pre>

<p>â€ƒâ€ƒä¸Šé¢è¿™ç§â€è§£å†³æ–¹æ¡ˆä¼˜å…ˆâ€æ€ç»´æœ€å¤§çš„å¼Šç«¯ï¼Œå°±æ˜¯ç¼ºå°‘â€è¾¹ç•Œæ¡ä»¶â€æ€è€ƒã€‚</p>

<ol>
  <li>æ­£å¸¸æƒ…å†µï¼šä¸‹è½½æœªå®Œæˆï¼Œé€€å‡ºåº”ç”¨ä¹‹å‰åºåˆ—åŒ–</li>
  <li>å¼‚å¸¸æƒ…å†µï¼šç¨‹åºå´©æºƒã€æ–­ç”µã€å¼ºåˆ¶å…³é—­</li>
  <li>æç«¯æƒ…å†µï¼šç£ç›˜æ»¡ã€æƒé™ä¸è¶³ã€å¹¶å‘å†²çª</li>
</ol>

<p>â€ƒâ€ƒæ­£å¸¸æƒ…å†µä¸‹åº”è¯¥æ˜¯è¿™æ ·çš„ã€‚</p>

<pre><code class="language-mermaid2">flowchart LR
    A[é—®é¢˜] --&gt; B[æ·±åº¦åˆ†æ]
    B --&gt; C[å¤šæ–¹æ¡ˆå¯¹æ¯”]
    C --&gt; D[é€‰æ‹©å®ç°]
    D --&gt; E[éªŒè¯]

    style A fill:#cce5ff
    style B fill:#ccd9ff
    style C fill:#e5ccff
    style D fill:#ffccf2
    style E fill:#ffd9cc
</code></pre>

<h2 id="æ”¹è¿›æ€è€ƒæ¨¡å¼">æ”¹è¿›æ€è€ƒæ¨¡å¼</h2>

<p>â€ƒâ€ƒğŸ§  ä»”ç»†å›æƒ³è¿‡å»ï¼Œå…¶å®å·²ç»é‡åˆ°äº†ä¸¤ä¸‰æ¬¡è¿™ç§æƒ…å†µäº†ï¼Œç°åœ¨å·¥ç¨‹é‡è¶Šå¤§è¶Šéš¾æ‰å¤´ï¼Œè¿™å¿…é¡»å¾—åº”è¯¥ä»æºå¤´å¼€å§‹åˆ¶å®šã€‚é“ç†éƒ½æ‡‚ï¼Œä½†æ˜¯åˆæ‡’å¾—æƒ³ï¼Œå¾€å¾€ä¼šè¢«åå™¬ã€‚</p>

<h3 id="æ•…éšœä¼˜å…ˆæ€ç»´">â€œæ•…éšœä¼˜å…ˆâ€æ€ç»´</h3>

<p>â€ƒâ€ƒæ•…éšœä¼˜å…ˆï¼Œæƒ³å‡ºå„ç§å„æ ·çš„å¤±è´¥åœºæ™¯ã€‚<code class="language-plaintext highlighter-rouge">è¿™ä¸ªæ–¹æ¡ˆåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå¤±è´¥</code>ï¼Ÿ<code class="language-plaintext highlighter-rouge">å¤±è´¥åä¼šé€ æˆä»€ä¹ˆåæœ</code>ï¼Ÿ<code class="language-plaintext highlighter-rouge">å¦‚ä½•ä»å¤±è´¥ä¸­æ¢å¤</code>ï¼Ÿ<code class="language-plaintext highlighter-rouge">æœ€åçš„æƒ…å†µæ˜¯ä»€ä¹ˆ</code>ï¼Ÿç­‰ç­‰ç–‘é—®ï½</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>æ–¹æ¡ˆï¼šåºåˆ—åŒ–infoæ–‡ä»¶
â†“
æ•…éšœåˆ†æï¼šç¨‹åºå¼‚å¸¸é€€å‡º â†’ infoæ–‡ä»¶æœªæ›´æ–° â†’ æ–­ç‚¹ä¿¡æ¯é”™è¯¯
â†“
åæœè¯„ä¼°ï¼šç”¨æˆ·é‡æ–°ä¸‹è½½ï¼Œæµªè´¹æ—¶é—´å’Œæµé‡
â†“
æ¢å¤ç­–ç•¥ï¼šæ–‡ä»¶åè‡ªæè¿°ï¼Œä»åˆ†æ®µæ–‡ä»¶æ¢å¤
</code></pre></div></div>

<h3 id="mvpè¿­ä»£æ€ç»´">â€œMVP+è¿­ä»£â€æ€ç»´</h3>

<p>â€ƒâ€ƒå¿«é€Ÿè¿­ä»£å¼€å‘ï¼Œä»æœ€æœ€åŸºç¡€çš„å¼€å§‹ï¼Œé¿å…ä¸€å¼€å§‹å°±è¿½æ±‚â€å®Œç¾æ–¹æ¡ˆâ€ã€‚ä½†æ˜¯å¯¹äºä¸€ä¸ªæ¯”è¾ƒå¤§çš„åŸºç¡€åŠŸèƒ½å¦‚æœå‰æœŸè®¾è®¡ä¸åˆ°ä½è¿˜æ˜¯ä¼šæœ‰ä¸€å®šçš„å±€é™æ€§ï¼ŒAPIæ¥å£ä½¿ç”¨é‡å¤§äº†åæœŸå†æ¬¡è¿­ä»£ä¹Ÿä¼šéå¸¸æ¼ç«ã€‚</p>

<ul>
  <li>V1: æœ€ç®€å¯è¡Œæ–¹æ¡ˆï¼ˆæ— æ–­ç‚¹ç»­ä¼ ï¼‰</li>
  <li>V2: åŸºç¡€æ–­ç‚¹ç»­ä¼ ï¼ˆæ–‡ä»¶ååŒ…å«ä¿¡æ¯ï¼‰</li>
  <li>V3: ä¼˜åŒ–æ€§èƒ½ï¼ˆæ‰¹é‡å¤„ç†ã€ç¼“å­˜ï¼‰</li>
  <li>V4: é«˜çº§ç‰¹æ€§ï¼ˆMD5æ ¡éªŒã€å‹ç¼©ï¼‰</li>
</ul>

<h3 id="é€†å‘å·¥ç¨‹æ€ç»´">â€œé€†å‘å·¥ç¨‹â€æ€ç»´</h3>

<p>â€ƒâ€ƒä»æœ€ç»ˆç›®æ ‡å€’æ¨æ€è€ƒï¼šç›®æ ‡ï¼šå¯é çš„æ–­ç‚¹ç»­ä¼ â†’éœ€æ±‚ï¼šå¼‚å¸¸é€€å‡ºåèƒ½æ¢å¤ä¸‹è½½è¿›åº¦â†’çº¦æŸï¼šä¸èƒ½ä¾èµ–åºåˆ—åŒ–æ–‡ä»¶ï¼ˆå¯èƒ½ä¸¢å¤±ï¼‰â†’æ–¹æ¡ˆï¼šä¿¡æ¯å¿…é¡»æŒä¹…åŒ–åœ¨åˆ†æ®µæ–‡ä»¶æœ¬èº«â†’å®ç°ï¼šæ–‡ä»¶ååŒ…å«èŒƒå›´ä¿¡æ¯</p>

<h2 id="å…·ä½“æ”¹è¿›æ–¹æ³•">å…·ä½“æ”¹è¿›æ–¹æ³•</h2>

<h3 id="å»ºç«‹è®¾è®¡æ£€æŸ¥æ¸…å•">å»ºç«‹â€è®¾è®¡æ£€æŸ¥æ¸…å•â€</h3>

<p>â€ƒâ€ƒæ¯æ¬¡è®¾è®¡æ–¹æ¡ˆåï¼Œå¯¹ç…§æ£€æŸ¥ï¼š</p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â–¡ å¼‚å¸¸é€€å‡ºåœºæ™¯æ˜¯å¦è€ƒè™‘ï¼Ÿ
â–¡ å¹¶å‘å†²çªå¦‚ä½•å¤„ç†ï¼Ÿ
â–¡ æ€§èƒ½ç“¶é¢ˆåœ¨å“ªé‡Œï¼Ÿ
â–¡ æ‰©å±•æ€§å¦‚ä½•ï¼Ÿ
â–¡ æµ‹è¯•è¦†ç›–äº†è¾¹ç•Œæƒ…å†µå—ï¼Ÿ
â–¡ æœ‰å¤‡é€‰æ–¹æ¡ˆå—ï¼Ÿ
</code></pre></div></div>

<h3 id="çº¢é˜Ÿæ€ç»´æŠ¬æ ">â€œçº¢é˜Ÿæ€ç»´â€æŠ¬æ </h3>

<p>â€ƒâ€ƒè®¾è®¡å®Œæ–¹æ¡ˆåï¼Œæ¢ä¸ªè§’è‰²è¯•å›¾â€æ”»å‡»â€æˆ‘çš„è®¾è®¡ï¼ŒæŠ¬æ è¦æŠŠè¿™ä¸ªç³»ç»Ÿå¼„å´©æºƒå¤±è´¥</p>
<ul>
  <li>åœ¨æœ€å…³é”®æ—¶åˆ»æ–­ç”µ</li>
  <li>æ€è¿›ç¨‹ã€å¼‚å¸¸å´©æºƒ</li>
  <li>æ¥å›åˆ‡æ¢åŠŸèƒ½ä¸‹è½½ï¼Œä¸åŒçš„èµ„æºä¸‹è½½-ç»ˆæ­¢-ä¸‹è½½-ç»ˆæ­¢â€¦</li>
  <li>åŒæ—¶å¯åŠ¨1000ä¸ªä¸‹è½½</li>
  <li>ç£ç›˜ç©ºé—´ä¸è¶³</li>
  <li>ç½‘ç»œä¸ç¨³å®š</li>
</ul>

<h3 id="å¤šå±‚æ€è€ƒè¹‚èº">â€œå¤šå±‚æ€è€ƒâ€è¹‚èº</h3>

<p>â€ƒâ€ƒç¬¬ä¸€å±‚ï¼šè¿™ä¸ªæ–¹æ¡ˆèƒ½è§£å†³é—®é¢˜å—ï¼Ÿï¼ˆåŠŸèƒ½æ€§ï¼‰ç¬¬äºŒå±‚ï¼šåœ¨å„ç§å¼‚å¸¸æƒ…å†µä¸‹è¿˜èƒ½å·¥ä½œå—ï¼Ÿï¼ˆå¯é æ€§ï¼‰ç¬¬ä¸‰å±‚ï¼šåœ¨å¤§è§„æ¨¡ã€é«˜å¹¶å‘ä¸‹æ€§èƒ½å¦‚ä½•ï¼Ÿï¼ˆæ‰©å±•æ€§ï¼‰ã€‚ç±»ä¼¼è‡ªæˆ‘é—®ç­”å§ã€‚</p>

<h3 id="å†™è®¾è®¡æ–‡æ¡£">å†™â€è®¾è®¡æ–‡æ¡£â€</h3>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gu">## æ–¹æ¡ˆå¯¹æ¯”</span>
| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é£é™© |
|------|------|------|------|
| åºåˆ—åŒ–info | ç®€å•ç›´è§‚ | å¼‚å¸¸é€€å‡ºä¸¢å¤± | é«˜ |
| æ–‡ä»¶ååŒ…å«ä¿¡æ¯ | å¯é æ€§é«˜ | æ–‡ä»¶åè¾ƒé•¿ | ä½ |

<span class="gu">## æ•…éšœåœºæ™¯åˆ†æ</span>
<span class="p">1.</span> ç¨‹åºå¼‚å¸¸é€€å‡º
<span class="p">2.</span> ç£ç›˜ç©ºé—´ä¸è¶³
<span class="p">3.</span> æƒé™é—®é¢˜
</code></pre></div></div>

<h2 id="é‚£ä¸ºä»€ä¹ˆä¼šé¢‘ç¹è¿™æ ·å‘¢">é‚£ä¸ºä»€ä¹ˆä¼šé¢‘ç¹è¿™æ ·å‘¢</h2>

<p>â€ƒâ€ƒ<strong>æŠ—ä½å‹åŠ›</strong>ï¼ç°å®æƒ…å†µå°±æ˜¯è¦æ±‚å¿«å¿«å¿«å¿«å¿«å¿«å¿«ï½ï½ï¼Œä»Šå¤©æå‡ºéœ€æ±‚æ˜å¤©å°±è¦çœ‹åˆ°åŸå‹ï¼Œâ€ç”¨AIå†™â€ã€â€å»GitHubæ‰’ä¸€å¥—ç°æˆçš„â€ï¼Œå„ç§å£°éŸ³ä¸ç»äºè€³ã€‚ä¸ç®¡æ€ä¹ˆæ ·å§ï¼Œå³ä½¿ç°å®æƒ…å†µæœ‰å¤šâ€æ¶åŠ£â€ï¼Œä¿æŒå¼€å‘å·¥ç¨‹çš„åˆå¿ƒã€å…¥è¡Œçš„åˆå¿ƒå§ã€‚<strong>æ‰›ä½å‹åŠ›ï¼Œè´¨é‡ä¸é€Ÿåº¦å…¼é¡¾</strong>ï¼</p>]]></content><author><name>ç¼–ç¨‹æ•£è®°</name></author><category term="other" /><category term="other" /><summary type="html"><![CDATA[æˆ‘åªæ˜¯ä¸€å‘³çš„æå‡ºä¸€ä¸ªæ–¹æ¡ˆç„¶åæµ…æµ…çš„æ€è€ƒï¼Œå½“æˆ‘å†™åˆ°ä¸€åŠæ—¶å°±å‘ç°äº†å¼‚å¸¸é€€å‡ºå¯¼è‡´åºåˆ—åŒ–ä¿¡æ¯ä¸¢å¤±ï¼Œå½“å†æ¬¡æ–­ç‚¹ä¸‹è½½æ—¶åºåˆ—åŒ–ä¿¡æ¯æ˜¯æ—§çš„é”™è¯¯çš„é—®é¢˜ã€‚]]></summary></entry><entry><title type="html">Unidownload_structure</title><link href="https://www.damonc.top/UniDownload_Structure.html" rel="alternate" type="text/html" title="Unidownload_structure" /><published>2025-06-10T00:00:00+00:00</published><updated>2025-06-10T00:00:00+00:00</updated><id>https://www.damonc.top/UniDownload_Structure</id><content type="html" xml:base="https://www.damonc.top/UniDownload_Structure.html"><![CDATA[]]></content><author><name>ç¼–ç¨‹æ•£è®°</name></author><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">å¤šçº¿ç¨‹ç¼–ç¨‹æ¨¡å‹ç¯‡(ä¸‰)</title><link href="https://www.damonc.top/csharp/CSharp_Thread_Pattern.html" rel="alternate" type="text/html" title="å¤šçº¿ç¨‹ç¼–ç¨‹æ¨¡å‹ç¯‡(ä¸‰)" /><published>2025-06-07T10:00:00+00:00</published><updated>2025-06-07T10:00:00+00:00</updated><id>https://www.damonc.top/csharp/CSharp_Thread_Pattern</id><content type="html" xml:base="https://www.damonc.top/csharp/CSharp_Thread_Pattern.html"><![CDATA[<p>â€ƒâ€ƒUnityæœ‰ç€ä¸¥æ ¼çš„ä¸»çº¿ç¨‹é™åˆ¶ï¼ŒåŒæ—¶Unityçš„C#åº“ä¸€ç›´æ²¡æœ‰å¾—åˆ°åŠæ—¶çš„æ›´æ–°ï¼Œå¯¼è‡´å¾ˆå¤šC#çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼åœ¨Unityä¸­æ— æ³•ä½¿ç”¨ã€‚æŒç»­åˆ°Unity2020ç‰ˆæœ¬å‘å¸ƒåŠ å…¥äº†.net 4.xæ­£å¼ç‰ˆæœ¬çš„æ”¯æŒæ‰æœ‰äº†å®Œæ•´çš„C#å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ã€‚APMã€EAPã€async/awaitå¼‚æ­¥æ¨¡å¼éƒ½æœ‰äº†ã€‚</p>

<h2 id="apmæ¨¡å¼">APMæ¨¡å¼</h2>

<p>â€ƒâ€ƒAPMæ¨¡å¼æ˜¯åŸºäºå§”æ‰˜çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼Œå…¨ç§°<code class="language-plaintext highlighter-rouge">Asynchronous Programming Model</code>ï¼Œè¯¥æ¨¡å¼çš„å…¸å‹ç‰¹å¾æ˜¯BeginOperationNameå’ŒEndOperationNameï¼Œç”¨äºå¼€å§‹å’Œç»“æŸå¼‚æ­¥æ“ä½œOperationNameã€‚ä¾‹å¦‚ï¼ŒFileStreamç±»æä¾› BeginReadå’ŒEndReadæ–¹æ³•ã€‚Beginæ–¹æ³•è¿”å›ä¸€ä¸ªIAsyncResultå¯¹è±¡ï¼Œè°ƒç”¨Endæ–¹æ³•æ—¶éœ€è¦ä¼ å…¥IAsyncResultå¯¹è±¡ï¼ŒEndæ–¹æ³•ä¼šè¿”å›å¼‚æ­¥æ“ä½œçš„ç»“æœã€‚</p>

<h3 id="iasyncresultå¯¹è±¡">IAsyncResultå¯¹è±¡</h3>

<p>â€ƒâ€ƒè¯¥æ–¹æ³•BeginOperationNameå¼€å§‹å¼‚æ­¥æ“ä½œOperationNameå¹¶è¿”å›å®ç°IAsyncResultæ¥å£çš„å¯¹è±¡ã€‚IAsyncResultå¯¹è±¡å­˜å‚¨æœ‰å…³å¼‚æ­¥ä½œçš„ä¿¡æ¯ã€‚</p>

<table>
  <thead>
    <tr>
      <th>æˆå‘˜</th>
      <th>DESCRIPTION</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>AsyncState</td>
      <td>ä¸€ä¸ªå¯é€‰çš„ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«æœ‰å…³å¼‚æ­¥ä½œçš„ä¿¡æ¯ã€‚</td>
    </tr>
    <tr>
      <td>AsyncWaitHandle</td>
      <td>WaitHandleå¯ç”¨äºé˜»æ­¢åº”ç”¨ç¨‹åºæ‰§è¡Œï¼Œç›´åˆ°å¼‚æ­¥æ“ä½œå®Œæˆã€‚</td>
    </tr>
    <tr>
      <td>CompletedSynchronously</td>
      <td>ä¸€ä¸ªå€¼ï¼Œè¯¥å€¼æŒ‡ç¤ºå¼‚æ­¥æ“ä½œæ˜¯å¦åœ¨ç”¨äºè°ƒç”¨ BeginOperationName çš„çº¿ç¨‹ä¸Šå®Œæˆï¼Œè€Œä¸æ˜¯åœ¨å•ç‹¬çš„ ThreadPool çº¿ç¨‹ä¸Šå®Œæˆã€‚</td>
    </tr>
    <tr>
      <td>IsCompleted</td>
      <td>ä¸€ä¸ªè¡¨ç¤ºå¼‚æ­¥æ“ä½œæ˜¯å¦å·²å®Œæˆçš„å€¼ã€‚</td>
    </tr>
  </tbody>
</table>

<h3 id="å§”æ‰˜å¼‚æ­¥æ“ä½œ">å§”æ‰˜å¼‚æ­¥æ“ä½œ</h3>

<p>â€ƒâ€ƒæ— å‚æ— è¿”å›å€¼çš„å§”æ‰˜å¼‚æ­¥æ“ä½œç¤ºä¾‹ï¼š</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">WorkerHandler</span><span class="p">();</span>
<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Worker</span><span class="p">();</span>

<span class="n">WorkerHandler</span> <span class="n">workerHandler</span> <span class="p">=</span> <span class="n">Worker</span><span class="p">;</span>

<span class="c1">//å¯ä»¥ä¸ç”¨å›è°ƒå‡½æ•°å’Œè‡ªå®šä¹‰å‚æ•°</span>
<span class="n">IAsyncResult</span> <span class="n">asyncResult</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">BeginInvoke</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="n">workerHandler</span><span class="p">.</span><span class="nf">EndInvoke</span><span class="p">(</span><span class="n">asyncResult</span><span class="p">);</span>
</code></pre></div></div>

<p>â€ƒâ€ƒBeginInvokeå‰å‡ ä¸ªå‚æ•°å¿…é¡»ä¸å§”æ‰˜ç­¾åä¸€è‡´ï¼Œæœ€åä¸¤ä¸ªå‚æ•°æ˜¯å›ºå®šçš„å›è°ƒå‡½æ•°å’Œè‡ªå®šä¹‰å‚æ•°ï¼Œæœ‰å‚æœ‰è¿”å›å€¼çš„å§”æ‰˜å¼‚æ­¥æ“ä½œç¤ºä¾‹ï¼š</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">delegate</span> <span class="kt">string</span> <span class="nf">WorkerHandler</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">);</span>
<span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">Worker</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">);</span>

<span class="n">WorkerHandler</span> <span class="n">workerHandler</span> <span class="p">=</span> <span class="n">Worker</span><span class="p">;</span>

<span class="c1">//BeginInvokeå‰å‡ ä¸ªå‚æ•°å¿…é¡»ä¸å§”æ‰˜ç­¾åä¸€è‡´</span>
<span class="c1">//BeginInvokeæœ€åä¸¤ä¸ªå‚æ•°æ˜¯å›ºå®šçš„å›è°ƒå‡½æ•°å’Œè‡ªå®šä¹‰å‚æ•°</span>
<span class="n">IAsyncResult</span> <span class="n">asyncResult</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">BeginInvoke</span><span class="p">(</span><span class="s">"message"</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">EndInvoke</span><span class="p">(</span><span class="n">asyncResult</span><span class="p">);</span>
</code></pre></div></div>

<p>â€ƒâ€ƒå®Œæˆå›è°ƒå‡½æ•°ä¸AsyncCallbackå§”æ‰˜çš„ç­¾åä¸€è‡´ï¼Œè‡ªå®šä¹‰å‚æ•°é€šè¿‡IAsyncResult.AsyncStateå±æ€§è·å–ï¼Œå¼‚æ­¥æ“ä½œçš„å®Œæˆå›è°ƒä¸è‡ªå®šä¹‰å‚æ•°ç¤ºä¾‹ï¼š</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">delegate</span> <span class="kt">string</span> <span class="nf">WorkerHandler</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">);</span>
<span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">Worker</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">);</span>

<span class="n">WorkerHandler</span> <span class="n">workerHandler</span> <span class="p">=</span> <span class="n">Worker</span><span class="p">;</span>

<span class="c1">//å®Œæˆå›è°ƒå‡½æ•°ä¸AsyncCallbackå§”æ‰˜çš„ç­¾åä¸€è‡´</span>
<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">FinishCallback</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">message</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">result</span><span class="p">.</span><span class="n">AsyncState</span><span class="p">;</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">EndInvoke</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">IAsyncResult</span> <span class="n">asyncResult</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">BeginInvoke</span><span class="p">(</span><span class="s">"message"</span><span class="p">,</span> <span class="n">FinishCallback</span><span class="p">,</span> <span class="s">"custom parameter"</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="å¼‚æ­¥æ“ä½œç­‰å¾…">å¼‚æ­¥æ“ä½œç­‰å¾…</h3>

<p>â€ƒâ€ƒIAsyncResult.AsyncWaitHandleå±æ€§è¿”å›ä¸€ä¸ªWaitHandleå¯¹è±¡ï¼Œå¯ä»¥ç”¨äºé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°å¼‚æ­¥æ“ä½œå®Œæˆã€‚å¼‚æ­¥æ“ä½œç­‰å¾…ç¤ºä¾‹ï¼š</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. ç›´æ¥é˜»å¡ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ</span>
<span class="n">IAsyncResult</span> <span class="n">asyncResult</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">BeginInvoke</span><span class="p">(</span><span class="s">"message"</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">EndInvoke</span><span class="p">(</span><span class="n">asyncResult</span><span class="p">);</span>

<span class="c1">// 2. è½®è¯¢æ£€æŸ¥</span>
<span class="n">IAsyncResult</span> <span class="n">asyncResult</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">BeginInvoke</span><span class="p">(</span><span class="s">"message"</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(!</span><span class="n">asyncResult</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">100</span><span class="p">);</span> <span class="c1">// åšå…¶ä»–å·¥ä½œ</span>
<span class="p">}</span>
<span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">EndInvoke</span><span class="p">(</span><span class="n">asyncResult</span><span class="p">);</span>

<span class="c1">// 3. ä½¿ç”¨WaitHandle</span>
<span class="n">IAsyncResult</span> <span class="n">asyncResult</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">BeginInvoke</span><span class="p">(</span><span class="s">"message"</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="n">asyncResult</span><span class="p">.</span><span class="n">AsyncWaitHandle</span><span class="p">.</span><span class="nf">WaitOne</span><span class="p">();</span> <span class="c1">// ç­‰å¾…å®Œæˆ</span>
<span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">EndInvoke</span><span class="p">(</span><span class="n">asyncResult</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="eapæ¨¡å¼">EAPæ¨¡å¼</h2>
<p>â€ƒâ€ƒEAPæ¨¡å¼æ˜¯åŸºäºäº‹ä»¶çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼Œå…¨ç§°<code class="language-plaintext highlighter-rouge">Event-based Asynchronous Pattern</code>ï¼Œè¯¥æ¨¡å¼çš„å…¸å‹ç‰¹å¾æ˜¯äº‹ä»¶æ“ä½œã€‚å®ƒé€šè¿‡äº‹ä»¶å›è°ƒæ¥å¤„ç†å¼‚æ­¥æ“ä½œçš„å®Œæˆã€‚ç›¸æ¯”APMæ¨¡å¼ï¼ŒEAPæ¨¡å¼æ›´åŠ ç”¨æˆ·å‹å¥½ï¼Œæ”¯æŒå–æ¶ˆæ“ä½œå’Œè¿›åº¦æŠ¥å‘Šã€‚EAPæ¨¡å¼çš„æœ€å°è®¾è®¡åŒ…å«ä¸€ä¸ªBeginMethodNameæ–¹æ³•å’Œä¸€ä¸ªMethodNameCompletedäº‹ä»¶ã€‚BeginMethodNameæ–¹æ³•å¯åŠ¨å¼‚æ­¥æ“ä½œå¹¶è¿”å›IAsyncResultå¯¹è±¡ï¼ŒMethodNameCompletedäº‹ä»¶åœ¨å¼‚æ­¥æ“ä½œå®Œæˆæ—¶è§¦å‘ã€‚MethodNameCompletedEventArgsç±»æ´¾ç”Ÿè‡ªAsyncCompletedEventArgsï¼Œæä¾›å¼‚æ­¥æ“ä½œçš„ç»“æœå’Œä»»ä½•é”™è¯¯ä¿¡æ¯ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">MethodNameCompletedEventHandler</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span>
    <span class="n">MethodNameCompletedEventArgs</span> <span class="n">e</span><span class="p">);</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">MethodNameCompletedEventArgs</span> <span class="p">:</span>
    <span class="n">System</span><span class="p">.</span><span class="n">ComponentModel</span><span class="p">.</span><span class="n">AsyncCompletedEventArgs</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">MyReturnType</span> <span class="n">Result</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="eapæ¨¡å¼çš„æ ¸å¿ƒç‰¹å¾">EAPæ¨¡å¼çš„æ ¸å¿ƒç‰¹å¾</h3>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•/äº‹ä»¶</th>
      <th>è¯´æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>MethodNameAsync</td>
      <td>æ–¹æ³• - å¯åŠ¨å¼‚æ­¥æ“ä½œ</td>
    </tr>
    <tr>
      <td>MethodNameCompleted</td>
      <td>äº‹ä»¶ - å¼‚æ­¥æ“ä½œå®Œæˆæ—¶è§¦å‘</td>
    </tr>
    <tr>
      <td>MethodNameCompletedEventArgs</td>
      <td>äº‹ä»¶å‚æ•°ï¼ŒåŒ…å«ç»“æœå’Œé”™è¯¯ä¿¡æ¯</td>
    </tr>
    <tr>
      <td>CancelAsync</td>
      <td>æ–¹æ³• - æ”¯æŒå–æ¶ˆæ“ä½œ</td>
    </tr>
    <tr>
      <td>ProgressChanged</td>
      <td>äº‹ä»¶ - æ”¯æŒè¿›åº¦æŠ¥å‘Š</td>
    </tr>
  </tbody>
</table>

<h3 id="å®ç°æ”¯æŒeapçš„ç±»">å®ç°æ”¯æŒEAPçš„ç±»</h3>

<p>â€ƒâ€ƒå®šä¹‰äº‹ä»¶å‚æ•°ç±»MethodNameCompletedEventArgsï¼Œæ´¾ç”Ÿè‡ªAsyncCompletedEventArgsï¼Œæä¾›å¼‚æ­¥æ“ä½œçš„ç»“æœå’Œä»»ä½•é”™è¯¯ä¿¡æ¯ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">DownloadCompletedEventArgs</span> <span class="p">:</span> <span class="n">AsyncCompletedEventArgs</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">FilePath</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">long</span> <span class="n">BytesDownloaded</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    
    <span class="k">public</span> <span class="nf">DownloadCompletedEventArgs</span><span class="p">(</span><span class="n">Exception</span> <span class="n">error</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">cancelled</span><span class="p">,</span> 
        <span class="kt">object</span> <span class="n">userState</span><span class="p">,</span> <span class="kt">string</span> <span class="n">filePath</span><span class="p">,</span> <span class="kt">long</span> <span class="n">bytesDownloaded</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">cancelled</span><span class="p">,</span> <span class="n">userState</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">FilePath</span> <span class="p">=</span> <span class="n">filePath</span><span class="p">;</span>
        <span class="n">BytesDownloaded</span> <span class="p">=</span> <span class="n">bytesDownloaded</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">DownloadProgressChangedEventArgs</span> <span class="p">:</span> <span class="n">ProgressChangedEventArgs</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">long</span> <span class="n">BytesReceived</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">long</span> <span class="n">TotalBytesToReceive</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    
    <span class="k">public</span> <span class="nf">DownloadProgressChangedEventArgs</span><span class="p">(</span><span class="kt">int</span> <span class="n">progressPercentage</span><span class="p">,</span> <span class="kt">object</span> <span class="n">userState</span><span class="p">,</span>
        <span class="kt">long</span> <span class="n">bytesReceived</span><span class="p">,</span> <span class="kt">long</span> <span class="n">totalBytes</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">progressPercentage</span><span class="p">,</span> <span class="n">userState</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BytesReceived</span> <span class="p">=</span> <span class="n">bytesReceived</span><span class="p">;</span>
        <span class="n">TotalBytesToReceive</span> <span class="p">=</span> <span class="n">totalBytes</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒå®šä¹‰æ”¯æŒEAPçš„ç±»DownloadManagerï¼ŒåŒ…å«MethodNameAsyncæ–¹æ³•å’ŒMethodNameCompletedäº‹ä»¶ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. å®ç°EAPæ¨¡å¼çš„ä¸‹è½½å™¨ç±»</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">DownloadManager</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">WebClient</span> <span class="n">_webClient</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">_lockObject</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>
    
    <span class="c1">// 2. å®šä¹‰äº‹ä»¶</span>
    <span class="k">public</span> <span class="k">event</span> <span class="n">EventHandler</span><span class="p">&lt;</span><span class="n">DownloadCompletedEventArgs</span><span class="p">&gt;</span> <span class="n">DownloadCompleted</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">event</span> <span class="n">EventHandler</span><span class="p">&lt;</span><span class="n">DownloadProgressChangedEventArgs</span><span class="p">&gt;</span> <span class="n">ProgressChanged</span><span class="p">;</span>
    
    <span class="c1">// 3. å¼‚æ­¥æ–¹æ³•</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">,</span> <span class="kt">string</span> <span class="n">filePath</span><span class="p">,</span> <span class="kt">object</span> <span class="n">userState</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// æ£€æŸ¥æ˜¯å¦å·²æœ‰æ“ä½œåœ¨è¿›è¡Œ</span>
        <span class="k">lock</span> <span class="p">(</span><span class="n">_lockObject</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_webClient</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"ä¸‹è½½æ“ä½œå·²åœ¨è¿›è¡Œä¸­"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">_webClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WebClient</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="c1">// è®¢é˜…WebClientäº‹ä»¶</span>
        <span class="n">_webClient</span><span class="p">.</span><span class="n">DownloadProgressChanged</span> <span class="p">+=</span> <span class="n">OnDownloadProgressChanged</span><span class="p">;</span>
        <span class="n">_webClient</span><span class="p">.</span><span class="n">DownloadFileCompleted</span> <span class="p">+=</span> <span class="n">OnDownloadFileCompleted</span><span class="p">;</span>
        
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="c1">// å¼€å§‹å¼‚æ­¥ä¸‹è½½</span>
            <span class="n">_webClient</span><span class="p">.</span><span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="n">filePath</span><span class="p">,</span> 
                <span class="k">new</span> <span class="n">DownloadState</span> <span class="p">{</span> <span class="n">Url</span> <span class="p">=</span> <span class="n">url</span><span class="p">,</span> <span class="n">FilePath</span> <span class="p">=</span> <span class="n">filePath</span><span class="p">,</span> <span class="n">UserState</span> <span class="p">=</span> <span class="n">userState</span> <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// å¦‚æœå¯åŠ¨å¤±è´¥ï¼Œç«‹å³è§¦å‘å®Œæˆäº‹ä»¶</span>
            <span class="nf">OnDownloadCompleted</span><span class="p">(</span><span class="k">new</span> <span class="nf">DownloadCompletedEventArgs</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">userState</span><span class="p">,</span> <span class="n">filePath</span><span class="p">,</span> <span class="m">0</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// 4. å–æ¶ˆæ–¹æ³•</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">CancelAsync</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="n">_lockObject</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_webClient</span><span class="p">?.</span><span class="nf">CancelAsync</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// 5. å†…éƒ¨çŠ¶æ€ç±»</span>
    <span class="k">private</span> <span class="k">class</span> <span class="nc">DownloadState</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Url</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">FilePath</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">object</span> <span class="n">UserState</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// 6. è¿›åº¦å˜åŒ–äº‹ä»¶å¤„ç†</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnDownloadProgressChanged</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">DownloadProgressChangedEventArgs</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">state</span> <span class="p">=</span> <span class="p">(</span><span class="n">DownloadState</span><span class="p">)</span><span class="n">e</span><span class="p">.</span><span class="n">UserState</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">args</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DownloadProgressChangedEventArgs</span><span class="p">(</span>
            <span class="n">e</span><span class="p">.</span><span class="n">ProgressPercentage</span><span class="p">,</span>
            <span class="n">state</span><span class="p">.</span><span class="n">UserState</span><span class="p">,</span>
            <span class="n">e</span><span class="p">.</span><span class="n">BytesReceived</span><span class="p">,</span>
            <span class="n">e</span><span class="p">.</span><span class="n">TotalBytesToReceive</span><span class="p">);</span>
            
        <span class="n">ProgressChanged</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// 7. å®Œæˆäº‹ä»¶å¤„ç†</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnDownloadFileCompleted</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">AsyncCompletedEventArgs</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">state</span> <span class="p">=</span> <span class="p">(</span><span class="n">DownloadState</span><span class="p">)</span><span class="n">e</span><span class="p">.</span><span class="n">UserState</span><span class="p">;</span>
        <span class="kt">long</span> <span class="n">bytesDownloaded</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(!</span><span class="n">e</span><span class="p">.</span><span class="n">Cancelled</span> <span class="p">&amp;&amp;</span> <span class="n">e</span><span class="p">.</span><span class="n">Error</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">bytesDownloaded</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileInfo</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">FilePath</span><span class="p">).</span><span class="n">Length</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">{</span> <span class="cm">/* å¿½ç•¥è·å–æ–‡ä»¶å¤§å°çš„é”™è¯¯ */</span> <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1">// æ¸…ç†èµ„æº</span>
        <span class="k">lock</span> <span class="p">(</span><span class="n">_lockObject</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_webClient</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_webClient</span><span class="p">.</span><span class="n">DownloadProgressChanged</span> <span class="p">-=</span> <span class="n">OnDownloadProgressChanged</span><span class="p">;</span>
                <span class="n">_webClient</span><span class="p">.</span><span class="n">DownloadFileCompleted</span> <span class="p">-=</span> <span class="n">OnDownloadFileCompleted</span><span class="p">;</span>
                <span class="n">_webClient</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
                <span class="n">_webClient</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1">// è§¦å‘å®Œæˆäº‹ä»¶</span>
        <span class="nf">OnDownloadCompleted</span><span class="p">(</span><span class="k">new</span> <span class="nf">DownloadCompletedEventArgs</span><span class="p">(</span>
            <span class="n">e</span><span class="p">.</span><span class="n">Error</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">Cancelled</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">UserState</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">FilePath</span><span class="p">,</span> <span class="n">bytesDownloaded</span><span class="p">));</span>
    <span class="p">}</span>
    
    <span class="c1">// 8. å®‰å…¨è§¦å‘å®Œæˆäº‹ä»¶çš„æ–¹æ³•</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnDownloadCompleted</span><span class="p">(</span><span class="n">DownloadCompletedEventArgs</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">DownloadCompleted</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// 9. é‡Šæ”¾èµ„æº</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="n">_lockObject</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_webClient</span><span class="p">?.</span><span class="nf">Dispose</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒä½¿ç”¨æ”¯æŒEAPçš„ç±»DownloadManagerï¼Œå¯ä»¥å®ç°å¼‚æ­¥ä¸‹è½½æ–‡ä»¶ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">downloader</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileDownloader</span><span class="p">();</span>
        
        <span class="c1">// è®¢é˜…äº‹ä»¶</span>
        <span class="n">downloader</span><span class="p">.</span><span class="n">ProgressChanged</span> <span class="p">+=</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"ä¸‹è½½è¿›åº¦: </span><span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">ProgressPercentage</span><span class="p">}</span><span class="s">% "</span> <span class="p">+</span>
                            <span class="s">$"(</span><span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">BytesReceived</span><span class="p">}</span><span class="s">/</span><span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">TotalBytesToReceive</span><span class="p">}</span><span class="s"> bytes)"</span><span class="p">);</span>
        <span class="p">};</span>
        
        <span class="n">downloader</span><span class="p">.</span><span class="n">DownloadCompleted</span> <span class="p">+=</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Cancelled</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"ä¸‹è½½å·²å–æ¶ˆ"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Error</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"ä¸‹è½½å¤±è´¥: </span><span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">Error</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"ä¸‹è½½å®Œæˆ: </span><span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">FilePath</span><span class="p">}</span><span class="s">, å¤§å°: </span><span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">BytesDownloaded</span><span class="p">}</span><span class="s"> bytes"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span>
        
        <span class="c1">// å¼€å§‹å¼‚æ­¥ä¸‹è½½</span>
        <span class="kt">string</span> <span class="n">url</span> <span class="p">=</span> <span class="s">"https://example.com/largefile.zip"</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">filePath</span> <span class="p">=</span> <span class="s">@"C:\temp\downloaded.zip"</span><span class="p">;</span>
        
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"å¼€å§‹ä¸‹è½½..."</span><span class="p">);</span>
        <span class="n">downloader</span><span class="p">.</span><span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filePath</span><span class="p">,</span> <span class="s">"è‡ªå®šä¹‰çŠ¶æ€å¯¹è±¡"</span><span class="p">);</span>
        
        <span class="c1">// æ¨¡æ‹Ÿå…¶ä»–å·¥ä½œ</span>
        <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">5000</span><span class="p">);</span>
        
        <span class="c1">// å¯ä»¥å–æ¶ˆä¸‹è½½</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"5ç§’åå–æ¶ˆä¸‹è½½"</span><span class="p">);</span>
        <span class="n">downloader</span><span class="p">.</span><span class="nf">CancelAsync</span><span class="p">();</span>
        
        <span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="premonition warning"> <div class="header"> <svg class="icon warning" aria-hidden="true"> <use xlink:href="#icon-warning"></use> </svg> <div class="title"> ä¸æ¨èEAPæ¨¡å¼ </div> </div> <div class="content"> <p>ç›¸æ¯”äºAPMæ¨¡å¼ï¼ŒEAPæ¨¡å¼æ›´åŠ å¤æ‚ï¼Œè€Œä¸”å®¹æ˜“å‡ºç°èµ„æºæ³„æ¼ã€‚
åŒæ—¶å®˜æ–¹ä¹Ÿä¸æ¨èä½¿ç”¨EAPæ¨¡å¼ï¼Œæ”¹ç”¨async/awaitå¼‚æ­¥æ¨¡å¼ã€‚
Unityä¹‹å‰å¤§éƒ¨åˆ†éƒ½æ˜¯ç±»EAPæ¨¡å¼ï¼Œç°åœ¨æ¨èä½¿ç”¨async/awaitå¼‚æ­¥æ¨¡å¼ã€‚</p>



 </div> </div>
<h2 id="asyncawaitå¼‚æ­¥æ¨¡å¼">async/awaitå¼‚æ­¥æ¨¡å¼</h2>

<p>â€ƒâ€ƒasync/awaitå¼‚æ­¥æ¨¡å¼å…¨ç§°<code class="language-plaintext highlighter-rouge">Async/Await</code>ï¼Œè¯¥æ¨¡å¼çš„å…¸å‹ç‰¹å¾æ˜¯async/awaitå…³é”®å­—ã€‚async/awaitå…³é”®å­—ç”¨äºå£°æ˜å¼‚æ­¥æ–¹æ³•ï¼Œawaitå…³é”®å­—ç”¨äºç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="nn">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="çŠ¶æ€æœº">çŠ¶æ€æœº</h3>

<p>â€ƒâ€ƒasync/awaitçš„æœ¬è´¨æ˜¯ç¼–è¯‘å™¨ç”Ÿæˆçš„çŠ¶æ€æœºã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">DownloadAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"å¼€å§‹ä¸‹è½½"</span><span class="p">);</span> <span class="c1">// åŒæ­¥æ‰§è¡Œ</span>
    
    <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
    <span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="n">url</span><span class="p">);</span> <span class="c1">// å¼‚æ­¥ç­‰å¾…ç‚¹</span>
    
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"ä¸‹è½½å®Œæˆ"</span><span class="p">);</span> <span class="c1">// å¼‚æ­¥ç»§ç»­æ‰§è¡Œ</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="nf">ToUpper</span><span class="p">();</span> <span class="c1">// åŒæ­¥æ‰§è¡Œ</span>
<span class="p">}</span>

<span class="c1">// ç¼–è¯‘å™¨å®é™…ç”Ÿæˆçš„çŠ¶æ€æœºä¼ªä»£ç ï¼š</span>
<span class="c1">// - çŠ¶æ€0ï¼šå¼€å§‹æ‰§è¡Œ</span>
<span class="c1">// - çŠ¶æ€1ï¼šawaitä¹‹åçš„ç»§ç»­æ‰§è¡Œ</span>
</code></pre></div></div>

<h3 id="asyncå…³é”®å­—">asyncå…³é”®å­—</h3>

<p>â€ƒâ€ƒasyncå…³é”®å­—ç”¨äºå£°æ˜å¼‚æ­¥æ–¹æ³•ï¼Œasyncå…³é”®å­—ç”¨äºä¿®é¥°æ–¹æ³•ï¼Œè¡¨ç¤ºè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ã€‚å¦‚æœä¸æ˜¯å¼‚æ­¥æ–¹æ³•å°±ä¸è¦ä¹±åŠ asyncå…³é”®å­—ï¼Œå› ä¸ºè°ƒç”¨asyncæ–¹æ³•ä¼šæœ‰æ˜¾è‘—çš„æ€§èƒ½æŸå¤±ã€‚åŒæ ·çš„æ–¹æ³•ç”¨é€šå¸¸çš„åŒæ­¥å®šä¹‰ï¼Œè¦æ¯”åŠ ä¸Šasyncå…³é”®å­—ä¿®é¥°çš„å¿«40-50å€ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="nn">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒé¿å…ä½¿ç”¨async voidæ–¹æ³•ï¼Œè¿™æ˜¯éå¸¸å±é™©çš„ï¼Œå¼‚å¸¸å¤„ç†å®¹æ˜“å¿½ç•¥ï¼Œå¤„ç†ä¸å½“å®¹æ˜“é€ æˆè¿›ç¨‹å´©æºƒã€‚å¦‚æœasyncæ–¹æ³•è¿”å›Taskï¼ŒTaskå¯¹è±¡å¾ˆå®¹æ˜“ç›‘æ§ï¼Œå¼‚å¸¸ä¹Ÿè¢«åŒ…è£…åœ¨å†…ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">public</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"å¼‚å¸¸"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"å¼‚å¸¸"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromException</span><span class="p">(</span><span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"å¼‚å¸¸"</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="awaitå…³é”®å­—">awaitå…³é”®å­—</h3>

<p>â€ƒâ€ƒawaitå…³é”®å­—ç”¨äºç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆã€‚awaitå…³é”®å­—ç”¨äºä¿®é¥°è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºè¯¥è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚å¼‚æ­¥æ“ä½œå®Œæˆåï¼Œæ§åˆ¶æƒä¼šè¿”å›åˆ°awaitè¯­å¥æ‰€åœ¨çš„ä¸Šä¸‹æ–‡ã€‚</p>

<h3 id="configureawait">ConfigureAwait</h3>

<p>â€ƒâ€ƒConfigureAwait(bool continueOnCapturedContext)ç”¨äºé…ç½®åœ¨ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆæ—¶ï¼Œæ˜¯å¦ç»§ç»­åœ¨æ•è·çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œã€‚ä½¿ç”¨ConfigureAwait(false)å¯ä»¥é¿å…æ­»é”ï¼ŒåŒæ—¶ä¹Ÿä¸éœ€è¦å›åˆ°åŸå§‹ä¸Šä¸‹æ–‡å‡å°‘çº¿ç¨‹åˆ‡æ¢å¼€é”€ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">LibraryMethodAsync</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// âœ… ä¸éœ€è¦å›åˆ°åŸå§‹ä¸Šä¸‹æ–‡</span>
    <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">GetDataFromApiAsync</span><span class="p">().</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">processed</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">ProcessDataAsync</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">processed</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="å¼‚å¸¸å¤„ç†æ¨¡å¼">å¼‚å¸¸å¤„ç†æ¨¡å¼</h3>

<p>â€ƒâ€ƒå¼‚æ­¥æ–¹æ³•ä¸­ä½¿ç”¨try/catchå—æ•è·å¼‚å¸¸ï¼Œé€ä¸€å±•å¼€å¼‚å¸¸ï¼Œé¿å…åæ‰å¼‚å¸¸ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// âœ… æ­£ç¡®çš„å¼‚å¸¸å¤„ç†æ¨¡å¼</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">SafeExecuteAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">operation</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">operation</span><span class="p">().</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="nf">Success</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="nf">Cancelled</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">TimeoutException</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="nf">Failure</span><span class="p">(</span><span class="s">$"æ“ä½œè¶…æ—¶: </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">HttpRequestException</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="nf">Failure</span><span class="p">(</span><span class="s">$"ç½‘ç»œé”™è¯¯: </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// è®°å½•æœªé¢„æœŸçš„å¼‚å¸¸</span>
        <span class="n">Logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">"æœªå¤„ç†çš„å¼‚å¸¸"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="nf">Failure</span><span class="p">(</span><span class="s">$"æœªçŸ¥é”™è¯¯: </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// âŒ é”™è¯¯ï¼šåæ‰å¼‚å¸¸</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">BadExceptionHandling</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="nf">RiskyOperation</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span>
    <span class="p">{</span>
        <span class="c1">// é™é»˜å¿½ç•¥å¼‚å¸¸æ˜¯å±é™©çš„</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="valuetask">ValueTask</h2>

<p>â€ƒâ€ƒValueTaskæ˜¯Taskçš„è½»é‡çº§ç‰ˆæœ¬ï¼Œç”¨äºé¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é…ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// é—®é¢˜åœºæ™¯ï¼šç¼“å­˜åœºæ™¯ä¸‹çš„Taskåˆ†é…</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetDataAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_cache</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">out</span> <span class="kt">string</span> <span class="n">cachedValue</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// âŒ å³ä½¿æ•°æ®å·²ç¼“å­˜ï¼ˆåŒæ­¥å¯ç”¨ï¼‰ï¼Œä»ç„¶åˆ†é…Taskå¯¹è±¡</span>
        <span class="k">return</span> <span class="n">cachedValue</span><span class="p">;</span> <span class="c1">// ç¼–è¯‘å™¨ä¼šåŒ…è£…æˆ Task.FromResult(cachedValue)</span>
    <span class="p">}</span>
    
    <span class="c1">// åªæœ‰è¿™é‡Œæ‰çœŸæ­£éœ€è¦å¼‚æ­¥</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">_database</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="ä½¿ç”¨åœºæ™¯åˆ†æ">ä½¿ç”¨åœºæ™¯åˆ†æ</h3>

<p>â€ƒâ€ƒç¼“å­˜åœºæ™¯ä¸‹çš„ValueTaskä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">readonly</span> <span class="n">ConcurrentDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;</span> <span class="n">_userCache</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>

<span class="k">public</span> <span class="k">async</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="nf">GetUserAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">userId</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_userCache</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">cachedUser</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">cachedUser</span><span class="p">;</span> <span class="c1">// åŒæ­¥è·¯å¾„ï¼Œé›¶åˆ†é…</span>
    <span class="p">}</span>
    
    <span class="kt">var</span> <span class="n">user</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_userService</span><span class="p">.</span><span class="nf">LoadUserAsync</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
    <span class="n">_userCache</span><span class="p">.</span><span class="nf">TryAdd</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">user</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒæ¡ä»¶å¼‚æ­¥æ“ä½œçš„ValueTaskä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">ProcessAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useAsync</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">useAsync</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// åŒæ­¥å¤„ç†</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="nf">ProcessSync</span><span class="p">(</span><span class="n">input</span><span class="p">));</span>
    <span class="p">}</span>
    
    <span class="c1">// å¼‚æ­¥å¤„ç†</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="nf">ProcessAsyncInternal</span><span class="p">(</span><span class="n">input</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒå¯èƒ½ç«‹å³å®Œæˆçš„I/Oæ“ä½œçš„ValueTaskä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">async</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">ReadAsync</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// æ£€æŸ¥ç¼“å†²åŒºæ˜¯å¦æœ‰æ•°æ®</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_internalBuffer</span><span class="p">.</span><span class="n">Available</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">ReadFromBuffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span> <span class="c1">// åŒæ­¥å®Œæˆ</span>
        <span class="p">}</span>
        
        <span class="c1">// éœ€è¦ä»ç½‘ç»œè¯»å–</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">ReadFromNetworkAsync</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒçŠ¶æ€æœºä¼˜åŒ–çš„ValueTaskä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">enum</span> <span class="n">AsyncState</span> <span class="p">{</span> <span class="n">NotStarted</span><span class="p">,</span> <span class="n">InProgress</span><span class="p">,</span> <span class="n">Completed</span> <span class="p">}</span>
<span class="k">private</span> <span class="n">AsyncState</span> <span class="n">_state</span> <span class="p">=</span> <span class="n">AsyncState</span><span class="p">.</span><span class="n">NotStarted</span><span class="p">;</span>
<span class="k">private</span> <span class="kt">string</span> <span class="n">_result</span><span class="p">;</span>

<span class="k">public</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetOrCreateAsync</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">_state</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">AsyncState</span><span class="p">.</span><span class="n">Completed</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">_result</span><span class="p">);</span> <span class="c1">// ç«‹å³è¿”å›</span>
            
        <span class="k">case</span> <span class="n">AsyncState</span><span class="p">.</span><span class="n">NotStarted</span><span class="p">:</span>
            <span class="n">_state</span> <span class="p">=</span> <span class="n">AsyncState</span><span class="p">.</span><span class="n">InProgress</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="nf">CreateAsync</span><span class="p">());</span> <span class="c1">// å¼€å§‹å¼‚æ­¥æ“ä½œ</span>
            
        <span class="k">case</span> <span class="n">AsyncState</span><span class="p">.</span><span class="n">InProgress</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="nf">WaitForCompletionAsync</span><span class="p">());</span> <span class="c1">// ç­‰å¾…å®Œæˆ</span>
            
        <span class="k">default</span><span class="p">:</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>]]></content><author><name>ç¼–ç¨‹æ•£è®°</name></author><category term="CSharp" /><category term="Thread" /><summary type="html"><![CDATA[Unityæœ‰ç€ä¸¥æ ¼çš„ä¸»çº¿ç¨‹é™åˆ¶ï¼ŒåŒæ—¶Unityçš„C#åº“ä¸€ç›´æ²¡æœ‰å¾—åˆ°åŠæ—¶çš„æ›´æ–°ï¼Œå¯¼è‡´å¾ˆå¤šC#çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼åœ¨Unityä¸­æ— æ³•ä½¿ç”¨ã€‚æŒç»­åˆ°Unity2020ç‰ˆæœ¬å‘å¸ƒåŠ å…¥äº†.net 4.xæ­£å¼ç‰ˆæœ¬çš„æ”¯æŒæ‰æœ‰äº†å®Œæ•´çš„C#å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ã€‚APMã€EAPã€async/awaitå¼‚æ­¥æ¨¡å¼éƒ½æœ‰äº†ã€‚]]></summary></entry><entry><title type="html">å¤šçº¿ç¨‹ç¼–ç¨‹æ¨¡å‹ç¯‡-Task(äºŒ)</title><link href="https://www.damonc.top/csharp/Csharp_Task_Base.html" rel="alternate" type="text/html" title="å¤šçº¿ç¨‹ç¼–ç¨‹æ¨¡å‹ç¯‡-Task(äºŒ)" /><published>2025-06-06T10:00:00+00:00</published><updated>2025-06-06T10:00:00+00:00</updated><id>https://www.damonc.top/csharp/Csharp_Task_Base</id><content type="html" xml:base="https://www.damonc.top/csharp/Csharp_Task_Base.html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯task">ä»€ä¹ˆæ˜¯Task</h2>

<p>â€ƒâ€ƒä»»åŠ¡æ˜¯å¯¹è±¡ï¼Œå…¶ä¸­å°è£…äº†ä»¥å¼‚æ­¥æ–¹å¼æ‰§è¡Œçš„å·¥ä½œã€‚è¿™å¬èµ·æ¥æœ‰ç‚¹å„¿è€³ç†Ÿï¼Œå§”æ‰˜ä¸ä¹Ÿæ˜¯å°è£…äº†ä»£ç çš„å¯¹è±¡å—ï¼ŸåŒºåˆ«åœ¨äºå§”æ‰˜æ˜¯åŒæ­¥çš„è€Œä»»åŠ¡æ˜¯å¼‚æ­¥çš„ã€‚å¦‚æœæ‰§è¡Œä¸€ä¸ªå§”æ‰˜(ä¾‹å¦‚ä¸€ä¸ªAction)ï¼Œå½“å‰çº¿ç¨‹çš„æ§åˆ¶ç‚¹ä¼šç«‹å³è½¬ç§»åˆ°å§”æ‰˜çš„ä»£ç ï¼›é™¤éå§”æ‰˜ç»“æŸï¼Œå¦åˆ™æ§åˆ¶ä¸ä¼šè¿”å›è°ƒç”¨è€…ã€‚ç®€å•åœ°è¯´ï¼Œ<strong>ä»»åŠ¡æ˜¯å°†å§”æ‰˜ä»åŒæ­¥æ‰§è¡Œæ¨¡å¼è½¬å˜æˆå¼‚æ­¥æ‰§è¡Œ</strong>ã€‚</p>

<p>â€ƒâ€ƒä»»åŠ¡æ˜¯.NET4.0å¼•å…¥çš„ï¼Œæ˜¯.NET4.0ä¸­æ–°å¢çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ã€‚ç”¨ä»¥å–ä»£å¤æ‚ã€è€æ—§çš„ã€ä»£ä»·é«˜æ˜‚çš„Threadç¼–ç¨‹æ¨¡å‹ã€‚</p>

<h3 id="task-vs-çº¿ç¨‹">Task vs çº¿ç¨‹</h3>

<p>â€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">Thread</code>æ˜¯.NETä¸­æœ€åŸºç¡€çš„çº¿ç¨‹æ¨¡å‹ï¼Œå®ƒæä¾›äº†æœ€åº•å±‚çš„çº¿ç¨‹ç®¡ç†ã€‚ä½†æ˜¯Threadçš„åˆ›å»ºå’Œé”€æ¯æˆæœ¬å¾ˆé«˜ï¼Œè€Œä¸”ç¼–ç è¿‡ç¨‹ä¸èƒ½å¾ˆå¥½åœ°ç®¡ç†çº¿ç¨‹ã€‚</p>

<p>â€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">ThreadPool</code>æ˜¯.NETä¸­åŸºç¡€ç»„ä»¶ï¼Œä¸ºæ‰€æœ‰å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹æä¾›åº•å±‚æ”¯æŒå¹¶åœ¨ä¸æ–­æ”¹è¿›ä¸­ã€‚å®ƒæä¾›äº†çº¿ç¨‹çš„å¤ç”¨ï¼Œå¯ä»¥å¾ˆå¥½åœ°ç®¡ç†çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ã€‚ä½†æ˜¯ThreadPoolçš„çº¿ç¨‹åªé€‚åˆçŸ­æ—¶è½»é‡åŒ–ä»»åŠ¡ï¼Œåƒæ“ä½œI/Oè¿™æ ·çš„æ´»åŠ¨æˆ–è€…é•¿æ—¶é—´å ç”¨çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹çš„æ–¹æ³•æå¯èƒ½æ‹–æ…¢çº¿ç¨‹é˜Ÿåˆ—ä¸­çš„å…¶ä»–ä»»åŠ¡ï¼Œåè€Œæ€§èƒ½é™ä½ã€‚</p>

<p>â€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">Task</code>æ˜¯.NET4.0ä¸­æä¾›çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ï¼Œæ˜¯åŸºäºThreadPoolå®ç°çš„ï¼Œå¯ä»¥æ›´æ–¹ä¾¿åœ°ç¼–å†™å¼‚æ­¥ä»£ç ã€‚Taskçš„å¼•å…¥ä½¿å¾—å¼‚æ­¥ç¼–ç¨‹å˜å¾—æ›´åŠ ç®€å•ã€ç›´è§‚ã€‚</p>

<h3 id="taskçš„ç”Ÿå‘½å‘¨æœŸ">Taskçš„ç”Ÿå‘½å‘¨æœŸ</h3>

<p>â€ƒâ€ƒTaskçš„ç”Ÿå‘½å‘¨æœŸåŒ…å«åˆ›å»ºï¼ˆCreatedï¼‰ã€ç­‰å¾…è¿è¡Œï¼ˆWaitingToRunï¼‰ã€è¿è¡Œï¼ˆRunningï¼‰ã€å®Œæˆï¼ˆRanToCompletion/Completedï¼‰ã€å¤±è´¥ï¼ˆFaultedï¼‰æˆ–å·²å–æ¶ˆï¼ˆCanceledï¼‰ç­‰é˜¶æ®µã€‚</p>

<pre><code class="language-mermaid2">graph LR
    A[Task Created&lt;br/&gt;Created] --&gt; B{Task Started?}
    
    B --&gt;|No| C[WaitingToRun]
    B --&gt;|Yes| D[Running]
    
    C --&gt; E[Task Started]
    E --&gt; D
    
    D --&gt; F{Task Completed?}
    D --&gt; G{Task Cancelled?}
    D --&gt; H{Task Faulted?}
    
    F --&gt;|Yes| I[RanToCompletion]
    G --&gt;|Yes| J[Cancelled]
    H --&gt;|Yes| K[Faulted]
    
    I --&gt; L[Task Completed&lt;br/&gt;Final State]
    J --&gt; L
    K --&gt; L
    
    style A fill:#e1f5fe
    style L fill:#c8e6c9
    style D fill:#fff3e0
    style I fill:#e8f5e8
    style J fill:#ffebee
    style K fill:#fff3e0
</code></pre>

<h2 id="taskçš„api">Taskçš„API</h2>

<p>â€ƒâ€ƒä»Taskæ„é€ å‡½æ•°åˆ›å»ºTaskå®ä¾‹å¼€å§‹ã€‚System.Threading.Taskså‘½åç©ºé—´ä¸‹æä¾›äº†Taskç±»ã€‚</p>

<h3 id="taskæ„é€ å‡½æ•°">Taskæ„é€ å‡½æ•°</h3>

<p>â€ƒâ€ƒTaskçš„æ„é€ å‡½æ•°æœ‰å¤šä¸ªé‡è½½ï¼Œä¸»è¦ç”¨äºåˆ›å»ºTaskå¯¹è±¡ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å†…éƒ¨æ„é€ å‡½æ•°ç­¾å</span>
<span class="k">internal</span> <span class="nf">Task</span><span class="p">(</span><span class="n">Delegate</span><span class="p">,</span><span class="kt">object</span><span class="p">,</span><span class="n">Task</span><span class="p">,</span><span class="n">CancellationToken</span><span class="p">,</span>
    <span class="n">TaskCreationOptions</span><span class="p">,</span><span class="n">InternalTaskOptions</span><span class="p">,</span><span class="n">TaskScheduler</span><span class="p">)</span>

<span class="c1">// åˆ›å»ºä¸€ä¸ªTaskå¯¹è±¡ï¼Œå‚æ•°ä¸ºè¦æ‰§è¡Œçš„å§”æ‰˜</span>
<span class="k">public</span> <span class="nf">Task</span><span class="p">(</span><span class="n">Action</span><span class="p">)</span>
<span class="c1">// åˆ›å»ºä¸€ä¸ªTaskå¯¹è±¡ï¼Œå‚æ•°ä¸ºè¦æ‰§è¡Œçš„å§”æ‰˜ï¼Œå‚æ•°ä¸ºå–æ¶ˆä»¤ç‰Œ</span>
<span class="k">public</span> <span class="nf">Task</span><span class="p">(</span><span class="n">Action</span><span class="p">,</span> <span class="n">CancellationToken</span><span class="p">)</span>
<span class="c1">// åˆ›å»ºä¸€ä¸ªTaskå¯¹è±¡ï¼Œå‚æ•°ä¸ºè¦æ‰§è¡Œçš„å§”æ‰˜ï¼Œå‚æ•°ä¸ºTaskCreationOptionsæšä¸¾çš„å€¼</span>
<span class="k">public</span> <span class="nf">Task</span><span class="p">(</span><span class="n">Action</span><span class="p">,</span> <span class="n">TaskCreationOptions</span><span class="p">)</span>
<span class="c1">// åˆ›å»ºä¸€ä¸ªTaskå¯¹è±¡ï¼Œå‚æ•°ä¸ºè¦æ‰§è¡Œçš„å§”æ‰˜ï¼Œå‚æ•°ä¸ºå–æ¶ˆä»¤ç‰Œï¼Œå‚æ•°ä¸ºTaskCreationOptionsæšä¸¾çš„å€¼</span>
<span class="k">public</span> <span class="nf">Task</span><span class="p">(</span><span class="n">Action</span><span class="p">,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskCreationOptions</span><span class="p">)</span>
<span class="c1">// åˆ›å»ºä¸€ä¸ªTaskå¯¹è±¡ï¼Œå‚æ•°ä¸ºè¦æ‰§è¡Œçš„å§”æ‰˜ï¼Œå‚æ•°æ˜¯ä¼ é€’ç»™å§”æ‰˜çš„</span>
<span class="k">public</span> <span class="nf">Task</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Object</span><span class="p">&gt;,</span> <span class="n">Object</span><span class="p">)</span>
<span class="c1">// åˆ›å»ºä¸€ä¸ªTaskå¯¹è±¡ï¼Œå‚æ•°ä¸ºè¦æ‰§è¡Œçš„å§”æ‰˜ï¼Œå‚æ•°æ˜¯ä¼ é€’ç»™å§”æ‰˜çš„ï¼Œå‚æ•°ä¸ºå–æ¶ˆä»¤ç‰Œ</span>
<span class="k">public</span> <span class="nf">Task</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Object</span><span class="p">&gt;,</span> <span class="n">Object</span><span class="p">,</span> <span class="n">CancellationToken</span><span class="p">)</span>
<span class="c1">// åˆ›å»ºä¸€ä¸ªTaskå¯¹è±¡ï¼Œå‚æ•°ä¸ºè¦æ‰§è¡Œçš„å§”æ‰˜ï¼Œå‚æ•°æ˜¯ä¼ é€’ç»™å§”æ‰˜çš„ï¼Œå‚æ•°ä¸ºTaskCreationOptionsæšä¸¾çš„å€¼</span>
<span class="k">public</span> <span class="nf">Task</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Object</span><span class="p">&gt;,</span> <span class="n">Object</span><span class="p">,</span> <span class="n">TaskCreationOptions</span><span class="p">)</span>
<span class="c1">// åˆ›å»ºä¸€ä¸ªTaskå¯¹è±¡ï¼Œå‚æ•°ä¸ºè¦æ‰§è¡Œçš„å§”æ‰˜ï¼Œå‚æ•°æ˜¯ä¼ é€’ç»™å§”æ‰˜çš„ï¼Œå‚æ•°ä¸ºå–æ¶ˆä»¤ç‰Œï¼Œå‚æ•°ä¸ºTaskCreationOptionsæšä¸¾çš„å€¼</span>
<span class="k">public</span> <span class="nf">Task</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Object</span><span class="p">&gt;,</span> <span class="n">Object</span><span class="p">,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskCreationOptions</span><span class="p">)</span>
</code></pre></div></div>

<p>â€ƒâ€ƒè™½ç„¶Taskçš„æ„é€ å‡½æ•°æœ‰å¤šä¸ªé‡è½½ï¼Œä½†æ˜¯<a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.threading.tasks.task.-ctor?view=net-9.0#system-threading-tasks-task-ctor(system-action)">å®˜æ–¹ç¤ºä¾‹</a>æ¨èå¸¸è§åšæ³•è¿˜æ˜¯ä½¿ç”¨Task.Runæˆ–TaskFactory.StartNewæ–¹æ³•æ¥åˆ›å»ºTaskå¯¹è±¡ã€‚</p>

<div class="premonition info"> <div class="header"> <svg class="icon info" aria-hidden="true"> <use xlink:href="#icon-info"></use> </svg> <div class="title"> æ¨èä½¿ç”¨æ–¹å¼ </div> </div> <div class="content"> <p>æ¯ä¸€ä¸ªTaskæ„é€ å‡½æ•°ï¼Œéƒ½æä¾›äº†å¯¹åº”ç‰ˆæœ¬çš„Task.Runæˆ–è€…TaskFactory.StartNewæ–¹æ³•ã€‚å®˜æ–¹ç¤ºä¾‹ä¸­çš„æ‰€æœ‰æ„é€ å‡½æ•°éƒ½å¤šæ¬¡æ¨èä½¿ç”¨ä¸Šè¿°æ–¹æ³•æ¥åˆ›å»ºTaskå¯¹è±¡ã€‚é™¤äº†è¦å®ç°ä¸€å¥—æ›´é«˜çº§åˆ«çš„åˆ†ç¦»ä»»åŠ¡åˆ›å»ºå’Œå¯åŠ¨çš„é«˜çº§æ–¹æ¡ˆã€‚</p>



 </div> </div>

<h3 id="ä½¿ç”¨taskrun">ä½¿ç”¨Task.Run</h3>

<p>â€ƒâ€ƒå¯¹åœ¨ ThreadPool ä¸Šè¿è¡Œçš„æŒ‡å®šå·¥ä½œè¿›è¡Œæ’é˜Ÿï¼Œå¹¶ä¸ºè¯¥å·¥ä½œè¿”å›ä»»åŠ¡æˆ–Task<TResult>å¥æŸ„ã€‚å®ƒæ˜¯StartNewé‡è½½çš„è½»å‹æ›¿ä»£æ–¹æ³•ã€‚</TResult></p>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Run(Func<Task>, CancellationToken)</Task></td>
      <td>åœ¨çº¿ç¨‹æ± ä¸Šæ’é˜Ÿè¿è¡Œä»»åŠ¡ï¼Œè¿”å›ä»»åŠ¡ä»£ç†ã€‚å¯å–æ¶ˆã€‚</td>
    </tr>
    <tr>
      <td>Run(Action, CancellationToken)</td>
      <td>åœ¨çº¿ç¨‹æ± ä¸Šæ’é˜Ÿè¿è¡Œå·¥ä½œï¼Œè¿”å›Taskå¯¹è±¡ã€‚å¯å–æ¶ˆã€‚</td>
    </tr>
    <tr>
      <td>Run(Func<Task>)</Task></td>
      <td>åœ¨çº¿ç¨‹æ± ä¸Šæ’é˜Ÿè¿è¡Œä»»åŠ¡ï¼Œè¿”å›ä»»åŠ¡ä»£ç†ã€‚</td>
    </tr>
    <tr>
      <td>Run(Action)</td>
      <td>åœ¨çº¿ç¨‹æ± ä¸Šæ’é˜Ÿè¿è¡Œå·¥ä½œï¼Œè¿”å›Taskå¯¹è±¡ã€‚</td>
    </tr>
    <tr>
      <td>Run<TResult>(Func&lt;Task<TResult>&gt;)</TResult></TResult></td>
      <td>åœ¨çº¿ç¨‹æ± ä¸Šæ’é˜Ÿè¿è¡Œä»»åŠ¡ï¼Œè¿”å›Task(TResult)ä»£ç†ã€‚</td>
    </tr>
    <tr>
      <td>Run<TResult>(Func<TResult>)</TResult></TResult></td>
      <td>åœ¨çº¿ç¨‹æ± ä¸Šæ’é˜Ÿè¿è¡Œå·¥ä½œï¼Œè¿”å›Task<TResult>å¯¹è±¡ã€‚</TResult></td>
    </tr>
    <tr>
      <td>Run<TResult>(Func&lt;Task<TResult>&gt;, CancellationToken)</TResult></TResult></td>
      <td>åœ¨çº¿ç¨‹æ± ä¸Šæ’é˜Ÿè¿è¡Œä»»åŠ¡ï¼Œè¿”å›Task(TResult)ä»£ç†ã€‚</td>
    </tr>
    <tr>
      <td>Run<TResult>(Func<TResult>, CancellationToken)</TResult></TResult></td>
      <td>åœ¨çº¿ç¨‹æ± ä¸Šæ’é˜Ÿè¿è¡Œå·¥ä½œï¼Œè¿”å›Task<TResult>å¯¹è±¡ã€‚</TResult></td>
    </tr>
  </tbody>
</table>

<p>â€ƒâ€ƒæ–°çº¿ç¨‹è¦è¿è¡Œçš„ä»£ç ç”±ä¼ ç»™Task.Run()æ–¹æ³•çš„å§”æ‰˜(æœ¬ä¾‹æ˜¯Actionç±»å‹)æ¥å®šä¹‰ã€‚è¿™ä¸ªå§”æ‰˜(ä»¥Lambdaè¡¨è¾¾å¼çš„å½¢å¼)åœ¨æ§åˆ¶å°ä¸æ–­æ‰“å°ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"-"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Task</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"."</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">})</span>
<span class="n">task</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
</code></pre></div></div>

<div class="premonition warning"> <div class="header"> <svg class="icon warning" aria-hidden="true"> <use xlink:href="#icon-warning"></use> </svg> <div class="title"> ä»»åŠ¡çš„å†·ä¸çƒ­ </div> </div> <div class="content"> <p>è°ƒç”¨Task.Run()ä¹‹åï¼Œä½œä¸ºå‚æ•°ä¼ é€’çš„ Actionå‡ ä¹ç«‹å³å¼€å§‹æ‰§è¡Œã€‚è¿™ç§°ä¸ºâ€œçƒ­â€ä»»åŠ¡ï¼Œå³å·²è§¦å‘å¹¶å¼€å§‹æ‰§è¡Œ(æˆ–å·²å¼€å§‹æ’é˜Ÿç­‰å¾…æ‰§è¡Œ)ã€‚</p>

<p>new Task()åˆ™æ˜¯â€œå†·â€ä»»åŠ¡ï¼Œå®ƒéœ€è¦åœ¨æ˜¾å¼è§¦å‘startä¹‹åæ‰å¼€å§‹è¿›å…¥çº¿ç¨‹æ± æ’é˜Ÿå»æ‰§è¡Œä»»åŠ¡ã€‚åœ¨startä¹‹å‰ä¸èƒ½è°ƒç”¨waitã€getRuseltç­‰ã€‚</p>



 </div> </div>
<h3 id="ä½¿ç”¨taskfactory">ä½¿ç”¨Task.Factory</h3>

<p>â€ƒâ€ƒå¯åŠ¨Taskå¯¹è±¡å¹¶å°†ä»»åŠ¡è°ƒåº¦åˆ°TaskSchedulerï¼Œå®ƒä¸Runæ–¹æ³•åŸºæœ¬ç›¸åŒï¼Œä½†è¿”å›Taskå¯¹è±¡è€Œä¸æ˜¯Task<TResult>ä»£ç†ã€‚å¯ä»¥è°ƒç”¨TaskFactoryç±»çš„æ„é€ å‡½æ•°æ¥é…ç½® TaskFactoryç±»åˆ›å»ºæ‰€éœ€è¦çš„æ¨¡ç‰ˆä»»åŠ¡ã€‚</TResult></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">CancellationTokenSource</span> <span class="n">cts</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">();</span>

<span class="k">static</span> <span class="n">TaskFactory</span> <span class="n">factory</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TaskFactory</span><span class="p">(</span>
    <span class="n">cts</span><span class="p">.</span><span class="n">Token</span><span class="p">,</span>
    <span class="n">TaskCreationOptions</span><span class="p">.</span><span class="n">PreferFairness</span><span class="p">,</span>
    <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">ExecuteSynchronously</span><span class="p">,</span>
    <span class="k">new</span> <span class="nf">CustomScheduler</span><span class="p">());</span>

<span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">t2</span> <span class="p">=</span> <span class="n">factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">DoWork</span><span class="p">());</span>
    <span class="n">cts</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">void</span> <span class="nf">DoWork</span><span class="p">()</span> <span class="p">{</span><span class="cm">/*...*/</span> <span class="p">}</span>
</code></pre></div></div>

<h2 id="taskçš„æ ¸å¿ƒå±æ€§">Taskçš„æ ¸å¿ƒå±æ€§</h2>

<table>
  <thead>
    <tr>
      <th>å±æ€§</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Status</td>
      <td>è·å–ä»»åŠ¡çš„å½“å‰çŠ¶æ€ã€‚</td>
    </tr>
    <tr>
      <td>IsCompleted</td>
      <td>è¯¥å€¼æŒ‡ç¤ºTaskæ˜¯å¦å·²é€šè¿‡è¿è¡Œå…¶æ–¹æ³•å®Œæˆæ‰§è¡Œã€‚</td>
    </tr>
    <tr>
      <td>IsFaulted</td>
      <td>è¯¥å€¼æŒ‡ç¤ºTaskæ˜¯å¦ç”±äºæœªå¤„ç†å¼‚å¸¸è€Œå®Œæˆæ‰§è¡Œã€‚</td>
    </tr>
    <tr>
      <td>IsCanceled</td>
      <td>è¯¥å€¼æŒ‡ç¤ºTaskæ˜¯å¦ç”±äºè¢«å–æ¶ˆè€Œå®Œæˆæ‰§è¡Œã€‚</td>
    </tr>
    <tr>
      <td>Exception</td>
      <td>è·å–ä¸€ä¸ªå¼‚å¸¸ï¼Œè¯¥å¼‚å¸¸æ˜¯Taskå› æœªå¤„ç†å¼‚å¸¸è€Œå®Œæˆæ—¶å¼•å‘çš„ã€‚</td>
    </tr>
    <tr>
      <td>Result</td>
      <td>è·å–Taskçš„ç»“æœå€¼ã€‚</td>
    </tr>
    <tr>
      <td>Id</td>
      <td>è·å–ä»»åŠ¡çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚</td>
    </tr>
  </tbody>
</table>

<h2 id="taskçš„ç­‰å¾…å’ŒåŒæ­¥">Taskçš„ç­‰å¾…å’ŒåŒæ­¥</h2>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•</th>
      <th>è¿”å›ç±»å‹</th>
      <th>è¯´æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>WaitAny</td>
      <td>int</td>
      <td>è¿”å›å·²å®ŒæˆTaskåœ¨æ•°ç»„ä¸­çš„ç´¢å¼•</td>
    </tr>
    <tr>
      <td>WaitAll</td>
      <td>void</td>
      <td>æ— è¿”å›å€¼ï¼Œé˜»å¡ç›´åˆ°æ‰€æœ‰å®Œæˆ</td>
    </tr>
    <tr>
      <td>WhenAny</td>
      <td>Task<Task></Task></td>
      <td>è¿”å›ä¸€ä¸ªTaskï¼Œå…¶Resultæ˜¯ç¬¬ä¸€ä¸ªå®Œæˆçš„Task</td>
    </tr>
    <tr>
      <td>WhenAll</td>
      <td>Task æˆ– Task&lt;TResult[]&gt;</td>
      <td>è¿”å›ä¸€ä¸ªTaskï¼Œå½“æ‰€æœ‰è¾“å…¥Taskå®Œæˆåå®Œæˆ</td>
    </tr>
  </tbody>
</table>

<p>â€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">Waitæ¥å£æ˜¯é˜»å¡æ–¹æ³•</code>ã€‚æ˜¯ä¸ç®¡æ˜¯å“ªä¸€ç§Waitã€WaitAnyã€WaitAllä»–ä»¬éƒ½é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³ã€‚å¼‚å¸¸ä¼šç›´æ¥æŠ›å‡ºï¼Œéœ€è¦ç«‹å³å¤„ç†ã€‚</p>

<p>â€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">Whenæ¥å£æ˜¯éé˜»å¡æ–¹æ³•</code>ã€‚éƒ½æ˜¯éé˜»å¡æ–¹æ³•ï¼Œå®ƒä»¬ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªTaskï¼Œå½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œè¯¥Taskä¼šå®Œæˆã€‚å¼‚å¸¸è¢«åŒ…è£…åœ¨è¿”å›çš„Taskä¸­ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ä¼ ç»Ÿæ–¹å¼ - é˜»å¡</span>
<span class="n">Task</span><span class="p">[]</span> <span class="n">tasks</span> <span class="p">=</span> <span class="p">{</span> <span class="nf">Task1</span><span class="p">(),</span> <span class="nf">Task2</span><span class="p">(),</span> <span class="nf">Task3</span><span class="p">()</span> <span class="p">};</span>
<span class="kt">int</span> <span class="n">index</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WaitAny</span><span class="p">(</span><span class="n">tasks</span><span class="p">);</span>  <span class="c1">// é˜»å¡ç­‰å¾…</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Task </span><span class="p">{</span><span class="n">index</span><span class="p">}</span><span class="s"> completed first"</span><span class="p">);</span>

<span class="c1">// å¼‚æ­¥æ–¹å¼ - éé˜»å¡</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span> <span class="n">whenAnyResult</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAny</span><span class="p">(</span><span class="n">tasks</span><span class="p">);</span>
<span class="n">Task</span> <span class="n">completedTask</span> <span class="p">=</span> <span class="k">await</span> <span class="n">whenAnyResult</span><span class="p">;</span>  <span class="c1">// ä¸é˜»å¡çº¿ç¨‹</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"First task completed"</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="taskæ¥å£ä¸€è‡´æ€§">Taskæ¥å£ä¸€è‡´æ€§</h3>

<p>â€ƒâ€ƒFromResultã€FromExceptionã€FromCanceledæ˜¯Taskçš„é™æ€æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºå·²å®Œæˆçš„Taskå¯¹è±¡ã€‚è¿™äº›æ–¹æ³•çš„ä¸»è¦ä»·å€¼åœ¨äºä¿æŒå¼‚æ­¥æ¥å£çš„ä¸€è‡´æ€§ï¼Œå°¤å…¶æ˜¯åœ¨æ— æ³•ä½¿ç”¨async/awaitå…³é”®å­—çš„æƒ…å†µä¸‹ï¼Œç¬¦åˆTask<T>çš„å¥‘çº¦ã€‚</T></p>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>FromResult</td>
      <td>åˆ›å»ºä¸€ä¸ªå·²å®Œæˆçš„Taskå¯¹è±¡ï¼Œå‚æ•°ä¸ºç»“æœ</td>
    </tr>
    <tr>
      <td>FromException</td>
      <td>åˆ›å»ºä¸€ä¸ªå·²å®Œæˆçš„Taskå¯¹è±¡ï¼Œå‚æ•°ä¸ºå¼‚å¸¸</td>
    </tr>
    <tr>
      <td>FromCanceled</td>
      <td>åˆ›å»ºä¸€ä¸ªå·²å®Œæˆçš„Taskå¯¹è±¡ï¼Œå‚æ•°ä¸ºå–æ¶ˆä»¤ç‰Œ</td>
    </tr>
  </tbody>
</table>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IMathService</span>
<span class="p">{</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="nf">DivideAsync</span><span class="p">(</span><span class="kt">double</span> <span class="n">numerator</span><span class="p">,</span> <span class="kt">double</span> <span class="n">denominator</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">MathService</span> <span class="p">:</span> <span class="n">IMathService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="nf">DivideAsync</span><span class="p">(</span><span class="kt">double</span> <span class="n">numerator</span><span class="p">,</span> <span class="kt">double</span> <span class="n">denominator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// åŒæ­¥çš„å‚æ•°éªŒè¯</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">denominator</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// å‘ç°é”™è¯¯ï¼Œç«‹å³è¿”å›ä¸€ä¸ªå¤±è´¥çš„ä»»åŠ¡ï¼Œè€Œä¸æ˜¯æŠ›å‡ºé˜»å¡æ€§å¼‚å¸¸</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromException</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;(</span><span class="k">new</span> <span class="nf">DivideByZeroException</span><span class="p">(</span><span class="s">"Denominator cannot be zero."</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="c1">// å¦‚æœéªŒè¯é€šè¿‡ï¼Œè¿›è¡ŒåŒæ­¥è®¡ç®—å¹¶è¿”å›æˆåŠŸç»“æœ</span>
        <span class="kt">double</span> <span class="n">result</span> <span class="p">=</span> <span class="n">numerator</span> <span class="p">/</span> <span class="n">denominator</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>â€ƒâ€ƒé¿å…çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ä¸å¥½ - ä¸å¿…è¦çš„çº¿ç¨‹åˆ‡æ¢v</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">BadExample</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="s">"Hello"</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// å¥½ - ç›´æ¥è¿”å›</span>
<span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GoodExample</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="taskçš„å»¶ç»­æ“ä½œ">Taskçš„å»¶ç»­æ“ä½œ</h2>

<p>â€ƒâ€ƒå»¶ç»­ä»»åŠ¡ï¼ˆContinuation Tasksï¼‰æ˜¯Taskå¹¶è¡Œåº“ä¸­æœ€é‡è¦çš„ç‰¹æ€§ä¹‹ä¸€ï¼Œå®ƒå…è®¸æ‚¨åœ¨æŸä¸ªä»»åŠ¡å®Œæˆåè‡ªåŠ¨æ‰§è¡Œåç»­æ“ä½œï¼Œå½¢æˆä»»åŠ¡é“¾ã€‚å»¶ç»­ä»»åŠ¡çš„æ ¸å¿ƒæ–¹æ³•æ˜¯ContinueWithã€‚</p>

<h3 id="taskcontinuewith">Task.ContinueWith</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span> <span class="n">continuationAction</span><span class="p">);</span>
<span class="k">public</span> <span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span> <span class="n">continuationAction</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span> <span class="n">continuationOptions</span><span class="p">);</span>
<span class="k">public</span> <span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span> <span class="n">continuationAction</span><span class="p">,</span> <span class="n">TaskScheduler</span> <span class="n">scheduler</span><span class="p">);</span>
<span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;</span> <span class="n">continuationFunction</span><span class="p">);</span>
</code></pre></div></div>

<p>å…³é”®ç‰¹æ€§ï¼š</p>
<ol>
  <li>éé˜»å¡æ€§ï¼šå»¶ç»­ä»»åŠ¡ä¸ä¼šé˜»å¡å‰ç½®ä»»åŠ¡çš„å®Œæˆ</li>
  <li>è‡ªåŠ¨è°ƒåº¦ï¼šå½“ä»»åŠ¡å®Œæˆæ—¶ï¼Œå»¶ç»­ä»»åŠ¡ä¼šè‡ªåŠ¨è¢«è°ƒåº¦æ‰§è¡Œ</li>
  <li>çŠ¶æ€æ„ŸçŸ¥ï¼šå»¶ç»­ä»»åŠ¡å¯ä»¥é€šè¿‡Taskå‚æ•°è®¿é—®å‰ç½®ä»»åŠ¡çš„çŠ¶æ€ã€ç»“æœå’Œå¼‚å¸¸</li>
</ol>

<p>â€ƒâ€ƒå»¶ç»­ä»»åŠ¡çš„æ‰§è¡Œä¾èµ–äºå‰ç½®ä»»åŠ¡çš„çŠ¶æ€ï¼š</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Task</span> <span class="n">antecedent</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">ComputeData</span><span class="p">());</span>

<span class="n">Task</span> <span class="n">continuation</span> <span class="p">=</span> <span class="n">antecedent</span><span class="p">.</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ä»»åŠ¡æˆåŠŸå®Œæˆ</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">IsFaulted</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ä»»åŠ¡å‡ºç°å¼‚å¸¸</span>
        <span class="kt">var</span> <span class="n">exception</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">Exception</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">IsCanceled</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ä»»åŠ¡è¢«å–æ¶ˆ</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"ä»»åŠ¡è¢«å–æ¶ˆ"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="å»¶ç»­ä»»åŠ¡çš„é€‰é¡¹">å»¶ç»­ä»»åŠ¡çš„é€‰é¡¹</h3>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. æ— æ¡ä»¶æ‰§è¡Œ - æ— è®ºå‰ç½®ä»»åŠ¡ä»€ä¹ˆçŠ¶æ€éƒ½æ‰§è¡Œ</span>
<span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">None</span>

<span class="c1">// 2. æ¡ä»¶æ‰§è¡Œé€‰é¡¹</span>
<span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnRanToCompletion</span>    <span class="c1">// ä»…åœ¨å‰ç½®ä»»åŠ¡æˆåŠŸå®Œæˆæ—¶æ‰§è¡Œ</span>
<span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnFaulted</span>           <span class="c1">// ä»…åœ¨å‰ç½®ä»»åŠ¡å¤±è´¥æ—¶æ‰§è¡Œ  </span>
<span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnCanceled</span>          <span class="c1">// ä»…åœ¨å‰ç½®ä»»åŠ¡å–æ¶ˆæ—¶æ‰§è¡Œ</span>

<span class="c1">// 3. æ”¯æŒç»„åˆæ¡ä»¶</span>
<span class="n">OnlyOnRanToCompletion</span> <span class="p">|</span> <span class="n">OnlyOnFaulted</span>
</code></pre></div></div>

<h3 id="é“¾å¼å»¶ç»­ä»»åŠ¡">é“¾å¼å»¶ç»­ä»»åŠ¡</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">DownloadData</span><span class="p">())</span>
<span class="p">.</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
    <span class="k">return</span> <span class="nf">ProcessData</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">},</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnRanToCompletion</span><span class="p">)</span>
<span class="p">.</span><span class="nf">Uwarp</span><span class="p">()</span>
<span class="p">.</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">processedData</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
    <span class="k">return</span> <span class="nf">SaveResults</span><span class="p">(</span><span class="n">processedData</span><span class="p">);</span>
<span class="p">},</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnRanToCompletion</span><span class="p">);</span>

<span class="k">return</span> <span class="n">task</span><span class="p">;</span>
</code></pre></div></div>

<p>â€ƒâ€ƒUnwrapæ˜¯Taskçš„æ‰©å±•æ–¹æ³•ï¼Œç”¨äºå°†Task&lt;Task<T>&gt;è§£åŒ…ä¸ºTask<T>ã€‚å¯ä»¥å°†é“¾å¼ä»»åŠ¡è§£åŒ…ï¼Œé¿å…åµŒå¥—çš„Taskã€‚</T></T></p>

<h2 id="taskçš„å¼‚å¸¸å¤„ç†">Taskçš„å¼‚å¸¸å¤„ç†</h2>

<p>â€ƒâ€ƒä¸èƒ½ç”¨tryå—åŒ…è£…start()è°ƒç”¨æ¥æ•æ‰å¼‚å¸¸ï¼Œå› ä¸ºæ§åˆ¶ä¼šç«‹å³ä»è°ƒç”¨è¿”å›ï¼Œç„¶åæ§åˆ¶ä¼šç¦»å¼€tryå—ï¼Œè€Œè¿™æ—¶è·ç¦»å·¥ä½œè€…çº¿ç¨‹å‘ç”Ÿå¼‚å¸¸å¯èƒ½è¿˜æœ‰å¥½ä¹…å‘¢ ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯å°†ä»»åŠ¡çš„å§”æ‰˜ä¸»ä½“åŒ…è£…åˆ°try/catchå—ä¸­ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"Something went wrong"</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// å¼‚å¸¸æ­¤æ—¶è¿˜æ²¡æœ‰æŠ›å‡º</span>
<span class="c1">// åªæœ‰åœ¨ä»¥ä¸‹æ“ä½œæ—¶æ‰ä¼šæŠ›å‡ºï¼š</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="n">task</span><span class="p">.</span><span class="nf">Wait</span><span class="p">();</span>  <span class="c1">// ç›´æ¥æŠ›å‡ºå¼‚å¸¸</span>
    <span class="c1">// æˆ–</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>  <span class="c1">// é€šè¿‡ResultæŠ›å‡º</span>
    <span class="c1">// æˆ–åœ¨asyncæ–¹æ³•ä¸­</span>
    <span class="k">await</span> <span class="n">task</span><span class="p">;</span>  <span class="c1">// awaitæ—¶æŠ›å‡º</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidOperationException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="å¼‚å¸¸ä¼ æ’­æœºåˆ¶">å¼‚å¸¸ä¼ æ’­æœºåˆ¶</h3>

<p>â€ƒâ€ƒå½“ä¸€ä¸ªTaskæŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¼‚å¸¸ä¼šè¢«æ•è·å¹¶å­˜å‚¨åœ¨Taskå¯¹è±¡ä¸­ï¼Œåªæœ‰åœ¨è®¿é—®Resultå±æ€§ã€è°ƒç”¨Wait()æˆ–awaitæ—¶æ‰ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¼‚å¸¸å¯ä»¥åœ¨ä»»ä½•çº¿ç¨‹ä¸Šè¢«è§‚å¯Ÿåˆ°ã€‚</p>

<h3 id="aggregateexceptionè¯¦è§£">AggregateExceptionè¯¦è§£</h3>

<p>â€ƒâ€ƒå¤šä¸ªTaskçš„å¼‚å¸¸ä¼šè¢«åŒ…è£…æˆAggregateExceptionï¼Œå¯ä»¥åµŒå¥—å…¶ä»–AggregateExceptionã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Task</span> <span class="n">task1</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{});</span>
<span class="n">Task</span> <span class="n">task2</span> <span class="p">=</span> <span class="n">task1</span><span class="p">.</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"exception"</span><span class="p">);</span>
<span class="p">});</span>

<span class="k">try</span> <span class="p">{</span>
    <span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">task1</span><span class="p">,</span> <span class="n">task2</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">AggregateException</span> <span class="n">ae</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// å¤„ç†èšåˆå¼‚å¸¸</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">innerEx</span> <span class="k">in</span> <span class="n">ae</span><span class="p">.</span><span class="n">InnerExceptions</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Inner exception: </span><span class="p">{</span><span class="n">innerEx</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// æˆ–è€…å±•å¼€æ‰€æœ‰å¼‚å¸¸</span>
    <span class="n">ae</span><span class="p">.</span><span class="nf">Flatten</span><span class="p">().</span><span class="nf">Handle</span><span class="p">(</span><span class="n">ex</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Flattened exception: </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span> <span class="c1">// è¡¨ç¤ºå·²å¤„ç†</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ">å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ</h3>

<p>â€ƒâ€ƒâ‘ ä½¿ç”¨awaitè¿›è¡Œè‡ªç„¶å¼‚å¸¸å¤„ç†ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æ¨èï¼šå¼‚å¸¸è‡ªç„¶ä¼ æ’­</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">ProcessDataAsync</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">DownloadDataAsync</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">ProcessDataAsync</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// è°ƒç”¨æ–¹è‡ªç„¶å¤„ç†å¼‚å¸¸</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">ProcessDataAsync</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidOperationException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ç›´æ¥å¤„ç†å…·ä½“å¼‚å¸¸ç±»å‹</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒâ‘¡èšåˆå¼‚å¸¸çš„å¤„ç†æ¨¡å¼</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æ¨¡å¼1ï¼šå±•å¼€å¹¶é€ä¸ªå¤„ç†</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAll</span><span class="p">(</span><span class="n">tasks</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">AggregateException</span> <span class="n">ae</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ae</span><span class="p">.</span><span class="nf">Flatten</span><span class="p">().</span><span class="nf">Handle</span><span class="p">(</span><span class="n">ex</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ex</span> <span class="k">is</span> <span class="n">IOException</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// å¤„ç†IOå¼‚å¸¸</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ex</span> <span class="k">is</span> <span class="n">ValidationException</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// å¤„ç†éªŒè¯å¼‚å¸¸</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span> <span class="c1">// æœªå¤„ç†çš„å¼‚å¸¸ä¼šé‡æ–°æŠ›å‡º</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// æ¨¡å¼2ï¼šé‡æ–°æŠ›å‡ºç¬¬ä¸€ä¸ªå¼‚å¸¸</span>
<span class="k">catch</span> <span class="p">(</span><span class="n">AggregateException</span> <span class="n">ae</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="n">ae</span><span class="p">.</span><span class="n">InnerException</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒâ‘¢é¿å…æ··ç”¨åŒæ­¥å’Œå¼‚æ­¥ç­‰å¾…</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// é¿å…ï¼šæ··ç”¨.Wait()å’Œawait</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">ProcessAsync</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="nf">DoWorkAsync</span><span class="p">();</span>
    
    <span class="c1">// ä¸è¦è¿™æ ·åš - å¯èƒ½å¯¼è‡´æ­»é”</span>
    <span class="n">task</span><span class="p">.</span><span class="nf">Wait</span><span class="p">();</span>  <span class="c1">// é˜»å¡å½“å‰çº¿ç¨‹</span>
    
    <span class="c1">// è€Œåº”è¯¥ï¼š</span>
    <span class="k">await</span> <span class="n">task</span><span class="p">;</span>  <span class="c1">// æ­£ç¡®çš„æ–¹å¼</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒâ‘£å»¶ç»­ä»»åŠ¡çš„å¼‚å¸¸å¤„ç†</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">DoWork</span><span class="p">());</span>
<span class="n">Task</span> <span class="n">continuation</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">IsFaulted</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å¤„ç†å‰ç½®ä»»åŠ¡çš„å¼‚å¸¸</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Previous task failed: </span><span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// å¤„ç†æˆåŠŸç»“æœ</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
<span class="p">},</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnRanToCompletion</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="æœªè§‚å¯Ÿå¼‚å¸¸çš„å¤„ç†">æœªè§‚å¯Ÿå¼‚å¸¸çš„å¤„ç†</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å±é™©ï¼šåˆ›å»ºTaskä½†ä¸è§‚å¯Ÿå…¶ç»“æœ</span>
<span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"This will be unobserved!"</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">// å±é™©ï¼šåˆ›å»ºTaskä½†ä¸è§‚å¯Ÿå…¶ç»“æœ</span>
<span class="n">New</span> <span class="nf">Task</span><span class="p">(()=&gt;{}).</span><span class="nf">Start</span><span class="p">();</span>
<span class="c1">// Taskè¢«åƒåœ¾å›æ”¶æ—¶æ‰ä¼šè§¦å‘UnobservedTaskException</span>
</code></pre></div></div>

<p>â€ƒâ€ƒUnityä¸­æœªè§‚å¯Ÿå¼‚å¸¸çš„å¤„ç†ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Unityä¸­å¤„ç†æœªè§‚å¯Ÿå¼‚å¸¸</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">TaskExceptionHandler</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
    <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">UnobservedTaskException</span> <span class="p">+=</span> <span class="n">HandleUnobservedException</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">void</span> <span class="nf">OnDestroy</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">UnobservedTaskException</span> <span class="p">-=</span> <span class="n">HandleUnobservedException</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">void</span> <span class="nf">HandleUnobservedException</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">UnobservedTaskExceptionEventArgs</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// åœ¨ä¸»çº¿ç¨‹å¤„ç†å¼‚å¸¸ï¼Œé¿å…Unityå´©æºƒ</span>
        <span class="n">UnityEngine</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">$"Unobserved Task Exception: </span><span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">Exception</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="n">e</span><span class="p">.</span><span class="nf">SetObserved</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="taskçš„å–æ¶ˆæœºåˆ¶">Taskçš„å–æ¶ˆæœºåˆ¶</h2>

<h3 id="cancellationtokensource">CancellationTokenSource</h3>

<p>â€ƒâ€ƒCancellationTokenSourceæ˜¯Taskå–æ¶ˆæœºåˆ¶çš„æ ¸å¿ƒç±»ï¼Œè´Ÿè´£åˆ›å»ºå’Œç®¡ç†CancellationTokenå®ä¾‹ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åˆ›å»ºCancellationTokenSource</span>
<span class="n">CancellationTokenSource</span> <span class="n">cts</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">();</span>
<span class="c1">// è·å–ä»¤ç‰Œ</span>
<span class="n">CancellationToken</span> <span class="n">token</span> <span class="p">=</span> <span class="n">cts</span><span class="p">.</span><span class="n">Token</span><span class="p">;</span>
<span class="c1">// å¯åŠ¨ä»»åŠ¡</span>
<span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(!</span><span class="n">token</span><span class="p">.</span><span class="n">IsCancellationRequested</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// æ‰§è¡Œå·¥ä½œ</span>
        <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="n">token</span><span class="p">);</span>
<span class="c1">// è¯·æ±‚å–æ¶ˆ</span>
<span class="n">cts</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
<span class="c1">// æ¸…ç†èµ„æº</span>
<span class="n">cts</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
</code></pre></div></div>

<h4 id="è¶…æ—¶cancellationtokensource">è¶…æ—¶CancellationTokenSource</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åˆ›å»ºå¸¦è¶…æ—¶çš„ä»¤ç‰Œæº</span>
<span class="n">CancellationTokenSource</span> <span class="n">cts</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">5</span><span class="p">));</span>
<span class="c1">// æˆ–è€…æ‰‹åŠ¨è®¾ç½®è¶…æ—¶</span>
<span class="n">cts</span><span class="p">.</span><span class="nf">CancelAfter</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">10</span><span class="p">));</span>
<span class="c1">// ä½¿ç”¨</span>
<span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">LongRunningOperation</span><span class="p">(</span><span class="n">cts</span><span class="p">.</span><span class="n">Token</span><span class="p">),</span> <span class="n">cts</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="é“¾æ¥cancellationtokensource">é“¾æ¥CancellationTokenSource</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CancellationTokenSource</span> <span class="n">cts1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">();</span>
<span class="n">CancellationTokenSource</span> <span class="n">cts2</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">();</span>
<span class="c1">// åˆ›å»ºé“¾æ¥çš„ä»¤ç‰Œæº</span>
<span class="k">using</span> <span class="nn">var</span> <span class="n">linkedCts</span> <span class="p">=</span> <span class="n">CancellationTokenSource</span><span class="p">.</span><span class="nf">CreateLinkedTokenSource</span><span class="p">(</span><span class="n">cts1</span><span class="p">.</span><span class="n">Token</span><span class="p">,</span> <span class="n">cts2</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
<span class="c1">// ä»»ä½•ä¸€ä¸ªä»¤ç‰Œå–æ¶ˆéƒ½ä¼šå¯¼è‡´é“¾æ¥ä»¤ç‰Œå–æ¶ˆ</span>
<span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">DoWork</span><span class="p">(</span><span class="n">linkedCts</span><span class="p">.</span><span class="n">Token</span><span class="p">),</span> <span class="n">linkedCts</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="cancellationtoken">CancellationToken</h3>

<p>â€ƒâ€ƒCancellationTokenæ˜¯ä¸å¯å˜çš„å€¼ç±»å‹ï¼Œç”¨äºä¼ é€’å–æ¶ˆè¯·æ±‚ã€‚</p>

<h4 id="æ ¸å¿ƒå±æ€§å’Œæ–¹æ³•">æ ¸å¿ƒå±æ€§å’Œæ–¹æ³•</h4>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">struct</span> <span class="nc">CancellationToken</span> <span class="p">{</span>
    <span class="c1">// å±æ€§</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsCancellationRequested</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>  <span class="c1">// æ˜¯å¦è¯·æ±‚äº†å–æ¶ˆ</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">CanBeCanceled</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>            <span class="c1">// æ˜¯å¦å¯ä»¥è¢«å–æ¶ˆ</span>
    <span class="k">public</span> <span class="n">WaitHandle</span> <span class="n">WaitHandle</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>         <span class="c1">// ç”¨äºåŒæ­¥ç­‰å¾…</span>
    
    <span class="c1">// æ–¹æ³•</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ThrowIfCancellationRequested</span><span class="p">()</span>    <span class="c1">// æŠ›å‡ºå–æ¶ˆå¼‚å¸¸</span>
    <span class="k">public</span> <span class="n">CancellationTokenRegistration</span> <span class="nf">Register</span><span class="p">(</span><span class="n">Action</span> <span class="n">callback</span><span class="p">)</span>  <span class="c1">// æ³¨å†Œå–æ¶ˆå›è°ƒ</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="åŸºæœ¬å–æ¶ˆæ£€æŸ¥æ¨¡å¼">åŸºæœ¬å–æ¶ˆæ£€æŸ¥æ¨¡å¼</h4>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">DoWorkAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ–¹å¼1ï¼šè½®è¯¢æ£€æŸ¥</span>
    <span class="k">while</span> <span class="p">(!</span><span class="n">token</span><span class="p">.</span><span class="n">IsCancellationRequested</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>  <span class="c1">// è‡ªåŠ¨å¤„ç†å–æ¶ˆ</span>
    <span class="p">}</span>
    
    <span class="c1">// æ–¹å¼2ï¼šå®šæœŸæ£€æŸ¥</span>
    <span class="n">token</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>
    <span class="k">await</span> <span class="nf">DoStep1Async</span><span class="p">();</span>
    
    <span class="n">token</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>
    <span class="k">await</span> <span class="nf">DoStep2Async</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="æ³¨å†Œå–æ¶ˆå›è°ƒ">æ³¨å†Œå–æ¶ˆå›è°ƒ</h4>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CancellationToken</span> <span class="n">token</span> <span class="p">=</span> <span class="n">cts</span><span class="p">.</span><span class="n">Token</span><span class="p">;</span>

<span class="c1">// æ³¨å†Œå–æ¶ˆæ—¶çš„å›è°ƒ</span>
<span class="n">CancellationTokenRegistration</span> <span class="n">registration</span> <span class="p">=</span> <span class="n">token</span><span class="p">.</span><span class="nf">Register</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"ä»»åŠ¡è¢«å–æ¶ˆï¼Œæ‰§è¡Œæ¸…ç†å·¥ä½œ"</span><span class="p">);</span>
    <span class="c1">// æ¸…ç†èµ„æº</span>
<span class="p">});</span>

<span class="c1">// å–æ¶ˆæ³¨å†Œï¼ˆå¯é€‰ï¼‰</span>
<span class="n">registration</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
</code></pre></div></div>

<h3 id="å–æ¶ˆæ“ä½œçš„æ¨¡å¼">å–æ¶ˆæ“ä½œçš„æ¨¡å¼</h3>

<h4 id="åä½œå¼å–æ¶ˆæ¨¡å¼">åä½œå¼å–æ¶ˆæ¨¡å¼</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">ProcessDataAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// é˜¶æ®µ1ï¼šæ•°æ®éªŒè¯</span>
    <span class="n">token</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>
    <span class="k">await</span> <span class="nf">ValidateDataAsync</span><span class="p">();</span>
    
    <span class="c1">// é˜¶æ®µ2ï¼šæ•°æ®å¤„ç†</span>
    <span class="n">token</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">ProcessDataAsync</span><span class="p">();</span>
    
    <span class="c1">// é˜¶æ®µ3ï¼šç»“æœä¿å­˜</span>
    <span class="n">token</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>
    <span class="k">await</span> <span class="nf">SaveResultAsync</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="åŸºäºå›è°ƒçš„å–æ¶ˆæ¨¡å¼">åŸºäºå›è°ƒçš„å–æ¶ˆæ¨¡å¼</h4>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">using</span> <span class="nn">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
        
        <span class="c1">// æ³¨å†Œå–æ¶ˆå›è°ƒ</span>
        <span class="k">using</span> <span class="nn">var</span> <span class="n">registration</span> <span class="p">=</span> <span class="n">token</span><span class="p">.</span><span class="nf">Register</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="n">client</span><span class="p">.</span><span class="nf">CancelPendingRequests</span><span class="p">();</span>
        <span class="p">});</span>
        
        <span class="c1">// æ‰§è¡Œä¸‹è½½</span>
        <span class="k">return</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
    <span class="p">},</span> <span class="n">token</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="è¶…æ—¶å–æ¶ˆæ¨¡å¼">è¶…æ—¶å–æ¶ˆæ¨¡å¼</h4>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">ExecuteWithTimeoutAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
    <span class="n">Func</span><span class="p">&lt;</span><span class="n">CancellationToken</span><span class="p">,</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">operation</span><span class="p">,</span> 
    <span class="n">TimeSpan</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="k">using</span> <span class="nn">var</span> <span class="n">cts</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
    
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">operation</span><span class="p">(</span><span class="n">cts</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span><span class="p">)</span> <span class="nf">when</span> <span class="p">(</span><span class="n">cts</span><span class="p">.</span><span class="n">IsCancellationRequested</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">TimeoutException</span><span class="p">(</span><span class="s">$"æ“ä½œåœ¨</span><span class="p">{</span><span class="n">timeout</span><span class="p">.</span><span class="n">TotalSeconds</span><span class="p">}</span><span class="s">ç§’å†…æœªå®Œæˆ"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="å¤åˆå–æ¶ˆæ¨¡å¼ç”¨æˆ·å–æ¶ˆ--è¶…æ—¶">å¤åˆå–æ¶ˆæ¨¡å¼ï¼ˆç”¨æˆ·å–æ¶ˆ + è¶…æ—¶ï¼‰</h4>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">ExecuteWithUserCancellationAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
    <span class="n">Func</span><span class="p">&lt;</span><span class="n">CancellationToken</span><span class="p">,</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">operation</span><span class="p">,</span>
    <span class="n">CancellationToken</span> <span class="n">userToken</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="k">using</span> <span class="nn">var</span> <span class="n">timeoutCts</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromMinutes</span><span class="p">(</span><span class="m">5</span><span class="p">));</span>
    <span class="k">using</span> <span class="nn">var</span> <span class="n">linkedCts</span> <span class="p">=</span> <span class="n">CancellationTokenSource</span><span class="p">.</span><span class="nf">CreateLinkedTokenSource</span><span class="p">(</span>
        <span class="n">userToken</span><span class="p">,</span> <span class="n">timeoutCts</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="k">await</span> <span class="nf">operation</span><span class="p">(</span><span class="n">linkedCts</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="å–æ¶ˆæ“ä½œçš„ä¼ æ’­">å–æ¶ˆæ“ä½œçš„ä¼ æ’­</h3>

<h4 id="çˆ¶å­ä»»åŠ¡çš„å–æ¶ˆä¼ æ’­">çˆ¶å­ä»»åŠ¡çš„å–æ¶ˆä¼ æ’­</h4>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">ProcessMultipleFilesAsync</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">files</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">tasks</span> <span class="p">=</span> <span class="n">files</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">file</span> <span class="p">=&gt;</span> 
        <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">ProcessFileAsync</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">token</span><span class="p">),</span> <span class="n">token</span><span class="p">)</span>
    <span class="p">);</span>
    
    <span class="c1">// å½“ä»»ä½•ä¸€ä¸ªä»»åŠ¡å¤±è´¥æˆ–å–æ¶ˆæ—¶ï¼Œå–æ¶ˆæ‰€æœ‰ä»»åŠ¡</span>
    <span class="kt">var</span> <span class="n">allTasks</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAll</span><span class="p">(</span><span class="n">tasks</span><span class="p">);</span>
    
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">await</span> <span class="n">allTasks</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å–æ¶ˆä¼ æ’­åˆ°æ‰€æœ‰å­ä»»åŠ¡</span>
        <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="å»¶ç»­ä»»åŠ¡çš„å–æ¶ˆå¤„ç†">å»¶ç»­ä»»åŠ¡çš„å–æ¶ˆå¤„ç†</h4>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Task</span> <span class="n">initialTask</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">DoInitialWork</span><span class="p">(),</span> <span class="n">token</span><span class="p">);</span>

<span class="c1">// åªæœ‰å½“åˆå§‹ä»»åŠ¡æˆåŠŸå®Œæˆæ—¶æ‰æ‰§è¡Œå»¶ç»­</span>
<span class="n">Task</span> <span class="n">continuation1</span> <span class="p">=</span> <span class="n">initialTask</span><span class="p">.</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// å¤„ç†æˆåŠŸç»“æœ</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
<span class="p">},</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnRanToCompletion</span><span class="p">);</span>

<span class="c1">// æ— è®ºåˆå§‹ä»»åŠ¡ä»€ä¹ˆçŠ¶æ€éƒ½æ‰§è¡Œå»¶ç»­ï¼ˆç”¨äºæ¸…ç†ï¼‰</span>
<span class="n">Task</span> <span class="n">continuation2</span> <span class="p">=</span> <span class="n">initialTask</span><span class="p">.</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// æ‰§è¡Œæ¸…ç†å·¥ä½œ</span>
    <span class="nf">CleanupResources</span><span class="p">();</span>
<span class="p">},</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="å–æ¶ˆçŠ¶æ€çš„ä¼ æ’­">å–æ¶ˆçŠ¶æ€çš„ä¼ æ’­</h4>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">OperationResult</span><span class="p">&gt;</span> <span class="nf">ExecuteOperationAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">DoWorkAsync</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">OperationResult</span> <span class="p">{</span> <span class="n">Success</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">Data</span> <span class="p">=</span> <span class="n">result</span> <span class="p">};</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å–æ¶ˆçŠ¶æ€ä¼ æ’­</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">OperationResult</span> <span class="p">{</span> <span class="n">Success</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">WasCancelled</span> <span class="p">=</span> <span class="k">true</span> <span class="p">};</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å…¶ä»–å¼‚å¸¸</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">OperationResult</span> <span class="p">{</span> <span class="n">Success</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">Error</span> <span class="p">=</span> <span class="n">ex</span> <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="èµ„æºæ¸…ç†çš„å–æ¶ˆä¼ æ’­">èµ„æºæ¸…ç†çš„å–æ¶ˆä¼ æ’­</h4>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">ProcessWithCleanupAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">IDisposable</span> <span class="n">resource</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">resource</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">AcquireResourceAsync</span><span class="p">();</span>
        
        <span class="c1">// æ£€æŸ¥å–æ¶ˆçŠ¶æ€</span>
        <span class="n">token</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>
        
        <span class="k">await</span> <span class="nf">ProcessResourceAsync</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å³ä½¿å–æ¶ˆä¹Ÿè¦æ¸…ç†èµ„æº</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">resource</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">resource</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="c1">// ç¡®ä¿èµ„æºè¢«æ¸…ç†</span>
        <span class="n">resource</span><span class="p">?.</span><span class="nf">Dispose</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="å–æ¶ˆè¯·æ±‚çš„çº§è”ä¼ æ’­">å–æ¶ˆè¯·æ±‚çš„çº§è”ä¼ æ’­</h4>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="n">CancellationTokenSource</span> <span class="n">_cts</span><span class="p">;</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">StartOperation</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">_cts</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">();</span>
    <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">ExecuteOperationAsync</span><span class="p">(</span><span class="n">_cts</span><span class="p">.</span><span class="n">Token</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">ExecuteOperationAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// å­æ“ä½œä¹Ÿä¼šæ”¶åˆ°å–æ¶ˆè¯·æ±‚</span>
        <span class="k">await</span> <span class="nf">Step1Async</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
        <span class="k">await</span> <span class="nf">Step2Async</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
        <span class="k">await</span> <span class="nf">Step3Async</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å–æ¶ˆè¢«æ­£ç¡®å¤„ç†</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"æ“ä½œè¢«å–æ¶ˆ"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="taskçš„è°ƒåº¦å’Œé…ç½®">Taskçš„è°ƒåº¦å’Œé…ç½®</h2>

<p>â€ƒâ€ƒTaskScheduleræ˜¯Taskè°ƒåº¦ç³»ç»Ÿçš„æ ¸å¿ƒæŠ½è±¡ç±»ï¼Œè´Ÿè´£æ§åˆ¶Taskçš„æ‰§è¡Œæ–¹å¼å’Œä½ç½®ã€‚</p>

<h3 id="taskschedulerè¯¦è§£">TaskSchedulerè¯¦è§£</h3>

<p>â€ƒâ€ƒTaskSchedulerè°ƒåº¦å™¨ç»´æŠ¤äº†ä¸€ä¸ªç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¹¶å†³å®šä»»åŠ¡æ‰§è¡Œçš„ä¼˜å…ˆçº§å’Œå¤„ç†ä»»åŠ¡çš„ä¾èµ–å…³ç³»ã€‚TaskSchedulerå¯ä»¥å†³å®šä»»åŠ¡åœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œæ§åˆ¶å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡ï¼Œå¤„ç†ä»»åŠ¡çš„å¼‚å¸¸ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. çº¿ç¨‹æ± è°ƒåº¦å™¨ï¼ˆé»˜è®¤ï¼‰</span>
<span class="n">TaskScheduler</span> <span class="n">threadPoolScheduler</span> <span class="p">=</span> <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">Default</span><span class="p">;</span>

<span class="c1">// 2. å½“å‰åŒæ­¥ä¸Šä¸‹æ–‡è°ƒåº¦å™¨</span>
<span class="n">TaskScheduler</span> <span class="n">currentScheduler</span> <span class="p">=</span> <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>

<span class="c1">// 3. ä»åŒæ­¥ä¸Šä¸‹æ–‡ä¸­æ•è·çš„è°ƒåº¦å™¨</span>
<span class="n">TaskScheduler</span> <span class="n">capturedScheduler</span> <span class="p">=</span> <span class="n">TaskScheduler</span><span class="p">.</span><span class="nf">FromCurrentSynchronizationContext</span><span class="p">();</span>

<span class="c1">// é»˜è®¤è°ƒåº¦å™¨ - ä½¿ç”¨çº¿ç¨‹æ± </span>
<span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"æ‰§è¡Œçº¿ç¨‹: </span><span class="p">{</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="m">42</span><span class="p">;</span>
<span class="p">});</span>

<span class="c1">// æ˜¾å¼æŒ‡å®šè°ƒåº¦å™¨</span>
<span class="kt">var</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">DoWork</span><span class="p">();</span>
<span class="p">},</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">TaskCreationOptions</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">Default</span><span class="p">);</span>



<span class="k">private</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">Button_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// åœ¨åå°çº¿ç¨‹æ‰§è¡Œ</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">DoWork</span><span class="p">());</span>
    
    <span class="c1">// è‡ªåŠ¨åˆ‡æ¢å›UIçº¿ç¨‹æ›´æ–°ç•Œé¢</span>
    <span class="n">textBox</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// æ˜¾å¼ä½¿ç”¨è°ƒåº¦å™¨</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateUI</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">TaskScheduler</span> <span class="n">uiScheduler</span> <span class="p">=</span> <span class="n">TaskScheduler</span><span class="p">.</span><span class="nf">FromCurrentSynchronizationContext</span><span class="p">();</span>
    
    <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="nf">LoadData</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
    <span class="p">}).</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="c1">// åœ¨UIçº¿ç¨‹æ‰§è¡Œ</span>
        <span class="nf">UpdateUI</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">);</span>
    <span class="p">},</span> <span class="n">uiScheduler</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="taskcreationoptions">TaskCreationOptions</h3>

<p>â€ƒâ€ƒTaskCreationOptionsæšä¸¾ç”¨äºé…ç½®Taskçš„åˆ›å»ºè¡Œä¸ºã€‚</p>

<table>
  <thead>
    <tr>
      <th>é€‰é¡¹</th>
      <th>è¯´æ˜</th>
      <th>ä½¿ç”¨åœºæ™¯</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>None</td>
      <td>é»˜è®¤è¡Œä¸º</td>
      <td>æ ‡å‡†ä»»åŠ¡åˆ›å»º</td>
    </tr>
    <tr>
      <td>PreferFairness</td>
      <td>å…¬å¹³è°ƒåº¦</td>
      <td>ç¡®ä¿ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œ</td>
    </tr>
    <tr>
      <td>LongRunning</td>
      <td>é•¿è¿è¡Œä»»åŠ¡</td>
      <td>CPUå¯†é›†å‹æˆ–é•¿æ—¶é—´è¿è¡Œä»»åŠ¡</td>
    </tr>
    <tr>
      <td>AttachedToParent</td>
      <td>é™„åŠ åˆ°çˆ¶ä»»åŠ¡</td>
      <td>åˆ›å»ºå­ä»»åŠ¡å±‚æ¬¡ç»“æ„</td>
    </tr>
    <tr>
      <td>DenyChildAttach</td>
      <td>æ‹’ç»å­ä»»åŠ¡é™„åŠ </td>
      <td>ç‹¬ç«‹ä»»åŠ¡æ‰§è¡Œ</td>
    </tr>
    <tr>
      <td>HideScheduler</td>
      <td>éšè—è°ƒåº¦å™¨</td>
      <td>å†…éƒ¨ä½¿ç”¨</td>
    </tr>
    <tr>
      <td>RunContinuationsAsynchronously</td>
      <td>å¼‚æ­¥å»¶ç»­</td>
      <td>é¿å…æ­»é”</td>
    </tr>
  </tbody>
</table>

<p>â€ƒâ€ƒLongRunningé€‰é¡¹ç”¨äºå°†ä»»åŠ¡åˆ†é…ç»™ä¸“ç”¨çº¿ç¨‹ï¼Œé€‚ç”¨äºCPUå¯†é›†å‹æˆ–é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ã€‚</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// é•¿è¿è¡Œä»»åŠ¡ - ä¸ºå…¶åˆ†é…ä¸“ç”¨çº¿ç¨‹</span>
<span class="n">Task</span> <span class="n">longRunningTask</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// CPUå¯†é›†å‹è®¡ç®—</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">1000000</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
        <span class="c1">// å¤æ‚è®¡ç®—</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="n">TaskCreationOptions</span><span class="p">.</span><span class="n">LongRunning</span><span class="p">);</span>
</code></pre></div></div>

<p>â€ƒâ€ƒAttachedToParenté€‰é¡¹ç”¨äºå°†å­ä»»åŠ¡è‡ªåŠ¨é™„åŠ åˆ°çˆ¶ä»»åŠ¡ï¼Œé€‚ç”¨äºåˆ›å»ºå­ä»»åŠ¡å±‚æ¬¡ç»“æ„ã€‚</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Task</span> <span class="n">parentTask</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"çˆ¶ä»»åŠ¡å¼€å§‹"</span><span class="p">);</span>
    
    <span class="c1">// å­ä»»åŠ¡è‡ªåŠ¨é™„åŠ åˆ°çˆ¶ä»»åŠ¡</span>
    <span class="n">Task</span> <span class="n">childTask</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"å­ä»»åŠ¡æ‰§è¡Œ"</span><span class="p">);</span>
        <span class="k">return</span> <span class="m">42</span><span class="p">;</span>
    <span class="p">},</span> <span class="n">TaskCreationOptions</span><span class="p">.</span><span class="n">AttachedToParent</span><span class="p">);</span>
    
    <span class="c1">// çˆ¶ä»»åŠ¡ç­‰å¾…æ‰€æœ‰å­ä»»åŠ¡å®Œæˆ</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"çˆ¶ä»»åŠ¡ç»“æŸ"</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>â€ƒâ€ƒPreferFairnessé€‰é¡¹ç”¨äºç¡®ä¿ä»»åŠ¡æŒ‰æäº¤é¡ºåºæ‰§è¡Œã€‚</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ç¡®ä¿ä»»åŠ¡æŒ‰æäº¤é¡ºåºæ‰§è¡Œ</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
    <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"ä»»åŠ¡ </span><span class="p">{</span><span class="n">i</span><span class="p">}</span><span class="s"> æ‰§è¡Œ"</span><span class="p">);</span>
    <span class="p">},</span> <span class="n">TaskCreationOptions</span><span class="p">.</span><span class="n">PreferFairness</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="taskcontinuationoptions">TaskContinuationOptions</h3>

<p>â€ƒâ€ƒTaskContinuationOptionsæ§åˆ¶å»¶ç»­ä»»åŠ¡çš„æ‰§è¡Œæ¡ä»¶å’Œè¡Œä¸ºã€‚</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Task</span> <span class="n">initialTask</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// å¯èƒ½æˆåŠŸã€å¤±è´¥æˆ–å–æ¶ˆ</span>
    <span class="k">return</span> <span class="nf">ComputeResult</span><span class="p">();</span>
<span class="p">});</span>

<span class="c1">// 1. åªæœ‰æˆåŠŸæ—¶æ‰§è¡Œ</span>
<span class="n">Task</span> <span class="n">successContinuation</span> <span class="p">=</span> <span class="n">initialTask</span><span class="p">.</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"ç»“æœ: </span><span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">},</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnRanToCompletion</span><span class="p">);</span>

<span class="c1">// 2. åªæœ‰å¤±è´¥æ—¶æ‰§è¡Œ</span>
<span class="n">Task</span> <span class="n">failureContinuation</span> <span class="p">=</span> <span class="n">initialTask</span><span class="p">.</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"é”™è¯¯: </span><span class="p">{</span><span class="n">t</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">},</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnFaulted</span><span class="p">);</span>

<span class="c1">// 3. åªæœ‰å–æ¶ˆæ—¶æ‰§è¡Œ</span>
<span class="n">Task</span> <span class="n">cancellationContinuation</span> <span class="p">=</span> <span class="n">initialTask</span><span class="p">.</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"ä»»åŠ¡è¢«å–æ¶ˆ"</span><span class="p">);</span>
<span class="p">},</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnCanceled</span><span class="p">);</span>

<span class="c1">// 4. æ— è®ºä»€ä¹ˆæƒ…å†µéƒ½æ‰§è¡Œï¼ˆç”¨äºæ¸…ç†ï¼‰</span>
<span class="n">Task</span> <span class="n">cleanupContinuation</span> <span class="p">=</span> <span class="n">initialTask</span><span class="p">.</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nf">CleanupResources</span><span class="p">();</span>
<span class="p">},</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>

<span class="c1">// ç»„åˆå¤šä¸ªé€‰é¡¹</span>
<span class="n">TaskContinuationOptions</span> <span class="n">options</span> <span class="p">=</span> 
    <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnRanToCompletion</span> <span class="p">|</span> 
    <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">RunContinuationsAsynchronously</span> <span class="p">|</span> 
    <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">AttachedToParent</span><span class="p">;</span>

<span class="n">Task</span> <span class="n">continuation</span> <span class="p">=</span> <span class="n">initialTask</span><span class="p">.</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">ProcessResult</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">);</span>
<span class="p">},</span> <span class="n">options</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="è‡ªå®šä¹‰taskscheduler">è‡ªå®šä¹‰TaskScheduler</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">UnityTaskScheduler</span> <span class="p">:</span> <span class="n">TaskScheduler</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ConcurrentQueue</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span> <span class="n">_tasks</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">_lock</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">QueueTask</span><span class="p">(</span><span class="n">Task</span> <span class="n">task</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="n">_lock</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_tasks</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">TryExecuteTaskInline</span><span class="p">(</span><span class="n">Task</span> <span class="n">task</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">taskWasPreviouslyQueued</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">TryExecuteTask</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span> <span class="nf">GetScheduledTasks</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_tasks</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// åœ¨Unityä¸»çº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ExecutePendingTasks</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">_tasks</span><span class="p">.</span><span class="nf">TryDequeue</span><span class="p">(</span><span class="k">out</span> <span class="kt">var</span> <span class="n">task</span><span class="p">))</span> <span class="p">{</span>
            <span class="nf">TryExecuteTask</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// åœ¨MonoBehaviourä¸­ä½¿ç”¨</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">TaskManager</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
    <span class="k">private</span> <span class="n">UnityTaskScheduler</span> <span class="n">_scheduler</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>

    <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">_scheduler</span><span class="p">.</span><span class="nf">ExecutePendingTasks</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">RunOnMainThread</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">var</span> <span class="n">tcs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
        
        <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="nf">action</span><span class="p">();</span>
            <span class="n">tcs</span><span class="p">.</span><span class="nf">SetResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
        <span class="p">},</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">TaskCreationOptions</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">_scheduler</span><span class="p">);</span>
        
        <span class="k">return</span> <span class="n">tcs</span><span class="p">.</span><span class="n">Task</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="taskçš„é«˜çº§ç”¨æ³•">Taskçš„é«˜çº§ç”¨æ³•</h2>

<h3 id="taskcompletionsource">TaskCompletionSource</h3>

<p>â€ƒâ€ƒTaskCompletionSourceæ˜¯Taskå¹¶è¡Œåº“ä¸­æœ€å¼ºå¤§çš„å·¥å…·ä¹‹ä¸€ï¼Œå…è®¸åˆ›å»ºâ€å†·â€ä»»åŠ¡ï¼Œç”¨äºæ‰‹åŠ¨æ§åˆ¶Taskçš„ç”Ÿå‘½å‘¨æœŸå’Œå®ŒæˆçŠ¶æ€ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">TaskCompletionSource</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Task</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>  <span class="c1">// è·å–å…³è”çš„Taskå¯¹è±¡</span>
    
    <span class="c1">// å®Œæˆæ§åˆ¶æ–¹æ³•</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">SetResult</span><span class="p">(</span><span class="n">T</span> <span class="n">result</span><span class="p">);</span>           <span class="c1">// è®¾ç½®æˆåŠŸç»“æœ</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">SetException</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">);</span>    <span class="c1">// è®¾ç½®å¼‚å¸¸</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">SetException</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Exception</span><span class="p">&gt;</span> <span class="n">exs</span><span class="p">);</span>  <span class="c1">// è®¾ç½®å¤šä¸ªå¼‚å¸¸</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">SetCanceled</span><span class="p">();</span>                <span class="c1">// è®¾ç½®ä¸ºå·²å–æ¶ˆ</span>
    
    <span class="c1">// å°è¯•ç‰ˆæœ¬ï¼ˆå¦‚æœä»»åŠ¡å·²å®Œæˆåˆ™è¿”å›falseï¼‰</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">TrySetResult</span><span class="p">(</span><span class="n">T</span> <span class="n">result</span><span class="p">);</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">TrySetException</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">);</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">TrySetCanceled</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒåŒ…è£…å¼‚æ­¥å›è°ƒæ“ä½œ</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">tcs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
    
    <span class="k">using</span> <span class="nn">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WebClient</span><span class="p">();</span>
    <span class="n">client</span><span class="p">.</span><span class="n">DownloadStringCompleted</span> <span class="p">+=</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Error</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">tcs</span><span class="p">.</span><span class="nf">SetException</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Error</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Cancelled</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">tcs</span><span class="p">.</span><span class="nf">SetCanceled</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">tcs</span><span class="p">.</span><span class="nf">SetResult</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Result</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
    
    <span class="n">client</span><span class="p">.</span><span class="nf">DownloadAssestAsync</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">url</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">tcs</span><span class="p">.</span><span class="n">Task</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="taskåœ¨unity3dä¸­çš„åº”ç”¨">Taskåœ¨Unity3Dä¸­çš„åº”ç”¨</h2>

<h3 id="unityä¸»çº¿ç¨‹é™åˆ¶">Unityä¸»çº¿ç¨‹é™åˆ¶</h3>

<p>â€ƒâ€ƒUnity3Dæœ‰ä¸¥æ ¼çš„ä¸»çº¿ç¨‹é™åˆ¶ï¼Œè¿™æ˜¯ä½¿ç”¨Taskæ—¶å¿…é¡»äº†è§£çš„æ ¸å¿ƒæ¦‚å¿µï¼š</p>

<p>â€ƒâ€ƒ<strong>Unity APIçš„çº¿ç¨‹å®‰å…¨æ€§é™åˆ¶</strong></p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// âŒ é”™è¯¯ï¼šåœ¨åå°çº¿ç¨‹è°ƒç”¨Unity APIä¼šæŠ›å‡ºå¼‚å¸¸</span>
<span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// è¿™ä¼šå¯¼è‡´å¼‚å¸¸ï¼š"UnityEngine.Transform can only be called from the main thread"</span>
    <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>
    <span class="n">GameObject</span><span class="p">.</span><span class="nf">Instantiate</span><span class="p">(</span><span class="n">prefab</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// âœ… æ­£ç¡®ï¼šåœ¨ä¸»çº¿ç¨‹æ‰§è¡ŒUnity APIè°ƒç”¨</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">UnityTaskManager</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ConcurrentQueue</span><span class="p">&lt;</span><span class="n">System</span><span class="p">.</span><span class="n">Action</span><span class="p">&gt;</span> <span class="n">_mainThreadActions</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
    
    <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„æ“ä½œ</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">_mainThreadActions</span><span class="p">.</span><span class="nf">TryDequeue</span><span class="p">(</span><span class="k">out</span> <span class="kt">var</span> <span class="n">action</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">action</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">RunOnMainThread</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">var</span> <span class="n">tcs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
        
        <span class="n">_mainThreadActions</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="nf">action</span><span class="p">();</span>
                <span class="n">tcs</span><span class="p">.</span><span class="nf">SetResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">tcs</span><span class="p">.</span><span class="nf">SetException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
        
        <span class="k">return</span> <span class="n">tcs</span><span class="p">.</span><span class="n">Task</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="å¼‚æ­¥æ“ä½œçš„æœ€ä½³å®è·µ">å¼‚æ­¥æ“ä½œçš„æœ€ä½³å®è·µ</h3>

<p>â€ƒâ€ƒ<strong>ç½‘ç»œè¯·æ±‚çš„å¼‚æ­¥å¤„ç†</strong></p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">NetworkManager</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">HttpClient</span> <span class="n">_httpClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
    
    <span class="c1">// å¼‚æ­¥ä¸‹è½½å¹¶æ›´æ–°UI</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Sprite</span><span class="p">&gt;</span> <span class="nf">LoadSpriteAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">,</span> <span class="n">Image</span> <span class="n">targetImage</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// åå°çº¿ç¨‹ä¸‹è½½</span>
            <span class="kt">var</span> <span class="n">imageData</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_httpClient</span><span class="p">.</span><span class="nf">GetByteArrayAsync</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
            
            <span class="c1">// ä¸»çº¿ç¨‹åˆ›å»ºSpriteå¹¶æ›´æ–°UI</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">UnityTaskScheduler</span><span class="p">.</span><span class="nf">RunOnMainThread</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="kt">var</span> <span class="n">texture</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Texture2D</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">2</span><span class="p">);</span>
                <span class="n">texture</span><span class="p">.</span><span class="nf">LoadImage</span><span class="p">(</span><span class="n">imageData</span><span class="p">);</span>
                
                <span class="kt">var</span> <span class="n">sprite</span> <span class="p">=</span> <span class="n">Sprite</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">texture</span><span class="p">,</span> 
                    <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">texture</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">texture</span><span class="p">.</span><span class="n">height</span><span class="p">),</span> 
                    <span class="n">Vector2</span><span class="p">.</span><span class="n">one</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">);</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">targetImage</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">targetImage</span><span class="p">.</span><span class="n">sprite</span> <span class="p">=</span> <span class="n">sprite</span><span class="p">;</span>
                <span class="p">}</span>
                
                <span class="k">return</span> <span class="n">sprite</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">$"åŠ è½½å›¾ç‰‡å¤±è´¥: </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒ<strong>æ–‡ä»¶I/Oçš„å¼‚æ­¥å¤„ç†</strong></p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">SaveSystem</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">SaveGameDataAsync</span><span class="p">(</span><span class="n">GameData</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// åå°çº¿ç¨‹åºåˆ—åŒ–å’Œå†™å…¥æ–‡ä»¶</span>
            <span class="kt">var</span> <span class="n">json</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">JsonUtility</span><span class="p">.</span><span class="nf">ToJson</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">true</span><span class="p">));</span>
            <span class="kt">var</span> <span class="n">path</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span><span class="n">Application</span><span class="p">.</span><span class="n">persistentDataPath</span><span class="p">,</span> <span class="s">"save.json"</span><span class="p">);</span>
            
            <span class="k">await</span> <span class="n">File</span><span class="p">.</span><span class="nf">WriteAllTextAsync</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">json</span><span class="p">);</span>
            
            <span class="c1">// ä¸»çº¿ç¨‹æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º</span>
            <span class="k">await</span> <span class="n">UnityTaskScheduler</span><span class="p">.</span><span class="nf">RunOnMainThread</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="nf">ShowSaveSuccessMessage</span><span class="p">();</span>
            <span class="p">});</span>
            
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">$"ä¿å­˜å¤±è´¥: </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">GameData</span><span class="p">&gt;</span> <span class="nf">LoadGameDataAsync</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kt">var</span> <span class="n">path</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span><span class="n">Application</span><span class="p">.</span><span class="n">persistentDataPath</span><span class="p">,</span> <span class="s">"save.json"</span><span class="p">);</span>
            
            <span class="k">if</span> <span class="p">(!</span><span class="n">File</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nf">GameData</span><span class="p">();</span> <span class="c1">// è¿”å›é»˜è®¤æ•°æ®</span>
            <span class="p">}</span>
            
            <span class="c1">// åå°çº¿ç¨‹è¯»å–å’Œååºåˆ—åŒ–</span>
            <span class="kt">var</span> <span class="n">json</span> <span class="p">=</span> <span class="k">await</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllTextAsync</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">JsonUtility</span><span class="p">.</span><span class="n">FromJson</span><span class="p">&lt;</span><span class="n">GameData</span><span class="p">&gt;(</span><span class="n">json</span><span class="p">));</span>
            
            <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">$"åŠ è½½å¤±è´¥: </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">GameData</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒ<strong>æ‰¹é‡æ“ä½œçš„è¿›åº¦æŠ¥å‘Š</strong></p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">AssetLoader</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">LoadAssetsWithProgressAsync</span><span class="p">(</span>
        <span class="kt">string</span><span class="p">[]</span> <span class="n">assetPaths</span><span class="p">,</span> 
        <span class="n">IProgress</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">&gt;</span> <span class="n">progress</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="kt">var</span> <span class="n">loadedCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">totalCount</span> <span class="p">=</span> <span class="n">assetPaths</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
        
        <span class="kt">var</span> <span class="n">tasks</span> <span class="p">=</span> <span class="n">assetPaths</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="k">async</span> <span class="n">path</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="c1">// åå°åŠ è½½èµ„æºæ•°æ®</span>
                <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">LoadAssetDataAsync</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
                
                <span class="c1">// ä¸»çº¿ç¨‹åˆ›å»ºUnityå¯¹è±¡</span>
                <span class="k">await</span> <span class="n">UnityTaskScheduler</span><span class="p">.</span><span class="nf">RunOnMainThread</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="nf">CreateUnityAsset</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
                <span class="p">});</span>
                
                <span class="c1">// æ›´æ–°è¿›åº¦</span>
                <span class="n">Interlocked</span><span class="p">.</span><span class="nf">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">loadedCount</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">currentProgress</span> <span class="p">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">loadedCount</span> <span class="p">/</span> <span class="n">totalCount</span><span class="p">;</span>
                
                <span class="c1">// ä¸»çº¿ç¨‹æ›´æ–°UIè¿›åº¦</span>
                <span class="k">await</span> <span class="n">UnityTaskScheduler</span><span class="p">.</span><span class="nf">RunOnMainThread</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="n">progress</span><span class="p">?.</span><span class="nf">Report</span><span class="p">(</span><span class="n">currentProgress</span><span class="p">);</span>
                <span class="p">});</span>
                
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$"åŠ è½½ </span><span class="p">{</span><span class="n">path</span><span class="p">}</span><span class="s"> è¢«å–æ¶ˆ"</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Debug</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">$"åŠ è½½ </span><span class="p">{</span><span class="n">path</span><span class="p">}</span><span class="s"> å¤±è´¥: </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
        
        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAll</span><span class="p">(</span><span class="n">tasks</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="åç¨‹-vs-task">åç¨‹ vs Task</h3>

<p>â€ƒâ€ƒ<strong>åŠŸèƒ½å¯¹æ¯”åˆ†æ</strong></p>

<table>
  <thead>
    <tr>
      <th>ç‰¹æ€§</th>
      <th>åç¨‹(Coroutine)</th>
      <th>Task</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>æ‰§è¡Œçº¿ç¨‹</strong></td>
      <td>ä»…ä¸»çº¿ç¨‹</td>
      <td>å¯å¤šçº¿ç¨‹</td>
    </tr>
    <tr>
      <td><strong>Unityé›†æˆ</strong></td>
      <td>åŸç”Ÿæ”¯æŒ</td>
      <td>éœ€è¦é€‚é…å™¨</td>
    </tr>
    <tr>
      <td><strong>å–æ¶ˆæœºåˆ¶</strong></td>
      <td>æ‰‹åŠ¨å®ç°</td>
      <td>å†…ç½®CancellationToken</td>
    </tr>
    <tr>
      <td><strong>å¼‚å¸¸å¤„ç†</strong></td>
      <td>å¤æ‚</td>
      <td>æ ‡å‡†try-catch</td>
    </tr>
    <tr>
      <td><strong>ç»„åˆæ€§</strong></td>
      <td>æœ‰é™</td>
      <td>å¼ºå¤§(WhenAll/WhenAny)</td>
    </tr>
    <tr>
      <td><strong>æ€§èƒ½å¼€é”€</strong></td>
      <td>ä½</td>
      <td>ä¸­ç­‰</td>
    </tr>
    <tr>
      <td><strong>è°ƒè¯•æ”¯æŒ</strong></td>
      <td>ä¸€èˆ¬</td>
      <td>ä¼˜ç§€</td>
    </tr>
  </tbody>
</table>

<p>â€ƒâ€ƒ<strong>åç¨‹çš„ä¼˜åŠ¿åœºæ™¯</strong></p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">CoroutineExamples</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
    <span class="c1">// ç®€å•çš„æ—¶é—´å»¶è¿Ÿå’Œå¸§ç­‰å¾…</span>
    <span class="n">IEnumerator</span> <span class="nf">SimpleAnimation</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">100</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
            <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">+=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">up</span> <span class="p">*</span> <span class="m">0.1f</span><span class="p">;</span>
            <span class="k">yield</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span> <span class="c1">// ç­‰å¾…ä¸€å¸§</span>
        <span class="p">}</span>
        
        <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="nf">WaitForSeconds</span><span class="p">(</span><span class="m">1f</span><span class="p">);</span> <span class="c1">// ç­‰å¾…1ç§’</span>
        
        <span class="c1">// ç­‰å¾…ç‰¹å®šæ¡ä»¶</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="nf">WaitUntil</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetKeyDown</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">Space</span><span class="p">));</span>
    <span class="p">}</span>
    
    <span class="c1">// Unityç‰¹å®šçš„ç­‰å¾…æ¡ä»¶</span>
    <span class="n">IEnumerator</span> <span class="nf">WaitForAnimation</span><span class="p">()</span> <span class="p">{</span>
        <span class="kt">var</span> <span class="n">animator</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Animator</span><span class="p">&gt;();</span>
        <span class="n">animator</span><span class="p">.</span><span class="nf">SetTrigger</span><span class="p">(</span><span class="s">"Play"</span><span class="p">);</span>
        
        <span class="c1">// ç­‰å¾…åŠ¨ç”»å®Œæˆ</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="nf">WaitForAnimatorState</span><span class="p">(</span><span class="n">animator</span><span class="p">,</span> <span class="s">"IdleState"</span><span class="p">);</span>
        
        <span class="c1">// ç­‰å¾…ç‰©ç†æ›´æ–°</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="nf">WaitForFixedUpdate</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒ<strong>Taskçš„ä¼˜åŠ¿åœºæ™¯</strong></p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">TaskExamples</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
    <span class="c1">// å¤æ‚çš„å¼‚æ­¥æ“ä½œç»„åˆ</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">ComplexAsyncOperation</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// å¹¶è¡Œæ‰§è¡Œå¤šä¸ªç½‘ç»œè¯·æ±‚</span>
            <span class="kt">var</span> <span class="n">task1</span> <span class="p">=</span> <span class="nf">DownloadUserDataAsync</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">task2</span> <span class="p">=</span> <span class="nf">DownloadConfigAsync</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">task3</span> <span class="p">=</span> <span class="nf">DownloadAssetsAsync</span><span class="p">();</span>
            
            <span class="c1">// ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ</span>
            <span class="kt">var</span> <span class="n">results</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAll</span><span class="p">(</span><span class="n">task1</span><span class="p">,</span> <span class="n">task2</span><span class="p">,</span> <span class="n">task3</span><span class="p">);</span>
            
            <span class="c1">// å¤„ç†ç»“æœ</span>
            <span class="nf">ProcessResults</span><span class="p">(</span><span class="n">results</span><span class="p">);</span>
            
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">HttpRequestException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">HandleNetworkError</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">HandleCancellation</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// å¸¦è¶…æ—¶çš„æ“ä½œ</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">TryConnectWithTimeoutAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">server</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">using</span> <span class="nn">var</span> <span class="n">cts</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">5</span><span class="p">));</span>
        
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">await</span> <span class="nf">ConnectToServerAsync</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">cts</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span><span class="p">)</span> <span class="nf">when</span> <span class="p">(</span><span class="n">cts</span><span class="p">.</span><span class="n">IsCancellationRequested</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"è¿æ¥è¶…æ—¶"</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒ<strong>æ··åˆä½¿ç”¨æ¨¡å¼</strong></p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">HybridAsyncManager</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
    <span class="c1">// å°†Taskè½¬æ¢ä¸ºåç¨‹</span>
    <span class="k">public</span> <span class="n">Coroutine</span> <span class="n">StartTaskAsCoroutine</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">task</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">onComplete</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">StartCoroutine</span><span class="p">(</span><span class="nf">TaskToCoroutine</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">onComplete</span><span class="p">));</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="n">IEnumerator</span> <span class="n">TaskToCoroutine</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">task</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">onComplete</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ç­‰å¾…Taskå®Œæˆ</span>
        <span class="k">while</span> <span class="p">(!</span><span class="n">task</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">yield</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">IsFaulted</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">$"Taskå¤±è´¥: </span><span class="p">{</span><span class="n">task</span><span class="p">.</span><span class="n">Exception</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">IsCanceled</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Taskè¢«å–æ¶ˆ"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">onComplete</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">Result</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// å°†åç¨‹è½¬æ¢ä¸ºTask</span>
    <span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">CoroutineToTask</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">IEnumerator</span> <span class="n">coroutine</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">getResult</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">var</span> <span class="n">tcs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
        
        <span class="nf">StartCoroutine</span><span class="p">(</span><span class="nf">CoroutineWrapper</span><span class="p">());</span>
        
        <span class="n">IEnumerator</span> <span class="nf">CoroutineWrapper</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">yield</span> <span class="k">return</span> <span class="nf">StartCoroutine</span><span class="p">(</span><span class="n">coroutine</span><span class="p">);</span>
            
            <span class="k">try</span> <span class="p">{</span>
                <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="nf">getResult</span><span class="p">();</span>
                <span class="n">tcs</span><span class="p">.</span><span class="nf">SetResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">tcs</span><span class="p">.</span><span class="nf">SetException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">tcs</span><span class="p">.</span><span class="n">Task</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="æ€§èƒ½è€ƒè™‘">æ€§èƒ½è€ƒè™‘</h3>

<p>â€ƒâ€ƒ<strong>Taskåˆ†é…ä¼˜åŒ–</strong></p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">PerformanceOptimizedTaskManager</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
    <span class="c1">// ç¼“å­˜å¸¸ç”¨çš„å·²å®ŒæˆTask</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">_trueTask</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">_falseTask</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">Task</span> <span class="n">_completedTask</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
    
    <span class="c1">// é¿å…ä¸å¿…è¦çš„Taskåˆ†é…</span>
    <span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">ValidateAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// åŒæ­¥éªŒè¯ï¼Œç›´æ¥è¿”å›ç¼“å­˜çš„Task</span>
        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">input</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">_falseTask</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">Length</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">_falseTask</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="c1">// åªæœ‰éœ€è¦å¼‚æ­¥æ“ä½œæ—¶æ‰åˆ›å»ºæ–°Task</span>
        <span class="k">return</span> <span class="nf">ValidateAsyncInternal</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">ValidateAsyncInternal</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å®é™…çš„å¼‚æ­¥éªŒè¯é€»è¾‘</span>
        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">input</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"valid"</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// ä½¿ç”¨ValueTaskå‡å°‘åˆ†é…</span>
    <span class="k">public</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">GetCachedValueAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_cache</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">cachedValue</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// åŒæ­¥è·¯å¾„ï¼Œä¸åˆ†é…Taskå¯¹è±¡</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="n">cachedValue</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="c1">// å¼‚æ­¥è·¯å¾„ï¼Œéœ€è¦åˆ†é…Task</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="nf">LoadValueAsync</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>]]></content><author><name>ç¼–ç¨‹æ•£è®°</name></author><category term="CSharp" /><category term="Task" /><summary type="html"><![CDATA[ä»»åŠ¡æ˜¯å¯¹è±¡ï¼Œå…¶ä¸­å°è£…äº†ä»¥å¼‚æ­¥æ–¹å¼æ‰§è¡Œçš„å·¥ä½œã€‚è¿™å¬èµ·æ¥æœ‰ç‚¹å„¿è€³ç†Ÿï¼Œå§”æ‰˜ä¸ä¹Ÿæ˜¯å°è£…äº†ä»£ç çš„å¯¹è±¡å—ï¼ŸåŒºåˆ«åœ¨äºå§”æ‰˜æ˜¯åŒæ­¥çš„è€Œä»»åŠ¡æ˜¯å¼‚æ­¥çš„ã€‚å¦‚æœæ‰§è¡Œä¸€ä¸ªå§”æ‰˜(ä¾‹å¦‚ä¸€ä¸ªAction)ï¼Œå½“å‰çº¿ç¨‹çš„æ§åˆ¶ç‚¹ä¼šç«‹å³è½¬ç§»åˆ°å§”æ‰˜çš„ä»£ç ã€‚]]></summary></entry><entry><title type="html">å¤šçº¿ç¨‹ç¼–ç¨‹åŸºç¡€ç¯‡-Thread(ä¸€)</title><link href="https://www.damonc.top/csharp/CSharp_Thread_Base.html" rel="alternate" type="text/html" title="å¤šçº¿ç¨‹ç¼–ç¨‹åŸºç¡€ç¯‡-Thread(ä¸€)" /><published>2025-06-03T20:00:00+00:00</published><updated>2025-06-03T20:00:00+00:00</updated><id>https://www.damonc.top/csharp/CSharp_Thread_Base</id><content type="html" xml:base="https://www.damonc.top/csharp/CSharp_Thread_Base.html"><![CDATA[<h2 id="å¤šçº¿ç¨‹æ¦‚å¿µ">å¤šçº¿ç¨‹æ¦‚å¿µ</h2>

<p>â€ƒâ€ƒç°ä»£åº”ç”¨ç¨‹åºå¯èƒ½è¦åŒæ—¶å¤„ç†æ•°æ®è®¡ç®—ã€ç”»é¢æ¸²æŸ“ã€æ–‡ä»¶è¯»å†™ç­‰æ“ä½œï¼ŒåŒæ—¶è¦æ±‚æ“ä½œç³»ç»Ÿè¦æ»¡è¶³è¿è¡Œå¤šä¸ªåº”ç”¨ç¨‹åºï¼Œåæ¥éšç€ç°ä»£CPUçš„ä»å•æ ¸è¿›åŒ–åˆ°å¤šæ ¸ï¼Œä»ç‰©ç†æ ¸å¿ƒè¿›åŒ–åˆ°é€»è¾‘æ ¸å¿ƒã€‚å°±é€æ¸æœ‰äº†å¤šä»»åŠ¡æ‰§è¡Œæ¦‚å¿µã€‚</p>

<h3 id="ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹">ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹ï¼Ÿ</h3>

<p>â€ƒâ€ƒå¤šçº¿ç¨‹æ˜¯ä¸€ç§è½¯ä»¶ç¼–ç¨‹æ¦‚å¿µï¼ŒIntelæå‡ºäº†<a href="https://www.intel.cn/content/www/cn/zh/gaming/resources/hyper-threading.html">è¶…çº¿ç¨‹æŠ€æœ¯ï¼ˆHyper-Threadingï¼‰</a>æ˜¯å®ç°å¤šçº¿ç¨‹çš„ç¡¬ä»¶æŠ€æœ¯ï¼Œå°†å•ä¸ªç‰©ç†æ ¸å¿ƒè™šæ‹Ÿä¸ºå¤šä¸ªé€»è¾‘æ ¸å¿ƒï¼Œæ˜¯å¯¹å¤šçº¿ç¨‹çš„ç¡¬ä»¶æ”¯æŒã€‚é€»è¾‘æ ¸å¿ƒå…±äº«åŒä¸€ç‰©ç†æ ¸å¿ƒçš„ç¡¬ä»¶èµ„æºï¼ˆå¦‚ALUã€ç¼“å­˜ï¼‰ï¼Œä½†æ‹¥æœ‰ç‹¬ç«‹çš„å¯„å­˜å™¨ç»„å’Œçº¿ç¨‹çŠ¶æ€â€Œï¼Œå½“æŸä¸ªçº¿ç¨‹å› ç­‰å¾…æ•°æ®ï¼ˆå¦‚å†…å­˜è®¿é—®ï¼‰æš‚åœæ—¶ï¼Œç‰©ç†æ ¸å¿ƒç«‹å³åˆ‡æ¢è‡³å¦ä¸€çº¿ç¨‹æ‰§è¡Œï¼Œå¤ç”¨é—²ç½®èµ„æºä»¥æå‡åˆ©ç”¨ç‡â€Œã€‚<strong>çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿè°ƒåº¦çš„æœ€å°æ‰§è¡Œå•å…ƒï¼Œæ˜¯è¿›ç¨‹ä¸­çš„ä¸€æ¡æ‰§è¡Œè·¯å¾„ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ä»£ç æ‰§è¡Œè·¯å¾„å’Œç‹¬ç«‹çš„å †æ ˆç©ºé—´ï¼Œçº¿ç¨‹ä¹‹é—´å¯ä»¥å…±äº«ç¨‹åºçš„æ•°æ®æ®µå’Œä»£ç æ®µ</strong>ã€‚ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¯åŠ¨å¤šä¸ªçº¿ç¨‹ï¼Œå®ç°â€Œå¹¶å‘â€Œï¼ˆConcurrencyï¼‰æˆ–â€Œå¹¶è¡Œâ€Œï¼ˆParallelismï¼‰ã€‚</p>

<h3 id="çº¿ç¨‹çš„ç›®æ ‡æ˜¯ä»€ä¹ˆ">çº¿ç¨‹çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ</h3>

<p>â€ƒâ€ƒä¸ºäº†é˜²æ­¢ä¸€ä¸ªåº”ç”¨ç¨‹åºæ§åˆ¶CPUè€Œå¯¼è‡´å…¶ä»–åº”ç”¨ç¨‹åºå’Œæ“ä½œç³»ç»Ÿæœ¬èº«æ°¸è¿œè¢«æŒ‚èµ·è¿™ä¸€å¯èƒ½æƒ…å†µï¼Œæ“ä½œç³»ç»Ÿä¸å¾—ä¸ä½¿ç”¨æŸç§æ–¹å¼å°†ç‰©ç†è®¡ç®—å•å…ƒåˆ†å‰²ä¸ºä¸€äº›è™šæ‹Ÿçš„è¿›ç¨‹ï¼Œå¹¶ç»™äºˆæ¯ä¸ªæ‰§è¡Œç¨‹åºä¸€å®šé‡çš„è®¡ç®—èƒ½åŠ›ã€‚æ­¤å¤–ï¼Œæ“ä½œç³»ç»Ÿå¿…é¡»å§‹ç»ˆèƒ½å¤Ÿä¼˜å…ˆè®¿é—®CPUï¼Œå¹¶èƒ½è°ƒæ•´ä¸åŒç¨‹åºè®¿é—®CPUçš„ä¼˜å…ˆçº§ã€‚çº¿ç¨‹æ­£æ˜¯è¿™ä¸€æ¦‚å¿µçš„å®ç°ã€‚å¯ä»¥è®¤ä¸ºçº¿ç¨‹æ˜¯ä¸€ä¸ªè™šæ‹Ÿè¿›ç¨‹ï¼Œç”¨äºç‹¬ç«‹è¿è¡Œä¸€ä¸ªç‰¹å®šçš„ç¨‹åºã€‚<strong>æé«˜ç¨‹åºçš„å“åº”é€Ÿåº¦ï¼Œå®ç°å¹¶è¡Œè®¡ç®—ï¼Œä»¥åŠæé«˜CPUåˆ©ç”¨ç‡ã€‚å®ƒå¯ä»¥è®©ä¸€ä¸ªç¨‹åºåŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œä»è€Œæ›´æœ‰æ•ˆåœ°åˆ©ç”¨ç³»ç»Ÿèµ„æºï¼ŒåŠ å¿«ç¨‹åºè¿è¡Œé€Ÿåº¦ï¼Œå¹¶æå‡ç”¨æˆ·ä½“éªŒã€‚</strong></p>

<h3 id="ç¨‹åºè¿›ç¨‹çº¿ç¨‹åç¨‹">ç¨‹åºã€è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹</h3>

<p>è¿›ç¨‹å’Œçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿé¢†åŸŸçš„ä¸¤ä¸ªé‡è¦æ¦‚å¿µï¼Œä¸¤è€…æ—¢æœ‰åŒºåˆ«åˆæœ‰è”ç³»ã€‚</p>

<h4 id="å¯æ‰§è¡Œç¨‹åº">å¯æ‰§è¡Œç¨‹åº</h4>

<p>â€ƒâ€ƒC/C++æºæ–‡ä»¶ç»è¿‡ç¼–è¯‘å™¨ï¼ˆç¼–è¯‘+é“¾æ¥ï¼‰å¤„ç†åï¼Œä¼šäº§ç”Ÿå¯æ‰§è¡Œç¨‹åºæ–‡ä»¶ï¼Œä¸åŒç³»ç»Ÿæœ‰ä¸åŒæ ¼å¼ï¼Œæ¯”å¦‚Linuxç³»ç»Ÿçš„ELFæ ¼å¼ã€Windowsç³»ç»Ÿçš„EXEæ ¼å¼ï¼Œå¯æ‰§è¡Œç¨‹åºæ–‡ä»¶æ˜¯ä¸€ä¸ªé™æ€çš„æ¦‚å¿µã€‚</p>

<h4 id="è¿›ç¨‹æ˜¯ä»€ä¹ˆ">è¿›ç¨‹æ˜¯ä»€ä¹ˆ</h4>

<p>â€ƒâ€ƒå¯æ‰§è¡Œç¨‹åºåœ¨æ“ä½œç³»ç»Ÿä¸Šçš„ä¸€æ¬¡æ‰§è¡Œå¯¹åº”ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹æ˜¯ä¸€ä¸ªåŠ¨æ€çš„æ¦‚å¿µï¼š<strong>è¿›ç¨‹æ˜¯æ‰§è¡Œä¸­çš„ç¨‹åº</strong>ã€‚åŒä¸€ä»½å¯æ‰§è¡Œæ–‡ä»¶æ‰§è¡Œå¤šæ¬¡ï¼Œä¼šäº§ç”Ÿå¤šä¸ªè¿›ç¨‹ï¼Œè¿™è·Ÿä¸€ä¸ªç±»å¯ä»¥åˆ›å»ºå¤šä¸ªå®ä¾‹ä¸€æ ·ã€‚è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ã€‚</p>

<h4 id="çº¿ç¨‹æ˜¯ä»€ä¹ˆ">çº¿ç¨‹æ˜¯ä»€ä¹ˆ</h4>

<p>â€ƒâ€ƒä¸€ä¸ªè¿›ç¨‹å†…çš„å¤šä¸ªçº¿ç¨‹ä»£è¡¨ç€å¤šä¸ªæ‰§è¡Œæµï¼Œè¿™äº›çº¿ç¨‹ä»¥å¹¶å‘æ¨¡å¼ç‹¬ç«‹æ‰§è¡Œã€‚æ“ä½œç³»ç»Ÿä¸­ï¼Œè¢«è°ƒåº¦æ‰§è¡Œçš„æœ€å°å•ä½æ˜¯çº¿ç¨‹è€Œéè¿›ç¨‹ã€‚è¿›ç¨‹æ˜¯é€šè¿‡å…±äº«å­˜å‚¨ç©ºé—´å¯¹ç”¨æˆ·å‘ˆç°çš„é€»è¾‘æ¦‚å¿µï¼ŒåŒä¸€è¿›ç¨‹å†…çš„å¤šä¸ªçº¿ç¨‹å…±äº«åœ°å€ç©ºé—´å’Œæ–‡ä»¶æè¿°ç¬¦ï¼Œå…±äº«åœ°å€ç©ºé—´æ„å‘³ç€è¿›ç¨‹çš„ä»£ç ï¼ˆå‡½æ•°ï¼‰åŒºåŸŸã€å…¨å±€å˜é‡ã€å †ã€æ ˆéƒ½è¢«è¿›ç¨‹å†…çš„å¤šä¸ªçº¿ç¨‹å…±äº«ã€‚</p>

<h4 id="è¿›ç¨‹å’Œçº¿ç¨‹çš„å…³ç³»">è¿›ç¨‹å’Œçº¿ç¨‹çš„å…³ç³»</h4>

<p>â€ƒâ€ƒå¯åŠ¨ä¸€ä¸ªç¨‹åºï¼Œç³»ç»Ÿä¼šåœ¨å†…å­˜è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œè¿›ç¨‹æ˜¯æ„æˆç¨‹åºè¿è¡Œçš„èµ„æºé›†åˆï¼ŒåŒ…æ‹¬è™šæ‹Ÿåœ°å€ç©ºé—´ã€æ–‡ä»¶å¥æŸ„ç­‰ã€‚åœ¨è¿›ç¨‹å†…éƒ¨ç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡å¼€å§‹æ‰§è¡ŒMainæ–¹æ³•ï¼Œè¯¥çº¿ç¨‹ä¹Ÿè¢«ç§°ä¸ºä¸»çº¿ç¨‹ã€‚å› æ­¤è¿›ç¨‹ä¹Ÿæ˜¯çº¿ç¨‹çš„ä¸€ä¸ªé›†åˆã€‚</p>

<ol>
  <li>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¿›ç¨‹åªåŒ…å«ä¸€ä¸ªçº¿ç¨‹ï¼Œä»ç¨‹åºçš„å¼€å§‹ä¸€ç›´æ‰§è¡Œåˆ°ç»“æŸã€‚</li>
  <li>ä¸»çº¿ç¨‹ä¹Ÿå¯ä»¥ç»§ç»­æ´¾ç”Ÿçº¿ç¨‹ï¼Œè¿›ç¨‹å†…å¯èƒ½å«æœ‰ä¸åŒçŠ¶æ€çš„çº¿ç¨‹</li>
  <li>å¦‚æœä¸€ä¸ªè¿›ç¨‹æ‹¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå®ƒä»¬å°†å…±äº«è¿›ç¨‹èµ„æº</li>
  <li><strong>çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿè°ƒåº¦çš„æœ€å°æ‰§è¡Œå•å…ƒï¼Œæ˜¯è¿›ç¨‹ä¸­çš„ä¸€æ¡æ‰§è¡Œè·¯å¾„</strong></li>
</ol>

<h4 id="åç¨‹">åç¨‹</h4>

<p>â€ƒâ€ƒç”¨æˆ·æ€çš„å¤šæ‰§è¡Œæµï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬æ¯”çº¿ç¨‹æ›´ä½ï¼Œå¾®ä¿¡ç”¨åç¨‹æ”¹é€ åå°ç³»ç»Ÿåï¼Œè·å¾—äº†æ›´å¤§ååèƒ½åŠ›å’Œæ›´é«˜ç¨³å®šæ€§ã€‚å¦‚ä»Šï¼Œåç¨‹åº“ä¹Ÿè¿›äº†C++20æ–°æ ‡å‡†ã€‚Unityçš„åç¨‹å¹¶éå¤šçº¿ç¨‹ï¼Œè€Œæ˜¯å®Œå…¨è¿è¡Œåœ¨Unityä¸»çº¿ç¨‹ä¸Šï¼Œé€šè¿‡è¿­ä»£å™¨ï¼ˆIEnumeratorï¼‰å’ŒyieldæŒ‡ä»¤å®ç°é€»è¾‘åˆ†å¸§æ‰§è¡Œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹çš„UIå“åº”â€Œã€‚</p>

<h2 id="çº¿ç¨‹ç®€ä»‹">çº¿ç¨‹ç®€ä»‹</h2>

<p>â€ƒâ€ƒç°åœ¨çš„C#ä»£ç ç›´æ¥ä½¿ç”¨New Thread()åˆ›å»ºçº¿ç¨‹ï¼Œè¿™æ˜¯æ¯”è¾ƒè€æ—§çš„ç”¨æ³•ï¼ŒC#æ›´æ¨èä½¿ç”¨Taskã€async/awitæ–¹å¼ã€‚ä½†æ˜¯è¦äº†è§£çº¿ç¨‹çŸ¥è¯†å°±è¦ä»c#çš„Threadçº¿ç¨‹è¯´èµ·ã€‚</p>

<h3 id="åˆ›å»ºçº¿ç¨‹">åˆ›å»ºçº¿ç¨‹</h3>

<p>â€ƒâ€ƒè¦åˆ›å»ºå¹¶å¯åŠ¨ ä¸€ä¸ªçº¿ç¨‹ï¼Œéœ€è¦é¦–å…ˆå®ä¾‹åŒ–Threadå¯¹è±¡å¹¶è°ƒç”¨Startæ–¹æ³•ã€‚Threadçš„æœ€ç®€å•çš„æ„é€ å™¨æ¥æ”¶ä¸€ä¸ªThreadStartæ— å‚å§”æ‰˜æˆ–ParameterizedThreadStartæœ‰å‚å§”æ‰˜ã€‚</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="nf">Thread</span><span class="p">(</span><span class="n">ThreadStart</span> <span class="n">start</span><span class="p">);</span>
<span class="k">public</span> <span class="nf">Thread</span><span class="p">(</span><span class="n">ParameterizedThreadStart</span> <span class="n">start</span><span class="p">);</span>
<span class="k">public</span> <span class="nf">Thread</span><span class="p">(</span><span class="n">ThreadStart</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxStackSize</span><span class="p">);</span>
<span class="k">public</span> <span class="nf">Thread</span><span class="p">(</span><span class="n">ParameterizedThreadStart</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxStackSize</span><span class="p">);</span>

<span class="c1">//c#1.0</span>
<span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">ThreadStart</span><span class="p">();</span>
<span class="c1">//c#2.0</span>
<span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">ParameterizedThreadStart</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">);</span>
</code></pre></div></div>

<p>:ä¸€ä¸ªæ— å‚æ•°çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ‰§è¡Œçš„èµ·å§‹ä½ç½®ï¼Œä¾‹å¦‚</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">void</span> <span class="nf">Test2</span><span class="p">(){</span>
    <span class="c1">//ä¸»çº¿ç¨‹æ‰“å°x</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"x"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//å­çº¿ç¨‹æ‰“å°y</span>
    <span class="k">new</span> <span class="nf">Thread</span><span class="p">(()=&gt;</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"y"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}).</span><span class="nf">Start</span><span class="p">();</span>

    <span class="k">new</span> <span class="nf">Thread</span><span class="p">((</span><span class="n">y</span><span class="p">)=&gt;{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}).</span><span class="nf">Start</span><span class="p">(</span><span class="s">"y"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="premonition warning"> <div class="header"> <svg class="icon warning" aria-hidden="true"> <use xlink:href="#icon-warning"></use> </svg> <div class="title"> çº¿ç¨‹çš„å‚æ•°ä¼ é€’ </div> </div> <div class="content"> <p>çº¿ç¨‹çš„å‚æ•°ä¼ é€’éœ€è¦ä½¿ç”¨ParameterizedThreadStartå§”æ‰˜ï¼Œå¹¶ä¸”éœ€è¦å°†å‚æ•°ä¼ é€’ç»™Startæ–¹æ³•ã€‚</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å¦‚æœä½¿ç”¨è¿™ç§æ–¹å¼ä¼šå¼‚å¸¸</span>
<span class="k">new</span> <span class="nf">Thread</span><span class="p">(()=&gt;{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}).</span><span class="nf">Start</span><span class="p">(</span><span class="s">"y"</span><span class="p">);</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">(</span><span class="kt">object</span> <span class="n">parameter</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// å¦‚æœm_Delegateæ˜¯ThreadStartå§”æ‰˜ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span>
    <span class="k">if</span><span class="p">(</span><span class="n">m_Delegate</span> <span class="k">is</span> <span class="n">ThreadStart</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetResourceString</span><span class="p">(</span><span class="s">""</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>



 </div> </div>
<h3 id="çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ">çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</h3>

<p>â€ƒâ€ƒçº¿ç¨‹æœ‰å¤šä¸ªçŠ¶æ€è¡¨ç¤ºä½¿ç”¨ThreadStateè¡¨ç¤ºï¼Œå…¶ä¸­æœ€é‡è¦çš„å‡ ä¸ªçŠ¶æ€å°±æ˜¯æš‚åœç­‰å¾…(ä¼‘çœ )ã€ç»ˆæ­¢<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">Thread</span> <span class="n">thread</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="p">(()</span> <span class="p">=&gt;{});</span>
    <span class="n">thread</span><span class="p">.</span><span class="n">IsBackground</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="n">thread</span><span class="p">.</span><span class="n">Priority</span> <span class="p">=</span> <span class="n">ThreadPriority</span><span class="p">.</span><span class="n">Highest</span><span class="p">;</span>
    <span class="n">thread</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
    <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
    <span class="n">thread</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
    <span class="n">thread</span><span class="p">.</span><span class="nf">Interrupt</span><span class="p">();</span>
    <span class="n">thread</span><span class="p">.</span><span class="nf">Abort</span><span class="p">();</span>
</code></pre></div></div>

<ol>
  <li><strong>æ–°å»ºçŠ¶æ€(New)</strong>â€Œ new Thread()åˆ›å»ºçº¿ç¨‹å¯¹è±¡æ—¶ï¼Œçº¿ç¨‹å¤„äºæ–°å»ºçŠ¶æ€ï¼Œæ­¤æ—¶å°šæœªåˆ†é…ç³»ç»Ÿèµ„æºâ€Œã€‚</li>
  <li><strong>å‰å°/åå°çº¿ç¨‹</strong> æ˜¾å¼åˆ›å»ºçš„çº¿ç¨‹æ˜¯å‰å°çº¿ç¨‹ï¼Œé€šè¿‡çº¿ç¨‹å¯¹è±¡çš„IsBackgroundå±æ€§å¯ä»¥æ§åˆ¶ã€‚<strong>è¿›ç¨‹ä¼šç­‰å¾…æ‰€æœ‰çš„å‰å°çº¿ç¨‹å®Œæˆåå†ç»“æŸå·¥ä½œï¼Œä½†æ˜¯å¦‚æœåªå‰©ä¸‹åå°çº¿ç¨‹ï¼Œåˆ™ä¼šç›´æ¥ç»“æ±å·¥ä½œã€‚</strong></li>
  <li><strong>çº¿ç¨‹çš„ä¼˜å…ˆçº§</strong> å‰å°çº¿ç¨‹çš„ä¼˜å…ˆçº§å¤§äºåå°çº¿ç¨‹ï¼Œå¦‚æœçº¿ç¨‹ä¼˜å…ˆçº§è®¾ç½®è¿‡å¤§ï¼Œåˆ™å¯èƒ½ä¼šå¹²æ¶‰åˆ°ç³»ç»Ÿè¿è¡Œï¼Œå¦‚ç£ç›˜å†™å…¥ã€é¼ æ ‡ç‚¹å‡»ç­‰éƒ½æ˜¯é«˜é€Ÿè¿è½¬çš„ï¼Œå¦‚æœç¨‹åºä¸­æœ‰å¤ªå¤šé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆç³»ç»Ÿéœ€è¦åˆ†é…å¤§é‡CPUæ—¶é—´è¿è¡Œè¿™äº›çº¿ç¨‹çš„ä»£ç ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿæ— å“åº”æˆ–å“åº”ç¼“æ…¢ã€‚</li>
  <li><strong>â€Œå°±ç»ªçŠ¶æ€(Runnable)</strong>â€Œ Start()æ–¹æ³•è°ƒç”¨åçº¿ç¨‹è¿›å…¥å°±ç»ªé˜Ÿåˆ—ï¼Œç­‰å¾…CPUè°ƒåº¦æ‰§è¡Œâ€Œã€‚</li>
  <li><strong>â€Œè¿è¡ŒçŠ¶æ€(Running)â€Œ</strong> å½“çº¿ç¨‹è·å¾—CPUæ—¶é—´ç‰‡æ—¶å¼€å§‹æ‰§è¡Œï¼Œç¤ºä¾‹ä¸­ç”±äºLambdaè¡¨è¾¾å¼ä¸ºç©ºï¼Œå®é™…ä¸æ‰§è¡Œæ“ä½œâ€Œã€‚â€Œ</li>
  <li><strong>é˜»å¡çŠ¶æ€(Blocked)â€Œ</strong> Thread.Sleep(1000)ä½¿ä¸»çº¿ç¨‹ä¼‘çœ 1ç§’ï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹å¤„äºå®šæ—¶ç­‰å¾…çŠ¶æ€â€Œã€‚</li>
  <li><strong>é˜»å¡çŠ¶æ€(Blocked)â€Œ</strong> Join(1000)ä½¿ä¸»çº¿ç¨‹ç­‰å¾…ç›®æ ‡çº¿ç¨‹å®Œæˆï¼Œæœ€å¤šé˜»å¡1ç§’â€Œã€‚</li>
  <li>â€Œ<strong>ä¸­æ–­çŠ¶æ€(Interrupted)â€Œ</strong> Interrupt()å‘çº¿ç¨‹å‘é€ä¸­æ–­ä¿¡å·ï¼Œè‹¥çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ä¼šæŠ›å‡ºInterruptedExceptionâ€Œã€‚</li>
  <li>â€Œ<strong>ç»ˆæ­¢çŠ¶æ€(Aborted/Terminated)â€Œ</strong> Abort()å¼ºåˆ¶ç»ˆæ­¢çº¿ç¨‹ï¼Œä¼šæŠ›å‡ºThreadAbortExceptionå¼‚å¸¸â€Œã€‚æ³¨æ„è¯¥æ–¹æ³•åœ¨.NETä¸­å·²è¿‡æ—¶ï¼Œæ¨èä½¿ç”¨åä½œå¼å–æ¶ˆæ¨¡å¼â€Œã€‚</li>
</ol>

<p>â€ƒâ€ƒçº¿ç¨‹çŠ¶æ€æšä¸¾ThreadStateï¼Œçº¿ç¨‹çŠ¶æ€çš„è½¬æ¢å›¾å¦‚ä¸‹ï¼š</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">enum</span> <span class="n">ThreadState</span>
<span class="p">{</span>
    <span class="n">Running</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="c1">// çº¿ç¨‹æ­£åœ¨è¿è¡Œ</span>
    <span class="n">StopRequested</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="c1">// çº¿ç¨‹è¯·æ±‚åœæ­¢</span>
    <span class="n">SuspendRequested</span> <span class="p">=</span> <span class="m">2</span><span class="p">,</span> <span class="c1">// çº¿ç¨‹è¯·æ±‚æŒ‚èµ·</span>
    <span class="n">Background</span> <span class="p">=</span> <span class="m">4</span><span class="p">,</span> <span class="c1">// çº¿ç¨‹æ˜¯åå°çº¿ç¨‹</span>
    <span class="n">Unstarted</span> <span class="p">=</span> <span class="m">8</span><span class="p">,</span> <span class="c1">// çº¿ç¨‹æœªå¯åŠ¨</span>
    <span class="n">Stopped</span> <span class="p">=</span> <span class="m">16</span><span class="p">,</span> <span class="c1">// çº¿ç¨‹å·²åœæ­¢</span>
    <span class="n">WaitSleepJoin</span> <span class="p">=</span> <span class="m">32</span><span class="p">,</span> <span class="c1">// çº¿ç¨‹ç­‰å¾…ã€ä¼‘çœ æˆ–åŠ å…¥</span>
    <span class="n">Suspended</span> <span class="p">=</span> <span class="m">64</span><span class="p">,</span> <span class="c1">// çº¿ç¨‹æŒ‚èµ·</span>
    <span class="n">AbortRequested</span> <span class="p">=</span> <span class="m">128</span><span class="p">,</span> <span class="c1">// çº¿ç¨‹è¯·æ±‚ç»ˆæ­¢</span>
    <span class="n">Aborted</span> <span class="p">=</span> <span class="m">256</span><span class="p">,</span> <span class="c1">// çº¿ç¨‹å·²ç»ˆæ­¢</span>
<span class="p">}</span>
</code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts\2025\month6\thread_state.png" width="250" /><font size="2.5">
            <i>çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸå›¾ç¤º.</i>
        </font></center>

<div class="premonition warning"> <div class="header"> <svg class="icon warning" aria-hidden="true"> <use xlink:href="#icon-warning"></use> </svg> <div class="title"> çº¿ç¨‹ç»ˆæ­¢è­¦å‘Š </div> </div> <div class="content"> <p>Interrupt()å’ŒAbort()çš„è°ƒç”¨æ—¶æœºä¼šå½±å“çº¿ç¨‹çŠ¶æ€è½¬æ¢ç»“æœï¼Œè‹¥çº¿ç¨‹å·²ç»ˆæ­¢åˆ™è¿™äº›æ“ä½œæ— æ•ˆâ€Œã€‚åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­åº”è°¨æ…ä½¿ç”¨å¼ºåˆ¶ç»ˆæ­¢æ–¹æ³•ï¼Œå¯èƒ½å¼•å‘èµ„æºæœªé‡Šæ”¾ç­‰é—®é¢˜â€Œã€‚</p>



 </div> </div>
<h3 id="çº¿ç¨‹çš„åŒæ­¥å’Œäº’æ–¥">çº¿ç¨‹çš„åŒæ­¥å’Œäº’æ–¥</h3>

<p>â€ƒâ€ƒCLRè¿è¡Œæ—¶ç®¡ç†åˆ†é…ç€æ¯ä¸€ä¸ªçº¿ç¨‹æ‰€éœ€å¤šç‹¬ç«‹å†…å­˜æ ˆï¼Œä»è€Œä¿è¯äº†å±€éƒ¨å˜é‡çš„éš”ç¦»ã€‚å¦‚æœä¸åŒçš„çº¿ç¨‹æ‹¥æœ‰åŒä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œåˆ™è¿™äº›çº¿ç¨‹ä¹‹é—´å°±å…±äº«äº†æ•°æ®ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šå°†Lambdaè¡¨è¾¾å¼æ•è·çš„å±€éƒ¨å˜é‡æˆ–åŒ¿åå§”æ‰˜è½¬æ¢ä¸ºå­—æ®µï¼Œå› æ­¤å®ƒä»¬ä¹Ÿå¯ä»¥è¢«å…±äº«ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">void</span> <span class="n">ThreadTest</span><span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(){</span>
        <span class="kt">bool</span> <span class="n">done</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">ThreadStart</span> <span class="n">aciont</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span> <span class="n">Console</span> <span class="nf">WriteLine</span> <span class="p">(</span><span class="s">"Done"</span><span class="p">);</span> <span class="n">done</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">new</span> <span class="nf">Thread</span> <span class="p">(</span><span class="n">action</span><span class="p">).</span><span class="nf">Start</span><span class="p">();</span>
        <span class="nf">action</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>â€ƒâ€ƒä¸Šè¿°ä»£ç ï¼Œä¸»çº¿ç¨‹è°ƒç”¨äº†actionï¼ŒåŒæ—¶newäº†ä¸€ä¸ªå­çº¿ç¨‹ç»‘å®šäº†åŒ¿åå‡½æ•°æ•è·äº†å¤–éƒ¨å˜é‡doneï¼Œè¿™ä¸ªâ€œDoneâ€æ˜¯æœ‰å¯èƒ½è¾“å‡ºä¸¤æ¬¡çš„ã€‚ä¸»çº¿ç¨‹æ­£åœ¨æ‰“å°â€œDoneâ€æ—¶ï¼Œå­çº¿ç¨‹å¯èƒ½å·²ç»è¿›å…¥åˆ°åŒ¿åå‡½æ•°æ­£åœ¨åˆ¤å®šã€‚</p>

<h4 id="lockçº¿ç¨‹é”">lockçº¿ç¨‹é”</h4>

<p>â€ƒâ€ƒé”æœ‰ä¸‰ç§ç»“æ„ï¼šLockã€Mutexå’ŒSpinLockï¼Œå…¶ä¸­Lockæ˜¯æœ€å¸¸ç”¨æœ€æ–¹ä¾¿çš„é”ç»“æ„ã€‚é”å…è®¸å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶é—´å†…åªæœ‰ä¸€ä¸ªèƒ½å¤Ÿè®¿é—®è¢«é”å®šçš„èµ„æºï¼Œä»è€Œé¿å…ç«æ€æ¡ä»¶å’Œæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="kt">object</span> <span class="n">lockObject</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span> <span class="c1">// é”å¯¹è±¡</span>
    <span class="k">private</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">sharedValue</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Thread</span> <span class="n">thread1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="p">(</span><span class="n">IncrementSharedValue</span><span class="p">);</span>
        <span class="n">Thread</span> <span class="n">thread2</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="p">(</span><span class="n">IncrementSharedValue</span><span class="p">);</span>

        <span class="n">thread1</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
        <span class="n">thread2</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>

        <span class="n">thread1</span><span class="p">.</span><span class="nf">Join</span><span class="p">();</span>
        <span class="n">thread2</span><span class="p">.</span><span class="nf">Join</span><span class="p">();</span>

        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Final shared value: "</span> <span class="p">+</span> <span class="n">sharedValue</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">void</span> <span class="nf">IncrementSharedValue</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">100000</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="k">lock</span> <span class="p">(</span><span class="n">lockObject</span><span class="p">)</span> <span class="c1">// ä½¿ç”¨é”</span>
            <span class="p">{</span>
                <span class="n">sharedValue</span><span class="p">++;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«å¯¹sharedValueè¿›è¡Œäº†100000æ¬¡çš„å¢åŠ æ“ä½œï¼Œä½†ç”±äºä½¿ç”¨äº†é”æœºåˆ¶ï¼Œå®ƒä»¬ä¸ä¼šäº¤å‰å¹¶å‘åœ°ä¿®æ”¹sharedValueï¼Œä»è€Œç¡®ä¿äº†æ•°æ®ä¸€è‡´æ€§ã€‚thread1.Join()ä¸thread2.Join()ç®€å•ç†è§£å°±æ˜¯æŠŠthread1/2åˆå¹¶åˆ°ä¸»çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹é»˜è®¤æ˜¯å‰å°çº¿ç¨‹éœ€è¦ç­‰å¾…thread1/2æ‰§è¡Œå®Œæˆåæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚å¦‚æœä¸è°ƒç”¨Joiné‚£ä¹ˆç›´æ¥æ‰“å°äº†Final shared valueç»“æœä¼šä¸å‡†ç¡®ã€‚</p>

<div class="premonition info"> <div class="header"> <svg class="icon info" aria-hidden="true"> <use xlink:href="#icon-info"></use> </svg> <div class="title"> é”çš„å¼€é”€æç¤º </div> </div> <div class="content"> <p>ä½¿ç”¨é”æœºåˆ¶å¯èƒ½ä¼šå¼•å…¥æ€§èƒ½å¼€é”€ï¼Œå› ä¸ºåœ¨ä¸€ä¸ªçº¿ç¨‹è®¿é—®é”å®šä»£ç å—æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚å› æ­¤ï¼Œåœ¨è®¾è®¡å¤šçº¿ç¨‹åº”ç”¨æ—¶ï¼Œåº”æ ¹æ®å®é™…éœ€æ±‚å’Œæ€§èƒ½è¦æ±‚åˆç†åœ°ä½¿ç”¨é”æœºåˆ¶ï¼Œé¿å…é”çš„è¿‡åº¦ä½¿ç”¨å¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚</p>



 </div> </div>
<h4 id="æ­»é”">æ­»é”</h4>

<p>â€ƒâ€ƒæ­»é”å°†å¯¼è‡´ç¨‹åºåœæ­¢å·¥ä½œæ˜¯æœ€å¸¸è§çš„å¤šçº¿ç¨‹é”™è¯¯ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ­»é”ç¤ºä¾‹ï¼š</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">object</span> <span class="n">locker1</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>
<span class="kt">object</span> <span class="n">locker2</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span> 
<span class="n">Thread</span> <span class="n">threadA</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Thread</span> <span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">lock</span> <span class="p">(</span><span class="n">locker1</span><span class="p">){</span>
        <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
        <span class="k">lock</span> <span class="p">(</span><span class="n">locker2</span><span class="p">);</span> <span class="c1">//Deadlock</span>
    <span class="p">}</span>
    
<span class="p">});</span>
<span class="n">threadA</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>

<span class="k">lock</span> <span class="p">(</span><span class="n">locker2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span> <span class="p">(</span><span class="m">1000</span><span class="p">);</span>
    <span class="k">lock</span> <span class="p">(</span><span class="n">locker1</span><span class="p">);</span> <span class="c1">//Deadlock</span>
<span class="p">}</span>

<span class="c1">//ä½¿ç”¨ä¸‰ä¸ªæˆ–è€…æ›´å¤šçš„çº¿ç¨‹åˆ™å¯èƒ½å½¢æˆæ›´åŠ å¤æ‚çš„æ­»é”é“¾ã€‚</span>
</code></pre></div></div>

<p>â€ƒâ€ƒæ­»é”çš„å½¢æˆè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<p><strong>åˆå§‹çŠ¶æ€</strong>ï¼š</p>
<ol>
  <li>åˆ›å»ºäº†ä¸¤ä¸ªé”å¯¹è±¡ï¼šlocker1å’Œlocker2</li>
  <li>æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼šçº¿ç¨‹Aï¼ˆæ–°åˆ›å»ºçš„çº¿ç¨‹ï¼‰å’Œä¸»çº¿ç¨‹</li>
</ol>

<p><strong>æ­¥éª¤1</strong>ï¼šçº¿ç¨‹å¯åŠ¨ï¼ˆt=0msï¼‰</p>
<ol>
  <li>çº¿ç¨‹A å¼€å§‹æ‰§è¡Œï¼Œè¿›å…¥ç¬¬ä¸€ä¸ªlock(locker1)</li>
  <li>çº¿ç¨‹A æˆåŠŸè·å–lock(locker1)çš„é”</li>
  <li>åŒæ—¶ï¼Œä¸»çº¿ç¨‹ æ‰§è¡Œåˆ°lock(locker2)</li>
  <li>ä¸»çº¿ç¨‹ æˆåŠŸè·å–lock(locker2)çš„é”</li>
</ol>

<p><strong>æ­¥éª¤2</strong>ï¼šå»¶æ—¶é˜¶æ®µï¼ˆt=0-1000msï¼‰</p>
<ol>
  <li>çº¿ç¨‹A æŒæœ‰lock(locker1)ï¼Œæ‰§è¡ŒThread.Sleep(1000)</li>
  <li>ä¸»çº¿ç¨‹ æŒæœ‰lock(locker2)ï¼Œæ‰§è¡ŒThread.Sleep(1000)</li>
  <li>æ­¤æ—¶ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ç¡çœ ï¼Œå„è‡ªæŒæœ‰ä¸€ä¸ªé”</li>
</ol>

<p><strong>æ­¥éª¤3</strong>ï¼šæ­»é”å½¢æˆï¼ˆt=1000msåï¼‰</p>
<ol>
  <li>çº¿ç¨‹A ä»ç¡çœ ä¸­é†’æ¥ï¼Œå°è¯•è·å–lock(locker2)ï¼Œä½†æ˜¯locker2å·²ç»è¢«ä¸»çº¿ç¨‹æŒæœ‰ï¼Œçº¿ç¨‹Aè¢«é˜»å¡ï¼Œç­‰å¾…lock(locker2)é‡Šæ”¾</li>
  <li>ä¸»çº¿ç¨‹ ä»ç¡çœ ä¸­é†’æ¥ï¼Œå°è¯•è·å–lock(locker1)ï¼Œä½†æ˜¯locker1 å·²ç»è¢«çº¿ç¨‹AæŒæœ‰ï¼Œä¸»çº¿ç¨‹è¢«é˜»å¡ï¼Œç­‰å¾…lock(locker1)é‡Šæ”¾</li>
</ol>

<pre><code class="language-mermaid2">graph LR
    A[çº¿ç¨‹A] --&gt; |æŒæœ‰| L1[locker1]
    A --&gt; |ç­‰å¾…| L2[locker2]
    B[ä¸»çº¿ç¨‹] --&gt; |æŒæœ‰| L2
    B --&gt; |ç­‰å¾…| L1
    
    L1 -.-&gt; |é˜»å¡| B
    L2 -.-&gt; |é˜»å¡| A
    
    style A fill:#ff9999
    style B fill:#99ccff
    style L1 fill:#ffcc99
    style L2 fill:#ffcc99
</code></pre>

<h4 id="monitoré”å®šèµ„æº">Monitoré”å®šèµ„æº</h4>

<p>â€ƒâ€ƒMonitoræ˜¯C#ä¸­ç”¨äºå®ç°çº¿ç¨‹åŒæ­¥å’Œäº’æ–¥çš„å¦ä¸€ç§æœºåˆ¶ï¼ŒåŒæ—¶lockå…³é”®å­—æ˜¯Monitorç±»çš„ä¸€ç§è¯­æ³•ç³–ã€‚å®ƒæä¾›äº†æ›´é«˜çº§çš„æ–¹æ³•TryEenter()ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span> <span class="n">acquiredLock</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span> 
<span class="k">try</span><span class="p">{</span>
    <span class="n">Monitor</span><span class="p">.</span><span class="nf">Enter</span><span class="p">(</span><span class="n">lockObject</span><span class="p">,</span> <span class="k">ref</span> <span class="n">acquiredLock</span><span class="p">);</span>
    <span class="c1">// Code that accesses resources that are protected by the lock.</span>
<span class="p">}</span>
<span class="k">finally</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">acquiredLock</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Monitor</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="n">lockObject</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒMonitorç±»çš„ä½¿ç”¨æ–¹å¼ç›¸å¯¹äºlocké”æœºåˆ¶æ›´çµæ´»ã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨Monitorç±»çš„ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´æ§åˆ¶è®¿é—®é¡ºåºï¼š</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">syncLock</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>
    <span class="k">private</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">currentThread</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="c1">// 1è¡¨ç¤ºçº¿ç¨‹1ï¼Œ2è¡¨ç¤ºçº¿ç¨‹2</span>

    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">thread1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="p">(</span><span class="n">Worker</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">thread2</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="p">(</span><span class="n">Worker</span><span class="p">);</span>

        <span class="n">thread1</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
        <span class="n">thread2</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>

        <span class="n">thread1</span><span class="p">.</span><span class="nf">Join</span><span class="p">();</span>
        <span class="n">thread2</span><span class="p">.</span><span class="nf">Join</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">void</span> <span class="nf">Worker</span><span class="p">(</span><span class="kt">object</span> <span class="n">threadIdObj</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">threadId</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">threadIdObj</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="k">lock</span> <span class="p">(</span><span class="n">syncLock</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">currentThread</span> <span class="p">!=</span> <span class="n">threadId</span><span class="p">)</span>
                    <span class="n">Monitor</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="n">syncLock</span><span class="p">);</span>

                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Thread </span><span class="p">{</span><span class="n">threadId</span><span class="p">}</span><span class="s">: </span><span class="p">{</span><span class="n">i</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="n">currentThread</span> <span class="p">=</span> <span class="n">threadId</span> <span class="p">==</span> <span class="m">1</span> <span class="p">?</span> <span class="m">2</span> <span class="p">:</span> <span class="m">1</span><span class="p">;</span>
                <span class="n">Monitor</span><span class="p">.</span><span class="nf">Pulse</span><span class="p">(</span><span class="n">syncLock</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®Workeræ—¶é€šè¿‡åˆ¤å®šçº¿ç¨‹IDæ˜¯å¦ä¸€è‡´ç¡®å®šè¯¥çº¿ç¨‹æ˜¯å¦ç»§ç»­æ‰§è¡Œï¼Œä¸ä¸€è‡´å°±ä½¿ç”¨Monitor.Wait()æ–¹æ³•ä¼šä½¿å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°å…¶å®ƒçº¿ç¨‹å®Œæˆè®¿é—®Workeré€šè¿‡Monitor.Pulse()æ–¹æ³•é€šçŸ¥å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚</p>

<div class="premonition warning"> <div class="header"> <svg class="icon warning" aria-hidden="true"> <use xlink:href="#icon-warning"></use> </svg> <div class="title"> Monitorä¹Ÿä¼šæœ‰æ­»é” </div> </div> <div class="content"> <p>ä½¿ç”¨Monitorç±»å¯ä»¥åœ¨æ›´å¤æ‚çš„æƒ…å†µä¸‹æ§åˆ¶çº¿ç¨‹ä¹‹é—´çš„è®¿é—®é¡ºåºï¼Œä½†ä¹Ÿéœ€è¦å°å¿ƒé¿å…æ­»é”ç­‰é—®é¢˜ã€‚è¿™ç§æ–¹æ³•éœ€è¦çº¿ç¨‹ä¹‹é—´ç›¸äº’é…åˆï¼Œä»¥ç¡®ä¿æ­£ç¡®çš„æ‰§è¡Œé¡ºåºã€‚</p>



 </div> </div>
<h4 id="mutexåŒæ­¥">MutexåŒæ­¥</h4>

<p>â€ƒâ€ƒMutexå’Œlockç±»ä¼¼ï¼Œä½†æ˜¯å®ƒå¯ä»¥æ”¯æŒå¤šä¸ªè¿›ç¨‹ã€‚å…¶åªå¯¹ä¸€ä¸ªçº¿ç¨‹æˆäºˆå¯¹å…±äº«èµ„æºçš„ç‹¬å è®¿é—®ã€‚Mutexç±»çš„WaitOneæ–¹æ³•å°†è·å¾—è¯¥é”ï¼ŒReleaseMutexæ–¹æ³•å°†é‡Šæ”¾è¯¥é”ã€‚Mutexåªèƒ½åœ¨è·å¾—é”çš„çº¿ç¨‹é‡Šæ”¾é”ã€‚é‡Šæ”¾Mutexéœ€è¦å¤§çº¦ä¸€å¾®ç§’çš„æ—¶é—´ï¼Œå¤§æ¦‚æ¯”1ockè¦æ…¢20å€<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="kt">string</span> <span class="n">MutexName</span> <span class="p">=</span> <span class="s">"CSharpThreadingCookbook"</span><span class="p">;</span>
<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">m</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Mutex</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="n">MutexName</span><span class="p">)){</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">m</span><span class="p">.</span><span class="nf">WaitOne</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">5</span><span class="p">),</span> <span class="k">false</span><span class="p">)){</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Second instance is running!"</span><span class="p">);</span>    
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Running!"</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
        <span class="n">m</span><span class="p">.</span><span class="nf">ReleaseMutex</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="semaphoreä¿¡å·é‡">Semaphoreä¿¡å·é‡</h4>

<p>â€ƒâ€ƒä¿¡å·é‡æ˜¯ä¸€ç§è®¡æ•°å™¨ï¼Œç”¨äºé™åˆ¶åŒæ—¶è®¿é—®æŸä¸ªèµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚ä¿¡å·é‡å¯ç”¨äºé™åˆ¶å¹¶å‘æ€§ï¼Œé˜²æ­¢å¤ªå¤šçš„çº¿ç¨‹åŒæ—¶æ‰§è¡Œç‰¹å®šçš„ä»£ç ã€‚åœ¨C#4.0å¼•å…¥äº†è½»é‡çº§Semaphoreslimä¿¡å·é‡ï¼ŒSemaphoreåœ¨è°ƒç”¨WaitOneå’ŒReleaseæ–¹æ³•æ—¶å¤§æ¦‚ä¼šæ¶ˆè€—1å¾®ç§’çš„æ—¶é—´ï¼Œè€ŒSemaphoreslimçš„å¼€é”€åªæœ‰å‰è€…çš„ååˆ†ä¹‹ä¸€<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">Semaphoreslim</span> <span class="n">semaphore</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Semaphoreslim</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>

    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">Thread</span> <span class="n">thread</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="p">(</span><span class="n">DoWork</span><span class="p">);</span>
            <span class="n">thread</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">void</span> <span class="nf">DoWork</span><span class="p">(</span><span class="kt">object</span> <span class="n">id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">semaphore</span><span class="p">.</span><span class="nf">WaitOne</span><span class="p">();</span> <span class="c1">// ç­‰å¾…è·å–ä¿¡å·é‡</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Thread "</span> <span class="p">+</span> <span class="n">id</span> <span class="p">+</span> <span class="s">" is working..."</span><span class="p">);</span>
        <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Thread "</span> <span class="p">+</span> <span class="n">id</span> <span class="p">+</span> <span class="s">" finished."</span><span class="p">);</span>
        <span class="n">semaphore</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span> <span class="c1">// é‡Šæ”¾ä¿¡å·é‡</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="çº¿ç¨‹æ± ">çº¿ç¨‹æ± </h2>

<p>â€ƒâ€ƒæ¯å½“å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œéƒ½éœ€è¦ä¸€å®šæ—¶é—´(ä¸Šç™¾æ¯«ç§’)æ¥åˆ›å»ºæ–°çš„å±€éƒ¨å˜é‡æ ˆã€‚å¦‚æœä½¿ç”¨çº¿ç¨‹æ± é¢„å…ˆåˆ›å»ºå¯å›æ”¶çº¿ç¨‹å¯å¤§å¹…é™ä½åˆ›å»ºå¼€é”€ã€‚ä½†æ˜¯<strong>çº¿ç¨‹æ± çš„çº¿ç¨‹éƒ½æ˜¯åå°çº¿ç¨‹ï¼Œé˜»å¡çº¿ç¨‹æ± å°†ä¼šå½±å“æ€§èƒ½</strong>ã€‚Thread.CurrentThread.IsThreadPoolThreadå±æ€§å¯ç¡®è®¤å½“å‰çº¿ç¨‹æ˜¯å¦å±äºçº¿ç¨‹æ± ã€‚</p>

<h3 id="çº¿ç¨‹æ± ç®€ä»‹">çº¿ç¨‹æ± ç®€ä»‹</h3>

<p>â€ƒâ€ƒçº¿ç¨‹æ± çº¿ç¨‹æ˜¯åå°çº¿ç¨‹ã€‚ æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨é»˜è®¤å †æ ˆå¤§å°ï¼Œä»¥é»˜è®¤ä¼˜å…ˆçº§è¿è¡Œï¼Œå¹¶ä¸”ä½äºå¤šçº¿ç¨‹å•å…ƒä¸­ã€‚ çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å®Œæˆå…¶ä»»åŠ¡åï¼Œå®ƒå°†è¿”å›åˆ°ç­‰å¾…çº¿ç¨‹çš„é˜Ÿåˆ—ã€‚ ä»æ­¤åˆ»èµ·ï¼Œå¯ä»¥é‡å¤ä½¿ç”¨å®ƒã€‚ è¿™æ ·ï¼Œåº”ç”¨ç¨‹åºå°±å¯ä»¥é¿å…ä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºæ–°çº¿ç¨‹çš„æˆæœ¬ã€‚</p>

<p>â€ƒâ€ƒ<strong>æ¯ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ± å®ä¾‹ã€‚</strong></p>

<h3 id="çº¿ç¨‹æ± çš„ä½¿ç”¨">çº¿ç¨‹æ± çš„ä½¿ç”¨</h3>

<p>â€ƒâ€ƒé€šè¿‡System.Threading.ThreadPoolç±»å¯ä»¥è·å–çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼Œé€šè¿‡QueueUserWorkItemé™æ€æ–¹æ³•å°†ä»»åŠ¡æ·»åŠ åˆ°çº¿ç¨‹æ± é˜Ÿåˆ—ä¸­ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªå§”æ‰˜è¡¨ç¤ºä¸€ä¸ªè‡ªå®šä¹‰çš„å¼‚æ­¥æ“ä½œã€‚åœ¨è°ƒç”¨QueueUserWorkItemæ–¹æ³•æ—¶ï¼Œå¦‚æœçº¿ç¨‹æ± ä¸­æ²¡æœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™è¯¥æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œå§”æ‰˜ä»»åŠ¡ã€‚å¦‚æœè¿‡å¿«è°ƒç”¨QueueUserWorkItemæ–¹æ³•ï¼Œåˆ™çº¿ç¨‹æ± ä¼šåˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹ï¼Œæ–°çš„å§”æ‰˜æ“ä½œå°†åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ç›´åˆ°çº¿ç¨‹æ± ä¸­çº¿ç¨‹ç©ºé—²ï¼Œæ‰€ä»¥è¿‡å¿«çš„è°ƒç”¨ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</p>

<div class="premonition warning"> <div class="header"> <svg class="icon warning" aria-hidden="true"> <use xlink:href="#icon-warning"></use> </svg> <div class="title"> çº¿ç¨‹æ± è­¦å‘Š </div> </div> <div class="content"> <ol>
  <li>çº¿ç¨‹æ± é€‚åˆçŸ­æ—¶ä»»åŠ¡ï¼Œä¸é€‚åˆé•¿æ—¶é—´è¿è¡Œä¸”è®¡ç®—å¯†é›†å‹æ“ä½œã€‚</li>
  <li>çº¿ç¨‹æ˜¯è¢«CLRç®¡ç†çš„ä½œä¸ºç³»ç»Ÿçº§èµ„æºï¼Œå¦‚æœåº”ç”¨å¤§é‡å ç”¨çº¿ç¨‹æ± çº¿ç¨‹å¯¼è‡´é˜»å¡ï¼Œä¼šæ˜¾è‘—æ‹–æ…¢è¿›ç¨‹çš„å“åº”é€Ÿåº¦ã€‚</li>
</ol>



 </div> </div>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">delegate</span> <span class="kt">string</span> <span class="nf">RunTestThreadPool</span><span class="p">(</span><span class="k">out</span> <span class="kt">int</span> <span class="n">threadId</span><span class="p">);</span>

<span class="c1">//public delegate void AsyncCallback(IAsyncResult ar);</span>
<span class="c1">//åªè¦è·ŸAsyncCallbackå§”æ‰˜çš„ç­¾åä¸€è‡´å³å¯</span>
<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">FinishCallback</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"callback called"</span><span class="p">);</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$"çº¿ç¨‹çŠ¶æ€=</span><span class="p">{</span><span class="n">result</span><span class="p">.</span><span class="n">AsyncState</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$"çº¿ç¨‹Id</span><span class="p">{</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">Test</span><span class="p">(</span><span class="k">out</span> <span class="kt">int</span> <span class="n">threadId</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Thread starting"</span><span class="p">);</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$"Thread id = </span><span class="p">{</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
    <span class="n">threadId</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="s">$"Thread id = </span><span class="p">{</span><span class="n">threadId</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//å…¥å£å‡½æ•°</span>
<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ThreadPoolStart</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">threadId</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="c1">// ä½¿ç”¨Threadåˆ›å»ºçº¿ç¨‹</span>
    <span class="kt">var</span> <span class="n">thread1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="p">((()</span> <span class="p">=&gt;</span> <span class="nf">Test</span><span class="p">(</span><span class="k">out</span> <span class="n">threadId</span><span class="p">)));</span>
    <span class="n">thread1</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
    <span class="c1">//åˆ›å»ºçº¿ç¨‹idç¡®å®šä¸æ˜¯æ¥è‡ªçº¿ç¨‹æ± çš„çº¿ç¨‹id</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$"new Thread id </span><span class="p">{</span><span class="n">thread1</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="c1">// ä½¿ç”¨çº¿ç¨‹æ± è¿è¡Œå§”æ‰˜</span>
    <span class="n">RunTestThreadPool</span> <span class="n">poolDelegate</span> <span class="p">=</span> <span class="n">Test</span><span class="p">;</span>
    <span class="c1">// æ¥å—ä¸€ä¸ªå›è°ƒå‡½æ•°å’Œè‡ªå®šä¹‰å‚æ•°ï¼Œå¹¶ç†è§£è¿”å›IAsyncResultå¯¹è±¡</span>
    <span class="n">IAsyncResult</span> <span class="n">thread2</span> <span class="p">=</span> <span class="n">poolDelegate</span><span class="p">.</span><span class="nf">BeginInvoke</span><span class="p">(</span><span class="k">out</span> <span class="n">threadId</span><span class="p">,</span> <span class="n">FinishCallback</span><span class="p">,</span> <span class="s">"delegate async callback"</span><span class="p">);</span>
    <span class="c1">// ç­‰å¾…çº¿ç¨‹æ± çº¿ç¨‹å®Œæˆï¼Œåé¢çš„ä»£ç å¼€å§‹æŒ‚èµ·ï¼Œå…è®¸ç»§ç»­å…¶ä»–å·¥ä½œ</span>
    <span class="n">thread2</span><span class="p">.</span><span class="n">AsyncWaitHandle</span><span class="p">.</span><span class="nf">WaitOne</span><span class="p">();</span>
    <span class="c1">// è·å–çº¿ç¨‹æ± çº¿ç¨‹è¿”å›å€¼</span>
    <span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">poolDelegate</span><span class="p">.</span><span class="nf">EndInvoke</span><span class="p">(</span><span class="n">thread2</span><span class="p">);</span>
    <span class="c1">// æ‰“å°çº¿ç¨‹æ± çº¿ç¨‹id</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$"thread pool threaId </span><span class="p">{</span><span class="n">threadId</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="c1">// æ‰“å°çº¿ç¨‹æ± çº¿ç¨‹è¿”å›å€¼</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="c1">// ç­‰å¾…1ç§’</span>
    <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒBeginInvoke/EndInvokeçš„å‰xä¸ªå‚æ•°ä¸å§”æ‰˜çš„ç­¾åå‚æ•°æ˜¯è¦ä¸€è‡´çš„ï¼Œç„¶ååä¸€ä¸ªå‚æ•°æ˜¯å®Œæˆå›è°ƒï¼Œæœ€åæ˜¯è‡ªå®šä¹‰objectå‚æ•°æ˜¯åœ¨EndInvokeçš„è¿”å›å€¼ã€‚ä½¿ç”¨Begin/Endæ–¹æ³•å’ŒIAsyncResultå¯¹è±¡å¯ä»¥å®ç°å¼‚æ­¥è°ƒç”¨è¢«ç§°ä¸ºå¼‚æ­¥ç¼–ç¨‹æ¨¡å‹<a href="../CSharp/CSharp_Thread_Pattern.html#apmæ¨¡å¼">APMæ¨¡å‹</a>ã€‚<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup></p>

<div class="premonition error"> <div class="header"> <svg class="icon error" aria-hidden="true"> <use xlink:href="#icon-error"></use> </svg> <div class="title"> Threadå·²è¿‡æ—¶ </div> </div> <div class="content"> <p>ç°ä»£C#ä¸å†æ¨èç›´æ¥æ“ä½œä½¿ç”¨Threadã€ThreadPoolï¼ŒC#åœ¨4.0ä»¥åæ¨å‡ºäº†ä¸€å¥—æŠ½è±¡ç¨‹åº¦æ›´é«˜çš„TPLçš„APIå°†ThreadPoolä½œä¸ºåº•å±‚å®ç°åŒ…è£…èµ·æ¥ã€‚</p>



 </div> </div>
<h4 id="çº¿ç¨‹æ± åˆ›å»º">çº¿ç¨‹æ± åˆ›å»º</h4>

<p>â€ƒâ€ƒè§‚å¯Ÿåˆ›å»ºçº¿ç¨‹éœ€è¦çš„æ—¶é—´ï¼Œçº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹çš„æ•ˆç‡æ¯”new Thread()åˆ›å»ºçº¿ç¨‹çš„æ•ˆç‡è¦é«˜ï¼Œå› ä¸ºçº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹æ˜¯å¯å¤ç”¨çš„ï¼Œè€Œnew Thread()åˆ›å»ºçº¿ç¨‹æ˜¯æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Stopwatch</span> <span class="n">stopwatch</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Stopwatch</span><span class="p">();</span>
<span class="n">stopwatch</span><span class="p">.</span><span class="nf">Start</span><span class="p">();;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">100</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
<span class="p">{</span>
    <span class="c1">// new Thread(() =&gt; { }).Start();</span>
    <span class="n">ThreadPool</span><span class="p">.</span><span class="nf">QueueUserWorkItem</span><span class="p">((</span><span class="n">a</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">});</span>
<span class="p">}</span>
<span class="n">stopwatch</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"åˆ›å»º100ä¸ªçº¿ç¨‹éœ€è¦èŠ±è´¹æ—¶é—´(æ¯«ç§’)ï¼š"</span> <span class="p">+</span> <span class="n">stopwatch</span><span class="p">.</span><span class="n">ElapsedMilliseconds</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
</code></pre></div></div>
<p>â€ƒâ€ƒç”¨æˆ‘çš„Mac intel 6æ ¸CPUæµ‹è¯•åˆ°ç›´æ¥New Threadåˆ›å»ºæ¶ˆè€—260msï¼Œè€Œçº¿ç¨‹æ± åˆ›å»º100ä¸ªå¯å¤ç”¨çš„çº¿ç¨‹æ¶ˆè€—åªæœ‰3msã€‚</p>

<h4 id="çº¿ç¨‹æ± æ•°é‡">çº¿ç¨‹æ± æ•°é‡</h4>

<p>â€ƒâ€ƒçº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡æ˜¯æ ¹æ®CPUæ ¸å¿ƒæ•°æ¥å†³å®šçš„ï¼Œé»˜è®¤æƒ…å†µä¸‹çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ä¸ºCPUæ ¸å¿ƒæ•°ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡SetMinThreads()å’Œ SetMaxThreads()è®¾ç½®çº¿ç¨‹æ± å·¥ä½œçš„æœ€å°å’Œæœ€å¤§çº¿ç¨‹æ•°ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">SetMinThreads</span> <span class="p">(</span><span class="kt">int</span> <span class="n">workerThreads</span><span class="p">,</span> <span class="kt">int</span> <span class="n">completionPortThreads</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">SetMaxThreads</span> <span class="p">(</span><span class="kt">int</span> <span class="n">workerThreads</span><span class="p">,</span> <span class="kt">int</span> <span class="n">completionPortThreads</span><span class="p">);</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">GetMinThreads</span> <span class="p">(</span><span class="k">out</span> <span class="kt">int</span> <span class="n">workerThreads</span><span class="p">,</span> <span class="k">out</span> <span class="kt">int</span> <span class="n">completionPortThreads</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">GetMaxThreads</span> <span class="p">(</span><span class="k">out</span> <span class="kt">int</span> <span class="n">workerThreads</span><span class="p">,</span> <span class="k">out</span> <span class="kt">int</span> <span class="n">completionPortThreads</span><span class="p">);</span>
</code></pre></div></div>

<p>â€ƒâ€ƒ<strong>workerThreads</strong>ï¼šå·¥ä½œçº¿ç¨‹æ•°ï¼Œè¿™äº›çº¿ç¨‹ç”¨äºå¤„ç†ä¸€èˆ¬çš„CPUå¯†é›†å‹ä»»åŠ¡å’Œæ™®é€šçš„å¼‚æ­¥æ“ä½œï¼Œé»˜è®¤å€¼é€šå¸¸ç­‰äºCPUæ ¸å¿ƒæ•°ã€‚</p>

<p>â€ƒâ€ƒ<strong>completionPortThreads</strong>ï¼šI/Oå®Œæˆç«¯å£çº¿ç¨‹æ•°ï¼Œè¿™äº›çº¿ç¨‹ä¸“é—¨ç”¨äºå¤„ç†å¼‚æ­¥I/Oæ“ä½œçš„å®Œæˆé€šçŸ¥ï¼Œå¤„ç†æ–‡ä»¶è¯»å†™ã€ç½‘ç»œè¯·æ±‚ç­‰I/Oå¯†é›†å‹æ“ä½œçš„å›è°ƒã€‚
â€ƒâ€ƒ<strong>è¿”å›å€¼</strong>ï¼šSetå·¥ä½œçº¿ç¨‹æ•°é‡è¿”å›å€¼boolä¸ºtrueè¡¨ç¤ºæˆåŠŸï¼Œå¤±è´¥false(ç³»ç»Ÿå‚æ•°ä¸ºè´Ÿã€å†…å­˜ä¸è¶³ã€è¶…è¿‡å—é™å€¼)ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æ£€æŸ¥å½“å‰è®¾ç½®</span>
<span class="kt">int</span> <span class="n">currentWorker</span><span class="p">;</span> <span class="kt">int</span> <span class="n">currentIO</span><span class="p">;</span>
<span class="n">ThreadPool</span><span class="p">.</span><span class="nf">GetMaxThreads</span><span class="p">(</span><span class="k">out</span> <span class="n">currentWorker</span><span class="p">,</span> <span class="k">out</span> <span class="n">currentIO</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°=</span><span class="p">{</span><span class="n">currentWorker</span><span class="p">}</span><span class="s"> completionPortThreads=</span><span class="p">{</span><span class="n">currentIO</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">maxWorker</span><span class="p">;</span> <span class="kt">int</span> <span class="n">maxIO</span><span class="p">;</span>
<span class="n">ThreadPool</span><span class="p">.</span><span class="nf">GetMinThreads</span><span class="p">(</span><span class="k">out</span> <span class="n">maxWorker</span><span class="p">,</span> <span class="k">out</span> <span class="n">maxIO</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"çº¿ç¨‹æ± æœ€å°çº¿ç¨‹æ•°=</span><span class="p">{</span><span class="n">maxWorker</span><span class="p">}</span><span class="s"> completionPortThreads=</span><span class="p">{</span><span class="n">maxIO</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="c1">// å®‰å…¨è®¾ç½®æœ€å°çº¿ç¨‹æ•°ï¼Œä¸è¶…è¿‡æœ€å¤§å€¼</span>
<span class="kt">int</span> <span class="n">desiredWorker</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Min</span><span class="p">(</span><span class="m">50</span><span class="p">,</span> <span class="n">maxWorker</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">desiredIO</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Min</span><span class="p">(</span><span class="m">50</span><span class="p">,</span> <span class="n">maxIO</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(!</span><span class="n">ThreadPool</span><span class="p">.</span><span class="nf">SetMinThreads</span><span class="p">(</span><span class="n">desiredWorker</span><span class="p">,</span> <span class="n">desiredIO</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// å¤„ç†å¤±è´¥æƒ…å†µ</span>
<span class="p">}</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
</code></pre></div></div>

<h4 id="çº¿ç¨‹æ± è°ƒåº¦">çº¿ç¨‹æ± è°ƒåº¦</h4>

<p>â€ƒâ€ƒ<strong>çº¿ç¨‹æ± ä½¿ç”¨çš„ä¸€äº›æ³¨æ„äº‹é¡¹ï¼š</strong></p>
<ol>
  <li>SetMaxThreads()è®¾ç½®çš„æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°æˆ–I/Oçº¿ç¨‹æ•°ï¼Œä¸èƒ½å°äºSetMinThreads()è®¾ç½®çš„æœ€å°å·¥ä½œçº¿ç¨‹æ•°æˆ–I/Oçº¿ç¨‹æ•°ã€‚</li>
  <li>SetMaxThreads()è®¾ç½®çš„å·¥ä½œçº¿ç¨‹æˆ–I/Oå®Œæˆçº¿ç¨‹æ•°ç›®ä¸èƒ½è®¾ç½®ä¸ºå°äºè®¡ç®—æœºä¸Šçš„å¤„ç†å™¨æ•°ã€‚</li>
  <li>å¦‚æœå°†çº¿ç¨‹æ± æœ€å°æ•°è®¾ç½®å¾—è¿‡å¤§(SetMinThreads())ï¼Œä¼šå¯¼è‡´ä»»åŠ¡åˆ‡æ¢å¼€é”€å˜å¤§ï¼Œæ¶ˆè€—æ›´å¤šå¾—æ€§èƒ½èµ„æºã€‚</li>
  <li>å¦‚æœåŠ å…¥çš„ä»»åŠ¡å¤§äºè®¾ç½®çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå°†ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚</li>
</ol>

<p>â€ƒâ€ƒçº¿ç¨‹æ± è°ƒåº¦ç®—æ³•<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">5</a></sup>ï¼Œè¿™ä¸ªæœç´¢äº†Googleå’ŒAIï¼š</p>

<div class="premonition info"> <div class="header"> <svg class="icon info" aria-hidden="true"> <use xlink:href="#icon-info"></use> </svg> <div class="title"> çº¿ç¨‹è°ƒåº¦ </div> </div> <div class="content"> <p>å¦‚æœçº¿ç¨‹æ•°è®¾ç½®è¿‡å°ï¼Œé‚£ä¹ˆä»»åŠ¡å¾ˆå¤šæ—¶ï¼Œé˜Ÿåˆ—ä¼šæœ‰å¤§é‡ä»»åŠ¡éœ€è¦ç­‰å¾…ï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´æˆ‘ä»¬è¦æ‰§è¡Œçš„ä»»åŠ¡ä¸èƒ½é©¬ä¸Šå®Œæˆï¼Œå¾ˆå¤šè¦æ‰§è¡Œçš„å‡½æ•°é˜»å¡ç­‰å¾…ã€‚
c#çº¿ç¨‹æ± è°ƒåº¦ç®—æ³•æœ‰å·¥ä½œçªƒå–æ³•æ¼”è¿›åˆ°çˆ¬å±±ç®—æ³•ã€‚</p>



 </div> </div>
<h2 id="çº¿ç¨‹ç»ˆæ­¢">çº¿ç¨‹ç»ˆæ­¢</h2>

<p>â€ƒâ€ƒç»ˆæ­¢çº¿ç¨‹æ–¹å¼åŒ…æ‹¬ï¼šä»»åŠ¡å®Œæˆè‡ªåŠ¨ç»ˆæ­¢ã€å¼‚å¸¸ç»ˆæ­¢ã€è¶…æ—¶ç»ˆæ­¢ã€æ‰‹åŠ¨ç»ˆæ­¢()ã€‚ä¸»è¦æ³¨æ„çš„æ‰‹åŠ¨ç»ˆæ­¢æ–¹å¼æ–¹æ³•ã€‚çœ‹äº†å¥½å‡ æœ¬å…³äºçº¿ç¨‹çš„ä¹¦ç±éƒ½åœ¨å¼ºè°ƒä¸å¯è½»æ˜“è°ƒç”¨ç”¨Thread.Abort()ã€‚ç›´æ¥è°ƒç”¨Abortå¹¶ä¸èƒ½è¡¨æ˜è¯¥çº¿ç¨‹å°±åœæ­¢è¿è¡Œï¼Œæ ¹æ®<a href="../CSharp/CSharp_Thread_Pattern.html###çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ">çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸå›¾</a>å’Œçº¿ç¨‹çŠ¶æ€è½¬æ¢æšä¸¾ï¼Œå®ƒä»…ä»…æ˜¯å‘å‡ºäº†AbortRequestè¯·æ±‚CLRç»ˆæ­¢è¯¥çº¿ç¨‹ï¼Œè‡³äºç»ˆæ­¢æ—¶æœºå®Œå…¨ç”±CLRå†³å®šã€‚çº¿ç¨‹ç»ˆæ­¢åçŠ¶æ€ä¼šå˜ä¸ºAbortedï¼ŒCLRä¼šè‡ªåŠ¨å›æ”¶çº¿ç¨‹èµ„æºã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Thread</span> <span class="n">test</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">1000000</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">});</span>
<span class="n">test</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>

<span class="c1">// ç»ˆæ­¢çº¿ç¨‹åè·å–çŠ¶æ€</span>
<span class="n">test</span><span class="p">.</span><span class="nf">Abort</span><span class="p">();</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">$"çº¿ç¨‹æ˜¯å¦å­˜æ´»=</span><span class="p">{</span><span class="n">test</span><span class="p">.</span><span class="n">IsAlive</span><span class="p">}</span><span class="s">  çº¿ç¨‹çŠ¶æ€=</span><span class="p">{</span><span class="n">test</span><span class="p">.</span><span class="n">ThreadState</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

<span class="c1">// ç»ˆæ­¢çº¿ç¨‹åå¹¶è®©ä¸»çº¿ç¨‹ç­‰å¾…testçº¿ç¨‹å®Œæˆï¼Œè·å–çŠ¶æ€</span>
<span class="n">test</span><span class="p">.</span><span class="nf">Abort</span><span class="p">();</span>
<span class="n">test</span><span class="p">.</span><span class="nf">Join</span><span class="p">();</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">$"çº¿ç¨‹æ˜¯å¦å­˜æ´»=</span><span class="p">{</span><span class="n">test</span><span class="p">.</span><span class="n">IsAlive</span><span class="p">}</span><span class="s">  çº¿ç¨‹çŠ¶æ€=</span><span class="p">{</span><span class="n">test</span><span class="p">.</span><span class="n">ThreadState</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
</code></pre></div></div>

<h3 id="ä»¤ç‰Œæ–¹å¼ç»ˆæ­¢">ä»¤ç‰Œæ–¹å¼ç»ˆæ­¢</h3>

<p>â€ƒâ€ƒæ¨èä½¿ç”¨CancellationTokenSourceæ¥ç»ˆæ­¢çº¿ç¨‹ã€‚CancellationTokenSourceç±»æä¾›äº†ä¸€ä¸ªCancellationTokenå¯¹è±¡ï¼Œå¯ä»¥ç”¨äºå–æ¶ˆå¼‚æ­¥æ“ä½œã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CancellationTokenSource</span> <span class="n">cts</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">();</span>
<span class="n">Thread</span> <span class="n">test</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="p">((</span><span class="n">obj</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">CancellationToken</span> <span class="n">token</span> <span class="p">=</span> <span class="p">(</span><span class="n">CancellationToken</span><span class="p">)</span> <span class="n">obj</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">while</span> <span class="p">(!</span><span class="n">token</span><span class="p">.</span><span class="n">IsCancellationRequested</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
            <span class="n">token</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
<span class="n">test</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="n">cts</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
<span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
<span class="n">cts</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
<span class="n">test</span><span class="p">.</span><span class="nf">Join</span><span class="p">();</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"çº¿ç¨‹æ˜¯å¦å­˜æ´»=</span><span class="p">{</span><span class="n">test</span><span class="p">.</span><span class="n">IsAlive</span><span class="p">}</span><span class="s">  çº¿ç¨‹çŠ¶æ€=</span><span class="p">{</span><span class="n">test</span><span class="p">.</span><span class="n">ThreadState</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
</code></pre></div></div>

<p>â€ƒâ€ƒCancellationTokenSourceå‘å‡ºå–æ¶ˆä¿¡å·ï¼ŒCancellationToken.IsCancellationRequestedæ£€æŸ¥æ˜¯å¦è¯·æ±‚å–æ¶ˆï¼ŒCancellationToken.ThrowIfCancellationRequested()åœ¨å–æ¶ˆæ—¶æŠ›å‡ºå¼‚å¸¸åŒæ—¶IsCancellationRequestedè®¾ç½®ä¸ºtrueã€‚è¿™é‡Œtoken.ThrowIfCancellationRequested()æ˜¯å¦æŠ›å‡ºå¼‚å¸¸æ ¹æ®å®é™…éœ€æ±‚æ¥å†³å®šã€‚</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>å‚è€ƒä¹¦ç±ï¼šC#å¤šçº¿ç¨‹ç¼–ç¨‹å®æˆ˜ã€‚Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>å‚è€ƒä¹¦ç±ï¼šC#7.0æœ¬è´¨è®ºlockéƒ¨åˆ†ã€‚Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>å‚è€ƒä¹¦ç±ï¼šC#7.0æœ¬è´¨è®ºä¿¡å·é‡ã€‚Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>å‚è€ƒ<a href="https://learn.microsoft.com/zh-cn/dotnet/navigate/advanced-programming/">å¾®è½¯æ–‡æ¡£</a>ã€‚Â <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p>å‚è€ƒä¹¦ç±ï¼šC#5.0æœ¬è´¨è®ºçº¿ç¨‹è°ƒåº¦ç®—æ³•åŸç†ã€‚Â <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name>ç¼–ç¨‹æ•£è®°</name></author><category term="CSharp" /><category term="Thread" /><summary type="html"><![CDATA[ç°ä»£åº”ç”¨ç¨‹åºå¯èƒ½è¦åŒæ—¶å¤„ç†æ•°æ®è®¡ç®—ã€ç”»é¢æ¸²æŸ“ã€æ–‡ä»¶è¯»å†™ç­‰æ“ä½œï¼ŒåŒæ—¶è¦æ±‚æ“ä½œç³»ç»Ÿè¦æ»¡è¶³è¿è¡Œå¤šä¸ªåº”ç”¨ç¨‹åºï¼Œåæ¥éšç€ç°ä»£CPUçš„ä»å•æ ¸è¿›åŒ–åˆ°å¤šæ ¸ï¼Œä»ç‰©ç†æ ¸å¿ƒè¿›åŒ–åˆ°é€»è¾‘æ ¸å¿ƒã€‚å°±é€æ¸æœ‰äº†å¤šä»»åŠ¡æ‰§è¡Œæ¦‚å¿µã€‚]]></summary></entry><entry><title type="html">Unity Addressable Systemä½¿ç”¨åˆ†æ(ä¸‰)</title><link href="https://www.damonc.top/unity3d/Unity_Addressable_Build.html" rel="alternate" type="text/html" title="Unity Addressable Systemä½¿ç”¨åˆ†æ(ä¸‰)" /><published>2024-07-15T20:00:00+00:00</published><updated>2024-07-15T20:00:00+00:00</updated><id>https://www.damonc.top/unity3d/Unity_Addressable_Build</id><content type="html" xml:base="https://www.damonc.top/unity3d/Unity_Addressable_Build.html"><![CDATA[<h2 id="addressableåˆå§‹åŒ–">Addressableåˆå§‹åŒ–</h2>

<p>â€ƒâ€ƒAAåˆå§‹åŒ–è°ƒç”¨å‡½æ•°<code class="language-plaintext highlighter-rouge">Addressables.InitializeAsync(autoReleaseHandle)</code>ï¼Œè¿”å›AsyncOperationHandleã€‚å‚æ•°autoReleaseHandleæ˜¯æ§åˆ¶Handleæ˜¯å¦è‡ªåŠ¨é‡Šæ”¾ï¼Œé»˜è®¤æ˜¯trueä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚è™½ç„¶æˆåŠŸæ‰§è¡Œäº†åˆå§‹åŒ–ï¼Œä½†æ˜¯æƒ³è¦æ‹¿åˆ°AsyncOperationHandleçš„ç»“æœå°±ä¸èƒ½è®©å®ƒè‡ªåŠ¨é‡Šæ”¾ï¼Œå¦‚æœè®¿é—®ä¼šæç¤ºhandleæ— æ•ˆã€‚</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AsyncOperationHandle</span><span class="p">&lt;</span><span class="n">IResourceLocator</span><span class="p">&gt;</span> <span class="n">handle</span> <span class="p">=</span> <span class="n">Addressables</span><span class="p">.</span><span class="nf">InitializeAsync</span><span class="p">();</span>
<span class="k">yield</span> <span class="k">return</span> <span class="n">handle</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">handle</span><span class="p">.</span><span class="n">Status</span> <span class="p">!=</span> <span class="n">AsyncOperationStatus</span><span class="p">.</span><span class="n">Succeeded</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"Initialization Error"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>â€ƒâ€ƒAAåˆå§‹åŒ–è¿”å›ç»“æœå°±æ˜¯æœ¬åœ°çš„Catalog.bundleå¯¹è±¡ï¼Œä½¿ç”¨DefaultBuildScriptæ‰“AssetBundleç»“æœä¼šä¿å­˜åœ¨<code class="language-plaintext highlighter-rouge">Library/com.unity.addressables/aa/å¹³å°/</code>ã€‚InitialåŠ è½½çš„å°±æ˜¯æœ¬åœ°æœ€æ–°çš„Catalogå¯¹è±¡ï¼Œå¦‚æœæ˜¯çœŸæœºå°±ä¼šåŠ è½½æ‰“åŒ…APKæ—¶æœ€åˆæ‰“è¿›åŒ…çš„Catalogå¯¹è±¡ã€‚</p>

<h3 id="catalogç»“æ„">Catalogç»“æ„</h3>

<p>â€ƒâ€ƒCatalogåŠ è½½åä¼šæ„å»ºæˆ<code class="language-plaintext highlighter-rouge">ResourceLocationMap</code>å¯¹è±¡ï¼Œè¯¥æ•°æ®å¯¹è±¡å°±æ˜¯è®°å½•äº†ä¸€ä¸ªBundleçš„æ‰€ä¿å­˜çš„åœ°å€ä¿¡æ¯(æœ¬åœ°è¿˜æ˜¯è¿œç¨‹)ã€‚åŠ è½½Catalogæµç¨‹ï¼š</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ç”¨æˆ·ä»£ç ä¸­è°ƒç”¨</span>
<span class="n">Addressables</span><span class="p">.</span><span class="nf">InitializeAsync</span><span class="p">();</span>

<span class="c1">// å†…éƒ¨å®é™…è°ƒç”¨</span>
<span class="n">AddressablesImpl</span><span class="p">.</span><span class="nf">InitializeAsync</span><span class="p">()</span> <span class="err">â†’</span> <span class="n">ResourceManager</span><span class="p">.</span><span class="nf">StartOperation</span><span class="p">()</span>

<span class="c1">// åœ¨ InitializeAsync å†…éƒ¨</span>
<span class="n">InitializationOperation</span> <span class="n">operation</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">InitializationOperation</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="k">return</span> <span class="n">ResourceManager</span><span class="p">.</span><span class="nf">StartOperation</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="k">default</span><span class="p">);</span>

<span class="c1">// InitializationOperation ä¸­</span>
<span class="c1">// 1. é¦–å…ˆåŠ è½½ä¸» Catalog æ–‡ä»¶</span>
<span class="nf">LoadContentCatalogInternal</span><span class="p">(</span><span class="n">m_ResourceLocators</span><span class="p">,</span> <span class="n">s_Settings</span><span class="p">.</span><span class="n">catalogLocation</span><span class="p">,</span> <span class="p">...);</span>

<span class="c1">// 2. ç„¶ååŠ è½½é¢å¤–çš„ Catalog æ–‡ä»¶ï¼ŒåŒ…æ‹¬è¿œç¨‹çš„catalog(å¦‚æœæœ‰é…ç½®)</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">catalogLocation</span> <span class="k">in</span> <span class="n">s_Settings</span><span class="p">.</span><span class="n">catalogLocations</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nf">LoadContentCatalogInternal</span><span class="p">(</span><span class="n">m_ResourceLocators</span><span class="p">,</span> <span class="n">catalogLocation</span><span class="p">,</span> <span class="p">...);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>â€ƒâ€ƒå½“ Catalog åŠ è½½å®Œæˆåï¼Œç³»ç»Ÿä¼šè§£æå…¶ä¸­çš„å†…å®¹å¹¶æ„å»º ResourceLocationMapï¼š</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åœ¨ContentCatalogProvider.cs ä¸­</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ContentCatalogProvider</span> <span class="p">:</span> <span class="n">IResourceProvider</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnCatalogLoaded</span><span class="p">(</span><span class="n">ContentCatalogData</span> <span class="n">catalogData</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// åˆ›å»º ResourceLocationMap</span>
        <span class="kt">var</span> <span class="n">locMap</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ResourceLocationMap</span><span class="p">(</span><span class="n">catalogData</span><span class="p">);</span>
        
        <span class="c1">// å¤„ç†å†…éƒ¨ ID æ˜ å°„</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">kvp</span> <span class="k">in</span> <span class="n">catalogData</span><span class="p">.</span><span class="n">InternalIds</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// å»ºç«‹ key -&gt; location[]çš„æ˜ å°„</span>
            <span class="kt">string</span> <span class="n">key</span> <span class="p">=</span> <span class="n">kvp</span><span class="p">.</span><span class="n">Key</span><span class="p">;</span>
            <span class="n">IList</span><span class="p">&lt;</span><span class="n">IResourceLocation</span><span class="p">&gt;</span> <span class="n">locations</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IResourceLocation</span><span class="p">&gt;();</span>
            
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">id</span> <span class="k">in</span> <span class="n">kvp</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// ä¸ºæ¯ä¸ªå†…éƒ¨IDåˆ›å»º ResourceLocation</span>
                <span class="kt">var</span> <span class="n">loc</span> <span class="p">=</span> <span class="nf">CreateLocationForCatalogEntry</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">catalogData</span><span class="p">);</span>
                <span class="n">locations</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">loc</span><span class="p">);</span>
            <span class="p">}</span>
            
            <span class="c1">// å°† locations æ·»åŠ åˆ° ResourceLocationMap ä¸­</span>
            <span class="n">locMap</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">locations</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="c1">// å…¶ä»–å¤„ç†...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">ResourceLocationMap</code>æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå­—å…¸ç»“æ„ï¼Œå®ƒå°†ç”¨æˆ·å¯è®¿é—®çš„é”®æ˜ å°„åˆ°å¯¹åº”çš„èµ„æºä½ç½®åˆ—è¡¨ï¼š</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ResourceLocationMap çš„ç®€åŒ–ç»“æ„</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ResourceLocationMap</span> <span class="p">:</span> <span class="n">IResourceLocator</span>
<span class="p">{</span>
    <span class="c1">// æ ¸å¿ƒæ•°æ®ç»“æ„ï¼šé”® -&gt; èµ„æºä½ç½®åˆ—è¡¨çš„æ˜ å°„</span>
    <span class="k">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">,</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">IResourceLocation</span><span class="p">&gt;&gt;</span> <span class="n">m_Locations</span><span class="p">;</span>
    
    <span class="k">public</span> <span class="nf">ResourceLocationMap</span><span class="p">(</span><span class="n">ContentCatalogData</span> <span class="n">catalogData</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_Locations</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">,</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">IResourceLocation</span><span class="p">&gt;&gt;();</span>
        <span class="c1">// åˆå§‹åŒ–å…¶ä»–å…ƒæ•°æ®...</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">object</span> <span class="n">key</span><span class="p">,</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">IResourceLocation</span><span class="p">&gt;</span> <span class="n">locations</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_Locations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">locations</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// IResourceLocator æ¥å£å®ç°</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Locate</span><span class="p">(</span><span class="kt">object</span> <span class="n">key</span><span class="p">,</span> <span class="n">Type</span> <span class="n">type</span><span class="p">,</span> <span class="k">out</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">IResourceLocation</span><span class="p">&gt;</span> <span class="n">locations</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">m_Locations</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">out</span> <span class="n">locations</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">// æ ¹æ®ç±»å‹ç­›é€‰ä½ç½®...</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">locations</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>â€ƒâ€ƒå½“æ‰€æœ‰ Catalog éƒ½å¤„ç†å®Œæˆåï¼ŒResourceLocationMap è¢«æ³¨å†Œåˆ° Addressables ç³»ç»Ÿï¼š</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åœ¨åˆå§‹åŒ–å®Œæˆæ—¶</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">locator</span> <span class="k">in</span> <span class="n">m_ResourceLocators</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// å°†æ„å»ºå¥½çš„ ResourceLocationMap æ³¨å†Œåˆ° ResourceManager</span>
    <span class="n">ResourceManager</span><span class="p">.</span><span class="nf">RegisterLocator</span><span class="p">(</span><span class="n">locator</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="åŠ è½½è¿œç¨‹catalog">åŠ è½½è¿œç¨‹Catalog</h2>

<p>â€ƒâ€ƒæ¯æ¬¡ä¿®æ”¹æ–‡ä»¶æ‰“åŒ…AssetBundleåCatalogæ˜¯æœ‰å·®å¼‚çš„ï¼Œä¸ºäº†å¾—åˆ°æœ€æ–°AssetBundleå°±è¦å…ˆä¸‹è½½åˆ°æœ€æ–°çš„Catalogæ–‡ä»¶ç„¶åä¿å­˜åœ¨æœ¬åœ°Documentç›®å½•ã€‚AAä¹Ÿæä¾›åŠ è½½æŒ‡å®šåœ°å€çš„Catalogï¼Œå¯ä»¥æ˜¯file:///ï¼Œä¹Ÿå¯ä»¥æ˜¯http(s)ã€‚</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// remoteUrl -&gt; http://localhost:8000/</span>
<span class="n">AsyncOperationHandle</span><span class="p">&lt;</span><span class="n">IResourceLocator</span><span class="p">&gt;</span> <span class="n">remoteHandle</span> <span class="p">=</span> <span class="n">Addressables</span><span class="p">.</span><span class="nf">LoadContentCatalogAsync</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">remoteUrl</span><span class="p">}</span><span class="s">catalog.bundle"</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
<span class="k">yield</span> <span class="k">return</span> <span class="n">remoteHandle</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">remoteHandle</span><span class="p">.</span><span class="n">Status</span> <span class="p">!=</span> <span class="n">AsyncOperationStatus</span><span class="p">.</span><span class="n">Succeeded</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"InitRemoteLocation Error"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>â€ƒâ€ƒæœ¬åœ°æ¨¡æ‹ŸServerï¼ŒæŠŠ<code class="language-plaintext highlighter-rouge">Library/com.unity.addressables/aa/å¹³å°/</code>ä¸‹é¢çš„Assetbundleå’Œcatalogå¤åˆ¶åˆ°ä¸€ä¸ªç›®å½•ï¼Œåœ¨è¯¥ç›®å½•æ‰“å¼€cmdï¼Œè¾“å…¥python -m http.server 8000ä¼šæ¨¡æ‹Ÿä¸€ä¸ªæ–‡ä»¶æœåŠ¡å™¨ã€‚
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
--></p>
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/simulator_server.png" width="250" /><font size="2.5">
            <i>æ¨¡æ‹Ÿæ–‡ä»¶æœåŠ¡å™¨.</i>
        </font></center>
<p>â€ƒâ€ƒä¸‹è½½å¥½ä¹‹åå°±èƒ½è·å–åˆ°è¿œç¨‹<code class="language-plaintext highlighter-rouge">ResourceLocationMap</code>ã€‚ç°åœ¨æœ‰äº†æœ¬åœ°å’Œè¿œç¨‹Locationä¿¡æ¯ï¼Œé€šè¿‡å¯¹æ¯”å°±èƒ½çŸ¥é“æœ‰å“ªäº›AssetBundleäº§ç”Ÿå˜åŒ–ã€‚</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ç¼“å­˜AssetBundle Location</span>
<span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">_missingBundle</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;();</span>
<span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">_localBundle</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;();</span>

<span class="k">private</span> <span class="n">IEnumerator</span> <span class="nf">CheckRemoteLocation</span><span class="p">(</span><span class="n">IResourceLocator</span> <span class="n">local</span><span class="p">,</span> <span class="n">IResourceLocator</span> <span class="n">remote</span><span class="p">)</span>
<span class="p">{</span> 
    <span class="c1">// æ£€æŸ¥æœ¬åœ°èµ„æºåœ¨è¿œç¨‹æ˜¯å¦å­˜åœ¨</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">string</span> <span class="n">key</span> <span class="k">in</span> <span class="n">remote</span><span class="p">.</span><span class="n">Keys</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// é»˜è®¤æ‰“åŒ…çš„AssetBundleæ–‡ä»¶åç¼€å¸¦äº†.bundleï¼Œå¦‚æœä¿®æ”¹AAä»£ç å°±ç”¨è‡ªå®šä¹‰</span>
        <span class="c1">// ä¸€å®šè¦å¢åŠ ä¸€ä¸ªæ ‡è®°ï¼Œå¦åˆ™å°±ä¸èƒ½åŒºåˆ«bundleåå’Œå…¶ä»–ä¿¡æ¯çš„æè¿°å</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">key</span><span class="p">.</span><span class="nf">EndsWith</span><span class="p">(</span><span class="s">".bundle"</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Type</span> <span class="n">iAbType</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IAssetBundleResource</span><span class="p">);</span>
        <span class="c1">// Locateå®šä½remoteKeyæ˜¯å¦åœ¨localå†…ï¼Œè‹¥æœ‰è¡¨ç¤ºè¯¥ABæ–‡ä»¶æ²¡æœ‰å·®å¼‚ä¸ç”¨æ›´æ–°</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">local</span><span class="p">.</span><span class="nf">Locate</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iAbType</span><span class="p">,</span> <span class="k">out</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">IResourceLocation</span><span class="p">&gt;</span> <span class="n">localLocations</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">// remoteKeyä¸åœ¨localå†…ï¼Œè¯¥ABæœ‰å·®å¼‚æ˜¯æœ€æ–°çš„éœ€è¦æ›´æ–°ä¸‹è½½</span>
            <span class="n">remote</span><span class="p">.</span><span class="nf">Locate</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iAbType</span><span class="p">,</span> <span class="k">out</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">IResourceLocation</span><span class="p">&gt;</span> <span class="n">remoteLocations</span><span class="p">);</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">remoteLoc</span> <span class="k">in</span> <span class="n">remoteLocations</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_missingBundle</span><span class="p">[</span><span class="n">remoteLoc</span><span class="p">.</span><span class="n">PrimaryKey</span><span class="p">]</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="n">IResourceLocation</span> <span class="n">location</span> <span class="k">in</span> <span class="n">localLocations</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_localBundle</span><span class="p">[</span><span class="n">location</span><span class="p">.</span><span class="n">PrimaryKey</span><span class="p">]</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="æ›´æ–°assetbundle">æ›´æ–°AssetBundle</h3>

<p>â€ƒâ€ƒç°åœ¨æ‹¿åˆ°äº†<code class="language-plaintext highlighter-rouge">_missingBundle</code>å’Œ<code class="language-plaintext highlighter-rouge">_localBundle</code>ï¼Œç°åœ¨å°±è¦æ›´æ–°AssetBundleã€‚æ›´æ–°AssetBundleå°±è¦è·å–å®ƒçš„æœ€æ–°åœ°å€ï¼Œé‚£ä¹ˆAAä¹Ÿæä¾›äº†ä¸€ä¸ªå›è°ƒæ¥å£<code class="language-plaintext highlighter-rouge">Addressables.InternalIdTransformFunc</code>ï¼Œåªè¦æ³¨å†Œäº†è¯¥å›è°ƒï¼Œä»»ä½•åŠ è½½åŠ¨ä½œéƒ½ä¼šè¿›å…¥åˆ°è¯¥å›è°ƒï¼Œå°±å¯ä»¥åœ¨å›è°ƒé‡Œé¢è¿›è¡Œå¤„ç†ã€‚</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Addressables</span><span class="p">.</span><span class="n">InternalIdTransformFunc</span> <span class="p">=</span> <span class="n">InternalIdTransformFunc</span><span class="p">;</span>

<span class="kt">string</span> <span class="nf">InternalIdTransformFunc</span><span class="p">(</span><span class="n">IResourceLocation</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_missingBundle</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">PrimaryKey</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s">$"</span><span class="p">{</span><span class="n">remoteUrl</span><span class="p">}{</span><span class="n">arg</span><span class="p">.</span><span class="n">PrimaryKey</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_localBundle</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">PrimaryKey</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">arg</span><span class="p">.</span><span class="n">InternalId</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">arg</span><span class="p">.</span><span class="n">InternalId</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>â€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">IResourceLocation</code>æœ‰ä¸‰ä¸ªå…³é”®ä¿¡æ¯ï¼š<code class="language-plaintext highlighter-rouge">PrimaryKey</code>ã€<code class="language-plaintext highlighter-rouge">InternalId</code>ã€<code class="language-plaintext highlighter-rouge">ResourceType</code></p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// èµ„æºåŠ è½½åçš„ä¸»è¦æ ‡è¯†ç¬¦</span>
<span class="k">public</span> <span class="kt">object</span> <span class="n">PrimaryKey</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

<span class="c1">// èµ„æºåŠ è½½åœ°å€</span>
<span class="k">public</span> <span class="kt">string</span> <span class="n">InternalId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

<span class="c1">// èµ„æºåŠ è½½ç±»å‹ï¼Œé‡ç‚¹å¤„ç†IAssetBundleResourceã€catalogç±»å‹</span>
<span class="k">public</span> <span class="n">Type</span> <span class="n">ResourceType</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>å…ˆå¤„ç†å¦‚ä½•ä¸‹è½½ã€åŠ è½½æœ€æ–°çš„catalog
â€ƒâ€ƒä¸ç®¡æ˜¯Initialæœ¬åœ°Catalogè¿˜æ˜¯Loadè¿œç¨‹Catalogï¼Œåªè¦æ³¨å†Œ<code class="language-plaintext highlighter-rouge">InternalIdTransformFunc</code>å°±å¯ä»¥åœ¨å‡½æ•°å†…å¤„ç†ï¼š
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">string</span> <span class="nf">InternalIdTransformFunc</span><span class="p">(</span><span class="n">IResourceLocation</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
 <span class="c1">// å¦‚æœargResourceTypeæ˜¯catalogç±»å‹</span>
     <span class="c1">// åˆ¤å®šæœ¬åœ°ç¼“å­˜ç›®å½•æ˜¯å¦æœ‰Catalog.bundleï¼Œè®¡ç®—bundleçš„hashæ˜¯å¦ä¸catalog.hashä¸€è‡´</span>
         <span class="c1">// å¦‚æœä¸€è‡´å°±åŠ è½½ï¼Œç›´æ¥è¿”å›$"{ç¼“å­˜ç›®å½•}/Catalog.bundle"</span>
         <span class="c1">// å¦‚æœæ²¡æœ‰Catalog.bundleå°±ç”¨åŒ…ä½“å†…çš„Catalogç›´æ¥è¿”å›arg.InternalId</span>

 <span class="c1">// å¦‚æœargResourceTypeæ˜¯IAssetBundleResourceç±»å‹</span>
     <span class="c1">// åˆ¤å®šç¼“å­˜ç›®å½•æœ‰è¯¥æ–‡ä»¶</span>
     <span class="c1">// æœ‰ï¼Œç›´æ¥è¿”å›$"{ç¼“å­˜ç›®å½•}/xxx.bundle"</span>
     <span class="c1">// æ²¡æœ‰ï¼Œç›´æ¥è¿”å›$"{remoteUrl}/xxx.bundle"å»ä¸‹è½½</span>
 <span class="c1">// åªè¦èƒ½ç¡®ä¿Catalogæ˜¯æœ€æ–°ï¼Œä¸‹è½½çš„AssetBundleæ–‡ä»¶æ˜¯ä¸€å®šæ˜¯æœ€æ–°çš„</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="å¤æ‚çš„æ›´æ–°ç­–ç•¥">å¤æ‚çš„æ›´æ–°ç­–ç•¥</h2>
<p>â€ƒâ€ƒä¸Šé¢æˆ‘æ˜¯æ¼”ç¤ºç”¨äº†ä¸€ç§æœ€ç®€å•çš„æ›´æ–°ç­–ç•¥ï¼Œè‚¯å®šæ˜¯ä¸èƒ½æ»¡è¶³å¤æ‚éœ€æ±‚çš„ã€‚å¦‚æœè®¾å®šGroupæ‰“åŒ…ä½¿ç”¨hash of file nameï¼Œä¹Ÿå°±æ˜¯ç¡®ä¿æ„å»ºæ—¶æ¯ä¸ªAssetBundleåä¸å˜ï¼Œæ–‡ä»¶å†…å®¹hashä¼šå‘ç”Ÿäº†å˜åŒ–ã€‚é‚£ä¹ˆå°±è¦ç»´æŠ¤ä¸€ä»½bundleåæ˜ å°„hashè¡¨ï¼Œä¸€ä¸ªæœ¬åœ°ä¸€ä¸ªè¿œç¨‹ï¼Œæ¯æ¬¡å¯åŠ¨å°±è¦æ£€æŸ¥ä¸¤å¼ è¡¨æ˜¯å¦ä¸€è‡´ã€æ˜¯å¦æœ‰å˜åŒ–ï¼ŒåŒæ—¶æ£€æŸ¥ç¼“å­˜çš„æœ€æ–°æ–‡ä»¶æœ‰æ²¡æœ‰ä¸¢å¤±ã€‚å½“ç„¶ä¹Ÿè¿˜æœ‰å…¶ä»–çš„ç­–ç•¥å°±ä¸è®¨è®ºäº†ã€‚</p>

<h2 id="è¸©å‘">è¸©å‘</h2>
<p>â€ƒâ€ƒ1. ä¸èƒ½åŒæ—¶å­˜åœ¨å¤šä¸ªCatalogå¯¹è±¡ï¼Œå°±æ˜¯InstantiateAsyncäº†æœ¬åœ°Catalogåè·å–äº†Resultåæœ€å¥½æ˜¯ç«‹å³é‡Šæ”¾æ‰</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">localLocator</span> <span class="p">=</span> <span class="n">localHandle</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
<span class="n">Addressables</span><span class="p">.</span><span class="nf">Release</span><span class="p">(</span><span class="n">localHandle</span><span class="p">);</span>
<span class="n">Addressables</span><span class="p">.</span><span class="nf">RemoveResourceLocator</span><span class="p">(</span><span class="n">localLocator</span><span class="p">);</span>
</code></pre></div></div>
<p>â€ƒâ€ƒ2. <code class="language-plaintext highlighter-rouge">Addressables.ClearResourceLocators()</code>ä¸èƒ½éšä¾¿è°ƒç”¨ï¼Œä¼šä¸¢å¼ƒæ‰€æœ‰Catalogå¯¹è±¡ã€‚</p>

<p>â€ƒâ€ƒ3. æ¸¸æˆé‡å¯ï¼Œå¦‚æœæ˜¯åœ¨æ¸¸æˆå†…é‡å¯å°±ä¸èƒ½å†æ¬¡åˆå§‹åŒ–<code class="language-plaintext highlighter-rouge">InstantiateAsync</code>äº†ï¼Œå†…éƒ¨æ ‡è®°äº†<code class="language-plaintext highlighter-rouge">hasStartedInitialization</code>ã€‚</p>]]></content><author><name>ç¼–ç¨‹æ•£è®°</name></author><category term="Unity3d" /><category term="Addressable System" /><summary type="html"><![CDATA[ä½¿ç”¨Unity Addressable Systemè¿›è¡Œçƒ­æ›´ã€åŠ è½½ABåŒ…ï¼Œæœ¬æ–‡Addressableåç»­ç®€ç§°AAã€‚]]></summary></entry><entry><title type="html">Unity Addressable Systemä½¿ç”¨åˆ†æ(äºŒ)</title><link href="https://www.damonc.top/unity3d/Unity_Addressabel_Group.html" rel="alternate" type="text/html" title="Unity Addressable Systemä½¿ç”¨åˆ†æ(äºŒ)" /><published>2024-07-12T20:00:00+00:00</published><updated>2024-07-12T20:00:00+00:00</updated><id>https://www.damonc.top/unity3d/Unity_Addressabel_Group</id><content type="html" xml:base="https://www.damonc.top/unity3d/Unity_Addressabel_Group.html"><![CDATA[<h2 id="æ„å»ºå‰ç½®å‡†å¤‡">æ„å»ºå‰ç½®å‡†å¤‡</h2>

<p>â€ƒâ€ƒAAæ‰“åŒ…æä¾›äº†è‡ªå¸¦è„šæœ¬<strong><em>BuildScriptPackedMode</em></strong>æ‰“åŒ…å…¥å£æœ‰ä¸¤ä¸ªï¼š</p>
<ol>
  <li>ä¸å¸¦æ‰“åŒ…ç»“æœè¿”å›ï¼šAddressableAssetSettings.BuildPlayerContent();</li>
  <li>å¸¦æ‰“åŒ…ç»“æœçš„æ¥å£ï¼šAddressableAssetSettings.BuildPlayerContent(<code class="language-plaintext highlighter-rouge">out AddressablesPlayerBuildResult rst</code>);</li>
</ol>

<h3 id="å¼€å§‹æ„å»º">å¼€å§‹æ„å»º</h3>

<p>â€ƒâ€ƒAddressablesPlayerBuildResultä¸»è¦è®°å½•äº†æ‰“åŒ…æˆåŠŸåè·å–åˆ°bundleåˆ—è¡¨ä¿¡æ¯ï¼Œæ¯ä»½bundleéƒ½æœ‰ç”Ÿæˆï¼Œç±»ä¼¼äºä»¥å‰çš„AssetBundle Menifestç»“æ„ã€‚è¿™ä¸ªç»“æœå¯ä»¥åºåˆ—åŒ–ä¿å­˜åœ¨æœ¬åœ°ï¼Œæ–¹ä¾¿æŸ¥çœ‹è°ƒè¯•å„èµ„æºä¹‹é—´ä¾èµ–æƒ…å†µã€‚</p>

<div class="premonition note"> <div class="header"> <svg class="icon note" aria-hidden="true"> <use xlink:href="#icon-note"></use> </svg> <div class="title"> AddressablesPlayerBuildResultç»“æ„ </div> </div> <div class="content"> 
<pre><code class="language-CSHARP">//bundleæ„å»ºåçš„ä¿¡æ¯
class BundleBuildResult{
 public string FilePath;
 public string InternalBundleName;
 public AddressableAssetGroup SourceAssetGroup;
 public uint Crc;
 public string Hash;
}
public List&lt;BundleBuildResult&gt; AssetBundleBuildResults =&gt; m_AssetBundleBuildResults;
//catalog hashçš„è·¯å¾„
public string RemoteCatalogHashFilePath { get; internal set; }
//catalog jsonçš„è·¯å¾„
public string RemoteCatalogJsonFilePath { get; internal set; }
//content stateçš„è·¯å¾„
public string ContentStateFilePath { get; internal set; }
</code></pre>



 </div> </div>
<p>â€ƒâ€ƒè¿›å…¥åˆ°<strong><em>BuildPlayerContent</em></strong>å‡½æ•°ï¼Œæœ€ä¸»è¦å·¥ä½œä¹‹ä¸€æ˜¯å¯¹æ‰€æœ‰Groupå†…çš„æ‰€æœ‰Entryèµ„æºåœ¨æ‰“åŒ…ä¹‹å‰æŠŠ<code class="language-plaintext highlighter-rouge">BundleFileId</code>ç½®ç©ºï¼Œè¿™ä¸ªå­—æ®µåœ¨ç¼–è¾‘å™¨æ‰“åŒ…æ—¶æœ‰ç”¨åˆ°ã€‚è¯¥å˜é‡å€¼åœ¨æ‰“åŒ…æ—¶å¤šæ¬¡ä½¿ç”¨ï¼Œéå¸¸é‡è¦ï¼
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
--></p>
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/bundle_field_id.png" width="250" /><font size="2.5">
            <i>Debugæ¨¡å¼æŸ¥çœ‹åˆ°BundleFileId.</i>
        </font></center>
<p>â€ƒâ€ƒè¿›å…¥åˆ°<strong><em>BuildPlayerContentImpl</em></strong>å‡½æ•°ï¼Œä¸»è¦åšäº†ä¸‰å—å·¥ä½œã€‚</p>
<ol>
  <li>æ£€æŸ¥Addressables BuildPathç›®å½•ï¼Œå­˜åœ¨å°±æ¸…ç©ºè¯¥ç›®å½•ã€‚<code class="language-plaintext highlighter-rouge">BuildPath</code>å°±æ˜¯æ„å»ºbundleçš„å­˜æ”¾ç›®å½•ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">æ¸…ç©ºè¯¥ç›®å½•</code>çš„æ“ä½œã€‚</li>
  <li>å®ä¾‹åŒ–<code class="language-plaintext highlighter-rouge">AddressablesDataBuilderInput</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å†…éƒ¨åˆå§‹åŒ–ï¼šæŒ‡å®šæ„å»ºå¹³å°ã€æ„å»ºç‰ˆæœ¬å·ã€FileRegistryå®¹å™¨ã€PreviousContentStateç½®ç©ºã€‚</li>
  <li>ä½¿ç”¨æŒ‡å®šçš„<code class="language-plaintext highlighter-rouge">ActivePlayerDataBuilder</code>æ„å»ºå¯¹è±¡å¼€å§‹æ„å»ºbundleã€‚</li>
</ol>

<div class="premonition note"> <div class="header"> <svg class="icon note" aria-hidden="true"> <use xlink:href="#icon-note"></use> </svg> <div class="title"> æ¸…ç©ºç›®å½•å¦‚ä½•åšåˆ°å¢é‡æ‰“åŒ…ï¼Ÿ </div> </div> <div class="content"> <p>â€ƒâ€ƒå¯¹äºä¹‹å‰ä½¿ç”¨<strong><em>BuildPipeline.BuildAssetBundles</em></strong>æ¥å£æ‰“åŒ…ï¼Œé»˜è®¤è‡ªå¸¦å¢é‡æ‰“åŒ…å‚æ•°ï¼Œé™¤éä½¿ç”¨ForceRebuildAssetBundleå‚æ•°æŒ‡å®šã€‚</p>

<p>â€ƒâ€ƒä»¥å‰çš„å¢é‡æ‰“åŒ…çš„æ‰€éœ€æ¡ä»¶ï¼š</p>

<p>â€ƒâ€ƒ<strong>(1)</strong>èµ„æºæ²¡å˜åŒ–ä¸”ç”Ÿæˆç›®å½•ä¸‹çš„bundleåŒ…å’Œå¯¹åº”manifestå­˜åœ¨ï¼Œä¸ä¼šé‡æ–°æ‰“åŒ…ï¼›</p>

<p>â€ƒâ€ƒ<strong>(2)</strong>èµ„æºæ²¡å˜åŒ–å³ä½¿ç”Ÿæˆç›®å½•ä¸‹çš„bundleåŒ…è¢«åˆ é™¤äº†ï¼Œä¸ä¼šé‡æ–°æ‰“åŒ…ï¼›</p>

<p>â€ƒâ€ƒ<strong>(3)</strong>åªè¦ç”Ÿæˆç›®å½•ä¸‹çš„bundleåŒ…å¯¹åº”çš„manifaseè¢«åˆ é™¤äº†ï¼Œä¼šé‡æ–°æ‰“åŒ…ï¼›</p>

<p>â€ƒâ€ƒè€Œç°åœ¨å³ä½¿åˆ é™¤äº†Bundleå­˜æ”¾ç›®å½•ï¼Œå¯¹äºå¢é‡æ‰“åŒ…çš„ä½¿ç”¨addressables_content_stateæ–‡ä»¶å’ŒBuildCacheä¿¡æ¯ç»„åˆåˆ¤æ–­ã€‚</p>



 </div> </div>
<p>â€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">ActivePlayerDataBuilder</code>åˆ†æï¼šè¯¥å¯¹è±¡ä¸€å®šè¦ç»§æ‰¿è‡ªBuildScriptBaseã€‚ä¸€å®šè¦æ”¾åœ¨Data Buildersåˆ—è¡¨ã€‚ä¸€å®šè¦ç»™ActivePlayerDataBuilderIndexèµ‹å€¼ï¼Œæˆ–è€…åœ¨Settingsçš„Data Buildersåˆ—è¡¨æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œè¯»å–ActivePlayerDataBuilderIndexä¼˜å…ˆçº§æ˜¯é«˜äºåˆ—è¡¨é¡ºåºã€‚
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
--></p>
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/build_play_scripts.png" width="250" /><font size="2.5">
            <i>Data Buildersåˆ—è¡¨å°±æ˜¯è¿™ä¸ªScriptsåˆ—è¡¨.</i>
        </font></center>

<p>â€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">FileRegistry</code>åˆ†æï¼šæ–‡ä»¶æ³¨å†Œè¡¨çš„ä½œç”¨åœ¨æ„å»ºBundleæœŸé—´ä¿å­˜åˆ›å»ºBundleæ—¶çš„å­˜æ”¾è·¯å¾„(å¸¦hashä¿¡æ¯)ï¼Œç„¶ååœ¨Bundleæ„å»ºçš„åå¤„ç†ä½¿ç”¨ReplaceBundleEntryï¼Œä½¿ç”¨æ— hashçš„è·¯å¾„æ›¿æ¢å¸¦hashè·¯å¾„ã€‚æš‚æ—¶ä¸é‡è¦ã€‚</p>

<p>â€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">AddressablesContentState</code>ç»“æ„ä¸<code class="language-plaintext highlighter-rouge">BundleFileId</code>åˆ†æï¼šAddressablesContentStateä¿å­˜äº†å½“æ¬¡æ„å»ºæ—¶æ‰€æœ‰çš„Assetç¼“å­˜ä¿¡æ¯å’ŒBundleä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨ä¸‹æ¬¡æ„å»ºbundleæ—¶è¯»å–è¿™äº›ç¼“å­˜ä¿¡æ¯ã€‚BundleFileIdå°±åŒ…å«åœ¨è¿™äº›ç¼“å­˜ä¿¡æ¯å†…ã€‚</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">AddressablesContentState</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">playerVersion</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">editorVersion</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">CachedAssetState</span><span class="p">[]</span> <span class="n">cachedInfos</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">remoteCatalogLoadPath</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">CachedBundleState</span><span class="p">[]</span> <span class="n">cachedBundles</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">CachedAssetState</span> <span class="p">:</span> <span class="n">IEquatable</span><span class="p">&lt;</span><span class="n">CachedAssetState</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">AssetState</span> <span class="n">asset</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">AssetState</span><span class="p">[]</span> <span class="n">dependencies</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">groupGuid</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">bundleFileId</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">object</span> <span class="n">data</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">CachedAssetState</span> <span class="n">other</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">CachedBundleState</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">bundleFileId</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">object</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="åˆå§‹åŒ–icontextobject">åˆå§‹åŒ–IContextObject</h3>

<p>â€ƒâ€ƒè¿›å…¥<strong><em>BuildDataImplementation</em></strong>å†…ï¼Œä¼šç»§ç»­åˆå§‹åŒ–ä¸€äº›æ•°æ®ï¼šè°ƒç”¨åœºæ™¯ä¿å­˜(ä½¿ç”¨SBPç®¡çº¿æ„å»ºBundleå‰ä¸€å®šè¦ä¿å­˜åœºæ™¯)ã€åˆå§‹åŒ–AddressableAssetsBuildContextå¯¹è±¡ã€å¤„ç†æ‰€æœ‰Groupå¯¹è±¡ã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªé‡è¦çš„æ•°æ®ç»“æ„ï¼š</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">ResourceManagerRuntimeData</code>ï¼šç”¨äºåˆå§‹åŒ–AAçš„è¿è¡Œæ—¶æ•°æ®ï¼ŒåŒ…å«è®¸å¤šAAè®¾ç½®æ—¶çš„å‚æ•°ï¼Œæ¯æ¬¡æ„å»ºéƒ½ä¼šé‡æ–°ç”Ÿæˆã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">AddressableAssetsBuildContext</code>ï¼šç”¨äºæ„å»ºè¿‡ç¨‹ä¸­æ•°æ®ä¼ é€’ï¼Œåœ¨åé¢çš„Taskæµçš„ä¼šå¤šæ¬¡ç”¨åˆ°IContextObjectæˆ–IAddressableAssetsBuildContextæ¥å£æ•°æ®ã€‚</li>
</ol>

<p><span id="jump1"></span></p>

<h3 id="å¤„ç†group">å¤„ç†Group</h3>

<p>â€ƒâ€ƒå¯¹æ¯ä¸ªGroupçš„Schemaè¿›è¡Œé¢„å¤„ç†ï¼Œå¯¹Groupå†…æ‰€æœ‰AssetEntryç”Ÿæˆä¸€ä»½<code class="language-plaintext highlighter-rouge">ContentCatalogDataEntry</code>è¿è¡Œæ—¶å¯»å€æ•°æ®ä¿¡æ¯ã€‚</p>

<p>â€ƒâ€ƒ<strong>(1)PlayerDataGroupSchema</strong>åˆ†åˆ«æœ‰åœºæ™¯å†…çš„èµ„æºå’ŒResourceç›®å½•å†…çš„èµ„æºã€‚æŠŠè¯¥Schemaå†…æ‰€æœ‰çš„AssetEntryæ‰§è¡ŒGatherAllAssetsï¼šæ”¶é›†è¯¥Schemaå†…æ‰€æœ‰èµ„æº(åŒ…æ‹¬subAssetã€spriteç²¾çµ)è£…å…¥AddressableAssetEntryæ”¶é›†åˆ—è¡¨ã€‚éå†æ”¶é›†åˆ—è¡¨æ‰§è¡ŒCreateCatalogEntriesåˆ›å»º<code class="language-plaintext highlighter-rouge">ContentCatalogDataEntry</code>æ•°æ®(IResourceLocationå¯»å€æ•°æ®ï¼Œåœ¨è¿è¡Œæ—¶åˆå§‹åŒ–AAå’ŒåŠ è½½Catalogè¿™ä¸€æ•°æ®éå¸¸é‡è¦)ã€‚</p>

<p>â€ƒâ€ƒ<strong>(2)BundledAssetGroupSchema</strong>æ„å»ºbundleé…ç½®å’ŒåŒ…å«åœ¨Entriesåˆ—è¡¨é‡Œçš„èµ„æºï¼Œæ ¹æ®BundlePackingModeç”Ÿæˆé¢„å®šä¹‰Bundleåï¼Œä¸‰è€…çš„åŒºåˆ«æ˜¯å¯»å€è·¯å¾„å‚æ•°ä¸ä¸€æ ·ï¼Œ<strong>Bundleå‘½åæ ¼å¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">groupGuid + _assets_ + address + .bundle</code>ã€‚é‡ç‚¹è¯´ä¸€ä¸‹PackTogetherByLabelï¼Œæ ¹æ®AssetEntryå¯¹è±¡å†…çš„æ ‡ç­¾ç”ŸæˆBundleåï¼Œé€‰æ‹©è¿™ä¸ªæ¨¡å¼å‘½åBundleï¼Œæ²¡æœ‰ç‰¹æ®Šéœ€æ±‚ä¸€èˆ¬æ¯ä¸ªAssetåªéœ€è¦ä¸€ä¸ªæ ‡ç­¾å³å¯ï¼Œè¿™æ ·ä¸€ä¸ªæ ‡ç­¾å¯¹åº”å¤šä¸ªèµ„æºå°±å¯ä»¥æ‰“æˆä¸€ä¸ªBundleã€‚ä¸‰ç§æ¨¡å¼éƒ½ä¼šç”Ÿæˆä¸€ä»½AssetBundleBuild[]æ‰“åŒ…æ•°æ®ï¼Œç„¶åæŠŠè¯¥ä»½æ•°æ®æ¯ä¸ªBundleNameæ‰§è¡ŒReHashæ›¿æ¢(è¿™ä¸€æ­¥å¯ä»¥å®šåˆ¶bundle name)ã€‚</p>

<h2 id="å¼€å§‹æ‰“åŒ…">å¼€å§‹æ‰“åŒ…</h2>

<p>â€ƒâ€ƒå®ä¾‹åŒ–ExtractDataTaskå¯¹è±¡ï¼Œå®ä¾‹åŒ–AddressableAssetsBundleBuildParameterså¯¹è±¡ï¼Œåˆå§‹åŒ–buildTasksï¼Œè°ƒç”¨SBPç®¡çº¿ContentPipeline.BuildAssetBundlesæ¥å£å¼€å§‹æ‰“åŒ…ã€‚</p>

<h3 id="contentpipeline">ContentPipeline</h3>

<p>â€ƒâ€ƒContentPipelineæ˜¯SBPæ‰“åŒ…ç®¡çº¿å…¥å£çš„é™æ€ç±»ã€‚åœ¨è°ƒç”¨BuildAssetBundlesåè¿›è¡Œäº†ä¸€ç³»åˆ—çš„å®‰å…¨æ£€æŸ¥ï¼›æŠŠIBuildTaskéœ€è¦çš„æ•°æ®è£…å…¥BuildContextå¯¹è±¡çš„m_ContextObjectså­—å…¸ï¼›åœ¨æ‰§è¡ŒRunTaskä¹‹å‰å…ˆé€šè¿‡Injectå‡½æ•°æ“ä½œTaskæˆå‘˜å˜é‡çš„FieldInfoï¼Œå†ä»BuildContextçš„m_ContextObjectsæ ¹æ®æˆå‘˜å˜é‡ç±»å‹å–å‡ºValueå¹¶å†™å…¥Fieldï¼›æ‰§è¡ŒTask Runningæ“ä½œï¼›ç„¶åå†æŠŠTaskæ‰§è¡Œåæ›´æ–°çš„æˆå‘˜å˜é‡æ•°æ®å–å‡ºè£…å…¥BuildContextå€¼ã€‚</p>

<h2 id="taskç®¡çº¿">Taskç®¡çº¿</h2>

<p>â€ƒâ€ƒæ¯ä¸ªTaskå†…çš„æˆå‘˜å˜é‡ç”¨å±æ€§æ ‡è®°ï¼ŒContextUsage.Inæ˜¯ä»BuildContextå–å‡ºï¼ŒContextUsage.InOutæ˜¯è¾“å…¥è¾“å‡ºåŒå‘ï¼ŒContextUsage.Outè¾“å‡ºã€‚</p>

<h3 id="switchtobuildplatform">SwitchToBuildPlatform</h3>

<p>â€ƒâ€ƒåˆ‡æ¢åˆ°æŒ‡å®šçš„æ‰“åŒ…å¹³å°(å¦‚æœå½“å‰å¹³å°ä¸æ˜¯ç›®æ ‡å¹³å°è§¦å‘åˆ‡æ¢åŸºæœ¬è¦å¥½å‡ ååˆ†é’Ÿå§).</p>

<h3 id="rebuildspriteatlascache">RebuildSpriteAtlasCache</h3>

<p>â€ƒâ€ƒè§¦å‘æ‰€æœ‰Sprite Atlas Packingæ“ä½œï¼Œç”Ÿæˆæ‰€æœ‰ç²¾çµå›¾é›†çš„ç¼“å­˜æ•°æ®ã€‚</p>

<h3 id="buildplayerscripts">BuildPlayerScripts</h3>

<p>â€ƒâ€ƒè§¦å‘æ‰€æœ‰è„šæœ¬ç¼–è¯‘ã€‚</p>

<h3 id="postscriptscallback">PostScriptsCallback</h3>

<p>â€ƒâ€ƒç¼–è¯‘è„šæœ¬æ—¶çš„å›è°ƒï¼Œè¦ç”¨åˆ°è¿™ä¸ªå›è°ƒéœ€è¦ç»™ContentPipeline.BuildCallbacksæ³¨å†Œã€‚</p>

<h3 id="calculatescenedependencydata">CalculateSceneDependencyData</h3>

<p>â€ƒâ€ƒæ”¶é›†Sceneçš„ä¾èµ–èµ„æºä¿¡æ¯ã€‚</p>

<h3 id="calculateassetdependencydata">CalculateAssetDependencyData</h3>

<p>â€ƒâ€ƒæ”¶é›†èµ„æºçš„ä¾èµ–ä¿¡æ¯ï¼Œæœ‰ä¸‰ä¸ªæœ€é‡è¦çš„è¾“å‡ºæ•°æ®æ”¶é›†<code class="language-plaintext highlighter-rouge">IBuildResultsã€IBuildSpriteDataã€IBuildExtendedAssetData</code>ä¼ é€’ç»™ä¸‹ä¸€ä¸ªTaskï¼Œè¿™é‡Œæœ‰è®¸å¤šUnityå†…éƒ¨ä»£ç ç°åœ¨çœ‹ä¸åˆ°ï¼Œç”¨è¿™ä¸‰ä¸ªç»“æœæ•°æ®å€’æ¨è¿™ä¸ªæ”¶é›†æµç¨‹ï¼Œå…ˆçœ‹çœ‹è¿™ä¸‰ä¸ªæ•°æ®ç»“æ„ã€‚</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IBuildResults</span> <span class="p">:</span> <span class="n">IContextObject</span>
<span class="p">{</span>
    <span class="n">ScriptCompilationResult</span> <span class="n">ScriptResults</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">WriteResult</span><span class="p">&gt;</span> <span class="n">WriteResults</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">SerializedFileMetaData</span><span class="p">&gt;</span> <span class="n">WriteResultsMetaData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">GUID</span><span class="p">,</span> <span class="n">AssetResultData</span><span class="p">&gt;</span> <span class="n">AssetResults</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">WriteResult</span><span class="p">{...}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">SerializedFileMetaData</span><span class="p">{...}</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">AssetResultData</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">GUID</span> <span class="n">Guid</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">Hash128</span> <span class="n">Hash</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ObjectIdentifier</span><span class="p">&gt;</span> <span class="n">IncludedObjects</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ObjectIdentifier</span><span class="p">&gt;</span> <span class="n">ReferencedObjects</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">ObjectIdentifier</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="n">Type</span><span class="p">[</span><span class="k">]&gt;</span> <span class="n">ObjectTypes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="nc">IBuildSpriteData</span> <span class="p">:</span> <span class="n">IContextObject</span>
<span class="p">{</span>
    <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">GUID</span><span class="p">,</span> <span class="n">SpriteImporterData</span><span class="p">&gt;</span> <span class="n">ImporterData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="nc">IBuildExtendedAssetData</span> <span class="p">:</span> <span class="n">IContextObject</span>
<span class="p">{</span>
    <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">GUID</span><span class="p">,</span> <span class="n">ExtendedAssetData</span><span class="p">&gt;</span> <span class="n">ExtendedData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>(1) ä¾èµ–æ•°æ®æ–°æ—§å¯¹æ¯”</strong>ï¼Œå…ˆç”¨TaskOutputçš„ä¸´æ—¶ç»“æ„AssetOutputä¿å­˜ï¼ŒAssetOutputåŒ…å«æœ‰ä¸Šè¿°æœ€é‡è¦ä¸‰ä¸ªæ•°æ®ã€‚é€šè¿‡BuildCacheæ¥å£æ ¹æ®Asset GUIDè·å–èµ„äº§ä¿¡æ¯ï¼Œè¿™é‡Œçš„ç¼“å­˜éƒ½æ˜¯ä»Libraryä¸‹çš„BuildCacheè¯»å–ï¼Œè‹¥æ²¡æœ‰ç¼“å­˜ä¼šè·³è¿‡åç»­çš„æ›´æ–°ç¼“å­˜æ•°æ®æ“ä½œï¼Œç„¶åç”Ÿæˆç¼“å­˜ä¿å­˜ï¼›è‹¥æœ‰ä¸Šæ¬¡æ‰“åŒ…çš„ç¼“å­˜æ•°æ®ï¼Œåˆ™æ£€æŸ¥Spriteä¸Atlasçš„å…³è”æ•°æ®åœ¨è¿™æ¬¡æ‰“åŒ…å‰æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼ŒæŠŠç¼“å­˜ä¸­æœ‰è¿‡æ—¶çš„æ•°æ®éœ€è¦é‡æ–°ç”Ÿæˆæ•°æ®æ›¿æ¢ã€‚</p>

<p><strong>(2) ä¾èµ–æ•°æ®æ”¶é›†</strong>ï¼Œ(å¯è·³è¿‡ä¸é˜…è¯»)ï¼Œå…·ä½“æµç¨‹<strong>1)</strong>éå†æ¯ä¸ªAsset GUIDè·å–Cache Infoï¼Œå¦‚æœData[2]ç±»å‹æ˜¯Spriteå°±åŠ å…¥packedSpritesè¡¨ï¼›<strong>2)</strong>è·å–è¯¥Asset CacheInfo Data[4]ç±»å‹è¡¨å¹¶éå†ï¼Œè‹¥æ˜¯Spirteè¿›å…¥GetPlayerDependenciesForAssetæ£€æŸ¥å…¶ä¾èµ–ï¼›<strong>3)</strong>éå†æ‰€æœ‰includedObjectså¯¹è±¡å¹¶ä½¿ç”¨ContentBuildInterface.GetPlayerDependenciesForObjectsè·å–è¯¥å¯¹è±¡çš„æ‰€æœ‰ä¾èµ–ï¼Œè·³è¿‡inputè‡ªèº«æŠŠå…¶ä»–ä¾èµ–åŠ å…¥otherReferencedAssetObjectsHashSetè¡¨ï¼›<strong>4)</strong>ä½¿ç”¨objectLookingAtæ ˆå¯¹æ”¶é›†åˆ°çš„ä¾èµ–å¯¹è±¡å†æ¬¡éå†æŸ¥æ‰¾ï¼Œa.å¯¹äºä¸æ˜¯inputè‡ªèº«ä¸”æ²¡æœ‰åœ¨explicitAssetsè¡¨å†…å°±åŠ å…¥encounteredExplicitAssetDependenciesï¼Œè‹¥æ˜¯éæ‰“åŒ…ç²¾çµåŠ å…¥mainRepresentationNeededï¼Œb.å¯¹äºæœªå¤„ç†è¿‡çš„éšå¼èµ„æºï¼Œæ›´æ–°æˆ–åˆ›å»ºimplicitOutputï¼ŒæŸ¥æ‰¾ç¼“å­˜ä¾èµ–ï¼Œå°†æ–°å‘ç°çš„ä¾èµ–å‹å…¥objectLookingAtæ ˆä¸­ç»§ç»­éå†ï¼›<strong>5)</strong>æœ€åå†æ‰§è¡Œåˆå¹¶collectedImmediateReferencesè¡¨å’ŒmainRepresentationNeededè¡¨è¿”å›æœ€ç»ˆçš„ä¾èµ–ä¿¡æ¯ã€‚</p>

<p><strong>(3) æ”¶é›†IBuildResultsã€IBuildSpriteDataã€IBuildExtendedAssetData</strong>ï¼ŒéSpriteèµ„æºèµ°ProcessAssetå¤„ç†ï¼Œä½¿ç”¨GetPlayerObjectIdentifiersInAssetè·å–includedObjects IDè¡¨ï¼Œç»§ç»­ä½¿ç”¨GetPlayerDependenciesForAssetæ”¶é›†ä¾èµ–ï¼Œç„¶åæ”¶é›†èµ„æºçš„è¡¨ç¤ºè£…å…¥ExtendedAssetDataï¼Œç„¶åå°†ä¾èµ–é¡¹æ‰©å±•ä¸ºæ˜¾å¼èµ„äº§ã€‚æœ€åå°†assetOutput.assetè£…å…¥å„è‡ªçš„æ•°æ®ç»“æ„ä¸­ã€‚</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">internal</span> <span class="k">struct</span> <span class="nc">AssetOutput</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">GUID</span> <span class="n">asset</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">Hash128</span> <span class="n">Hash</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">AssetLoadInfo</span> <span class="n">assetInfo</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ObjectDependencyInfo</span><span class="p">&gt;</span> <span class="n">objectDependencyInfo</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">BuildUsageTagSet</span> <span class="n">usageTags</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">SpriteImporterData</span> <span class="n">spriteData</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">ExtendedAssetData</span> <span class="n">extendedData</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ObjectTypes</span><span class="p">&gt;</span> <span class="n">objectTypes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">CachedInfo</span> <span class="p">:</span> <span class="n">ICachedData</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">CacheEntry</span> <span class="n">Asset</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">CacheEntry</span><span class="p">[]</span> <span class="n">Dependencies</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="cm">/*
    [0]AssetLoadInfo
    [1]BuildUsageTagSet
    [2]SpriteImporterData
    [3]ExtendedAssetData
    [4]List&lt;ObjectTypes&gt;
    [5]List&lt;ObjectDependencyInfo&gt;
    */</span>
    <span class="k">public</span> <span class="kt">object</span><span class="p">[]</span> <span class="n">Data</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="addhashtobundlenametask">AddHashToBundleNameTask</h3>

<p>â€ƒâ€ƒå¦‚æœä½¿ç”¨äº†UniqueBundleIdså®šä¹‰Bundleå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œ</p>

<h3 id="stripunusedspritesources">StripUnusedSpriteSources</h3>

<p>â€ƒâ€ƒå‰¥ç¦»æœªä½¿ç”¨çš„Spiriteï¼Œä»ä¾èµ–åˆ†æçš„Taskè·å–çš„IBuildSpriteDataæ•°æ®è¿›è¡Œéå†ï¼Œåœ¨m_DependencyDataæ²¡æœ‰ç”¨åˆ°çš„Spriteç»Ÿç»Ÿå‰¥ç¦»ï¼Œå¹¶ä»IBuildExtendedAssetDataçš„ExtendedDataå†…åˆ é™¤ã€‚</p>

<h3 id="generatebundlepacking">GenerateBundlePacking</h3>

<p>â€ƒâ€ƒå¤„ç†èµ„æºåŒ…æ‰“åŒ…ç”Ÿæˆå†…éƒ¨æ–‡ä»¶åã€æ”¶é›†èµ„æºçš„å¯¹è±¡æ ‡è¯†ç¬¦ã€è¿‡æ»¤å’Œå¤„ç†èµ„æºå¼•ç”¨ã€è®°å½•èµ„æºåˆ°æ–‡ä»¶çš„æ˜ å°„ï¼Œè¿‡æ»¤é€»è¾‘ç§»é™¤é»˜è®¤èµ„æºå¼•ç”¨ã€å¤„ç†èµ„æºé—´çš„å¾ªç¯å¼•ç”¨ã€å»é™¤é‡å¤æˆ–ä¸å¿…è¦çš„å¼•ç”¨</p>

<h3 id="updatebundleobjectlayout">UpdateBundleObjectLayout</h3>

<p>â€ƒâ€ƒæ›´æ–°bundleçš„ç»„ç»‡ç»“æ„ï¼Œæœ€å¼€å§‹çš„æ•°æ®æ˜¯ä»ContentPipeline.BuildAssetBundlesæ‰“åŒ…æ¥å£å‚æ•°BundleBuildContent(m_AllBundleInputDefs)å¯¹è±¡ç”Ÿæˆï¼Œé€šè¿‡Bundle Packingæ›´æ–°ä¾èµ–æ•°æ®åï¼Œè¿™å—çš„bundleå†…éƒ¨ç»“æ„æ•°æ®ä¹Ÿè¦æ›´æ–°ã€‚</p>

<h3 id="generatebundlecommands">GenerateBundleCommands</h3>

<p>â€ƒâ€ƒä¸ºèµ„æºå’Œåœºæ™¯ç”Ÿæˆæ‰“åŒ…å‘½ä»¤ï¼Œå¤„ç†è‡ªå®šä¹‰èµ„æºã€éå†èµ„æºåŒ…å¸ƒå±€ï¼Œæ ¹æ®èµ„æºç±»å‹åˆ›å»ºä¸åŒçš„å‘½ä»¤ï¼š</p>
<ol>
  <li>èµ„æºåŒ…å‘½ä»¤ (CreateAssetBundleCommand)ï¼šåˆ›å»ºå†™å…¥å‘½ä»¤ã€åˆ›å»ºä½¿ç”¨çš„åˆ—è¡¨é›†ã€åˆ›å»ºå¼•ç”¨æ˜ å°„ã€å¤„ç†ä¾èµ–å“ˆå¸Œå¹¶æ’åºã€ç”Ÿæˆèµ„æºåŒ…å†™å…¥æ“ä½œã€‚</li>
  <li>åœºæ™¯åŒ…å‘½ä»¤ (CreateSceneBundleCommand)ï¼šè·å–åœºæ™¯æ–‡ä»¶å¯¹è±¡ã€åˆ›å»ºå†™å…¥å‘½ä»¤ã€å¤„ç†é¢„åŠ è½½å¯¹è±¡ã€ç”Ÿæˆåœºæ™¯åŠ è½½ä¿¡æ¯ã€åˆ›å»ºåœºæ™¯åŒ…å†™å…¥æ“ä½œã€‚</li>
  <li>åœºæ™¯æ•°æ®å‘½ä»¤ (CreateSceneDataCommand)ï¼šç±»ä¼¼åœºæ™¯åŒ…å‘½ä»¤ã€ä¸“é—¨å¤„ç†é¢å¤–çš„åœºæ™¯æ•°æ®ã€‚</li>
</ol>

<h3 id="generatesubassetpathmaps">GenerateSubAssetPathMaps</h3>

<p>â€ƒâ€ƒåˆ›å»ºå­èµ„æºçš„åŠ è½½ä¿¡æ¯ï¼Œèµ„æºåŒ…å†™å…¥æ“ä½œé›†è½¬ä¸ºinternalNameä¸Valueçš„å­—å…¸æ˜ å°„ï¼Œéå†ExtendedDataçš„guidæ•°æ®ï¼Œé€šè¿‡AssetToFileså–å‡ºä¸»èµ„æºï¼Œé€šè¿‡ä¸»èµ„æºè·å–å½“å‰guidçš„infoï¼Œæ ¹æ®infoå’Œèµ„æºè¡¨ç¤ºå½¢å¼CreateSubAssetLoadInfoï¼Œç„¶åæ’å…¥åˆ°ä¸»èµ„æºinfoçš„BundleAssetsã€‚</p>

<h3 id="generatebundlemaps">GenerateBundleMaps</h3>

<p>â€ƒâ€ƒå¯¹AssetBundleç”Ÿæˆä¾èµ–æ˜ å°„å’Œä½¿ç”¨é›†åˆï¼ŒBuildReferenceMapè¯¦ç»†è¯´æ˜æºåŒ…ä¸­çš„å¯¹è±¡æ‰€ä¾èµ–çš„å…¶ä»–åŒ…ä¸­å­˜åœ¨å“ªäº›å¯¹è±¡ï¼ˆå‰å‘ä¾èµ–é¡¹ï¼‰ï¼›BuildUsageTagSet è¯¦ç»†è¯´æ˜äº†æºåŒ…ä¸­çš„å¯¹è±¡éœ€è¦å†™å…¥çš„æ¡ä»¶æ•°æ®ï¼Œè¯¥æ•°æ®ç”±å…¶ä»–åŒ…ä¸­çš„å¯¹è±¡ä½¿ç”¨ï¼ˆåå‘ä¾èµ–ï¼‰ã€‚</p>

<h3 id="writeserializedfiles">WriteSerializedFiles</h3>

<p>â€ƒâ€ƒæŠŠèµ„æºåŒ…æ•°æ®åˆ†æ®µå†™å…¥AssetBundleã€‚é€šè¿‡TaskCachingUtility.RunCachedOperationæ³¨å†Œæœ¬åœ°å›è°ƒå‡½æ•°åˆ†å¸ƒæ“ä½œå†™å…¥ï¼šè·å–ç¼“å­˜ã€å¤„ç†æœªç¼“å­˜æ–‡ä»¶hashå†™å…¥SerializedFileMetaDataã€ä¿å­˜MetaDataæ•°æ®ä¸WriteResultæ•°æ®ã€‚</p>

<h3 id="archiveandcompressbundles">ArchiveAndCompressBundles</h3>

<p>â€ƒâ€ƒå‹ç¼©å†™å…¥èµ„æºåŒ…ï¼Œåˆ›å»ºArchiveWorkItemé›†ã€æ‰§è¡Œå‹ç¼©Itemçš„ResourceFilesæ‰€æœ‰æ–‡ä»¶å¹¶è¿”å›crcã€‚</p>

<h3 id="generatelocationliststask">GenerateLocationListsTask</h3>

<p>â€ƒâ€ƒåˆ›å»ºå¯»å€èµ„äº§çš„ä½ç½®åˆ—è¡¨ï¼Œç”¨äºæè¿°èµ„æºåœ¨æœ€ç»ˆæ„å»ºåŒ…ä¸­çš„ä½ç½®å’ŒåŠ è½½æ–¹å¼ã€‚æ¯ä¸ªä½ç½®åˆ—è¡¨æ¡ç›®åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼šèµ„æºç±»å‹ã€åŠ è½½è·¯å¾„ã€æä¾›ç¨‹åºã€å…¶ä»–å…ƒæ•°æ®ã€‚</p>

<h2 id="æ‰“åŒ…åå¤„ç†">æ‰“åŒ…åå¤„ç†</h2>

<p>â€ƒâ€ƒéå†ContentCatalogDataEntryé›†åˆç”Ÿæˆä¸»é”®æ˜ å°„ã€Bundle ReNameã€Catalog ReMapã€åˆ›å»ºCatalog Fileã€ä¿å­˜ContentStateã€‚</p>

<h3 id="bundleåå¤„ç†">Bundleåå¤„ç†</h3>

<p>â€ƒâ€ƒè¿™ä¸€æ­¥åœ¨Bundleå‹ç¼©å†™å…¥åã€‚åˆ›å»ºä¸‹è½½ä¿¡æ¯AssetBundleRequestOptionsæ˜¯æä¾›ç»™AssetBundleProviderä¸‹è½½æ—¶ä½¿ç”¨ã€‚æ ¹æ®BundleNamingæ¨¡å¼é‡æ„AssetBundleNameï¼Œé‡æ„å‘½åè¿™ä¸€æ­¥ä¼šå½±å“bundleå‘½åæ ¼å¼ï¼Œå°¤å…¶ä¼šç ´å<a href="#jump1"><code class="language-plaintext highlighter-rouge">1.3å¤„ç†Group</code></a>è¿™ä¸€æ­¥çš„é¢„å‘½åã€‚</p>]]></content><author><name>ç¼–ç¨‹æ•£è®°</name></author><category term="Unity3d" /><category term="Addressable System" /><summary type="html"><![CDATA[æ€»ç»“åœ¨ä½¿ç”¨Unity Addressable Systemè¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€éƒ¨åˆ†é—®é¢˜ï¼Œè¯¥ç¯‡ä¸»è¦è®°å½•Addressableæ‰“ABåŒ…ã€åŠ è½½ABåŒ…ï¼Œæœ¬æ–‡Addressableåç»­ç®€ç§°AAã€‚]]></summary></entry><entry><title type="html">Unity Addressable Systemä½¿ç”¨åˆ†æ(ä¸€)</title><link href="https://www.damonc.top/unity3d/Unity_Addressable_Editor.html" rel="alternate" type="text/html" title="Unity Addressable Systemä½¿ç”¨åˆ†æ(ä¸€)" /><published>2024-07-10T20:00:00+00:00</published><updated>2024-07-10T20:00:00+00:00</updated><id>https://www.damonc.top/unity3d/Unity_Addressable_Editor</id><content type="html" xml:base="https://www.damonc.top/unity3d/Unity_Addressable_Editor.html"><![CDATA[<h2 id="addressableå®‰è£…">Addressableå®‰è£…</h2>
<p>â€ƒâ€ƒæ€»ç»“åœ¨ä½¿ç”¨Unity Addressable Systemè¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€éƒ¨åˆ†é—®é¢˜ï¼Œè¯¥ç¯‡ä¸»è¦è®°å½•Addressableåœ¨Unityç¼–è¾‘å™¨çš„å„ç§ç»„ç»‡ç»“æ„ï¼Œæœ¬æ–‡Addressableåç»­ç®€ç§°AAï¼ŒåŸºäº1.21.19ç‰ˆæœ¬ã€‚</p>

<h3 id="packageå®‰è£…">Packageå®‰è£…</h3>
<p>â€ƒâ€ƒæ‰“å¼€Unity Window - Package Mangerï¼Œæ‰¾åˆ°Addressableå®‰è£…æ‰¾ä¸€ä¸ªåˆé€‚çš„ç‰ˆæœ¬ï¼š
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
--></p>
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/addressable_win_pkg_mgr.png" width="250" /><font size="2.5">
            <i>Addressable Version Seleclt.</i>
        </font></center>

<h3 id="æ‰‹åŠ¨å®‰è£…">æ‰‹åŠ¨å®‰è£…</h3>
<p>â€ƒâ€ƒåœ¨Package Manageré€‰æ‹©ä¸€ä¸ªåˆé€‚çš„Addressableç‰ˆæœ¬è¿˜è¦ç»“åˆAddressableæ›´æ–°logï¼Œæ‰“å¼€<a href="httpsï¼š//docs.unity3d.com/Packages/com.unity.addressables@1.21/changelog/CHANGELOG.html"><code class="language-plaintext highlighter-rouge">Addressableæ›´æ–°æ—¥å¿—</code></a>ï¼Œç‰ˆæœ¬åˆ—è¡¨å±•ç¤ºäº†Address ableå¯¹åº”çš„Unityç‰ˆæœ¬ï¼š
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
--></p>
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/addressable_version.png" width="250" /><font size="2.5">
            <i>Addressable Version List.</i>
        </font></center>
<p>â€ƒâ€ƒUnityè¿™é‡Œåˆ†äº†ä¸¤ä¸ªåˆ†æ”¯ç»´æŠ¤Addressableï¼Œå…¶ä¸­ä¸€ä¸ªåˆ†æ”¯æ˜¯1.21ç‰ˆæœ¬å¯¹åº”çš„Unityç‰ˆæœ¬æ˜¯2019+ï¼Œå¦ä¸€ä¸ªåˆ†æ”¯æ˜¯2.0ç‰ˆæœ¬å¯¹åº”çš„Unityç‰ˆæœ¬æ˜¯2023+ï¼š
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
--></p>
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/addressable_1_21.png" width="250" /><body></body>
        <img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/addressable_2_0.png" width="250" /><font size="2.5">
            <i>Addressable Branch.</i>
        </font></center>

<p>â€ƒâ€ƒ2.0ä»¥ä¸Šç‰ˆæœ¬ä¹Ÿå¯ä»¥ç”¨åœ¨é2023ç‰ˆçš„å¼•æ“ï¼Œä¸»è¦è¿˜æ˜¯é’ˆå¯¹2023+ Unityå¼•æ“æ”¯æŒæ–°çš„APIä»€ä¹ˆçš„ã€‚å¦‚æœæƒ³æŠŠ2.0ç‰ˆæœ¬åˆåˆ°1.21ï¼Œå¼€ä¸€Beyond Compareåˆå¹¶å·®å¼‚ä¹Ÿè¡Œã€‚æ‰“å¼€<a href="httpsï¼š//packages.unity.com/com.unity.addressables"><code class="language-plaintext highlighter-rouge">Addressable Package Json</code></a>ï¼Œè¿™é‡Œåˆ—æ˜äº†æ¯ä¸€ä¸ªAddressableç‰ˆæœ¬å¯¹åº”çš„Unityç‰ˆæœ¬ï¼Œç»“åˆ<a href="httpsï¼š//docs.unity3d.com/Packages/com.unity.addressables@1.21/changelog/CHANGELOG.html"><code class="language-plaintext highlighter-rouge">Addressableæ›´æ–°æ—¥å¿—</code></a>æ‰¾åˆ°ä¸€ä¸ªBugæœ€å°‘åˆç¬¦åˆå¯¹Unityç‰ˆæœ¬è¦æ±‚çš„Addressableç‰ˆæœ¬ã€‚æ‰¾åˆ°åˆé€‚çš„Addressableç‰ˆæœ¬åï¼Œæ‰“å¼€Packages/manifest.jsonï¼Œæ‰‹åŠ¨æ–°å¢åŒ…â€com.unity.addressablesâ€:â€1.21.19â€ã€‚</p>

<h3 id="å®‰è£…addressableä¾èµ–">å®‰è£…Addressableä¾èµ–</h3>
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/addressable_deps.png" width="250" /><font size="2.5">
            <i>Addressable Dependencies.</i>
        </font></center>
<p>â€ƒâ€ƒAddressableæœ€é‡è¦çš„ä¾èµ–æ˜¯ScriptableBuildPipelineï¼ŒSBPè¿™ä¸ªåŒ…è¦æ›´æ–°åˆ°1.21.23æˆ–2.1.xä»¥ä¸Šï¼Œæ—§ç‰ˆSBPå¯¹SpriteAtlaså›¾é›†æ‰“åŒ…ä¼šæœ‰å†—ä½™ã€‚æ‰“å¼€Packages/manifest.jsonï¼Œå¼ºåˆ¶æŒ‡å®šSBPç‰ˆæœ¬â€com.unity.scriptablebuildpipelineâ€:â€1.21.23â€,
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
--></p>
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/sbp_upgrade.png" width="250" /><font size="2.5">
            <i>SBPæŒ‡å®šç‰ˆæœ¬.</i>
        </font></center>

<h3 id="addressableç»“æ„é¢„è§ˆ">Addressableç»“æ„é¢„è§ˆ</h3>
<p>â€ƒâ€ƒå®‰è£…å¥½äº†AAä¹‹åï¼Œä¼šåœ¨Assetsç”Ÿæˆä»¥ä¸‹ç›®å½•ï¼š</p>

<table>
  <tbody>
    <tr>
      <td>ç›®å½•</td>
      <td>è¯´æ˜</td>
    </tr>
    <tr>
      <td>AddressableAssetsData</td>
      <td>æ ¹ç›®å½•ä¹ŸåŒ…å«å‡ ä¸ªé‡è¦æ–‡ä»¶</td>
    </tr>
    <tr>
      <td>##Platform</td>
      <td>æ ¹æ®å½“å‰å¹³å°æ„å»ºä¸€æ¬¡ABåŒ…åç”Ÿæˆçš„ç›®å½•</td>
    </tr>
    <tr>
      <td>AssetGroups</td>
      <td>ç»™æŸèµ„æºè®¾ç½®å¯»å€åœ°å€å¹¶æŒ‡å®šGroupåçš„Groupæè¿°æ–‡ä»¶</td>
    </tr>
    <tr>
      <td>Schemas</td>
      <td>Groupç»„çš„é…ç½®åŒ…å«é€»è¾‘ç»“æ„å’Œç‰¹æ€§æè¿°æ–‡ä»¶</td>
    </tr>
    <tr>
      <td>AssetGroupTemplates</td>
      <td>ç”ŸæˆGroupçš„æ¨¡ç‰ˆæè¿°æ–‡ä»¶</td>
    </tr>
    <tr>
      <td>DataBuilders</td>
      <td>è‡ªå®šä¹‰AssetBundleæ‰“åŒ…è„šæœ¬ç›®å½•</td>
    </tr>
  </tbody>
</table>

<h2 id="addressableå„é¡¹é…ç½®">Addressableå„é¡¹é…ç½®</h2>

<h3 id="addressableassetsettings">AddressableAssetSettings</h3>
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/addressable_assets_settings.png" width="250" /><font size="2.5">
            <i>AddressableAssetSettingsé¢„è§ˆ.</i>
        </font></center>
<p>â€ƒâ€ƒAAçš„å…¨å±€é…ç½®æ–‡ä»¶ï¼Œæ¶‰åŠä¸€äº›æ‰“åŒ…é…ç½®ã€çƒ­æ›´é…ç½®ã€ä¸‹è½½é…ç½®ç­‰ç­‰ï¼Œä¸‹é¢æ˜¯æ¯é¡¹å‚æ•°é…ç½®è¯´æ˜ã€‚</p>

<h3 id="profile">Profile</h3>

<p>â€ƒâ€ƒ<strong>Profile</strong>ä¸»è¦ä½œç”¨æ˜¯æŒ‡å®šæ‰“åŒ…åœ°å€å’ŒåŠ è½½åœ°å€ï¼Œè¿™é‡Œå¯ä»¥é…ç½®æ–°å¢æ‰“åŒ…Abçš„ä¿å­˜ç›®å½•å’ŒHotUpdateçƒ­æ›´èµ„æºç›®å½•çš„æŒ‡å®šè·¯å¾„ï¼Œå»ºè®®è‡ªå®šä¹‰è·¯å¾„ã€‚</p>

<p>â€ƒâ€ƒè¿™ä¸¤ä¸ªå‚æ•°çš„ä½¿ç”¨åœ°æ–¹åœ¨ä¸åŒçš„AAç‰ˆæœ¬æœ‰ä¸€ç‚¹å·®åˆ«ï¼š1.20ä»¥å‰çš„ç‰ˆæœ¬åœ¨Content Updateæœ‰ç”¨åˆ°ï¼Œ1.20ä»¥åçš„ç‰ˆæœ¬åœ¨Catalogæœ‰ä½¿ç”¨ã€‚è§<a href="#jump1"><code class="language-plaintext highlighter-rouge">Catalog</code></a>
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
--></p>
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/profile_in_use.png" width="250" /><font size="2.5">
            <i>Profileé¢„è§ˆ.</i>
        </font></center>
<p>Profile In Useå¯ä»¥é€‰æ‹©ç³»ç»Ÿè‡ªå¸¦æˆ–è‡ªå®šä¹‰ï¼Œå…¶ä¸­è‡ªå®šä¹‰ä½¿ç”¨ManageræŒ‰é’®æ‰“å¼€Profile Windowï¼Œç‚¹å‡»CreateæŒ‰é’®æ–°å¢å˜é‡ç­‰å‚æ•°ã€‚
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
--></p>
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/profile_window.png" width="250" /><font size="2.5">
            <i>Profile Window.</i>
        </font></center>

<p><span id="jump1"></span></p>

<h3 id="catalog">Catalog</h3>
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/catalog_attribute.png" width="250" /><font size="2.5">
            <i>Catalogè®¾ç½®é¢æ¿.</i>
        </font></center>
<p>â€ƒâ€ƒCatalogç±»ä¼¼äºæ ¹bundleï¼Œè®°å½•äº†å½“å‰æ„å»ºbundleæ—¶çš„ä¾èµ–å’ŒAAçš„å„é¡¹è®¾ç½®ã€‚</p>
<ul>
  <li><strong>(1) Player Version Override</strong>ï¼š è¿™ä¸ªå‚æ•°ä¼šå¯¹æ„å»ºå¥½çš„catalogè¿›è¡Œé‡å‘½åï¼Œunityä½¿ç”¨æ—¶é—´æˆ³ï¼Œæˆ‘ä»¬è‡ªå·±å¯ä»¥ç”¨è‡ªå·±çš„æ„å»ºç‰ˆæœ¬å·ï¼Œæ ¼å¼å¯ä»¥æ˜¯catalog_1.2.1720684396.jsonã€‚</li>
  <li><strong>(2) Compress Local Catalog</strong>ï¼š å¯ç”¨ä¼šå°†Catalog.jsonå‹ç¼©æˆCatalog.bundleï¼Œæ˜¾è‘—å‡å°‘æ–‡ä»¶sizeã€‚</li>
  <li><strong>(3) Build Remote Catalog</strong>ï¼š è¦çƒ­æ›´Catalogå°±è¦å¯ç”¨ã€‚</li>
  <li><strong>(4) Build Path</strong>ï¼š æ„å»ºAssetbundleçš„ä¿å­˜åœ°å€ã€‚</li>
  <li><strong>(5) Load Path</strong>ï¼š åŠ è½½AssetBundleçš„åœ°å€ï¼Œè¿™é‡Œæˆ‘æ˜¯åœ¨Profilesè®¾ç½®æˆäº†ç›¸å¯¹åœ°å€ï¼Œç„¶ååœ¨åŠ è½½è„šæœ¬å›è°ƒåœ°å€é€»è¾‘å®Œæˆåç»„è£…å®Œæ•´çš„åŠ è½½åœ°å€ã€‚</li>
  <li><strong>(6) Only Update catalogs manually</strong>ï¼š æ‰‹åŠ¨æ§åˆ¶æ›´æ–°Catalogæ—¶æœºå’Œæ–¹å¼ã€‚</li>
</ul>

<h3 id="update-a-previous-build">Update a Previous Build</h3>
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/update_download.png" width="250" /><font size="2.5">
            <i>Update Downloadsè®¾ç½®.</i>
        </font></center>

<ul>
  <li><strong>(1) Check for Update Issues</strong>ï¼šå®˜æ–¹æ¨èä½¿ç”¨List Restricted Assetsï¼Œåœ¨æ›´æ–°è¿‡ç¨‹ä¸­å¯¹ä½¿ç”¨äº†é™åˆ¶æ›´æ–°çš„Groupæœ‰é™åˆ¶ã€‚</li>
  <li><strong>(2) Content State Build Path</strong>ï¼šæŒ‡å®šaddressables_content_state.binçš„ä¿å­˜åœ°å€ã€‚</li>
</ul>

<p>â€ƒâ€ƒè¯¥content_stateæ–‡ä»¶åªåœ¨æœ¬åœ°æ„å»ºæ—¶è¯»å–è¿›è¡Œå¢é‡æ‰“åŒ…ï¼Œå¯ä»¥çœ‹çœ‹<a href="httpsï¼š//docs.unity3d.com/Packages/com.unity.addressables@2.2/manual/content-update-builds-overview.html"><code class="language-plaintext highlighter-rouge">å®˜æ–¹workflow</code></a>ã€‚ç®€åŒ–æè¿°å°±æ˜¯è¦æ„å»ºæ›´æ–°çš„AssetBundleï¼Œè¯·è¿è¡ŒUpdate a Previous Buildè„šæœ¬ã€‚æ­¤å·¥å…·è¿˜ä½¿ç”¨åˆ°<code class="language-plaintext highlighter-rouge">addressables_content_state.bin</code>æ–‡ä»¶ï¼Œå®ƒä¼šé‡æ–°æ„å»ºæ‰€æœ‰å†…å®¹å¹¶ä¼šç”Ÿæˆåˆ°ä¸€ä¸ªä¿®æ”¹è¿‡çš„ç›®å½•ï¼Œè¯¥ç›®å½•å¯ä»¥è®¿é—®åŸå§‹AssetBundleä¸­æœªæ›´æ”¹çš„å†…å®¹ä»¥åŠæ–°AssetBundleä¸­æ›´æ”¹è¿‡çš„å†…å®¹ã€‚é€šè¿‡æ‰“å¼€Groupsé¢æ¿Toolsé€‰é¡¹Check Content Update Restrictionsçª—å£ï¼Œåªè¦Groupå†…æŸä¸ªèµ„æºæœ‰ä¿®æ”¹ï¼Œå°±ä¼šå‡ºç°åœ¨è¿™ä¸ªåˆ—è¡¨ä¸­ã€‚ä½†æ˜¯å¦‚æœç©å®¶æœ¬åœ°ç”¨æˆ·ç›®å½•çš„bundleä¸å°å¿ƒæŸåäº†æˆ–è€…éœ€è¦å›é€€èµ„æºç‰ˆæœ¬ï¼Œç›´æ¥ä½¿ç”¨Unityè¿™ä¸ªæ–¹æ¡ˆå°±ä¸å¥½åŠã€‚
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
--></p>
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/modify_update_remote.png" width="250" /><font size="2.5">
            <i>ä¿®æ”¹è¿‡çš„groupåˆ—è¡¨.</i>
        </font></center>

<p>â€ƒâ€ƒç”±äºæˆ‘å¼€äº†æ‰‹åŠ¨æ›´æ–°Catalogï¼ŒåŒæ—¶è‡ªå·±ç»´æŠ¤äº†ä¸€å¥—å®Œæ•´çš„æ›´æ–°åˆ—è¡¨ï¼Œå°±ç¦ç”¨äº†è¿™æ¡å±æ€§ã€‚</p>

<h3 id="downloads">Downloads</h3>
<p>â€ƒâ€ƒè‡ªå®šä¹‰è¯ä¹¦ã€ä¸‹è½½å¹¶å‘æ•°é‡ã€è¶…æ—¶ç­‰è®¾ç½®</p>
<ul>
  <li><strong>(1) Custom certificate handler</strong>ï¼šè‡ªå®šä¹‰è¯ä¹¦ç±»è¦å®ç°CertificateHandlerã€‚</li>
  <li><strong>(2) Max Concurrent Web Requests</strong>ï¼šè®¾ç½®Webå¹¶å‘ä¸‹è½½æ•°é‡å®˜æ–¹å»ºè®®2-4ä¸ªã€‚</li>
  <li><strong>(3) Catalog Download Timeout</strong>ï¼šè¶…æ—¶è®¾ç½®ã€‚</li>
</ul>

<h3 id="builds">Builds</h3>

<p>â€ƒâ€ƒæ„å»ºABåŒ…çš„ä¸€äº›è®¾ç½®
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
--></p>
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/setting_build.png" width="250" /><font size="2.5">
            <i>Buildè®¾ç½®.</i>
        </font></center>
<ul>
  <li><strong>(1) Build Addressables on Player Build</strong>ï¼š æ‰“APKçš„æ—¶å€™ä¸€èµ·å…ˆæ‰“Assetbundleåœ¨æ‰“APKï¼Œè¿™é‡Œæˆ‘å…³äº†ä¸éœ€è¦ï¼Œä¸€èˆ¬æ˜¯å•ç‹¬å‡ºBundleèµ„æºçš„ã€‚</li>
  <li><strong>(2) Ignore Invalid/Unsupported Files in Build</strong>ï¼š æ„å»ºæ—¶æ’é™¤æ— æ•ˆæ–‡ä»¶ï¼Œå¦‚æœæœªå¯ç”¨å¯èƒ½å¯¼è‡´ä¸­æ–­æ„å»ºã€‚</li>
  <li><strong>(3) Unique Bundle IDs</strong>ï¼š æŒ‡å®šæ¯ä¸ªAssetbundleç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦ã€‚</li>
  <li><strong>(4) Contiguous Bundles</strong>ï¼š å®šä¹‰çš„Assetbundleå†…å®¹å¸ƒå±€ã€‚</li>
  <li><strong>(5) Non-Recursive Dependency Calculation</strong>ï¼š å¾ªç¯ä¾èµ–è®¡ç®—è€—è´¹æ—¶é—´ï¼Œå¼€å¯åªè®¡ç®—ç›´æ¥ä¾èµ–ã€‚(æŸäº›æƒ…å†µä¸‹æ‰€æœ‰è®¾ç½®éƒ½æ­£ç¡®å´æ— æ³•åŠ è½½Bundleï¼Œä¸€èˆ¬æ˜¯Groupå†…çš„èµ„æºä¾èµ–æœ‰é—®é¢˜ã€‚)</li>
  <li><strong>(6) Strip Unity Version From AssetBundles</strong>ï¼š è£å‰ªAssetbundleå†…çš„unityç‰ˆæœ¬å·ï¼Œå¯ç”¨ã€‚</li>
  <li><strong>(7) Disable Visible Sub Asset Representations</strong>ï¼š ä¸ç›´æ¥æ‹–æ‹½å¼•ç”¨æŸä¸ªspriteï¼Œå¼€å¯è¯¥é¡¹å¯ä»¥åŠ å¿«æ„å»ºæ—¶é—´ã€‚</li>
</ul>

<h3 id="build-and-play-mode-scripts">Build And Play Mode Scripts</h3>

<p>â€ƒâ€ƒæ„å»ºABçš„ä¸€äº›è„šæœ¬é…ç½®ï¼Œå¯ä»¥å®ç°IDataBuilderæ¥å£è‡ªå®šä¹‰æ‰“åŒ…æµç¨‹ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/build_play_scripts.png" width="250" /><body></body>
        <img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/play_mode.png" width="250" /><body></body>
        <img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/build_mode.png" width="250" /><font size="2.5">
            <i>Build Bundleè®¾ç½®.</i>
        </font></center>
<p>â€ƒâ€ƒPlay modeæŒ‡å®šåœ¨ç¼–è¾‘å™¨æ˜¯æ€ä¹ˆåŠ è½½èµ„æºï¼Œæœ¬åœ°æµ‹è¯•ç”¨</p>
<ul>
  <li><strong>(1) Fast Mode</strong>ï¼š ä¸æ‰“åŒ…ç›´æ¥åŠ è½½æ–‡ä»¶ï¼Œé€Ÿåº¦å¿«ä½†åœ¨Profilerä¸­æä¾›çš„ä¿¡æ¯è¾ƒå°‘</li>
  <li><strong>(2) Virtual Mode</strong>ï¼š è™šæ‹Ÿç¯å¢ƒæ¨¡æ‹Ÿç±»ä¼¼äºAssetBundleçš„è¡Œä¸ºï¼Œæ— éœ€æ‰“åŒ…</li>
  <li><strong>(3) Packed Mode</strong>ï¼š ä»å®é™…çš„AssetBundleä¸­åŠ è½½èµ„æºï¼ŒçœŸå®ç¯å¢ƒ</li>
</ul>

<h2 id="addressablegroupsåˆ†æ">AddressableGroupsåˆ†æ</h2>

<h3 id="groupé…ç½®">Groupé…ç½®</h3>

<p>â€ƒâ€ƒAssetGroupsæ˜¯Addressableç»„ç»‡bundleçš„ä¸€ç§å®¹å™¨ï¼Œå¿…é¡»è¦æŠŠèµ„æºåŠ å…¥Groupæ‰èƒ½å‚ä¸æ‰“åŒ…ã€‚
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
--></p>
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/group_view.png" width="250" /><font size="2.5">
            <i>Groupè®¾ç½®.</i>
        </font></center>

<ul>
  <li><strong>(1) Buildin&amp;Load Path</strong>ï¼šé€‰æ‹©Localæˆ–Remoteï¼Œä¸€èˆ¬é€‰RemotRemoteeä»¥æ”¯æŒçƒ­æ›´ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰èµ„æºéƒ½å¯èƒ½ä¼šçƒ­æ›´ã€‚</li>
  <li><strong>(2) AB Compression</strong>ï¼šæŒ‡å®šABåŒ…ç”¨å“ªç§å‹ç¼©ç®—æ³•ï¼šä¸å‹ç¼©ã€LZ4ã€LZMAã€‚</li>
  <li><strong>(3) Include In Build</strong>ï¼š å¯ç”¨æ‰èƒ½æ„å»ºè¯¥ç»„å†…æ‰€åŒ…å«çš„Asset Entryã€‚</li>
  <li><strong>(4) Force Unique Provider</strong>ï¼šæ˜¯å¦æŒ‡å®šå”¯ä¸€çš„GroupåŠ è½½å®ä¾‹ï¼Œå¦‚æœGroupæœ‰ä¸Šç™¾ä¸ªå°±ä¸è¦å‹¾é€‰äº†ã€‚</li>
  <li><strong>(5) Use AB Cache</strong>ï¼šä»è¿œç¨‹ä¸‹è½½çš„ABæ˜¯å¦ä½¿ç”¨AAçš„ç¼“å­˜æœºåˆ¶ã€‚(è¿™ä¸ªç¼“å­˜åŒ…æ‹¬ABèµ„æºå’Œå½“å‰æ›´æ–°æ—¶çš„AAç‰ˆæœ¬ä¿¡æ¯)</li>
  <li><strong>(6) Use UnityWebRequest for Local Asset Bundles</strong>ï¼šå¯¹äºæœ¬åœ°çš„ABèµ„æºæ˜¯å¦ä½¿ç”¨UnityWebRequestAssetBundle GetAssetBundleåŠ è½½ï¼Œè¿˜æ˜¯ä½¿ç”¨AssetBundle LoadFromFileAsyncåŠ è½½ã€‚</li>
  <li><strong>(7) Request Timeout</strong>ï¼šè®¾ç½®ä¸‹è½½è¶…æ—¶ã€‚</li>
  <li><strong>(8) Use Http Chunked Transfer</strong>ï¼šå¼€å¯åˆ†å—ä¼ è¾“ã€‚</li>
  <li><strong>(9) Http Redirect Limit</strong>ï¼šè®¾ç½®é‡å®šå‘æ¬¡æ•°ã€‚</li>
  <li><strong>(9) Retry Count</strong>ï¼šè®¾ç½®ä¸‹è½½å¤±è´¥é‡è¯•æ¬¡æ•°ã€‚</li>
  <li><strong>(10) Include Addresses in Catalog</strong>ï¼š ç¦ç”¨åæ„å»ºbundleæ—¶ä¸ä¼šåŒ…å«åœ¨catalog.jsonã€‚</li>
  <li><strong>(11) Include GUIDs in Catalog</strong>ï¼š ä½¿ç”¨AssetReferenceæ‹–æ‹½å¼•ç”¨å°±å¾—å¯ç”¨ã€‚</li>
  <li><strong>(12) Include Labels in Catalog</strong>ï¼š ä¸é€šè¿‡labelæ ‡ç­¾åŠ è½½èµ„æºï¼Œæˆ‘è¿™é‡Œä¸ä½¿ç”¨labelå»åŠ è½½èµ„æºã€‚</li>
  <li><strong>(13) Internal Asset Naming Mode</strong>ï¼šABåŒ…å†…èµ„æºçš„IDæ ‡è¯†æ–¹å¼ï¼Œæœ‰ä¸‰ç§ï¼šFull Path(èµ„æºå…¨è·¯å¾„)ã€Filename(èµ„æºå)ã€GUID(unityå¯¼å…¥æ—¶è®¾ç½®çš„ID)ã€Dynamic(å®˜æ–¹æ¨èä½¿ç”¨)ã€‚è¿™ä¸ªæ¨¡å¼å½±å“Abçš„CRCå’ŒHASHï¼Œè®¾ç½®è¯¥æ¨¡å¼ä¸­ä»»æ„ä¸€ç§ä¹Ÿä¸ä¼šå½±å“æˆ‘ä»¬ä»ABåŒ…å†…è¯»å–æŸä¸ªèµ„æºã€‚</li>
  <li><strong>(14) Cache Clear Behavior</strong>ï¼šè®¾ç½®APKåŒ…å†…ç¼“å­˜AAä¸‹è½½çš„ABèµ„æºæ—¶é•¿ï¼Œåˆ°æœŸè‡ªåŠ¨æ¸…é™¤ã€‚</li>
  <li><strong>(15) Bundle Mode</strong>ï¼šæ„å»ºABçš„æ¨¡å¼ï¼Œæœ‰ä¸‰ç§ï¼šGroupå†…æ‰€æœ‰èµ„æºæ‰“æˆä¸€ä¸ªABã€Groupå†…èµ„æºåˆ†åˆ«å•ç‹¬æ‰“æˆABã€æ ¹æ®ç»„å†…æ ‡ç­¾æ‰“åŒ…ã€‚</li>
  <li><strong>(16) Bundle Naming Mode</strong>ï¼šè®¾ç½®ABåï¼Œæœ‰ä¸‰ç§ï¼šGroupåã€ Groupåè¿½åŠ HASHã€ä½¿ç”¨Bundleçš„HASH(æ¨è-ä½†è¦åšç»„åä¸HASHä¹‹é—´çš„æ˜ å°„ï¼ŒåŠ è½½Bundleå…ˆæ‹¿åˆ°ç»„åæ˜ å°„çš„HASHå»æ‰¾BundleåŠ è½½)ã€ä½¿ç”¨Groupç»„åçš„å­—ç¬¦HASHã€‚</li>
  <li><strong>(17) Asset Load Mode</strong>ï¼šèµ„æºåŠ è½½æ¨¡å¼ï¼Œæœ‰ä¸¤ç§ï¼šä»bundleè¯·æ±‚åŠ è½½çš„èµ„æºåŠå…¶ä¾èµ–ä¸€èµ·åŠ è½½ã€bundleå†…æ‰€æœ‰çš„èµ„æºå…¨éƒ¨åŠ è½½ã€‚</li>
  <li><strong>(18) Asset Provider</strong>ï¼šä»Bundleå†…åŠ è½½Assetï¼Œå®˜æ–¹æ¨èä½¿ç”¨è‡ªå¸¦çš„Asset from Bundle Provider,ä¹Ÿå¯ä»¥æ ¹æ®Groupå†…æ–‡ä»¶ç±»å‹é€‰æ‹©Jsonã€Spritesç­‰providerã€‚</li>
  <li><strong>(19) Asset Bundle Provider</strong>ï¼šåŠ è½½AssetBundleæ¥å£ï¼Œå®˜æ–¹æ¨èAssetBundle Providerï¼Œæˆ–è€…è‡ªå·±å®ç°ä¸€å¥—Provider(å¯ä»¥å®ç°åŠ å¯†è§£å¯†)ã€‚</li>
</ul>

<h3 id="content-update">Content Update</h3>
<ul>
  <li><strong>(1) Prevent Updates</strong>ï¼šæ˜¯å¦å¯ç”¨ç¦æ­¢æ›´æ–°ç§»åŠ¨Assetã€‚å½“ä½¿ç”¨äº†AAè‡ªå¸¦çš„<strong>Check for Content Update Restrictions tool</strong>ï¼Œä¸å¯ç”¨æ—¶å¦‚æœç»„å†…æœ‰èµ„æºå‘ç”Ÿå˜æ›´ï¼Œè¿™ä¸ªå·¥å…·ä¼šæŠŠå˜æ›´çš„èµ„æºç§»åŠ¨åˆ°éœ€è¦ç”Ÿæˆçš„Remote Groupå†…ã€‚(æˆ‘æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªå·¥å…·ä¹Ÿæ²¡æœ‰å¯ç”¨è¿™ä¸ªé€‰é¡¹ï¼Œç»„å†…çš„èµ„æºç§»åŠ¨å®ç°äº†ä¸€ä¸ªè„šæœ¬è§„åˆ™æ£€æŸ¥)ã€‚</li>
</ul>

<h3 id="group-schemaé…ç½®">Group Schemaé…ç½®</h3>

<p>â€ƒâ€ƒBundledAssetGroupSchemaä¸»è¦æ˜¯Groupé¢æ¿é…ç½®ï¼Œä¸€ä¸ªGroupä¼šç”Ÿæˆä¸¤ä»½Schemaï¼Œ<strong>#GroupName_BundledAssetGroupSchema</strong>ã€<strong>#GroupName_BundledAssetGroupSchema</strong>ã€‚
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
--></p>
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/group_serialize.png" width="250" /><font size="2.5">
            <i>Group Debugæ¨¡å¼.</i>
        </font></center>
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/schema_serialize1.png" width="250" /><body></body>
        <img loading="lazy" src="https://img.damonc.top/posts/2024/month7/addressable_system/schema_serialize2.png" width="250" /><font size="2.5">
            <i>Schema Debugæ¨¡å¼.</i>
        </font></center>

<p>â€ƒâ€ƒé€šè¿‡Debugæ¨¡å¼å¯ä»¥çœ‹åˆ°Groupä¸»è¦æ˜¯ä¿å­˜äº†<strong>SerializeEntries</strong>èµ„æºã€<strong>Schema</strong>é…ç½®ï¼Œæ‰€ä»¥é…ç½®å®é™…ä¸Šæ˜¯ç”±Schemaä¿å­˜çš„ã€‚åœ¨å†™ä»£ç åˆ›å»ºGroupæ—¶ï¼Œè¦æŠŠèµ„æºåŠ å…¥åˆ°Groupå†…ã€é…ç½®å†™åˆ°Schemaå†…ã€‚</p>
<pre><code class="language-CSHARP">//...
group = settings.CreateGroup(key, i == 0, false, false, null);
AddressableBuildUtil.CheckSchemaValue(group, _keyIdArray);
AddressableBuildUtil.CheckUpdateSchema(group);
//...

SetSchemaBuildLoadPath(schema, keyIds);
schema.ChunkedTransfer = true;
//disable crc ä½¿ç”¨md5ä»£æ›¿
schema.UseAssetBundleCrc = false;
schema.UseAssetBundleCrcForCachedBundles = false;
//disable guid
schema.IncludeGUIDInCatalog = false;
schema.IncludeLabelsInCatalog = false;
schema.RedirectLimit = 2;
schema.RetryCount = 2;
schema.Timeout = 30;

SetBundleCache(schema);
//load asset by name
SetSchemaNameMode(schema, BundledAssetGroupSchema.AssetNamingMode.Filename);
//pack modeæ‰“åŒ…æ¨¡å¼
SetSchemaPackMode(schema, BundledAssetGroupSchema.BundlePackingMode.PackTogetherByLabel);
//bundle name
SetSchemaNameStyle(schema, BundledAssetGroupSchema.BundleNamingStyle.FileNameHash);
//bundle id
SetSchemaBundleIdMode(schema, BundledAssetGroupSchema.BundleInternalIdMode.GroupGuid);
//bundle compression
SetSchemaBundleCompressionMode(schema, BundledAssetGroupSchema.BundleCompressionMode.LZ4);

//è®¾ç½®Schema Valueä¼šè§¦å‘Group dirtyé€šçŸ¥ï¼Œè¦åˆ¤æ–­å€¼æœ‰æ²¡æœ‰å˜å†è®¾ç½®
if (schema.BundleMode ~= packMode)
{
    schema.BundleMode = packMode;
}
</code></pre>

<h2 id="assetgrouptemplates">AssetGroupTemplates</h2>
<p>â€ƒâ€ƒGroupæ¨¡ç‰ˆé…ç½®,å¯ä»¥é¢„å…ˆè®¾ç½®å¥½Groupçš„é…ç½®ï¼Œä½¿ç”¨è¯¥æ¨¡ç‰ˆåˆ›å»ºGroupã€‚</p>

<h2 id="databuilders">DataBuilders</h2>
<p>â€ƒâ€ƒå­˜æ”¾æ‰“åŒ…è„šæœ¬å’ŒEditoræµ‹è¯•åŠ è½½è„šæœ¬çš„ç›®å½•ï¼ŒAAæä¾›äº†å››ä¸ªè‡ªå¸¦è„šæœ¬ã€‚</p>
<ul>
  <li><strong>(1) BuildScriptFastMode</strong>ï¼šå¯¹åº”<strong>Use Asset Database (fastest)</strong>æŒ‰é’®ï¼Œå¿«é€ŸåŠ è½½æ¨¡å¼ï¼Œç±»ä¼¼AssetdataBaseåŠ è½½èµ„æºã€‚</li>
  <li><strong>(2) BuildScriptPackedMode</strong>ï¼šå¯¹åº”<strong>Default Build Script</strong>æ‰“åŒ…æŒ‰é’®ï¼Œé»˜è®¤çš„æ‰“ABåŒ…è„šæœ¬ï¼Œå¯ä»¥æ ¹æ®è¿™ä¸ªè„šæœ¬ä¿®æ”¹è‡ªå·±çš„æ‰“åŒ…å‰åæµç¨‹ã€‚</li>
  <li><strong>(3) BuildScriptPackedPlayMode</strong>ï¼šå¯¹åº”<strong>Use Existing Build(#Platform)</strong>ï¼ŒçœŸå®å®Œæ•´çš„ABåŠ è½½åœºæ™¯æ¨¡å¼ï¼Œåœ¨Editoræµ‹è¯•ABæ˜¯å¦æ­£ç¡®ã€‚</li>
  <li><strong>(4) BuildScriptVirtualMode</strong>ï¼šå¯¹åº”<strong>Simulate Groups (advanced)</strong>æŒ‰é’®ï¼Œä¸ç”¨æ‰“ABåŒ…å¯æ¨¡æ‹ŸåŠ è½½ABæ¨¡å¼ã€‚</li>
</ul>]]></content><author><name>ç¼–ç¨‹æ•£è®°</name></author><category term="Unity3d" /><category term="Addressable System" /><summary type="html"><![CDATA[æ€»ç»“åœ¨ä½¿ç”¨Unity Addressable Systemè¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€éƒ¨åˆ†é—®é¢˜ï¼Œè¯¥ç¯‡ä¸»è¦è®°å½•Addressableåœ¨Unityç¼–è¾‘å™¨çš„å„ç§ç»„ç»‡ç»“æ„ï¼Œæœ¬æ–‡Addressableåç»­ç®€ç§°AAã€‚]]></summary></entry><entry><title type="html">è§†å·®å’Œæ³•çº¿ã€é«˜åº¦å›¾å›é¡¾(ç¿»è¯‘äºŒå)</title><link href="https://www.damonc.top/Unity_Parallax_Normals_Heightmap.html" rel="alternate" type="text/html" title="è§†å·®å’Œæ³•çº¿ã€é«˜åº¦å›¾å›é¡¾(ç¿»è¯‘äºŒå)" /><published>2018-01-25T20:00:00+00:00</published><updated>2018-01-25T20:00:00+00:00</updated><id>https://www.damonc.top/Unity_Parallax_Normals_Heightmap</id><content type="html" xml:base="https://www.damonc.top/Unity_Parallax_Normals_Heightmap.html"><![CDATA[<p>ç”±äºè§†è§’çš„åŸå› ï¼Œå½“è°ƒæ•´æ‘„åƒæœºä½ç½®æ—¶ï¼Œè§‚å¯Ÿåˆ°çš„äº‹ç‰©çš„ç›¸å¯¹ä½ç½®ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™ç§è§†è§‰ç°è±¡ç§°ä¸ºè§†å·®ã€‚åœ¨åç«è½¦é«˜é€Ÿè¡Œé©¶çœ‹çª—å¤–çš„æ™¯ç‰©ï¼Œé™„è¿‘çš„ç‰©ä½“çœ‹èµ·æ¥å¾ˆå¤§å¹¶ä¸”ç§»åŠ¨å¾ˆå¿«ï¼Œè€Œè¿œå¤„çš„èƒŒæ™¯çœ‹èµ·æ¥å¾ˆå°å¹¶ä¸”ç§»åŠ¨è¾ƒæ…¢ã€‚æ¸²æŸ“æ—¶ï¼Œç›¸æœºä½¿ç”¨é€è§†æ¨¡å¼æ—¶ï¼Œä¹Ÿä¼šå‡ºç°è§†å·®ã€‚</p>

<h2 id="è§†å·®çº¹ç†">è§†å·®çº¹ç†</h2>

<p>ä¹‹å‰ç¿»è¯‘ä½¿ç”¨è¿‡æ³•çº¿è´´å›¾å°†è¡¨é¢ä¸è§„åˆ™æ„Ÿæ·»åŠ åˆ°å¹³æ»‘è¡¨é¢ã€‚ å®ƒä¼šå½±å“ç…§æ˜ï¼Œä½†ä¸ä¼šå½±å“è¡¨é¢çš„å®é™…å½¢çŠ¶ã€‚ å› æ­¤ï¼Œè¯¥æ•ˆæœè§†å·®ä¸æ˜æ˜¾ï¼Œé€šè¿‡å®ç°æ³•çº¿è´´å›¾åŸºäºè§†é‡æ·±åº¦çš„å¹»è§‰æœ‰è®¸å¤šé™åˆ¶ã€‚è¿™ä¸€ç¯‡çš„ç›®çš„å°±æ˜¯è§£å†³è¯¥é™åˆ¶ã€‚</p>

<h3 id="æ³•çº¿è´´å›¾æ•ˆæœå›é¡¾">æ³•çº¿è´´å›¾æ•ˆæœå›é¡¾</h3>

<p>ä¸‹é¢ç»™å‡ºè®¸å¤šalbedo map å’Œ normal mapå·®å¼‚å¯¹æ¯”ï¼š</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200615181223145-1229624244.png" width="250" /><body></body>
        <img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200615181223966-473200226.png" width="250" /><font size="2.5">
            <i>albedo map å’Œ normal map.</i>
        </font></center>

<p>å¦‚æœæ²¡æœ‰æ³•çº¿è´´å›¾ï¼Œè¡¨é¢çœ‹èµ·æ¥å¾ˆå¹³å¦ã€‚ æ·»åŠ æ³•çº¿è´´å›¾ä¼šä½¿å®ƒçœ‹èµ·æ¥å¥½åƒå…·æœ‰ä¸è§„åˆ™çš„è¡¨é¢ã€‚ ä½†æ˜¯ï¼Œé«˜åº¦æµ·æ‹”å·®å¼‚çœ‹èµ·æ¥ä¸æ˜æ˜¾ã€‚ å½“ä»å…¥å°„è§†è§’ä¸è¡¨é¢çš„å¤¹è§’è¶Šè¶‹äº0ï¼Œé«˜åº¦å·®è¶Šä¸æ˜æ˜¾ã€‚å¦‚æœé«˜ç¨‹å·®å¼‚è¾ƒå¤§ï¼Œåˆ™è¡¨é¢ç‰¹å¾çš„ç›¸å¯¹è§†è§‰ä½ç½®åº”ç”±äºè§†å·®è€Œå‘ç”Ÿå¾ˆå¤§å˜åŒ–ï¼Œä½†ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚ æˆ‘ä»¬çœ‹åˆ°çš„è§†å·®æ˜¯å¹³å¦çš„è¡¨é¢ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200616191420845-1957506928.png" width="250" /><font size="2.5">
            <i>å¹³å¦çš„è§†è§’.</i>
        </font></center>

<p>è™½ç„¶å¯ä»¥å¢åŠ æ³•çº¿è´´å›¾çš„å¼ºåº¦ï¼Œä½†è¿™ä¸ä¼šæ”¹å˜è§†å·®ã€‚åŒæ ·ï¼Œå½“æ³•çº¿è´´å›¾å˜å¾—å¤ªå¼ºæ—¶ï¼Œå®ƒä¼šçœ‹èµ·æ¥å¾ˆå¥‡æ€ªã€‚å®ƒå½±å“äº†å¹³å¦è¡¨é¢çš„å…‰çº¿çš„æ˜æš—å˜æ¢ï¼Œè€Œè§†å·®æ•ˆæœå®ƒä»¬ç¡®å®æ˜¯å¹³çš„ã€‚æ‰€ä»¥æ³•çº¿è´´å›¾åªé€‚ç”¨äºå°çš„å˜åŒ–ï¼Œä½†ä¸ä¼šè¡¨ç°å‡ºæ˜æ˜¾çš„è§†å·®ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200616191421654-712293996.png" width="250" /><font size="2.5">
            <i>æ³•çº¿è´´å›¾çš„å…‰çº¿å˜åŒ–.</i>
        </font></center>

<p>è¦è·å¾—çœŸæ­£çš„æ·±åº¦è§†å·®æ„Ÿï¼Œ<strong>é¦–å…ˆ</strong>éœ€è¦ç¡®å®šæ·±åº¦åº”è¯¥æ˜¯å¤šå°‘ã€‚æ³•çº¿è´´å›¾ä¸åŒ…å«è¿™äº›ä¿¡æ¯ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªé«˜åº¦å›¾ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªåŸºäºé«˜åº¦ä¿¡æ¯çš„å‡è§†å·®æ•ˆæœï¼Œå°±åƒæ³•çº¿è´´å›¾åˆ›å»ºä¸€ä¸ªå‡æ–œç‡ä¸€æ ·ã€‚ä¸‹é¢çš„è´´å›¾ä¹Ÿç§°å®ƒæ˜¯ç°åº¦å›¾ï¼Œé»‘è‰²ä»£è¡¨æœ€ä½ç‚¹ï¼Œç™½è‰²ä»£è¡¨æœ€é«˜ç‚¹ã€‚å› ä¸ºæˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªè´´å›¾æ¥åˆ›å»ºä¸€ä¸ªè§†å·®æ•ˆæœï¼Œä¹Ÿç§°ä¸ºè§†å·®å›¾ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200616191422519-1710373191.png" width="250" /><font size="2.5">
            <i>é«˜åº¦å›¾.</i>
        </font></center>

<p>ç¡®ä¿åœ¨å¯¼å…¥æ—¶ç¦ç”¨sRGB(é¢œè‰²çº¹ç†)ï¼Œè¿™æ ·åœ¨ä½¿ç”¨çº¿æ€§ç©ºé—´æ¸²æŸ“æ—¶æ•°æ®å°±ä¸ä¼šè¢«å¼„ä¹±</p>

<h3 id="shaderå‚æ•°">Shaderå‚æ•°</h3>

<p>ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨è§†å·®è´´å›¾ï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºå®ƒæ·»åŠ ä¸€ä¸ªå±æ€§åˆ°ç€è‰²å™¨ã€‚ä¹Ÿä¼šç»™å®ƒä¸€ä¸ªå¼ºåº¦å‚æ•°æ¥ç¼©æ”¾æ•ˆæœã€‚å› ä¸ºè§†å·®æ•ˆæœç›¸å½“å¼ºï¼Œæˆ‘ä»¬å°†å…¶èŒƒå›´è®¾ç½®ä¸º(0 , 0.1)ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="n">_ParallaxMap</span> <span class="p">(</span><span class="s">"Parallax"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"black"</span> <span class="p">{}</span>
<span class="n">_ParallaxStrength</span> <span class="p">(</span><span class="s">"Parallax Strength"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span>

<span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="n">_OcclusionMap</span> <span class="p">(</span><span class="s">"Occlusion"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="n">_OcclusionStrength</span> <span class="p">(</span><span class="s">"Occlusion Strength"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div></div>

<p>è§†å·®è´´å›¾æ˜¯ä¸€ä¸ªç€è‰²å™¨ç‰¹æ€§ï¼Œæˆ‘ä»¬å°†å¯ç”¨__PARALLAX_MAP_å…³é”®å­—ã€‚å°†å¿…éœ€çš„ç¼–è¯‘å™¨æŒ‡ä»¤æ·»åŠ åˆ°base passã€additive passå’Œdeferred passã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma shader_feature _NORMAL_MAP
#pragma shader_feature _PARALLAX_MAP
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ä¸ºä»€ä¹ˆä¸åœ¨ShadowCasterå¢åŠ è§†å·®è´´å›¾ï¼Ÿ
å½“ä½¿ç”¨albedoè´´å›¾çš„alphaé€šé“çš„é€æ˜åº¦æ—¶ï¼Œè§†å·®è´´å›¾åªä¼šå½±å“é˜´å½±ã€‚å³ä½¿æ˜¯è¿™æ ·ï¼Œåœ¨é˜´å½±è´´å›¾ä¸­çš„è§†å·®æ•ˆæœä¹Ÿå¾ˆéš¾è¢«æ³¨æ„åˆ°ã€‚æ‰€ä»¥å®ƒé€šå¸¸ä¸å€¼å¾—é¢å¤–çš„è®¡ç®—æ—¶é—´ã€‚ä½†æ˜¯å¦‚æœæ„¿æ„ï¼Œä¹Ÿå¯ä»¥å°†å®ƒæ·»åŠ åˆ°é˜´å½±æ–½æ³•è€…é€šé“ä¸­ã€‚
</code></pre></div></div>

<p>ä¸ºäº†è®¿é—®æ–°çš„å±æ€§ï¼Œç»™æˆ‘çš„ç…§æ˜æ·»åŠ ç›¸åº”çš„å˜é‡</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sampler2D</span> <span class="n">_ParallaxMap</span><span class="p">;</span>
<span class="n">float</span> <span class="n">_ParallaxStrength</span><span class="p">;</span>

<span class="n">sampler2D</span> <span class="n">_OcclusionMap</span><span class="p">;</span>
<span class="n">float</span> <span class="n">_OcclusionStrength</span><span class="p">;</span>
</code></pre></div></div>

<p>ä¸ºäº†èƒ½å¤Ÿè‡ªå®šä¹‰é…ç½®æè´¨ï¼Œåœ¨Extend ShaderGUIæ‰©å±•ä¸­å¢åŠ ç›¸åº”Enableä¸Disanble keyçš„æ–¹æ³•ã€‚</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">void</span> <span class="nf">DoParallax</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">MaterialProperty</span> <span class="n">map</span> <span class="p">=</span> <span class="nf">FindProperty</span><span class="p">(</span><span class="s">"_ParallaxMap"</span><span class="p">);</span>
    <span class="n">Texture</span> <span class="n">tex</span> <span class="p">=</span> <span class="n">map</span><span class="p">.</span><span class="n">textureValue</span><span class="p">;</span>
    <span class="n">EditorGUI</span><span class="p">.</span><span class="nf">BeginChangeCheck</span><span class="p">();</span>
    <span class="n">editor</span><span class="p">.</span><span class="nf">TexturePropertySingleLine</span>
    <span class="p">(</span>
        <span class="nf">MakeLabel</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="s">"Parallax (G)"</span><span class="p">),</span> <span class="n">map</span><span class="p">,</span>
        <span class="n">tex</span> <span class="p">?</span> <span class="nf">FindProperty</span><span class="p">(</span><span class="s">"_ParallaxStrength"</span><span class="p">)</span> <span class="p">:</span> <span class="k">null</span>
    <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">EditorGUI</span><span class="p">.</span><span class="nf">EndChangeCheck</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="n">tex</span> <span class="p">!=</span> <span class="n">map</span><span class="p">.</span><span class="n">textureValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">SetKeyword</span><span class="p">(</span><span class="s">"_PARALLAX_MAP"</span><span class="p">,</span> <span class="n">map</span><span class="p">.</span><span class="n">textureValue</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200616191423089-347056836.png" width="250" /></center>

<h3 id="åæ ‡åŒ¹é…">åæ ‡åŒ¹é…</h3>

<p>é€šè¿‡åœ¨fragmentç¨‹åºä¸­è°ƒæ•´çº¹ç†åæ ‡ï¼Œè®©å¹³å¦è¡¨é¢çš„æŸäº›éƒ¨åˆ†çœ‹èµ·æ¥é«˜ä½äº¤é”™ã€‚åˆ›å»ºä¸€ä¸ªåº”ç”¨è§†å·®å‡½æ•°ï¼Œç»™å®ƒä¸€ä¸ªinoutæ’å€¼å™¨å‚æ•°ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">ApplyParallax</span> <span class="p">(</span><span class="k">inout</span> <span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨fragmentç¨‹åºä½¿ç”¨æ’å…¥çš„æ•°æ®ä¹‹å‰è°ƒç”¨è§†å·®å‡½æ•°ã€‚_ä¼šæœ‰ç‚¹å¼‚å¸¸æ˜¯LODè¡°è½ï¼Œ_å› ä¸ºè¿™å–å†³äºå±å¹•ä½ç½®ã€‚å…ˆä¸è°ƒæ•´è¿™äº›åæ ‡ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FragmentOutput</span> <span class="nf">MyFragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UNITY_SETUP_INSTANCE_ID</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="cp">#if defined(LOD_FADE_CROSSFADE)
</span>        <span class="n">UnityApplyDitherCrossFade</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">vpos</span><span class="p">);</span>
    <span class="cp">#endif
</span>
    <span class="n">ApplyParallax</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

    <span class="n">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">GetAlpha</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="cp">#if defined(_RENDERING_CUTOUT)
</span>        <span class="nb">clip</span><span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">_Cutoff</span><span class="p">);</span>
    <span class="cp">#endif
</span><span class="p">}</span>
</code></pre></div></div>

<p>é€šè¿‡ç®€å•åœ°å‘Uåæ ‡æ·»åŠ è§†å·®å¼ºåº¦æ¥è°ƒæ•´çº¹ç†åæ ‡ã€‚åšä¸€æ¬¡åç§»è®¡ç®—</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">ApplyParallax</span> <span class="p">(</span><span class="k">inout</span> <span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="cp">#if defined(_PARALLAX_MAP)
</span>        <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">_ParallaxStrength</span><span class="p">;</span>
    <span class="cp">#endif
</span><span class="p">}</span>
</code></pre></div></div>

<p>æ”¹å˜è§†å·®å¼ºåº¦ä¼šå¯¼è‡´çº¹ç†åç§»ã€‚å¢åŠ Uåæ ‡ä¼šä½¿çº¹ç†å‘è´Ÿçš„Uæ–¹å‘ç§»åŠ¨ï¼ŒVåæ ‡åŒç†ã€‚è¿™çœ‹èµ·æ¥ä¸æ˜¯è§†å·®æ•ˆæœï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªä¸è§†è§’æ— å…³çš„å‡åŒ€ä½ç§»ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200618012938981-982216259.gif" width="250" /><font size="2.5">
            <i>uåæ ‡ç§»åŠ¨.</i>
        </font></center>

<h3 id="éšè§†è§’æ–¹å‘ç§»åŠ¨">éšè§†è§’æ–¹å‘ç§»åŠ¨</h3>

<p>è§†å·®æ˜¯ç”±ç›¸å¯¹äºè§‚å¯Ÿè€…çš„é€è§†æŠ•å½±ï¼Œæ‰€ä»¥å¿…é¡»æ”¹å˜çº¹ç†åæ ‡ã€‚è¿™æ„å‘³ç€å¿…é¡»åŸºäºè§†å›¾çš„æ–¹å‘æ¥ç§»åŠ¨åæ ‡ï¼Œè€Œè§†å›¾çš„æ–¹å‘å¯¹äºè¡¨é¢ä¸Šæ¯ä¸ªç‰‡æ®µéƒ½æ˜¯ä¸åŒçš„ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200617192759952-594530144.png" width="250" /><font size="2.5">
            <i>varies across a surface.</i>
        </font></center>

<p>çº¹ç†åæ ‡å­˜åœ¨äºåˆ‡çº¿ç©ºé—´ä¸­ã€‚ä¸ºäº†è°ƒæ•´è¿™äº›åæ ‡ï¼Œéœ€è¦çŸ¥é“è§†å›¾åœ¨åˆ‡çº¿ç©ºé—´ä¸­çš„æ–¹å‘ã€‚è¿™éœ€è¦çŸ©é˜µä¹˜æ³•å¯¹ç©ºé—´è¿›è¡Œè½¬æ¢ã€‚åœ¨fragment-ç¨‹åºå·²ç»æœ‰äº†ä¸€ä¸ªåˆ‡çº¿ç©ºé—´çŸ©é˜µï¼Œä½†æ˜¯å®ƒæ˜¯ç”¨äºä»åˆ‡çº¿ç©ºé—´åˆ°ä¸–ç•Œç©ºé—´çš„è½¬æ¢ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œéœ€è¦ä»å¯¹è±¡ç©ºé—´è½¬åˆ°åˆ‡çº¿ç©ºé—´ã€‚</p>

<p>è§†å›¾æ–¹å‘å‘é‡å®šä¹‰ä¸ºä»è¡¨é¢åˆ°æ‘„åƒæœºï¼Œéœ€è¦å½’ä¸€åŒ–ã€‚æˆ‘ä»¬å¯ä»¥åœ¨vertexç¨‹åºä¸­ç¡®å®šè¿™ä¸ªå‘é‡ï¼Œè½¬æ¢å®ƒå¹¶å°†å®ƒä¼ é€’ç»™fragmentç¨‹åºã€‚ä½†æ˜¯ä¸ºäº†æœ€ç»ˆå¾—åˆ°æ­£ç¡®çš„æ–¹å‘ï¼Œéœ€è¦æ¨è¿Ÿå½’ä¸€åŒ–ï¼Œç›´åˆ°æ’å€¼å®Œæˆåã€‚æ·»åŠ åˆ‡çº¿ç©ºé—´è§†å›¾æ–¹å‘ä½œä¸ºä¸€ä¸ªæ–°çš„æ’å€¼æˆå‘˜å˜é‡ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">InterpolatorsVertex</span> <span class="p">{</span>
    <span class="cp">#if defined(_PARALLAX_MAP)
</span>        <span class="kt">float3</span> <span class="n">tangentViewDir</span> <span class="o">:</span> <span class="n">TEXCOORD8</span><span class="p">;</span>
    <span class="cp">#endif
</span><span class="p">};</span>

<span class="k">struct</span> <span class="n">Interpolators</span> <span class="p">{</span>
    <span class="cp">#if defined(_PARALLAX_MAP)
</span>        <span class="kt">float3</span> <span class="n">tangentViewDir</span> <span class="o">:</span> <span class="n">TEXCOORD8</span><span class="p">;</span>
    <span class="cp">#endif
</span><span class="p">};</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å¯„å­˜å™¨æ•°é‡é™åˆ¶æ˜¯å¤šå°‘?
model 1ä¸model 2éƒ½åªæ”¯æŒ8ä¸ªTexture Coordinate Register -&gt;Texcoord[0-7]ã€‚å½“ä½¿ç”¨model 3æ—¶ï¼Œå¯ä»¥ä½¿ç”¨TEXCOORD8ã€‚è‹¥ç¡¬ä»¶ä¸æ”¯æŒmodel 3å…¶æœºèƒ½ä¹Ÿå°±ä¸æ˜¯å¾ˆå¼ºå¤§ï¼Œæ‰€ä»¥ä¸è¦ä½¿ç”¨è§†å·®æ˜ å°„ã€‚
</code></pre></div></div>

<p><strong>é¦–å…ˆ</strong>, ä½¿ç”¨meshç½‘æ ¼æ•°æ®ä¸­çš„åŸå§‹é¡¶ç‚¹åˆ‡å‘é‡å’Œæ³•å‘é‡ï¼Œåœ¨é¡¶ç‚¹ç¨‹åºä¸­åˆ›å»ºä¸€ä¸ªä»å¯¹è±¡ç©ºé—´åˆ°åˆ‡çº¿ç©ºé—´çš„è½¬æ¢çŸ©é˜µã€‚å› ä¸ºæˆ‘ä»¬åªç”¨å®ƒæ¥å˜æ¢ä¸€ä¸ªå‘é‡è€Œä¸æ˜¯ä¸€ä¸ªä½ç½®æˆ‘ä»¬ç”¨ä¸€ä¸ª3Ã—3çŸ©é˜µå°±è¶³å¤Ÿäº†ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">InterpolatorsVertex</span> <span class="nf">MyVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ComputeVertexLightColor</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

    <span class="cp">#if defined (_PARALLAX_MAP)
</span>        <span class="kt">float3x3</span> <span class="n">objectToTangent</span> <span class="o">=</span> <span class="kt">float3x3</span><span class="p">(</span>
            <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">,</span>
            <span class="nb">cross</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">,</span>
            <span class="n">v</span><span class="p">.</span><span class="n">normal</span>
        <span class="p">);</span>
    <span class="cp">#endif
</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>ç„¶å</strong>ï¼Œå¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">ObjSpaceViewDir</code>å‡½æ•°å¾—åˆ°å¯¹è±¡ç©ºé—´ä¸­é¡¶ç‚¹ä½ç½®çš„è§†å›¾æ–¹å‘ï¼Œå†ç”¨çŸ©é˜µå˜æ¢å®ƒæˆ‘ä»¬å°±å¾—åˆ°äº†æˆ‘ä»¬éœ€è¦çš„åˆ‡çº¿ç©ºé—´ä¸‹è§†å›¾æ–¹å‘ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if defined (_PARALLAX_MAP)
</span>    <span class="kt">float3x3</span> <span class="n">objectToTangent</span> <span class="o">=</span> <span class="kt">float3x3</span>
    <span class="p">(</span>
        <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">,</span>
        <span class="nb">cross</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">,</span>
        <span class="n">v</span><span class="p">.</span><span class="n">normal</span>
    <span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">objectToTangent</span><span class="p">,</span> <span class="n">ObjSpaceViewDir</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">));</span>
<span class="cp">#endif
</span></code></pre></div></div>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ObjSpaceViewDirå†…éƒ¨å®ç°?</span>
<span class="c1">//ObjSpaceViewDirå‡½æ•°æ˜¯åœ¨UnityCGä¸­å®šä¹‰çš„ã€‚å®ƒå…ˆå°†æ‘„åƒæœºä½ç½®è½¬æ¢åˆ°å¯¹è±¡ç©ºé—´ï¼Œç„¶åå‡å»å¯¹è±¡ç©ºé—´ä¸‹é¡¶ç‚¹ä½ç½®å¾—åˆ°ä¸€ä¸ªä»é¡¶ç‚¹æŒ‡å‘æ‘„åƒæœºçš„å‘é‡ï¼Œæ³¨æ„å®ƒè¿˜æ²¡æœ‰æ ‡å‡†åŒ–.</span>

<span class="k">inline</span> <span class="kt">float3</span> <span class="nf">ObjSpaceViewDir</span> <span class="p">(</span><span class="kt">float4</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float3</span> <span class="n">objSpaceCameraPos</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">unity_WorldToObject</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">_WorldSpaceCameraPos</span><span class="p">.</span><span class="n">xyz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">objSpaceCameraPos</span> <span class="o">-</span> <span class="n">v</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>æœ€å</strong>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ApplyParallaxå‡½æ•°ä½¿ç”¨åˆ‡çº¿ç©ºé—´è§†å›¾æ–¹å‘äº†ã€‚é¦–å…ˆï¼Œå¯¹å®ƒè¿›è¡Œè§„æ ¼åŒ–normalizeï¼ŒæŠŠå®ƒå˜æˆä¸€ä¸ªåˆé€‚çš„æ–¹å‘å‘é‡ã€‚ç„¶åï¼Œæ·»åŠ å®ƒçš„XYç»„ä»¶åˆ°çº¹ç†åæ ‡ï¼Œå†ç”±è§†å·®å¼ºåº¦ç¼©æ”¾ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">ApplyParallax</span> <span class="p">(</span><span class="k">inout</span> <span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="cp">#if defined(_PARALLAX_MAP)
</span>        <span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">);</span>
        <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="o">+=</span> <span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">xy</span> <span class="o">*</span> <span class="n">_ParallaxStrength</span><span class="p">;</span>
    <span class="cp">#endif
</span><span class="p">}</span>
</code></pre></div></div>

<p>è¿™èƒ½æœ‰æ•ˆåœ°å°†è§†å›¾æ–¹å‘æŠ•å½±åˆ°çº¹ç†è¡¨é¢ä¸Šã€‚å½“ä»¥90åº¦è§’ç›´è§†è¡¨é¢æ—¶ï¼Œåœ¨åˆ‡ç©ºé—´ä¸­çš„è§†å›¾æ–¹å‘ç­‰äºè¡¨é¢æ³•çº¿(0,0,1)ï¼Œè¿™ä¸ä¼šå¯¼è‡´ä½ç§»ã€‚è§†è§’è¶Šæµ…ï¼ŒæŠ•å½±è¶Šå¤§ï¼Œä½ç§»æ•ˆæœä¹Ÿè¶Šå¤§ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200617192800432-1757806048.png" width="250" /><font size="2.5">
            <i>å½±è§†å›¾æ–¹å‘ç”¨ä½œUVåç§».</i>
        </font></center>

<p>æ‰€æœ‰è¿™ä¸€åˆ‡çš„å½±å“æ˜¯è¡¨é¢ä¼¼ä¹è¢«æ‹‰å‘ä¸Šçš„åˆ‡çº¿ç©ºé—´ï¼Œçœ‹èµ·æ¥æ¯”å®ƒå®é™…ä¸Šæ›´é«˜ï¼ŒåŸºäºè§†å·®å¼ºåº¦ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200618012940748-384205609.gif" width="250" /><font size="2.5">
            <i>éšæŠ•å½±è§†è§’æ–¹å‘ç§»åŠ¨UV.</i>
        </font></center>

<h3 id="åŸºäºé«˜åº¦æ»‘åŠ¨">åŸºäºé«˜åº¦æ»‘åŠ¨</h3>

<p>åœ¨åŸºäºé«˜åº¦è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥è®©è¡¨é¢çœ‹èµ·æ¥æ›´é«˜ï¼Œä½†å®ƒä»ç„¶æ˜¯ä¸€ä¸ªå‡åŒ€ä½ç§»ã€‚ä¸‹ä¸€æ­¥æ˜¯ä½¿ç”¨è§†å·®è´´å›¾æ¥ç¼©æ”¾ä½ç§»ã€‚é‡‡æ ·è´´å›¾ï¼Œä½¿ç”¨å®ƒçš„Gé€šé“ä½œä¸ºé«˜åº¦ï¼Œåº”ç”¨è§†å·®å¼ºåº¦ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥è°ƒèŠ‚ä½ç§»ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">);</span>
<span class="n">float</span> <span class="n">height</span> <span class="o">=</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_ParallaxMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">).</span><span class="n">g</span><span class="p">;</span>
<span class="n">height</span> <span class="o">*=</span> <span class="n">_ParallaxStrength</span><span class="p">;</span>
<span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="o">+=</span> <span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">xy</span> <span class="o">*</span> <span class="n">height</span><span class="p">;</span>
</code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200618012942351-290008046.gif" width="250" /><font size="2.5">
            <i>ç”±é«˜åº¦è°ƒæ•´çš„ç§»åŠ¨.</i>
        </font></center>

<p>ä½çš„åŒºåŸŸç°åœ¨ä¿æŒä¸å˜ï¼Œè€Œé«˜çš„åŒºåŸŸè¢«å‘ä¸Šæ‹‰ã€‚standard shaderæŠµæ¶ˆäº†è¿™ç§æ•ˆæœï¼Œæ‰€ä»¥ä½çš„åŒºåŸŸä¹Ÿå‘ä¸‹ç§»åŠ¨ï¼Œè€Œåœ¨ä¸­é—´çš„åŒºåŸŸä¿æŒä»–ä»¬åŸæ¥çš„ä½ç½®ã€‚è¿™æ˜¯é€šè¿‡ä»åŸå§‹é«˜åº¦æ•°æ®ä¸­å‡å»å·®å€¼æ¥å®ç°çš„ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float</span> <span class="n">height</span> <span class="o">=</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_ParallaxMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">).</span><span class="n">g</span><span class="p">;</span>
<span class="n">height</span> <span class="o">-=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
<span class="n">height</span> <span class="o">*=</span> <span class="n">_ParallaxStrength</span><span class="p">;</span>
</code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200618012944095-1997194416.gif" width="250" /><font size="2.5">
            <i>è§†å·®è´´å›¾æ•ˆæœ ç”±åˆç†åˆ°è¿‡é‡.</i>
        </font></center>

<p>è¿™å°±äº§ç”Ÿäº†æˆ‘ä»¬æƒ³è¦çš„è§†å·®æ•ˆæœï¼Œä½†å®ƒåªåœ¨ä½å¼ºåº¦ä¸‹æœ‰æ•ˆã€‚ä¸è¶³çš„æ˜¯ä½ç§»ä½ç§»å˜æ¢çš„å¾ˆå¿«ï¼Œä¼šæ’•è£‚è¡¨é¢ã€‚</p>

<h3 id="åç§»è§†å·®æ˜ å°„ç®—æ³•">åç§»è§†å·®æ˜ å°„ç®—æ³•</h3>

<p>æˆ‘ä»¬ç›®å‰ä½¿ç”¨çš„è§†å·®æ˜ å°„æŠ€æœ¯è¢«ç§°ä¸ºå¸¦åç§»é™åˆ¶çš„è§†å·®æ˜ å°„ã€‚æˆ‘ä»¬åªæ˜¯ä½¿ç”¨äº†è§†å›¾æ–¹å‘çš„XYéƒ¨åˆ†ï¼Œå®ƒçš„æœ€å¤§é•¿åº¦æ˜¯1ã€‚å› æ­¤ï¼Œçº¹ç†åç§»é‡æ˜¯æœ‰é™çš„ã€‚è¿™ç§æ•ˆæœä¸é”™ï¼Œä½†ä¸èƒ½ä»£è¡¨æ­£ç¡®çš„é€è§†æŠ•å½±ã€‚</p>

<p>ä¸€ä¸ªæ›´ç²¾ç¡®çš„è®¡ç®—åç§»é‡çš„ç‰©ç†æ–¹æ³•æ˜¯å°†é«˜åº¦åœºè§†ä¸ºå‡ ä½•å›¾å½¢è¡¨é¢ä¸‹çš„ä½“ç§¯ï¼Œå¹¶é€šè¿‡å®ƒæ‹æ‘„ä¸€ä¸ªè§†å›¾å°„çº¿ã€‚å…‰çº¿ä»ç›¸æœºå‘å°„åˆ°è¡¨é¢ï¼Œä»ä¸Šé¢è¿›å…¥é«˜åº¦åœºä½“ç§¯ï¼Œå¹¶æŒç»­å‘å°„ç›´åˆ°å®ƒåˆ°è¾¾ç”±åœºå®šä¹‰çš„è¡¨é¢ã€‚</p>

<p>å¦‚æœé«˜åº¦åœºå‡åŒ€ä¸ºé›¶ï¼Œé‚£ä¹ˆå°„çº¿å°±ä¼šä¸€ç›´æŒç»­åˆ°ä½“ç§¯çš„åº•éƒ¨ã€‚å®ƒä¸ç‰©ä½“çš„è·ç¦»å–å†³äºå…‰çº¿è¿›å…¥ç‰©ä½“æ—¶çš„è§’åº¦ã€‚å®ƒæ²¡æœ‰é™åˆ¶ã€‚è§’åº¦è¶Šæµ…ï¼Œè¶Šè¿œã€‚æœ€æç«¯çš„æƒ…å†µæ˜¯å½“è§†è§’è¶‹äº0æ—¶ï¼Œå…‰çº¿å°„å‘æ— ç©·å¤§ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200617192800958-1980748310.png" width="250" /><font size="2.5">
            <i>å…‰çº¿æŠ•å°„åˆ°åº•éƒ¨ï¼Œæœ‰é™ä¸”æ­£ç¡®.</i>
        </font></center>

<p>ä¸ºäº†æ‰¾åˆ°åˆé€‚çš„åç§»é‡ï¼Œæˆ‘ä»¬å¿…é¡»ç¼©æ”¾è§†å›¾æ–¹å‘å‘é‡ï¼Œé€šè¿‡é™¤ä»¥å®ƒè‡ªå·±çš„Zåˆ†é‡æ¥ä½¿å®ƒçš„Zåˆ†é‡å˜æˆ1ã€‚å› ä¸ºæˆ‘ä»¬ä»¥åä¸éœ€è¦ç”¨Zï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨Xå’ŒYé™¤ä»¥Zã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">);</span>
<span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">xy</span> <span class="o">/=</span> <span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
</code></pre></div></div>

<p>è™½ç„¶è¿™æ ·å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ›´æ­£ç¡®çš„æŠ•å½±ï¼Œä½†å®ƒç¡®å®ä¼šä½¿æµ…è§†è§’çš„è§†å·®æ•ˆæœæ¶åŒ–ã€‚standardç€è‰²å™¨é€šè¿‡å¢åŠ 0.42åå·®åˆ°Zå‡è½»æµ…è§†è§’çš„è§†å·®æ•ˆæœæ¶åŒ–ï¼Œæ‰€ä»¥å®ƒæ°¸è¿œä¸ä¼šæ¥è¿‘é›¶ã€‚è¿™æ‰­æ›²äº†é€è§†å›¾ï¼Œä½†ä½¿å·¥ä»¶æ›´æ˜“äºç®¡ç†ã€‚æˆ‘ä»¬å†åŠ ä¸Šè¿™ä¸ªåå·®.</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">xy</span> <span class="o">/=</span> <span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="mi">0</span><span class="p">.</span><span class="mi">42</span><span class="p">);</span>
</code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200617192802151-218582125.png" width="250" /><font size="2.5">
            <i>è§†å·®è´´å›¾åƒæ ‡å‡†ç€è‰²å™¨.</i>
        </font></center>

<p>é€šè¿‡ä¸Šè¿°å¤šä¸ªæ­¥éª¤ä¿®æ­£å, ç°åœ¨æˆ‘ä»¬çš„ç€è‰²å™¨ä¸æ ‡å‡†ç€è‰²å™¨æ”¯æŒåŒæ ·çš„è§†å·®æ•ˆæœã€‚è§†å·®æ˜ å°„å¯ä»¥åº”ç”¨äºä»»ä½•è¡¨é¢ï¼ŒæŠ•å½±å‡è®¾åˆ‡çº¿ç©ºé—´æ˜¯å‡åŒ€çš„ã€‚æ›²é¢å…·æœ‰å¼¯æ›²çš„åˆ‡çº¿ç©ºé—´ï¼Œå› æ­¤ä¼šäº§ç”Ÿç‰©ç†ä¸Šä¸æ­£ç¡®çš„ç»“æœã€‚åªè¦è§†å·®å¼ºåº¦å’Œæ›²ç‡å¾ˆå°ï¼Œä½ å°±å¯ä»¥æ‘†è„±å®ƒã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200617192802555-2049613835.png" width="250" /><font size="2.5">
            <i>çƒé¢è§†å·®è´´å›¾.</i>
        </font></center>

<p>åŒæ ·ï¼Œé˜´å½±åæ ‡ä¸ä¼šå—åˆ°è¿™ä¸ªæ•ˆæœçš„å½±å“ã€‚å› æ­¤ï¼Œé˜´å½±åœ¨å¼ºçƒˆçš„è§†å·®çš„ç»„åˆä¸‹çœ‹èµ·æ¥å¾ˆå¥‡æ€ªï¼Œå¥½åƒæ¼‚æµ®åœ¨è¡¨é¢ä¸Šã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200617192803371-1931947503.png" width="250" /><font size="2.5">
            <i>é˜´å½±ä¸å—è§†å·®å½±å“.</i>
        </font></center>

<h3 id="parallax-configuration">Parallax Configuration</h3>

<p>ä½ ä¸åŒæ„Unityä½¿ç”¨0.42çš„åç§»å€¼å—?æˆ–è€…ä½ æƒ³ä½¿ç”¨ä¸€ä¸ªä¸åŒçš„å€¼ï¼Œè¿˜æ˜¯è®©å®ƒä¿æŒåœ¨0?æˆ–è€…ä½ æƒ³ç”¨åç§»é™åˆ¶ä»£æ›¿å—?å®ƒæ˜¯å¯ä»¥é…ç½®!</p>

<p>å½“ä½ æƒ³ä½¿ç”¨åç§»é™åˆ¶ï¼Œå®šä¹‰<code class="language-plaintext highlighter-rouge">PARALLAX_OFFSET_LIMITING</code>åœ¨ç€è‰²å™¨ã€‚æˆ–è€…ï¼Œé€šè¿‡å®šä¹‰PARALLAX_BIASæ¥è®¾ç½®è¦ä½¿ç”¨çš„åå·®ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">ApplyParallax</span> <span class="p">(</span><span class="k">inout</span> <span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="cp">#if defined(_PARALLAX_MAP)
</span>        <span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">);</span>
        <span class="cp">#if !defined(PARALLAX_OFFSET_LIMITING)
</span>            <span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">xy</span> <span class="o">/=</span> <span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">PARALLAX_BIAS</span><span class="p">);</span>
        <span class="cp">#endif
</span>    <span class="cp">#endif
</span><span class="p">}</span>
</code></pre></div></div>

<p>å½“æ²¡æœ‰å®šä¹‰æ—¶ï¼Œå‡è®¾åå·®æ˜¯0.42ã€‚åœ¨<code class="language-plaintext highlighter-rouge">ApplyParallax</code> ä¸­å®šä¹‰å®ƒã€‚æ³¨æ„ï¼Œå®å®šä¹‰ä¸å…³å¿ƒå‡½æ•°ä½œç”¨åŸŸï¼Œå®ƒä»¬æ€»æ˜¯å…¨å±€çš„ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if !defined(PARALLAX_OFFSET_LIMITING)
</span>    <span class="cp">#if !defined(PARALLAX_BIAS)
</span>        <span class="cp">#define PARALLAX_BIAS 0.42
</span>    <span class="cp">#endif
</span>    <span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">xy</span> <span class="o">/=</span> <span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">PARALLAX_BIAS</span><span class="p">);</span>
<span class="cp">#endif
</span></code></pre></div></div>

<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡ç€è‰²å™¨çš„CGINCLUDEå—æ¥å¾®è°ƒæˆ‘ä»¬çš„è§†å·®æ•ˆæœã€‚æ·»åŠ æ— åå·®å’Œé™åˆ¶åç§»çš„é€‰é¡¹ï¼Œä½†å°†å®ƒä»¬è½¬æ¢ä¸ºæ³¨é‡Šï¼Œä»¥åšæŒé»˜è®¤é€‰é¡¹ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CGINCLUDE</span>
    <span class="cp">#define BINORMAL_PER_FRAGMENT
</span>    <span class="cp">#define FOG_DISTANCE
</span>
<span class="c1">//	#define PARALLAX_BIAS 0</span>
<span class="c1">//	#define PARALLAX_OFFSET_LIMITING</span>

<span class="n">ENDCG</span>
</code></pre></div></div>

<h3 id="detail-uv">Detail UV</h3>

<p>è§†å·®è´´å›¾å¯ä»¥åœ¨ä¸»è´´å›¾ä¸Šå·¥ä½œï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰æ³¨æ„åˆ°å‰¯è´´å›¾ã€‚æˆ‘ä»¬å¿…é¡»åº”ç”¨çº¹ç†åæ ‡åç§»åˆ°ç»†èŠ‚UVä¸Šã€‚</p>

<p>é¦–å…ˆï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªåŒ…å«ç½‘æ ¼æ¨¡å¼çš„è¯¦ç»†åœ°å›¾ã€‚å®ƒå¯ä»¥å¾ˆå®¹æ˜“åœ°éªŒè¯æ•ˆæœæ˜¯å¦æ­£ç¡®åœ°åº”ç”¨äºç»†èŠ‚ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200617192803893-1797850325.png" width="250" /><font size="2.5">
            <i>ç»†èŠ‚ç½‘æ ¼çº¹ç†.</i>
        </font></center>

<p>ä½¿ç”¨è¿™ä¸ªçº¹ç†ä½œä¸ºæè´¨çš„ç»†èŠ‚albedoè´´å›¾ã€‚è®¾ç½®äºŒçº§è´´å›¾çš„å¹³é“ºä¸º10Ã—10ã€‚è¿™è¡¨æ˜ï¼Œç»†èŠ‚ç´«å¤–çº¿ç¡®å®ä»ç„¶ä¸å—å½±å“ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200617192804491-290326603.png" width="250" /><body></body>
        <img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200617192805295-1360127209.png" width="250" /><font size="2.5">
            <i>ç»†èŠ‚UVä¸å—å½±å“.</i>
        </font></center>

<p>Standardä¹Ÿç®€å•åœ°æ·»åŠ äº†UVåç§»åˆ°ç»†èŠ‚UVï¼Œè¿™æ˜¯å­˜å‚¨åœ¨UVæ’å€¼å™¨çš„ZWç»„ä»¶ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float</span> <span class="n">height</span> <span class="o">=</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_ParallaxMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">).</span><span class="n">g</span><span class="p">;</span>
<span class="n">height</span> <span class="o">-=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
<span class="n">height</span> <span class="o">*=</span> <span class="n">_ParallaxStrength</span><span class="p">;</span>
<span class="kt">float2</span> <span class="n">uvOffset</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">xy</span> <span class="o">*</span> <span class="n">height</span><span class="p">;</span>
<span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="o">+=</span> <span class="n">uvOffset</span><span class="p">;</span>
<span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span> <span class="o">+=</span> <span class="n">uvOffset</span><span class="p">;</span>
</code></pre></div></div>

<p>ç»†èŠ‚å¯èƒ½æœ‰æ‰€å˜åŒ–ï¼Œä½†æ˜¯å®ƒä»¬è‚¯å®šè¿˜ä¸åŒ¹é…è§†å·®æ•ˆæœã€‚ é‚£æ˜¯å› ä¸ºæˆ‘ä»¬å¹³é“ºäº†äºŒçº§çº¹ç†ã€‚ è¿™æ ·ä¼šå°†ç»†èŠ‚UVç¼©æ”¾10å€ï¼Œä½¿è§†å·®åç§»é‡å˜å¼±åå€ã€‚ æˆ‘ä»¬è¿˜å¿…é¡»å°†ç»†èŠ‚æ‹¼è´´åº”ç”¨åˆ°åç§»é‡ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span> <span class="o">+=</span> <span class="n">uvOffset</span> <span class="o">*</span> <span class="n">_DetailTex_ST</span><span class="p">.</span><span class="n">xy</span><span class="p">;</span>
</code></pre></div></div>

<p>å®é™…ä¸Šï¼Œç¼©æ”¾åº”è¯¥ç›¸å¯¹äºä¸»UVå¹³é“ºï¼Œä»¥é˜²å®ƒè¢«è®¾ç½®ä¸º1Ã—1ä»¥å¤–çš„ä¸€äº›ä¸œè¥¿ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span> <span class="o">+=</span> <span class="n">uvOffset</span> <span class="o">*</span> <span class="p">(</span><span class="n">_DetailTex_ST</span><span class="p">.</span><span class="n">xy</span> <span class="o">/</span> <span class="n">_MainTex_ST</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
</code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200617192806533-2106069113.png" width="250" /><font size="2.5">
            <i>æ­£ç¡®çš„UV.</i>
        </font></center>

<h2 id="ray-marching-å…‰çº¿æ­¥è¿›">Ray Marching-å…‰çº¿æ­¥è¿›</h2>

<p>ç„¶è€Œï¼Œé™¤äº†ä¸Šè¿°çš„åç§»è§†å·®æ˜ å°„è¿˜æœ‰å¦å¤–çš„è§†å·®ç®—æ³•ï¼šå‘å°„å°„çº¿ä¸é«˜åº¦åœºä½“ç§¯ç›¸äº¤ï¼Œç¡®å®šå…¶äº¤ç‚¹åœ¨è¡¨é¢ä¸Šçš„ä½ç½®ï¼Œç„¶åå¯¹è¯¥ä½ç½®é‡‡æ ·ã€‚ å®ƒé€šè¿‡åœ¨å°„çº¿è¿›å…¥ä½“ç§¯æ—¶çš„äº¤ç‚¹ï¼Œå¯¹é«˜åº¦å›¾è¿›è¡Œä¸€æ¬¡é‡‡æ ·ã€‚ ä½†æ˜¯ï¼Œå½“çœ‹å‘ä»»æ„ä¸€ä¸ªè§’åº¦æ—¶ï¼Œè¿™å¹¶ä¸èƒ½å‡†ç¡®å‘Šè¯‰å°„çº¿å®é™…ä¸Šä¸é«˜åº¦åœºç›¸äº¤çš„é«˜åº¦ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200617192807160-2024700857.png" width="250" /><font size="2.5">
            <i>å®é™…ä¸é¢„æµ‹çš„é«˜åº¦å¯¹æ¯”.</i>
        </font></center>

<p>å…ˆå‡è®¾å…¥å£ç‚¹çš„é«˜åº¦ä¸äº¤ç‚¹çš„é«˜åº¦ç›¸åŒï¼Œä½†è¿™å®é™…ä¸Šåªæœ‰åœ¨å…¥å£ç‚¹å’Œäº¤ç‚¹å…·æœ‰ç›¸åŒçš„é«˜åº¦æ—¶æ‰æ˜¯æ­£ç¡®çš„ã€‚å½“åç§»é‡ä¸å¤§ä¸”é«˜åº¦åœºå˜åŒ–ä¸å¤§æ—¶ï¼Œå®ƒçš„æ•ˆæœä»ç„¶å¾ˆå¥½ã€‚ä½†æ˜¯ï¼Œå½“åç§»é‡å¤ªå¤§æˆ–é«˜åº¦å˜åŒ–å¤ªå¿«æ—¶ï¼Œè¯¥ç®—æ³•å°±ä¼šå‡ºç°é—®é¢˜ï¼Œè€Œè¿™å¾ˆå¯èƒ½æ˜¯é”™è¯¯çš„ã€‚è¿™å°±ä¼šé€ æˆè¡¨é¢æ’•è£‚ã€‚</p>

<p>å¦‚æœæˆ‘ä»¬èƒ½ç®—å‡ºå°„çº¿å®é™…åˆ°è¾¾çš„é«˜åº¦åœºçš„ä½ç½®ï¼Œé‚£ä¹ˆæ€»èƒ½æ‰¾åˆ°çœŸæ­£çš„å¯è§è¡¨é¢ç‚¹ã€‚è¿™ä¸èƒ½é€šè¿‡å•ä¸ªçº¹ç†æ ·æœ¬æ¥å®ç°ï¼Œæˆ‘ä»¬å¿…é¡»æ²¿ç€è§†å›¾å°„çº¿é€æ­¥ç§»åŠ¨ï¼Œå¹¶æ¯æ¬¡éƒ½é‡‡æ ·é«˜åº¦åœºï¼Œç›´åˆ°å°„çº¿åˆ°è¾¾è¡¨é¢ã€‚è¯¥æŠ€æœ¯æ˜¯RayMarchingã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200617192807679-1545265192.png" width="250" /><font size="2.5">
            <i>éšè§†å›¾å°„çº¿å‰è¿›.</i>
        </font></center>

<p>æœ‰å„ç§ä¸åŒçš„è§†å·®è´´å›¾ä½¿ç”¨raymarchingã€‚å¸¸è§çš„æ˜¯é™¡è§†å·®æ˜ å°„_Steep Parallax Mapping_ã€åœ°å½¢æ˜ å°„_Relief Mapping_å’Œè§†å·®é®æŒ¡æ˜ å°„_Parallax Occlusion Mapping_ã€‚ä¸ä½¿ç”¨å•ä¸€çº¹ç†æ ·æœ¬ç›¸æ¯”ï¼Œå®ƒä»¬èƒ½é€šè¿‡é«˜åº¦åœºæ¥åˆ›å»ºæ›´å¥½çš„è§†å·®æ•ˆæœã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒä»¬è¿˜å¯ä»¥åº”ç”¨é¢å¤–çš„é˜´å½±å’ŒæŠ€æœ¯æ¥æ”¹è¿›è¯¥ç®—æ³•ã€‚å½“æˆ‘ä»¬åšçš„åŒ¹é…è¿™äº›æ–¹æ³•æ—¶ï¼Œæˆ‘ä¼šè°ƒç”¨å®ƒã€‚</p>

<h3 id="è‡ªå®šä¹‰è§†å·®å‡½æ•°">è‡ªå®šä¹‰è§†å·®å‡½æ•°</h3>

<p>æ ‡å‡†ç€è‰²å™¨ä»…æ”¯æŒç®€å•çš„åç§»è§†å·®æ˜ å°„ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬è¦åœ¨è‡ªå·±çš„ç€è‰²å™¨ä¸­æ·»åŠ å¯¹è§†å·®å…‰çº¿Ray marchingçš„æ”¯æŒã€‚ ä½†æ˜¯ï¼Œæˆ‘ä»¬è¿˜è¦ç»§ç»­æ”¯æŒè¿™ç§ç®€å•æ–¹æ³•ã€‚ ä¸¤è€…éƒ½éœ€è¦é‡‡æ ·heightå­—æ®µï¼Œå› æ­¤å°†é‡‡æ ·ä»£ç è¡Œæ”¾åœ¨å•ç‹¬çš„GetParallaxHeightå‡½æ•°ä¸­ã€‚ è€Œä¸”ï¼Œä¸¤ç§æ–¹æ³•çš„æŠ•å½±è§†å›¾æ–¹å‘å’Œåç§»é‡çš„æœ€ç»ˆåº”ç”¨éƒ½ç›¸åŒã€‚ å› æ­¤ï¼Œå°†åç§»é‡è®¡ç®—ä¹Ÿå•ç‹¬ä¸ºä¸€ä¸ªå‡½æ•°ã€‚ å®ƒä»…éœ€è¦åŸå§‹UVåæ ‡å’Œå·²å¤„ç†çš„è§†å›¾æ–¹å‘ä½œä¸ºå‚æ•°ï¼Œç»“æœè¿”å›è¦åº”ç”¨çš„UVåç§»ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float</span> <span class="nf">GetParallaxHeight</span> <span class="p">(</span><span class="kt">float2</span> <span class="n">uv</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_ParallaxMap</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">g</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float2</span> <span class="nf">ParallaxOffset</span> <span class="p">(</span><span class="kt">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="kt">float2</span> <span class="n">viewDir</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float</span> <span class="n">height</span> <span class="o">=</span> <span class="n">GetParallaxHeight</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>
    <span class="n">height</span> <span class="o">-=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
    <span class="n">height</span> <span class="o">*=</span> <span class="n">_ParallaxStrength</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">viewDir</span> <span class="o">*</span> <span class="n">height</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ApplyParallax</span> <span class="p">(</span><span class="k">inout</span> <span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="cp">#if defined(_PARALLAX_MAP)
</span>        <span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">);</span>
        <span class="cp">#if !defined(PARALLAX_OFFSET_LIMITING)
</span>            <span class="cp">#if !defined(PARALLAX_BIAS)
</span>                <span class="cp">#define PARALLAX_BIAS 0.42
</span>            <span class="cp">#endif
</span>            <span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">xy</span> <span class="o">/=</span> <span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">PARALLAX_BIAS</span><span class="p">);</span>
        <span class="cp">#endif
</span>
        <span class="kt">float2</span> <span class="n">uvOffset</span> <span class="o">=</span> <span class="n">ParallaxOffset</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
        <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="o">+=</span> <span class="n">uvOffset</span><span class="p">;</span>
        <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span> <span class="o">+=</span> <span class="n">uvOffset</span> <span class="o">*</span> <span class="p">(</span><span class="n">_DetailTex_ST</span><span class="p">.</span><span class="n">xy</span> <span class="o">/</span> <span class="n">_MainTex_ST</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
    <span class="cp">#endif
</span><span class="p">}</span>
</code></pre></div></div>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†åº”ç”¨è§†å·®å‡½æ•°å®æ›¿æ¢å¯¹è§†å·®åç§»çš„ç¡¬ç¼–ç è°ƒç”¨ï¼Œä»è€Œä½¿è§†å·®æ–¹æ³•æ›´åŠ çµæ´»ã€‚å¦‚æœæ²¡æœ‰å®šä¹‰å®ƒï¼Œæˆ‘ä»¬å°†å®ƒè®¾ç½®ä¸ºä½¿ç”¨åç§»é‡æ–¹æ³•ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">ApplyParallax</span> <span class="p">(</span><span class="k">inout</span> <span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="cp">#if defined(_PARALLAX_MAP)
</span>        <span class="c1">//...</span>
        <span class="cp">#if !defined(PARALLAX_FUNCTION)
</span>            <span class="cp">#define PARALLAX_FUNCTION ParallaxOffset
</span>        <span class="cp">#endif
</span>        <span class="kt">float2</span> <span class="n">uvOffset</span> <span class="o">=</span> <span class="n">PARALLAX_FUNCTION</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
        <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="o">+=</span> <span class="n">uvOffset</span><span class="p">;</span>
        <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span> <span class="o">+=</span> <span class="n">uvOffset</span> <span class="o">*</span> <span class="p">(</span><span class="n">_DetailTex_ST</span><span class="p">.</span><span class="n">xy</span> <span class="o">/</span> <span class="n">_MainTex_ST</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
    <span class="cp">#endif
</span><span class="p">}</span>
</code></pre></div></div>

<p>ä¸ºRayMarchingæ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°å‡½æ•°ã€‚ä¸ParallaxOffsetå‡½æ•°ç±»ä¼¼çš„å‚æ•°å’Œè¿”å›ç±»å‹ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float2</span> <span class="nf">ParallaxOffset</span> <span class="p">(</span><span class="kt">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="kt">float2</span> <span class="n">viewDir</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kt">float2</span> <span class="nf">ParallaxRaymarching</span> <span class="p">(</span><span class="kt">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="kt">float2</span> <span class="n">viewDir</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float2</span> <span class="n">uvOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">uvOffset</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç°åœ¨å¯ä»¥é€šè¿‡å®šä¹‰_PARALLAX_FUNCTION_æ¥æ”¹å˜ç€è‰²å™¨ä¸­çš„è§†å·®æ–¹æ³•ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define PARALLAX_BIAS 0
</span><span class="c1">//#define PARALLAX_OFFSET_LIMITING</span>
<span class="cp">#define PARALLAX_FUNCTION ParallaxRaymarching
</span></code></pre></div></div>

<h3 id="ç›¸äº¤è®¡ç®—">ç›¸äº¤è®¡ç®—</h3>

<p>ä¸ºäº†æ‰¾åˆ°è§†å›¾å°„çº¿åˆ°è¾¾é«˜åº¦åœºçš„ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å°„çº¿ä¸Šçš„å¤šä¸ªç‚¹è¿›è¡Œé‡‡æ ·å¹¶è®¡ç®—å‡ºåœ¨è¡¨é¢ä¸‹æ–¹çš„ä½ç½®ã€‚ç¬¬ä¸€ä¸ªé‡‡æ ·ç‚¹åœ¨é¡¶éƒ¨ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè¾“å…¥é«˜åº¦é‡ï¼Œå°±åƒä½¿ç”¨åç§»æ–¹æ³•ä¸€æ ·ã€‚æœ€åä¸€ä¸ªé‡‡æ ·ç‚¹å°±æ˜¯å°„çº¿åˆ°è¾¾ä½“ç§¯åº•éƒ¨çš„åœ°æ–¹ã€‚æˆ‘ä»¬ä¼šåœ¨è¿™äº›ç«¯ç‚¹ä¹‹é—´å‡åŒ€åœ°æ·»åŠ é¢å¤–çš„é‡‡æ ·ç‚¹ã€‚</p>

<p>å‡è®¾æ¯æ¡å°„çº¿è¿›è¡Œ10æ¬¡é‡‡æ ·ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å°†å¯¹é«˜åº¦å›¾é‡‡æ ·10æ¬¡è€Œä¸æ˜¯ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™ä¸æ˜¯ä¸€ä¸ªä¾¿å®œè®¡ç®—æ–¹æ³•ã€‚å› ä¸ºæˆ‘ä»¬ç”¨äº†10ä¸ªæ ·æœ¬ï¼Œæ‰€ä»¥æ­¥é•¿æ˜¯0.1ã€‚è¿™æ˜¯æˆ‘ä»¬æ²¿ç€è§†å›¾å°„çº¿ç§»åŠ¨çš„å› å­ï¼Œä¹Ÿå°±æ˜¯UVåç§»å¢é‡ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float2</span> <span class="nf">ParallaxRaymarching</span> <span class="p">(</span><span class="kt">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="kt">float2</span> <span class="n">viewDir</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float2</span> <span class="n">uvOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">stepSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">float2</span> <span class="n">uvDelta</span> <span class="o">=</span> <span class="n">viewDir</span> <span class="o">*</span> <span class="n">stepSize</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">uvOffset</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸ºäº†åº”ç”¨è§†å·®å¼ºåº¦ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒæ•´æ¯ä¸€æ­¥é‡‡æ ·çš„é«˜åº¦ã€‚ä½†æ˜¯ç¼©æ”¾UV deltaä¹Ÿæœ‰åŒæ ·çš„æ•ˆæœï¼Œåªéœ€è¦è®¡ç®—ä¸€æ¬¡ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float2</span> <span class="n">uvDelta</span> <span class="o">=</span> <span class="n">viewDir</span> <span class="o">*</span> <span class="p">(</span><span class="n">stepSize</span> <span class="o">*</span> <span class="n">_ParallaxStrength</span><span class="p">);</span>
</code></pre></div></div>

<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ— è®ºè§†å·®å¼ºåº¦å¦‚ä½•ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ç»§ç»­ä½¿ç”¨0â€“1ä½œä¸ºé«˜åº¦åœºçš„èŒƒå›´ã€‚ å› æ­¤ï¼Œå°„çº¿çš„ç¬¬ä¸€æ­¥é«˜åº¦å§‹ç»ˆä¸º1ã€‚ä½äºæˆ–é«˜äºè¯¥é«˜åº¦çš„è¡¨é¢ç‚¹çš„é«˜åº¦ç”±é«˜åº¦åœºå®šä¹‰ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float</span> <span class="n">stepSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">;</span><span class="c1">//æ­¥é•¿</span>
<span class="kt">float2</span> <span class="n">uvDelta</span> <span class="o">=</span> <span class="n">viewDir</span> <span class="o">*</span> <span class="p">(</span><span class="n">stepSize</span> <span class="o">*</span> <span class="n">_ParallaxStrength</span><span class="p">);</span>
<span class="n">float</span> <span class="n">stepHeight</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//æ­¥é«˜</span>
<span class="n">float</span> <span class="n">surfaceHeight</span> <span class="o">=</span> <span class="n">GetParallaxHeight</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>
</code></pre></div></div>

<p>ç°åœ¨æˆ‘ä»¬è¦æ²¿ç€å°„çº¿è¿­ä»£ã€‚<strong>é¦–å…ˆ</strong>ï¼Œæ¯ä¸€æ­¥æˆ‘ä»¬éƒ½ä¼šå¢åŠ UVåç§»é‡ã€‚è§†å›¾å‘é‡æŒ‡å‘æ‘„åƒæœºï¼Œä½†æˆ‘ä»¬æ˜¯åœ¨å‘è¡¨é¢ç§»åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å‡å»UV deltaã€‚<strong>ç„¶å</strong>æˆ‘ä»¬ç”¨æ­¥é«˜æ¥å‡å°æ­¥é•¿ã€‚<strong>ç„¶å</strong>æˆ‘ä»¬å†æ¬¡å¯¹é«˜åº¦å›¾é‡‡æ ·ã€‚ä½¿ç”¨whileå¾ªç¯é‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œç›´åˆ°é‡‡æ ·å®Œæ¯•ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float</span> <span class="n">stepHeight</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">float</span> <span class="n">surfaceHeight</span> <span class="o">=</span> <span class="n">GetParallaxHeight</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>

<span class="k">while</span> <span class="p">(</span><span class="n">stepHeight</span> <span class="o">&gt;</span> <span class="n">surfaceHeight</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uvOffset</span> <span class="o">-=</span> <span class="n">uvDelta</span><span class="p">;</span>
    <span class="n">stepHeight</span> <span class="o">-=</span> <span class="n">stepSize</span><span class="p">;</span>
    <span class="n">surfaceHeight</span> <span class="o">=</span> <span class="n">GetParallaxHeight</span><span class="p">(</span><span class="n">uv</span> <span class="o">+</span> <span class="n">uvOffset</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å½“ç¼–è¯‘æ—¶ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªç¼–è¯‘å™¨è­¦å‘Šå’Œé”™è¯¯ã€‚è¿™ä¸ªè­¦å‘Šå‘Šè¯‰æˆ‘ä»¬åœ¨å¾ªç¯ä¸­ä½¿ç”¨äº†æ¢¯åº¦æŒ‡ä»¤ã€‚è¿™æŒ‡çš„æ˜¯å¾ªç¯ä¸­çš„çº¹ç†é‡‡æ ·ã€‚GPUå¿…é¡»å¼„æ¸…æ¥šä½¿ç”¨å“ªä¸ªmipmapçº§åˆ«ï¼Œå®ƒéœ€è¦æ¯”è¾ƒç›¸é‚»ç‰‡æ®µä½¿ç”¨çš„UVåæ ‡ã€‚åªæœ‰å½“æ‰€æœ‰ç‰‡æ®µæ‰§è¡Œç›¸åŒçš„ä»£ç æ—¶ï¼Œå®ƒæ‰èƒ½å¯¹æ¯”ã€‚å¯¹äºå¾ªç¯æ¥è¯´ï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºå®ƒå¯ä»¥æå‰ç»ˆæ­¢ï¼Œæ¯ä¸ªç‰‡æ®µéƒ½å¯èƒ½ä¸åŒã€‚å› æ­¤ç¼–è¯‘å™¨å°†å±•å¼€å¾ªç¯ï¼Œè¿™æ„å‘³ç€å®ƒå°†ä¸€ç›´æ‰§è¡Œæ‰€æœ‰9ä¸ªæ­¥éª¤ï¼Œè€Œä¸ç®¡é€»è¾‘æ˜¯å¦å¯ä»¥æå‰åœæ­¢ã€‚ç›¸åï¼Œå®ƒéšåä½¿ç”¨ç¡®å®šæ€§é€»è¾‘é€‰æ‹©æœ€ç»ˆç»“æœã€‚</p>

<p>ç¼–è¯‘å¤±è´¥æ˜¯å› ä¸ºç¼–è¯‘å™¨æ— æ³•ç¡®å®šå¾ªç¯çš„æœ€å¤§è¿­ä»£æ¬¡æ•°ã€‚å®ƒä¸çŸ¥é“è¿™ä¸ªæœ€å¤šæ˜¯9ã€‚é€šè¿‡å°†whileå¾ªç¯è½¬æ¢ä¸ºæ‰§è¡Œé™åˆ¶çš„forå¾ªç¯æ¥æ˜ç¡®è¿™ä¸€ç‚¹ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">stepHeight</span> <span class="o">&gt;</span> <span class="n">surfaceHeight</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uvOffset</span> <span class="o">-=</span> <span class="n">uvDelta</span><span class="p">;</span>
    <span class="n">stepHeight</span> <span class="o">-=</span> <span class="n">stepSize</span><span class="p">;</span>
    <span class="n">surfaceHeight</span> <span class="o">=</span> <span class="n">GetParallaxHeight</span><span class="p">(</span><span class="n">uv</span> <span class="o">+</span> <span class="n">uvOffset</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200618012945572-448280189.png" width="250" /><font size="2.5">
            <i>Raymarching æ­¥è¿›10æ¬¡ æ— åå·®, æ— é™åˆ¶.</i>
        </font></center>

<p>ä¸ç®€å•çš„è§†å·®åç§»æ–¹æ³•ç›¸æ¯”ï¼Œè§†å·®æ•ˆæœæ›´åŠ æ˜æ˜¾ã€‚è¾ƒé«˜çš„åŒºåŸŸç°åœ¨ä¹Ÿæ­£ç¡®åœ°é˜»æŒ¡äº†æˆ‘ä»¬åé¢è¾ƒä½åŒºåŸŸçš„è§†é‡ã€‚æˆ‘ä»¬è¿˜å¾—åˆ°äº†æ˜æ˜¾çš„å›¾å±‚ï¼Œæ€»å…±10å±‚ã€‚</p>

<h3 id="æ›´å¤šæ­¥è¿›">æ›´å¤šæ­¥è¿›</h3>

<p>è¿™ä¸ªåŸºæœ¬çš„å…‰çº¿è¡Œè¿›æ–¹æ³•æœ€é€‚åˆé™¡å³­çš„è§†å·®è´´å›¾ã€‚æ•ˆæœçš„è´¨é‡æ˜¯ç”±æˆ‘ä»¬çš„æ ·æœ¬åˆ†è¾¨ç‡å†³å®šçš„ã€‚ä¸€äº›æ–¹æ³•æ ¹æ®è§†è§’ä½¿ç”¨å¯å˜çš„æ­¥éª¤ã€‚è¾ƒæµ…çš„è§’åº¦éœ€è¦æ›´å¤šçš„æ­¥é•¿ï¼Œå› ä¸ºå…‰çº¿è¾ƒé•¿ã€‚ä½†æˆ‘ä»¬çš„æ ·æœ¬é‡æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ä¼šè¿™æ ·åšã€‚</p>

<p>æé«˜è´¨é‡çš„æ˜æ˜¾æ–¹æ³•æ˜¯å¢åŠ é‡‡æ ·çš„æ¬¡æ•°ï¼Œå› æ­¤è®©å…¶å¯é…ç½®ã€‚ä½¿ç”¨_PARALLAX_RAYMARCHING_STEPS_ï¼Œé»˜è®¤å€¼ä¸º10ï¼Œè€Œä¸æ˜¯å›ºå®šçš„æ­¥é•¿å’Œè¿­ä»£æ¬¡æ•°ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float2</span> <span class="nf">ParallaxRaymarching</span> <span class="p">(</span><span class="kt">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="kt">float2</span> <span class="n">viewDir</span><span class="p">)</span> <span class="p">{</span>
    <span class="cp">#if !defined(PARALLAX_RAYMARCHING_STEPS)
</span>        <span class="cp">#define PARALLAX_RAYMARCHING_STEPS 10
</span>    <span class="cp">#endif
</span>    <span class="kt">float2</span> <span class="n">uvOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">stepSize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="n">PARALLAX_RAYMARCHING_STEPS</span><span class="p">;</span>
    <span class="kt">float2</span> <span class="n">uvDelta</span> <span class="o">=</span> <span class="n">viewDir</span> <span class="o">*</span> <span class="p">(</span><span class="n">stepSize</span> <span class="o">*</span> <span class="n">_ParallaxStrength</span><span class="p">);</span>

    <span class="n">float</span> <span class="n">stepHeight</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">surfaceHeight</span> <span class="o">=</span> <span class="n">GetParallaxHeight</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span>
        <span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PARALLAX_RAYMARCHING_STEPS</span> <span class="o">&amp;&amp;</span> <span class="n">stepHeight</span> <span class="o">&gt;</span> <span class="n">surfaceHeight</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="n">uvOffset</span> <span class="o">-=</span> <span class="n">uvDelta</span><span class="p">;</span>
        <span class="n">stepHeight</span> <span class="o">-=</span> <span class="n">stepSize</span><span class="p">;</span>
        <span class="n">surfaceHeight</span> <span class="o">=</span> <span class="n">GetParallaxHeight</span><span class="p">(</span><span class="n">uv</span> <span class="o">+</span> <span class="n">uvOffset</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">uvOffset</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨ç€è‰²å™¨ä¸­æ§åˆ¶æ­¥æ•°ã€‚å¯¹äºçœŸæ­£çš„é«˜è´¨é‡ï¼Œå°†PARALLAX_RAYMARCHING_STEPSå®šä¹‰ä¸º100ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define PARALLAX_BIAS 0
</span><span class="c1">//#define PARALLAX_OFFSET_LIMITING</span>
<span class="cp">#define PARALLAX_RAYMARCHING_STEPS 100
#define PARALLAX_FUNCTION ParallaxRaymarching
</span></code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200618012948054-536464296.png" width="250" /><font size="2.5">
            <i>Raymarching 100æ¬¡é‡‡æ ·.</i>
        </font></center>

<p>è¿™è®©æˆ‘ä»¬çŸ¥é“äº†å®ƒçš„æ•ˆæœèƒ½æœ‰å¤šå¥½ï¼Œä½†å®ƒè®¡ç®—é‡å¤ªå¤§äº†ï¼Œä¸€èˆ¬ä¸é€‚åˆæ‰‹æœºã€‚æ‰€ä»¥æŠŠæ ·æœ¬æ•°è®¾ä¸º10åï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥çœ‹åˆ°è§†å·®æ•ˆæœçœ‹èµ·æ¥è¿ç»­å’Œå¹³æ»‘ã€‚ç„¶è€Œï¼Œç”±è§†å·®é®æŒ¡å¼•èµ·çš„è½®å»“æ€»æ˜¯é”¯é½¿çŠ¶çš„ï¼ŒMSAAå¹¶ä¸èƒ½æ¶ˆé™¤è¿™ä¸€ç‚¹ï¼Œå› ä¸ºå®ƒåªé€‚ç”¨äºå‡ ä½•å›¾å½¢çš„è¾¹ç¼˜ï¼Œè€Œä¸æ˜¯çº¹ç†æ•ˆæœã€‚åªè¦ä¸ä¾èµ–æ·±åº¦ç¼“å†²åŒºï¼Œåå¤„ç†æŠ—é”¯é½¿æŠ€æœ¯èƒ½è§£å†³ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ä¸èƒ½æŒ‰ç‰‡æ®µå†™å…¥æ·±åº¦ç¼“å†²åŒºå—?
è¿™åœ¨è¶³å¤Ÿå…ˆè¿›çš„ç¡¬ä»¶ä¸Šç¡®å®æ˜¯å¯èƒ½çš„ï¼Œä½¿å®ƒèƒ½å¤Ÿæ­£ç¡®åœ°ä¸é«˜åº¦åœºç›¸äº¤å¹¶åº”ç”¨é˜´å½±ã€‚ä¸è¿‡ï¼Œå®ƒè®¡ç®—é‡å¤ªå¤§ã€‚
</code></pre></div></div>

<p>æˆ‘ä»¬å½“å‰çš„æ–¹æ³•æ˜¯æ²¿ç€å°„çº¿æ­¥è¿›ï¼Œç›´åˆ°åˆ°è¾¾è¡¨é¢ä»¥ä¸‹çš„ç‚¹ï¼Œæˆ–è€…åˆ°è¾¾å°„çº¿æœ«ç«¯å¯èƒ½çš„æœ€ä½ç‚¹ã€‚ç„¶åæˆ‘ä»¬ç”¨UVåç§»å¤„ç†é‚£ä¸ªç‚¹ã€‚ä½†éšè—åœ¨è¡¨é¢ä¹‹ä¸‹çš„è¿™ä¸ªç‚¹ï¼Œå¾ˆå¯èƒ½ä¼šå‡ºç°é”™è¯¯ã€‚è¿™å°±æ˜¯å¯¼è‡´è¡¨é¢æ’•è£‚çš„åŸå› ã€‚</p>

<p>å¢åŠ æ­¥é•¿æ•°åªä¼šå‡å°‘æœ€å¤§è¯¯å·®ã€‚ä½¿ç”¨è¶³å¤Ÿçš„æ­¥éª¤ï¼Œé”™è¯¯ä¼šå˜å¾—æ›´å°ï¼Œä»¥è‡³äºæˆ‘ä»¬æ— æ³•å†çœ‹åˆ°å®ƒã€‚æ‰€ä»¥å½“ä¸€ä¸ªè¡¨é¢æ€»æ˜¯ä»è¿œå¤„çœ‹ï¼Œä½ å¯ä»¥ç”¨æ›´å°‘çš„æ­¥éª¤ã€‚è·ç¦»è¶Šè¿‘ï¼Œè§†è§’è¶Šå°ï¼Œéœ€è¦çš„æ ·æœ¬å°±è¶Šå¤šã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200618012948690-1598196626.png" width="250" /><font size="2.5">
            <i>Raymarching 100æ¬¡é‡‡æ ·.</i>
        </font></center>

<h3 id="æ­¥é•¿ä¹‹é—´æ’å€¼">æ­¥é•¿ä¹‹é—´æ’å€¼</h3>

<p>æé«˜è´¨é‡çš„ä¸€ç§æ–¹æ³•æ˜¯æ ¹æ®ç»éªŒé¢„æµ‹å…‰çº¿çœŸæ­£åˆ°è¾¾è¡¨é¢çš„ä½ç½®ã€‚æ¯”å¦‚ç¬¬ä¸€æ­¥åœ¨è¡¨é¢ä¹‹ä¸Šï¼Œä¸‹ä¸€æ­¥åœ¨è¡¨é¢ä¹‹ä¸‹ã€‚åœ¨è¿™ä¸¤æ­¥ä¹‹é—´çš„æŸä¸ªç‚¹å°„çº¿ä¸€å®šåˆ°è¾¾äº†è¡¨é¢ã€‚</p>

<p>ä¸¤ä¸ªå°„çº¿ç‚¹ã€å’Œä¸¤ä¸ªå°„çº¿ç‚¹åˆ°è¡¨é¢æœ€è¿‘çš„ç‚¹ï¼Œèƒ½å®šä¹‰ä¸¤æ¡çº¿æ®µã€‚å› ä¸ºå…‰çº¿å’Œè¡¨é¢ç¢°æ’ï¼Œè¿™ä¸¤æ¡çº¿æ®µä¼šç›¸äº¤ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬è·Ÿè¸ªå‰é¢çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¾ªç¯ä¹‹åæ‰§è¡Œç›´çº¿äº¤å‰ã€‚æˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªä¿¡æ¯æ¥è¿‘ä¼¼å‡ºçœŸæ­£çš„äº¤ç‚¹ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200618012949277-977122761.png" width="250" /><font size="2.5">
            <i>æ‰§è¡Œç›´çº¿äº¤å‰.</i>
        </font></center>

<p>åœ¨forå¾ªç¯å†…ï¼Œæˆ‘ä»¬å¿…é¡»è·Ÿè¸ªä¹‹å‰çš„UVåç§»é‡ã€æ­¥é•¿é«˜åº¦å’Œè¡¨é¢é«˜åº¦ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™äº›ç­‰äºå¾ªç¯ä¹‹å‰çš„ç¬¬ä¸€ä¸ªæ ·æœ¬ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float2</span> <span class="n">prevUVOffset</span> <span class="o">=</span> <span class="n">uvOffset</span><span class="p">;</span>
<span class="n">float</span> <span class="n">prevStepHeight</span> <span class="o">=</span> <span class="n">stepHeight</span><span class="p">;</span>
<span class="n">float</span> <span class="n">prevSurfaceHeight</span> <span class="o">=</span> <span class="n">surfaceHeight</span><span class="p">;</span>
</code></pre></div></div>

<p>åœ¨å¾ªç¯ä¹‹åï¼Œæˆ‘ä»¬è®¡ç®—è¿™äº›çº¿çš„äº¤ç‚¹ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ’å€¼ä¹‹é—´çš„å‰ç‚¹å’Œåç‚¹çš„UVåç§»ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float</span> <span class="n">prevDifference</span> <span class="o">=</span> <span class="n">prevStepHeight</span> <span class="o">-</span> <span class="n">prevSurfaceHeight</span><span class="p">;</span>
<span class="n">float</span> <span class="n">difference</span> <span class="o">=</span> <span class="n">surfaceHeight</span> <span class="o">-</span> <span class="n">stepHeight</span><span class="p">;</span>
<span class="n">float</span> <span class="n">t</span> <span class="o">=</span> <span class="n">prevDifference</span> <span class="o">/</span> <span class="p">(</span><span class="n">prevDifference</span> <span class="o">+</span> <span class="n">difference</span><span class="p">);</span>
<span class="n">uvOffset</span> <span class="o">=</span> <span class="nb">lerp</span><span class="p">(</span><span class="n">prevUVOffset</span><span class="p">,</span> <span class="n">uvOffset</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>

<span class="k">return</span> <span class="n">uvOffset</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>æ•°å­¦åŸç†ï¼š
è¿™ä¸¤ä¸ªçº¿æ®µå®šä¹‰åœ¨ä¸¤ä¸ªæ ·æœ¬æ­¥éª¤ä¹‹é—´çš„ç©ºé—´å†…ã€‚æˆ‘ä»¬å°†è¿™ä¸ªç©ºé—´çš„å®½åº¦è®¾ç½®ä¸º1ã€‚ä»å‰ä¸€æ­¥åˆ°æœ€åä¸€æ­¥çš„ç›´çº¿ç”±ç‚¹(0ï¼Œa)å’Œç‚¹(1ï¼Œb)å®šä¹‰ï¼Œå…¶ä¸­aæ˜¯å‰ä¸€æ­¥çš„é«˜åº¦ï¼Œbæ˜¯åä¸€æ­¥çš„é«˜åº¦ã€‚å› æ­¤ï¼Œå¯ä»¥ç”¨çº¿æ€§å‡½æ•°'v(t) = a + (b - a)t'æ¥å®šä¹‰è§†å›¾çº¿ã€‚åŒæ ·åœ°ï¼Œé¢çº¿ç”±ç‚¹(0ï¼Œc)å’Œ(1ï¼Œd)å®šä¹‰ï¼Œå‡½æ•°'s(t) = hlsl + (d - hlsl)t'ã€‚

äº¤ç‚¹å­˜åœ¨äºs(t) = v(t)'å¤„ã€‚é‚£ä¹ˆtçš„å€¼æ˜¯å¤šå°‘?
c + (d - c)t = a + (b - a)t
(d - c)t - (b - a)t = a - c
(a - c + d - b)t = a - c
t = (a - c) / (a - c + d - b)
æ³¨æ„:a - cæ˜¯åœ¨t = 0å¤„ç›´çº¿é«˜åº¦çš„ç»å¯¹å·®ã€‚d - bæ˜¯t = 1å¤„çš„ç»å¯¹é«˜åº¦å·®ã€‚
</code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200618012950193-51635460.png" width="250" /><font size="2.5">
            <i>çº¿æ®µäº¤ç‚¹.</i>
        </font></center>

<p>å®é™…ä¸Šï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ’å€¼å™¨æ¥ç¼©æ”¾æˆ‘ä»¬è¦æ·»åŠ åˆ°ä¸Šä¸€ç‚¹ä¸Šçš„UVåç§»é‡ã€‚å®ƒå¯ä»¥å½’ç»“ä¸ºç›¸åŒçš„ä¸œè¥¿ï¼Œåªæ˜¯ç”¨äº†æ›´å°‘çš„æ•°å­¦ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float</span> <span class="n">t</span> <span class="o">=</span> <span class="n">prevDifference</span> <span class="o">/</span> <span class="p">(</span><span class="n">prevDifference</span> <span class="o">-</span> <span class="n">difference</span><span class="p">);</span>
<span class="n">uvOffset</span> <span class="o">=</span> <span class="n">prevUVOffset</span> <span class="o">-</span> <span class="n">uvDelta</span> <span class="o">*</span> <span class="n">t</span><span class="p">;</span>
</code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200618012951620-360864955.png" width="250" /></center>

<p>æ•ˆæœçœ‹èµ·æ¥å¥½å¤šäº†ã€‚æˆ‘ä»¬ç°åœ¨å‡è®¾è¡¨é¢åœ¨æ ·æœ¬ç‚¹ä¹‹é—´æ˜¯çº¿æ€§çš„ï¼Œè¿™å¯ä»¥é˜²æ­¢æœ€æ˜æ˜¾çš„åˆ†å±‚å‡è±¡ã€‚ç„¶è€Œï¼Œå®ƒä¸èƒ½å¸®åŠ©æˆ‘ä»¬æ£€æµ‹æˆ‘ä»¬æ˜¯å¦é”™è¿‡äº†æ­¥éª¤ä¹‹é—´çš„äº¤é›†ã€‚æˆ‘ä»¬ä»ç„¶éœ€è¦å¾ˆå¤šçš„æ ·æœ¬æ¥å¤„ç†å°çš„ç‰¹å¾ï¼Œè½®å»“å’Œæµ…è§’åº¦ã€‚</p>

<p>æœ‰äº†è¿™ä¸ªæŠ€å·§ï¼Œæˆ‘ä»¬çš„æ–¹æ³•ç±»ä¼¼äºè§†å·®é®æŒ¡æ˜ å°„ã€‚è™½ç„¶è¿™æ˜¯ä¸€ä¸ªç›¸å¯¹ä¾¿å®œçš„æ”¹è¿›ï¼Œä½†é€šè¿‡å®šä¹‰_PARALLAX_RAYMARCHING_INTERPOLATE_ï¼Œæˆ‘ä»¬è®©å®ƒæˆä¸ºå¯é€‰çš„ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if defined(PARALLAX_RAYMARCHING_INTERPOLATE)
</span>    <span class="n">float</span> <span class="n">prevDifference</span> <span class="o">=</span> <span class="n">prevStepHeight</span> <span class="o">-</span> <span class="n">prevSurfaceHeight</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">difference</span> <span class="o">=</span> <span class="n">surfaceHeight</span> <span class="o">-</span> <span class="n">stepHeight</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">t</span> <span class="o">=</span> <span class="n">prevDifference</span> <span class="o">/</span> <span class="p">(</span><span class="n">prevDifference</span> <span class="o">+</span> <span class="n">difference</span><span class="p">);</span>
    <span class="n">uvOffset</span> <span class="o">=</span> <span class="n">prevUVOffset</span> <span class="o">-</span> <span class="n">uvDelta</span> <span class="o">*</span> <span class="n">t</span><span class="p">;</span>
<span class="cp">#endif
</span></code></pre></div></div>

<p>åœ¨shaderå†…å®šä¹‰PARALLAX_RAYMARCHING_INTERPOLATEã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define PARALLAX_BIAS 0
</span><span class="c1">//#define PARALLAX_OFFSET_LIMITING</span>
<span class="cp">#define PARALLAX_RAYMARCHING_STEPS 10
#define PARALLAX_RAYMARCHING_INTERPOLATE
#define PARALLAX_FUNCTION ParallaxRaymarching
</span></code></pre></div></div>

<h3 id="æ­¥é•¿æœç´¢">æ­¥é•¿æœç´¢</h3>

<p>é€šè¿‡åœ¨ä¸¤ä¸ªæ­¥é•¿ä¹‹é—´è¿›è¡Œçº¿æ€§æ’å€¼ï¼Œæˆ‘ä»¬å‡å®šè¡¨é¢åœ¨ä¸¤ä¸ªæ­¥é•¿ä¹‹é—´æ˜¯ç¬”ç›´çš„ã€‚ ä½†æ˜¯ï¼Œé€šå¸¸æƒ…å†µå¹¶éå¦‚æ­¤ã€‚ ä¸ºäº†æ›´å¥½åœ°å¤„ç†ä¸è§„åˆ™çš„é«˜åº¦åœºï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ä¸¤ä¸ªæ­¥é•¿ä¹‹é—´æœç´¢å®é™…çš„äº¤ç‚¹ã€‚ æˆ–è‡³å°‘æ¥è¿‘å®ƒã€‚</p>

<p>å®Œæˆå¾ªç¯åï¼Œä¸è¦ä½¿ç”¨æœ€åçš„åç§»é‡ï¼Œè€Œæ˜¯å°†åç§»é‡è°ƒæ•´åˆ°æœ€åä¸¤ä¸ªæ­¥é•¿çš„ä¸­é—´ä½ç½®ã€‚å¯¹è¯¥ç‚¹çš„é«˜åº¦è¿›è¡Œé‡‡æ ·ã€‚å¦‚æœæˆ‘ä»¬ç»“æŸåœ¨è¡¨é¢ä»¥ä¸‹ï¼Œå‘è¡¨é¢ä¹‹ä¸Šæ–¹å‘ç§»åŠ¨å››åˆ†ä¹‹ä¸€ï¼Œå¹¶å†æ¬¡é‡‡æ ·ã€‚å¦‚æœæˆ‘ä»¬åœ¨è¡¨é¢ä¸Šç»“æŸï¼Œå‘è¡¨é¢ä¹‹ä¸‹æ–¹å‘ç§»åŠ¨å››åˆ†ä¹‹ï¼Œå¹¶å†æ¬¡é‡‡æ ·ã€‚ä¸æ–­é‡å¤è¿™ä¸ªè¿‡ç¨‹ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200618012952340-10743193.png" width="250" /><font size="2.5">
            <i>è¶Šæ¥è¶Šæ¥è¿‘äº¤ç‚¹.</i>
        </font></center>

<p>ä¸Šè¿°æ–¹æ³•æ˜¯äºŒåˆ†æŸ¥æ‰¾çš„ä¸€ä¸ªåº”ç”¨ã€‚å®ƒä¸åœ°å½¢æµ‹ç»˜æ–¹æ³•æœ€åŒ¹é…ã€‚æ¯èµ°ä¸€æ­¥ï¼Œè·¯ç¨‹å‡åŠï¼Œç›´åˆ°åˆ°è¾¾ç›®çš„åœ°ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†ç®€å•åœ°åšå›ºå®šæ¬¡æ•°ï¼Œä»¥è¾¾åˆ°é¢„æœŸçš„è§£å†³æ–¹æ¡ˆã€‚ä¸€æ­¥ï¼Œå¾—åˆ°0.5ã€‚ä¸¤æ­¥ï¼Œå¾—åˆ°0.25ã€0.75ã€‚ä¸‰æ­¥ï¼Œæ˜¯0.125ã€0.375ã€0.625ã€0.875ã€‚æ³¨æ„ï¼Œä»ç¬¬äºŒæ­¥å¼€å§‹ï¼Œæ¯æ¬¡é‡‡æ ·æå‡åˆ†çš„è¾¨ç‡å°†ç¿»å€ã€‚</p>

<p>ä¸ºäº†æ§åˆ¶æ˜¯å¦ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œæˆ‘ä»¬å®šä¹‰_PARALLAX_RAYMARCHING_SEARCH_STEPS_ã€‚é»˜è®¤æƒ…å†µä¸‹å°†å…¶è®¾ç½®ä¸ºé›¶ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æ ¹æœ¬ä¸è¿›è¡Œæœç´¢ã€‚å¦‚æœå®ƒè¢«å®šä¹‰ä¸ºå¤§äº0ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸ä½¿ç”¨å¦ä¸€ä¸ªå¾ªç¯ã€‚æ³¨æ„ï¼Œè¿™ç§æ–¹æ³•ä¸_PARALLAX_RAYMARCHING_INTERPOLATE_æ˜¯<strong>ä¸å…¼å®¹</strong>çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½å†ä¿è¯è¡¨é¢æ˜¯äº¤å‰çš„æœ€åä¸¤ä¸ªæ­¥éª¤ã€‚å½“æˆ‘ä»¬æœç´¢çš„æ—¶å€™ï¼Œç¦ç”¨æ’å€¼ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if !defined(PARALLAX_RAYMARCHING_SEARCH_STEPS)
</span>    <span class="cp">#define PARALLAX_RAYMARCHING_SEARCH_STEPS 0
#endif
#if PARALLAX_RAYMARCHING_SEARCH_STEPS &gt; 0
</span>    <span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PARALLAX_RAYMARCHING_SEARCH_STEPS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="cp">#elif defined(PARALLAX_RAYMARCHING_INTERPOLATE)
</span>    <span class="n">float</span> <span class="n">prevDifference</span> <span class="o">=</span> <span class="n">prevStepHeight</span> <span class="o">-</span> <span class="n">prevSurfaceHeight</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">difference</span> <span class="o">=</span> <span class="n">surfaceHeight</span> <span class="o">-</span> <span class="n">stepHeight</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">t</span> <span class="o">=</span> <span class="n">prevDifference</span> <span class="o">/</span> <span class="p">(</span><span class="n">prevDifference</span> <span class="o">+</span> <span class="n">difference</span><span class="p">);</span>
    <span class="n">uvOffset</span> <span class="o">=</span> <span class="n">prevUVOffset</span> <span class="o">-</span> <span class="n">uvDelta</span> <span class="o">*</span> <span class="n">t</span><span class="p">;</span>
<span class="cp">#endif
</span></code></pre></div></div>

<p>æ­¤å¾ªç¯ä¹Ÿæ‰§è¡Œä¸åŸå§‹å¾ªç¯ç›¸åŒçš„åŸºæœ¬å·¥ä½œã€‚è°ƒæ•´åç§»é‡å’Œæ­¥é«˜ï¼Œç„¶åé‡‡æ ·é«˜åº¦å­—æ®µã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PARALLAX_RAYMARCHING_SEARCH_STEPS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">uvOffset</span> <span class="o">-=</span> <span class="n">uvDelta</span><span class="p">;</span>
    <span class="n">stepHeight</span> <span class="o">-=</span> <span class="n">stepSize</span><span class="p">;</span>
    <span class="n">surfaceHeight</span> <span class="o">=</span> <span class="n">GetParallaxHeight</span><span class="p">(</span><span class="n">uv</span> <span class="o">+</span> <span class="n">uvOffset</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä½†æ¯æ¬¡è¿­ä»£ï¼ŒUVå¢é‡å’Œæ­¥é•¿å‡åŠã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PARALLAX_RAYMARCHING_SEARCH_STEPS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uvDelta</span> <span class="o">*=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
    <span class="n">stepSize</span> <span class="o">*=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
    <span class="n">uvOffset</span> <span class="o">-=</span> <span class="n">uvDelta</span><span class="p">;</span>
    <span class="n">stepHeight</span> <span class="o">-=</span> <span class="n">stepSize</span><span class="p">;</span>
    <span class="n">surfaceHeight</span> <span class="o">=</span> <span class="n">GetParallaxHeight</span><span class="p">(</span><span class="n">uv</span> <span class="o">+</span> <span class="n">uvOffset</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åŒæ ·ï¼Œå¦‚æœç‚¹åœ¨è¡¨é¢ä¹‹ä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»æœç›¸åçš„æ–¹å‘ç§»åŠ¨ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">uvDelta</span> <span class="o">*=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
<span class="n">stepSize</span> <span class="o">*=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">stepHeight</span> <span class="o">&lt;</span> <span class="n">surfaceHeight</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">uvOffset</span> <span class="o">+=</span> <span class="n">uvDelta</span><span class="p">;</span>
    <span class="n">stepHeight</span> <span class="o">+=</span> <span class="n">stepSize</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="n">uvOffset</span> <span class="o">-=</span> <span class="n">uvDelta</span><span class="p">;</span>
    <span class="n">stepHeight</span> <span class="o">-=</span> <span class="n">stepSize</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">surfaceHeight</span> <span class="o">=</span> <span class="n">GetParallaxHeight</span><span class="p">(</span><span class="n">uv</span> <span class="o">+</span> <span class="n">uvOffset</span><span class="p">);</span>
</code></pre></div></div>

<p>è°ƒæ•´ç€è‰²å™¨ï¼Œæ‰€ä»¥å®ƒä½¿ç”¨ä¸‰ä¸ªæœç´¢æ­¥éª¤</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define PARALLAX_BIAS 0
</span><span class="c1">//#define PARALLAX_OFFSET_LIMITING</span>
<span class="cp">#define PARALLAX_RAYMARCHING_STEPS 10
#define PARALLAX_RAYMARCHING_INTERPOLATE
#define PARALLAX_RAYMARCHING_SEARCH_STEPS 3
#define PARALLAX_FUNCTION ParallaxRaymarching
</span></code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200618012953271-1061541462.png" width="250" /><font size="2.5">
            <i>10æ­¥é•¿åŠ ä¸Š3ä¸ªäºŒåˆ†æŸ¥æ‰¾çš„æœ€ç»ˆæ•ˆæœ.</i>
        </font></center>

<p>ç»“æœçœ‹èµ·æ¥ç›¸å½“ä¸é”™ï¼Œä½†ä»ä¸å®Œç¾ã€‚äºŒåˆ†æ³•æœç´¢å¯ä»¥æ¯”ç®€å•çš„æ’å€¼å¤„ç†è¾ƒæµ…çš„è§’åº¦ï¼Œä½†ä»ç„¶éœ€è¦ç›¸å½“å¤šçš„æœç´¢æ­¥éª¤ï¼Œä»¥æ‘†è„±åˆ†å±‚ã€‚æ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªè¯•éªŒçš„é—®é¢˜ï¼Œæ‰¾å‡ºå“ªç§æ–¹æ³•åœ¨ç‰¹å®šæƒ…å†µä¸‹æœ€æœ‰æ•ˆï¼Œéœ€è¦å¤šå°‘æ­¥éª¤ã€‚</p>

<h3 id="ç¼©æ”¾å¯¹è±¡å’ŒåŠ¨æ€æ‰¹å¤„ç†">ç¼©æ”¾å¯¹è±¡å’ŒåŠ¨æ€æ‰¹å¤„ç†</h3>

<p>å°½ç®¡æˆ‘ä»¬çš„è§†å·®æ˜ å°„æ–¹æ³•ä¼¼ä¹å¯è¡Œï¼Œä½†å­˜åœ¨ä¸€ä¸ªéšè—çš„é”™è¯¯ã€‚ è€Œä¸”è¿˜æŠŠé”™è¯¯æ˜¾ç¤ºå‡ºæ¥äº†ã€‚å®ƒæ˜¾ç¤ºäº†ä½•æ—¶ä½¿ç”¨åŠ¨æ€æ‰¹å¤„ç†æ¥ç»„åˆå·²ç¼©æ”¾çš„å¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œç»™æˆ‘ä»¬çš„å››è¾¹å½¢ä¸€ä¸ªåƒ\((10,10,10)\)çš„æ¯”ä¾‹ï¼Œç„¶åå¤åˆ¶å®ƒï¼Œå°†å‰¯æœ¬ç§»åˆ°å®ƒä¸‹é¢ä¸€ç‚¹ã€‚ å‡è®¾åœ¨æ’­æ”¾å™¨è®¾ç½®ä¸­å¯ç”¨äº†æ­¤é€‰é¡¹ï¼Œè¿™å°†è§¦å‘UnityåŠ¨æ€æ‰¹å¤„ç†å››è¾¹å½¢ã€‚</p>

<p>æ‰¹å¤„ç†å¼€å§‹æ—¶ï¼Œè§†å·®æ•ˆæœå°†æ‰­æ›²ã€‚ æ—‹è½¬ç›¸æœºæ—¶ï¼Œè¿™ä¸€ç‚¹éå¸¸æ˜æ˜¾ã€‚ ä½†æ˜¯ï¼Œè¿™ä»…å‘ç”Ÿåœ¨æ¸¸æˆè§†å›¾å’Œæ„å»ºä¸­ï¼Œè€Œä¸å‘ç”Ÿåœ¨åœºæ™¯è§†å›¾ä¸­ã€‚ è¯·æ³¨æ„ï¼Œstandardç€è‰²å™¨ä¹Ÿå­˜åœ¨æ­¤é—®é¢˜ï¼Œä½†æ˜¯å½“ä½¿ç”¨å¼±åç§»è§†å·®æ•ˆæœæ—¶ï¼Œæ‚¨å¯èƒ½ä¸ä¼šç«‹å³æ³¨æ„åˆ°å®ƒã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/1692664-20200618012954391-1540920343.png" width="250" /><font size="2.5">
            <i>åŠ¨æ€æ‰¹å¤„ç†ä¼šäº§ç”Ÿå¥‡æ€ªçš„ç»“æœ.</i>
        </font></center>

<p>åœ¨æ‰¹å¤„ç†å°†å®ƒä»¬åˆå¹¶åˆ°ä¸€ä¸ªå•ä¸€çš„ç½‘æ ¼ä¸­ä¹‹åï¼ŒUnityä¸èƒ½æ ‡å‡†åŒ–å¤„ç†åçš„å‡ ä½•æ³•å‘é‡å’Œåˆ‡å‘é‡ã€‚å› æ­¤é¡¶ç‚¹æ•°æ®æ­£ç¡®çš„å‡è®¾ä¸å†æˆç«‹ã€‚</p>

<p>é¡¶ç‚¹æ³•å‘é‡å’Œåˆ‡å‘é‡æ²¡æœ‰è§„èŒƒåŒ–ä¸æ˜¯ä»€ä¹ˆå¤§çš„é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨é¡¶ç‚¹ç¨‹åºä¸­å°†è§†å›¾å‘é‡è½¬æ¢åˆ°åˆ‡çº¿ç©ºé—´ã€‚å¯¹äºå…¶ä»–æ‰€æœ‰å†…å®¹ï¼Œæ•°æ®åœ¨ä½¿ç”¨ä¹‹å‰éƒ½è¦æ ‡å‡†åŒ–ã€‚</p>

<p>è§£å†³æ–¹æ³•æ˜¯åœ¨æ„é€ å¯¹è±¡è½¬æ¢åˆ°åˆ‡çº¿çŸ©é˜µä¹‹å‰å¯¹å‘é‡è¿›è¡Œå½’ä¸€åŒ–ã€‚ å› ä¸ºåªæœ‰åŠ¨æ€æ‰¹å¤„ç†çš„ç¼©æ”¾å‡ ä½•æ‰éœ€è¦æ­¤é€‰é¡¹ï¼Œæ‰€ä»¥æ ¹æ®æ˜¯å¦å®šä¹‰äº†PARALLAX_SUPPORT_SCALED_DYNAMIC_BATCHINGï¼Œå°†å…¶è®¾ä¸ºå¯é€‰ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if defined (_PARALLAX_MAP)
</span>    <span class="cp">#if defined(PARALLAX_SUPPORT_SCALED_DYNAMIC_BATCHING)
</span>        <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
        <span class="n">v</span><span class="p">.</span><span class="n">normal</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
    <span class="cp">#endif
</span>    <span class="kt">float3x3</span> <span class="n">objectToTangent</span> <span class="o">=</span> <span class="kt">float3x3</span><span class="p">(</span>
        <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">,</span>
        <span class="nb">cross</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">,</span>
        <span class="n">v</span><span class="p">.</span><span class="n">normal</span>
    <span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">tangentViewDir</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">objectToTangent</span><span class="p">,</span> <span class="n">ObjSpaceViewDir</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">));</span>
<span class="cp">#endif
</span></code></pre></div></div>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define PARALLAX_BIAS 0
</span><span class="c1">//#define PARALLAX_OFFSET_LIMITING</span>
<span class="cp">#define PARALLAX_RAYMARCHING_STEPS 10
#define PARALLAX_RAYMARCHING_INTERPOLATE
#define PARALLAX_RAYMARCHING_SEARCH_STEPS 3
#define PARALLAX_FUNCTION ParallaxRaymarching
#define PARALLAX_SUPPORT_SCALED_DYNAMIC_BATCHING
</span></code></pre></div></div>
<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender20/batched-correct.png" width="250" /><font size="2.5">
            <i>åŠ¨æ€æ‰¹é‡ä¸æ­£ç¡®çš„ç»“æœ.</i>
        </font></center>]]></content><author><name>catlikecoding</name></author><category term="Shader" /><summary type="html"><![CDATA[ç”±äºè§†è§’çš„åŸå› ï¼Œå½“è°ƒæ•´æ‘„åƒæœºä½ç½®æ—¶ï¼Œè§‚å¯Ÿåˆ°çš„äº‹ç‰©çš„ç›¸å¯¹ä½ç½®ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™ç§è§†è§‰ç°è±¡ç§°ä¸ºè§†å·®ã€‚åœ¨åç«è½¦é«˜é€Ÿè¡Œé©¶çœ‹çª—å¤–çš„æ™¯ç‰©ï¼Œé™„è¿‘çš„ç‰©ä½“çœ‹èµ·æ¥å¾ˆå¤§å¹¶ä¸”ç§»åŠ¨å¾ˆå¿«ï¼Œè€Œè¿œå¤„çš„èƒŒæ™¯çœ‹èµ·æ¥å¾ˆå°å¹¶ä¸”ç§»åŠ¨è¾ƒæ…¢ã€‚æ¸²æŸ“æ—¶ï¼Œç›¸æœºä½¿ç”¨é€è§†æ¨¡å¼æ—¶ï¼Œä¹Ÿä¼šå‡ºç°è§†å·®ã€‚]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://www.damonc.top/posts/2018/month1/catRender20/tutorial-image.png" /><media:content medium="image" url="https://www.damonc.top/posts/2018/month1/catRender20/tutorial-image.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Unity GPU Instance(ç¿»è¯‘åä¹)</title><link href="https://www.damonc.top/Unity_GPU_Instance.html" rel="alternate" type="text/html" title="Unity GPU Instance(ç¿»è¯‘åä¹)" /><published>2018-01-24T20:00:00+00:00</published><updated>2018-01-24T20:00:00+00:00</updated><id>https://www.damonc.top/Unity_GPU_Instance</id><content type="html" xml:base="https://www.damonc.top/Unity_GPU_Instance.html"><![CDATA[<p>æœ¬ç¯‡æ‘˜è¦ï¼š</p>
<ul>
  <li>æ¸²æŸ“å¤§é‡çƒä½“-ä¼˜åŒ–DrawCall</li>
  <li>æ”¯æŒGPU-Instance</li>
  <li>ä½¿ç”¨æè´¨å±æ€§å—</li>
  <li>LOD-Groupsæ”¯æŒGPU-Instance</li>
</ul>

<h2 id="batching-instance-æ‰¹å¤„ç†">Batching Instance-æ‰¹å¤„ç†</h2>

<p>æŒ‡ç¤ºGPUç»˜åˆ¶éœ€è¦èŠ±æ—¶é—´ï¼›å‘å…¶ä¼ é€’meshå’Œmaterialå±æ€§ä¹Ÿè¦èŠ±æ—¶é—´ã€‚ç°åœ¨å·²çŸ¥ä¸¤ç§èŠ‚çœDraw Callçš„æ–¹å¼ï¼šstaticå’Œ<a href="https://docs.unity3d.com/Manual/DrawCallBatching.html"><strong>dynamic batching</strong></a></p>

<p>Unityå¯ä»¥å°†å¤šä¸ªé™æ€ç‰©ä½“çš„ç½‘æ ¼åˆå¹¶ä¸ºä¸€ä¸ªæ›´å¤§çš„é™æ€ç½‘æ ¼ï¼Œä»è€Œå‡å°‘draw callã€‚ <strong>æ³¨æ„ï¼š</strong> åªæœ‰ä½¿ç”¨ç›¸åŒæè´¨çš„å¯¹è±¡æ‰èƒ½ä»¥è¿™ç§æ–¹å¼ç»„åˆã€‚ è¿™æ˜¯ä»¥å¿…é¡»å­˜å‚¨æ›´å¤šç½‘æ ¼æ•°æ®ä¸ºä»£ä»·çš„ã€‚ å¯ç”¨åŠ¨æ€æ‰¹å¤„ç†åï¼ŒUnityåœ¨è¿è¡Œæ—¶ä¼šå¯¹è§†å›¾ä¸­çš„åŠ¨æ€å¯¹è±¡æ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚ è¿™ä»…é€‚ç”¨äºå°å‹ç½‘æ ¼ç‰©ä½“ï¼Œå¦åˆ™å¼€é”€å°†å˜å¾—å¤ªå¤§ã€‚</p>

<p>è¿˜æœ‰å¦ä¸€ç§ç»„åˆdraw callçš„æ–¹æ³•ï¼šGPU instanceæˆ–Geometry instanceã€‚ä¸åŠ¨æ€æ‰¹å¤„ç†ä¸€æ ·ï¼Œæ­¤æ“ä½œåœ¨è¿è¡Œæ—¶é’ˆå¯¹å¯è§å¯¹è±¡ã€‚ å®ƒçš„ç›®æ ‡æ˜¯è®©GPUä¸€æ¬¡æ€§æ¸²æŸ“åŒä¸€ç½‘æ ¼çš„å¤šä¸ªå‰¯æœ¬ã€‚ å› æ­¤ï¼Œå®ƒä¸èƒ½ç»„åˆä¸åŒçš„ç½‘æ ¼æˆ–æè´¨ã€‚</p>

<h3 id="åˆ›å»ºå¤§é‡çƒä½“">åˆ›å»ºå¤§é‡çƒä½“</h3>

<div class="language-plaintext tip-info highlighter-rouge"><div class="highlight"><pre class="highlight"><code>im title?
test test test.
test test test.
test test test!!dfS:FDFH&amp;*YER#.
</code></pre></div></div>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">using</span> <span class="n">UnityEngine</span><span class="p">;</span>

<span class="kr">public</span> <span class="k">class</span> <span class="n">GPUInstancingTest</span> <span class="o">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
    <span class="kr">public</span> <span class="n">Transform</span> <span class="n">prefab</span><span class="p">;</span>
    <span class="kr">public</span> <span class="n">int</span> <span class="n">instances</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
    <span class="kr">public</span> <span class="n">float</span> <span class="n">radius</span> <span class="o">=</span> <span class="mi">50</span><span class="n">f</span><span class="p">;</span>
    <span class="c1">//å•ä½åœ†å†…éšæœºä¸€ç‚¹å¹¶æ”¾å¤§åæ ‡50å€ï¼Œç”Ÿæˆ5000ä¸ªçƒä½“</span>
    <span class="c1">//ç„¶åæŸ¥çœ‹statisticsç»Ÿè®¡çš„draw Callä¿¡æ¯</span>
    <span class="kt">void</span> <span class="n">Start</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">instances</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Transform</span> <span class="n">t</span> <span class="o">=</span> <span class="n">Instantiate</span><span class="p">(</span><span class="n">prefab</span><span class="p">);</span>
            <span class="n">t</span><span class="p">.</span><span class="n">localPosition</span> <span class="o">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">insideUnitSphere</span> <span class="o">*</span> <span class="n">radius</span><span class="p">;</span>
            <span class="n">t</span><span class="p">.</span><span class="n">SetParent</span><span class="p">(</span><span class="n">transform</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä½¿ç”¨forward render pathç»Ÿè®¡åˆ°çš„draw callï¼Œå»æ‰èƒŒæ™¯å’Œcamera Effectä¸¤ä¸ªdraw callï¼š</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender19/1692664-20200612010902826-821880737.png" width="250" /><font size="2.5">
            <i>5000 draw call.</i>
        </font></center>

<p>ä½†æ˜¯å½“ä½¿ç”¨cubeä»£æ›¿çƒä½“</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender19/1692664-20200612010904552-338192039.png" width="250" /><font size="2.5">
            <i>6 draw call.</i>
        </font></center>

<h3 id="æ”¯æŒinstance">æ”¯æŒInstance</h3>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒGPU Instanceä¸ä¼šå¼€å¯ï¼Œå¿…é¡»è®¾è®¡shaderä»¥æ”¯æŒå®ƒã€‚ å³ä½¿è¿™æ ·ï¼Œä¹Ÿå¿…é¡»ä¸ºæ¯ç§ææ–™æ˜¾å¼å¯ç”¨å®ä¾‹åŒ–ã€‚ Unityçš„standardç€è‰²å™¨æœ‰ä¸€ä¸ªå¼€å…³ã€‚åƒæ ‡å‡†ç€è‰²å™¨çš„GUIä¸€æ ·ï¼Œæˆ‘ä»¬å°†ä¸ºshaderæ‰©å±•é¢æ¿åˆ›å»ºâ€œé«˜çº§é€‰é¡¹â€éƒ¨åˆ†ã€‚ å¯ä»¥é€šè¿‡è°ƒç”¨MaterialEditor.EnableInstancingFieldæ–¹æ³•æ¥æ·»åŠ åˆ‡æ¢ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">DoAdvanced</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">GUILayout</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="s">"Advanced Options"</span><span class="p">,</span> <span class="n">EditorStyles</span><span class="p">.</span><span class="n">boldLabel</span><span class="p">);</span>
    <span class="n">editor</span><span class="p">.</span><span class="n">EnableInstancingField</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä»…å½“shaderå®é™…æ”¯æŒinstanceæ—¶ï¼Œæ‰ä¼šæ˜¾ç¤ºè¯¥åˆ‡æ¢ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†#pragma multi_compile_instancingæŒ‡ä»¤æ·»åŠ åˆ°ç€è‰²å™¨base-passå¯ç”¨æ­¤æ”¯æŒã€‚ è¿™å°†ä¸ºä¸€äº›å…³é”®å­—å¯ç”¨ç€è‰²å™¨å˜ä½“ï¼Œè‡ªå®šä¹‰å…³é”®å­—_INSTANCING_ON_ï¼Œå…¶ä»–å…³é”®å­—ä¹Ÿå¯ä»¥ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma multi_compile_fwdbase
#pragma multi_compile_fog
#pragma multi_compile_instancing
</span></code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender19/1692664-20200612010905493-1524350499.png" width="250" /><body></body>
        <img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender19/1692664-20200612010906722-1492830859.png" width="250" /><font size="2.5">
            <i>åˆå¹¶äº†ï¼Œä½†æ˜¯æ˜¾ç¤ºæœ‰é”™è¯¯.</i>
        </font></center>

<p>æ‰¹å¤„ç†æ•°é‡å·²å‡å°‘åˆ°42ï¼Œè¿™æ„å‘³ç€ç°åœ¨ä»…ç”¨40ä¸ªæ‰¹å¤„ç†å³å¯æ¸²æŸ“æ‰€æœ‰5000ä¸ªçƒä½“ã€‚å¸§é€Ÿç‡ä¹Ÿé«˜è¾¾80 fpsï¼Œä½†æ˜¯åªæœ‰å‡ ä¸ªçƒä½“å¯è§ã€‚<strong>é”™è¯¯åŸå› </strong>ï¼šè™½ç„¶5000ä¸ªçƒä½“ä»åœ¨æ¸²æŸ“ï¼Œä½†æ˜¯åœ¨åˆæ‰¹ä¸­åŒä¸€æ‰¹æ¬¡çš„æ‰€æœ‰çƒä½“çš„é¡¶ç‚¹è½¬æ¢æ—¶éƒ½ä½¿ç”¨äº†åŒä¸€ä¸ªä½ç½®ï¼šå®ƒä»¬éƒ½ä½¿ç”¨åŒä¸€æ‰¹æ¬¡ä¸­ç¬¬ä¸€ä¸ªçƒçš„è½¬æ¢çŸ©é˜µã€‚ å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸ºç°åœ¨åŒä¸€æ‰¹ä¸­æ‰€æœ‰çƒä½“çš„çŸ©é˜µéƒ½ä½œä¸ºæ•°ç»„å‘é€åˆ°GPUã€‚ åœ¨ä¸å‘ŠçŸ¥ç€è‰²å™¨è¦ä½¿ç”¨å“ªä¸ªæ•°ç»„ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œå®ƒå§‹ç»ˆä½¿ç”¨ç¬¬ä¸€ä¸ªç´¢å¼•ã€‚</p>

<h3 id="instance-ids">Instance IDs</h3>

<p>ä¸Šè¿°é”™è¯¯è§£å†³åŠæ³•ï¼šæ¯ä¸ªInstanceç›¸å¯¹åº”çš„æ•°ç»„ç´¢å¼•ç§°ä¸ºå…¶Instance IDï¼ŒGPUé€šè¿‡é¡¶ç‚¹æ•°æ®å°†å…¶ä¼ é€’åˆ°ç€è‰²å™¨çš„vertexç¨‹åºã€‚åœ¨å¤§å¤šæ•°å¹³å°ä¸Šï¼Œå®ƒæ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°ï¼Œåä¸ºinstanceIDï¼Œå…·æœ‰SV_InstanceIDè¯­ä¹‰ã€‚ æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä½¿ç”¨_UNITY_VERTEX_INPUT_INSTANCE_ID_å®å°†å…¶åŒ…å«åœ¨æˆ‘ä»¬çš„VertexDataç»“æ„ä¸­ã€‚ å®ƒåœ¨UnityCGä¸­åŒ…å«çš„_UnityInstancing.cginc_æ–‡ä»¶ä¸­å®šä¹‰ã€‚ å®ƒä¸ºæˆ‘ä»¬æä¾›äº†å®ä¾‹IDçš„æ­£ç¡®å®šä¹‰ï¼Œæˆ–è€…åœ¨æœªå¯ç”¨å®ä¾‹åŒ–æ—¶ä¸æä¾›ä»»ä½•å†…å®¹ã€‚å°†å…¶æ·»åŠ åˆ°VertexDataç»“æ„ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">VertexData</span> <span class="p">{</span>
    <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
    <span class="kt">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="nb">POSITION</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>å¯ç”¨instanceåï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥åœ¨é¡¶ç‚¹ç¨‹åºä¸­è®¿é—®instanceIDã€‚ æœ‰äº†å®ƒï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å˜æ¢é¡¶ç‚¹ä½ç½®æ—¶ä½¿ç”¨æ­£ç¡®çš„çŸ©é˜µã€‚ ä½†æ˜¯ï¼ŒUnityObjectToClipPoså‡½æ•°æ²¡æœ‰çŸ©é˜µå‚æ•°ï¼Œå®ƒå‡½æ•°å†…éƒ¨å§‹ç»ˆä½¿ç”¨unity_ObjectToWorldçŸ©é˜µã€‚è¦è§£å†³æ­¤é—®é¢˜ï¼ŒUnityInstancingåŒ…å«æ–‡ä»¶ä¼šä½¿ç”¨çŸ©é˜µæ•°ç»„çš„å®è¦†ç›–unity_ObjectToWorldã€‚ <em>è¿™å¯ä»¥è¢«è®¤ä¸ºæ˜¯è‚®è„çš„å®æŠ€å·§ï¼Œä½†æ— éœ€æ›´æ”¹ç°æœ‰ç€è‰²å™¨ä»£ç å³å¯å·¥ä½œï¼Œä»è€Œç¡®ä¿äº†å‘åå…¼å®¹æ€§</em>ã€‚</p>

<p>è¦ä½¿å®ƒå·¥ä½œï¼Œinstanceçš„æ•°ç»„ç´¢å¼•å¿…é¡»å¯¹æ‰€æœ‰ç€è‰²å™¨ä»£ç å…¨å±€å¯ç”¨ã€‚å¿…é¡»é€šè¿‡_UNITY_SETUP_INSTANCE_ID_å®è¿›è¡Œæ‰‹åŠ¨è®¾ç½®ï¼Œè¯¥å®å¿…é¡»åœ¨vertexç¨‹åºæœ€å…ˆè®¡ç®—ï¼Œç„¶åå†æ‰§è¡Œå…¶ä»–çš„ä»£ç ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">InterpolatorsVertex</span> <span class="nf">MyVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">InterpolatorsVertex</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">UNITY_INITIALIZE_OUTPUT</span><span class="p">(</span><span class="n">Interpolators</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">UNITY_SETUP_INSTANCE_ID</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender19/1692664-20200612010908398-221325174.png" width="250" /><font size="2.5">
            <i>çŸ©é˜µæ›¿æ¢å†…éƒ¨å®ç°ï¼Ÿ.</i>
        </font></center>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//UnityInstancingä¸­çš„å®é™…ä»£ç è¦å¤æ‚å¾—å¤šã€‚ å®ƒè¦å¤„ç†å¹³å°å·®å¼‚ï¼Œå…¶ä»–ä½¿ç”¨å®ä¾‹åŒ–çš„æ–¹æ³•ä»¥åŠç”¨äºç«‹</span>
<span class="c1">//ä½“å£°æ¸²æŸ“çš„ç‰¹æ®Šä»£ç ï¼Œä»è€Œå¯¼è‡´é—´æ¥å®šä¹‰çš„å¤šä¸ªæ­¥éª¤ã€‚ å®ƒè¿˜å¿…é¡»é‡æ–°å®šä¹‰UnityObjectToClipPosï¼Œå› </span>
<span class="c1">//ä¸ºUnityCGé¦–å…ˆåŒ…å«UnityShaderUtilitiesã€‚</span>
<span class="c1">//ç¼“å†²åŒºå®å°†åœ¨åé¢è¯´æ˜ã€‚</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">unity_InstanceID</span><span class="p">;</span>

<span class="n">CBUFFER_START</span><span class="p">(</span><span class="n">UnityDrawCallInfo</span><span class="p">)</span>
    <span class="c1">// Where the current batch starts within the instanced arrays.</span>
    <span class="n">int</span> <span class="n">unity_BaseInstanceID</span><span class="p">;</span>
<span class="n">CBUFFER_END</span>

<span class="cp">#define UNITY_VERTEX_INPUT_INSTANCE_ID uint instanceID : SV_InstanceID;
</span>
<span class="cp">#define UNITY_SETUP_INSTANCE_ID(input) \
    unity_InstanceID = input.instanceID + unity_BaseInstanceID;
</span>
<span class="c1">// Redefine some of the built-in variables</span>
<span class="c1">// macros to make them work with instancing.</span>
<span class="n">UNITY_INSTANCING_CBUFFER_START</span><span class="p">(</span><span class="n">PerDraw0</span><span class="p">)</span>
    <span class="kt">float4x4</span> <span class="n">unity_ObjectToWorldArray</span><span class="p">[</span><span class="n">UNITY_INSTANCED_ARRAY_SIZE</span><span class="p">];</span>
    <span class="kt">float4x4</span> <span class="n">unity_WorldToObjectArray</span><span class="p">[</span><span class="n">UNITY_INSTANCED_ARRAY_SIZE</span><span class="p">];</span>
<span class="n">UNITY_INSTANCING_CBUFFER_END</span>
<span class="cp">#define unity_ObjectToWorld     unity_ObjectToWorldArray[unity_InstanceID]
#define unity_WorldToObject     unity_WorldToObjectArray[unity_InstanceID]
</span></code></pre></div></div>

<h3 id="æ‰¹å¤„ç†å¤§å°">æ‰¹å¤„ç†å¤§å°</h3>

<p>æ¯å°è®¾å¤‡ä¸ä¸€æ ·ï¼Œæœ€ç»ˆå¾—åˆ°çš„æ‰¹æ¬¡æ•°é‡å¯èƒ½ä¸å½“å‰å®éªŒå¾—åˆ°çš„æ•°é‡ä¸åŒã€‚ç°åœ¨è¿™æƒ…å†µä¸‹ï¼Œä»¥40æ‰¹æ¸²æŸ“5000ä¸ªçƒä½“å®ä¾‹ï¼Œè¿™æ„å‘³ç€æ¯æ‰¹125ä¸ªçƒä½“ã€‚</p>

<p>æ¯ä¸ªæ‰¹æ¬¡éƒ½éœ€è¦è‡ªå·±çš„çŸ©é˜µæ•°ç»„ã€‚ æ­¤æ•°æ®å‘é€åˆ°GPUå¹¶å­˜å‚¨åœ¨å†…å­˜ç¼“å†²åŒºä¸­ï¼Œåœ¨Direct3Dä¸­ç§°ä¸ºå¸¸é‡ç¼“å†²åŒºï¼Œåœ¨OpenGLä¸­ç§°ä¸ºç»Ÿä¸€ç¼“å†²åŒºã€‚ è¿™äº›<strong>ç¼“å†²åŒºå…·æœ‰æœ€å¤§å¤§å°</strong>ï¼Œè¿™é™åˆ¶äº†ä¸€æ‰¹ä¸­å¯ä»¥å®¹çº³å¤šå°‘ä¸ªå®ä¾‹ã€‚ å‡è®¾å°å¼æœºGPUæ¯ä¸ªç¼“å†²åŒºçš„é™åˆ¶ä¸º64KBã€‚</p>

<p>ä¸€ä¸ªçŸ©é˜µç”±16ä¸ªæµ®ç‚¹æ•°ç»„æˆï¼Œæ¯ä¸ªæµ®ç‚¹æ•°å‡ä¸º4ä¸ªå­—èŠ‚ã€‚ å› æ­¤ï¼Œæ¯ä¸ªçŸ©é˜µ64ä¸ªå­—èŠ‚ã€‚ æ¯ä¸ªå®ä¾‹éƒ½éœ€è¦ä¸€ä¸ªå¯¹è±¡åˆ°ä¸–ç•Œçš„è½¬æ¢çŸ©é˜µã€‚ ä½†æ˜¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªä¸–ç•Œåˆ°å¯¹è±¡çš„çŸ©é˜µæ¥è½¬æ¢æ³•çº¿å‘é‡ã€‚ å› æ­¤ï¼Œæœ€ç»ˆæ¯ä¸ªå®ä¾‹æœ‰128ä¸ªå­—èŠ‚ã€‚ è¿™å¯¼è‡´æœ€å¤§æ‰¹å¤„ç†å¤§å°ä¸ºâ€œ 64000/128 = 500â€ï¼Œè¿™åªèƒ½åœ¨10ä¸ªæ‰¹å¤„ç†ä¸­æ¸²æŸ“5000ä¸ªçƒä½“ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å†…å­˜å•ä½æ˜¯2è¿›åˆ¶ï¼Œæ‰€ä»¥1KBè¡¨ç¤º1024å­—èŠ‚ï¼Œè€Œä¸æ˜¯1000ã€‚å› æ­¤ï¼Œ'(64 * 1024)/ 128 = 512 'ã€‚UNITY_INSTANCED_ARRAY_SIZEé»˜è®¤å®šä¹‰ä¸º500ï¼Œä½†æ‚¨å¯ä»¥ä½¿ç”¨ç¼–è¯‘å™¨æŒ‡ä»¤è¦†ç›–å®ƒã€‚ä¾‹å¦‚ï¼Œ#pragma instancing_options maxcount:512å°†æœ€å¤§å€¼è®¾ç½®ä¸º512ã€‚ä½†æ˜¯ï¼Œè¿™å°†å¯¼è‡´æ–­è¨€å¤±è´¥é”™è¯¯ï¼Œå› æ­¤å®é™…é™åˆ¶ä¸º511ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œ500å’Œ512ä¹‹é—´æ²¡æœ‰å¤ªå¤§çš„å·®åˆ«ã€‚
</code></pre></div></div>

<p>å³ä½¿å‡è®¾å°å¼æœºçš„æœ€å¤§å®¹é‡ä¸º64KBæˆç«‹ï¼Œä½†æ˜¯å¤§å¤šæ•°ç§»åŠ¨è®¾å¤‡çš„æœ€å¤§å®¹é‡è¿œè¿œè¾¾ä¸åˆ°64ï¼Œå¯èƒ½ä»…ä¸º16KBã€‚ Unityé€šè¿‡åœ¨é’ˆå¯¹OpenGL ES 3ï¼ŒOpenGL Coreæˆ–Metalæ—¶å°†æœ€å¤§å€¼é™¤ä»¥å››æ¥è§£å†³æ­¤é—®é¢˜ã€‚ å› ä¸ºæˆ‘åœ¨ç¼–è¾‘å™¨ä¸­ä½¿ç”¨çš„æ˜¯OpenGL Coreï¼Œæ‰€ä»¥æœ€ç»ˆçš„æœ€å¤§æ‰¹å¤„ç†å¤§å°ä¸ºâ€œ 500/4 = 125â€ã€‚</p>

<p>å¯ä»¥é€šè¿‡æ·»åŠ ç¼–è¯‘å™¨æŒ‡ä»¤#pragma instancing_options force_same_maxcount_for_glæ¥ç¦ç”¨æ­¤è‡ªåŠ¨å‡å°‘åŠŸèƒ½ã€‚ å¤šä¸ªinstanceé€‰é¡¹ç»„åˆåœ¨åŒä¸€æŒ‡ä»¤ä¸­ã€‚ ä½†æ˜¯ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´åœ¨éƒ¨ç½²åˆ°ç§»åŠ¨è®¾å¤‡ä¸Šæ—¶å‘ç”Ÿæ•…éšœï¼Œå› æ­¤è¯·å°å¿ƒä½¿ç”¨ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>é‚£å‡è®¾å‡ç­‰ç¼©æ”¾é€‰é¡¹å‘¢ï¼Ÿ

å¯ä»¥ä½¿ç”¨#pragma instancing_optionsæŒ‡ç¤ºæ‰€æœ‰instanceå¯¹è±¡å…·æœ‰ç»Ÿä¸€çš„ç¼©æ”¾æ¯”ä¾‹ã€‚ è¿™æ¶ˆé™¤äº†å°†ä¸–ç•Œåˆ°å¯¹è±¡çŸ©é˜µç”¨äºæ³•çº¿è½¬æ¢çš„éœ€è¦(å°‘å­˜å‚¨ä¸€ä¸ªçŸ©é˜µ)ã€‚ è®¾ç½®æ­¤é€‰é¡¹åï¼Œè™½ç„¶UnityObjectToWorldNormalå‡½æ•°ç¡®å®ä¼šæ›´æ”¹å…¶è¡Œä¸ºï¼Œä½†å®ƒä¸ä¼šæ¶ˆé™¤ç¬¬äºŒä¸ªçŸ©é˜µæ•°ç»„ã€‚ å› æ­¤ï¼Œè‡³å°‘åœ¨Unity 2017.1.0ä¸­ï¼Œæ­¤é€‰é¡¹å®é™…ä¸Šæ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚
</code></pre></div></div>

<h3 id="instance-shadows">Instance Shadows</h3>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸€ç›´æ²¡æœ‰é˜´å½±ã€‚ é‡æ–°æ‰“å¼€ä¸»é˜´å½±çš„Soft shadowï¼Œå¹¶ç¡®ä¿é˜´å½±è·ç¦»è¶³ä»¥åŒ…å«æ‰€æœ‰çƒä½“</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender19/1692664-20200612010909964-776430193.png" width="250" /><font size="2.5">
            <i>æ‰¹å¤„ç†çˆ†ç‚¸.</i>
        </font></center>

<p>ä¸ºå¤§é‡ç‰©ä½“æ¸²æŸ“é˜´å½±ä¼šå¢åŠ GPUè€—èƒ½ã€‚ä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æ¸²æŸ“çƒä½“é˜´å½±æ—¶ä½¿ç”¨GPU instanceã€‚åœ¨shadow caster-passä¸­æ·»åŠ instanceæŒ‡ä»¤ï¼›åŒæ—¶ä¹Ÿå¢åŠ <code class="language-plaintext highlighter-rouge">UNITY_VERTEX_INPUT_INSTANCE_ID</code> and <code class="language-plaintext highlighter-rouge">UNITY_SETUP_INSTANCE_ID</code></p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma multi_compile_shadowcaster
#pragma multi_compile_instancing
</span><span class="k">struct</span> <span class="n">VertexData</span> <span class="p">{</span>
	<span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
<span class="p">};</span>

<span class="n">InterpolatorsVertex</span> <span class="nf">MyShadowVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">InterpolatorsVertex</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">UNITY_SETUP_INSTANCE_ID</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender19/1692664-20200612010911627-1161944067.png" width="250" /><font size="2.5">
            <i>instanced é˜´å½±.</i>
        </font></center>

<h3 id="å¤šå…‰æº">å¤šå…‰æº</h3>

<p>æˆ‘ä»¬ä»…åœ¨base-passå’Œshadow caster-passä¸­æ·»åŠ äº†instanceæ”¯æŒã€‚ å› æ­¤ï¼Œæ‰¹å¤„ç†ä¸é€‚ç”¨äºå…¶ä»–å…‰æºã€‚ è¦éªŒè¯è¿™ä¸€ç‚¹ï¼Œåœç”¨ä¸»å…‰æºå¹¶æ·»åŠ ä¸€äº›ä¼šå½±å“å¤šä¸ªçƒä½“çš„èšå…‰ç¯æˆ–ç‚¹å…‰æºã€‚ ä¸è¦ä¸ºå®ƒä»¬æ‰“å¼€é˜´å½±ï¼Œå› ä¸ºé‚£æ ·ä¼šé™ä½å¸§é€Ÿç‡ã€‚</p>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender19/1692664-20200612010913312-1389275661.png" width="250" /><font size="2.5">
            <i>æ‰¹å¤„ç†çˆ†ç‚¸.</i>
        </font></center>

<p>ä¸Šå›¾ï¼Œå®Œå…¨ä¸æ”¯æŒå¤šå…‰æºæ‰¹å¤„ç†ã€‚ è¦å°†instanceä¸å¤šä¸ªå…‰æºç»“åˆä½¿ç”¨ï¼Œåªèƒ½åˆ‡æ¢åˆ°å»¶è¿Ÿæ¸²æŸ“è·¯å¾„ã€‚ ä¸ºæ­¤ï¼Œè¯·å°†æ‰€éœ€çš„ç¼–è¯‘å™¨æŒ‡ä»¤æ·»åŠ åˆ°ç€è‰²å™¨çš„å»¶è¿Ÿä¼ é€’ä¸­ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma multi_compile_prepassfinal
#pragma multi_compile_instancing
</span></code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender19/1692664-20200612010914967-1310775534.png" width="250" /><font size="2.5">
            <i>å¤šå…‰æºinstance.</i>
        </font></center>

<h2 id="mixing-material-properties">Mixing Material Properties</h2>

<p>æ‰€æœ‰æ‰¹å¤„ç†éƒ½æœ‰ä¸€ä¸ªé™åˆ¶ï¼šå®ƒä»¬ä»…é™äºå…·æœ‰ç›¸åŒææ–™çš„å¯¹è±¡ã€‚ å½“æˆ‘ä»¬å¸Œæœ›æ¸²æŸ“çš„å¯¹è±¡å…·æœ‰å¤šæ ·æ€§æ—¶ï¼Œæ­¤é™åˆ¶å°±ä¼šæˆä¸ºé—®é¢˜ã€‚</p>

<h3 id="éšæœºç€è‰²">éšæœºç€è‰²</h3>

<p>éšæœºæ”¹å˜çƒä½“çš„é¢œè‰²</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">Start</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">instances</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Transform</span> <span class="n">t</span> <span class="o">=</span> <span class="n">Instantiate</span><span class="p">(</span><span class="n">prefab</span><span class="p">);</span>
        <span class="n">t</span><span class="p">.</span><span class="n">localPosition</span> <span class="o">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">insideUnitSphere</span> <span class="o">*</span> <span class="n">radius</span><span class="p">;</span>
        <span class="n">t</span><span class="p">.</span><span class="n">SetParent</span><span class="p">(</span><span class="n">transform</span><span class="p">);</span>
        <span class="n">t</span><span class="p">.</span><span class="n">GetComponent</span><span class="o">&lt;</span><span class="n">MeshRenderer</span><span class="o">&gt;</span><span class="p">().</span><span class="n">material</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span>    <span class="kr">new</span> <span class="n">Color</span><span class="p">(</span><span class="n">Random</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Random</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Random</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender19/1692664-20200612010916576-490651101.png" width="250" /><font size="2.5">
            <i>çƒä½“ä¸éšæœºçš„é¢œè‰²ï¼Œæ²¡æœ‰æ‰¹é‡å’Œé˜´å½±.</i>
        </font></center>

<p>å³ä½¿æˆ‘ä»¬ä¸ºç‰©æ–™å¯ç”¨äº†æ‰¹å¤„ç†ï¼Œå®ƒä¹Ÿä¸å†èµ·ä½œç”¨ã€‚ç”±äºæ¯ä¸ªçƒä½“ç°åœ¨éƒ½æœ‰è‡ªå·±çš„æè´¨ï¼Œå› æ­¤æ¯ä¸ªçƒä½“çš„ç€è‰²å™¨çŠ¶æ€ä¹Ÿå¿…è¢«æ›´æ”¹ã€‚ è¿™æ˜¾ç¤ºåœ¨ç»Ÿè®¡é¢æ¿ä¸­ä¸ºSetPass callçš„æ•°é‡ã€‚åœ¨è¿™ä¿®æ”¹ä¹‹å‰åªæœ‰å°‘é‡å‡ ä¸ªæ‰¹æ¬¡æ¸²æŸ“ï¼Œä½†æ˜¯ç°åœ¨æ˜¯5000åŠ æ‰¹æ¬¡ã€‚</p>

<h3 id="æè´¨å±æ€§å—-material-property-blocks">æè´¨å±æ€§å—-Material Property Blocks</h3>

<p>é™¤äº†ä¸ºæ¯ä¸ªçƒä½“åˆ›å»ºæ–°çš„æè´¨å®ä¾‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨æè´¨å±æ€§å—ã€‚ è¿™äº›æ˜¯å°çš„ä¿®æ”¹ï¼Œè®¾ç½®å±æ€§å—çš„é¢œè‰²å¹¶å°†å…¶ä¼ é€’ç»™çƒä½“çš„æ¸²æŸ“å™¨ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ†é…æè´¨çš„é¢œè‰²ã€‚<a href="http://docs.unity3d.com/Documentation/ScriptReference/MaterialPropertyBlock.html">MaterialPropertyBlock</a>å®˜ç½‘ä»‹ç»;</p>

<h3 id="property-buffers-å±æ€§ç¼“å†²åŒº">Property Buffers-å±æ€§ç¼“å†²åŒº</h3>

<p>æ¸²æŸ“instanceå¯¹è±¡æ—¶ï¼ŒUnityé€šè¿‡æ•°ç»„å½¢å¼å°†é¢œè‰²æ•°æ®ä¼ é€’åˆ°GPUå†…å­˜å¹¶è½¬æ¢çŸ©é˜µï¼ŒUnityå¯¹å­˜å‚¨åœ¨ææ–™å±æ€§å—ä¸­çš„å±æ€§æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Œä½†è¦ä½¿å…¶èµ·ä½œç”¨çš„è¯ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨shaderä¸­å®šä¹‰ä¸€ä¸ªinstanceçš„ç¼“å†²åŒºã€‚</p>

<p>å£°æ˜instanceç¼“å†²åŒºçš„å·¥ä½œç±»ä¼¼äºåˆ›å»ºè¯¸å¦‚æ’å€¼å™¨ä¹‹ç±»çš„ç»“æ„ï¼Œä½†æ˜¯ç¡®åˆ‡çš„è¯­æ³•å› å¹³å°è€Œå¼‚ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨UNITY_INSTANCING_CBUFFER_STARTå’ŒUNITY_INSTANCING_CBUFFER_ENDå®æ¥è§£å†³å·®å¼‚ã€‚ å¯ç”¨å®ä¾‹åŒ–åï¼Œå®ƒä»¬å°†ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚</p>

<p>å°†_Colorå˜é‡çš„å®šä¹‰æ”¾åœ¨instanceç¼“å†²åŒºä¸­ã€‚ UNITY_INSTANCING_CBUFFER_STARTå®éœ€è¦ä¸€ä¸ªåç§°å‚æ•°ï¼Œå®é™…åç§°æ— å…³ç´§è¦ä½†è¦æ³¨æ„é¿å…é‡åå†²çªã€‚ å®ä»¥UNITY_INSTANCING_ä¸ºå…¶å‰ç¼€ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UNITY_INSTANCING_CBUFFER_START</span><span class="p">(</span><span class="n">InstanceProperties</span><span class="p">)</span>
    <span class="kt">float4</span> <span class="n">_Color</span><span class="p">;</span>
<span class="n">UNITY_INSTANCING_CBUFFER_END</span>
</code></pre></div></div>

<p>åƒå˜æ¢çŸ©é˜µä¸€æ ·ï¼Œå¯ç”¨instanceåï¼Œé¢œè‰²æ•°æ®ä½œä¸ºæ•°ç»„ä¸Šä¼ åˆ°GPUã€‚UNITY_DEFINE_INSTANCED_PROPå®ä¼šä¸ºæˆ‘ä»¬å¤„ç†æ­£ç¡®çš„å£°æ˜è¯­æ³•ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UNITY_INSTANCING_CBUFFER_START</span><span class="p">(</span><span class="n">InstanceProperties</span><span class="p">)</span>
    <span class="c1">//float4 _Color;</span>
    <span class="n">UNITY_DEFINE_INSTANCED_PROP</span><span class="p">(</span><span class="kt">float4</span><span class="p">,</span> <span class="n">_Color</span><span class="p">)</span>
<span class="n">UNITY_INSTANCING_CBUFFER_END</span>
</code></pre></div></div>

<p>æœ€åè¦è®¿é—®fragmentç¨‹åºä¸­çš„æ•°ç»„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨å…¶ä¸­çŸ¥é“instanceIDã€‚ å› æ­¤ï¼Œå°†å…¶æ·»åŠ åˆ°æ’å€¼å™¨ç»“æ„ä¸­ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">InterpolatorsVertex</span> <span class="p">{</span>
    <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">Interpolators</span> <span class="p">{</span>
    <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
<span class="p">};</span>
</code></pre></div></div>

<p>åœ¨vertexé¡¶ç‚¹ç¨‹åºä¸­ï¼Œå°†IDä»é¡¶ç‚¹æ•°æ®å¤åˆ¶åˆ°æ’å€¼å™¨ã€‚ å¯ç”¨å®ä¾‹åŒ–æ—¶ï¼ŒUNITY_TRANSFER_INSTANCE_IDå®å®šä¹‰æ­¤ç®€å•æ“ä½œï¼Œå¦åˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">InterpolatorsVertex</span> <span class="nf">MyVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">InterpolatorsVertex</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">UNITY_INITIALIZE_OUTPUT</span><span class="p">(</span><span class="n">Interpolators</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">UNITY_SETUP_INSTANCE_ID</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="n">UNITY_TRANSFER_INSTANCE_ID</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨ç‰‡æ®µç¨‹åºçš„å¼€å¤´ï¼Œä½¿IDå…¨å±€å¯ç”¨ï¼Œå°±åƒåœ¨é¡¶ç‚¹ç¨‹åºä¸­ä¸€æ ·ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FragmentOutput</span> <span class="nf">MyFragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UNITY_SETUP_INSTANCE_ID</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ä¸ä½¿ç”¨instanceæ—¶ä»¥_Colorçš„å½¢å¼è®¿é—®é¢œè‰²ï¼Œè€Œåœ¨å¯ç”¨å®ä¾‹åŒ–æ—¶ä»¥_Color [unity_InstanceID]çš„å½¢å¼è®¿é—®é¢œè‰²ã€‚ ä½¿ç”¨UNITY_ACCESS_INSTANCED_PROPå®å¯åŒæ—¶æ”¯æŒä¸Šè¿°ä¸¤ç§è®¿é—®ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float3</span> <span class="nf">GetAlbedo</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float3</span> <span class="n">albedo</span> <span class="o">=</span>
        <span class="nb">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">).</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">UNITY_ACCESS_INSTANCED_PROP</span><span class="p">(</span><span class="n">_Color</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">float</span> <span class="nf">GetAlpha</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">UNITY_ACCESS_INSTANCED_PROP</span><span class="p">(</span><span class="n">_Color</span><span class="p">).</span><span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>æ–°ç‰ˆæœ¬å¦‚æœç¼–è¯‘æœ‰é”™è¯¯ï¼š
ä»2017.3åŠä»¥ä¸Šç‰ˆæœ¬, UNITY_ACCESS_INSTANCED_PROP macroæ”¹äº†å®ƒéœ€è¦çš„ä¸¤ä¸ªå‚æ•°ï¼šbufferåï¼Œé¢œè‰²åä½¿ç”¨UNITY_ACCESS_INSTANCED_PROP(InstanceProperties, _Color).
</code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender19/1692664-20200612010918398-38688989.png" width="250" /></center>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬çš„é¢œè‰²éšæœºçš„çƒå†æ¬¡è¢«æ‰¹å¤„ç†ã€‚ æˆ‘ä»¬<strong>å¯ä»¥ç”¨ç›¸åŒçš„æ–¹å¼ä½¿å…¶ä»–å±æ€§å¯å˜ã€‚ å¯¹äºé¢œè‰²ï¼Œæµ®ç‚¹æ•°ï¼ŒçŸ©é˜µå’Œå››åˆ†é‡æµ®ç‚¹å‘é‡ï¼Œè¿™æ˜¯å¯èƒ½çš„</strong>ã€‚ <strong>å¦‚æœè¦æ”¹å˜çº¹ç†ï¼Œå¯ä»¥ä½¿ç”¨å•ç‹¬çš„çº¹ç†æ•°ç»„</strong>ï¼Œå¹¶å°†ç´¢å¼•æ·»åŠ åˆ°å®ä¾‹åŒ–ç¼“å†²åŒºã€‚å…¶ä»–å±æ€§ä¿®æ”¹ç±»ä¼¼ã€‚</p>

<p>å¯ä»¥åœ¨åŒä¸€ä¸ªç¼“å†²åŒºä¸­ç»„åˆå¤šä¸ªå±æ€§ï¼Œä½†è¦ç‰¢è®°å¤§å°é™åˆ¶ã€‚ è¿˜åº”æ³¨æ„ï¼Œç¼“å†²åŒºè¢«åˆ’åˆ†ä¸º32ä½å—ï¼Œå› æ­¤å•ä¸ªæµ®ç‚¹æ•°éœ€è¦ä¸å‘é‡ç›¸åŒçš„ç©ºé—´ã€‚ æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨å¤šä¸ªç¼“å†²åŒºï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€ä¸ªé™åˆ¶ï¼Œå®ƒä»¬ä¸æ˜¯å…è´¹æä¾›çš„ã€‚ å¯ç”¨instanceåï¼Œæ¯ä¸ªè¦ç¼“å†²çš„å±æ€§éƒ½å°†æˆä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå› æ­¤ä»…å¯¹éœ€è¦æ ¹æ®instanceå˜åŒ–çš„å±æ€§æ‰§è¡Œæ­¤æ“ä½œã€‚</p>

<h3 id="é˜´å½±">é˜´å½±</h3>

<p>æˆ‘ä»¬çš„é˜´å½±ä¹Ÿå–å†³äºé¢œè‰²ã€‚ è°ƒæ•´shaderé˜´å½±ä»¥ä¾¿æ¯ä¸ªå®ä¾‹ä¹Ÿå¯ä»¥æ”¯æŒå”¯ä¸€çš„é¢œè‰²ã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//float4 _Color;</span>
<span class="n">UNITY_INSTANCING_CBUFFER_START</span><span class="p">(</span><span class="n">InstanceProperties</span><span class="p">)</span>
    <span class="n">UNITY_DEFINE_INSTANCED_PROP</span><span class="p">(</span><span class="kt">float4</span><span class="p">,</span> <span class="n">_Color</span><span class="p">)</span>
<span class="n">UNITY_INSTANCING_CBUFFER_END</span>

<span class="k">struct</span> <span class="n">InterpolatorsVertex</span> <span class="p">{</span>
    <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">Interpolators</span> <span class="p">{</span>
    <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
<span class="p">};</span>
<span class="n">float</span> <span class="nf">GetAlpha</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">UNITY_ACCESS_INSTANCED_PROP</span><span class="p">(</span><span class="n">_Color</span><span class="p">).</span><span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">InterpolatorsVertex</span> <span class="nf">MyShadowVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">InterpolatorsVertex</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">UNITY_SETUP_INSTANCE_ID</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="n">UNITY_TRANSFER_INSTANCE_ID</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">float4</span> <span class="nf">MyShadowFragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="n">UNITY_SETUP_INSTANCE_ID</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="lod-instance">LOD Instance</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">void</span> <span class="nf">Start</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">MaterialPropertyBlock</span> <span class="n">properties</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MaterialPropertyBlock</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">instances</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">Transform</span> <span class="n">t</span> <span class="p">=</span> <span class="nf">Instantiate</span><span class="p">(</span><span class="n">prefab</span><span class="p">);</span>
        <span class="n">t</span><span class="p">.</span><span class="n">localPosition</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">insideUnitSphere</span> <span class="p">*</span> <span class="n">radius</span><span class="p">;</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">SetParent</span><span class="p">(</span><span class="n">transform</span><span class="p">);</span>
        <span class="c1">//MaterialPropertyBlock properties = new MaterialPropertyBlock();</span>
        <span class="n">properties</span><span class="p">.</span><span class="nf">SetColor</span>
        <span class="p">(</span>
            <span class="s">"_Color"</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Color</span><span class="p">(</span><span class="n">Random</span><span class="p">.</span><span class="k">value</span><span class="p">,</span> <span class="n">Random</span><span class="p">.</span><span class="k">value</span><span class="p">,</span> <span class="n">Random</span><span class="p">.</span><span class="k">value</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="c1">//t.GetComponent&lt;MeshRenderer&gt;().SetPropertyBlock(properties);</span>
        <span class="n">MeshRenderer</span> <span class="n">r</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">MeshRenderer</span><span class="p">&gt;();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="n">r</span><span class="p">.</span><span class="nf">SetPropertyBlock</span><span class="p">(</span><span class="n">properties</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> 
        <span class="p">{</span>
            <span class="c1">//å¯¹LODå­å¯¹è±¡è®¾ç½®é¢œè‰²</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">ci</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">ci</span> <span class="p">&lt;</span> <span class="n">t</span><span class="p">.</span><span class="n">childCount</span><span class="p">;</span> <span class="n">ci</span><span class="p">++)</span> <span class="p">{</span>
                <span class="n">r</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">GetChild</span><span class="p">(</span><span class="n">ci</span><span class="p">).</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">MeshRenderer</span><span class="p">&gt;();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">r</span><span class="p">.</span><span class="nf">SetPropertyBlock</span><span class="p">(</span><span class="n">properties</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender19/1692664-20200612010919954-2006515171.png" width="250" /></center>

<p>ä¸å¹¸çš„æ˜¯æ²¡æœ‰æœ‰æ•ˆçš„æ‰¹å¤„ç†ã€‚Unityèƒ½å¤Ÿå¯¹ä»¥ç›¸åŒçš„LODé¢œè‰²çƒä½“è¿›è¡Œæ‰¹å¤„ç†ï¼Œä½†æ˜¯å¦‚æœå¯ä»¥åƒå¾€å¸¸ä¸€æ ·è¿›è¡Œæ‰¹å¤„ç†ä¼šæ›´å¥½ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡ç”¨ç¼“å†²æ•°ç»„æ›¿æ¢unity_LODFadeæ¥å®ç°ã€‚å¯ä»¥é€šè¿‡ä¸ºæ”¯æŒå®ä¾‹åŒ–çš„æ¯ä¸ªè¿‡ç¨‹æ·»åŠ lodfadeå®ä¾‹åŒ–é€‰é¡¹æ¥æŒ‡ç¤ºUnityçš„ç€è‰²å™¨ä»£ç æ‰§è¡Œæ­¤æ“ä½œã€‚</p>

<div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma multi_compile_instancing
#pragma instancing_options lodfade
</span></code></pre></div></div>

<!--url1 url2 url3 url4 url5
    ä»£è¡¨ä¸€æ¬¡åŠ è½½å¤šå°‘å¼ å›¾
-->
<center class="half"><img loading="lazy" src="https://img.damonc.top/posts/2018/month1/catRender19/1692664-20200612010921540-656727216.png" width="250" /><font size="2.5">
            <i>instance LOD fading.</i>
        </font></center>]]></content><author><name>catlikecoding</name></author><category term="Shader" /><summary type="html"><![CDATA[è¿˜æœ‰å¦ä¸€ç§ç»„åˆdraw callçš„æ–¹æ³•ï¼šGPU instanceæˆ–Geometry instanceã€‚ä¸åŠ¨æ€æ‰¹å¤„ç†ä¸€æ ·ï¼Œæ­¤æ“ä½œåœ¨è¿è¡Œæ—¶é’ˆå¯¹å¯è§å¯¹è±¡ã€‚ å®ƒçš„ç›®æ ‡æ˜¯è®©GPUä¸€æ¬¡æ€§æ¸²æŸ“åŒä¸€ç½‘æ ¼çš„å¤šä¸ªå‰¯æœ¬ã€‚ å› æ­¤ï¼Œå®ƒä¸èƒ½ç»„åˆä¸åŒçš„ç½‘æ ¼æˆ–æè´¨ï¼Œä½†ä¸ä»…é™äºå°ç½‘æ ¼ã€‚]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://www.damonc.top/posts/2018/month1/catRender19/tutorial-image.png" /><media:content medium="image" url="https://www.damonc.top/posts/2018/month1/catRender19/tutorial-image.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>