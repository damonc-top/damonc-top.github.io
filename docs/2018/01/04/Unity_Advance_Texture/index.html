<!DOCTYPE html><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="baidu-site-verification" content="code-BGVivWGmxV" /><title>Unity çº¹ç†é«˜çº§ç”¨æ³•(ç¿»è¯‘å…­)</title><meta name="description" content="æœ¬ç¯‡æ‘˜è¦: æ‰°åŠ¨æ³•çº¿ä»¥æ¨¡æ‹Ÿå‡¹å‡¸è§†è§‰ ä»é«˜åº¦åœºè®¡ç®—æ³•çº¿ é‡‡æ ·å’Œæ··åˆæ³•çº¿è´´å›¾ ä»åˆ‡çº¿ç©ºé—´è½¬æ¢åˆ°ä¸–ç•Œç©ºé—´"><link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon"><link rel="icon" href="/favicon.ico?" type="image/x-icon"><link rel="stylesheet" href="/css/main.css "><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href=" /css/font_8v3czwksspqlg14i.css "><link rel="canonical" href="https://www.damonc.top/2018/01/04/Unity_Advance_Texture/"><link rel="alternate" type="application/rss+xml" title="çˆ±ç©¿æ‹–é‹" href="https://www.damonc.top/feed.xml "> <script src=" /js/Valine.min.js " charset="utf-8"></script> <script src=" /js/jquery_3_2_0.min.js " charset="utf-8"></script> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "//hm.baidu.com/hm.js?f7f1a5967e3927ea98597632f0a17ad9"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script async src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><body class="custom-background"><header id="top"><div class="wrapper"> <a href="/" class="brand">çˆ±ç©¿æ‹–é‹</a> <small>è‡ªç”±è‡ªåœ¨ğŸ©´</small> <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button><nav id="headerNav"><ul><li> <a href="/"> <i class="fa fa-home"></i>Home </a><li> <a href="/archive/"> <i class="fa fa-archive"></i>å½’æ¡£ </a><li> <a href="/category/"> <i class="fa fa-th-list"></i>åˆ†ç±» </a><li> <a href="/tag/"> <i class="fa fa-tags"></i>æ ‡ç­¾ </a><li> <a href="/collection/"> <i class="fa fa-bookmark"></i>æ”¶é›† </a><li> <a href="/demo/"> <i class="fa fa-play"></i>å·¥å…· </a><li> <a href="/about/"> <i class="fa fa-heart"></i>About </a></ul></nav></div></header><div class="home-right-bar"> <button class="anchor"><i class="fa fa-anchor"></i></button><div class="right"><div class="wrap"><div class="side content"><div> ç›®å½•</div><ul id="content-side" class="content-ul"><li><a href="#comments">Comments</a></ul></div></div></div></div><div class="page clearfix" post><div class="left"><h1>Unity çº¹ç†é«˜çº§ç”¨æ³•(ç¿»è¯‘å…­)</h1><div class="label"><div class="label-card"> <i class="fa fa-calendar"></i>2018-01-04</div><div class="label-card"> <i class="fa fa-user"></i>catlikecoding</div><div class="label-card"></div><div class="label-card"> <span class="categories"> <i class="fa fa-th-list"></i> <a href="/category/#ç¿»è¯‘" title="Category: ç¿»è¯‘" rel="category">ç¿»è¯‘</a> </span></div><div class="label-card"> <span class="pageTag"> <i class="fa fa-tags"></i> <b href="/tag/#Shader" title="Tag: Shader" rel="tag">Shader</b>&nbsp; <b href="/tag/#Unity3d" title="Tag: Unity3d" rel="tag">Unity3d</b> </span></div></div><hr><article itemscope itemtype="http://schema.org/BlogPosting"><ul id="markdown-toc"><li><a href="#bump-mapå‡¹å‡¸è´´å›¾" id="markdown-toc-bump-mapå‡¹å‡¸è´´å›¾">Bump Map(å‡¹å‡¸è´´å›¾):</a><ul><li><a href="#é«˜åº¦å›¾-heightmap" id="markdown-toc-é«˜åº¦å›¾-heightmap">é«˜åº¦å›¾-HeightMap</a><li><a href="#æ³•çº¿-normal-map" id="markdown-toc-æ³•çº¿-normal-map">æ³•çº¿-Normal Map</a><li><a href="#ç»†èŠ‚çº¹ç†ä¸ç»†èŠ‚æ³•çº¿-detail-mapssecond-texture-ä¸-detail-normals" id="markdown-toc-ç»†èŠ‚çº¹ç†ä¸ç»†èŠ‚æ³•çº¿-detail-mapssecond-texture-ä¸-detail-normals">ç»†èŠ‚çº¹ç†ä¸ç»†èŠ‚æ³•çº¿-Detail Maps(Second Texture) ä¸ Detail Normals</a><li><a href="#æ³•çº¿èåˆ-blending-normals" id="markdown-toc-æ³•çº¿èåˆ-blending-normals">æ³•çº¿èåˆ-Blending Normals</a><li><a href="#åˆ‡çº¿ç©ºé—´-tangent-space" id="markdown-toc-åˆ‡çº¿ç©ºé—´-tangent-space">åˆ‡çº¿ç©ºé—´-Tangent Space</a></ul><li><a href="#è½¬æ¢ç©ºé—´" id="markdown-toc-è½¬æ¢ç©ºé—´">è½¬æ¢ç©ºé—´</a><ul><li><a href="#å‰¯åˆ‡çº¿åœ¨å“ªç®—åˆé€‚" id="markdown-toc-å‰¯åˆ‡çº¿åœ¨å“ªç®—åˆé€‚">å‰¯åˆ‡çº¿åœ¨å“ªç®—åˆé€‚</a></ul></ul><p>æœ¬ç¯‡æ‘˜è¦:</p><ul><li>æ‰°åŠ¨æ³•çº¿ä»¥æ¨¡æ‹Ÿå‡¹å‡¸è§†è§‰<li>ä»é«˜åº¦åœºè®¡ç®—æ³•çº¿<li>é‡‡æ ·å’Œæ··åˆæ³•çº¿è´´å›¾<li>ä»åˆ‡çº¿ç©ºé—´è½¬æ¢åˆ°ä¸–ç•Œç©ºé—´</ul><h2 id="bump-mapå‡¹å‡¸è´´å›¾">Bump Map(å‡¹å‡¸è´´å›¾):</h2><table><thead><tr><th>Bump Map Type<th>Describe<tbody><tr><td>NormalMap<td>æ³•çº¿å›¾ï¼Œæ˜ å°„å…¬å¼ï¼šnormal=pixel*2-1,åæ˜ å°„ï¼špixel=(normal+1)/2. æ³•çº¿å­˜å‚¨æ—¢å¯ä»¥åœ¨<br />æ¨¡å‹ç©ºé—´ï¼Œä¹Ÿå¯ä»¥åœ¨åˆ‡çº¿ç©ºé—´ã€‚//unityé¡¶ç‚¹è¾“å…¥ç»“æ„å¸¦åˆ‡çº¿å˜é‡ï¼Œä¸€èˆ¬å­˜åœ¨åˆ‡çº¿ç©ºé—´æ›´ä½³<tr><td>HeightMap<td>ç°åº¦å›¾(é»‘ç™½çº¹ç†-å¼ºåº¦å€¼)ï¼Œé¢œè‰²è¶Šæµ…è¯¥è¡¨é¢è¶Šå‘å¤–å‡¸èµ·ï¼Œé¢œè‰²æ·±è¶Šå‡¹ã€‚è§†å·®æ˜ å°„æŠ€æœ¯ï¼Œä¸<br />Occlusion Mapæ­é…ä½¿ç”¨ä½“éªŒæ›´ä½³ï¼Œè®¡ç®—æ˜‚è´µ<tr><td>Occlusion Map<td>ç°åº¦å›¾ï¼Œè¡¨é¢ç»†èŠ‚æ›´ä¸°å¯Œã€‚é¢œè‰²å€¼ç™½è‰²è¡¨ç¤ºåº”è¯¥æ¥æ”¶å®Œå…¨é—´æ¥ç…§æ˜çš„åŒºåŸŸï¼Œé»‘è‰²è¡¨ç¤ºæ²¡æœ‰<br />é—´æ¥ç…§æ˜ã€‚å¦‚è£‚ç¼æˆ–è¤¶çš±ï¼Œå®é™…ä¸Šä¸ä¼šæ¥æ”¶åˆ°å¤ªå¤šçš„é—´æ¥å…‰ï¼Œå¯ä¸é«˜åº¦å›¾ä¸€èµ·ä½¿ç”¨<tr><td>Detail Maps<td>å‚è€ƒStandardShader:ç¬¬äºŒç»†èŠ‚çº¹ç†ï¼Œåº”ç”¨ç¬¬äºŒåç…§ç‡å›¾å’Œç¬¬äºŒæ³•çº¿å›¾ï¼Œåœ¨è¿‘è·ç¦»è§‚å¯Ÿæ—¶<br />æœ‰æ¸…æ™°çš„ç»†èŠ‚ï¼Œæ¯”å¦‚æ¯›å­”ã€ç»†å°çš„è£‚ç¼ç­‰ã€‚è®¡ç®—æ˜‚è´µ</table><blockquote class="prompt-tip"><p>å¸¸ç”¨çº¹ç†<br /> NormalMap æ³•çº¿çº¹ç†ï¼šæ¯”è¾ƒå¸¸ç”¨<br /> HeightMap é«˜åº¦çº¹ç†(è§†å·®æ˜ å°„)ï¼šæ‰‹æœºå¹³å°ä¸å¸¸ç”¨ï¼Œä½¿ç”¨æ³•çº¿çº¹ç†æ›¿ä»£<br /> Occlusion Mapï¼šç»†èŠ‚çº¹ç†<br /> Secondary Maps (Detail Maps) &amp; Detail Maskï¼šç»†èŠ‚çº¹ç†<br /></p></blockquote><h3 id="é«˜åº¦å›¾-heightmap">é«˜åº¦å›¾-HeightMap</h3><p>é«˜åº¦å›¾ä¸ºäº†æ¨¡æ‹Ÿå¹³é¢çš„å‡¹å‡¸ç¨‹åº¦ï¼Œå°†é«˜åº¦(é»‘ç™½è‰²)æ•°æ®å­˜å‚¨åœ¨çº¹ç†ä¸­ï¼Œç”±äºçº¹ç†æ•°æ®æ˜¯äºŒç»´çš„ï¼Œå³uè½´å’Œvè½´ï¼Œé‚£ä¸ºäº†å¾—åˆ°è¿™äº›æ•°æ®ä¸ºæ¯ä¸ªç‰‡æ®µç”Ÿæˆæ³•å‘é‡ï¼Œå¯åˆ†åˆ«åœ¨uè½´å’Œvè½´ä¸Šé‡‡æ ·ã€‚å…ˆä»Uè½´è®¡ç®—ï¼šf(<em>u</em>)=h ,å¦‚æœçŸ¥é“äº†æ–œç‡å°±èƒ½æ±‚å¾—uè½´ä¸Šæ‰€æœ‰ç‚¹çš„æ³•å‘é‡ï¼Œä½†æ–œç‡ç”±hçš„å˜åŒ–ç¨‹åº¦é«˜ä½å†³å®šã€‚ä¸ºäº†è¿‘ä¼¼å¾—åˆ°ä»ä¸€ä¸ªç‚¹åˆ°ä¸‹ä¸€ä¸ªç‚¹çš„é«˜åº¦å·®ï¼š</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender6/1692664-20191105100150635-879071241.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æ–œç‡é‡‡æ ·ç¤ºæ„å›¾ï¼Œä»$f(0) \rightarrow f(1)$.</a></i></center> </font><p>è¿™æ˜¯å¯¹åˆ‡å‘é‡çš„ä¸€ä¸ªç²—ç•¥çš„ä¼°ç®—ï¼Œå®ƒæŠŠæ•´å¼ çº¹ç†ä½œä¸ºçº¿æ€§çš„æ–œç‡ã€‚é‚£ä¸ºäº†é¿å…è¿™ç§ç²—ç•¥è®¡ç®—ï¼Œå¯ä»¥é‡‡æ ·ä¸¤ä¸ªé çš„æ›´è¿‘ç‚¹çš„ã€‚ä¾‹å¦‚ï¼Œä»$0 \rightarrow {1\over2}$ï¼Œé‚£è¿™ä¸¤ç‚¹çš„æ–œç‡$f=f({1 \over 2})-f(0)$ï¼ŒåŒæ—¶få› å­è¢«ç¼©å°ï¼Œéœ€è¦ä¹˜ä»¥ç›¸åº”çš„å€æ•°ã€‚$2f({1 \over 2})-f(0)$ã€‚æ‰©å±•å¼€æ¥ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„å‡½æ•°ï¼šÎ´å€¼è¶Šå°è¶Šç²¾ç¡®ï¼Œå¿…é¡»å¤§äº0å°äº1.</p><p>å·®åˆ†å‡½æ•°:</p>\[f^`(u) = {f(u+Î´) - f(u) \over Î´}\]<p>æœ‰é™å·®åˆ†å‡½æ•°:</p>\[f^`(u)= lim_{(Î´\rightarrow 0)} {f(u+Î´) - f(u) \over Î´}\]<p>é‚£ä¹ˆåˆ‡å‘é‡å°±æ˜¯ \(\begin{bmatrix} 1&amp;f`(u)&amp;0 \end{bmatrix}^\mathrm{T}\) ï¼Œä»åˆ‡å‘é‡è®¡ç®—æ³•å‘é‡ \(\begin{bmatrix} fâ€™(u)&amp;1&amp;0 \end{bmatrix}^\mathrm{T}\)</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sampler2D</span> <span class="n">_HeightMap</span><span class="p">;</span>
<span class="n">float4</span> <span class="n">_HeightMap_TexelSize</span><span class="p">;</span><span class="c1">//xyæ˜¯çº¹ç´ åæ ‡(uv)ï¼Œzwæ˜¯æ•´å¼ çº¹ç†å®½é«˜</span>
<span class="n">float2</span> <span class="n">delta</span> <span class="p">=</span> <span class="nf">float2</span><span class="p">(</span><span class="n">_HeightMap_TexelSize</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span><span class="c1">//uè½´</span>
<span class="kt">float</span> <span class="n">h1</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_HeightMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span><span class="c1">//æ¨¡å‹uvåœ¨é«˜åº¦å›¾é‡‡æ ·</span>
<span class="kt">float</span> <span class="n">h2</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_HeightMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="p">+</span> <span class="n">delta</span><span class="p">);</span><span class="c1">//äºŒæ¬¡é‡‡æ ·</span>

<span class="c1">//ç¬¬ä¸€æ­¥å¥—ç”¨å…¬å¼</span>
<span class="c1">//i.normal = float3(1, (h2 - h1) / delta.x, 0); </span>

<span class="c1">//ç¬¬äºŒæ­¥ä¼˜åŒ–ï¼Œç¼©æ”¾å‘é‡å¹¶ä¸æ”¹å˜æ–¹å‘ï¼Œæ¶ˆé™¤äº†é™¤æ³•æ“ä½œ</span>
<span class="c1">//i.normal = float3( delta.x, (h2 - h1), 0);</span>

<span class="c1">//ç¬¬ä¸‰æ­¥æ”¹å˜å‚ç›´æ–¹å‘ï¼Œéœ€è¦å¾—åˆ°æ³•å‘é‡æ­£å‘å‚ç›´äºè¡¨é¢ï¼Œé‚£ä¹ˆé€†æ—¶é’ˆæ—‹è½¬90åº¦ä»¥ç¿»è½¬xåˆ†é‡ç¬¦å·.//Yæ˜¯æ‰°åŠ¨æ³•å‘é‡çš„é«˜ä½å˜åŒ–å› å­</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">float3</span><span class="p">(</span> <span class="n">h1</span> <span class="p">-</span> <span class="n">h2</span><span class="p">,</span> <span class="m">1</span> <span class="p">,</span> <span class="m">0</span><span class="p">);</span>

<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
</code></pre></div></div><p>æœ‰é™å·®åˆ†åªåœ¨ä¸€ä¸ªæ–¹å‘è¿‘ä¼¼æ±‚å€¼ï¼Œä¸ºäº†æ›´å¥½è¿‘ä¼¼å¯ä»¥åœ¨ä¸¤ä¸ªæ–¹å‘çº¿æ€§é€¼è¿‘.</p><p>ä¸­å¿ƒå·®åˆ†:</p>\[f^`(u)= lim_{(Î´\rightarrow 0)} {f(u+{Î´\over 2}) - f(u - {Î´\over 2}) \over Î´}\]<div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float2</span> <span class="n">delta</span> <span class="p">=</span> <span class="nf">float2</span><span class="p">(</span><span class="n">_HeightMap_TexelSize</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">h1</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_HeightMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="p">-</span> <span class="n">delta</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">h2</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_HeightMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="p">+</span> <span class="n">delta</span><span class="p">);</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">float3</span><span class="p">(</span><span class="n">h1</span> <span class="p">-</span> <span class="n">h2</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
</code></pre></div></div><p>é‚£ä¹ˆ$fâ€™(u, v)$è®¡ç®—$fâ€™(v)$åŒç†,åˆ‡å‘é‡ \(\begin{bmatrix} 0&amp;fâ€™(v)&amp;1 \end{bmatrix}^\mathrm{T}\) æ³•å‘é‡æ˜¯ \(\begin{bmatrix} 0&amp;1&amp;fâ€™(v) \end{bmatrix}^\mathrm{T}\)</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float2</span> <span class="n">du</span> <span class="p">=</span> <span class="nf">float2</span><span class="p">(</span><span class="n">_HeightMap_TexelSize</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">u1</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_HeightMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="p">-</span> <span class="n">du</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">u2</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_HeightMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="p">+</span> <span class="n">du</span><span class="p">);</span>
<span class="c1">//float3 tu = float3(1, u2 - u1, 0);</span>
<span class="n">float2</span> <span class="n">dv</span> <span class="p">=</span> <span class="nf">float2</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">_HeightMap_TexelSize</span><span class="p">.</span><span class="n">y</span> <span class="p">*</span> <span class="m">0.5</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">v1</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_HeightMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="p">-</span> <span class="n">dv</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">v2</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_HeightMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="p">+</span> <span class="n">dv</span><span class="p">);</span>
<span class="c1">//float3 tv = float3(0, v2 - v1, 1);</span>
<span class="c1">//i.normal = cross(tv, tu);//ç›´æ¥ä½¿ç”¨å‰ç§¯æ±‚å‡ºå‚ç›´äºuå’Œvè½´çš„æ³•å‘é‡=&gt;(0*(v2-v1)-(u2-u1)*1, 1*1-0*0, (u2-u1)*0-1*(v2-v1))=(u1-u2, 1, v1-v2)</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">float3</span><span class="p">(</span><span class="n">u1</span> <span class="p">-</span> <span class="n">u2</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="n">v1</span> <span class="p">-</span> <span class="n">v2</span><span class="p">);</span>

<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
</code></pre></div></div><p>\(\begin{bmatrix} 0\\fâ€™(v)\\1 \end{bmatrix}\) x \(\begin{bmatrix} 1\\fâ€™(u)\\0 \end{bmatrix}\) = \(\begin{bmatrix} -fâ€™(u)\\1\\-fâ€™(v) \end{bmatrix}\)</p><h3 id="æ³•çº¿-normal-map">æ³•çº¿-Normal Map</h3><p>é«˜åº¦å›¾æ˜¯æ¯å¸§é‡‡æ ·å®æ—¶è®¡ç®—æ³•çº¿ï¼Œä¸ºäº†é¿å…é«˜é¢è®¡ç®—é‡ï¼Œé‡‡ç”¨é¢„åˆ¶æ³•çº¿çº¹ç†ä»£æ›¿ã€‚</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender6/1692664-20191105100152927-1516726103.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>Unityä¸­ä½¿ç”¨é«˜åº¦å›¾.</a></i></center> </font><p>å¯¼å…¥é«˜åº¦å›¾ä½œä¸ºæ³•çº¿è´´å›¾é¢„å…ˆè®¡ç®—æ³•çº¿çº¹ç†å¿…é¡»å‹¾é€‰Create from Grayscaleï¼Œç™½è‰²è¡¨ç¤ºç›¸å¯¹æ›´é«˜ï¼Œé»‘è‰²è¡¨ç¤ºç›¸å¯¹æ›´ä½ã€‚</p><p>åƒç´ åˆ†é‡èŒƒå›´æ˜¯[0,1]ï¼Œè€Œæ³•çº¿åˆ†é‡èŒƒå›´[-1,1]ã€‚ç›¸äº’æ˜ å°„è½¬æ¢å…¬å¼ä¸ºï¼š</p><p>$pixel = {(normal+1)\over 2}$</p><p>$normal = pixel \cdot 2 â€“ 1$</p><p>æ³•çº¿çº¹ç†å‘ˆç°æ·¡è“è‰²ï¼Œè¿™æ˜¯å› ä¸ºæ³•å‘æ˜ å°„æœ€å¸¸è§çš„çº¦å®šæ˜¯å°†å‘ä¸Šçš„æ–¹å‘å­˜å‚¨åœ¨Zåˆ†é‡ä¸­(å‚ç›´äºè¡¨é¢å¤–ä¾§)ï¼Œåˆç”±äºDXT5nmçº¹ç†å‹ç¼©æ ¼å¼çš„åŸå› ï¼Œåªå­˜å‚¨äº†Xä¸Yåˆ†é‡èˆå¼ƒäº†Zåˆ†é‡(Yåˆ†é‡å­˜å‚¨åœ¨Gé€šé“ï¼ŒXåˆ†é‡å­˜å‚¨åœ¨Aé€šé“ï¼ŒRBé€šé“è¢«èˆå¼ƒ)ã€‚é€šè¿‡æ¨å¯¼æ³•å‘é‡çš„å•ä½å‘é‡å¯å¾—Zåˆ†é‡ï¼š</p><p>$ |N| = |N|^2 = N_x{^2} + N_y{^2} + N_z{^2} = 1 $</p><p>$Nz = \sqrt{1 - N_x{^2} - N_y{^2}}$</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ç¬¬ä¸€ç§æ–¹æ³•</span>
<span class="c1">// Unpack normal as DXT5nm (1, y, 1, x) or BC5 (x, y, 0, 1)</span>
<span class="c1">//dxt5å‹ç¼©å¯¹åº”çš„ä½ç½®å–wy</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">xy</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">).</span><span class="n">wy</span> <span class="p">*</span> <span class="m">2</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">xy</span> <span class="p">*=</span> <span class="n">_BumpScale</span><span class="p">;</span><span class="c1">//è®¡ç®—Zä¹‹å‰ç¼©æ”¾æ‰æœ‰æ•ˆï¼Œå¹³å¦å‡¹å‡¸ç¨‹åº¦</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="nf">saturate</span><span class="p">(</span><span class="nf">dot</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">xy</span><span class="p">)));</span><span class="c1">//dotæ¨¡æ‹Ÿå¹³æ–¹è®¡ç®—-((x,y)*(x,y))=-xæ–¹-yæ–¹</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">xzy</span><span class="p">;</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>

<span class="c1">//ç¬¬äºŒç§æ–¹æ³•</span>
<span class="c1">//UnityStandardUtils.cgincåŒ…å«äº†è§£ç æ³•çº¿å‡½æ•°ï¼Œæ›¿ä»£ä¸Šé¢çš„æ–¹æ³•</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">UnpackScaleNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">),</span> <span class="n">_BumpScale</span><span class="p">);</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">xzy</span><span class="p">;</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
</code></pre></div></div><h3 id="ç»†èŠ‚çº¹ç†ä¸ç»†èŠ‚æ³•çº¿-detail-mapssecond-texture-ä¸-detail-normals">ç»†èŠ‚çº¹ç†ä¸ç»†èŠ‚æ³•çº¿-Detail Maps(Second Texture) ä¸ Detail Normals</h3><p>ç¬¬äºŒç»†èŠ‚çº¹ç†ä¸MainTextureåˆå¹¶ï¼Œç®€è¦ä»£ç å¦‚ä¸‹ï¼š</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//é¡¶ç‚¹uvåæ ‡æ˜ å°„åˆ°çº¹ç†uv</span>
<span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span>  <span class="p">=</span> <span class="nf">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
<span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span> <span class="p">=</span> <span class="nf">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_DetailTex</span><span class="p">);</span>
<span class="c1">//è®¡ç®—ç¬¬äºŒçº¹ç†çš„å½±å“</span>
<span class="n">float3</span> <span class="n">albedo</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">).</span><span class="n">rgb</span> <span class="p">*</span> <span class="n">_Tint</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
<span class="n">albedo</span> <span class="p">*=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_DetailTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span><span class="p">)</span> <span class="p">*</span> <span class="n">unity_ColorSpaceDouble</span><span class="p">;</span><span class="c1">//é¢œè‰²ç©ºé—´è½¬æ¢</span>
</code></pre></div></div><p>ç¬¬äºŒç»†èŠ‚çº¹ç†çš„æ³•çº¿æ˜ å°„</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">UnpackScaleNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">),</span> <span class="n">_BumpScale</span><span class="p">);</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">UnpackScaleNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_DetailNormalMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span><span class="p">),</span> <span class="n">_DetailBumpScale</span><span class="p">);</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">xzy</span><span class="p">;</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
</code></pre></div></div><h3 id="æ³•çº¿èåˆ-blending-normals">æ³•çº¿èåˆ-Blending Normals</h3><p>æ–¹å¼ä¸€ï¼š(main.normal + details.normal) * 0.5; ç®€å•å®¹æ˜“ï¼Œä½†ç»“æœä¸æ˜¯å¾ˆå¥½ã€‚ä¸»çº¹ç†å’Œç»†èŠ‚çº¹ç†éƒ½å˜å¾—å¹³å¦ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œå½“å…¶ä¸­ä¸€ä¸ªæ˜¯å¹³çš„ï¼ŒæœŸæœ›å®ƒä¸ä¼šå½±å“åˆ°å¦ä¸€ä¸ªã€‚</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">mainNormal</span> <span class="p">=</span> <span class="nf">UnpackScaleNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">),</span> <span class="n">_BumpScale</span><span class="p">);</span>
<span class="n">float3</span> <span class="n">detailNormal</span> <span class="p">=</span> <span class="nf">UnpackScaleNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_DetailNormalMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span><span class="p">),</span> <span class="n">_DetailBumpScale</span><span class="p">);</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="p">(</span><span class="n">mainNormal</span> <span class="p">+</span> <span class="n">detailNormal</span><span class="p">)</span> <span class="p">*</span> <span class="m">0.5</span><span class="p">;</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">xzy</span><span class="p">;</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
</code></pre></div></div><p>æ–¹å¼äºŒï¼šç”¨zåˆ†é‡åšç¼©æ”¾å› å­æ±‚åå¯¼å‡½æ•°ï¼Œç„¶åç›¸åŠ ã€‚[Mx, My, Mz]T = [Mx/Mz, My/Mz, 1]T åŒç†æ±‚å¾—detailåå¯¼å‡½æ•°ï¼Œç„¶åç›¸åŠ ï¼š[Mx/Mz + Dx/Dz, My/Mz + Dy/Dz, 1]T .æ•ˆæœå¾ˆå¥½ï¼Œä½†æ˜¯åœ¨åˆå¹¶é™¡å³­æ—¶ä»å°†å¤±å»ç»†èŠ‚ã€‚</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">mainNormal</span> <span class="p">=</span> <span class="nf">UnpackScaleNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">),</span> <span class="n">_BumpScale</span><span class="p">);</span>
<span class="n">float3</span> <span class="n">detailNormal</span> <span class="p">=</span> <span class="nf">UnpackScaleNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_DetailNormalMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span><span class="p">),</span> <span class="n">_DetailBumpScale</span><span class="p">);</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">float3</span><span class="p">(</span><span class="n">mainNormal</span><span class="p">.</span><span class="n">xy</span> <span class="p">/</span> <span class="n">mainNormal</span><span class="p">.</span><span class="n">z</span> <span class="p">+</span> <span class="n">detailNormal</span><span class="p">.</span><span class="n">xy</span> <span class="p">/</span> <span class="n">detailNormal</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">xzy</span><span class="p">;</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
</code></pre></div></div><p>æ–¹å¼ä¸‰ï¼šç™½è‰²è°ƒå’Œï¼Œå¯¹ä¸Šä¸€æ­¥åˆå¹¶æ³•çº¿åˆ†åˆ«ä¹˜ä»¥MzDz,ç„¶åå†å»æ‰xå’Œyçš„ç¼©æ”¾å› å­å¤¸å¤§ç¼©æ”¾ï¼Œä½¿é™¡å³­æ›´åŠ æ˜æ˜¾ï¼ŒåŒæ—¶å¹³å¦çš„æ³•çº¿ï¼Œå®ƒä¸ä¼šå½±å“åˆ°å¦ä¸€ä¸ªäº†ã€‚</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">mainNormal</span> <span class="p">=</span> <span class="nf">UnpackScaleNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">),</span> <span class="n">_BumpScale</span><span class="p">);</span>
<span class="n">float3</span> <span class="n">detailNormal</span> <span class="p">=</span> <span class="nf">UnpackScaleNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_DetailNormalMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span><span class="p">),</span> <span class="n">_DetailBumpScale</span><span class="p">);</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">float3</span><span class="p">(</span><span class="n">mainNormal</span><span class="p">.</span><span class="n">xy</span> <span class="p">+</span> <span class="n">detailNormal</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">mainNormal</span><span class="p">.</span><span class="n">z</span> <span class="p">*</span> <span class="n">detailNormal</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="c1">//UnityStandardUtilsåŒ…å«äº†æ··åˆå‡½æ•°</span>
<span class="c1">//i.normal = BlendNormals(mainNormal, detailNormal);</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">xzy</span><span class="p">;</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span><span class="n">View</span> <span class="n">Code</span>
</code></pre></div></div><h3 id="åˆ‡çº¿ç©ºé—´-tangent-space">åˆ‡çº¿ç©ºé—´-Tangent Space</h3><p>åˆ‡çº¿ç©ºé—´çš„æ³•çº¿çº¹ç†ï¼šé¡¶ç‚¹ä¸ºåŸç‚¹ï¼Œzè½´ä¸ºæ³•çº¿æ–¹å‘ï¼Œxè½´ä¸ºåˆ‡çº¿æ–¹å‘ï¼Œyè½´ä¸ºå‚ç›´äºxzçš„å‰¯åˆ‡çº¿æ–¹å‘ã€‚Unityå¯¼å…¥æ¨¡å‹è®¡ç®—åˆ‡çº¿é»˜è®¤ä½¿ç”¨äº†mikktspace(åœ¨é¡¶ç‚¹ç€è‰²å™¨è®¡ç®—)ï¼Œä¹Ÿå¯ä»¥åœ¨ç‰‡å…ƒç€è‰²å™¨è®¡ç®—crosså¾—åˆ°å‰¯åˆ‡çº¿å‘é‡ã€‚</p><p>é¡¶ç‚¹ä¸‹è®¡ç®—ï¼š</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">VertexData</span> <span class="p">{</span>
	<span class="n">float4</span> <span class="n">tangent</span> <span class="p">:</span> <span class="n">TANGENT</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="nc">Interpolators</span> <span class="p">{</span>
	<span class="n">float4</span> <span class="n">tangent</span> <span class="p">:</span> <span class="n">TEXCOORD2</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div><p>ä½¿ç”¨UnityCGä¸­çš„UnityObjectToWorldDiråœ¨é¡¶ç‚¹ç¨‹åºä¸­å°†åˆ‡çº¿è½¬æ¢ä¸ºä¸–ç•Œç©ºé—´ã€‚ å½“ç„¶ï¼Œè¿™ä»…é€‚ç”¨äºåˆ‡çº¿çš„XYZéƒ¨åˆ†ã€‚ å®ƒçš„Wåˆ†é‡éœ€è¦ä¸åŠ ä¿®æ”¹åœ°ä¼ é€’ã€‚</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Interpolators</span> <span class="nf">MyVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">Interpolators</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">i</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="nf">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_MVP</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">position</span><span class="p">);</span>
	<span class="n">i</span><span class="p">.</span><span class="n">worldPos</span> <span class="p">=</span> <span class="nf">mul</span><span class="p">(</span><span class="n">unity_ObjectToWorld</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">position</span><span class="p">);</span>
	<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">UnityObjectToWorldNormal</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
	<span class="n">i</span><span class="p">.</span><span class="n">tangent</span> <span class="p">=</span> <span class="nf">float4</span><span class="p">(</span><span class="nf">UnityObjectToWorldDir</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">),</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
	<span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="p">=</span> <span class="nf">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
	<span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span> <span class="p">=</span> <span class="nf">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_DetailTex</span><span class="p">);</span>
	<span class="nf">ComputeVertexLightColor</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å°†æ³•çº¿ä»åˆ‡çº¿ç©ºé—´è½¬æ¢ä¸ºä¸–ç•Œç©ºé—´ã€‚</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">binormal</span> <span class="p">=</span> <span class="nf">cross</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">)</span> <span class="p">*</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span>
	<span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span> <span class="p">+</span>
	<span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">y</span> <span class="p">*</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">+</span>
	<span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">z</span> <span class="p">*</span> <span class="n">binormal</span>
<span class="p">);</span>
</code></pre></div></div><p>å»æ‰æ˜¾å¼YZäº¤æ¢ï¼Œå°†å…¶ä¸ç©ºé—´è½¬æ¢ç»“åˆåœ¨ä¸€èµ·ã€‚</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//tangentSpaceNormal = tangentSpaceNormal.xzy;	</span>
<span class="n">float3</span> <span class="n">binormal</span> <span class="p">=</span> <span class="nf">cross</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">)</span> <span class="p">*</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span>
	<span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span> <span class="p">+</span>
	<span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">y</span> <span class="p">*</span> <span class="n">binormal</span> <span class="p">+</span>
	<span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">z</span> <span class="p">*</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span>
<span class="err">ï¼‰</span><span class="p">;</span>

</code></pre></div></div><p>åœ¨æ„é€ å‰¯æ³•çº¿æ—¶ï¼Œè¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„ç»†èŠ‚ã€‚å‡è®¾ä¸€ä¸ªå¯¹è±¡çš„scaleè®¾ç½®ä¸º(- 1,1,1)ï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯é•œåƒçš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»ç¿»è½¬å‰¯æ³•çº¿ï¼Œæ¥æ­£ç¡®åœ°é•œåƒåˆ‡çº¿ç©ºé—´ã€‚äº‹å®ä¸Šï¼Œå½“å¥‡æ•°ç»´æ•°ä¸ºè´Ÿæ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è¿™æ ·åšã€‚_UnityShaderVariables_é€šè¿‡å®šä¹‰float4 unity_WorldTransformParamså˜é‡æ¥å¸®åŠ©æˆ‘ä»¬å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚å½“éœ€è¦ç¿»è½¬å‰¯æ³•çº¿æ—¶ï¼Œå®ƒçš„ç¬¬å››ä¸ªåˆ†é‡ä¸º- 1ï¼Œå¦åˆ™ä¸º1ã€‚</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">binormal</span> <span class="p">=</span> <span class="nf">cross</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">)</span> <span class="p">*(</span><span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span> <span class="p">*</span> <span class="n">unity_WorldTransformParams</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
</code></pre></div></div><h2 id="è½¬æ¢ç©ºé—´">è½¬æ¢ç©ºé—´</h2><p>åœ¨ä¸–ç•Œç©ºé—´ä¸‹è®¡ç®—</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fixed4</span> <span class="nf">MyFrag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">v</span><span class="p">)</span> <span class="p">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
	<span class="c1">//...</span>
	<span class="n">float3</span> <span class="n">tangentSpaceNormal</span><span class="p">=</span> <span class="nf">UnpackScaleNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">),</span> <span class="n">_BumpScale</span><span class="p">);</span>
	<span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">BINORMAL_PER_FRAGMENT</span><span class="p">)</span>
	    <span class="n">float3</span> <span class="n">binormal</span> <span class="p">=</span> <span class="nf">cross</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">)</span> <span class="p">*</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
	<span class="err">#</span><span class="k">else</span>
	    <span class="n">float3</span> <span class="n">binormal</span> <span class="p">=</span> <span class="n">v</span><span class="p">.</span><span class="n">binormal</span><span class="p">;</span>
	<span class="err">#</span><span class="n">endif</span>
	<span class="c1">//æŠŠåˆ‡çº¿ç©ºé—´è½¬åˆ°ä¸–ç•Œç©ºé—´</span>
	<span class="c1">//tangentSpaceNormal * [v.tangent,binromal, v.normal]T</span>
	<span class="n">v</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span>
	    <span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span> <span class="p">+</span>
	    <span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">y</span> <span class="p">*</span> <span class="n">binormal</span> <span class="p">+</span>
	    <span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">z</span> <span class="p">*</span> <span class="n">v</span><span class="p">.</span><span class="n">normal</span>
	<span class="p">);</span>
	<span class="c1">//...</span>
<span class="p">}</span>
</code></pre></div></div><p>åœ¨åˆ‡çº¿ç©ºé—´è®¡ç®—</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//è®¡ç®—å‰¯åˆ‡çº¿</span>
<span class="n">float3</span> <span class="n">binormal</span> <span class="p">=</span> <span class="nf">cross</span><span class="p">(</span><span class="nf">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">),</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">))</span> <span class="p">*</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="c1">//åˆ‡çº¿ç©ºé—´çŸ©é˜µ//è¡Œä¼˜å…ˆçš„å¡«å……</span>
<span class="n">float3x3</span> <span class="n">t_matrix</span> <span class="p">=</span> <span class="nf">float3x3</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">binormal</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
<span class="c1">//æŠŠå„ç§ä¿¡æ¯è½¬åˆ°åˆ‡çº¿ç©ºé—´ä¸‹å‚ä¸è®¡ç®—</span>
</code></pre></div></div><h3 id="å‰¯åˆ‡çº¿åœ¨å“ªç®—åˆé€‚">å‰¯åˆ‡çº¿åœ¨å“ªç®—åˆé€‚</h3><p>åœ¨é¡¶ç‚¹è®¡ç®—ä¸å¿…è®¡ç®—å‰ä¹˜å‡½æ•°ï¼Œé€šè¿‡å®å®šä¹‰å¼€å¯ã€‚</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">Interpolators</span> <span class="p">{</span>
	<span class="n">float4</span> <span class="n">position</span> <span class="p">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
	<span class="n">float4</span> <span class="n">uv</span> <span class="p">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
	<span class="n">float3</span> <span class="n">normal</span> <span class="p">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span>

	<span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">BINORMAL_PER_FRAGMENT</span><span class="p">)</span>
		<span class="n">float4</span> <span class="n">tangent</span> <span class="p">:</span> <span class="n">TEXCOORD2</span><span class="p">;</span>
	<span class="err">#</span><span class="k">else</span>
		<span class="n">float3</span> <span class="n">tangent</span> <span class="p">:</span> <span class="n">TEXCOORD2</span><span class="p">;</span>
		<span class="n">float3</span> <span class="n">binormal</span> <span class="p">:</span> <span class="n">TEXCOORD3</span><span class="p">;</span>
	<span class="err">#</span><span class="n">endif</span>

	<span class="n">float3</span> <span class="n">worldPos</span> <span class="p">:</span> <span class="n">TEXCOORD4</span><span class="p">;</span>

	<span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">VERTEXLIGHT_ON</span><span class="p">)</span>
		<span class="n">float3</span> <span class="n">vertexLightColor</span> <span class="p">:</span> <span class="n">TEXCOORD5</span><span class="p">;</span>
	<span class="err">#</span><span class="n">endif</span>
<span class="p">};</span>
</code></pre></div></div><p>å¦‚æœä¸ç¡®å®šåœ¨å“ªé‡Œè®¡ç®—æ¯”è¾ƒå¥½ï¼Œå¯ä»¥åŒæ—¶æ”¯æŒè¿™ä¸¤ç§æ–¹æ³•ã€‚å‡è®¾å®šä¹‰äº†BINORMAL_PER_FRAGMENTï¼Œæˆ‘ä»¬é€åƒç´ è®¡ç®—æ¯ä¸ªç‰‡æ®µçš„å‰¯æ³•çº¿ã€‚å¦åˆ™ï¼Œé€é¡¶ç‚¹è®¡ç®—ã€‚åœ¨å‰ä¸€ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¿æŒæˆ‘ä»¬çš„float4 tangentå˜é‡ ã€‚åœ¨åè€…ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªfloat3å˜é‡ã€‚</p><div file="cg" class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="nf">CreateBinormal</span> <span class="p">(</span><span class="n">float3</span> <span class="n">normal</span><span class="p">,</span> <span class="n">float3</span> <span class="n">tangent</span><span class="p">,</span> <span class="kt">float</span> <span class="n">binormalSign</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nf">cross</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">)</span> <span class="p">*</span>
		<span class="p">(</span><span class="n">binormalSign</span> <span class="p">*</span> <span class="n">unity_WorldTransformParams</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">Interpolators</span> <span class="nf">MyVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">Interpolators</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">i</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="nf">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_MVP</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">position</span><span class="p">);</span>
	<span class="n">i</span><span class="p">.</span><span class="n">worldPos</span> <span class="p">=</span> <span class="nf">mul</span><span class="p">(</span><span class="n">unity_ObjectToWorld</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">position</span><span class="p">);</span>
	<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">UnityObjectToWorldNormal</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>

	<span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">BINORMAL_PER_FRAGMENT</span><span class="p">)</span>
		<span class="n">i</span><span class="p">.</span><span class="n">tangent</span> <span class="p">=</span> <span class="nf">float4</span><span class="p">(</span><span class="nf">UnityObjectToWorldDir</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">),</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
	<span class="err">#</span><span class="k">else</span>
		<span class="n">i</span><span class="p">.</span><span class="n">tangent</span> <span class="p">=</span> <span class="nf">UnityObjectToWorldDir</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
		<span class="n">i</span><span class="p">.</span><span class="n">binormal</span> <span class="p">=</span> <span class="nf">CreateBinormal</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
	<span class="err">#</span><span class="n">endif</span>

	<span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="p">=</span> <span class="nf">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
	<span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span> <span class="p">=</span> <span class="nf">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_DetailTex</span><span class="p">);</span>
	<span class="nf">ComputeVertexLightColor</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">void</span> <span class="nf">InitializeFragmentNormal</span><span class="p">(</span><span class="n">inout</span> <span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">float3</span> <span class="n">mainNormal</span> <span class="p">=</span>
		<span class="nf">UnpackScaleNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">),</span> <span class="n">_BumpScale</span><span class="p">);</span>
	<span class="n">float3</span> <span class="n">detailNormal</span> <span class="p">=</span>
		<span class="nf">UnpackScaleNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_DetailNormalMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span><span class="p">),</span> <span class="n">_DetailBumpScale</span><span class="p">);</span>
	<span class="n">float3</span> <span class="n">tangentSpaceNormal</span> <span class="p">=</span> <span class="nf">BlendNormals</span><span class="p">(</span><span class="n">mainNormal</span><span class="p">,</span> <span class="n">detailNormal</span><span class="p">);</span>

	<span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">BINORMAL_PER_FRAGMENT</span><span class="p">)</span>
		<span class="n">float3</span> <span class="n">binormal</span> <span class="p">=</span> <span class="nf">CreateBinormal</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
	<span class="err">#</span><span class="k">else</span>
		<span class="n">float3</span> <span class="n">binormal</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">binormal</span><span class="p">;</span>
	<span class="err">#</span><span class="n">endif</span>

	<span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span>
		<span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span> <span class="p">+</span>
		<span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">y</span> <span class="p">*</span> <span class="n">binormal</span> <span class="p">+</span>
		<span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">z</span> <span class="p">*</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span>
	<span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>è¦å¯¹æ‰€æœ‰Passå—ç”Ÿæ•ˆï¼Œéœ€è¦ä½¿ç”¨CGINCLUDE â€¦ ENDCGåŒ…å«</p></article><hr><div class='like-post'> <a style="color:rgb(112, 40, 85);" id="likeBtn" onclick="likePost(1);"> <i class="fa fa-thumbs-o-up fa-2x" aria-hidden="true"></i> </a> <span id="likeNum">0</span><div class="text-xs text-slate-500 mx-2">çœŸè¯šç‚¹èµï¼Œæ‰‹ç•™ä½™é¦™</div></div><h2 id="similar_posts">Similar Posts</h2><ul><li class="relatedPost"> <a href="/2018/01/25/Unity_Parallax_Normals_Heightmap/">è§†å·®å’Œæ³•çº¿ã€é«˜åº¦å›¾å›é¡¾(ç¿»è¯‘äºŒå) </a><li class="relatedPost"> <a href="/2018/01/24/Unity_GPU_Instance/">Unity GPU Instance(ç¿»è¯‘åä¹) </a><li class="relatedPost"> <a href="/2018/01/23/Unity_RealTime_GI_LOD/">Unity å®æ—¶ GI & LPPV & LOD(ç¿»è¯‘åå…«) </a><li class="relatedPost"> <a href="/2018/01/21/Unity_Mix_Lighting/">Unity æ··åˆå…‰ç…§(ç¿»è¯‘åä¸ƒ) </a><li class="relatedPost"> <a href="/2018/01/19/Unity_Static_Lightting/">Unity å…‰ç…§çƒ˜ç„™(ç¿»è¯‘åå…­) </a><li class="relatedPost"> <a href="/2018/01/17/Unity_Deferred_Lights/">Unity Deferred Lights-å»¶è¿Ÿå…‰ç…§(ç¿»è¯‘åäº”) </a></ul><div class="post-recent"><div class="pre"><p><strong>ä¸Šä¸€ç¯‡</strong> <a href="/2018/01/03/Unity_Multi_Light/">Unity åŸºç¡€å…‰ç…§å¤šå…‰æºé‡‡æ ·(ç¿»è¯‘äº”)</a></p></div><div class="nex"><p><strong>ä¸‹ä¸€ç¯‡</strong> <a href="/2018/01/05/Unity_Shadows/">Unity Shadow é˜´å½±(ç¿»è¯‘ä¸ƒ)</a></p></div></div><h2 id="comments">Comments</h2><div id="vcomments"></div><script type="text/javascript"> /*è¯„è®ºç›¸å…³*/ function delayLoadValine() { new Valine({ el: '#vcomments', verify: "true", notify: "false", app_id: "rbtCCmKrVdjghvJbkHOoyx9F-gzGzoHsz", app_key: "TnNTd821LZSYh3cREOLIm9cO", avatar: "monsterid", placeholder: "æ¬¢è¿è¯„è®ºï¼", pageSize: "10 || 10", master: "b5586e582cb181c6b0fc8b2ce828bd50", tagMeta: ["åšä¸»","å°ä¼™ä¼´","è®¿å®¢"], enableQQ: true, requiredFields: [], serverURLs: "", }); $(document).ready(function(){ fetch('https://v1.hitokoto.cn') .then(response => response.json()) .then(data => { document.getElementById("veditor").setAttribute( "placeholder", data.hitokoto+"â€”"+data.from ); setTimeout(() => { addPostVisitedTimes(); }, 1000); } ) .catch(console.error); }); } /*ç‚¹èµç›¸å…³*/ var curIpVisitRecord = null; var curPost = null; var curUrl = "https://www.damonc.top/2018/01/04/Unity_Advance_Texture/"; function getVisitorIpAndJudge() { $.getJSON('https://api.ipify.org?format=json', function(data){ saveOrUpdateIpRecord(data.ip) }); } function saveOrUpdateIpRecord(ip) { var Visitor = AV.Object.extend("visitors_record"); var post_url = curUrl; var query = new AV.Query(Visitor); query.equalTo("visitor_ip", ip); query.equalTo("post_url", post_url); query.find().then(function(results) { if (results.length > 0) { /* if(window.console){ console.log('è¯¥IPå·²è®¿é—®è¿‡è¯¥æ–‡ç« '); }*/ curIpVisitRecord = results[0]; updateIpRecord(); refreshLikeBtn(); } else { /*if(window.console){ console.log('è¯¥IPç¬¬ä¸€æ¬¡è®¿é—®è¯¥æ–‡ç« ï¼Œä¿å­˜æ–°çš„è®¿é—®è®°å½•ï¼Œå¹¶å¢åŠ è®¿é—®æ¬¡æ•°'); }*/ addNewIpRecord(ip, post_url); } }, function(error) { addPostVisitedTimes(); }); } function addPostVisitedTimes() { var AV_Posts = AV.Object.extend("Posts"); var url = curUrl; var title = "Unity çº¹ç†é«˜çº§ç”¨æ³•(ç¿»è¯‘å…­)"; var query = new AV.Query(AV_Posts); query.equalTo("post_url", url); query.find().then(function(results) { if (results.length > 0) { curPost = results[0]; curPost.increment("visited_times"); curPost.save(); loadLikeNums(); } else { curPost = new AV_Posts(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); curPost.setACL(acl); /* End Set ACL */ curPost.set("post_title", title); curPost.set("post_url", url); curPost.set("visited_times", 1); curPost.set('like_times', 0); curPost.save(); } getVisitorIpAndJudge(); }, function(error) { console.log('Error:' + error.code + " " + error.message); }); } function showPostVisitedTimes() { var AV_Posts = AV.Object.extend("Posts"); var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(AV_Posts); query.equalTo("post_url", url); query.find().then(function(results) { if (results.length > 0) { curPost = results[0]; loadLikeNums(); } else { /*if(window.console){ console.log('å¼‚å¸¸æƒ…å†µï¼Œä¸åº”è¯¥æ²¡è®°å½•çš„'); }*/ } }, function(error) { console.log('Error:' + error.code + " " + error.message); }); } function updateIpRecord(){ var lastTime = curIpVisitRecord.updatedAt; var curTime = new Date(); var timePassed = curTime.getTime() - lastTime.getTime(); if(timePassed > 300000) { /*if(window.console){ console.log('è·ç¦»è¯¥IPä¸Šä¸€æ¬¡è®¿é—®è¯¥æ–‡ç« å·²è¶…è¿‡äº†5åˆ†é’Ÿï¼Œæ›´æ–°è®¿é—®è®°å½•ï¼Œå¹¶å¢åŠ è®¿é—®æ¬¡æ•°'); }*/ addPostVisitedTimes(); curIpVisitRecord.save(); } else { /*console.log('è¿™æ˜¯è¯¥IP 1åˆ†é’Ÿå†…é‡å¤è®¿é—®è¯¥æ–‡ç« ï¼Œä¸æ›´æ–°è®¿é—®è®°å½•ï¼Œä¸å¢åŠ è®¿é—®æ¬¡æ•°');*/ } } function addNewIpRecord(ip, post_url){ var Visitor = AV.Object.extend("visitors_record"); curIpVisitRecord = new Visitor(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); curIpVisitRecord.setACL(acl); curIpVisitRecord.set("visitor_ip", ip); curIpVisitRecord.set("post_url", post_url); curIpVisitRecord.set("like_this_post", 0); curIpVisitRecord.save(); } function loadLikeNums() { var likeTimes = curPost.get('like_times'); $("#likeNum").text(likeTimes); } function refreshLikeBtn() { var likeState = curIpVisitRecord.get('like_this_post'); if(likeState == 1){ $("#likeBtn").css("color", "red"); $("#likeBtn").attr("onclick", "likePost(-1)"); } else { $("#likeBtn").css("color", "black"); $("#likeBtn").attr("onclick", "likePost(1)"); } loadLikeNums(); } function likePost(type) { if(curPost == null || curIpVisitRecord == null) { alert('å»¶è¿Ÿ10såæ‰èƒ½ç‚¹èµ, è¯·ç¨ç­‰...'); return } var newNum; var getlikeTime = curPost.get('like_times'); if(typeof getlikeTime == "undefined" || getlikeTime == null || getlikeTime == "") { newNum = parseInt(type); }else{ newNum = parseInt(type) + parseInt(getlikeTime); } curPost.set('like_times', newNum); curPost.save().then(function(curPost){ var likeThisPost = type == -1 ? 0 : 1; curIpVisitRecord.set("like_this_post", likeThisPost); curIpVisitRecord.save().then(function(){ refreshLikeBtn(); }); },function(error){ console.log('Failed to create visitor record, with error message: ' + error.message); }); } /*å¯åŠ¨æ‰§è¡Œ*/ setTimeout(() => { delayLoadValine(); }, 10000); </script></div></div><script> /** * target _blank */ (function() { var aTags = document.querySelectorAll('article a:not([id])'); for (var i = 0; i < aTags.length; i++) { aTags[i].setAttribute('target', '_blank'); } }()); </script> <script src="/js/pageContent.js " charset="utf-8"></script><footer class="site-footer"><div class="wrapper"><p class="description"> äº‘ä¸Šçš„æ—¥å­!</p><p class="contact"> <a href="https://github.com/bitfeng" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a> <a href="mailto:damonc@126.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></p><p> æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡ï¼Œæœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡ï¼Œæœ¬æ–‡æ€»é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡</p></div></footer><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="back-to-top"> <a href="#top" data-scroll> <i class="fa fa-arrow-up" aria-hidden="true"></i> </a></div><script src=" /js/main.js " charset="utf-8"></script> <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script> <script type="text/javascript"> smoothScroll.init({ speed: 500, easing: 'easeInOutCubic', offset: 20, }); function displayWindowSize() { var w = document.documentElement.clientWidth; var h = document.documentElement.clientHeight; var rightDiv = document.querySelector('.right'); var footer = document.querySelector('.site-footer'); if(!rightDiv || !footer){ return; } if(w <= 1700){ rightDiv.style.display='none'; footer.style.display='none'; }else{ rightDiv.style.display='block'; footer.style.display = "block"; } } window.addEventListener("resize", displayWindowSize); displayWindowSize(); </script>
