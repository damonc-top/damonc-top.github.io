<!DOCTYPE html><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="baidu-site-verification" content="code-BGVivWGmxV" /><title>Unity Deferred Lights-å»¶è¿Ÿå…‰ç…§(ç¿»è¯‘åäº”)</title><meta name="description" content="æœ¬ç¯‡æ‘˜è¦ï¼š è‡ªå®šä¹‰ç¯å…‰æ¸²æŸ“ è§£ç LDRé¢œè‰² å¢åŠ ç‹¬ç«‹Passæ¸²æŸ“å…‰ æ”¯æŒæ–¹å‘å…‰ã€ç‚¹å…‰æºã€èšå…‰ç¯ æ‰‹åŠ¨é‡‡æ ·é˜´å½±çº¹ç†"><link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon"><link rel="icon" href="/favicon.ico?" type="image/x-icon"><link rel="stylesheet" href="/css/main.css "><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href=" /css/font_8v3czwksspqlg14i.css "><link rel="canonical" href="https://www.damonc.top/2018/01/17/Unity_Deferred_Lights/"><link rel="alternate" type="application/rss+xml" title="çˆ±ç©¿æ‹–é‹" href="https://www.damonc.top/feed.xml "> <script src=" /js/Valine.min.js " charset="utf-8"></script> <script src=" /js/jquery_3_2_0.min.js " charset="utf-8"></script> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "//hm.baidu.com/hm.js?f7f1a5967e3927ea98597632f0a17ad9"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script async src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><body class="custom-background"><header id="top"><div class="wrapper"> <a href="/" class="brand">çˆ±ç©¿æ‹–é‹</a> <small>è‡ªç”±è‡ªåœ¨ğŸ©´</small> <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button><nav id="headerNav"><ul><li> <a href="/"> <i class="fa fa-home"></i>Home </a><li> <a href="/archive/"> <i class="fa fa-archive"></i>å½’æ¡£ </a><li> <a href="/category/"> <i class="fa fa-th-list"></i>åˆ†ç±» </a><li> <a href="/tag/"> <i class="fa fa-tags"></i>æ ‡ç­¾ </a><li> <a href="/collection/"> <i class="fa fa-bookmark"></i>æ”¶é›† </a><li> <a href="/demo/"> <i class="fa fa-play"></i>å·¥å…· </a><li> <a href="/about/"> <i class="fa fa-heart"></i>About </a></ul></nav></div></header><div class="home-right-bar"> <button class="anchor"><i class="fa fa-anchor"></i></button><div class="right"><div class="wrap"><div class="side content"><div> ç›®å½•</div><ul id="content-side" class="content-ul"><li><a href="#comments">Comments</a></ul></div></div></div></div><div class="page clearfix" post><div class="left"><h1>Unity Deferred Lights-å»¶è¿Ÿå…‰ç…§(ç¿»è¯‘åäº”)</h1><div class="label"><div class="label-card"> <i class="fa fa-calendar"></i>2018-01-17</div><div class="label-card"> <i class="fa fa-user"></i>catlikecoding</div><div class="label-card"></div><div class="label-card"> <span class="categories"> <i class="fa fa-th-list"></i> <a href="/category/#ç¿»è¯‘" title="Category: ç¿»è¯‘" rel="category">ç¿»è¯‘</a> </span></div><div class="label-card"> <span class="pageTag"> <i class="fa fa-tags"></i> <b href="/tag/#Shader" title="Tag: Shader" rel="tag">Shader</b>&nbsp; <b href="/tag/#Unity3d" title="Tag: Unity3d" rel="tag">Unity3d</b> </span></div></div><hr><article itemscope itemtype="http://schema.org/BlogPosting"><ul id="markdown-toc"><li><a href="#å…‰ç…§light-shader" id="markdown-toc-å…‰ç…§light-shader">å…‰ç…§Light Shader</a><ul><li><a href="#using-a-custom-shader" id="markdown-toc-using-a-custom-shader">Using a Custom Shader</a><li><a href="#ç¬¬äºŒä¸ªpassa-second-pass" id="markdown-toc-ç¬¬äºŒä¸ªpassa-second-pass">ç¬¬äºŒä¸ªPassA Second Pass</a><li><a href="#avoiding-the-sky" id="markdown-toc-avoiding-the-sky">Avoiding the Sky</a><li><a href="#é¢œè‰²è½¬æ¢converting-colors" id="markdown-toc-é¢œè‰²è½¬æ¢converting-colors">é¢œè‰²è½¬æ¢Converting Colors</a></ul><li><a href="#directional-lights" id="markdown-toc-directional-lights">Directional Lights</a><ul><li><a href="#g-buffer-uv-coordinates" id="markdown-toc-g-buffer-uv-coordinates">G-Buffer UV Coordinates</a><li><a href="#åæ ‡è½¬æ¢world-position" id="markdown-toc-åæ ‡è½¬æ¢world-position">åæ ‡è½¬æ¢World Position</a><li><a href="#è¯»å–g-buff-reading-g-buffer-data" id="markdown-toc-è¯»å–g-buff-reading-g-buffer-data">è¯»å–G-Buff Reading G-Buffer Data</a><li><a href="#è®¡ç®—brd-computing-brdf" id="markdown-toc-è®¡ç®—brd-computing-brdf">è®¡ç®—BRD Computing BRDF</a><li><a href="#å…‰æºé…ç½®-configuring-the-light" id="markdown-toc-å…‰æºé…ç½®-configuring-the-light">å…‰æºé…ç½® Configuring the Light</a><li><a href="#é˜´å½±-shadows" id="markdown-toc-é˜´å½±-shadows">é˜´å½± Shadows</a><li><a href="#fading-shadows" id="markdown-toc-fading-shadows">Fading Shadows</a><li><a href="#light-cookies" id="markdown-toc-light-cookies">Light Cookies</a><li><a href="#æ”¯æŒldr-supporting-ldr" id="markdown-toc-æ”¯æŒldr-supporting-ldr">æ”¯æŒLDR Supporting LDR</a></ul><li><a href="#èšå…‰æº-spotlights" id="markdown-toc-èšå…‰æº-spotlights">èšå…‰æº Spotlights</a><ul><li><a href="#drawing-a-pyramid" id="markdown-toc-drawing-a-pyramid">Drawing a Pyramid</a><li><a href="#æ”¯æŒå¤šå…‰æº-supporting-multiple-light-types" id="markdown-toc-æ”¯æŒå¤šå…‰æº-supporting-multiple-light-types">æ”¯æŒå¤šå…‰æº Supporting Multiple Light Types</a><li><a href="#world-position-agin" id="markdown-toc-world-position-agin">World Position Agin</a><li><a href="#é”¥å½¢è¡°å‡-cookie-attenuation" id="markdown-toc-é”¥å½¢è¡°å‡-cookie-attenuation">é”¥å½¢è¡°å‡ Cookie Attenuation</a><li><a href="#è·ç¦»è¡°å‡-distance-attenuation" id="markdown-toc-è·ç¦»è¡°å‡-distance-attenuation">è·ç¦»è¡°å‡ Distance Attenuation</a><li><a href="#shadows" id="markdown-toc-shadows">Shadows</a><li><a href="#ç‚¹å…‰æº-point-lights" id="markdown-toc-ç‚¹å…‰æº-point-lights">ç‚¹å…‰æº Point Lights</a><li><a href="#shadows-1" id="markdown-toc-shadows-1">Shadows</a><li><a href="#cookies" id="markdown-toc-cookies">Cookies</a><li><a href="#skipping-shadows" id="markdown-toc-skipping-shadows">Skipping Shadows</a></ul></ul><p>æœ¬ç¯‡æ‘˜è¦ï¼š</p><ul><li>è‡ªå®šä¹‰ç¯å…‰æ¸²æŸ“<li>è§£ç LDRé¢œè‰²<li>å¢åŠ ç‹¬ç«‹Passæ¸²æŸ“å…‰<li>æ”¯æŒæ–¹å‘å…‰ã€ç‚¹å…‰æºã€èšå…‰ç¯<li>æ‰‹åŠ¨é‡‡æ ·é˜´å½±çº¹ç†</ul><h2 id="å…‰ç…§light-shader">å…‰ç…§Light Shader</h2><p>åœ¨G-Bufferså¡«å……å®Œæ¯•åï¼Œç„¶åæ¸²æŸ“å…‰ã€‚æœ¬ç¯‡å…ˆä»‹ç»Unityæ˜¯å¦‚ä½•æ¸²æŸ“å…‰ï¼Œä»¥åŠå®ç°è‡ªå·±çš„æ¸²æŸ“å…‰çš„Shaderã€‚åœ¨Edit / Project Settings / Graphics å»æ‰é»˜è®¤çš„Shaderã€‚</p><h3 id="using-a-custom-shader">Using a Custom Shader</h3><p>æ¯ä¸ªdeferredå…‰éƒ½æ˜¯åœ¨ä¸€ä¸ªç‹¬ç«‹çš„Passä¿®æ”¹å±å¹•å›¾åƒ(åå¤„ç†Image)å®Œæˆæ¸²æŸ“ã€‚åˆ›å»ºä¸€ä¸ªShaderç„¶åæŒ‡å®šåˆ°Built-In shader settings</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200519084812390-1178609122.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>ä¿®æ”¹å†…ç½®çš„Shader.</a></i></center> </font><h3 id="ç¬¬äºŒä¸ªpassa-second-pass">ç¬¬äºŒä¸ªPassA Second Pass</h3><p>ä¿®æ”¹ä¹‹åï¼Œç¼–è¾‘å™¨å¤§é‡æŠ¥é”™.</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200519084812964-728132925.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>least 2 passes.</a></i></center> </font><p>å…ˆç®€å•å¤åˆ¶ç¬¬ä¸€ä¸ªPassè§£å†³é”™è¯¯ï¼Œç»“æœæ˜¯å±å¹•å†…é™¤äº†å¤©ç©ºç›’å¤–æ‰€æœ‰ç‰©ä½“è¢«æ¸²æŸ“æˆé»‘è‰²äº†ã€‚è¿™æ˜¯å› ä¸ºä½¿ç”¨äº†stencil-bufferã€‚</p><p><strong>æŠ¥é”™çš„åŸå› </strong>ï¼šä¸ºä»€ä¹ˆéœ€è¦ç¬¬äºŒä¸ªPassï¼Ÿ</p><ul><li>å½“HDRç¦ç”¨æ—¶ï¼Œå…‰ç…§æ•°æ®ä¼šè¢«ä½¿ç”¨å¯¹æ•°ç¼–ç è®¡ç®—ï¼Œç„¶ååœ¨(ç¬¬äºŒä¸ª)æœ€ç»ˆçš„passè§£ç è¯¥æ•°æ®ã€‚æ‰€ä»¥å¿…é¡»è¦å¢åŠ Passã€‚<em>å½“ç¦ç”¨HDRæ—¶å°±èƒ½è°ƒç”¨ç¬¬äºŒä¸ªPassï¼Œä½†æ­¤æ—¶å¤©ç©ºä¹Ÿå˜é»‘äº†ã€‚</em></ul><h3 id="avoiding-the-sky">Avoiding the Sky</h3><p>å½“åœ¨LDRï¼ˆHDRç¦ç”¨ï¼‰æ¨¡å¼ï¼Œå¤©ç©ºå˜é»‘äº†ã€‚è¿™æ˜¯å› ä¸ºè½¬æ¢è¿‡ç¨‹ä¸­æ²¡æœ‰æ­£ç¡®ä½¿ç”¨stencil-bufferæ¨¡æ¿æ©ç ã€‚åœ¨<strong>ç¬¬äºŒä¸ªPassä¸­é…ç½®</strong>ï¼šåº”è¯¥åªæ¸²æŸ“ä¸å±äºèƒŒæ™¯çš„ç‰‡æ®µï¼Œå¯é€šè¿‡_StencilNonBackgroundæä¾›é€‚å½“çš„æ¨¡æ¿å€¼ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Pass</span>
<span class="p">{</span>
    <span class="n">Stencil</span>
    <span class="p">{</span>
        <span class="n">Ref</span><span class="p">[</span><span class="n">_StencilNonBackground</span><span class="p">]</span>
        <span class="n">ReadMask</span><span class="p">[</span><span class="n">_StencilNonBackground</span><span class="p">]</span>
        <span class="n">CompBack</span> <span class="n">Equal</span>
        <span class="n">CompFront</span> <span class="n">Equal</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="é¢œè‰²è½¬æ¢converting-colors">é¢œè‰²è½¬æ¢Converting Colors</h3><p>åœ¨ç¬¬äºŒä¸ªPassçš„light-bufferè½¬æ¢å…‰ç…§æ•°æ®ï¼Œæ–¹æ³•å°±ä¼¼Fog shaderï¼šç”¨è¾“å…¥æºçš„Image UVåæ ‡é‡‡æ ·bufferæ¥ç»˜åˆ¶ä¸€ä¸ªè¦†ç›–å…¨å±çš„quad</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">VertexData</span> <span class="p">{</span>
    <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
    <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">Interpolators</span> <span class="p">{</span>
    <span class="n">float4</span> <span class="n">pos</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
    <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">Interpolators</span> <span class="nf">VertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Interpolators</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">i</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>è¯¥light bufferé€šè¿‡åä¸º_LightBufferå˜é‡æä¾›ç»™Shader</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sampler2D</span> <span class="n">_LightBuffer</span><span class="p">;</span>
<span class="c1">//...</span>
<span class="n">float4</span> <span class="nf">FragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_LightBuffer</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div></div><p>LDRé¢œè‰²ä½¿ç”¨æŒ‡æ•°ç¼–ç :$2^{-C}$ï¼Œä½¿ç”¨å¯¹æ•°è§£ç $-log2^C$</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="o">-</span><span class="n">log2</span><span class="p">(</span><span class="n">tex2D</span><span class="p">(</span><span class="n">_LightBuffer</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">));</span>
</code></pre></div></div><h2 id="directional-lights">Directional Lights</h2><p>æ–°å¢ä¸€ä¸ªcgincæ–‡ä»¶ï¼Œå¼•å…¥ç¬¬ä¸€ä¸ªpassã€‚è¦æŠŠæ¸²æŸ“çš„å…‰ç…§å¢åŠ åˆ°å›¾åƒä¸Šï¼Œå¿…é¡»ç¡®ä¿ä¸èƒ½æ“¦é™¤å·²æ¸²æŸ“çš„å›¾åƒï¼Œå› æ­¤æ”¹å˜æ··åˆæ¨¡å¼è¦å®Œå…¨åˆå¹¶æºé¢œè‰²å’Œç›®æ ‡é¢œè‰²ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Blend</span> <span class="n">One</span> <span class="n">One</span>
</code></pre></div></div><p>ä¹Ÿéœ€è¦æ‰€æœ‰å¯èƒ½çš„å…‰ç…§é…ç½®shader variantså˜ä½“ï¼Œè¯¥ç¼–è¯‘æŒ‡ä»¤ï¼šmulti_compile_lightpassä¼šåˆ›å»ºæ‰€æœ‰åŒ…å«çš„å˜ä½“ã€‚ç„¶åå†å¢åŠ ä¸€ä¸ªHDR_ONçš„æŒ‡ä»¤ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma multi_compile_lightpass
#pragma multi_compile _ UNITY_HDR_ON
</span></code></pre></div></div><h3 id="g-buffer-uv-coordinates">G-Buffer UV Coordinates</h3><p>éœ€è¦ç”¨UVåæ ‡ä»G-buffersé‡‡æ ·ï¼Œä¸å¹¸çš„æ˜¯ï¼Œè¯¥light passé€šé“unityä¸æ”¯æŒæä¾›è¯¥åæ ‡ã€‚è§£å†³åŠæ³•ï¼šä»clip-spaceä¼ é€’è¿‡æ¥ï¼Œä½¿ç”¨ComputeScreenPoså‡½æ•°è®¡ç®—ï¼Œè¿”å›ä¸€ä¸ªfloat4çš„é½æ¬¡åæ ‡ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v2f</span> <span class="nf">VertexProgram</span><span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">)</span>  
<span class="p">{</span>  
     <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>  
     <span class="n">o</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>  
     <span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">ComputeScreenPos</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">pos</span><span class="p">);</span>  
     <span class="k">return</span> <span class="n">o</span><span class="p">;</span>  
<span class="p">}</span>
</code></pre></div></div><p>ç„¶ååœ¨fragmentå°±èƒ½è®¡ç®—æœ€ç»ˆçš„2Dåæ ‡ã€‚å¿…é¡»åœ¨fragmentè®¡ç®—ã€‚è§ç¿»è¯‘7</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fixed4</span> <span class="n">FragmentProgram</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
<span class="p">{</span>
    <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="o">/</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="åæ ‡è½¬æ¢world-position">åæ ‡è½¬æ¢World Position</h3><p>ä¸ä¸Šç¯‡deferred fogä¸­ç›¸ä¼¼ï¼Œéœ€è¦è®¡ç®—ä»ç›¸æœºåˆ°ç‰‡å…ƒçš„è·ç¦»ï¼šä»ç›¸æœºåŸç‚¹å‘å°„å°„çº¿é€šè¿‡ç‰‡å…ƒ(ç»™å®šæ–¹å‘)åˆ°è¾¾far-planeï¼Œç„¶åå†ç”¨fragmentæ·±åº¦ç¼©æ”¾å°„çº¿ã€‚ç”¨è¯¥æ–¹æ³•<strong>é‡å»ºç‰‡å…ƒçš„ä¸–ç•Œåæ ‡</strong>ã€‚</p><ol><li>é¦–å…ˆã€‚å¯¹äºæ–¹å‘å…‰ï¼Œä»quadçš„å››é¡¶ç‚¹å‘å‡ºçš„å°„çº¿ä½œä¸ºæ³•å‘é‡æä¾›ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡é¡¶ç‚¹ç¨‹åºå¯¹å°„çº¿è¿›è¡Œæ’å€¼ã€‚</ol><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">VertexData</span> <span class="p">{</span>
    <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
    <span class="n">float3</span> <span class="n">normal</span> <span class="o">:</span> <span class="n">NORMAL</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">Interpolators</span> <span class="p">{</span>
    <span class="n">float4</span> <span class="n">pos</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
    <span class="n">float4</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
    <span class="n">float3</span> <span class="n">ray</span> <span class="o">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">Interpolators</span> <span class="nf">VertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Interpolators</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">i</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">ComputeScreenPos</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">pos</span><span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">ray</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><ol><li>å…¶æ¬¡ã€‚åœ¨fragmentå‡½æ•°é€šè¿‡é‡‡æ ·_CameraDepthTextureçº¹ç†å’Œçº¿æ€§åŒ–è®¡ç®—å¯ä»¥å¾—åˆ°depthå€¼ï¼Œç±»ä¼¼äºdeferred fogè®¡ç®—</ol><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Unityæä¾›çš„å£°æ˜å‡½æ•°ï¼Œç­‰äº sampler2D _CameraDepthTexture; å®šä¹‰åœ¨UnityCG</span>
<span class="n">UNITY_DECLARE_DEPTH_TEXTURE</span><span class="p">(</span><span class="n">_CameraDepthTexture</span><span class="p">);</span>

<span class="n">float4</span> <span class="n">FragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span> <span class="p">{</span>
    <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="o">/</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">SAMPLE_DEPTH_TEXTURE</span><span class="p">(</span><span class="n">_CameraDepthTexture</span><span class="p">,</span> <span class="n">uv</span><span class="p">);</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">Linear01Depth</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><ol><li>ç„¶åã€‚ä¸deferred fogæœ€å¤§çš„ä¸åŒï¼šfog shaderéœ€è¦å°„çº¿åˆ°è¾¾far planeï¼›è€Œæœ¬shaderçš„å°„çº¿åªèƒ½åˆ°è¾¾near planeã€‚æ‰€ä»¥å¿…é¡»è¦ç¼©æ”¾å°„çº¿ä»¥ä¾¿å®ƒèƒ½è¾¾åˆ°far-planeï¼šç¼©æ”¾å°„çº¿ä½¿Zåæ ‡å˜ä¸º1ï¼Œå¹¶ä¸è¿œå¹³é¢è·ç¦»ç›¸ä¹˜ã€‚</ol><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">depth</span> <span class="o">=</span> <span class="n">Linear01Depth</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
<span class="n">float3</span> <span class="n">rayToFarPlane</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">ray</span> <span class="o">*</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span> <span class="o">/</span> <span class="n">i</span><span class="p">.</span><span class="n">ray</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
</code></pre></div></div><ol><li>å†æ¥ç€ã€‚æŒ‰æ·±åº¦å€¼ç¼©æ”¾å°„çº¿ä¸€æ¬¡å¾—åˆ°ä¸€ä¸ªåæ ‡ã€‚è¯¥å°„çº¿è¢«å®šä¹‰åœ¨è§†å›¾ç©ºé—´ï¼Œå®ƒæ˜¯cameraçš„æœ¬åœ°ç©ºé—´ã€‚å› æ­¤ï¼Œå°„çº¿ä¹Ÿä»¥ç‰‡æ®µåœ¨è§†å›¾ç©ºé—´ä¸­çš„åæ ‡ç»“æŸã€‚</ol><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">rayToFarPlane</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">ray</span> <span class="o">*</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span> <span class="o">/</span> <span class="n">i</span><span class="p">.</span><span class="n">ray</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">viewPos</span> <span class="o">=</span> <span class="n">rayToFarPlane</span> <span class="o">*</span> <span class="n">depth</span><span class="p">;</span>
</code></pre></div></div><ol><li>æœ€åã€‚å†ä½¿ç”¨unity_CameraToWorldå†…ç½®çŸ©é˜µä»viewè§†å›¾ç©ºé—´è½¬æ¢åˆ°worldä¸–ç•Œåæ ‡ï¼Œè¯¥çŸ©é˜µå®šä¹‰åœ¨ShaderVariables.cginc</ol><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">viewPos</span> <span class="o">=</span> <span class="n">rayToFarPlane</span> <span class="o">*</span> <span class="n">depth</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">worldPos</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_CameraToWorld</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">viewPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
</code></pre></div></div><h3 id="è¯»å–g-buff-reading-g-buffer-data">è¯»å–G-Buff Reading G-Buffer Data</h3><p>è·å–World Posåã€‚é€šè¿‡è®¿é—®G-bufferæ£€ç´¢propertiesï¼Œè¯¥bufferå¯ä»å†…ç½®çš„_CamearGBufferTextureå˜é‡è·å–</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sampler2D</span> <span class="n">_CameraGBufferTexture0</span><span class="p">;</span>
<span class="n">sampler2D</span> <span class="n">_CameraGBufferTexture1</span><span class="p">;</span>
<span class="n">sampler2D</span> <span class="n">_CameraGBufferTexture2</span><span class="p">;</span>
</code></pre></div></div><p>åœ¨ä¸Šä¸€ç¯‡Defferred Shadingä¸­ä¹Ÿæ‰‹åŠ¨è®¡ç®—è¿‡G-buffer,è¿™æ¬¡ç›´æ¥è¯»å–_CameraGBufferTextureç°æˆçš„albedoã€specularã€smoothnessã€normal</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">worldPos</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_CameraToWorld</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">viewPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">albedo</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_CameraGBufferTexture0</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">specularTint</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_CameraGBufferTexture1</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span><span class="c1">//åˆå¹¶</span>
<span class="n">float3</span> <span class="n">smoothness</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_CameraGBufferTexture1</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">a</span><span class="p">;</span><span class="c1">//åˆå¹¶</span>
<span class="n">float3</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_CameraGBufferTexture2</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">rgb</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div><h3 id="è®¡ç®—brd-computing-brdf">è®¡ç®—BRD Computing BRDF</h3><p>å¼•å…¥BRDFå‡½æ•°ï¼Œå®šä¹‰åœ¨UnityPBSLighting.cgincä¸­</p><p>é¦–å…ˆè®¡ç®—è§†é‡æ–¹å‘</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">worldPos</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_CameraToWorld</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">viewPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">viewDir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">_WorldSpaceCameraPos</span> <span class="o">-</span> <span class="n">worldPos</span><span class="p">);</span>
</code></pre></div></div><p>å…¶æ¬¡æ˜¯è¡¨é¢åå°„ï¼Œè¿™å¯ä»specularé¢œè‰²è·å–ï¼Œä½¿ç”¨SpecularStrengthå‡½æ•°æå–ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//...</span>
<span class="kt">float</span> <span class="n">oneMinusReflectivity</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">SpecularStrength</span><span class="p">(</span><span class="n">specularTint</span><span class="p">);</span>
</code></pre></div></div><p>ç„¶åä¼ é€’å…‰ç…§æ•°æ®ï¼Œåˆå§‹åŒ–ç›´æ¥å…‰å’Œé—´æ¥å…‰</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">oneMinusReflectivity</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">SpecularStrength</span><span class="p">(</span><span class="n">specularTint</span><span class="p">);</span>
<span class="c1">//...</span>
<span class="n">UnityLight</span> <span class="n">light</span><span class="p">;</span>
<span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">UnityIndirect</span> <span class="n">indirectLight</span><span class="p">;</span>
<span class="n">indirectLight</span><span class="p">.</span><span class="n">diffuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div></div><p>æœ€åè®¡ç®—æœ€ç»ˆçš„é¢œè‰²</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">UNITY_BRDF_PBS</span>
<span class="p">(</span>
    <span class="n">albedo</span><span class="p">,</span> <span class="n">specularTint</span><span class="p">,</span> <span class="n">oneMinusReflectivity</span><span class="p">,</span> <span class="n">smoothness</span><span class="p">,</span>
    <span class="n">normal</span><span class="p">,</span> <span class="n">viewDir</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">indirectLight</span>
<span class="p">);</span>
<span class="k">return</span> <span class="n">color</span><span class="p">;</span>
</code></pre></div></div><h3 id="å…‰æºé…ç½®-configuring-the-light">å…‰æºé…ç½® Configuring the Light</h3><p>å› ä¸ºé—´æ¥å…‰å‘ˆç°çš„æ˜¯é»‘è‰²çš„ï¼Œåœ¨è¿™é‡Œä¸é€‚ç”¨ã€‚ä½†æ˜¯ç›´æ¥å…‰å¿…é¡»è¢«é…ç½®æˆä¸å½“å‰æ¸²æŸ“çš„å…‰ç›¸åŒ¹é…ã€‚å¯¹äºæ–¹å‘å…‰ï¼Œéœ€è¦å®ƒçš„é¢œè‰²å’Œæ–¹å‘ã€‚è¿™ä¸¤ä¸ªå˜é‡å¯ä»¥é€šè¿‡_LightColorå’Œ_LightDirå˜é‡è·å¾—ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float4</span> <span class="n">_LightColor</span><span class="p">,</span> <span class="n">_LightDir</span><span class="p">;</span>

<span class="n">UnityLight</span> <span class="nf">CreateLight</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">UnityLight</span> <span class="n">light</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">_LightDir</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">light</span><span class="p">;</span>
<span class="p">}</span>

    <span class="n">UnityLight</span> <span class="n">light</span> <span class="o">=</span> <span class="n">CreateLight</span><span class="p">();</span>
<span class="c1">//    light.color = 0;</span>
<span class="c1">//    light.dir = 0;</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527011132912-1838344751.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>å…‰ç…§æ–¹å‘é”™è¯¯.</a></i></center> </font><p>è®¡ç®—å¾—åˆ°æœ€ç»ˆçš„å…‰ç…§ï¼Œä½†å…‰çš„æ–¹å‘é”™è¯¯äº†ã€‚åŸå› ï¼š_LightDiræ˜¯å…‰åˆ°è¡¨é¢çš„æ–¹å‘ã€‚åœ¨CreateLightè®¡ç®—ä¸­éœ€è¦è¡¨é¢åˆ°å…‰çš„æ–¹å‘</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">_LightDir</span><span class="p">;</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527011133845-1557873589.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æ­£ç¡®ï¼Œæ²¡æœ‰é˜´å½±.</a></i></center> </font><h3 id="é˜´å½±-shadows">é˜´å½± Shadows</h3><p>åœ¨è‡ªå·±çš„cgincæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¾é AutoLightä¸­çš„å®æ¥ç¡®å®šç”±é˜´å½±å¼•èµ·çš„å…‰è¡°å‡ã€‚ ä¸å¹¸çš„æ˜¯ï¼Œè¯¥æ–‡ä»¶åœ¨ç¼–å†™æ—¶å¹¶æ²¡æœ‰è€ƒè™‘åˆ°å»¶è¿Ÿçš„å…‰çº¿ã€‚ ç°åœ¨å°†è‡ªå·±è¿›è¡Œé˜´å½±é‡‡æ ·ï¼Œå¯é€šè¿‡_ShadowMapTextureå˜é‡è®¿é—®é˜´å½±è´´å›¾ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sampler2D</span> <span class="n">_ShadowMapTexture</span><span class="p">;</span>
</code></pre></div></div><p>ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸èƒ½éšæ„å£°æ˜æ­¤å˜é‡ã€‚ å®ƒå·²ç»åœ¨UnityShadowLibraryä¸­ä¸ºç‚¹å’Œèšå…‰ç¯é˜´å½±å®šä¹‰äº†å®ƒã€‚ å› æ­¤ï¼Œæˆ‘ä»¬ä¸åº”è¯¥è‡ªå·±å®šä¹‰å®ƒï¼Œé™¤éä½¿ç”¨æ–¹å‘å…‰é˜´å½±ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if defined (SHADOWS_SCREEN)
</span>    <span class="n">sampler2D</span> <span class="n">_ShadowMapTexture</span><span class="p">;</span>
<span class="cp">#endif
</span></code></pre></div></div><p>è¦åº”ç”¨æ–¹å‘å…‰é˜´å½±ï¼Œéœ€è¦é‡‡æ ·é˜´å½±çº¹ç†å¹¶ä½¿ç”¨å®ƒæ¥å‡å¼±å…‰è‰²å³å¯ã€‚ åœ¨CreateLightä¸­è®¡ç®—å°±éœ€è¦æŠŠUVåæ ‡å‚æ•°ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UnityLight</span> <span class="nf">CreateLight</span> <span class="p">(</span><span class="n">float2</span> <span class="n">uv</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UnityLight</span> <span class="n">light</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">_LightDir</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_ShadowMapTexture</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">shadowAttenuation</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">light</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">UnityLight</span> <span class="n">light</span> <span class="o">=</span> <span class="n">CreateLight</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527011134639-175464244.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æœ‰é˜´å½±çš„æ–¹å‘å…‰.</a></i></center> </font><p>å½“ç„¶ï¼Œè¿™ä»…åœ¨å®šå‘å…‰å¯ç”¨äº†é˜´å½±æ—¶æ‰æœ‰æ•ˆã€‚ å¦‚æœä¸æ˜¯ï¼Œåˆ™é˜´å½±è¡°å‡å§‹ç»ˆä¸º1ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#if defined(SHADOWS_SCREEN)
</span>    <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_ShadowMapTexture</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
<span class="cp">#endif
</span><span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">shadowAttenuation</span><span class="p">;</span>
</code></pre></div></div><h3 id="fading-shadows">Fading Shadows</h3><p>é˜´å½±è´´å›¾åº”è¯¥æ˜¯æœ‰é™çš„ï¼Œå®ƒè¦†ç›–çš„é¢ç§¯è¶Šå¤§ï¼Œé˜´å½±çš„åˆ†è¾¨ç‡è¶Šä½ã€‚ Unityæä¾›äº†ç»˜åˆ¶é˜´å½±çš„æœ€å¤§è·ç¦»ï¼Œæ­¤è·ç¦»å¯ä»¥é€šè¿‡_Edit / Project Settings / Quality_è¿›è¡Œè°ƒæ•´ã€‚</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527011135350-727795272.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>é˜´å½±è·ç¦»é…ç½®.</a></i></center> </font><p>å½“é˜´å½±å‡ ä¹å¿«è¾¾åˆ°äº†è¯¥é™å®šè·ç¦»å°±ä¼šæ·¡å‡ºï¼ŒUnityå†…ç½®çš„shaderæ˜¯è¿™æ ·è®¾å®šå¹¶è®¡ç®—ã€‚ç”±äºæˆ‘å°†æ‰‹åŠ¨é‡‡æ ·è¯¥é˜´å½±çº¹ç†ï¼Œå½“åˆ°è¾¾çº¹ç†çš„è¾¹ç¼˜æ—¶é˜´å½±ä¼šè¢«æˆªå–ï¼Œç»“æœæ˜¯é˜´å½±è™½ç„¶æ¶ˆå¤±äº†ï¼Œä½†æœ‰è¢«æ€¥å‰§åˆ‡å‰²çš„ç”Ÿç¡¬ç”»é¢ã€‚</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527011136133-1319763420.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>é•¿ã€çŸ­è·ç¦»é˜´å½±å¯¹æ¯”.</a></i></center> </font><p>è¦æ¸éšé˜´å½±ï¼Œ<strong>é¦–å…ˆ</strong>è¦çŸ¥é“çš„æ˜¯é˜´å½±å®Œå…¨æ¶ˆå¤±çš„è·ç¦»ã€‚è¯¥è·ç¦»åˆä¾èµ–äºé˜´å½±æŠ•å°„æ–¹å‘ã€‚åœ¨Stable Fitæ¨¡å¼ä¸‹ï¼Œä»¥mapçš„ä¸­å¿ƒç‚¹å‘ˆçƒé¢å½¢å¼€å§‹æ¸éšæ¶ˆå¤±é˜´å½±ï¼›åœ¨Close Fitæ¨¡å¼å®ƒæ˜¯ä¾èµ–äºè§†é‡æ·±åº¦ã€‚</p><p>UnityComputeShadowFadeDistanceå‡½æ•°èƒ½è®¡ç®—å‡ºæ­£ç¡®è·ç¦»ï¼Œå®ƒéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼šworld pos å’Œ view depthï¼›<strong>ç„¶å</strong>è¿”å›è·ç¦»Aã€‚ æ³¨æ„ï¼šè¯¥è·ç¦»Aæ˜¯ä»é˜´å½±çº¹ç†çš„ä¸­å¿ƒç‚¹ä½ç½®æˆ–è€…æœªæ›´æ”¹çš„è§†é‡æ·±åº¦å¼€å§‹è®¡ç®—çš„ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UnityLight</span> <span class="nf">CreateLight</span> <span class="p">(</span><span class="n">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="n">float3</span> <span class="n">worldPos</span><span class="p">,</span> <span class="kt">float</span> <span class="n">viewZ</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UnityLight</span> <span class="n">light</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">_LightDir</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="cp">#if defined(SHADOWS_SCREEN)
</span>        <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_ShadowMapTexture</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">shadowFadeDistance</span> <span class="o">=</span> <span class="n">UnityComputeShadowFadeDistance</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="n">viewZ</span><span class="p">);</span>
    <span class="cp">#endif
</span>    <span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">shadowAttenuation</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">light</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>é˜´å½±åº”è¯¥æ˜¯å¿«è¦æ¥è¿‘æ¸éšè·ç¦»æ—¶å¼€å§‹æ¶ˆå¤±ï¼Œä¸€æ—¦åˆ°è¾¾å°±å®Œå…¨æ¶ˆå¤±ã€‚UnityComputeShadowFadeå‡½æ•°è®¡ç®—åˆé€‚çš„æ¶ˆå¤±å› å­ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">shadowFadeDistance</span> <span class="o">=</span> <span class="n">UnityComputeShadowFadeDistance</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="n">viewZ</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">shadowFade</span> <span class="o">=</span> <span class="n">UnityComputeShadowFade</span><span class="p">(</span><span class="n">shadowFadeDistance</span><span class="p">);</span>
</code></pre></div></div><p><em>UnityComputeShadowFade</em> å®šä¹‰åœ¨UnityShadowLibrary.cgincï¼Œè§ä¸‹ï¼š</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="nf">UnityComputeShadowFadeDistance</span> <span class="p">(</span><span class="n">float3</span> <span class="n">wpos</span><span class="p">,</span> <span class="kt">float</span> <span class="n">z</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float</span> <span class="n">sphereDist</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">wpos</span><span class="p">,</span> <span class="n">unity_ShadowFadeCenterAndType</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">lerp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">sphereDist</span><span class="p">,</span> <span class="n">unity_ShadowFadeCenterAndType</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">half</span> <span class="nf">UnityComputeShadowFade</span><span class="p">(</span><span class="kt">float</span> <span class="n">fadeDist</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">saturate</span><span class="p">(</span><span class="n">fadeDist</span> <span class="o">*</span> <span class="n">_LightShadowData</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">_LightShadowData</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>é˜´å½±æ¸éšå€¼èŒƒå›´æ˜¯[0, 1]ï¼Œè¯¥å€¼å†³å®šäº†é˜´å½±è¦æ¶ˆå¤±å¤šå°‘ã€‚å®é™…çš„æ¶ˆå¤±å€¼å¯ä»¥åŠ åˆ°é˜´å½±è¡°å‡ä¹‹ä¸Šå¹¶é™å®šåœ¨[0, 1]ä¹‹å†…</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">shadowFade</span> <span class="o">=</span> <span class="n">UnityComputeShadowFade</span><span class="p">(</span><span class="n">shadowFadeDistance</span><span class="p">);</span>
<span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">shadowAttenuation</span> <span class="o">+</span> <span class="n">shadowFade</span><span class="p">);</span>
</code></pre></div></div><p>æœ€åï¼Œæä¾›ä¸–ç•Œåæ ‡å’Œè§†å›¾æ·±åº¦åœ¨ç‰‡å…ƒç¨‹åºä¸­åˆ›å»ºå…‰ç…§ã€‚è§†å›¾æ·±åº¦æ˜¯ç‰‡å…ƒåœ¨è§†å›¾ç©ºé—´ä¸­çš„ä½ç½®çš„Zåˆ†é‡ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UnityLight</span> <span class="n">light</span> <span class="o">=</span> <span class="n">CreateLight</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">worldPos</span><span class="p">,</span> <span class="n">viewPos</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527011136822-531625316.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>é˜´å½±æ¸éš.</a></i></center> </font><h3 id="light-cookies">Light Cookies</h3><p>æ”¯æŒCookiesçº¹ç†ï¼Œä½¿ç”¨å˜é‡__LightTexture0_è®¿é—®ï¼›åŒæ—¶è¿˜è¦ä»world-spaceè½¬æ¢åˆ°light-spaceï¼Œæœ€åé‡‡æ ·ã€‚è½¬æ¢çŸ©é˜µä½¿ç”¨_unity_WorldToLight_çŸ©é˜µå˜é‡</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sampler2D</span> <span class="n">_LightTexture0</span><span class="p">;</span>
<span class="n">float4x4</span> <span class="n">unity_WorldToLight</span><span class="p">;</span>
</code></pre></div></div><p>åœ¨_CreateLight_ï¼Œä½¿ç”¨ä¸Šè¿°çŸ©é˜µå˜é‡è½¬æ¢world-spaceåˆ°light-spaceï¼›ç„¶åä½¿ç”¨è½¬æ¢åçš„åæ ‡é‡‡æ ·cookieçº¹ç†ã€‚cookieä¹Ÿè¦è¡°å‡ï¼Œéœ€è¦å•ç‹¬å®šä¹‰å¹¶ä½¿ç”¨ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">_LightDir</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#if defined(DIRECTIONAL_COOKIE)
</span>    <span class="n">float2</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xy</span><span class="p">;</span>
    <span class="n">attenuation</span> <span class="o">*=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="n">uvCookie</span><span class="p">).</span><span class="n">w</span><span class="p">;</span>
<span class="cp">#endif
</span>    <span class="c1">//...</span>
<span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="p">(</span><span class="n">attenuation</span> <span class="o">*</span> <span class="n">shadowAttenuation</span><span class="p">);</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527011137698-104613306.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>å¸¦æœ‰cookieçš„æ–¹å‘å…‰.</a></i></center> </font><p>æ•´ä½“ç»“æœä¼¼ä¹å¯ä»¥ï¼Œä½†æ˜¯è§‚å¯Ÿè¾¹ç¼˜ä¼¼ä¹æœ‰ç¡¬è¾¹</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527011138369-1638016260.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>ç¡¬è¾¹è¿‡æ¸¡.</a></i></center> </font><p>ç›¸é‚»ç‰‡å…ƒçš„cookieåæ ‡çš„å·¨å¤§å·®å¼‚å°±ä¼šå¯¼è‡´è¯¥é—®é¢˜å‡ºç°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒGPUé€‰æ‹©çš„mipmapçº§åˆ«å¯¹äºæœ€è¿‘çš„è¡¨é¢æ˜¯low levelã€‚è§£å†³åŠæ³•ä¹‹ä¸€å°±æ˜¯ï¼šåœ¨é‡‡æ ·mipæ˜ å°„æ—¶åº”ç”¨åç§»ã€‚<a href="http://aras-p.info/blog/2010/01/07/screenspace-vs-mip-mapping/">å¤§vçš„æ€»ç»“</a></p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">attenuation</span> <span class="o">*=</span> <span class="n">tex2Dbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527011138941-1152817269.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>åç§»é‡‡æ ·.</a></i></center> </font><h3 id="æ”¯æŒldr-supporting-ldr">æ”¯æŒLDR Supporting LDR</h3><p>ä¸Šè¿°åªæ”¯æŒHDRï¼Œç°åœ¨æ¥æ”¯æŒLDRã€‚æ­¥éª¤å¦‚ä¸‹ï¼š</p><p>é¦–å…ˆï¼Œç¼–ç åçš„LDRé¢œè‰²è¦ä¹˜å¦‚light-bufferï¼Œè€Œä¸æ˜¯åŠ æ³•ã€‚è¿™å¯ä»¥ç”¨ï¼šBlend DstColor Zeroå®ç°ã€‚<strong>æ³¨æ„</strong>åªç”¨è¯¥Blend modeä¼šå¼•èµ·HDRçš„é”™è¯¯ã€‚æ‰€ä»¥éœ€è¦çµæ´»é…ç½®ï¼šBlend [_SrcBlend] [_DstBlend]</p><p>ç„¶åï¼Œä½¿ç”¨$2^{-c}$å‡½æ•°è§£ç </p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">UNITY_BRDF_PBS</span><span class="p">(</span>
        <span class="n">albedo</span><span class="p">,</span> <span class="n">specularTint</span><span class="p">,</span> <span class="n">oneMinusReflectivity</span><span class="p">,</span> <span class="n">smoothness</span><span class="p">,</span>
        <span class="n">normal</span><span class="p">,</span> <span class="n">viewDir</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">indirectLight</span>
<span class="p">);</span>
    <span class="cp">#if !defined(UNITY_HDR_ON)
</span>        <span class="n">color</span> <span class="o">=</span> <span class="n">exp2</span><span class="p">(</span><span class="o">-</span><span class="n">color</span><span class="p">);</span>
    <span class="cp">#endif
</span><span class="k">return</span> <span class="n">color</span><span class="p">;</span>
</code></pre></div></div><h2 id="èšå…‰æº-spotlights">èšå…‰æº Spotlights</h2><p>å› ä¸ºæ–¹å‘å…‰ä¼šå½±å“åˆ°åœºæ™¯å†…æ‰€æœ‰ç‰©ä½“ï¼Œæ‰€ä»¥è¢«ç”»æˆå…¨å±quadã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œèšå…‰ç¯åªä¼šå½±å“ä½äºåœ†é”¥ä½“å†…çš„éƒ¨åˆ†ç‰©ä½“ã€‚é€šå¸¸ä¸éœ€è¦è®¡ç®—æ•´ä¸ªå›¾åƒçš„èšå…‰ç¯å…‰ç…§ï¼Œå°†ç»˜åˆ¶ä¸€ä¸ªä¸èšå…‰ç¯çš„å½±å“èŒƒå›´ç›¸åŒ¹é…çš„é‡‘å­—å¡”ä½“ã€‚</p><h3 id="drawing-a-pyramid">Drawing a Pyramid</h3><p>ç¦ç”¨æ–¹å‘ç¯ï¼Œæ”¹ç”¨èšå…‰ç¯ã€‚å› ä¸ºç€è‰²å™¨åªå¯¹æ–¹å‘å…‰æ­£ç¡®å·¥ä½œï¼Œé‚£ä¹ˆç°åœ¨çš„ç»“æœä¼šå‡ºç°é”™è¯¯ã€‚ä½†æ˜¯å®ƒä»å¯ä»¥è®©ä½ çœ‹åˆ°é‡‘å­—å¡”çš„å“ªäº›éƒ¨åˆ†è¢«æ¸²æŸ“äº†ã€‚</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527011139705-601577612.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æ¸²æŸ“èŒƒå›´.</a></i></center> </font><p>æ ¹æ®ä¸Šå›¾ï¼Œé‡‘å­—å¡”æ˜¯ä½œä¸ºä¸€ä¸ªæ™®é€šçš„3Då¯¹è±¡å‘ˆç°çš„ã€‚å®ƒçš„èƒŒé¢è¢«å‰”é™¤ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é‡‘å­—å¡”çš„æ­£é¢ã€‚åªæœ‰å½“å®ƒå‰é¢æ²¡æœ‰ä¸œè¥¿çš„æ—¶å€™ï¼Œå®ƒæ‰ä¼šè¢«ç”»å‡ºæ¥ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æ·»åŠ äº†ä¸€ä¸ªpassï¼Œç”¨äºè®¾ç½®æ¨¡æ¿ç¼“å†²åŒºï¼Œä»¥å°†ç»˜å›¾é™åˆ¶ä¸ºä½äºé‡‘å­—å¡”å·å†…çš„ç‰‡æ®µã€‚æ‚¨å¯ä»¥é€šè¿‡frame-debuggeræ¥éªŒè¯ã€‚</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527011140292-1380890338.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>å‰”é™¤æ–¹å¼.</a></i></center> </font><p>è¿™æ„å‘³ç€æˆ‘ä»¬çš„ç€è‰²å™¨çš„cullingå’Œz-testè®¾ç½®è¢«å¦å¼ƒäº†ã€‚ å› æ­¤å°†å…¶ä»ç€è‰²å™¨ä¸­åˆ é™¤ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Blend</span> <span class="p">[</span><span class="n">_SrcBlend</span><span class="p">]</span> <span class="p">[</span><span class="n">_DstBlend</span><span class="p">]</span>
<span class="c1">//Cull Off</span>
<span class="c1">//ZTest Always</span>
<span class="n">ZWrite</span> <span class="n">Off</span>
</code></pre></div></div><p>å½“èšå…‰ç¯çš„ä½“ç§¯è·ç¦»ç›¸æœºè¶³å¤Ÿè¿œæ—¶ï¼Œæ­¤æ–¹æ³•é€‚ç”¨ã€‚ ä½†æ˜¯ï¼Œå½“èšå…‰ç¯ç¦»æ‘„åƒæœºå¤ªè¿‘æ—¶ï¼Œå®ƒä¼šå¤±è´¥ã€‚ å‘ç”Ÿè¿™ç§æƒ…å†µæ—¶ï¼Œç›¸æœºå¯èƒ½ä¼šè¿›å…¥äº†è¯¥ä½“ç§¯å†…ã€‚ ç”šè‡³æœ‰å¯èƒ½å°†è¿‘å¹³é¢çš„ä¸€éƒ¨åˆ†ç½®äºå…¶å†…éƒ¨ï¼Œè€Œå°†å…¶ä½™éƒ¨åˆ†ç½®äºå…¶å¤–éƒ¨ï¼Œä¸è¿‘å¹³é¢ç›¸äº¤äº†ã€‚ åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæ¨¡æ¿ç¼“å†²åŒºä¸èƒ½ç”¨äºé™åˆ¶æ¸²æŸ“ã€‚</p><p>ä»ç„¶æ¸²æŸ“å…‰ç…§çš„æŠ€å·§æ˜¯ç»˜åˆ¶é‡‘å­—å¡”çš„å†…è¡¨é¢ï¼Œè€Œä¸æ˜¯é‡‘å­—å¡”çš„å¤–è¡¨é¢ã€‚ è¿™æ˜¯é€šè¿‡æ¸²æŸ“å…¶èƒŒé¢è€Œä¸æ˜¯å…¶æ­£é¢æ¥å®Œæˆçš„ã€‚ è€Œä¸”ï¼Œä»…å½“è¿™äº›è¡¨é¢æœ€ç»ˆä½äºå·²æ¸²æŸ“çš„è¡¨é¢ä¹‹åæ—¶æ‰æ¸²æŸ“å®ƒä»¬ã€‚ è¿™ç§æ–¹æ³•è¿˜æ¶µç›–äº†èšå…‰ç¯ä½“ç§¯å†…çš„æ‰€æœ‰ç‰‡æ®µã€‚ ä½†è¿™æœ€ç»ˆå¯¼è‡´æ¸²æŸ“äº†å¤ªå¤šçš„ç¢ç‰‡ï¼Œå› ä¸ºé€šå¸¸é‡‘å­—å¡”çš„é€šå¸¸éšè—éƒ¨åˆ†ä¹Ÿå°†è¢«æ¸²æŸ“ã€‚ å› æ­¤ï¼Œä»…åœ¨å¿…è¦æ—¶æ‰§è¡Œã€‚</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527011141041-480459935.png" width="250" alt="loading failed, need vpn." /> <img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527011141704-455701372.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>å½“é è¿‘ç›¸æœºæ—¶ï¼Œè¦ç»˜åˆ¶èƒŒé¢æ‰æ­£ç¡®.</a></i></center> </font><h3 id="æ”¯æŒå¤šå…‰æº-supporting-multiple-light-types">æ”¯æŒå¤šå…‰æº Supporting Multiple Light Types</h3><p>ç›®å‰ï¼ŒCreateLightåªèƒ½ç”¨äºæ–¹å‘å…‰ã€‚è®©æˆ‘ä»¬ç¡®ä¿ç‰¹å®šäºæ–¹å‘ç¯çš„ä»£ç åªåœ¨é€‚å½“çš„æ—¶å€™ä½¿ç”¨ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UnityLight</span> <span class="nf">CreateLight</span> <span class="p">(</span><span class="n">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="n">float3</span> <span class="n">worldPos</span><span class="p">,</span> <span class="kt">float</span> <span class="n">viewZ</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UnityLight</span> <span class="n">light</span><span class="p">;</span>
    <span class="c1">//light.dir = -_LightDir;</span>
    <span class="kt">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="cp">#if defined(DIRECTIONAL) || defined(DIRECTIONAL_COOKIE)
</span>        <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">_LightDir</span><span class="p">;</span>

        <span class="cp">#if defined(DIRECTIONAL_COOKIE)
</span>            <span class="n">float2</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xy</span><span class="p">;</span>
            <span class="n">attenuation</span> <span class="o">*=</span> <span class="n">tex2Dbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>
        <span class="cp">#endif
</span>
        <span class="cp">#if defined(SHADOWS_SCREEN)
</span>            <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_ShadowMapTexture</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">shadowFadeDistance</span> <span class="o">=</span> <span class="n">UnityComputeShadowFadeDistance</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="n">viewZ</span><span class="p">);</span>
            <span class="kt">float</span> <span class="n">shadowFade</span> <span class="o">=</span> <span class="n">UnityComputeShadowFade</span><span class="p">(</span><span class="n">shadowFadeDistance</span><span class="p">);</span>
            <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">shadowAttenuation</span> <span class="o">+</span> <span class="n">shadowFade</span><span class="p">);</span>
        <span class="cp">#endif
</span>    <span class="cp">#else
</span>        <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="cp">#endif
</span>
    <span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="p">(</span><span class="n">attenuation</span> <span class="o">*</span> <span class="n">shadowAttenuation</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">light</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>å°½ç®¡é˜´å½±è¡°è½åŸºäºæ–¹å‘é˜´å½±è´´å›¾ï¼Œä½†æ˜¯å…¶ä»–ç±»å‹çš„é˜´å½±ä¹Ÿåº”è¯¥ä¼šè¢«æ¸éšã€‚ è¿™æ ·å¯ä»¥ç¡®ä¿æ‰€æœ‰é˜´å½±éƒ½ä»¥ç›¸åŒçš„æ–¹å¼æ¸éšï¼Œè€Œä¸ä»…ä»…æ˜¯æŸäº›é˜´å½±ã€‚ å› æ­¤ï¼Œåªè¦æœ‰é˜´å½±ï¼Œé˜´å½±æ·¡å…¥æ·¡å‡ºä»£ç ä¾¿é€‚ç”¨äºæ‰€æœ‰ç¯å…‰ã€‚ å› æ­¤ï¼Œè®©æˆ‘ä»¬å°†è¯¥ä»£ç ç§»åˆ°ç‰¹å®šäºå…‰æºçš„å—ä¹‹å¤–ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¸ƒå°”å€¼æ¥æ§åˆ¶æ˜¯å¦ä½¿ç”¨é˜´å½±æ·¡å‡ºä»£ç ã€‚ç”±äºå¸ƒå°”å€¼æ˜¯ä¸€ä¸ªå¸¸æ•°å€¼ï¼Œå¦‚æœå®ƒä»ç„¶ä¸ºå‡ï¼Œä»£ç å°†è¢«åˆ é™¤ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UnityLight</span> <span class="nf">CreateLight</span> <span class="p">(</span><span class="n">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="n">float3</span> <span class="n">worldPos</span><span class="p">,</span> <span class="kt">float</span> <span class="n">viewZ</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UnityLight</span> <span class="n">light</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">shadowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="cp">#if defined(DIRECTIONAL) || defined(DIRECTIONAL_COOKIE)
</span>        <span class="c1">//çœç•¥ä»£ç </span>
        <span class="cp">#if defined(SHADOWS_SCREEN)
</span>            <span class="n">shadowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_ShadowMapTexture</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
        <span class="c1">// float shadowFadeDistance = UnityComputeShadowFadeDistance(worldPos, viewZ);</span>
        <span class="c1">// float shadowFade = UnityComputeShadowFade(shadowFadeDistance);</span>
        <span class="c1">// shadowAttenuation = saturate(shadowAttenuation + shadowFade);</span>
        <span class="cp">#endif
</span>    <span class="cp">#else
</span>        <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="cp">#endif
</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">shadowed</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">float</span> <span class="n">shadowFadeDistance</span> <span class="o">=</span> <span class="n">UnityComputeShadowFadeDistance</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="n">viewZ</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">shadowFade</span> <span class="o">=</span> <span class="n">UnityComputeShadowFade</span><span class="p">(</span><span class="n">shadowFadeDistance</span><span class="p">);</span>
        <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">shadowAttenuation</span> <span class="o">+</span> <span class="n">shadowFade</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="p">(</span><span class="n">attenuation</span> <span class="o">*</span> <span class="n">shadowAttenuation</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">light</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>éæ–¹å‘ç¯å…‰éƒ½æœ‰ä¸€ä¸ªpositionå˜é‡ã€‚å®ƒé€šè¿‡å†…ç½®çš„_LightPosæä¾›ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float4</span> <span class="n">_LightColor</span><span class="p">,</span> <span class="n">_LightDir</span><span class="p">,</span> <span class="n">_LightPos</span><span class="p">;</span>
</code></pre></div></div><p>ç°åœ¨å¯ä»¥ç¡®å®šèšå…‰ç¯çš„å…‰å‘é‡å¾—å‡ºå…‰æ–¹å‘ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#else
</span>    <span class="n">float3</span> <span class="n">lightVec</span> <span class="o">=</span> <span class="n">_LightPos</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">worldPos</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">lightVec</span><span class="p">);</span>
<span class="cp">#endif
</span></code></pre></div></div><h3 id="world-position-agin">World Position Agin</h3><p>ç»“æœä¸ºé»‘è‰²ï¼Œä¼¼ä¹å…‰çº¿æ–¹å‘ä¸æ­£ç¡®ã€‚ å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸ºèšå…‰ç¯çš„ä¸–ç•Œä½ç½®è®¡ç®—ä¸æ­£ç¡®ã€‚ å½“æˆ‘ä»¬åœ¨åœºæ™¯ä¸­çš„æŸä¸ªåœ°æ–¹æ¸²æŸ“é‡‘å­—å¡”æ—¶ï¼Œä¸åƒæ–¹å‘å…‰é‚£æ ·æ¸²æŸ“å…¨å±quadå°†å…‰çº¿å­˜å‚¨åœ¨normalé€šé“ä¸­ã€‚ è€Œå¿…é¡»æ˜¯ç»ç”±Vertex-Programä»é¡¶ç‚¹çš„ä½ç½®å‘å°„å°„çº¿ï¼Œé€šè¿‡å°†é¡¶ç‚¹çš„posè½¬æ¢åˆ°view-spaceå®Œæˆè®¡ç®—ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨UnityObjectToViewPoså‡½æ•°ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">i</span><span class="p">.</span><span class="n">ray</span> <span class="o">=</span> <span class="n">UnityObjectToViewPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
</code></pre></div></div><p>ç„¶è€Œï¼Œè¿™ä¼šäº§ç”Ÿæ–¹å‘é”™è¯¯çš„å…‰çº¿ã€‚æˆ‘ä»¬è¦æ¶ˆå»å®ƒä»¬çš„Xå’ŒYåæ ‡ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">i</span><span class="p">.</span><span class="n">ray</span> <span class="o">=</span> <span class="n">UnityObjectToViewPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">)</span> <span class="o">*</span> <span class="nf">float3</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527011142595-16646437.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æ­£ç¡®çš„ä¸–ç•Œä½ç½®.</a></i></center> </font><p>å†æ¬¡çœ‹çœ‹UnityObjectToViewPoså†…éƒ¨å®ç°</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">inline</span> <span class="n">float3</span> <span class="nf">UnityObjectToViewPos</span> <span class="p">(</span><span class="n">in</span> <span class="n">float3</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_V</span><span class="p">,</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_ObjectToWorld</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">))).</span><span class="n">xyz</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>å½“æ¸²æŸ“æ–¹å‘å…‰æ—¶ï¼Œåº”è¯¥åªä½¿ç”¨é¡¶ç‚¹æ³•çº¿ã€‚å½“æ¸²æŸ“éæ–¹å‘ç¯ä»¥å¤–çš„å…‰å‡ ä½•æ—¶ï¼Œéœ€è¦æŠŠé¡¶ç‚¹posè½¬åˆ°view-spaceè®¡ç®—ã€‚Unityé€šè¿‡__LightAsQuad_å˜é‡å‘Šè¯‰æˆ‘ä»¬æ­£åœ¨å¤„ç†å“ªç§æƒ…å†µã€‚</p><p>å¦‚æœ__LightAsQuad_è¢«è®¾ä¸º1ï¼Œåˆ™å¤„ç†çš„æ˜¯æ–¹å‘å…‰quadå¹¶ä¸”å¯ä»¥ä½¿ç”¨æ³•çº¿ã€‚å¦åˆ™ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨UnityObjectToViewPosã€‚æ’å€¼å¥½è¿‡if ==&gt; from + (to â€“ from) * t, tä¸º1ç›´æ¥ä½¿ç”¨æ³•çº¿ï¼Œä¸º0ç›´æ¥è®¡ç®—åˆ°view-space</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">i</span><span class="p">.</span><span class="n">ray</span> <span class="o">=</span> <span class="n">lerp</span>
<span class="p">(</span>
    <span class="n">UnityObjectToViewPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">)</span> <span class="o">*</span> <span class="nf">float3</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span>
    <span class="n">_LightAsQuad</span>
<span class="p">);</span>
</code></pre></div></div><h3 id="é”¥å½¢è¡°å‡-cookie-attenuation">é”¥å½¢è¡°å‡ Cookie Attenuation</h3><p>èšå…‰ç¯çš„é”¥å½¢è¡°å‡æ˜¯é€šè¿‡cookieçº¹ç†åˆ›å»ºçš„ï¼Œæ— è®ºæ˜¯é»˜è®¤çš„åœ†å½¢è¿˜æ˜¯å®šåˆ¶çš„cookieã€‚æˆ‘ä»¬å¯ä»¥ä»å¤åˆ¶å®šå‘å…‰çš„cookieä»£ç ï¼Œä»¿ç…§ç€å†™ã€‚ä¹Ÿæ˜¯å­˜å‚¨åœ¨_LightTexture0</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">lightVec</span> <span class="o">=</span> <span class="n">_LightPos</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">worldPos</span><span class="p">;</span>
<span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">lightVec</span><span class="p">);</span>
<span class="n">float2</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xy</span><span class="p">;</span>
<span class="n">attenuation</span> <span class="o">*=</span> <span class="n">tex2Dbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>
</code></pre></div></div><p>ä½†æ˜¯ï¼Œèšå…‰ç¯Cookieè¶Šè¿œç¦»ç¯å…‰ä½ç½®ï¼Œå®ƒå°±ä¼šå˜å¾—è¶Šå¤§ã€‚ è¿™æ˜¯ç”±äºé€šè¿‡é€è§†å˜æ¢é€ æˆçš„ã€‚ å› æ­¤ï¼ŒçŸ©é˜µä¹˜æ³•ä¼šäº§ç”Ÿ4Dé½æ¬¡åæ ‡ã€‚ ä¸ºäº†å¾—åˆ°è§„åˆ™çš„2Dåæ ‡ï¼Œæˆ‘ä»¬å¿…é¡»å°†Xå’ŒYé™¤ä»¥Wã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float4</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
<span class="n">uvCookie</span><span class="p">.</span><span class="n">xy</span> <span class="o">/=</span> <span class="n">uvCookie</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="n">attenuation</span> <span class="o">*=</span> <span class="n">tex2Dbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527012302994-353496315.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>cookieè¡°å‡.</a></i></center> </font><p>ä¸Šå›¾å®é™…ä¸Šäº§ç”Ÿäº†ä¸¤ä¸ªå…‰é”¥ï¼Œä¸€ä¸ªå‘å‰ä¸€ä¸ªå‘åã€‚ åå‘åœ†é”¥é€šå¸¸åœ¨æ¸²æŸ“åŒºåŸŸä¹‹å¤–ç»“æŸï¼Œä½†è¿™å¹¶ä¸èƒ½ä¿è¯ã€‚æˆ‘ä»¬åªéœ€è¦å‰å‘é”¥ï¼Œå®ƒå¯¹åº”äºè´Ÿçš„Wåæ ‡ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">attenuation</span> <span class="o">*=</span> <span class="n">tex2Dbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>
<span class="n">attenuation</span> <span class="o">*=</span> <span class="n">uvCookie</span><span class="p">.</span><span class="n">w</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div></div><h3 id="è·ç¦»è¡°å‡-distance-attenuation">è·ç¦»è¡°å‡ Distance Attenuation</h3><p>èšå…‰ç¯å‘å‡ºçš„å…‰ä¹Ÿä¼šæ ¹æ®è·ç¦»è¡°å‡ã€‚æ­¤è¡°å‡å­˜å‚¨åœ¨æŸ¥æ‰¾çº¹ç†ä¸­ï¼Œå¯é€šè¿‡__LightTextureB0_ä½¿ç”¨è¯¥çº¹ç†ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sampler2D</span> <span class="n">_LightTexture0</span><span class="p">,</span> <span class="n">_LightTextureB0</span><span class="p">;</span>
</code></pre></div></div><p>çº¹ç†è¢«è®¾è®¡æˆå¿…é¡»ä½¿ç”¨å…‰çš„è·ç¦»çš„å¹³æ–¹ï¼Œå¹¶æŒ‰å…‰çš„èŒƒå›´è¿›è¡Œç¼©æ”¾ï¼Œä½œä¸ºUVè¿›è¡Œé‡‡æ ·ã€‚èŒƒå›´å­˜å‚¨åœ¨_LightPosçš„ç¬¬å››ä¸ªåˆ†é‡ä¸­ã€‚é‡‡æ ·å¾—åˆ°çš„çº¹ç†åº”è¯¥ä½¿ç”¨å“ªä¸ªé€šé“åœ¨ä¸åŒçš„å¹³å°ï¼Œç”±_UNITY_ATTEN_CHANNEL_å®å®šä¹‰ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">lightVec</span><span class="p">);</span>
<span class="n">attenuation</span> <span class="o">*=</span> <span class="n">tex2D</span>
<span class="p">(</span>
    <span class="n">_LightTextureB0</span><span class="p">,</span>
    <span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">lightVec</span><span class="p">,</span> <span class="n">lightVec</span><span class="p">)</span> <span class="o">*</span> <span class="n">_LightPos</span><span class="p">.</span><span class="n">w</span><span class="p">).</span><span class="n">rr</span>
<span class="p">).</span><span class="n">UNITY_ATTEN_CHANNEL</span><span class="p">;</span>
<span class="n">float4</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527085923716-1558484014.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>cookie å’Œ distanceè¡°å‡.</a></i></center> </font><h3 id="shadows">Shadows</h3><p>å½“èšå…‰ç¯æœ‰é˜´å½±æ—¶ï¼Œå®šä¹‰SHADOWS_DEPTHå…³é”®å­—ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//åœ¨CreateLightä¸­</span>
<span class="n">float4</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
<span class="n">uvCookie</span><span class="p">.</span><span class="n">xy</span> <span class="o">/=</span> <span class="n">uvCookie</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="n">attenuation</span> <span class="o">*=</span> <span class="n">tex2Dbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>

<span class="cp">#if defined(SHADOWS_DEPTH)
</span>    <span class="n">shadowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#endif
</span></code></pre></div></div><p>èšå…‰ç¯å’Œæ–¹å‘ç¯ä½¿ç”¨ç›¸åŒçš„å˜é‡æ¥é‡‡æ ·é˜´å½±è´´å›¾ã€‚åœ¨èšå…‰ç¯çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨å†…ç½®UnitySampleShadowmapæ¥å¤„ç†é‡‡æ ·ç¡¬é˜´å½±æˆ–è½¯é˜´å½±çš„ç»†èŠ‚ã€‚å‚æ•°ï¼šé˜´å½±ç©ºé—´ä¸­çš„ç‰‡å…ƒä½ç½®ã€‚unity_WorldToShadow_(4x4)_çŸ©é˜µä¸­ç¬¬ä¸€ä¸ªæ•°ç»„å¯ä»¥ç”¨æ¥å°†ä¸–ç•Œç©ºé—´è½¬æ¢ä¸ºé˜´å½±ç©ºé—´ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shadowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">UnitySampleShadowmap</span><span class="p">(</span>
    <span class="n">mul</span><span class="p">(</span><span class="n">unity_WorldToShadow</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="p">);</span>
</code></pre></div></div><h3 id="ç‚¹å…‰æº-point-lights">ç‚¹å…‰æº Point Lights</h3><p>ç‚¹å…‰æºä½¿ç”¨ä¸èšå…‰ç¯ç›¸åŒçš„å…‰å‘é‡ã€æ–¹å‘å’Œè·ç¦»è¡°å‡ã€‚è¿™æ ·ä»–ä»¬å°±å¯ä»¥å…±äº«ä»£ç ã€‚åº”è¯¥åªåœ¨å®šä¹‰SPOTå…³é”®å­—æ—¶ä½¿ç”¨spotlightä»£ç çš„å…¶ä½™éƒ¨åˆ†ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if defined(DIRECTIONAL) || defined(DIRECTIONAL_COOKIE)
</span>    <span class="c1">//...</span>
<span class="cp">#else
</span>    <span class="n">float3</span> <span class="n">lightVec</span> <span class="o">=</span> <span class="n">_LightPos</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">worldPos</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">lightVec</span><span class="p">);</span>

    <span class="n">attenuation</span> <span class="o">*=</span> <span class="n">tex2D</span><span class="p">(</span>
        <span class="n">_LightTextureB0</span><span class="p">,</span>
        <span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">lightVec</span><span class="p">,</span> <span class="n">lightVec</span><span class="p">)</span> <span class="o">*</span> <span class="n">_LightPos</span><span class="p">.</span><span class="n">w</span><span class="p">).</span><span class="n">rr</span>
    <span class="p">).</span><span class="n">UNITY_ATTEN_CHANNEL</span><span class="p">;</span>

    <span class="cp">#if defined(SPOT)
</span>        <span class="n">float4</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
        <span class="n">uvCookie</span><span class="p">.</span><span class="n">xy</span> <span class="o">/=</span> <span class="n">uvCookie</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
        <span class="n">attenuation</span> <span class="o">*=</span>
            <span class="n">tex2Dbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>
        <span class="n">attenuation</span> <span class="o">*=</span> <span class="n">uvCookie</span><span class="p">.</span><span class="n">w</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cp">#if defined(SHADOWS_DEPTH)
</span>            <span class="n">shadowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">UnitySampleShadowmap</span><span class="p">(</span>
                <span class="n">mul</span><span class="p">(</span><span class="n">unity_WorldToShadow</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">);</span>
        <span class="cp">#endif
</span>    <span class="cp">#endif
#endif
</span></code></pre></div></div><p>è¿™å·²ç»è¶³å¤Ÿè®©ç‚¹å…‰æºå·¥ä½œäº†ã€‚å®ƒä»¬è¢«æ¸²æŸ“æˆå’Œèšå…‰ç¯ä¸€æ ·çš„æ•ˆæœï¼Œé™¤äº†æ¸²æŸ“èŒƒå›´ä½¿ç”¨çš„æ˜¯çƒå½¢è€Œä¸æ˜¯é”¥å½¢ã€‚</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527085924576-1982519938.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>é«˜äº®.</a></i></center> </font><h3 id="shadows-1">Shadows</h3><p>ç‚¹å…‰æºçš„é˜´å½±å­˜å‚¨åœ¨ä¸€ä¸ªCubeMapã€‚å†…ç½®UnitySampleShadowmapå¯é‡‡æ ·ã€‚å‚æ•°ï¼šå…‰çš„æ–¹å‘ã€‚ä¸€ä¸ªä»å…‰åˆ°è¡¨é¢çš„å‘é‡ã€‚å®ƒæ˜¯å…‰çš„ç›¸åæ–¹å‘ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if defined(SPOT)
</span><span class="c1">//...</span>
<span class="cp">#else
</span>    <span class="cp">#if defined(SHADOWS_CUBE)
</span>        <span class="n">shadowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">UnitySampleShadowmap</span><span class="p">(</span><span class="o">-</span><span class="n">lightVec</span><span class="p">);</span>
    <span class="cp">#endif
#endif
</span></code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527085925412-308331709.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>ç‚¹å…‰æºé˜´å½±.</a></i></center> </font><h3 id="cookies">Cookies</h3><p>Point light cookieä¹Ÿå¯ä»¥é€šè¿‡_LightTexture0è·å¾—ã€‚éœ€è¦çš„æ˜¯ä¸€ä¸ªcubeMapæ˜ å°„ï¼Œè€Œä¸æ˜¯å¸¸è§„çš„çº¹ç†ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//sampler2D _LightTexture0, _LightTextureB0;</span>
<span class="cp">#if defined(POINT_COOKIE)
</span>    <span class="n">samplerCUBE</span> <span class="n">_LightTexture0</span><span class="p">;</span>
<span class="cp">#else
</span>    <span class="n">sampler2D</span> <span class="n">_LightTexture0</span><span class="p">;</span>
<span class="cp">#endif
</span>
<span class="n">sampler2D</span> <span class="n">_LightTextureB0</span><span class="p">;</span>
<span class="n">float4x4</span> <span class="n">unity_WorldToLight</span><span class="p">;</span>
</code></pre></div></div><p>è¦å¯¹cookieè¿›è¡Œé‡‡æ ·ï¼Œè¯·å°†ç‰‡æ®µçš„world-spaceè½¬æ¢ä¸ºlight-spaceï¼Œå¹¶ä½¿ç”¨å…‰ç…§ç©ºé—´å¯¹ç«‹æ–¹ä½“æ˜ å°„è¿›è¡Œé‡‡æ ·ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#else
</span>    <span class="cp">#if defined(POINT_COOKIE)
</span>        <span class="n">float3</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
        <span class="n">attenuation</span> <span class="o">*=</span> <span class="n">texCUBEbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>
    <span class="cp">#endif
</span>
    <span class="cp">#if defined(SHADOWS_CUBE)
</span>        <span class="n">shadowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">UnitySampleShadowmap</span><span class="p">(</span><span class="o">-</span><span class="n">lightVec</span><span class="p">);</span>
    <span class="cp">#endif
#endif
</span></code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender15/1692664-20200527085926193-2066682458.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>ç‚¹å…‰æºcookie.</a></i></center> </font><h3 id="skipping-shadows">Skipping Shadows</h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è‡ªå·±çš„ç€è‰²å™¨æ¸²æŸ“æ‰€æœ‰åŠ¨æ€å…‰æºã€‚ å°½ç®¡æˆ‘ä»¬ç›®å‰å¹¶æœªå¯¹ä¼˜åŒ–è¿›è¡Œå¤ªå¤šå…³æ³¨ï¼Œä½†ä»æœ‰ä¸€é¡¹æ½œåœ¨çš„å¤§å‹ä¼˜åŒ–<strong>å€¼å¾—è€ƒè™‘</strong>ï¼š<strong>æœ€ç»ˆè¶…å‡ºé˜´å½±æ¸éšè·ç¦»çš„ç‰‡å…ƒå°†ä¸ä¼šè¢«é˜´å½±åŒ–</strong>ã€‚ ä½†æ˜¯ç°åœ¨ä»åœ¨é‡‡æ ·å®ƒä»¬çš„é˜´å½±ï¼Œè¿™å¯èƒ½å¾ˆæ˜‚è´µã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡åŸºäºé˜´å½±è¡°è½å› å­è¿›è¡Œ_UNITY_BRANCH_åˆ†æ”¯æ¥é¿å…è¿™ç§æƒ…å†µã€‚ å®ƒæ¥è¿‘1ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å®Œå…¨è·³è¿‡é˜´å½±è¡°å‡ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">shadowed</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float</span> <span class="n">shadowFadeDistance</span> <span class="o">=</span> <span class="n">UnityComputeShadowFadeDistance</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="n">viewZ</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">shadowFade</span> <span class="o">=</span> <span class="n">UnityComputeShadowFade</span><span class="p">(</span><span class="n">shadowFadeDistance</span><span class="p">);</span>
    <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">shadowAttenuation</span> <span class="o">+</span> <span class="n">shadowFade</span><span class="p">);</span>
    <span class="n">UNITY_BRANCH</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">shadowFade</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>ä½†æ˜¯ï¼Œå³ä½¿ç”¨äº†_UNITY_BRANCH_åˆ†æ”¯å®ƒæœ¬èº«ä¹Ÿå¾ˆæ˜‚è´µã€‚é™¤äº†é è¿‘é˜´å½±åŒºåŸŸçš„è¾¹ç¼˜ï¼Œæ‰€æœ‰ç¢ç‰‡éƒ½è½åœ¨é˜´å½±åŒºåŸŸçš„å†…éƒ¨æˆ–å¤–éƒ¨ã€‚ ä½†è¿™ä»…åœ¨GPUå¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹çš„æƒ…å†µä¸‹æ‰é‡è¦ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨HLSLSupport.cgincå®šä¹‰UNITY_FAST_COHERENT_DYNAMIC_BRANCHINGå®ã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if defined(UNITY_FAST_COHERENT_DYNAMIC_BRANCHING)
</span>    <span class="n">UNITY_BRANCH</span>
    <span class="nf">if</span> <span class="p">(</span><span class="n">shadowFade</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif
</span></code></pre></div></div><p>å³ä½¿è¿™æ ·ï¼Œä»…å½“é˜´å½±éœ€è¦å¤šä¸ªçº¹ç†æ ·æœ¬æ—¶æ‰å€¼å¾—ä½¿ç”¨ã€‚ <strong>å¯¹äºæŸ”å’Œçš„èšå…‰ç¯å’Œç‚¹å…‰æºé˜´å½±ï¼Œè¿›ä¸€æ­¥ä½¿ç”¨ç”¨SHADOWS_SOFTå…³é”®å­—æŒ‡ç¤º</strong>ã€‚ è€Œæ–¹å‘å…‰é˜´å½±å§‹ç»ˆåªéœ€è¦å•ä¸ªçº¹ç†ï¼Œå› æ­¤å®ƒæ€§èƒ½å¾ˆä¾¿å®œã€‚</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if defined(UNITY_FAST_COHERENT_DYNAMIC_BRANCHING) &amp;&amp; defined(SHADOWS_SOFT)
</span>    <span class="n">UNITY_BRANCH</span>
    <span class="nf">if</span> <span class="p">(</span><span class="n">shadowFade</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif
</span></code></pre></div></div></article><hr><div class='like-post'> <a style="color:rgb(112, 40, 85);" id="likeBtn" onclick="likePost(1);"> <i class="fa fa-thumbs-o-up fa-2x" aria-hidden="true"></i> </a> <span id="likeNum">0</span><div class="text-xs text-slate-500 mx-2">çœŸè¯šç‚¹èµï¼Œæ‰‹ç•™ä½™é¦™</div></div><h2 id="similar_posts">Similar Posts</h2><ul><li class="relatedPost"> <a href="/2018/01/25/Unity_Parallax_Normals_Heightmap/">è§†å·®å’Œæ³•çº¿ã€é«˜åº¦å›¾å›é¡¾(ç¿»è¯‘äºŒå) </a><li class="relatedPost"> <a href="/2018/01/24/Unity_GPU_Instance/">Unity GPU Instance(ç¿»è¯‘åä¹) </a><li class="relatedPost"> <a href="/2018/01/23/Unity_RealTime_GI_LOD/">Unity å®æ—¶ GI & LPPV & LOD(ç¿»è¯‘åå…«) </a><li class="relatedPost"> <a href="/2018/01/21/Unity_Mix_Lighting/">Unity æ··åˆå…‰ç…§(ç¿»è¯‘åä¸ƒ) </a><li class="relatedPost"> <a href="/2018/01/19/Unity_Static_Lightting/">Unity å…‰ç…§çƒ˜ç„™(ç¿»è¯‘åå…­) </a><li class="relatedPost"> <a href="/2018/01/15/UNity_Shader_Fog/">Unity Shader Fog(ç¿»è¯‘åå››) </a></ul><div class="post-recent"><div class="pre"><p><strong>ä¸Šä¸€ç¯‡</strong> <a href="/2018/01/15/UNity_Shader_Fog/">Unity Shader Fog(ç¿»è¯‘åå››)</a></p></div><div class="nex"><p><strong>ä¸‹ä¸€ç¯‡</strong> <a href="/2018/01/19/Unity_Static_Lightting/">Unity å…‰ç…§çƒ˜ç„™(ç¿»è¯‘åå…­)</a></p></div></div><h2 id="comments">Comments</h2><div id="vcomments"></div><script type="text/javascript"> /*è¯„è®ºç›¸å…³*/ function delayLoadValine() { new Valine({ el: '#vcomments', verify: "true", notify: "false", app_id: "rbtCCmKrVdjghvJbkHOoyx9F-gzGzoHsz", app_key: "TnNTd821LZSYh3cREOLIm9cO", avatar: "monsterid", placeholder: "æ¬¢è¿è¯„è®ºï¼", pageSize: "10 || 10", master: "b5586e582cb181c6b0fc8b2ce828bd50", tagMeta: ["åšä¸»","å°ä¼™ä¼´","è®¿å®¢"], enableQQ: true, requiredFields: [], serverURLs: "", }); $(document).ready(function(){ fetch('https://v1.hitokoto.cn') .then(response => response.json()) .then(data => { document.getElementById("veditor").setAttribute( "placeholder", data.hitokoto+"â€”"+data.from ); setTimeout(() => { addPostVisitedTimes(); }, 1000); } ) .catch(console.error); }); } /*ç‚¹èµç›¸å…³*/ var curIpVisitRecord = null; var curPost = null; var curUrl = "https://www.damonc.top/2018/01/17/Unity_Deferred_Lights/"; function getVisitorIpAndJudge() { $.getJSON('https://api.ipify.org?format=json', function(data){ saveOrUpdateIpRecord(data.ip) }); } function saveOrUpdateIpRecord(ip) { var Visitor = AV.Object.extend("visitors_record"); var post_url = curUrl; var query = new AV.Query(Visitor); query.equalTo("visitor_ip", ip); query.equalTo("post_url", post_url); query.find().then(function(results) { if (results.length > 0) { /* if(window.console){ console.log('è¯¥IPå·²è®¿é—®è¿‡è¯¥æ–‡ç« '); }*/ curIpVisitRecord = results[0]; updateIpRecord(); refreshLikeBtn(); } else { /*if(window.console){ console.log('è¯¥IPç¬¬ä¸€æ¬¡è®¿é—®è¯¥æ–‡ç« ï¼Œä¿å­˜æ–°çš„è®¿é—®è®°å½•ï¼Œå¹¶å¢åŠ è®¿é—®æ¬¡æ•°'); }*/ addNewIpRecord(ip, post_url); } }, function(error) { addPostVisitedTimes(); }); } function addPostVisitedTimes() { var AV_Posts = AV.Object.extend("Posts"); var url = curUrl; var title = "Unity Deferred Lights-å»¶è¿Ÿå…‰ç…§(ç¿»è¯‘åäº”)"; var query = new AV.Query(AV_Posts); query.equalTo("post_url", url); query.find().then(function(results) { if (results.length > 0) { curPost = results[0]; curPost.increment("visited_times"); curPost.save(); loadLikeNums(); } else { curPost = new AV_Posts(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); curPost.setACL(acl); /* End Set ACL */ curPost.set("post_title", title); curPost.set("post_url", url); curPost.set("visited_times", 1); curPost.set('like_times', 0); curPost.save(); } getVisitorIpAndJudge(); }, function(error) { console.log('Error:' + error.code + " " + error.message); }); } function showPostVisitedTimes() { var AV_Posts = AV.Object.extend("Posts"); var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(AV_Posts); query.equalTo("post_url", url); query.find().then(function(results) { if (results.length > 0) { curPost = results[0]; loadLikeNums(); } else { /*if(window.console){ console.log('å¼‚å¸¸æƒ…å†µï¼Œä¸åº”è¯¥æ²¡è®°å½•çš„'); }*/ } }, function(error) { console.log('Error:' + error.code + " " + error.message); }); } function updateIpRecord(){ var lastTime = curIpVisitRecord.updatedAt; var curTime = new Date(); var timePassed = curTime.getTime() - lastTime.getTime(); if(timePassed > 300000) { /*if(window.console){ console.log('è·ç¦»è¯¥IPä¸Šä¸€æ¬¡è®¿é—®è¯¥æ–‡ç« å·²è¶…è¿‡äº†5åˆ†é’Ÿï¼Œæ›´æ–°è®¿é—®è®°å½•ï¼Œå¹¶å¢åŠ è®¿é—®æ¬¡æ•°'); }*/ addPostVisitedTimes(); curIpVisitRecord.save(); } else { /*console.log('è¿™æ˜¯è¯¥IP 1åˆ†é’Ÿå†…é‡å¤è®¿é—®è¯¥æ–‡ç« ï¼Œä¸æ›´æ–°è®¿é—®è®°å½•ï¼Œä¸å¢åŠ è®¿é—®æ¬¡æ•°');*/ } } function addNewIpRecord(ip, post_url){ var Visitor = AV.Object.extend("visitors_record"); curIpVisitRecord = new Visitor(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); curIpVisitRecord.setACL(acl); curIpVisitRecord.set("visitor_ip", ip); curIpVisitRecord.set("post_url", post_url); curIpVisitRecord.set("like_this_post", 0); curIpVisitRecord.save(); } function loadLikeNums() { var likeTimes = curPost.get('like_times'); $("#likeNum").text(likeTimes); } function refreshLikeBtn() { var likeState = curIpVisitRecord.get('like_this_post'); if(likeState == 1){ $("#likeBtn").css("color", "red"); $("#likeBtn").attr("onclick", "likePost(-1)"); } else { $("#likeBtn").css("color", "black"); $("#likeBtn").attr("onclick", "likePost(1)"); } loadLikeNums(); } function likePost(type) { if(curPost == null || curIpVisitRecord == null) { alert('å»¶è¿Ÿ10såæ‰èƒ½ç‚¹èµ, è¯·ç¨ç­‰...'); return } var newNum; var getlikeTime = curPost.get('like_times'); if(typeof getlikeTime == "undefined" || getlikeTime == null || getlikeTime == "") { newNum = parseInt(type); }else{ newNum = parseInt(type) + parseInt(getlikeTime); } curPost.set('like_times', newNum); curPost.save().then(function(curPost){ var likeThisPost = type == -1 ? 0 : 1; curIpVisitRecord.set("like_this_post", likeThisPost); curIpVisitRecord.save().then(function(){ refreshLikeBtn(); }); },function(error){ console.log('Failed to create visitor record, with error message: ' + error.message); }); } /*å¯åŠ¨æ‰§è¡Œ*/ setTimeout(() => { delayLoadValine(); }, 10000); </script></div></div><script> /** * target _blank */ (function() { var aTags = document.querySelectorAll('article a:not([id])'); for (var i = 0; i < aTags.length; i++) { aTags[i].setAttribute('target', '_blank'); } }()); </script> <script src="/js/pageContent.js " charset="utf-8"></script><footer class="site-footer"><div class="wrapper"><p class="description"> äº‘ä¸Šçš„æ—¥å­!</p><p class="contact"> <a href="https://github.com/bitfeng" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a> <a href="mailto:damonc@126.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></p><p> æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡ï¼Œæœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡ï¼Œæœ¬æ–‡æ€»é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡</p></div></footer><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="back-to-top"> <a href="#top" data-scroll> <i class="fa fa-arrow-up" aria-hidden="true"></i> </a></div><script src=" /js/main.js " charset="utf-8"></script> <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script> <script type="text/javascript"> smoothScroll.init({ speed: 500, easing: 'easeInOutCubic', offset: 20, }); function displayWindowSize() { var w = document.documentElement.clientWidth; var h = document.documentElement.clientHeight; var rightDiv = document.querySelector('.right'); var footer = document.querySelector('.site-footer'); if(!rightDiv || !footer){ return; } if(w <= 1700){ rightDiv.style.display='none'; footer.style.display='none'; }else{ rightDiv.style.display='block'; footer.style.display = "block"; } } window.addEventListener("resize", displayWindowSize); displayWindowSize(); </script>
