<!DOCTYPE html><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="baidu-site-verification" content="code-BGVivWGmxV" /><title>Unity Shader Fog(ç¿»è¯‘åå››)</title><meta name="description" content="æœ¬ç¯‡æ‘˜è¦ï¼š åº”ç”¨é›¾åˆ°æ¸¸æˆå¯¹è±¡ åŸºäºè·ç¦»æˆ–æ·±åº¦çš„é›¾ æ”¯æŒdeferred fog"><link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon"><link rel="icon" href="/favicon.ico?" type="image/x-icon"><link rel="stylesheet" href="/css/main.css "><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href=" /css/font_8v3czwksspqlg14i.css "><link rel="canonical" href="https://www.damonc.top/2018/01/15/UNity_Shader_Fog/"><link rel="alternate" type="application/rss+xml" title="çˆ±ç©¿æ‹–é‹" href="https://www.damonc.top/feed.xml "> <script type="text/javascript" src=" /js/jquery_3_2_0.min.js " charset="utf-8"></script> <script type="text/javascript" src=" /js/Valine.min.js " charset="utf-8"></script> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "//hm.baidu.com/hm.js?8c087101d4768b7aa439cef954b30a8f"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> <script> (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-WN45VXRK'); </script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <scrip type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/js-polyfills/0.1.43/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><body class="custom-background"> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WN45VXRK" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><header id="top"><div class="wrapper"> <a href="/" class="brand">çˆ±ç©¿æ‹–é‹</a> <small>è‡ªç”±è‡ªåœ¨ğŸ©´</small> <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button><nav id="headerNav"><ul><li> <a href="/"> <i class="fa fa-home"></i>Home </a><li> <a href="/archive/"> <i class="fa fa-archive"></i>å½’æ¡£ </a><li> <a href="/category/"> <i class="fa fa-th-list"></i>åˆ†ç±» </a><li> <a href="/tag/"> <i class="fa fa-tags"></i>æ ‡ç­¾ </a></ul></nav></div></header><div class="home-right-bar"> <button class="anchor"><i class="fa fa-anchor"></i></button><div class="right"><div class="wrap"><div class="side content"><div> ç›®å½•</div><ul id="content-side" class="content-ul"><li><a href="#comments">Comments</a></ul></div></div></div></div><div class="page clearfix" post><div class="left"><h1>Unity Shader Fog(ç¿»è¯‘åå››)</h1><div class="label"><div class="label-card"> <i class="fa fa-calendar"></i>2018-01-15</div><div class="label-card"> <i class="fa fa-user"></i>catlikecoding</div><div class="label-card"></div><div class="label-card"> <span class="categories"> <i class="fa fa-th-list"></i> <a href="/category/#ç¿»è¯‘" title="Category: ç¿»è¯‘" rel="category">ç¿»è¯‘</a> </span></div><div class="label-card"> <span class="pageTag"> <i class="fa fa-tags"></i> <b href="/tag/#Shader" title="Tag: Shader" rel="tag">Shader</b>&nbsp; <b href="/tag/#Unity3d" title="Tag: Unity3d" rel="tag">Unity3d</b> </span></div></div><hr><article><ul id="markdown-toc"><li><a href="#å‰å‘æ¸²æŸ“é›¾-forward-fog" id="markdown-toc-å‰å‘æ¸²æŸ“é›¾-forward-fog">å‰å‘æ¸²æŸ“é›¾-Forward Fog</a><ul><li><a href="#æ ‡å‡†é›¾-standard-fog" id="markdown-toc-æ ‡å‡†é›¾-standard-fog">æ ‡å‡†é›¾-Standard Fog</a><li><a href="#çº¿æ€§é›¾-linear-fog" id="markdown-toc-çº¿æ€§é›¾-linear-fog">çº¿æ€§é›¾-Linear Fog</a><li><a href="#æŒ‡æ•°é›¾-exponential-fog" id="markdown-toc-æŒ‡æ•°é›¾-exponential-fog">æŒ‡æ•°é›¾-Exponential Fog</a><li><a href="#æŒ‡æ•°å¹³æ–¹é›¾-exponential-squared-fog" id="markdown-toc-æŒ‡æ•°å¹³æ–¹é›¾-exponential-squared-fog">æŒ‡æ•°å¹³æ–¹é›¾-Exponential Squared Fog</a><li><a href="#æ¸²æŸ“é›¾-adding-fog" id="markdown-toc-æ¸²æŸ“é›¾-adding-fog">æ¸²æŸ“é›¾-Adding Fog</a><li><a href="#æ·±åº¦é›¾-depth-based-fog" id="markdown-toc-æ·±åº¦é›¾-depth-based-fog">æ·±åº¦é›¾-Depth-Based Fog</a><li><a href="#è£å‰ªç©ºé—´ä¸ä¸–ç•Œç©ºé—´-clip-space-depth-vs-world-space-distance" id="markdown-toc-è£å‰ªç©ºé—´ä¸ä¸–ç•Œç©ºé—´-clip-space-depth-vs-world-space-distance">è£å‰ªç©ºé—´ä¸ä¸–ç•Œç©ºé—´-Clip-Space Depth vs World-Space Distance</a><li><a href="#disabling-fog" id="markdown-toc-disabling-fog">Disabling Fog</a><li><a href="#å¤šå…‰æº-multiple-lights" id="markdown-toc-å¤šå…‰æº-multiple-lights">å¤šå…‰æº-Multiple Lights</a></ul><li><a href="#å»¶è¿Ÿé›¾æ¸²æŸ“-deferred-fog" id="markdown-toc-å»¶è¿Ÿé›¾æ¸²æŸ“-deferred-fog">å»¶è¿Ÿé›¾æ¸²æŸ“-Deferred Fog</a><ul><li><a href="#åå¤„ç†æ•ˆæœ-image-effects" id="markdown-toc-åå¤„ç†æ•ˆæœ-image-effects">åå¤„ç†æ•ˆæœ-Image Effects</a><li><a href="#fog-shader" id="markdown-toc-fog-shader">Fog Shader</a><li><a href="#æ·±åº¦é›¾é‡‡æ ·-depth-based-fog" id="markdown-toc-æ·±åº¦é›¾é‡‡æ ·-depth-based-fog">æ·±åº¦é›¾é‡‡æ ·-Depth-Based Fog</a><li><a href="#é›¾æ··åˆ-fixing-the-fog" id="markdown-toc-é›¾æ··åˆ-fixing-the-fog">é›¾æ··åˆ-Fixing the Fog</a><li><a href="#è·ç¦»åœºé›¾-distance-based-fog" id="markdown-toc-è·ç¦»åœºé›¾-distance-based-fog">è·ç¦»åœºé›¾-Distance-Based Fog</a><li><a href="#è·ç¦»æ£€æµ‹-calculating-rays" id="markdown-toc-è·ç¦»æ£€æµ‹-calculating-rays">è·ç¦»æ£€æµ‹-Calculating Rays</a><li><a href="#è®¡ç®—è·ç¦»-deriving-distances" id="markdown-toc-è®¡ç®—è·ç¦»-deriving-distances">è®¡ç®—è·ç¦»-Deriving Distances</a><li><a href="#å¤©ç©ºç›’-fogged-skybox" id="markdown-toc-å¤©ç©ºç›’-fogged-skybox">å¤©ç©ºç›’-Fogged Skybox</a><li><a href="#no-fog" id="markdown-toc-no-fog">No Fog</a></ul></ul><p>æœ¬ç¯‡æ‘˜è¦ï¼š</p><ul><li>åº”ç”¨é›¾åˆ°æ¸¸æˆå¯¹è±¡<li>åŸºäºè·ç¦»æˆ–æ·±åº¦çš„é›¾<li>æ”¯æŒdeferred fog</ul><h2 id="å‰å‘æ¸²æŸ“é›¾-forward-fog">å‰å‘æ¸²æŸ“é›¾-Forward Fog</h2><p>åœ¨14ä¹‹å‰ï¼Œä¸€ç›´å‡å®šç€å…‰çº¿åœ¨çœŸç©ºä¸­ä¼ æ’­ï¼Œåœ¨çœŸç©ºä¸­å¯èƒ½æ˜¯ç²¾ç¡®çš„ã€‚ä½†æ˜¯å½“å…‰çº¿ç©¿è¿‡å¤§æ°”æˆ–æ°´å°±ä¸ä¸€æ ·äº†ï¼Œå…‰çº¿åœ¨å‡»ä¸­ç‰©ä½“è¡¨é¢æ—¶ä¼šå‘ç”Ÿè¢«å¸æ”¶ã€æ•£å°„å’Œåå°„ã€‚</p><p>ä¸€ä¸ªç²¾ç¡®çš„å¤§æ°”å¹²æ‰°å…‰çº¿æ¸²æŸ“å°†éœ€è¦åŠå…¶æ˜‚è´µçš„ä½“ç§¯æµ‹é‡æ–¹æ³•ï¼Œé‚£æ˜¯å¤§å¤šæ•°ç°ä»£GPUè´Ÿæ‹…ä¸èµ·çš„ã€‚ç›¸åï¼Œå‹‰å¼ºé‡‡ç”¨ä¸€äº›å¸¸é‡é›¾å‚æ•°è¿‘ä¼¼æ¨¡æ‹Ÿã€‚</p><h3 id="æ ‡å‡†é›¾-standard-fog">æ ‡å‡†é›¾-Standard Fog</h3><p>Unityå…‰ç…§è®¾ç½®åŒ…å«äº†åœºæ™¯é›¾è®¾ç½®é€‰é¡¹ï¼Œé»˜è®¤æ˜¯ä¸å¯ç”¨ã€‚å¯ç”¨åï¼Œé»˜è®¤æ˜¯ç°è‰²é›¾ã€‚Unityè‡ªå¸¦çš„é›¾åªé€‚ç”¨äºä½¿ç”¨äº†Forwardæ¸²æŸ“è·¯å¾„çš„ç‰©ä½“ã€‚è‹¥æ¿€æ´»Deferred pathï¼Œæç¤ºï¼š</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235158162-487991047.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>deferred æç¤º.</a></i></center> </font> <center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235158998-641873984.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>ä¸æ˜æ˜¾çš„é›¾.</a></i></center> </font><h3 id="çº¿æ€§é›¾-linear-fog">çº¿æ€§é›¾-Linear Fog</h3><p>å›¾2ä¸æ˜æ˜¾ï¼Œæ˜¯å› ä¸ºFog colorç°è‰²é›¾å°†æ•£å°„å’Œåå°„æ›´å¤šçš„å…‰çº¿ï¼Œå¸æ”¶è¾ƒå°‘ã€‚æŠŠFog Coloræ”¹ä¸ºçº¯é»‘è‰²è¯•è¯•</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235159582-1089337078.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235200361-31174269.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>linear fog.</a></i></center> </font><p>é›¾çš„æµ“åº¦æ˜¯éšè§†è·çº¿æ€§å¢é•¿çš„ï¼Œåœ¨è§†è·å¼€å¤´æ­£å¸¸æ˜¾ç¤ºï¼Œè¶…è¿‡è¿™ä¸ªè·ç¦»å°±åªæœ‰é›¾çš„é¢œè‰²å¯è§ã€‚</p><p><strong>çº¿æ€§é›¾å…¬å¼</strong>ï¼š \(f = { {E-c} \over {E-s} }\)</p><p>c æ˜¯é›¾åæ ‡ï¼›<br /> s æ˜¯è§†è·èµ·å§‹è·ç¦»ï¼›<br /> E æ˜¯è§†è·ç»ˆæ­¢è·ç¦»ï¼›<br /> få€¼ è¢«é™å®šåœ¨[0, 1]èŒƒå›´ï¼Œè¢«ç”¨åœ¨é›¾å’Œç‰©ä½“ç€è‰²ä¹‹é—´æ’å€¼ã€‚</p><p>æœ€ç»ˆè®¡ç®—åœ¨fragment colorç€è‰²åˆ°ç‰©ä½“å¯¹è±¡ä¸Šï¼Œé›¾ä¸ä¼šå½±å“åˆ°skybox</p><h3 id="æŒ‡æ•°é›¾-exponential-fog">æŒ‡æ•°é›¾-Exponential Fog</h3><p>æ›´æ¥è¿‘çœŸå®æ„Ÿçš„é›¾</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235201459-832769226.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235203426-304224456.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æŒ‡æ•°é›¾.</a></i></center> </font><p><strong>æŒ‡æ•°é›¾å…¬å¼</strong>ï¼š \(f = {1 \over {2^{cd}}}\)</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235204598-417023262.png" width="150" alt="loading failed, need vpn." /></center><p>d æ˜¯fogçš„å¯†åº¦å› å­ï¼›<br /> c æ˜¯è·ç¦»å› å­ã€‚</p><h3 id="æŒ‡æ•°å¹³æ–¹é›¾-exponential-squared-fog">æŒ‡æ•°å¹³æ–¹é›¾-Exponential Squared Fog</h3><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235205400-412540608.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235206302-247343724.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æŒ‡æ•°å¹³æ–¹é›¾.</a></i></center> </font><p><strong>æŒ‡æ•°å¹³æ–¹é›¾å…¬å¼</strong>ï¼š \(f = {1 \over {2^{(cd)^2}}}\)</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235207307-166956062.png" width="150" alt="loading failed, need vpn." /></center><h3 id="æ¸²æŸ“é›¾-adding-fog">æ¸²æŸ“é›¾-Adding Fog</h3><p>å¢åŠ Fogåˆ°è‡ªå·±çš„shaderä¸­ï¼Œå¢åŠ Fogéœ€è¦ä½¿ç”¨å†…ç½®å…³é”®å­—ï¼š<em>multi_compile_fog_æŒ‡ä»¤ã€‚è¯¥æŒ‡ä»¤çš„å˜ä½“ä¼šé¢å¤–å¢åŠ ï¼š_FOG_LINEARã€FOG_EXPã€FOG_EXP2</em></p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma multi_compile_fog
</span></code></pre></div></div><p>æ–°å¢ApplyFog()å‡½æ•°ï¼Œç”¨äºåœ¨Fragmentè®¡ç®—æœ€ç»ˆç€è‰²ï¼šè·å–å½“å‰é¢œè‰²å’Œæ’å€¼æ•°æ®ä½œä¸ºå‚æ•°ï¼Œè¿”å›æœ€ç»ˆé¢œè‰²ã€‚</p><p>è®¡ç®—æ­¥éª¤ï¼š<br /> ä»»ä½•é›¾å…¬å¼éƒ½æ˜¯åŸºäºè§†è·çš„ï¼Œé¦–å…ˆè®¡ç®—å‡ºè§†è·å€¼å¤‡ç”¨ï¼›<br /> ç„¶åä½¿ç”¨UnityCG.cgincå®_UNITY_CALC_FOG_FACTOR_RAW_æ ¹æ®å…·ä½“é›¾å…¬å¼è®¡ç®—å‡ºé›¾å› å­ã€‚<br /> æœ€åæ ¹æ®é›¾å› å­ï¼Œåœ¨fog_colorå’Œå½“å‰colorå–æ’å€¼è¿”å›ã€‚</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float4</span> <span class="nf">ApplyFOG</span><span class="p">(</span><span class="n">float4</span> <span class="n">color</span><span class="p">,</span> <span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">viewDistance</span> <span class="p">=</span> <span class="nf">length</span><span class="p">(</span><span class="n">_WorldSpaceCameraPos</span> <span class="p">-</span> <span class="n">i</span><span class="p">.</span><span class="n">worldPos</span><span class="p">);</span>
    <span class="nf">UNITY_CALC_FOG_FACTOR_RAW</span><span class="p">(</span><span class="n">viewDistance</span><span class="p">);</span>
    <span class="k">return</span> <span class="nf">learp</span><span class="p">(</span><span class="n">unity_FogColor</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">unityFogFactor</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//å®UNITY_CALC_FOG_FACTOR_RAW</span>
<span class="cp">#if defined(FOG_LINEAR)
</span>    <span class="c1">// factor = (end-z)/(end-start) = z \* (-1/(end-start)) + (end/(end-start))</span>
    <span class="err">#</span><span class="n">define</span> <span class="nf">UNITY_CALC_FOG_FACTOR_RAW</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="kt">float</span> <span class="n">unityFogFactor</span> <span class="p">=</span> <span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="err">\</span><span class="p">*</span> <span class="n">unity_FogParams</span><span class="p">.</span><span class="n">z</span> <span class="p">+</span> <span class="n">unity_FogParams</span><span class="p">.</span><span class="n">w</span>
<span class="cp">#elif defined(FOG_EXP)
</span>    <span class="c1">// factor = exp(-density\*z)</span>
    <span class="err">#</span><span class="n">define</span> <span class="nf">UNITY_CALC_FOG_FACTOR_RAW</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="kt">float</span> <span class="n">unityFogFactor</span> <span class="p">=</span> <span class="n">unity_FogParams</span><span class="p">.</span><span class="n">y</span> <span class="err">\</span><span class="p">*</span> <span class="p">(</span><span class="n">coord</span><span class="p">);</span> <span class="n">unityFogFactor</span> <span class="p">=</span> <span class="nf">exp2</span><span class="p">(-</span><span class="n">unityFogFactor</span><span class="p">)</span>
<span class="cp">#elif defined(FOG_EXP2)
</span>    <span class="c1">// factor = exp(-(density\*z)^2)</span>
    <span class="err">#</span><span class="n">define</span> <span class="nf">UNITY_CALC_FOG_FACTOR_RAW</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="kt">float</span> <span class="n">unityFogFactor</span> <span class="p">=</span> <span class="n">unity_FogParams</span><span class="p">.</span><span class="n">x</span> <span class="err">\</span><span class="p">*</span> <span class="p">(</span><span class="n">coord</span><span class="p">);</span> <span class="n">unityFogFactor</span> <span class="p">=</span> <span class="nf">exp2</span><span class="p">(-</span><span class="n">unityFogFactor</span><span class="err">\</span><span class="p">*</span><span class="n">unityFogFactor</span><span class="p">)</span>
<span class="cp">#else
</span>    <span class="err">#</span><span class="n">define</span> <span class="nf">UNITY_CALC_FOG_FACTOR_RAW</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="kt">float</span> <span class="n">unityFogFactor</span> <span class="p">=</span> <span class="m">0.0</span>
<span class="cp">#endif
</span>
<span class="c1">//å®UNITY_CALC_FOG_FACTOR</span>
<span class="cp">#define UNITY_CALC_FOG_FACTOR(coord) UNITY_CALC_FOG_FACTOR_RAW(UNITY_Z_0_FAR_FROM_CLIPSPACE(coord))
</span>
<span class="c1">//unity_FogParams å®šä¹‰åœ¨ShaderVariables</span>
<span class="c1">// x = density / sqrt(ln(2)), useful for Exp2 mode</span>
<span class="c1">// y = density / ln(2), useful for Exp mode</span>
<span class="c1">// z = -1/(end-start), useful for Linear mode</span>
<span class="c1">// w = end/(end-start), useful for Linear mode</span>
<span class="n">float4</span> <span class="n">unity_FogParams</span><span class="p">;</span>
</code></pre></div></div><p>æ³¨æ„é›¾å› å­å¿…é¡»é™å®šåœ¨[0,1]</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="nf">learp</span><span class="p">(</span><span class="n">unity_FogColor</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="nf">saturate</span><span class="p">(</span><span class="n">unityFogFactor</span><span class="p">));</span>
</code></pre></div></div><p>åŒæ—¶é›¾ä¹Ÿä¸èƒ½å½±å“Alphaå€¼</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="p">=</span> <span class="nf">learp</span><span class="p">(</span><span class="n">unity_FogColor</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="nf">saturate</span><span class="p">(</span><span class="n">unityFogFactor</span><span class="p">));</span>
</code></pre></div></div><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235208597-1924410952.png" width="350" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>linearï¼šstandard vs. mine.</a></i></center> </font> <center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235209833-525170101.png" width="350" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>expï¼šstandard vs. mine.</a></i></center> </font> <center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235210707-599317063.png" width="350" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>exp2ï¼šstandard vs. mine.</a></i></center> </font><h3 id="æ·±åº¦é›¾-depth-based-fog">æ·±åº¦é›¾-Depth-Based Fog</h3><p>å¢åŠ æ·±åº¦é›¾æ”¯æŒã€‚ä¸Standard Shaderä¸åŒçš„åŸå› æ˜¯è®¡ç®—fogåæ ‡æ–¹æ³•ä¸åŒã€‚è™½ç„¶ä½¿ç”¨world-spaceè§†å›¾è·ç¦»æ˜¯æœ‰æ„ä¹‰çš„ï¼Œä½†æ ‡å‡†ç€è‰²å™¨ä½¿ç”¨è£å‰ªç©ºé—´æ·±åº¦å€¼ã€‚å› æ­¤è§†è§’ä¸å½±å“é›¾åæ ‡ã€‚æ­¤å¤–ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè·ç¦»æ˜¯å—ç›¸æœºçš„è¿‘è£åˆ‡é¢è·ç¦»çš„å½±å“ï¼Œè¿™å°†æŠŠé›¾æ¨å¼€ä¸€ç‚¹ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235211359-387262789.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æ·±åº¦ (ä¸‰è§’) vs. è·ç¦»(å›­).</a></i></center> </font><p><strong>åŸºäºæ·±åº¦ä»£æ›¿è·ç¦»çš„ä¼˜ç‚¹</strong>æ˜¯ï¼šä¸å¿…è®¡ç®—å¹³æ–¹æ ¹ï¼Œè®¡ç®—é€Ÿåº¦æ›´å¿«ï¼Œé€‚ç”¨äºéçœŸå®æ¸²æŸ“ã€‚<strong>ç¼ºç‚¹</strong>æ˜¯ï¼šå¿½ç•¥è§†è§’ï¼Œä¹Ÿå³ç›¸æœºä»¥åŸç‚¹æ—‹è½¬ä¼šå½±å“é›¾å¯†åº¦ï¼Œå› ä¸ºæ—‹è½¬æ—¶å¯†åº¦ä¼šæ”¹å˜ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200516235212013-881187042.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>çº¢åˆ°è“æ—‹è½¬ï¼Œæ·±åº¦æ”¹å˜å¯†åº¦.</a></i></center> </font><p>æ”¯æŒdepth-basedæ·±åº¦é›¾ ï¼Œå¿…é¡»æŠŠclip-passè£å‰ªç©ºé—´æ·±åº¦å€¼ä¼ é€’åˆ°ç‰‡å…ƒå‡½æ•°ã€‚å®šä¹‰ä¸€ä¸ªå…³é”®å­—ï¼šFOG_DEPTH.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if defined(FOG_LINEAR) || defined(FOG_EXP) || defined(FOG_EXP2)
</span>    <span class="err">#</span><span class="n">define</span> <span class="n">FOG_DEPTH</span> <span class="m">1</span>
<span class="cp">#endif
</span></code></pre></div></div><p>ç”±äºéœ€è¦å¤šå­˜å‚¨ä¸€ä¸ªzå€¼ï¼Œä½†åˆä¸èƒ½æ–°å¢ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡ï¼Œå°±æŠŠworldPosæ”¹ä¸ºfloat4</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if defined(FOG_DEPTH)
</span>    <span class="n">float4</span> <span class="n">worldPos</span> <span class="p">:</span> <span class="n">TEXCOORD4</span><span class="p">;</span>
<span class="cp">#else
</span>    <span class="n">float3</span> <span class="n">worldPos</span> <span class="p">:</span> <span class="n">TEXCOORD4</span><span class="p">;</span>
<span class="cp">#endif
</span></code></pre></div></div><p>ç„¶åè¦æ›¿æ¢i.worldPosçš„æ‰€æœ‰ç”¨æ³•ä¸ºi.worldPos.xyzã€‚å°†å‰ªè´´ç©ºé—´æ·±åº¦å€¼èµ‹ç»™i.worldPos.wï¼Œåœ¨fragmentä¼ é€’ç»™viewDistanceã€‚å®ƒåªæ˜¯é½æ¬¡å‰ªè´´ç©ºé—´ä½ç½®çš„Zåæ ‡ï¼Œæ‰€ä»¥åœ¨å®ƒè¢«è½¬æ¢ä¸º0-1èŒƒå›´å†…çš„å€¼ä¹‹å‰ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004339507-1542612657.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>é”™è¯¯.</a></i></center> </font> <center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004340429-1853847721.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æ­£ç¡®.</a></i></center> </font><p>ä¸æ­£ç¡®çš„åŸå› ï¼šå¯èƒ½ä¼šæœ‰åå‘è£å‰ªç©ºé—´Zçš„æƒ…å†µï¼Œéœ€è¦è½¬æ¢ã€‚</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if defined(UNITY_REVERSED_Z)
</span>    <span class="c1">//D3d with reversed Z =&gt;</span>
    <span class="c1">//z clip range is [near, 0] -&gt; remapping to [0, far]</span>
    <span class="c1">//max is required to protect ourselves from near plane not being</span>
    <span class="c1">//correct/meaningfull in case of oblique matrices.</span>
    <span class="err">#</span><span class="n">define</span> <span class="nf">UNITY_Z_0_FAR_FROM_CLIPSPACE</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="err">\\</span>
        <span class="nf">max</span><span class="p">(((</span><span class="m">1.0</span><span class="p">-(</span><span class="n">coord</span><span class="p">)/</span><span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="err">\</span><span class="p">*</span><span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="m">0</span><span class="p">)</span>
<span class="cp">#elif UNITY_UV_STARTS_AT_TOP
</span>    <span class="c1">//D3d without reversed z =&gt; z clip range is [0, far] -&gt; nothing to do</span>
    <span class="err">#</span><span class="n">define</span> <span class="nf">UNITY_Z_0_FAR_FROM_CLIPSPACE</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="p">(</span><span class="n">coord</span><span class="p">)</span>
<span class="cp">#else
</span>    <span class="c1">//Opengl =&gt; z clip range is [-near, far] -&gt; should remap in theory</span>
    <span class="c1">//but dont do it in practice to save some perf (range is close enought)</span>
    <span class="err">#</span><span class="n">define</span> <span class="nf">UNITY_Z_0_FAR_FROM_CLIPSPACE</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="p">(</span><span class="n">coord</span><span class="p">)</span>
<span class="cp">#endif
</span>
<span class="cp">#define UNITY_CALC_FOG_FACTOR(coord) \\
</span>    <span class="nf">UNITY_CALC_FOG_FACTOR_RAW</span><span class="p">(</span><span class="nf">UNITY_Z_0_FAR_FROM_CLIPSPACE</span><span class="p">(</span><span class="n">coord</span><span class="p">))</span>
</code></pre></div></div><h3 id="è£å‰ªç©ºé—´ä¸ä¸–ç•Œç©ºé—´-clip-space-depth-vs-world-space-distance">è£å‰ªç©ºé—´ä¸ä¸–ç•Œç©ºé—´-Clip-Space Depth vs World-Space Distance</h3><p>å¢åŠ åŒæ”¯æŒï¼FOG_DISTANCE å’Œ FOG_DEPTHã€‚ç”¨å®ä»£æ›¿featureæŒ‡ä»¤ï¼Œä»¿ç…§_BINORMAL_PER_FRAGMENT_å®šä¹‰_FOG_DISTANCEï¼Œ_é»˜è®¤å°±æ˜¯å®ƒã€‚</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CGINCLUDE</span>
    <span class="err">#</span><span class="n">define</span> <span class="n">BINORMAL_PER_FRAGMENT</span>
    <span class="err">#</span><span class="n">define</span> <span class="n">FOG_DISTANCE</span>
<span class="n">ENDCG</span>
</code></pre></div></div><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//åœ¨shaderä¸­ï¼Œè¦åˆ‡æ¢åˆ°åŸºäºè·ç¦»çš„é›¾ï¼Œå¦‚æœFOG_DISTANCEå·²ç»è¢«å®šä¹‰,æˆ‘ä»¬è¦åšçš„å°±æ˜¯å»æ‰FOG_DEPTHçš„å®šä¹‰ã€‚</span>
<span class="cp">#if defined(FOG_LINEAR) || defined(FOG_EXP) || defined(FOG_EXP2)
</span>    <span class="err">#</span><span class="k">if</span> <span class="p">!</span><span class="nf">defined</span><span class="p">(</span><span class="n">FOG_DISTANCE</span><span class="p">)</span>
        <span class="err">#</span><span class="n">define</span> <span class="n">FOG_DEPTH</span> <span class="m">1</span>
    <span class="err">#</span><span class="n">endif</span>
<span class="cp">#endif
</span></code></pre></div></div><h3 id="disabling-fog">Disabling Fog</h3><p>å¢åŠ æ”¯æŒç¦ç”¨ã€‚åªåœ¨éœ€è¦æ—¶ä½¿ç”¨é›¾ï¼Œå¢åŠ FOG_ONå®</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if defined(FOG_LINEAR) || defined(FOG_EXP) || defined(FOG_EXP2)
</span>    <span class="err">#</span><span class="k">if</span> <span class="p">!</span><span class="nf">defined</span><span class="p">(</span><span class="n">FOG_DISTANCE</span><span class="p">)</span>
        <span class="err">#</span><span class="n">define</span> <span class="n">FOG_DEPTH</span> <span class="m">1</span>
    <span class="err">#</span><span class="n">endif</span>
    <span class="err">#</span><span class="n">define</span> <span class="n">FOG_ON</span> <span class="m">1</span>
<span class="cp">#endif
</span>
<span class="n">float4</span> <span class="nf">ApplyFog</span> <span class="p">(</span><span class="n">float4</span> <span class="n">color</span><span class="p">,</span> <span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">#</span><span class="k">if</span> <span class="n">FOG_ON</span>
        <span class="kt">float</span> <span class="n">viewDistance</span> <span class="p">=</span> <span class="nf">length</span><span class="p">(</span><span class="n">_WorldSpaceCameraPos</span> <span class="p">-</span> <span class="n">i</span><span class="p">.</span><span class="n">worldPos</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
        <span class="err">#</span><span class="k">if</span> <span class="n">FOG_DEPTH</span>
            <span class="n">viewDistance</span> <span class="p">=</span> <span class="nf">UNITY_Z_0_FAR_FROM_CLIPSPACE</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">worldPos</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
        <span class="err">#</span><span class="n">endif</span>
        <span class="nf">UNITY_CALC_FOG_FACTOR_RAW</span><span class="p">(</span><span class="n">viewDistance</span><span class="p">);</span>
        <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="p">=</span> <span class="nf">lerp</span><span class="p">(</span><span class="n">unity_FogColor</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="nf">saturate</span><span class="p">(</span><span class="n">unityFogFactor</span><span class="p">));</span>
    <span class="err">#</span><span class="n">endif</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="å¤šå…‰æº-multiple-lights">å¤šå…‰æº-Multiple Lights</h3><p>å¢åŠ æ”¯æŒå¤šå…‰æºã€‚ä½†æ˜¯å˜å¾—æ›´äº®äº†ï¼Œè¿™æ˜¯å› ä¸ºæ¯ä¸ªå…‰çš„é¢œè‰²éƒ½å åŠ åˆ°äº†é›¾è‰²ä¹‹ä¸Šï¼Œæ‰€ä»¥é»‘è‰²é›¾æ˜¯æ²¡é—®é¢˜ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004341631-1514085003.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>å¤ªäº®.</a></i></center> </font><p>è§£å†³åŠæ³•å°±æ˜¯ï¼šå¯¹additive passä½¿ç”¨é»‘è‰²é›¾ï¼Œè¿™æ ·å°±ä¼šæ·¡åŒ–ä¸€éƒ¨åˆ†é¢œè‰²ã€‚</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">fogColor</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="cp">#if defined(FORWARD_BASE_PASS)
</span>    <span class="n">fogColor</span> <span class="p">=</span> <span class="n">unity_FogColor</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
<span class="cp">#endif
</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="p">=</span> <span class="nf">lerp</span><span class="p">(</span><span class="n">fogColor</span><span class="p">,</span> <span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="nf">saturate</span><span class="p">(</span><span class="n">unityFogFactor</span><span class="p">));</span>
</code></pre></div></div><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004342819-161700675.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>å¤ªäº®.</a></i></center> </font><h2 id="å»¶è¿Ÿé›¾æ¸²æŸ“-deferred-fog">å»¶è¿Ÿé›¾æ¸²æŸ“-Deferred Fog</h2><p>deferredè·¯å¾„æ²¡æœ‰é›¾ï¼Œè¿™æ˜¯å› ä¸ºæ‰€æœ‰çš„å…‰ç…§è®¡ç®—å®Œæˆåï¼Œæ‰ä¼šè®¡ç®—é›¾ã€‚ä¸ºäº†èƒ½å¤Ÿåœ¨deferredæ¸²æŸ“é›¾ï¼Œè§2.1</p><h3 id="åå¤„ç†æ•ˆæœ-image-effects">åå¤„ç†æ•ˆæœ-Image Effects</h3><p>è¦å¢åŠ é›¾æ¸²æŸ“ï¼Œéœ€è¦ç­‰æ‰€æœ‰å…‰ç…§è®¡ç®—ç›´åˆ°å®ƒä»¬å®Œæˆåï¼Œåœ¨å…¶ä»–passå†æ¬¡æ¸²æŸ“é›¾ã€‚è¯¥passä¸åœ¨shaderå†…éƒ¨ï¼Œå±äºå±å¹•ImageEffects(åå¤„ç†)é˜¶æ®µã€‚</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">ExecuteInEditMode</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">DeferredFogRender</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnRenderImage</span><span class="p">(</span><span class="n">RenderTexture</span> <span class="n">source</span><span class="p">,</span> <span class="n">RenderTexture</span> <span class="n">destination</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>è¿™æ˜¯å¢åŠ äº†ä¸€ä¸ªå…¨å±åå¤„ç†passã€‚å¦‚æœæœ‰å¤šä¸ªè¿™æ ·å®ç°äº†OnRenderImageè„šæœ¬ï¼Œå°†ä¼šæŒ‰é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚</p><p><em>OnRenderImage(RenderTexture source, RenderTexture destination)</em> ä¸¤ä¸ªå‚æ•°ï¼š<br /> source æ˜¯å·²è®¡ç®—å¥½æœ€ç»ˆé¢œè‰²<br /> destination è¾“å‡ºé›¾ã€‚è‹¥ä¸ºç©ºç›´æ¥è¿›å…¥å¸§ç¼“å†²åŒº</p><p>æ–¹æ³•å†…éƒ¨å¿…é¡»è°ƒç”¨Graphics.Blitå‡½æ•°ï¼Œå®ƒä¼šç”»ä¸€ä¸ªå…¨å±é¢ç‰‡è¾“å‡ºåˆ°Destination</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">void</span> <span class="nf">OnRenderImage</span> <span class="p">(</span><span class="n">RenderTexture</span> <span class="n">source</span><span class="p">,</span> <span class="n">RenderTexture</span> <span class="n">destination</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Graphics</span><span class="p">.</span><span class="nf">Blit</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004343465-563203657.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>åå¤„ç†pass.</a></i></center> </font><h3 id="fog-shader">Fog Shader</h3><p>2.1åªæ˜¯åšäº†ç®€å•çš„æ‹·è´ï¼Œæ²¡ä»€ä¹ˆç”¨ã€‚å¿…é¡»è¦æ–°å»ºä¸€ä¸ªå¤„ç†sourceTextureçš„shaderæ¥æ¸²æŸ“é›¾ã€‚åŸºæœ¬æ¡†æ¶ï¼š</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Custom/MyDeferredFog"</span>
<span class="p">{</span>
    <span class="n">Properties</span>
    <span class="p">{</span>
        <span class="nf">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">}</span>
    <span class="n">SubShader</span>
    <span class="p">{</span>
        <span class="c1">// No culling or depth</span>
        <span class="n">Cull</span> <span class="n">Off</span>
        <span class="n">ZWrite</span> <span class="n">Off</span>
        <span class="n">ZTest</span> <span class="n">Always</span>
        <span class="n">Pass</span>
        <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>ç„¶åç”¨åå¤„ç†è„šæœ¬éœ€è¦å¼•ç”¨è¯¥Shader</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Pass</span>
<span class="p">{</span>
    <span class="n">CGPROGRAM</span>
    <span class="err">#</span><span class="n">pragma</span> <span class="n">vertex</span>   <span class="n">VertexProgram</span>
    <span class="err">#</span><span class="n">pragma</span> <span class="n">fragment</span> <span class="n">FragmentProgram</span>
    <span class="err">#</span><span class="n">pragma</span> <span class="n">multi_compile_fog</span>
    <span class="err">#</span><span class="n">include</span> <span class="s">"UnityCG.cginc"</span>
    <span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">modelData</span>
    <span class="p">{</span>
        <span class="n">float4</span> <span class="n">vertex</span> <span class="p">:</span> <span class="n">POSITION</span><span class="p">;</span>
        <span class="n">float2</span> <span class="n">uv</span>      <span class="p">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">struct</span> <span class="nc">Interpolarters</span>
    <span class="p">{</span>
        <span class="n">float4</span> <span class="n">position</span> <span class="p">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
        <span class="n">float2</span> <span class="n">uv</span>        <span class="p">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">Interpolarters</span> <span class="nf">VertexProgram</span><span class="p">(</span><span class="n">modelData</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Interpolarters</span> <span class="n">i</span><span class="p">;</span>
        <span class="n">i</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="nf">UnityObjectToClipPos</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
        <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="p">=</span> <span class="n">m</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">float4</span> <span class="nf">FragmentProgram</span><span class="p">(</span><span class="n">Interpolarters</span> <span class="n">i</span><span class="p">)</span> <span class="p">:</span><span class="n">SV_Target</span>
    <span class="p">{</span>
        <span class="n">float3</span> <span class="n">sourceColor</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
        <span class="k">return</span> <span class="nf">float4</span><span class="p">(</span><span class="n">sourceColor</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">ENDCG</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="æ·±åº¦é›¾é‡‡æ ·-depth-based-fog">æ·±åº¦é›¾é‡‡æ ·-Depth-Based Fog</h3><p>å¢åŠ æ·±åº¦é›¾ã€‚Unityè‡ªå¸¦æ·±åº¦bufferå˜é‡__CameraDepthTexture_, ç„¶åä½¿ç”¨æŒ‡ä»¤_SAMPLE_DEPTH_TEXTURE_é‡‡æ ·æ·±åº¦ï¼š</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">UNITY_DECLARE_DEPTH_TEXTURE</span><span class="p">(</span><span class="n">_CameraDepthTexture</span><span class="p">);</span>

<span class="n">float4</span> <span class="nf">FragmentProgram</span><span class="p">(</span><span class="n">Interpolarters</span> <span class="n">i</span><span class="p">)</span> <span class="p">:</span><span class="n">SV_Target</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">depth</span> <span class="p">=</span> <span class="nf">SAMPLE_DEPTHE_TEXTURE</span><span class="p">(</span><span class="n">_CameraDepthTexture</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
    <span class="n">float3</span> <span class="n">sourceColor</span>  <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
    <span class="k">return</span> <span class="nf">float4</span><span class="p">(</span><span class="n">sourceColor</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>ï¼é¦–å…ˆã€‚å¯ä»¥ä½¿ç”¨åœ¨UnityCGä¸­å®šä¹‰çš„Linear01Depthå‡½æ•°å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªçº¿æ€§èŒƒå›´ã€‚è¿™æ˜¯å› ä¸ºä»æ·±åº¦ç¼“å†²åŒºå¾—åˆ°åŸå§‹æ•°æ®åï¼Œéœ€è¦ä»é½æ¬¡åæ ‡è½¬æ¢ä¸º[0,1]èŒƒå›´çš„clip-spaceåæ ‡ã€‚æˆ‘ä»¬å¿…é¡»è½¬æ¢è¿™ä¸ªå€¼ï¼Œä½¿å®ƒæˆä¸ºä¸–ç•Œç©ºé—´ä¸­çš„ä¸€ä¸ªçº¿æ€§æ·±åº¦å€¼ã€‚</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">depth</span> <span class="p">=</span> <span class="nf">SAMPLE_DEPTH_TEXTURE</span><span class="p">(</span><span class="n">_CameraDepthTexture</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
<span class="n">depth</span> <span class="p">=</span> <span class="nf">Linear01Depth</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
</code></pre></div></div><p>Linear01Depthå†…éƒ¨å®ç°ï¼š</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Z buffer to linear 0..1 depth</span>
<span class="n">inline</span> <span class="kt">float</span> <span class="nf">Linear01Depth</span><span class="p">(</span> <span class="kt">float</span> <span class="n">z</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="m">1.0</span> <span class="p">/</span> <span class="p">(</span><span class="n">_ZBufferParams</span><span class="p">.</span><span class="n">x</span> <span class="err">\</span><span class="p">*</span> <span class="n">z</span> <span class="p">+</span> <span class="n">_ZBufferParams</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Values used to linearize the Z buffer</span>
<span class="c1">// (http://www.humus.name/temp/Linearize%20depth.txt)</span>
<span class="c1">// x = 1-far/near</span>
<span class="c1">// y = far/near</span>
<span class="c1">// z = x/far</span>
<span class="c1">// w = y/far</span>
<span class="n">float4</span> <span class="n">_ZBufferParams</span><span class="p">;</span>
</code></pre></div></div><p>ï¼ç„¶åã€‚éœ€è¦ä½¿ç”¨far_clipå¹³é¢è·ç¦»ç¼©æ”¾è¯¥depthå€¼ï¼Œå¾—åˆ°çœŸå®çš„æ·±åº¦è§†è·ã€‚clip_spaceè£å‰ªç©ºé—´å¯é€šè¿‡float4 <em>ProjectionParamså˜é‡è·å¾—, å®šä¹‰åœ¨_UnityShaderVariables.cgincä¸­</em>ã€‚å…¶ä¸­Zåˆ†é‡å°±æ˜¯è¿œå¹³é¢far_clipè·ç¦»ã€‚ã€‚</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">depth</span> <span class="p">=</span> <span class="nf">Linear01Depth</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">distance</span> <span class="p">=</span> <span class="n">depth</span> <span class="err">\</span><span class="p">*</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
</code></pre></div></div><p>ï¼æœ€åï¼Œè®¡ç®—å®é™…çš„fogã€‚</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">viewDistance</span> <span class="p">=</span> <span class="n">depth</span> <span class="err">\</span><span class="p">*</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="nf">UNITY_CALC_FOG_FACTOR_RAW</span><span class="p">(</span><span class="n">viewDistance</span><span class="p">);</span>
<span class="n">unityFogFactor</span> <span class="p">=</span> <span class="nf">saturate</span><span class="p">(</span><span class="n">unityFogFactor</span><span class="p">);</span>
<span class="n">float3</span> <span class="n">sourceColor</span>  <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">color</span> <span class="p">=</span> <span class="nf">lerp</span><span class="p">(</span><span class="n">unity_FogColor</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">sourceColor</span><span class="p">,</span> <span class="n">unityFogFactor</span><span class="p">);</span>
<span class="k">return</span> <span class="nf">float4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</code></pre></div></div><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004344659-491057751.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>ä¸å¤ªæ˜æ˜¾çš„é›¾.</a></i></center> </font><h3 id="é›¾æ··åˆ-fixing-the-fog">é›¾æ··åˆ-Fixing the Fog</h3><p>å¯¹æ¯”å›¾15ï¼Œå°±åƒæŠŠé›¾è’™åœ¨äº†ç‰©ä½“ä¸Šæ–¹ã€‚è§£å†³åŠæ³•å°±æ˜¯åœ¨ç»˜åˆ¶ç‰©ä½“ä¹‹å‰ï¼Œç»˜åˆ¶é›¾ã€‚ä½¿ç”¨<code class="language-plaintext highlighter-rouge">_ImageEffectOpaque_å±æ€§ç»˜åˆ¶</code></p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">ImageEffectOpaque</span><span class="p">]</span>
<span class="k">void</span> <span class="nf">OnRenderImage</span> <span class="p">(</span><span class="n">RenderTexture</span> <span class="n">source</span><span class="p">,</span> <span class="n">RenderTexture</span> <span class="n">destination</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Graphics</span><span class="p">.</span><span class="nf">Blit</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">fogMate</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004345386-585512243.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004346464-2132954797.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>ä¸å¤ªæ˜æ˜¾çš„é›¾.</a></i></center> </font><p>å¤„ç†è¿‘å¹³é¢ï¼ˆéç²¾ç¡®å¤„ç†ï¼‰ï¼Œnear planeå­˜å‚¨åœ¨Yå€¼ä¸­</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">viewDistance</span> <span class="p">=</span> <span class="n">depth</span> <span class="err">\</span><span class="p">*</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span> <span class="p">-</span><span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</code></pre></div></div><h3 id="è·ç¦»åœºé›¾-distance-based-fog">è·ç¦»åœºé›¾-Distance-Based Fog</h3><p>deferredç¯å…‰çš„ç€è‰²ï¼Œä»depth-bufferä¸­é‡å»ºä¸–ç•Œç©ºé—´ä½ç½®ï¼Œä»¥ä¾¿è®¡ç®—ç¯å…‰ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿™æ ·ä»¿ç…§è¿™æ ·è®¡ç®—é›¾ã€‚</p><p>é€è§†ç›¸æœºçš„clip-spaceç©ºé—´å®šä¹‰äº†ä¸€ä¸ªæ¢¯å½¢åŒºåŸŸï¼Œå¦‚æœå¿½ç•¥near-planeå°±å¾—åˆ°çš„æ˜¯ä¸€ä¸ªä»¥ç›¸æœºworld-posä¸ºé¡¶ç‚¹çš„ä¸‰è§’å½¢åŒºåŸŸã€‚å®ƒçš„é«˜æ˜¯far-plaenè·ç¦»ï¼Œé‚£ä¹ˆçº¿æ€§åŒ–åçš„depthèŒƒå›´ï¼šé¡¶ç‚¹ä¸º0ï¼Œåº•è¾¹ä¸º1ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004347033-483399479.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004347679-1381640131.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>é‡‘å­—å¡”åŒºåŸŸ.</a></i></center> </font><p>å¯¹äºæ¸²æŸ“çš„åå¤„ç†å›¾å½¢Imageçš„æ¯ä¸ªåƒç´ ï¼Œéƒ½èƒ½é€šè¿‡ä»é¡¶ç‚¹åˆ°åº•è¾¹å‘å°„ä¸€æ¡å°„çº¿(ä»å±å¹•å°„å‘3Dç©ºé—´)ï¼Œæ£€æµ‹æ˜¯å¦å‡»ä¸­ä»»ä½•ç‰©ä½“ï¼Œå‡»ä¸­æ¸²æŸ“ï¼Œæœªå‡»ä¸­ä¸æ¸²æŸ“ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004348280-181627301.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>Imageæ¯ä¸ªåƒç´ å‘å°„ä¸€æ¡å°„çº¿.</a></i></center> </font><p>è‹¥å‡»ä¸­æŸä¸ªç‰©ä½“ï¼Œé‚£ä¹ˆå¯¹åº”åƒç´ çš„æ·±åº¦å°±è¦å°äº1. å¦‚æœï¼Œè¯¥å°„çº¿åœ¨åŠé“å‡»ä¸­äº†ç‰©ä½“ï¼Œå°„çº¿å¯¹åº”çš„åƒç´ æ·±åº¦å€¼å°±æ˜¯1/2.è¿™å°±æ„å‘³ç€ $å°„çº¿å¯¹åº”çš„Zå€¼ ={å°„çº¿å‡»ä¸­ç‰©ä½“æ—¶çš„é•¿åº¦\overå°„çº¿æ€»é•¿åº¦}$ã€‚èŒƒå›´[0, 1]ã€‚åˆç”±äºå°„çº¿çš„æ–¹å‘éƒ½æ˜¯ä¸€è‡´çš„ï¼ŒXå’ŒYåæ ‡ä¹Ÿåº”è¯¥å‡åŠã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004348844-1867477460.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>å°„çº¿çš„ç¼©æ”¾.</a></i></center> </font><p>ä¸€æ—¦å¾—åˆ°è¯¥å°„çº¿ï¼Œå°±èƒ½ä»ç›¸æœºçš„ä½ç½®å‡ºå‘ï¼Œå¯»æ‰¾å¯èƒ½ä¼šè¢«æ¸²æŸ“çš„ç‰©ä½“è¡¨é¢çš„ä¸–ç•Œåæ ‡(è‹¥å‡»ä¸­)ã€‚åŒæ—¶ï¼Œä¹Ÿè¦å¾—åˆ°è¯¥å°„çº¿çš„é•¿åº¦ã€‚</p><p>è¦ä½¿ç”¨ä¸Šè¿°æ–¹æ³•ï¼Œå¿…é¡»çŸ¥é“ä»ç›¸æœºåˆ°å¹³é¢çš„æ¯ä¸€ä¸ªåƒç´ çš„å°„çº¿ã€‚ä½†å®é™…ä¸Šï¼Œåªéœ€è¦4æ¡å°„çº¿ï¼Œé‡‘å­—å¡”çš„æ¯ä¸ªè§’éƒ½éœ€è¦ä¸€æ¡å°„çº¿ã€‚ç”¨æ’å€¼å¯ç»™å‡ºä¸­é—´æ‰€æœ‰åƒç´ çš„å…‰çº¿ã€‚</p><h3 id="è·ç¦»æ£€æµ‹-calculating-rays">è·ç¦»æ£€æµ‹-Calculating Rays</h3><p>åŸºäºç›¸æœºè¿œå¹³é¢å’Œè§†è§’è®¡ç®—å…‰çº¿ï¼ŒåŒæ—¶ç›¸æœºçš„æ–¹å‘å’Œä½ç½®ä¸è·ç¦»æ— å…³ï¼Œæ‰€ä»¥å¯ä»¥å¿½ç•¥å˜æ¢ã€‚Cameraæä¾›äº†ä¸€ä¸ªå‡½æ•°ï¼š<code class="language-plaintext highlighter-rouge">CalculateFrustumCorners</code>ï¼Œå››ä¸ªå‚æ•°<br /> çŸ©å½¢é¢ç§¯(image rect)<br /> å…‰çº¿æŠ•å°„è·ç¦»(ç›¸æœºfar-plane)<br /> ç«‹ä½“æ¸²æŸ“(ç›¸æœºè‡ªå¸¦)<br /> 4ä¸ªå…ƒç´ çš„3Då‘é‡ç»„</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">deferredCamera</span><span class="p">.</span><span class="nf">CalculateFrustumCorners</span>
<span class="p">(</span>
    <span class="n">rectArea</span><span class="p">,</span>
    <span class="n">deferredCamera</span><span class="p">.</span><span class="n">farClipPlane</span><span class="p">,</span>
    <span class="n">deferredCamera</span><span class="p">.</span><span class="n">stereoActiveEye</span><span class="p">,</span>
    <span class="n">corners</span>
<span class="p">);</span>
</code></pre></div></div><p>ä¸‹ä¸€æ­¥ä¼ é€’è¯¥æ•°æ®è‡³Shaderï¼ŒåŒæ—¶ä¹Ÿå¾—æ”¹å˜ç´¢å¼•é¡ºåºã€‚ç›¸æœºæä¾›çš„æ˜¯ï¼šå·¦ä¸‹ã€å·¦ä¸Šã€å³ä¸Šã€å³ä¸‹ã€‚shaderéœ€è¦ï¼šå·¦ä¸‹ã€å³ä¸‹ã€å·¦ä¸Šã€å³ä¸Š</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//corners vectex index: b-l, u-l, u-r, b-r</span>
<span class="c1">//shader vectex index : b-l, b-r, u-l, u-r</span>
<span class="n">frustumCorners</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">corners</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
<span class="n">frustumCorners</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="n">corners</span><span class="p">[</span><span class="m">3</span><span class="p">];</span>
<span class="n">frustumCorners</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="n">corners</span><span class="p">[</span><span class="m">1</span><span class="p">];</span>
<span class="n">frustumCorners</span><span class="p">[</span><span class="m">3</span><span class="p">]</span> <span class="p">=</span> <span class="n">corners</span><span class="p">[</span><span class="m">2</span><span class="p">];</span>

<span class="n">fogMate</span><span class="p">.</span><span class="nf">SetVectorArray</span><span class="p">(</span><span class="s">"__FustumCorners"</span><span class="p">,</span> <span class="n">frustumCorners</span><span class="p">);</span>
</code></pre></div></div><h3 id="è®¡ç®—è·ç¦»-deriving-distances">è®¡ç®—è·ç¦»-Deriving Distances</h3><p>Shaderéœ€è¦ä¸€ä¸ªæ¥æ”¶å˜é‡ï¼ŒåŒæ—¶å®šä¹‰ä¸€ä¸ªFOG_DISTANCEå®ï¼Œå½“éœ€è¦ä½¿ç”¨è·ç¦»æ—¶å†è®¡ç®—å…‰çº¿ã€‚</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define FOG_DISTANCE
</span>
<span class="k">struct</span> <span class="nc">Interpolators</span>
<span class="p">{</span>
    <span class="n">float4</span> <span class="n">position</span> <span class="p">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
    <span class="n">float2</span> <span class="n">uv</span>       <span class="p">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
<span class="cp">#if FOG_DISTANCE
</span>    <span class="n">float3</span> <span class="n">ray</span> <span class="p">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span>
<span class="cp">#endif
</span><span class="p">};</span>
</code></pre></div></div><p>æ ¹æ®UVåæ ‡è®¡ç®—è·å–æ•°ç»„ä¸­å¯¹åº”çš„å…‰çº¿ï¼Œä¼ è¿›shaderçš„æ•°ç»„æ’åˆ—ï¼š(0,0) (1,0) (0,1) (1,1)ï¼Œä½¿ç”¨U+2Vå¯å¾—</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if FOG_DISTANCE
</span>    <span class="n">i</span><span class="p">.</span><span class="n">ray</span> <span class="p">=</span> <span class="n">_FustumCorners</span><span class="p">[</span><span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="m">2</span> <span class="err">\</span><span class="p">*</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">];</span>
<span class="cp">#endif
</span></code></pre></div></div><p>æœ€ååœ¨Fragmentå‡½æ•°æ›¿æ¢åŸºäºæ·±åº¦è®¡ç®—çš„é›¾ï¼Œä½¿ç”¨åŸºäºè·ç¦»è®¡ç®—</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">viewDistance</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="cp">#if defined(FOG_DISTANCE)
</span>    <span class="n">viewDistance</span> <span class="p">=</span> <span class="nf">length</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">ray</span> <span class="err">\</span><span class="p">*</span> <span class="n">depth</span><span class="p">);</span>
<span class="cp">#else
</span>    <span class="n">viewDistance</span> <span class="p">=</span> <span class="n">depth</span> <span class="err">\</span><span class="p">*</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span> <span class="p">-</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="cp">#endif
</span></code></pre></div></div><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004349963-1740626309.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004351071-1952278624.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>åŸºäºè·ç¦»çš„é›¾ standard vs deferrd.</a></i></center> </font><h3 id="å¤©ç©ºç›’-fogged-skybox">å¤©ç©ºç›’-Fogged Skybox</h3><p>è§£æ”¾å¤©ç©ºç›’ã€‚ä¸¤ä¸ªä¸åŒæ¸²æŸ“è·¯å¾„æ¸²æŸ“çš„é›¾ä¼šæœ‰æ˜¾è‘—å·®å¼‚ã€‚å»¶è¿Ÿé›¾ä¹Ÿä¼šå½±å“å¤©ç©ºç›’ã€‚å®ƒçš„ä½œç”¨å°±åƒfar-planeæ˜¯ä¸€ä¸ªå›ºä½“å±éšœï¼Œå—åˆ°é›¾çš„å½±å“ã€‚å½“æ·±åº¦å€¼æ¥è¿‘1æ—¶ï¼Œè¡¨æ˜å·²ç»åˆ°è¾¾äº†è¿œå¹³é¢ã€‚å¦‚æœä¸æƒ³ç»™å¤©ç©ºç›’è’™ä¸Šé›¾ï¼Œå¯ä»¥é€šè¿‡å°†é›¾å› å­è®¾ç½®ä¸º1æ¥é˜²æ­¢ã€‚</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="p">&gt;</span> <span class="m">0.999</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">unityFogFactor</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender14/1692664-20200518004352199-224022866.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>åŸºäºè·ç¦»çš„é›¾ standard vs deferrd.</a></i></center> </font><h3 id="no-fog">No Fog</h3><p>æœ€åè€ƒè™‘å¦‚ä½•åœæ­¢æ¸²æŸ“é›¾ã€‚è§£å†³æ–¹æ¡ˆæ˜¯å½“æ²¡æœ‰è®¾ç½®ä»»ä½•é›¾å…³é”®å­—ï¼Œé€šè¿‡è®¾ç½®é›¾å› å­ä¸º1å³å¯ã€‚</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if !defined(FOG_LINEAR) || !defined(FOG_EXP) || !defined(FOG_EXP2)
</span>    <span class="n">unityFogFactor</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
<span class="cp">#endif
</span></code></pre></div></div></article><hr><div class='like-post'> <a style="color:rgb(112, 40, 85);" id="likeBtn" onclick="likePost(1);"> <i class="fa fa-thumbs-o-up fa-2x" aria-hidden="true"></i> </a> <span id="likeNum">0</span><div class="text-xs text-slate-500 mx-2">çœŸè¯šç‚¹èµï¼Œæ‰‹ç•™ä½™é¦™</div></div><h2 id="similar_posts">Similar Posts</h2><ul><li class="relatedPost"> <a href="/2024/07/10/Unity_Addressable_Editor/">Unity Addressable Editorç»“æ„ </a><li class="relatedPost"> <a href="/2018/01/25/Unity_Parallax_Normals_Heightmap/">è§†å·®å’Œæ³•çº¿ã€é«˜åº¦å›¾å›é¡¾(ç¿»è¯‘äºŒå) </a><li class="relatedPost"> <a href="/2018/01/24/Unity_GPU_Instance/">Unity GPU Instance(ç¿»è¯‘åä¹) </a><li class="relatedPost"> <a href="/2018/01/23/Unity_RealTime_GI_LOD/">Unity å®æ—¶ GI & LPPV & LOD(ç¿»è¯‘åå…«) </a><li class="relatedPost"> <a href="/2018/01/21/Unity_Mix_Lighting/">Unity æ··åˆå…‰ç…§(ç¿»è¯‘åä¸ƒ) </a><li class="relatedPost"> <a href="/2018/01/19/Unity_Static_Lightting/">Unity å…‰ç…§çƒ˜ç„™(ç¿»è¯‘åå…­) </a></ul><div class="post-recent"><div class="pre"><p><strong>ä¸Šä¸€ç¯‡</strong> <a href="/2018/01/10/Unity_Deferred_Shading/">Unity Shader å»¶è¿Ÿæ¸²æŸ“(ç¿»è¯‘åä¸‰)</a></p></div><div class="nex"><p><strong>ä¸‹ä¸€ç¯‡</strong> <a href="/2018/01/17/Unity_Deferred_Lights/">Unity Deferred Lights-å»¶è¿Ÿå…‰ç…§(ç¿»è¯‘åäº”)</a></p></div></div><h2 id="comments">Comments</h2><div id="vcomments"></div><script type="text/javascript"> /*è¯„è®ºç›¸å…³*/ function delayLoadValine() { new Valine({ el: '#vcomments', verify: "true", notify: "false", app_id: "JgYk2pcFa3QxhhWPhDjjoPvv-MdYXbMMI", app_key: "fjDLTSUgCNGrSKgCID672IJx", avatar: "monsterid", placeholder: "æ¬¢è¿è¯„è®ºï¼", pageSize: "10 || 10", master: "b5586e582cb181c6b0fc8b2ce828bd50", tagMeta: ["åšä¸»","å°ä¼™ä¼´","è®¿å®¢"], enableQQ: true, requiredFields: [], serverURLs: "https://leanapi.damonc.top", recordIP: "true", visitor: "true", }); $(document).ready(function(){ fetch('https://v1.hitokoto.cn/') .then(response => response.json()) .then(data => { document.getElementById("veditor").setAttribute( "placeholder", data.hitokoto+"â€”"+data.from ); setTimeout(() => { addPostVisitedTimes(); }, 1000); } ) .catch(console.error); }); } /*ç‚¹èµç›¸å…³*/ var curIpVisitRecord = null; var curPost = null; var curUrl = "https://www.damonc.top/2018/01/15/UNity_Shader_Fog/"; function getVisitorIpAndJudge() { $.getJSON('https://api.ipify.org?format=json', function(data){ saveOrUpdateIpRecord(data.ip) }); } function saveOrUpdateIpRecord(ip) { var Visitor = AV.Object.extend("visitors_record"); var post_url = curUrl; var query = new AV.Query(Visitor); query.equalTo("visitor_ip", ip); query.equalTo("post_url", post_url); query.find().then(function(results) { if (results.length > 0) { /* if(window.console){ console.log('è¯¥IPå·²è®¿é—®è¿‡è¯¥æ–‡ç« '); }*/ curIpVisitRecord = results[0]; updateIpRecord(); refreshLikeBtn(); } else { /*if(window.console){ console.log('è¯¥IPç¬¬ä¸€æ¬¡è®¿é—®è¯¥æ–‡ç« ï¼Œä¿å­˜æ–°çš„è®¿é—®è®°å½•ï¼Œå¹¶å¢åŠ è®¿é—®æ¬¡æ•°'); }*/ addNewIpRecord(ip, post_url); } }, function(error) { addPostVisitedTimes(); }); } function addPostVisitedTimes() { var AV_Posts = AV.Object.extend("Posts"); var url = curUrl; var title = "Unity Shader Fog(ç¿»è¯‘åå››)"; var query = new AV.Query(AV_Posts); query.equalTo("post_url", url); query.find().then(function(results) { if (results.length > 0) { curPost = results[0]; curPost.increment("visited_times"); curPost.save(); loadLikeNums(); } else { curPost = new AV_Posts(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); curPost.setACL(acl); /* End Set ACL */ curPost.set("post_title", title); curPost.set("post_url", url); curPost.set("visited_times", 1); curPost.set('like_times', 0); curPost.save(); } getVisitorIpAndJudge(); }, function(error) { console.log('Error:' + error.code + " " + error.message); }); } function showPostVisitedTimes() { var AV_Posts = AV.Object.extend("Posts"); var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(AV_Posts); query.equalTo("post_url", url); query.find().then(function(results) { if (results.length > 0) { curPost = results[0]; loadLikeNums(); } else { /*if(window.console){ console.log('å¼‚å¸¸æƒ…å†µï¼Œä¸åº”è¯¥æ²¡è®°å½•çš„'); }*/ } }, function(error) { console.log('Error:' + error.code + " " + error.message); }); } function updateIpRecord(){ var lastTime = curIpVisitRecord.updatedAt; var curTime = new Date(); var timePassed = curTime.getTime() - lastTime.getTime(); if(timePassed > 300000) { /*if(window.console){ console.log('è·ç¦»è¯¥IPä¸Šä¸€æ¬¡è®¿é—®è¯¥æ–‡ç« å·²è¶…è¿‡äº†5åˆ†é’Ÿï¼Œæ›´æ–°è®¿é—®è®°å½•ï¼Œå¹¶å¢åŠ è®¿é—®æ¬¡æ•°'); }*/ addPostVisitedTimes(); curIpVisitRecord.save(); } else { /*console.log('è¿™æ˜¯è¯¥IP 1åˆ†é’Ÿå†…é‡å¤è®¿é—®è¯¥æ–‡ç« ï¼Œä¸æ›´æ–°è®¿é—®è®°å½•ï¼Œä¸å¢åŠ è®¿é—®æ¬¡æ•°');*/ } } function addNewIpRecord(ip, post_url){ var Visitor = AV.Object.extend("visitors_record"); curIpVisitRecord = new Visitor(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); curIpVisitRecord.setACL(acl); curIpVisitRecord.set("visitor_ip", ip); curIpVisitRecord.set("post_url", post_url); curIpVisitRecord.set("like_this_post", 0); curIpVisitRecord.save(); } function loadLikeNums() { var likeTimes = curPost.get('like_times'); $("#likeNum").text(likeTimes); } function refreshLikeBtn() { var likeState = curIpVisitRecord.get('like_this_post'); if(likeState == 1){ $("#likeBtn").css("color", "red"); $("#likeBtn").attr("onclick", "likePost(-1)"); } else { $("#likeBtn").css("color", "rgb(112, 40, 85)"); $("#likeBtn").attr("onclick", "likePost(1)"); } loadLikeNums(); } function likePost(type) { if(curPost == null || curIpVisitRecord == null) { alert('å»¶è¿Ÿ10såæ‰èƒ½ç‚¹èµ, è¯·ç¨ç­‰...'); return } var newNum; var getlikeTime = curPost.get('like_times'); if(typeof getlikeTime == "undefined" || getlikeTime == null || getlikeTime == "") { newNum = parseInt(type); }else{ newNum = parseInt(type) + parseInt(getlikeTime); } curPost.set('like_times', newNum); curPost.save().then(function(curPost){ var likeThisPost = type == -1 ? 0 : 1; curIpVisitRecord.set("like_this_post", likeThisPost); curIpVisitRecord.save().then(function(){ refreshLikeBtn(); }); },function(error){ console.log('Failed to create visitor record, with error message: ' + error.message); }); } /*å¯åŠ¨æ‰§è¡Œ*/ setTimeout(() => { delayLoadValine(); }, 10000); </script></div></div><script> /** * target _blank */ (function() { var aTags = document.querySelectorAll('article a:not([id])'); for (var i = 0; i < aTags.length; i++) { var htps = aTags[i].href; if (htps.startsWith("https://")) aTags[i].setAttribute('target', '_blank'); } }()); </script> <script src="/js/pageContent.js " charset="utf-8"></script><footer class="site-footer"><div class="wrapper"><p class="description"> äº‘ä¸Šçš„æ—¥å­!</p><p class="contact"> <a href="https://github.com/bitfeng" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a> <a href="mailto:damonc@126.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></p><p> æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡ï¼Œæœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡ï¼Œæœ¬æ–‡æ€»é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡</p></div></footer><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="back-to-top"> <a href="#top" data-scroll> <i class="fa fa-arrow-up" aria-hidden="true"></i> </a></div><script src=" /js/main.js " charset="utf-8"></script> <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script> <script type="text/javascript"> smoothScroll.init({ speed: 500, easing: 'easeInOutCubic', offset: 20, }); function displayWindowSize() { var w = document.documentElement.clientWidth; var h = document.documentElement.clientHeight; var rightDiv = document.querySelector('.right'); var footer = document.querySelector('.site-footer'); if(!rightDiv || !footer){ return; } if(w <= 1700){ rightDiv.style.display='none'; footer.style.display='none'; }else{ rightDiv.style.display='block'; footer.style.display = "block"; } } window.addEventListener("resize", displayWindowSize); displayWindowSize(); </script><meta name="viewport" content="width=device-width, initial-scale=1.0"><div id="myModal" class="modal" onclick="closeModal()"> <span class="modal-content"> <img id="modalImg" src="" alt="Modal Image"><div class="prev-div" onclick="prevImage()" ><button class="btn-s prev-btn"></button></div><div class="next-div" onclick="nextImage()" ><button class="btn-s next-btn"></button></div></span></div><script> var images = document.getElementsByTagName("img"); var currentImageIndex = 0; /*ä¸ºæ¯ä¸ªå›¾ç‰‡æ ‡ç­¾æ·»åŠ ç‚¹å‡»äº‹ä»¶*/ for (var i = 0; i < images.length; i++) { if(images[i].id.startsWith("fit-picture")){ images[i].onclick = function () { openModal(this); }; } } /*æ‰“å¼€æ¨¡æ€æ¡†å¹¶æ˜¾ç¤ºæ”¾å¤§çš„å›¾ç‰‡*/ function openModal(img) { console.log(img.src); var modal = document.getElementById("myModal"); var modalImg = document.getElementById("modalImg"); modal.style.display = "block"; modalImg.src = img.src; } /*å…³é—­æ¨¡æ€æ¡†*/ function closeModal() { var modal = document.getElementById("myModal"); modal.style.display = "none"; } /*ä¸Šä¸€å¼ å›¾ç‰‡*/ function prevImage() { event.stopPropagation(); /*é˜»æ­¢äº‹ä»¶å†’æ³¡*/ currentImageIndex--; if (currentImageIndex < 0) { currentImageIndex = images.length - 1; } var modalImg = document.getElementById("modalImg"); modalImg.src = images[currentImageIndex].src; } /*ä¸‹ä¸€å¼ å›¾ç‰‡*/ function nextImage() { event.stopPropagation(); /*é˜»æ­¢äº‹ä»¶å†’æ³¡*/ currentImageIndex++; if (currentImageIndex >= images.length) { currentImageIndex = 0; } var modalImg = document.getElementById("modalImg"); modalImg.src = images[currentImageIndex].src; } </script>
