<!DOCTYPE html><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="baidu-site-verification" content="code-BGVivWGmxV" /><title>Unity Reflection åå°„(ç¿»è¯‘å…«)</title><meta name="description" content="æœ¬ç¯‡æ‘˜è¦: é‡‡æ ·åå¢ƒ ä½¿ç”¨reflection probesæ¢é’ˆ åˆ›å»ºç²—ç³™æˆ–å…‰æ»‘çš„é•œé¢ å®ŒæˆboxæŠ•å½±ä¸ç«‹æ–¹ä½“é‡‡æ · æ··åˆä¸¤ä¸ªæ¢é’ˆ"><link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon"><link rel="icon" href="/favicon.ico?" type="image/x-icon"><link rel="stylesheet" href="/css/main.css "><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href=" /css/font_8v3czwksspqlg14i.css "><link rel="canonical" href="https://www.damonc.top/2018/01/06/Unity_Reflection/"><link rel="alternate" type="application/rss+xml" title="çˆ±ç©¿æ‹–é‹" href="https://www.damonc.top/feed.xml "> <script src=" /js/Valine.min.js " charset="utf-8"></script> <script src=" /js/jquery_3_2_0.min.js " charset="utf-8"></script> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "//hm.baidu.com/hm.js?f7f1a5967e3927ea98597632f0a17ad9"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script async src="https://cdnjs.cloudflare.com/ajax/libs/js-polyfills/0.1.43/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><body class="custom-background"><header id="top"><div class="wrapper"> <a href="/" class="brand">çˆ±ç©¿æ‹–é‹</a> <small>è‡ªç”±è‡ªåœ¨ğŸ©´</small> <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button><nav id="headerNav"><ul><li> <a href="/"> <i class="fa fa-home"></i>Home </a><li> <a href="/archive/"> <i class="fa fa-archive"></i>å½’æ¡£ </a><li> <a href="/category/"> <i class="fa fa-th-list"></i>åˆ†ç±» </a><li> <a href="/tag/"> <i class="fa fa-tags"></i>æ ‡ç­¾ </a><li> <a href="/collection/"> <i class="fa fa-bookmark"></i>æ”¶é›† </a><li> <a href="/demo/"> <i class="fa fa-play"></i>å·¥å…· </a><li> <a href="/about/"> <i class="fa fa-heart"></i>About </a></ul></nav></div></header><div class="home-right-bar"> <button class="anchor"><i class="fa fa-anchor"></i></button><div class="right"><div class="wrap"><div class="side content"><div> ç›®å½•</div><ul id="content-side" class="content-ul"><li><a href="#comments">Comments</a></ul></div></div></div></div><div class="page clearfix" post><div class="left"><h1>Unity Reflection åå°„(ç¿»è¯‘å…«)</h1><div class="label"><div class="label-card"> <i class="fa fa-calendar"></i>2018-01-06</div><div class="label-card"> <i class="fa fa-user"></i>catlikecoding</div><div class="label-card"></div><div class="label-card"> <span class="categories"> <i class="fa fa-th-list"></i> <a href="/category/#ç¿»è¯‘" title="Category: ç¿»è¯‘" rel="category">ç¿»è¯‘</a> </span></div><div class="label-card"> <span class="pageTag"> <i class="fa fa-tags"></i> <b href="/tag/#Shader" title="Tag: Shader" rel="tag">Shader</b>&nbsp; <b href="/tag/#Unity3d" title="Tag: Unity3d" rel="tag">Unity3d</b> </span></div></div><hr><article itemscope itemtype="http://schema.org/BlogPosting"><ul id="markdown-toc"><li><a href="#ç¯å¢ƒæ˜ å°„-environment-mapping" id="markdown-toc-ç¯å¢ƒæ˜ å°„-environment-mapping">ç¯å¢ƒæ˜ å°„-Environment Mapping</a><ul><li><a href="#é—´æ¥é•œé¢åå°„" id="markdown-toc-é—´æ¥é•œé¢åå°„">é—´æ¥é•œé¢åå°„</a><li><a href="#ç¯å¢ƒé‡‡æ ·-sampling-enviroment" id="markdown-toc-ç¯å¢ƒé‡‡æ ·-sampling-enviroment">ç¯å¢ƒé‡‡æ ·-Sampling Enviroment</a><li><a href="#åå°„è¿½è¸ª-tracing-reflections" id="markdown-toc-åå°„è¿½è¸ª-tracing-reflections">åå°„è¿½è¸ª-Tracing Reflections</a><li><a href="#åå°„æ¢é’ˆ" id="markdown-toc-åå°„æ¢é’ˆ">åå°„æ¢é’ˆ</a></ul><li><a href="#æœ‰ç‘•ç–µçš„åå°„" id="markdown-toc-æœ‰ç‘•ç–µçš„åå°„">æœ‰ç‘•ç–µçš„åå°„</a><ul><li><a href="#ç²—ç³™é•œé¢" id="markdown-toc-ç²—ç³™é•œé¢">ç²—ç³™é•œé¢</a><li><a href="#æ¨¡æ‹Ÿå‡¹å‡¸é•œ" id="markdown-toc-æ¨¡æ‹Ÿå‡¹å‡¸é•œ">æ¨¡æ‹Ÿå‡¹å‡¸é•œ</a><li><a href="#é‡‘å±vséé‡‘å±" id="markdown-toc-é‡‘å±vséé‡‘å±">é‡‘å±vséé‡‘å±</a><li><a href="#é•œé¢å’Œé˜´å½±" id="markdown-toc-é•œé¢å’Œé˜´å½±">é•œé¢å’Œé˜´å½±</a></ul><li><a href="#boxæŠ•å½±" id="markdown-toc-boxæŠ•å½±">BoxæŠ•å½±</a><ul><li><a href="#åå°„æ¢é’ˆbox" id="markdown-toc-åå°„æ¢é’ˆbox">åå°„æ¢é’ˆbox</a><li><a href="#è°ƒæ•´é‡‡æ ·æ–¹å‘-boxprojection" id="markdown-toc-è°ƒæ•´é‡‡æ ·æ–¹å‘-boxprojection">è°ƒæ•´é‡‡æ ·æ–¹å‘-BoxProjection</a><li><a href="#å¯é€‰çš„æŠ•å½±" id="markdown-toc-å¯é€‰çš„æŠ•å½±">å¯é€‰çš„æŠ•å½±</a></ul><li><a href="#æ··åˆåå°„æ¢é’ˆ" id="markdown-toc-æ··åˆåå°„æ¢é’ˆ">æ··åˆåå°„æ¢é’ˆ</a><ul><li><a href="#ä¸¤ä¸ªæ¢é’ˆæ’å€¼è®¡ç®—" id="markdown-toc-ä¸¤ä¸ªæ¢é’ˆæ’å€¼è®¡ç®—">ä¸¤ä¸ªæ¢é’ˆæ’å€¼è®¡ç®—</a><li><a href="#æ¢é’ˆç›’é‡å " id="markdown-toc-æ¢é’ˆç›’é‡å ">æ¢é’ˆç›’é‡å </a><li><a href="#ä¼˜åŒ–" id="markdown-toc-ä¼˜åŒ–">ä¼˜åŒ–</a><li><a href="#æ¨¡æ‹Ÿåå°„çš„åå¼¹" id="markdown-toc-æ¨¡æ‹Ÿåå°„çš„åå¼¹">æ¨¡æ‹Ÿåå°„çš„åå¼¹</a></ul></ul><p>æœ¬ç¯‡æ‘˜è¦:</p><ul><li>é‡‡æ ·åå¢ƒ<li>ä½¿ç”¨reflection probesæ¢é’ˆ<li>åˆ›å»ºç²—ç³™æˆ–å…‰æ»‘çš„é•œé¢<li>å®ŒæˆboxæŠ•å½±ä¸ç«‹æ–¹ä½“é‡‡æ ·<li>æ··åˆä¸¤ä¸ªæ¢é’ˆ</ul><h2 id="ç¯å¢ƒæ˜ å°„-environment-mapping">ç¯å¢ƒæ˜ å°„-Environment Mapping</h2><p>ä¸€å—å®Œç¾çš„é•œå­æ˜¯ä¸ä¼šå‘ç”Ÿæ¼«åå°„ï¼Œä½†ç°åœ¨æˆ‘ä»¬è‡ªå·±çš„ShaderåŒ…å«çš„å…‰ç…§ï¼šç¯å¢ƒå…‰ã€æ¼«åå°„ã€é«˜å…‰åå°„ã€çº¹ç†ã€é˜´å½±ï¼Œç»“æœçœ‹èµ·æ¥è›®å¥½ã€‚ä½†æ˜¯å½“æŠŠMetallicè®¾ä¸º1ï¼ŒSmoothnessè®¾ä½0.95ï¼Œçœ‹èµ·æ¥å¾ˆäº®å°±å¾ˆä¸è‡ªç„¶äº†ã€‚ä»ä¸‹å›¾çœ‹å°½ç®¡é¢œè‰²æ˜¯ç™½è‰²ä½†æ•´ä¸ªè¡¨é¢éƒ½æ˜¯é»‘è‰²ï¼Œåªæœ‰ä¸€ä¸ªå¾ˆå°çš„é«˜äº®ç‚¹ã€‚è¿™ä¸ªäº®ç‚¹å½¢æˆ1æ˜¯å…‰æºçš„å…¥å°„ï¼Œ2æœå‘è§‚å¯Ÿè€…çš„åå°„ã€‚</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220852598-1153450081.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>é‡‘å±æ„Ÿé«˜äº®ç‚¹.</a></i></center> </font><h3 id="é—´æ¥é•œé¢åå°„">é—´æ¥é•œé¢åå°„</h3><p>ä¹‹å‰å¯¹äºé—´æ¥å…‰å…‰ç…§è®¡ç®—æ—¶ï¼Œåªè®¡ç®—äº†æ¼«åå°„æ²¡æœ‰è®¡ç®—é•œé¢åå°„ï¼Œé»˜è®¤å€¼ç»™çš„0ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆçƒé¢æ˜¯é»‘è‰²ã€‚ç°åœ¨æˆ‘ä»¬ç®€å•çš„åœ¨_CreateIndirectLight_å‡½æ•°ç»™specularå˜é‡èµ‹å€¼ï¼Œçœ‹çƒçš„è¡¨é¢æœ‰ä»€ä¹ˆå˜åŒ–ï¼š</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220853479-769128700.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>Pink!.</a></i></center> </font><p>è¿™å°±ç»™å‡ºçªç ´ç‚¹ï¼Œ<strong>è®¡ç®—é—´æ¥å…‰specularçš„æ­£ç¡®å€¼ï¼Œå°±å¯ä»¥åå°„å‘¨å›´ç¯å¢ƒï¼</strong></p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220901326-141484309.gif" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æ”¹å˜smoothnesså€¼ï¼Œæ³¨æ„è¾¹ç¼˜è¿‡æ¸¡.</a></i></center> </font><p>å…³äºè¾¹ç¼˜åå°„ï¼Œæœ€è‘—åçš„å°±æ˜¯è²æ¶…è€³åå°„ã€‚æˆ‘ä»¬å…ˆä½¿ç”¨UNITY_BRDF_PBSçš„ç‰ˆæœ¬æ¥è®¡ç®—ã€‚</p><h3 id="ç¯å¢ƒé‡‡æ ·-sampling-enviroment">ç¯å¢ƒé‡‡æ ·-Sampling Enviroment</h3><p>ä¸ºäº†åå°„å‘¨å›´ç¯å¢ƒï¼Œæˆ‘ä»¬éœ€è¦é‡‡æ ·å¤©ç©ºç›’ã€‚åœºæ™¯å†…å¤©ç©ºç›’å¯¹åº”çš„å†…ç½®å˜é‡æ˜¯åœ¨_UnityShaderVariables_æ–‡ä»¶çš„_unity_SpecCube0_çš„ï¼Œè¯¥å˜é‡ç±»å‹å–å†³äºç›®æ ‡å¹³å°ï¼Œåˆç”±_HLSLSupport_æ–‡ä»¶å†³å®šã€‚è€Œé‡‡æ ·å‡½æ•°<code class="language-plaintext highlighter-rouge">UNITY_SAMPLE_TEXCUBEå®</code>éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œ1æ˜¯å¤©ç©ºç›’ï¼Œ2æ˜¯uvã€‚å…ˆç”¨æ³•çº¿æ›¿ä»£uvã€‚åŒæ—¶å¤©ç©ºç›’æ”¯æŒHDRé«˜åŠ¨æ€èŒƒå›´é¢œè‰²ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¯¹HDRè§£ç åˆ°RGBï¼šUnityCGåŒ…å«DecodeHDRå‡½æ•°</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">half4</span> <span class="n">envSample</span> <span class="p">=</span> <span class="nf">UNITY_SAMPLE_TEXCUBE</span><span class="p">(</span><span class="n">unity_SpecCube0</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
<span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="p">=</span> <span class="nf">DecodeHDR</span><span class="p">(</span><span class="n">envSample</span><span class="p">,</span> <span class="n">unity_SpecCube0_HDR</span><span class="p">);</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220903789-1260122218.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>ç¯å¢ƒé‡‡æ ·.</a></i></center> </font><blockquote class="prompt-tip"><p>UNITY_SAMPLE_TEXCUBE</p><p>å‡½æ•°æ˜¯æ ¹æ®å¹³å°è‡ªåŠ¨åˆ‡æ¢å¯¹åº”çš„CGå‡½æ•°,DecodeHDRè½¬RGBï¼šRGBMåŒ…å«è§£ç åçš„RGBå’ŒMç³»æ•°ã€‚æœ€ç»ˆçš„RGBè¦ä¸$xM^y$ç»“æœç›¸ä¹˜ã€‚</p></blockquote><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// UNITY_SAMPLE_TEXCUBEå†…éƒ¨å®ç°</span>
<span class="c1">// Decodes HDR textures</span>
<span class="c1">// handles dLDR, RGBM formats</span>
<span class="k">inline</span> <span class="kt">half3</span> <span class="nf">DecodeHDR</span> <span class="p">(</span><span class="kt">half4</span> <span class="n">data</span><span class="p">,</span> <span class="kt">half4</span> <span class="n">decodeInstructions</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Take into account texture alpha</span>
  <span class="c1">// if decodeInstructions.w is true(the alpha value affects the RGB channels)</span>
  <span class="n">half</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">decodeInstructions</span><span class="p">.</span><span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">a</span> <span class="o">-</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
   <span class="c1">// If Linear mode is not supported we can skip exponent part</span>
  <span class="cp">#if defined(UNITY_COLORSPACE_GAMMA)
</span>    <span class="k">return</span> <span class="p">(</span><span class="n">decodeInstructions</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">data</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
  <span class="cp">#else
</span>      <span class="cp">#if defined(UNITY_USE_NATIVE_HDR)
</span>        <span class="c1">// Multiplier for future HDRI relative to absolute conversion.</span>
        <span class="k">return</span> <span class="n">decodeInstructions</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">data</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
      <span class="cp">#else
</span>        <span class="k">return</span> <span class="p">(</span><span class="n">decodeInstructions</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span>
               <span class="nb">pow</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">decodeInstructions</span><span class="p">.</span><span class="n">y</span><span class="p">))</span> <span class="o">*</span> <span class="n">data</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
      <span class="cp">#endif
</span>  <span class="cp">#endif
</span><span class="p">}</span>
</code></pre></div></div><h3 id="åå°„è¿½è¸ª-tracing-reflections">åå°„è¿½è¸ª-Tracing Reflections</h3><p>è™½ç„¶å¾—åˆ°æ­£ç¡®çš„é¢œè‰²ï¼Œä½†æ²¡æœ‰çœ‹è§æ­£ç¡®çš„åå°„ç»“æœã€‚å› ä¸ºä¸Šé¢ä½¿ç”¨äº†çƒä½“çš„æ³•çº¿é‡‡æ ·ç¯å¢ƒï¼Œä¸”æŠ•å½±ä¸ä¾èµ–è§†å›¾æ–¹å‘ï¼Œå› æ­¤å°±å¥½åƒåœ¨çƒä½“ä¸Šç”»äº†ç¯å¢ƒã€‚ä¸ºäº†å¾—åˆ°æ­£ç¡®çš„ç»“æœï¼Œæˆ‘ä»¬éœ€è¦<strong>å¾—åˆ°ä»ç›¸æœºåˆ°è¡¨é¢çš„æ–¹å‘ï¼Œç„¶åç”¨è¡¨é¢æ³•çº¿å†åå°„è¯¥æ–¹å‘ã€‚</strong></p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UnityIndirect</span> <span class="nf">CreateIndirectLight</span><span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">viewDir</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//ã€‚ã€‚ã€‚</span>
    <span class="cp">#if defined(FORWARD_BASE_PASS) 
</span>        <span class="kt">float3</span> <span class="n">reflectDir</span> <span class="o">=</span> <span class="nb">reflect</span><span class="p">(</span><span class="o">-</span><span class="n">viewDir</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
        <span class="kt">half4</span> <span class="n">envSample</span> <span class="o">=</span> <span class="n">UNITY_SAMPLE_TEXCUBE</span><span class="p">(</span><span class="n">unity_SpecCube0</span><span class="p">,</span> <span class="n">reflectDir</span><span class="p">);</span>
        <span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="o">=</span> <span class="n">DecodeHDR</span><span class="p">(</span><span class="n">envSample</span><span class="p">,</span> <span class="n">unity_SpecCube0_HDR</span><span class="p">);</span>
    <span class="cp">#endif
</span>    <span class="k">return</span> <span class="n">indirectLight</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220905942-262093732.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æ­£ç¡®çš„åå°„.</a></i></center> </font><h3 id="åå°„æ¢é’ˆ">åå°„æ¢é’ˆ</h3><p>Unityè‡ªå¸¦åå°„æ¢é’ˆç»„ä»¶ã€‚é€šè¿‡chuangjiaä½ _GameObject/Light/Reflection Probeã€‚_å‚æ•°å¦‚ä¸‹å›¾çš„çš„</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220906903-1563076120.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>Reflection Probeæ¢é’ˆå‚æ•°.</a></i></center> </font><p>Typeå¯ä»¥è®¾ç½®ä½bakeæˆ–realtimeï¼Œä¸ç®¡é‚£ç§æ¨¡å¼éƒ½ä¼šæ¸²æŸ“6æ¬¡ã€‚å…¶ä¸­realtimeæ¨¡å¼ä¸‹å¯ä»¥è®©ç¨‹åºé€šè¿‡ä»£ç é…ç½®ï¼šé‡‡æ ·é¢‘ç‡ã€åœ¨æ»¡è¶³æŸç§æƒ…å†µä¸‹æ¿€æ´»é‡‡æ ·ï¼Œè¿™èƒ½é€‚å½“åœ°èŠ‚çœè¿è¡Œæ—¶è®¡ç®—é‡ã€‚è€Œçƒ˜ç„™æ¨¡å¼ä¸‹ï¼Œéœ€è¦æŠŠç‰©ä½“è®¾ç½®ä¸ºé™æ€æ¨¡å¼ã€‚</p><h2 id="æœ‰ç‘•ç–µçš„åå°„">æœ‰ç‘•ç–µçš„åå°„</h2><p>åªæœ‰å®Œç¾çš„å…‰æ»‘è¡¨é¢æ‰èƒ½äº§ç”Ÿå®Œç¾çš„åå°„ï¼Œè¶Šç²—ç³™çš„è¡¨é¢å®ƒçš„æ¼«åå°„è¶Šå¤šã€‚<strong>å¦‚ä½•æ¨¡æ‹Ÿæš—æ·¡çš„æ¨¡ç³Šé•œé¢åå°„</strong>ï¼Ÿ</p><p><strong>å¼€å¯MipMaps.</strong></p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220908231-309110279.gif" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>bakeæ¨¡å¼ä¸‹ï¼Œçƒ˜ç„™åå¾—åˆ°çš„cubeMap.</a></i></center> </font><h3 id="ç²—ç³™é•œé¢">ç²—ç³™é•œé¢</h3><p>æˆ‘ä»¬å¯ä½¿ç”¨<code class="language-plaintext highlighter-rouge">UNITY_SAMPLE_TEXCUBE_LOD</code>å®æŒ‡å®šé‡‡æ ·cubeMapçš„mipmapç­‰çº§ã€‚ç”±äºçƒ˜ç„™å¾—åˆ°çš„ç¯å¢ƒcubeMapä½¿ç”¨ä¸‰çº¿æ€§è¿‡æ»¤ï¼Œæ‰€ä»¥èƒ½æ··åˆç›¸é‚»mipMapLevel.è¿™å¯ä½¿å¾—æ ¹æ®smoothnesså¤§å°ç¡®å®šmipmapç­‰çº§ã€‚æè´¨è¶Šç²—ç³™ï¼ŒmipMapç­‰çº§å°±è¶Šé«˜ã€‚ç²—ç³™å€¼èŒƒå›´ä¹Ÿæ˜¯[0,1]ï¼Œä¹Ÿå°±æ˜¯1-smoothessã€‚Unityæä¾›äº†UNITY_SPECCUBE_LOD_STEPSå®æ¥è®¡ç®—è¿™ä¸ªèŒƒå›´ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*2Lodé‡‡æ ·*/</span>
<span class="kt">float3</span> <span class="n">reflectDir</span> <span class="o">=</span> <span class="nb">reflect</span><span class="p">(</span><span class="o">-</span><span class="n">viewDir</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
<span class="n">float</span> <span class="n">roughness</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">_Smoothness</span><span class="p">;</span>
<span class="kt">half4</span> <span class="n">envSample</span> <span class="o">=</span> <span class="n">UNITY_SAMPLE_TEXCUBE_LOD</span><span class="p">(</span><span class="n">unity_SpecCube0</span><span class="p">,</span> <span class="n">reflectDir</span><span class="p">,</span> <span class="n">roughness</span> <span class="o">*</span> <span class="n">UNITY_SPECCUBE_LOD_STEPS</span><span class="p">);</span>
<span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="o">=</span> <span class="n">DecodeHDR</span><span class="p">(</span><span class="n">envSample</span><span class="p">,</span> <span class="n">unity_SpecCube0_HDR</span><span class="p">);</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220911576-823906377.gif" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>smoothnessè¡°å‡.</a></i></center> </font><p>äº‹å®ä¸Šï¼Œç²—ç³™åº¦å’Œmipmapç­‰çº§ä¸æ˜¯çº¿æ€§çš„ï¼ŒUnityä½¿ç”¨äº†$1.7r â€“ 0.7r^2$å…¬å¼æ¢ç®—ã€‚ræ˜¯åŸå§‹çš„ç²—ç³™åº¦</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float3</span> <span class="n">reflectDir</span> <span class="o">=</span> <span class="nb">reflect</span><span class="p">(</span><span class="o">-</span><span class="n">viewDir</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
<span class="n">float</span> <span class="n">roughness</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">_Smoothness</span><span class="p">;</span>
<span class="n">roughness</span> <span class="o">*=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">7</span> <span class="o">-</span> <span class="mi">0</span><span class="p">.</span><span class="mi">7</span> <span class="o">*</span> <span class="n">roughness</span><span class="p">;</span>
<span class="kt">half4</span> <span class="n">envSample</span> <span class="o">=</span> <span class="n">UNITY_SAMPLE_TEXCUBE_LOD</span><span class="p">(</span><span class="n">unity_SpecCube0</span><span class="p">,</span> <span class="n">reflectDir</span><span class="p">,</span> <span class="n">roughness</span> <span class="o">*</span> <span class="n">UNITY_SPECCUBE_LOD_STEPS</span><span class="p">);</span>
<span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="o">=</span> <span class="n">DecodeHDR</span><span class="p">(</span><span class="n">envSample</span><span class="p">,</span> <span class="n">unity_SpecCube0_HDR</span><span class="p">);</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220914656-1050871905.gif" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æ›´æ—©åœ°ç²—ç³™.</a></i></center> </font><p><code class="language-plaintext highlighter-rouge">UnityStandardBRDF</code>æ–‡ä»¶æä¾›äº†Unity_GlossyEnvironmentå‡½æ•°è®¡ç®—roughnessã€é‡‡æ ·cubeMapã€è½¬æ¢HDRä»£ç ï¼Œä»¥åŠUnity_GlossyEnvironmentDataç»“æ„ä½“åŒ…å«äº†roughnessã€åå°„æ–¹å‘ã€‚</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*3Unityå®*/</span>
<span class="n">float3</span> <span class="n">reflectDir</span> <span class="p">=</span> <span class="nf">reflect</span><span class="p">(-</span><span class="n">viewDir</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>

<span class="n">Unity_GlossyEnvironmentData</span> <span class="n">envData</span><span class="p">;</span>
<span class="n">envData</span><span class="p">.</span><span class="n">roughness</span> <span class="p">=</span> <span class="m">1</span> <span class="p">-</span> <span class="n">_Smoothness</span><span class="p">;</span>
<span class="n">envData</span><span class="p">.</span><span class="n">reflUVW</span> <span class="p">=</span> <span class="n">reflectDir</span><span class="p">;</span>
<span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="p">=</span> <span class="nf">Unity_GlossyEnvironment</span>
<span class="p">(</span>
	<span class="nf">UNITY_PASS_TEXCUBE</span> <span class="p">(</span><span class="n">unity_SpecCube0</span><span class="p">),</span>
	<span class="n">unity_SpecCube0_HDR</span><span class="p">,</span>
	<span class="n">envData</span>
<span class="p">);</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">è¿™æ˜¯Unity_GlossyEnvironmentå‡½æ•°ï¼Œå†…éƒ¨è®¡ç®—ç»†èŠ‚ä¸æˆ‘ä»¬è®¡ç®—å¤§è‡´ç›¸åŒã€‚</code></p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// -</span>
<span class="kt">half3</span> <span class="nf">Unity_GlossyEnvironment</span> <span class="p">(</span><span class="n">UNITY_ARGS_TEXCUBE</span><span class="p">(</span><span class="n">tex</span><span class="p">),</span> <span class="kt">half4</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">Unity_GlossyEnvironmentData</span> <span class="n">glossIn</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">half</span> <span class="n">perceptualRoughness</span> <span class="o">=</span> <span class="n">glossIn</span><span class="p">.</span><span class="n">roughness</span> <span class="cm">/* perceptualRoughness */</span> <span class="p">;</span>

    <span class="c1">// TODO: CAUTION: remap from Morten may work only with offline convolution, see impact with runtime convolution!</span>
    <span class="c1">// For now disabled</span>
<span class="c">#if 0
    float m = PerceptualRoughnessToRoughness(perceptualRoughness); // m is the real roughness parameter

    // smallest such that 1.0+FLT_EPSILON != 1.0  (+1e-4h is NOT good here. is visibly very wrong)
    const float fEps = 1.192092896e-07F;

    // remap to spec power. See eq. 21 in https://dl.dropboxusercontent.com/u/55891920/papers/mm_brdf.pdf
    float n =  (2.0/max(fEps, m*m))-2.0;        
    n /= 4;

    // remap from n_dot_h formulatino to n_dot_r. See section "Pre-convolved Cube Maps vs Path Tracers" 
    // in https://s3.amazonaws.com/docs.knaldtech.com/knald/1.0.0/lys_power_drops.html

    // remap back to square root of real roughness
    // (0.25 include both the sqrt root of the conversion and sqrt for going from roughness to perceptualRoughness)
    perceptualRoughness = pow( 2/(n+2), 0.25);
#else</span>
    <span class="c1">// MM: came up with a surprisingly close approximation to what the #if 0'ed out code above does.</span>
    <span class="n">perceptualRoughness</span> <span class="o">=</span> <span class="n">perceptualRoughness</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">7</span> <span class="o">-</span> <span class="mi">0</span><span class="p">.</span><span class="mi">7</span><span class="o">*</span><span class="n">perceptualRoughness</span><span class="p">);</span>
<span class="cp">#endif
</span>

    <span class="n">half</span> <span class="n">mip</span> <span class="o">=</span> <span class="n">perceptualRoughnessToMipmapLevel</span><span class="p">(</span><span class="n">perceptualRoughness</span><span class="p">);</span>
    <span class="kt">half3</span> <span class="n">R</span> <span class="o">=</span> <span class="n">glossIn</span><span class="p">.</span><span class="n">reflUVW</span><span class="p">;</span>
    <span class="kt">half4</span> <span class="n">rgbm</span> <span class="o">=</span> <span class="n">UNITY_SAMPLE_TEXCUBE_LOD</span><span class="p">(</span><span class="n">tex</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">mip</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">DecodeHDR</span><span class="p">(</span><span class="n">rgbm</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define UNITY_PASS_TEXCUBE(tex) tex, sampler##tex
</span></code></pre></div></div><h3 id="æ¨¡æ‹Ÿå‡¹å‡¸é•œ">æ¨¡æ‹Ÿå‡¹å‡¸é•œ</h3><p><code class="language-plaintext highlighter-rouge">ç»™æè´¨çƒæŒ‡å®šä¸€ä¸ªæ³•çº¿çº¹ç†ã€‚å»‰ä»·çš„æ°´é¢æ‰°åŠ¨æ¨¡æ‹Ÿã€‚</code></p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220916149-1630380913.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æ¨¡æ‹Ÿæ°´é¢æ‰°åŠ¨.</a></i></center> </font><h3 id="é‡‘å±vséé‡‘å±">é‡‘å±vséé‡‘å±</h3><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220917166-148397097.png" width="250" alt="loading failed, need vpn." /> <img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220918277-2118614339.png" width="250" alt="loading failed, need vpn." /> <img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220919332-963853704.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>éé‡‘å±ï¼Œ0.5ã€0.75ã€0.9.</a></i></center> </font> <center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220920696-681950148.png" width="250" alt="loading failed, need vpn." /> <img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220921820-772592016.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>é‡‘å±åå°„ä¸Šè‰²ï¼›éé‡‘å±åå°„ä¸ä¸Šè‰²(æ–¹å—è¿˜æ˜¯ç™½è‰²).</a></i></center> </font><h3 id="é•œé¢å’Œé˜´å½±">é•œé¢å’Œé˜´å½±</h3><p><code class="language-plaintext highlighter-rouge">é—´æ¥å…‰åå°„ä¾èµ–äºç‰©ä½“è¡¨é¢çš„ç›´æ¥å…‰ç…§ï¼Œæœ€æ˜æ˜¾çš„å°±æ˜¯é˜´å½±åŒºåŸŸã€‚å¯¹éé‡‘å±è€Œè¨€ï¼Œé˜´å½±åŒºåŸŸåå€’å¾ˆäº®ã€‚</code></p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220922720-1635659180.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>é˜´å½±åŒºåŸŸæ›´äº®.</a></i></center> </font><p><code class="language-plaintext highlighter-rouge">å¯¹äºé‡‘å±è€Œè¨€ï¼Œsmoothnessè¶Šå…‰æ»‘é˜´å½±è¶Šæš—</code></p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220924422-914181312.gif" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>smoothneesç”±å¤§åˆ°å°.</a></i></center> </font><h2 id="boxæŠ•å½±">BoxæŠ•å½±</h2><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200222220925863-819058878.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>ä¸€ä¸ªprobesï¼Œæ‰€æœ‰çƒä½“åå°„ä¸€æ ·.</a></i></center> </font><p>æˆ‘ä»¬ä¸æƒ³æ¯ä¸ªçƒä½“éƒ½é…ä¸€ä¸ªprobeã€‚ä½†æ˜¯åªæœ‰ä¸€ä¸ªProbeæ—¶ä¸ºäº†èƒ½å¾—åˆ°å‘¨å›´çš„åå°„ï¼Œæˆ‘ä»¬è¦è®¡ç®—probeåå°„æ–¹å‘ä¸æ¯ä¸ªç«‹æ–¹ä½“çš„äº¤ç‚¹ï¼Œç„¶åæ„é€ ä¸­å¿ƒprobeåˆ°æ­¤äº¤ç‚¹çš„å‘é‡ï¼Œå¾—åˆ°æœ€ç»ˆçš„åå°„ã€‚</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200223012003016-659991713.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>ä¸€ä¸ªprobesï¼Œæ‰€æœ‰çƒä½“åå°„ä¸€æ ·.</a></i></center> </font><h3 id="åå°„æ¢é’ˆbox">åå°„æ¢é’ˆbox</h3><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200223012003797-345465392.png" width="250" alt="loading failed, need vpn." /> <img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200223012004313-1566914734.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>boxè¾¹ç•Œ.</a></i></center> </font><p><code class="language-plaintext highlighter-rouge">ç‰¹æ€§</code></p><ol><li>boxå°ºå¯¸å’ŒåŸç‚¹ç¡®å®šäº†å…¶ä½ç½®åœ¨ä¸–ç•Œç©ºé—´çš„ç«‹æ–¹ä½“åŒºåŸŸ<li>å§‹ç»ˆä¸è½´å¯¹é½ï¼Œå¿½ç•¥æ‰€æœ‰æ—‹è½¬å’Œç¼©æ”¾<li>Unityä½¿ç”¨è¿™äº›åŒºåŸŸå†³å®šåœ¨æ¸²æŸ“æ—¶ä½¿ç”¨å“ªä¸ªæ¢é’ˆ<li>boxæŒ‡å®šäº†ç«‹æ–¹åŒºåŸŸå¤§å°ï¼Œä»¥è¯¥å¤§å°è¿›è¡ŒæŠ•å½±</ol><h3 id="è°ƒæ•´é‡‡æ ·æ–¹å‘-boxprojection">è°ƒæ•´é‡‡æ ·æ–¹å‘-BoxProjection</h3><p>å¢åŠ BoxProjectionå‡½æ•°ï¼Œç›®çš„æ˜¯åˆå§‹åŒ–åå°„æ–¹å‘ã€‚ä»cubeMapåæ ‡å’Œboxè¾¹ç•Œé‡‡æ ·å¾—åˆ°ã€‚</p><p><code class="language-plaintext highlighter-rouge">ç¬¬ä¸€æ­¥</code>æ˜¯åç§»boxåˆ°ç›¸å¯¹è¯¥è¡¨é¢é¡¶ç‚¹ä¸ºä¸­å¿ƒ</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*åˆå§‹åŒ–boxæŠ•å½±æ–¹å‘*/</span>
<span class="n">float3</span> <span class="nf">BoxProjection</span><span class="p">(</span><span class="n">float3</span> <span class="n">direction</span><span class="p">,</span> <span class="n">float3</span> <span class="n">position</span><span class="p">,</span> <span class="n">float3</span> <span class="n">cubeMapPosition</span><span class="p">,</span> <span class="n">float3</span> <span class="n">boxMin</span><span class="p">,</span> <span class="n">float3</span> <span class="n">boxMax</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">boxMin</span> <span class="p">-=</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">boxMax</span> <span class="p">-=</span> <span class="n">position</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">direction</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">ç¬¬äºŒæ­¥</code>ç¼©æ”¾æ–¹å‘å‘é‡ï¼Œä»¥ä¾¿ä»è¯¥ä½ç½®ç§»åŠ¨åˆ°äº¤ç‚¹ä½ç½®ã€‚</p><ol><li>xç»´åº¦ï¼Œå¦‚æœæ–¹å‘å‘é‡xåˆ†é‡æ˜¯æ­£æ•°ï¼Œå®ƒå°±æŒ‡å‘boxçš„maxè¾¹ç•Œï¼›å¦åˆ™æŒ‡å‘boxçš„minè¾¹ç•Œã€‚ç„¶åç”¨æ­£ç¡®è¾¹ç•Œå€¼å†é™¤ä»¥æ–¹å‘å‘é‡çš„xåˆ†é‡ï¼Œå¾—åˆ°é€‚å½“çš„æ ‡é‡ã€‚<li>yã€zç»´åº¦åŒç†ã€‚<li>å–å¾—ä¸‰ä¸ªæ ‡é‡ï¼Œå†ä»ä¸­æ‹¿åˆ°ä¸€ä¸ªæœ€å°å€¼ã€‚è¡¨ç¤ºå“ªä¸ªè¾¹ç•Œé¢æœ€æ¥è¿‘è¡¨é¢ã€‚</ol><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200223012004774-488251662.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>è®¡ç®—æœ€è¿‘è¾¹ç•Œé¢.</a></i></center> </font><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float3</span> <span class="nf">BoxProjection</span><span class="p">(</span><span class="kt">float3</span> <span class="n">direction</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">position</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">cubeMapPosition</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">boxMin</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">boxMax</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">boxMin</span> <span class="o">-=</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">boxMax</span> <span class="o">-=</span> <span class="n">position</span><span class="p">;</span>

    <span class="n">float</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">direction</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">boxMax</span><span class="p">.</span><span class="n">x</span> <span class="o">:</span> <span class="n">boxMin</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">direction</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">direction</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">boxMax</span><span class="p">.</span><span class="n">y</span> <span class="o">:</span> <span class="n">boxMin</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">direction</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">direction</span><span class="p">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">boxMax</span><span class="p">.</span><span class="n">z</span> <span class="o">:</span> <span class="n">boxMin</span><span class="p">.</span><span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="n">direction</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">scalar</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">z</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">direction</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">ç¬¬ä¸‰æ­¥</code>ä½¿ç”¨æœ€å°æ ‡é‡ç¼©æ”¾æ–¹å‘å‘é‡æ‰¾åˆ°äº¤ç‚¹ã€‚é€šè¿‡å‡å»cubeMapä½ç½®å¾—åˆ°æ–°çš„åå°„æ–¹å‘ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">scalar</span> <span class="o">+</span> <span class="p">(</span><span class="n">position</span> <span class="o">-</span> <span class="n">cubeMapPosition</span><span class="p">);</span>
</code></pre></div></div><p>å¯ä»¥ä½¿ç”¨ä»»ä½•éé›¶å‘é‡å¯¹cubemapè¿›è¡Œé‡‡æ ·ã€‚cubemapé‡‡æ ·åŸºæœ¬ä¸Šå’Œæˆ‘ä»¬åˆšæ‰åšçš„æ˜¯ä¸€æ ·çš„ã€‚å®ƒæŒ‡å‡ºå‘é‡æŒ‡å‘å“ªä¸ªé¢ï¼Œç„¶åæ‰§è¡Œé™¤æ³•ä»¥æ‰¾åˆ°ä¸cubemapé¢ç›¸äº¤çš„ç‚¹ã€‚å®ƒä½¿ç”¨è¿™ä¸ªç‚¹çš„é€‚å½“åæ ‡æ¥é‡‡æ ·çº¹ç†ã€‚</p><p><code class="language-plaintext highlighter-rouge">ç®€åŒ–ä¸Šé¢ä¸‰æ­¥çš„ä»£ç å¦‚ä¸‹ï¼š</code></p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float3</span> <span class="nf">BoxProjection</span><span class="p">(</span><span class="kt">float3</span> <span class="n">direction</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">position</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">cubeMapPosition</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">boxMin</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">boxMax</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">boxMin</span> <span class="o">-=</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">boxMax</span> <span class="o">-=</span> <span class="n">position</span><span class="p">;</span>
    <span class="cm">/*	float x = (direction.x &gt; 0 ? boxMax.x : boxMin.x) / direction.x;
    float y = (direction.y &gt; 0 ? boxMax.y : boxMin.y) / direction.y;
    float z = (direction.z &gt; 0 ? boxMax.z : boxMin.z) / direction.z;
    float scalar = min(min(x, y), z);*/</span>
    <span class="kt">float3</span> <span class="n">scalarVec</span> <span class="o">=</span> <span class="p">(</span><span class="n">direction</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">boxMax</span> <span class="o">:</span> <span class="n">boxMin</span><span class="p">)</span> <span class="o">/</span> <span class="n">direction</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">scalar</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">scalarVec</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">scalarVec</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="n">scalarVec</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">scalar</span> <span class="o">+</span> <span class="p">(</span><span class="n">position</span> <span class="o">-</span> <span class="n">cubeMapPosition</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200223012005749-552525742.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æ­£ç¡®çš„boxæŠ•å½±.</a></i></center> </font><p>è¿™æ ·çš„ç›’å‹æŠ•å½±æ¢é’ˆèƒ½å¤Ÿå¾ˆå¥½çš„è§£å†³å¤šä¸ªprobeå¸¦æ¥çš„æ€§èƒ½é—®é¢˜ã€‚</p><h3 id="å¯é€‰çš„æŠ•å½±">å¯é€‰çš„æŠ•å½±</h3><p>ç»„ä»¶æœ‰ä¸ªProject toggleå¼€å…³ï¼Œç”¨ä»¥æ§åˆ¶æ˜¯å¦ä½¿ç”¨ç›’å‹æŠ•å½±æ¢é’ˆã€‚UnityæŠŠè¿™ä¸ªå¼€å…³å€¼å­˜åœ¨cubeMapåæ ‡çš„ç¬¬å››ä¸ªåˆ†é‡ï¼Œå¦‚æœwå€¼å¤§äº0è¡¨ç¤ºå¼€å¯ç›’å‹æŠ•å½±æ¢é’ˆã€‚</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*åˆå§‹åŒ–boxæŠ•å½±æ–¹å‘*/</span>
<span class="n">float3</span> <span class="nf">BoxProjection</span><span class="p">(</span><span class="n">float3</span> <span class="n">direction</span><span class="p">,</span> <span class="n">float3</span> <span class="n">position</span><span class="p">,</span>
    <span class="n">float4</span> <span class="n">cubeMapPosition</span><span class="p">,</span> <span class="n">float3</span> <span class="n">boxMin</span><span class="p">,</span> <span class="n">float3</span> <span class="n">boxMax</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">boxMin</span> <span class="p">-=</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">boxMax</span> <span class="p">-=</span> <span class="n">position</span><span class="p">;</span>
    <span class="cm">/*float x = (direction.x &gt; 0 ? boxMax.x : boxMin.x) / direction.x;
    float y = (direction.y &gt; 0 ? boxMax.y : boxMin.y) / direction.y;
    float z = (direction.z &gt; 0 ? boxMax.z : boxMin.z) / direction.z;
    float scalar = min(min(x, y), z);*/</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">cubeMapPosition</span><span class="p">.</span><span class="n">w</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> 
    <span class="p">{</span> 
        <span class="n">float3</span> <span class="n">scalarVec</span> <span class="p">=</span> <span class="p">(</span><span class="n">direction</span> <span class="p">&gt;</span> <span class="m">0</span> <span class="p">?</span> <span class="n">boxMax</span> <span class="p">:</span> <span class="n">boxMin</span><span class="p">)</span> <span class="p">/</span> <span class="n">direction</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">scalar</span> <span class="p">=</span> <span class="nf">min</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">scalarVec</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">scalarVec</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="n">scalarVec</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
        <span class="n">direction</span> <span class="p">=</span> <span class="n">direction</span> <span class="p">*</span> <span class="n">scalar</span> <span class="p">+</span> <span class="p">(</span><span class="n">position</span> <span class="p">-</span> <span class="n">cubeMapPosition</span><span class="p">);</span> 
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">direction</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><blockquote class="prompt-tip"><p>Unityæœ‰ä¸€ä¸ªUNITY_BRANCHå®æ¥è¦æ±‚ç¼–è¯‘å™¨æä¾›å’Œå’Œå®é™…ç¼–å†™æ—¶ä¸€æ ·çš„åˆ†æ”¯è€Œä¸æ˜¯æ¡ä»¶èµ‹å€¼è¯­å¥ã€‚ä¸å¤ªèµåŒåœ¨shaderä½¿ç”¨å¤§é‡åˆ†æ”¯è¯­å¥</p></blockquote><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UNITY_BRANCH</span>
<span class="nf">if</span> <span class="p">(</span><span class="n">cubemapPosition</span><span class="p">.</span><span class="n">w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//...</span>
<span class="p">}</span>
</code></pre></div></div><p>Unityä¹Ÿæä¾›äº†è®¡ç®—é‡‡æ ·boxProjectionåå°„æ–¹å‘çš„å‡½æ•°ï¼š<code class="language-plaintext highlighter-rouge">BoxProjectedCubemapDirection</code>å®šä¹‰åœ¨_UnityStandardUtilsæ–‡ä»¶ä¸­ã€‚ä¸ä½¿ç”¨çš„åŸå› æ˜¯å¯¹æ–¹å‘åšäº†å½’ä¸€åŒ–ï¼Œå‰é¢è®²äº†ä»»ä½•éé›¶å‘é‡éƒ½å¯é‡‡æ ·ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//-</span>
<span class="k">inline</span> <span class="kt">half3</span> <span class="nf">BoxProjectedCubemapDirection</span> <span class="p">(</span><span class="kt">half3</span> <span class="n">worldRefl</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">worldPos</span><span class="p">,</span> <span class="kt">float4</span> <span class="n">cubemapCenter</span><span class="p">,</span> <span class="kt">float4</span> <span class="n">boxMin</span><span class="p">,</span> <span class="kt">float4</span> <span class="n">boxMax</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Do we have a valid reflection probe?</span>
    <span class="n">UNITY_BRANCH</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cubemapCenter</span><span class="p">.</span><span class="n">w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">half3</span> <span class="n">nrdir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">worldRefl</span><span class="p">);</span>

        <span class="cp">#if 1
</span>            <span class="kt">half3</span> <span class="n">rbmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxMax</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">worldPos</span><span class="p">)</span> <span class="o">/</span> <span class="n">nrdir</span><span class="p">;</span>
            <span class="kt">half3</span> <span class="n">rbmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxMin</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">worldPos</span><span class="p">)</span> <span class="o">/</span> <span class="n">nrdir</span><span class="p">;</span>
            <span class="kt">half3</span> <span class="n">rbminmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">nrdir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">)</span> <span class="o">?</span> <span class="n">rbmax</span> <span class="o">:</span> <span class="n">rbmin</span><span class="p">;</span>

        <span class="cp">#else // Optimized version
</span>            <span class="kt">half3</span> <span class="n">rbmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxMax</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">worldPos</span><span class="p">);</span>
            <span class="kt">half3</span> <span class="n">rbmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxMin</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">worldPos</span><span class="p">);</span>
            <span class="kt">half3</span> <span class="n">select</span> <span class="o">=</span> <span class="nb">step</span> <span class="p">(</span><span class="kt">half3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">nrdir</span><span class="p">);</span>
            <span class="kt">half3</span> <span class="n">rbminmax</span> <span class="o">=</span> <span class="nb">lerp</span> <span class="p">(</span><span class="n">rbmax</span><span class="p">,</span> <span class="n">rbmin</span><span class="p">,</span> <span class="n">select</span><span class="p">);</span>
            <span class="n">rbminmax</span> <span class="o">/=</span> <span class="n">nrdir</span><span class="p">;</span>
        <span class="cp">#endif
</span>
        <span class="n">half</span> <span class="n">fa</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">rbminmax</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">rbminmax</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="n">rbminmax</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>

        <span class="n">worldPos</span> <span class="o">-=</span> <span class="n">cubemapCenter</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
        <span class="n">worldRefl</span> <span class="o">=</span> <span class="n">worldPos</span> <span class="o">+</span> <span class="n">nrdir</span> <span class="o">*</span> <span class="n">fa</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">worldRefl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="æ··åˆåå°„æ¢é’ˆ">æ··åˆåå°„æ¢é’ˆ</h2><p>åœ¨æ¢é’ˆç»„ä»¶å®šä¹‰çš„ç«‹æ–¹ä½“åŒºåŸŸè¾¹ç•Œåˆ‡æ¢æ—¶ï¼Œå¦‚ä½•åšåˆ°è‡ªç„¶è¿‡æ¸¡ï¼Ÿ</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200223012006706-1954160110.gif" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>è¾¹ç•Œè¿‡æ¸¡åƒµç¡¬.</a></i></center> </font><h3 id="ä¸¤ä¸ªæ¢é’ˆæ’å€¼è®¡ç®—">ä¸¤ä¸ªæ¢é’ˆæ’å€¼è®¡ç®—</h3><p>shaderæ”¯æŒäº†ä¸¤ä¸ªæ¢é’ˆæ•°æ®ï¼Œç¬¬äºŒä¸ªæ¢é’ˆå†…ç½®å˜é‡åæ˜¯<code class="language-plaintext highlighter-rouge">unity_SpecCube1</code>ã€‚æˆ‘ä»¬è¦é‡‡æ ·ä¸¤æ¬¡ç¯å¢ƒè´´å›¾å¹¶ä¾æ®å“ªä¸ªæ›´ä¼˜è¿›è¡Œæ’å€¼ã€‚Unityå·²ç»åšäº†è®¡ç®—æŠŠæ’å€¼å€¼å­˜åœ¨äº†ï¼Œunity_SpecCube0_BoxMinçš„ç¬¬å››ä¸ªåˆ†é‡wã€‚wä¸º1åªæ˜¯ç¬¬ä¸€ä¸ªæ¢é’ˆï¼Œå€¼å°äº1å¼€å§‹æ··åˆã€‚</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">reflectDir</span> <span class="p">=</span> <span class="nf">reflect</span><span class="p">(-</span><span class="n">viewDir</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
<span class="n">Unity_GlossyEnvironmentData</span> <span class="n">envData</span><span class="p">;</span>
<span class="n">envData</span><span class="p">.</span><span class="n">roughness</span> <span class="p">=</span> <span class="m">1</span> <span class="p">-</span> <span class="n">_Smoothness</span><span class="p">;</span>

<span class="n">envData</span><span class="p">.</span><span class="n">reflUVW</span> <span class="p">=</span> <span class="nf">BoxProjection</span><span class="p">(</span><span class="n">reflectDir</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">worldPos</span><span class="p">,</span> <span class="n">unity_SpecCube0_ProbePosition</span> <span class="n">unity_SpecCube0_BoxMin</span><span class="p">,</span> <span class="n">unity_SpecCube0_BoxMax</span><span class="p">);</span><span class="c1">//reflectDir;</span>
<span class="n">float3</span> <span class="n">probe0</span> <span class="p">=</span> <span class="nf">Unity_GlossyEnvironment</span><span class="p">(</span>
    <span class="nf">UNITY_PASS_TEXCUBE</span><span class="p">(</span><span class="n">unity_SpecCube0</span><span class="p">),</span>
    <span class="n">unity_SpecCube0_HDR</span><span class="p">,</span>
    <span class="n">envData</span>
<span class="p">);</span>

<span class="n">envData</span><span class="p">.</span><span class="n">reflUVW</span> <span class="p">=</span> <span class="nf">BoxProjection</span><span class="p">(</span><span class="n">reflectDir</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">worldPos</span><span class="p">,</span> <span class="n">unity_SpecCube1_ProbePosition</span><span class="p">,</span> <span class="n">unity_SpecCube1_BoxMin</span><span class="p">,</span> <span class="n">unity_SpecCube1_BoxMax</span><span class="p">);</span>
<span class="n">float3</span> <span class="n">probe1</span> <span class="p">=</span> <span class="nf">Unity_GlossyEnvironment</span><span class="p">(</span>
    <span class="c1">//UNITY_PASS_TEXCUBE(unity_SpecCube1),//æ³¨æ„ï¼šè¿™é‡Œç”±äºéœ€è¦ä¸¤ä¸ªæ¢é’ˆè¿‡æ¸¡ï¼Œä½†æ˜¯åœºæ™¯å†…åªæœ‰ä¸€ä¸ªæ¢é’ˆã€‚æ‰€ä»¥ç”¨ä¸‹é¢ä»£ç æ¶ˆé™¤é”™è¯¯ã€‚</span>
    <span class="nf">UNITY_PASS_TEXCUBE_SAMPLER</span><span class="p">(</span><span class="n">unity_SpecCube1</span><span class="p">,</span><span class="n">unity_SpecCube0</span><span class="p">),</span>
    <span class="n">unity_SpecCube1_HDR</span><span class="p">,</span>
    <span class="n">envData</span>
<span class="p">);</span>

<span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="p">=</span> <span class="nf">lerp</span><span class="p">(</span><span class="n">probe1</span> <span class="p">,</span><span class="n">probe0</span><span class="p">,</span> <span class="n">unity_SpecCube0_BoxMin</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200223012007648-606013855.gif" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æ­£ç¡®è¿‡æ¸¡.</a></i></center> </font><h3 id="æ¢é’ˆç›’é‡å ">æ¢é’ˆç›’é‡å </h3><p>å¤šä¸ªæ¢é’ˆé‡å æœ‰ä¸€ä¸ªæƒé‡å€¼</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200223012008191-925569700.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>weight.</a></i></center> </font><p>ä¹Ÿå¯ä»¥æ··åˆæ¢é’ˆå’Œå¤©ç©ºç›’ï¼Œå…¶ä¸­offæ˜¯å…³é—­æ¢é’ˆåªç”¨å¤©ç©ºç›’</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200223012008691-814030726.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>reflection probes.</a></i></center> </font><h3 id="ä¼˜åŒ–">ä¼˜åŒ–</h3><p>ç”±äºè®¡ç®—ä¸¤ä¸ªæ¢é’ˆçš„è®¡ç®—é‡å¤ªå¤§ï¼Œå¢åŠ ä¸€ä¸ªåˆ†æ”¯</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if UNITY_SPECCUBE_BLENDING
</span>    <span class="n">UNITY_BRANCH</span>
    <span class="nf">if</span> <span class="p">(</span><span class="n">unity_SpecCube0_BoxMin</span><span class="p">.</span><span class="n">w</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">9999</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">envData</span><span class="p">.</span><span class="n">reflUVW</span> <span class="o">=</span> <span class="n">BoxProjection</span><span class="p">(</span><span class="n">reflectDir</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">worldPos</span><span class="p">,</span> <span class="n">unity_SpecCube1_ProbePosition</span><span class="p">,</span> <span class="n">unity_SpecCube1_BoxMin</span><span class="p">,</span> <span class="n">unity_SpecCube1_BoxMax</span><span class="p">);</span>
        <span class="kt">float3</span> <span class="n">probe1</span> <span class="o">=</span> <span class="n">Unity_GlossyEnvironment</span><span class="p">(</span>
        <span class="c1">//UNITY_PASS_TEXCUBE(unity_SpecCube1),</span>
        <span class="n">UNITY_PASS_TEXCUBE_SAMPLER</span><span class="p">(</span><span class="n">unity_SpecCube1</span><span class="p">,</span> <span class="n">unity_SpecCube0</span><span class="p">),</span>
        <span class="n">unity_SpecCube1_HDR</span><span class="p">,</span>
        <span class="n">envData</span>
    <span class="p">);</span>
        <span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="o">=</span> <span class="nb">lerp</span><span class="p">(</span><span class="n">probe1</span><span class="p">,</span> <span class="n">probe0</span><span class="p">,</span> <span class="n">unity_SpecCube0_BoxMin</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="o">=</span> <span class="n">probe0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#else
</span>        <span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="o">=</span> <span class="n">probe0</span><span class="p">;</span>
<span class="cp">#endif
</span></code></pre></div></div><p>å¯¹äºBoxProjectionå‡½æ•°çš„ä¼˜åŒ–æŒ‡ä»¤ï¼šUNITY_SPECCUBE_BOX_PROJECTION</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if UNITY_SPECCUBE_BOX_PROJECTION
</span>    <span class="n">UNITY_BRANCH</span>
    <span class="nf">if</span> <span class="p">(</span><span class="n">cubeMapPosition</span><span class="p">.</span><span class="n">w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">float3</span> <span class="n">scalarVec</span> <span class="o">=</span> <span class="p">(</span><span class="n">direction</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">boxMax</span> <span class="o">:</span> <span class="n">boxMin</span><span class="p">)</span> <span class="o">/</span> <span class="n">direction</span><span class="p">;</span>
        <span class="n">float</span> <span class="n">scalar</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">scalarVec</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">scalarVec</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="n">scalarVec</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">scalar</span> <span class="o">+</span> <span class="p">(</span><span class="n">position</span> <span class="o">-</span> <span class="n">cubeMapPosition</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif
</span></code></pre></div></div><h3 id="æ¨¡æ‹Ÿåå°„çš„åå¼¹">æ¨¡æ‹Ÿåå°„çš„åå¼¹</h3><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender8/1692664-20200223012009190-1606524650.png" width="250" alt="loading failed, need vpn." /></center><p>è¿™æœ‰ä¸ªå…‰çš„åå¼¹ç³»æ•°ï¼Œæœ€é«˜5æ¬¡ã€‚è®¡ç®—é‡å¾ˆå¤§ã€‚</p></article><hr><div class='like-post'> <a style="color:rgb(112, 40, 85);" id="likeBtn" onclick="likePost(1);"> <i class="fa fa-thumbs-o-up fa-2x" aria-hidden="true"></i> </a> <span id="likeNum">0</span><div class="text-xs text-slate-500 mx-2">çœŸè¯šç‚¹èµï¼Œæ‰‹ç•™ä½™é¦™</div></div><h2 id="similar_posts">Similar Posts</h2><ul><li class="relatedPost"> <a href="/2018/01/25/Unity_Parallax_Normals_Heightmap/">è§†å·®å’Œæ³•çº¿ã€é«˜åº¦å›¾å›é¡¾(ç¿»è¯‘äºŒå) </a><li class="relatedPost"> <a href="/2018/01/24/Unity_GPU_Instance/">Unity GPU Instance(ç¿»è¯‘åä¹) </a><li class="relatedPost"> <a href="/2018/01/23/Unity_RealTime_GI_LOD/">Unity å®æ—¶ GI & LPPV & LOD(ç¿»è¯‘åå…«) </a><li class="relatedPost"> <a href="/2018/01/21/Unity_Mix_Lighting/">Unity æ··åˆå…‰ç…§(ç¿»è¯‘åä¸ƒ) </a><li class="relatedPost"> <a href="/2018/01/19/Unity_Static_Lightting/">Unity å…‰ç…§çƒ˜ç„™(ç¿»è¯‘åå…­) </a><li class="relatedPost"> <a href="/2018/01/17/Unity_Deferred_Lights/">Unity Deferred Lights-å»¶è¿Ÿå…‰ç…§(ç¿»è¯‘åäº”) </a></ul><div class="post-recent"><div class="pre"><p><strong>ä¸Šä¸€ç¯‡</strong> <a href="/2018/01/05/Unity_Shadows/">Unity Shadow é˜´å½±(ç¿»è¯‘ä¸ƒ)</a></p></div><div class="nex"><p><strong>ä¸‹ä¸€ç¯‡</strong> <a href="/2018/01/07/Unity_ShaderGUI_Extension_1/">Unity Shader GUI æ‰©å±•ä¸€(ç¿»è¯‘ä¹)</a></p></div></div><h2 id="comments">Comments</h2><div id="vcomments"></div><script type="text/javascript"> /*è¯„è®ºç›¸å…³*/ function delayLoadValine() { new Valine({ el: '#vcomments', verify: "true", notify: "false", app_id: "JgYk2pcFa3QxhhWPhDjjoPvv-MdYXbMMI", app_key: "fjDLTSUgCNGrSKgCID672IJx", avatar: "monsterid", placeholder: "æ¬¢è¿è¯„è®ºï¼", pageSize: "10 || 10", master: "b5586e582cb181c6b0fc8b2ce828bd50", tagMeta: ["åšä¸»","å°ä¼™ä¼´","è®¿å®¢"], enableQQ: true, requiredFields: [], serverURLs: "https://leanapi.damonc.top", recordIP: "true", visitor: "true", }); $(document).ready(function(){ fetch('https://v1.hitokoto.cn/') .then(response => response.json()) .then(data => { document.getElementById("veditor").setAttribute( "placeholder", data.hitokoto+"â€”"+data.from ); setTimeout(() => { addPostVisitedTimes(); }, 1000); } ) .catch(console.error); }); } /*ç‚¹èµç›¸å…³*/ var curIpVisitRecord = null; var curPost = null; var curUrl = "https://www.damonc.top/2018/01/06/Unity_Reflection/"; function getVisitorIpAndJudge() { $.getJSON('https://api.ipify.org?format=json', function(data){ saveOrUpdateIpRecord(data.ip) }); } function saveOrUpdateIpRecord(ip) { var Visitor = AV.Object.extend("visitors_record"); var post_url = curUrl; var query = new AV.Query(Visitor); query.equalTo("visitor_ip", ip); query.equalTo("post_url", post_url); query.find().then(function(results) { if (results.length > 0) { /* if(window.console){ console.log('è¯¥IPå·²è®¿é—®è¿‡è¯¥æ–‡ç« '); }*/ curIpVisitRecord = results[0]; updateIpRecord(); refreshLikeBtn(); } else { /*if(window.console){ console.log('è¯¥IPç¬¬ä¸€æ¬¡è®¿é—®è¯¥æ–‡ç« ï¼Œä¿å­˜æ–°çš„è®¿é—®è®°å½•ï¼Œå¹¶å¢åŠ è®¿é—®æ¬¡æ•°'); }*/ addNewIpRecord(ip, post_url); } }, function(error) { addPostVisitedTimes(); }); } function addPostVisitedTimes() { var AV_Posts = AV.Object.extend("Posts"); var url = curUrl; var title = "Unity Reflection åå°„(ç¿»è¯‘å…«)"; var query = new AV.Query(AV_Posts); query.equalTo("post_url", url); query.find().then(function(results) { if (results.length > 0) { curPost = results[0]; curPost.increment("visited_times"); curPost.save(); loadLikeNums(); } else { curPost = new AV_Posts(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); curPost.setACL(acl); /* End Set ACL */ curPost.set("post_title", title); curPost.set("post_url", url); curPost.set("visited_times", 1); curPost.set('like_times', 0); curPost.save(); } getVisitorIpAndJudge(); }, function(error) { console.log('Error:' + error.code + " " + error.message); }); } function showPostVisitedTimes() { var AV_Posts = AV.Object.extend("Posts"); var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(AV_Posts); query.equalTo("post_url", url); query.find().then(function(results) { if (results.length > 0) { curPost = results[0]; loadLikeNums(); } else { /*if(window.console){ console.log('å¼‚å¸¸æƒ…å†µï¼Œä¸åº”è¯¥æ²¡è®°å½•çš„'); }*/ } }, function(error) { console.log('Error:' + error.code + " " + error.message); }); } function updateIpRecord(){ var lastTime = curIpVisitRecord.updatedAt; var curTime = new Date(); var timePassed = curTime.getTime() - lastTime.getTime(); if(timePassed > 300000) { /*if(window.console){ console.log('è·ç¦»è¯¥IPä¸Šä¸€æ¬¡è®¿é—®è¯¥æ–‡ç« å·²è¶…è¿‡äº†5åˆ†é’Ÿï¼Œæ›´æ–°è®¿é—®è®°å½•ï¼Œå¹¶å¢åŠ è®¿é—®æ¬¡æ•°'); }*/ addPostVisitedTimes(); curIpVisitRecord.save(); } else { /*console.log('è¿™æ˜¯è¯¥IP 1åˆ†é’Ÿå†…é‡å¤è®¿é—®è¯¥æ–‡ç« ï¼Œä¸æ›´æ–°è®¿é—®è®°å½•ï¼Œä¸å¢åŠ è®¿é—®æ¬¡æ•°');*/ } } function addNewIpRecord(ip, post_url){ var Visitor = AV.Object.extend("visitors_record"); curIpVisitRecord = new Visitor(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); curIpVisitRecord.setACL(acl); curIpVisitRecord.set("visitor_ip", ip); curIpVisitRecord.set("post_url", post_url); curIpVisitRecord.set("like_this_post", 0); curIpVisitRecord.save(); } function loadLikeNums() { var likeTimes = curPost.get('like_times'); $("#likeNum").text(likeTimes); } function refreshLikeBtn() { var likeState = curIpVisitRecord.get('like_this_post'); if(likeState == 1){ $("#likeBtn").css("color", "red"); $("#likeBtn").attr("onclick", "likePost(-1)"); } else { $("#likeBtn").css("color", "black"); $("#likeBtn").attr("onclick", "likePost(1)"); } loadLikeNums(); } function likePost(type) { if(curPost == null || curIpVisitRecord == null) { alert('å»¶è¿Ÿ10såæ‰èƒ½ç‚¹èµ, è¯·ç¨ç­‰...'); return } var newNum; var getlikeTime = curPost.get('like_times'); if(typeof getlikeTime == "undefined" || getlikeTime == null || getlikeTime == "") { newNum = parseInt(type); }else{ newNum = parseInt(type) + parseInt(getlikeTime); } curPost.set('like_times', newNum); curPost.save().then(function(curPost){ var likeThisPost = type == -1 ? 0 : 1; curIpVisitRecord.set("like_this_post", likeThisPost); curIpVisitRecord.save().then(function(){ refreshLikeBtn(); }); },function(error){ console.log('Failed to create visitor record, with error message: ' + error.message); }); } /*å¯åŠ¨æ‰§è¡Œ*/ setTimeout(() => { delayLoadValine(); }, 10000); </script></div></div><script> /** * target _blank */ (function() { var aTags = document.querySelectorAll('article a:not([id])'); for (var i = 0; i < aTags.length; i++) { aTags[i].setAttribute('target', '_blank'); } }()); </script> <script src="/js/pageContent.js " charset="utf-8"></script><footer class="site-footer"><div class="wrapper"><p class="description"> äº‘ä¸Šçš„æ—¥å­!</p><p class="contact"> <a href="https://github.com/bitfeng" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a> <a href="mailto:damonc@126.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></p><p> æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡ï¼Œæœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡ï¼Œæœ¬æ–‡æ€»é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡</p></div></footer><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="back-to-top"> <a href="#top" data-scroll> <i class="fa fa-arrow-up" aria-hidden="true"></i> </a></div><script src=" /js/main.js " charset="utf-8"></script> <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script> <script type="text/javascript"> smoothScroll.init({ speed: 500, easing: 'easeInOutCubic', offset: 20, }); function displayWindowSize() { var w = document.documentElement.clientWidth; var h = document.documentElement.clientHeight; var rightDiv = document.querySelector('.right'); var footer = document.querySelector('.site-footer'); if(!rightDiv || !footer){ return; } if(w <= 1700){ rightDiv.style.display='none'; footer.style.display='none'; }else{ rightDiv.style.display='block'; footer.style.display = "block"; } } window.addEventListener("resize", displayWindowSize); displayWindowSize(); </script>
