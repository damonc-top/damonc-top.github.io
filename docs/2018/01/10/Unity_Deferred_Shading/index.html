<!DOCTYPE html><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="baidu-site-verification" content="code-BGVivWGmxV" /><title>Unity Shader å»¶è¿Ÿæ¸²æŸ“(ç¿»è¯‘åä¸‰)</title><meta name="description" content="æœ¬ç¯‡æ‘˜è¦: G-Buffer HDRä¸LDR Defferedåå°„"><link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon"><link rel="icon" href="/favicon.ico?" type="image/x-icon"><link rel="stylesheet" href="/css/main.css "><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href=" /css/font_8v3czwksspqlg14i.css "><link rel="canonical" href="https://www.damonc.top/2018/01/10/Unity_Deferred_Shading/"><link rel="alternate" type="application/rss+xml" title="çˆ±ç©¿æ‹–é‹" href="https://www.damonc.top/feed.xml "> <script type="text/javascript" src=" /js/jquery_3_2_0.min.js " charset="utf-8"></script> <script type="text/javascript" src=" /js/Valine.min.js " charset="utf-8"></script> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "//hm.baidu.com/hm.js?8c087101d4768b7aa439cef954b30a8f"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> <script> (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-WN45VXRK'); </script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <scrip type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/js-polyfills/0.1.43/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><body class="custom-background"> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WN45VXRK" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><header id="top"><div class="wrapper"> <a href="/" class="brand">çˆ±ç©¿æ‹–é‹</a> <small>è‡ªç”±è‡ªåœ¨ğŸ©´</small> <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button><nav id="headerNav"><ul><li> <a href="/"> <i class="fa fa-home"></i>Home </a><li> <a href="/archive/"> <i class="fa fa-archive"></i>å½’æ¡£ </a><li> <a href="/category/"> <i class="fa fa-th-list"></i>åˆ†ç±» </a><li> <a href="/tag/"> <i class="fa fa-tags"></i>æ ‡ç­¾ </a></ul></nav></div></header><div class="home-right-bar"> <button class="anchor"><i class="fa fa-anchor"></i></button><div class="right"><div class="wrap"><div class="side content"><div> ç›®å½•</div><ul id="content-side" class="content-ul"><li><a href="#comments">Comments</a></ul></div></div></div></div><div class="page clearfix" post><div class="left"><h1>Unity Shader å»¶è¿Ÿæ¸²æŸ“(ç¿»è¯‘åä¸‰)</h1><div class="label"><div class="label-card"> <i class="fa fa-calendar"></i>2018-01-10</div><div class="label-card"> <i class="fa fa-user"></i>catlikecoding</div><div class="label-card"></div><div class="label-card"> <span class="categories"> <i class="fa fa-th-list"></i> <a href="/category/#ç¿»è¯‘" title="Category: ç¿»è¯‘" rel="category">ç¿»è¯‘</a> </span></div><div class="label-card"> <span class="pageTag"> <i class="fa fa-tags"></i> <b href="/tag/#Shader" title="Tag: Shader" rel="tag">Shader</b>&nbsp; <b href="/tag/#Unity3d" title="Tag: Unity3d" rel="tag">Unity3d</b> </span></div></div><hr><article><ul id="markdown-toc"><li><a href="#deferred-rendering-path" id="markdown-toc-deferred-rendering-path">Deferred Rendering Path</a><ul><li><a href="#å‡†å¤‡å·¥ä½œ" id="markdown-toc-å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</a><li><a href="#å¼€å§‹å¯¹æ¯”draw-calls" id="markdown-toc-å¼€å§‹å¯¹æ¯”draw-calls">å¼€å§‹å¯¹æ¯”Draw Calls</a><li><a href="#åˆ†æ12çš„å¯¹æ¯”æ•°æ®" id="markdown-toc-åˆ†æ12çš„å¯¹æ¯”æ•°æ®">åˆ†æ1.2çš„å¯¹æ¯”æ•°æ®</a><li><a href="#deferredä¸‹å¤šå…‰æºå¦‚ä½•ä½¿ç”¨" id="markdown-toc-deferredä¸‹å¤šå…‰æºå¦‚ä½•ä½¿ç”¨">deferredä¸‹å¤šå…‰æºå¦‚ä½•ä½¿ç”¨</a><li><a href="#å…‰æºå¦‚ä½•æ¸²æŸ“åˆ†æ" id="markdown-toc-å…‰æºå¦‚ä½•æ¸²æŸ“åˆ†æ">å…‰æºå¦‚ä½•æ¸²æŸ“åˆ†æ</a><li><a href="#åˆ†æä»€ä¹ˆæ˜¯g-buffers" id="markdown-toc-åˆ†æä»€ä¹ˆæ˜¯g-buffers">åˆ†æä»€ä¹ˆæ˜¯G-Buffers</a><li><a href="#æ··åˆä½¿ç”¨deferredä¸forwardæ¸²æŸ“æ¨¡å‹" id="markdown-toc-æ··åˆä½¿ç”¨deferredä¸forwardæ¸²æŸ“æ¨¡å‹">æ··åˆä½¿ç”¨Deferredä¸Forwardæ¸²æŸ“æ¨¡å‹</a></ul><li><a href="#å¼€å§‹å†™deferred-shader" id="markdown-toc-å¼€å§‹å†™deferred-shader">å¼€å§‹å†™Deferred Shader</a><ul><li><a href="#4ä¸ªg-bufferè¾“å‡º" id="markdown-toc-4ä¸ªg-bufferè¾“å‡º">4ä¸ªg-bufferè¾“å‡º</a><li><a href="#è®¡ç®—buffer-0" id="markdown-toc-è®¡ç®—buffer-0">è®¡ç®—Buffer 0</a><li><a href="#è®¡ç®—buffer-1" id="markdown-toc-è®¡ç®—buffer-1">è®¡ç®—Buffer 1</a><li><a href="#è®¡ç®—buffer-2" id="markdown-toc-è®¡ç®—buffer-2">è®¡ç®—Buffer 2</a><li><a href="#è®¡ç®—buffer-3" id="markdown-toc-è®¡ç®—buffer-3">è®¡ç®—Buffer 3</a><li><a href="#ambient-light" id="markdown-toc-ambient-light">Ambient Light</a><li><a href="#å…‰æºèŒƒå›´-ldrä¸hdråˆ†æ" id="markdown-toc-å…‰æºèŒƒå›´-ldrä¸hdråˆ†æ">å…‰æºèŒƒå›´-LDRä¸HDRåˆ†æ</a><li><a href="#hdr-ä¸-ldr" id="markdown-toc-hdr-ä¸-ldr">HDR ä¸ LDR</a></ul><li><a href="#deferred-reflections" id="markdown-toc-deferred-reflections">Deferred Reflections</a><ul><li><a href="#é€åƒç´ ç…§å°„" id="markdown-toc-é€åƒç´ ç…§å°„">é€åƒç´ ç…§å°„</a><li><a href="#blend-distance" id="markdown-toc-blend-distance">Blend Distance</a><li><a href="#deferred-passä¸‹çš„åå°„" id="markdown-toc-deferred-passä¸‹çš„åå°„">Deferred Passä¸‹çš„åå°„</a></ul></ul><p>æœ¬ç¯‡æ‘˜è¦:</p><ul><li>G-Buffer<li>HDRä¸LDR<li>Defferedåå°„</ul><h2 id="deferred-rendering-path">Deferred Rendering Path</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ä¸€ç›´ä½¿ç”¨äº†Unityçš„Forward Render Pathï¼Œç°åœ¨å¼€å§‹å­¦ä¹ Deferred Pathï¼Œä»¥åŠå¯¹æ¯”è¿™ä¸¤è€…é—´çš„å·®å¼‚</p><h3 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h3><ol><li>é€šè¿‡Edit/Project Setting/Graphicåˆ‡æ¢Render Pathï¼›<li>å…³é—­ç¯å¢ƒå…‰ã€åå°„å…‰ï¼›<li>Qualityè®¾ç½®é˜´å½±è´¨é‡ä¸ºæœ€é«˜ï¼Œæ–¹ä¾¿è§‚å¯Ÿï¼›<li>å¯ç”¨dynamic batching</ol><h3 id="å¼€å§‹å¯¹æ¯”draw-calls">å¼€å§‹å¯¹æ¯”Draw Calls</h3><p>ä¸€å…±æœ‰64ä¸ªObjectå¯è§ç‰©ä½“ç»„æˆä¸€ä¸ªPrefabã€‚</p><p>é€šè¿‡å¯¹æ¯”è¿™ä¸ªprefabæœ‰å’Œæ²¡æœ‰é˜´å½±ï¼Œåˆ†åˆ«è®¡ç®—å¤„äºForwardPathå’ŒDeferredPathä¸‹çš„Draw Callæ•°ã€‚</p><center> <b>$\downarrow$Use Forward Path$\downarrow$</b> </center><p><strong>1. No Shadows</strong></p><p>æ²¡æœ‰é˜´å½±ä¸‹ï¼Œ128æ¬¡å‡ ä½•ç»˜åˆ¶åŠ 1æ¬¡Clearï¼›<code class="language-plaintext highlighter-rouge">1æ¬¡</code>å¤©ç©ºç›’ç»˜åˆ¶ï¼›<code class="language-plaintext highlighter-rouge">2æ¬¡</code>å±å¹•å¤„ç†ç»˜åˆ¶ï¼Œæ€»å…±<strong>132</strong>æ¬¡Draw Callã€‚(å¦‚æœæ˜¯ä½¿ç”¨ä¸€ä¸ªæ–¹å‘å…‰ï¼ŒåŠ¨æ€æ‰¹å¤„ç†å°±ä¼šç”Ÿæ•ˆï¼Œå°±å¯ä»¥å°‘äº64ä¸ªæ‰¹æ¬¡ç»˜åˆ¶)ã€‚ç„¶è€Œç”±äºæœ‰ä¸€ä¸ªé¢å¤–çš„æ–¹å‘å…‰ï¼ŒdynamicBatchingå°±ä¸ä¼šç”Ÿæ•ˆï¼Œæ‰€ä»¥æ€»å…±ç»˜åˆ¶ä¸¤éã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200510154452501-654159285.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>Forwardï¼Œno shadow.</a></i></center> </font><p><strong>2. Enable Shadows</strong><br /></p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200510154453072-905156320.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>enable shadow.</a></i></center> </font><p>å¯ç”¨é˜´å½±åï¼Œéœ€è¦æ›´å¤šçš„Draw Callså»ç”Ÿæˆé˜´å½±çº¹ç†ï¼Œåˆ†æå¦‚ä¸‹ï¼š</p><p>é¦–å…ˆï¼Œå¡«å……depth-bufferï¼Œéœ€è¦<strong>47</strong>æ¬¡Draw Callï¼Œ<em>47å°‘äº64å¾—ç›ŠäºdynamicBatching</em>ï¼›<br /> å…¶æ¬¡ï¼Œåˆ›å»ºCascadingé˜´å½±çº¹ç†ã€‚ç¬¬ä¸€ä¸ªå…‰æäº¤äº†<strong>110</strong>æ¬¡Drall Callï¼ŒåŒæ—¶ç¬¬äºŒä¸ªå…‰æäº¤äº†<strong>115</strong>æ¬¡Drall Callï¼Œè¿™äº›çº¹ç†æ¸²æŸ“åœ¨å±å¹•ç©ºé—´screen-space bufferï¼Œæ‰§è¡Œè¿‡æ»¤ã€‚<br /> æœ€åï¼Œæ¯ä¸ªå…‰ç»˜åˆ¶ä¸€æ¬¡å‡ ä½•ç‰©ä½“ï¼Œç”¨äº†<strong>128</strong>=$(64*2)$æ¬¡DCã€‚</p><p>æ€»å…±<strong>408</strong>æ¬¡Draw Callsã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200510154453746-531274810.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>Forwardï¼Œenable shadow.</a></i></center> </font> <center> <b>$\uparrow$**Use Forward Path**$\uparrow$</b> </center><p>ä¸Šé¢æ˜¯åˆ†æå‰å‘æ¸²æŸ“ï¼Œä¸‹é¢æ˜¯åˆ†æå»¶è¿Ÿæ¸²æŸ“ã€‚</p><center> <b>$\downarrow$**Use Deferred Path**$\downarrow$</b> </center><p><strong>1. No Shadows</strong></p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200510154454370-1630685432.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>Deferredï¼Œno shadows.</a></i></center> </font><p>é¦–å…ˆï¼Œ45æ¬¡Draw Callæ¸²æŸ“GBufferï¼Œè¿™å¾—ç›Šäºdynamic Batchingï¼›<br /> å…¶æ¬¡ï¼Œ1æ¬¡Draw Callå¤åˆ¶æ·±åº¦çº¹ç†ï¼›<br /> æ¥ç€ï¼Œ1æ¬¡ç»˜åˆ¶åå°„å’Œ1æ¬¡è‡ªå‘å…‰åå°„ï¼›<br /> æœ€åï¼Œ2æ¬¡å…‰ç…§ç€è‰²(ä¸¤ä¸ªæ–¹å‘å…‰)ã€‚</p><p>æ€»å…±52æ¬¡ = 49æ¬¡å‡ ä½•ç»˜åˆ¶ï¼› 1æ¬¡å¤©ç©ºç›’ç»˜åˆ¶ï¼›2æ¬¡å±å¹•å¤„ç†ç»˜åˆ¶</p><p><strong>2. Enable Shadows</strong></p><p>ä¸ä¸Šå›¾çš„lightingç€è‰²ä¸åŒï¼Œç”¨231æ¬¡Draw Callsç»˜åˆ¶ã€‚ä½†æ˜¯å…¶é˜´å½±ç»˜åˆ¶æ–¹æ³•ä¸Forwardæ¨¡å¼æ˜¯ä¸€æ ·çš„ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200510154455028-1110322294.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>Defferedï¼Œenable shadows.</a></i></center> </font><blockquote><p>Noticeï¼šDeferredä¸æ”¯æŒMSAAï¼Œå¦‚æœå¯ç”¨Cameraç»„ä»¶ä¼šæœ‰Warningï¼š</p><p>å»¶è¿Ÿç€è‰²ä¾èµ–äºæ¯ä¸ªç‰‡æ®µå­˜å‚¨çš„æ•°æ®ï¼Œè¿™æ˜¯é€šè¿‡çº¹ç†å®Œæˆçš„ã€‚ è¿™ä¸MSAAä¸å…¼å®¹ï¼Œå› ä¸ºè¯¥æŠ—é”¯ é½¿æŠ€æœ¯ä¾èµ–äºå­åƒç´ æ•°æ®ã€‚ å°½ç®¡ ä¸‰è§’å½¢è¾¹ç¼˜ä»ç„¶å¯ä»¥ä»MSAAä¸­å—ç›Šï¼Œä½†å»¶è¿Ÿçš„æ•°æ®ä»ä¼šæ··å ã€‚ æ‚¨å¿…é¡»ä¾é ä¸€ä¸ªåå¤„ç†è¿‡æ»¤å™¨æ¥è¿›è¡ŒæŠ—é”¯é½¿ã€‚</p></blockquote><center> <b>$\uparrow$**Use Deferred Path**$\uparrow$</b> </center><h3 id="åˆ†æ12çš„å¯¹æ¯”æ•°æ®">åˆ†æ1.2çš„å¯¹æ¯”æ•°æ®</h3><table cellspacing="0" cellpadding="2" border="0"><tbody><tr><td valign="top"><font color="#ff0000">ç»“è®º</font><td valign="top"><font color="#ff0000">å½“æ¸²æŸ“å¤šä¸ªlightå…‰æ—¶ï¼ŒDefferedç€è‰²æ¨¡å¼æ¯”Forwardç€è‰²æ¨¡å¼çš„æ¸²æŸ“æ•ˆç‡æ›´é«˜ï¼</font><tr><td valign="top">ç›¸åŒ<td valign="top">ä¸¤ä¸ªæ¨¡å¼çš„é˜´å½±ç»˜åˆ¶æ–¹æ³•ä¸€æ ·<tr><td valign="center">å·®å¼‚<td valign="center"><table width="0" cellspacing="0" cellpadding="2" border="0"><tbody><tr><td width="0" valign="center">forwardæ¨¡å¼è¦æ±‚æ¯ä¸ªå…‰æ¯ä¸ªç‰©ä½“æœ‰ä¸€ä¸ªé¢å¤–çš„additive passï¼›deferredä¸éœ€è¦<tr><td width="0" valign="center">deferredä¸å¿…èŠ±è´¹é¢å¤–Draw Callsç»˜åˆ¶æ·±åº¦çº¹ç†ï¼ŒCopyå®Œæˆã€‚<font color="#ff0000"><strong>ç¼˜ç”±ï¼Ÿ</strong></font></table></table><p><code class="language-plaintext highlighter-rouge">ç¼˜ç”±ä»¥åŠdeferredç€è‰²è§£é‡Š</code>ï¼š</p><p>è¦æ¸²æŸ“ç‰©ä½“ï¼Œéœ€è¦æŠ“å–å®ƒçš„Meshæ•°æ®ï¼›è½¬æ¢åˆ°æ­£ç¡®çš„ç©ºé—´ï¼›æ’å€¼ä¼ é€’æ•°æ®ï¼›æ£€ç´¢propertiesæ•°æ®ï¼›è®¡ç®—å…‰ç…§ã€‚å¯¹äºForward shadersï¼šå¯¹è¦ç€è‰²çš„ç‰©ä½“çš„æ¯ä¸ªåƒç´ é‡å¤ä¸Šè¿°æ­¥éª¤ï¼›additivePassè¦æ¯”basePassèŠ‚çœï¼Œæ˜¯å› ä¸ºdepth-bufferå·²ç»æå‰å‡†å¤‡å¥½ï¼ŒåŒæ—¶å®ƒä¸éœ€è¦å…³å¿ƒé—´æ¥å…‰ï¼›ä½†å®ƒä»»ç„¶ä¼šé‡å¤åœ¨basePaseå·²ç»å®Œæˆçš„æœ‰å¤§é‡å·¥ä½œã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085743046-2070098632.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>é‡å¤æµç¨‹.</a></i></center> </font><p>æ—¢ç„¶æ¯æ¬¡è®¡ç®—çš„å‡ ä½•æ€§è´¨éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¯ä»¥è®©basePassè®¡ç®—åå°†å®ƒä»¬å­˜å‚¨åœ¨ä¸€ä¸ªç¼“å†²åŒºä¸­ã€‚ç„¶åï¼ŒadditivePasså¯ä»¥é‡ç”¨æ•°æ®ï¼Œæ¶ˆé™¤é‡å¤çš„å·¥ä½œã€‚è¦å­˜å‚¨è¿™äº›ç‰‡æ®µçš„æ•°æ®ï¼Œå°±éœ€è¦ä¸€ä¸ªé€‚åˆçš„ç¼“å†²åŒºï¼Œå°±åƒæ·±åº¦å’Œå¸§ç¼“å†²åŒºä¸€æ ·ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085743816-266537686.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>ç¼“å­˜ï¼ŒåŠéƒ¨åˆ†æ•°æ®é¡»å†æ¬¡è®¡ç®—.</a></i></center> </font><p>ç°åœ¨ï¼Œç¼“å†²åŒºä¸­æä¾›äº†ç…§æ˜æ‰€éœ€çš„æ‰€æœ‰å‡ ä½•æ•°æ®ã€‚ å”¯ä¸€ç¼ºå°‘çš„æ˜¯ç¯å…‰æœ¬èº«ã€‚ ä½†è¿™æ„å‘³ç€æˆ‘ä»¬ä¸å†éœ€è¦æ¸²æŸ“å‡ ä½•ä½“ï¼Œä»…éœ€æ¸²æŸ“å…‰å°±è¶³å¤Ÿäº†ã€‚ æ­¤å¤–ï¼ŒbasePassåªéœ€è¦å¡«å……ç¼“å†²åŒºï¼Œç„¶åæ¨è¿Ÿæ‰€æœ‰ç›´æ¥å…‰ç…§ç€è‰²è®¡ç®—ã€‚è¿™å°±æ˜¯å»¶è¿Ÿç€è‰²ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085744534-1514664437.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>deferred shading.</a></i></center> </font><h3 id="deferredä¸‹å¤šå…‰æºå¦‚ä½•ä½¿ç”¨">deferredä¸‹å¤šå…‰æºå¦‚ä½•ä½¿ç”¨</h3><p>å½“ä½¿ç”¨ä¸€ä¸ªå…‰æºï¼Œdeferredç€è‰²æœ¬èº«æ²¡æœ‰å¤šå¤§å¥½å¤„ã€‚ä½†æ˜¯å½“ä½¿ç”¨å¾ˆå¤šå…‰æºæ—¶ï¼Œæ¯é¢å¤–å¢åŠ ä¸€ä¸ªå…‰åªä¼šå°‘é‡å¢åŠ ä¸€ç‚¹å·¥ä½œï¼Œå‰ææ˜¯è¯¥å…‰æºä¸æŠ•å°„é˜´å½±ã€‚</p><p>å› æ­¤ï¼Œå½“å‡ ä½•ç‰©ä½“å’Œå…‰æºåˆ†å¼€æ¸²æŸ“ï¼Œå…‰çš„æ•°é‡å¯¹ç‰©ä½“çš„å½±å“æ˜¯æ²¡æœ‰é™åˆ¶çš„ï¼Œæ‰€æœ‰çš„å…‰å¯¹å®ƒä»¬èŒƒå›´å†…çš„ç‰©ä½“éƒ½æ˜¯é€åƒç´ ç€è‰²ï¼Œè¿™ä¸ª_Pixel Light Count_ä¹Ÿå°±æ²¡ç”¨äº†ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085745459-1157598431.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085746437-849874847.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>many lights, deferred vs. forward.</a></i></center> </font><p><em>å¤šä¸ªå®æ—¶å…‰æºï¼Œä¹Ÿå¯ä»¥ç”¨bakeæ›¿ä»£ã€‚</em></p><h3 id="å…‰æºå¦‚ä½•æ¸²æŸ“åˆ†æ">å…‰æºå¦‚ä½•æ¸²æŸ“åˆ†æ</h3><p>å…‰æœ¬èº«æ˜¯å¦‚ä½•æ¸²æŸ“çš„ï¼Ÿ</p><p>1ã€directionalæ–¹å‘å…‰ï¼Œå®ƒè¢«æ¸²æŸ“æˆä¸€ä¸ªé¢ç‰‡(Quad)è¦†ç›–æ•´ä¸ªå±å¹•ï¼Œä½¿ç”¨_Internal-DeferredShading_ shaderå®Œæˆæ¸²æŸ“.</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085747037-32153529.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>directional lights use a quad.</a></i></center> </font><p>è¯¥shaderä½¿ç”¨äº†_UnityDeferredLibrary.cginc_çš„UnityDeferredCalculateLightParamså‡½æ•°è®¡ç®—å…‰ç…§ã€‚</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    **å¯¹äºSpotLightã€PointLightç±»ä¼¼ï¼Œä¸åŒåœ¨äºå®ƒæœ‰è‡ªèº«çš„ç…§æ˜èŒƒå›´ã€‚**
</code></pre></div></div><p>2ã€SpotLighté¦–å…ˆè¦æ¸²æŸ“æˆä¸€ä¸ªç±»ä¼¼é‡‘å­—å¡”ä½“Meshã€‚</p><p>é¦–å…ˆï¼Œä½¿ç”¨Internal-StencilWrite shaderæ¸²æŸ“è¯¥é‡‘å­—å¡”Meshå¹¶å†™å…¥<strong>æ¨¡æ¿ç¼“å†²</strong>åŒºï¼›<br /> ç„¶åï¼Œç”¨è¯¥ç¼“å†²åŒºä¸ç¨åå°†æ¸²æŸ“çš„ç‰‡å…ƒæ¯”å¯¹ï¼Œæ˜¯å¦è¦<strong>å±è”½</strong>ä½“ç§¯èŒƒå›´å¤–çš„ç‰‡å…ƒå…‰ç…§è®¡ç®—ã€‚<br /> <strong>ç›®çš„</strong>ï¼šå¤„äºä½“ç§¯èŒƒå›´å†…çš„ç‰‡å…ƒå°†è¢«è®¡ç®—å…‰ç…§ã€é˜´å½±ï¼Œä½“ç§¯èŒƒå›´å¤–çš„ä¸éœ€è¦è®¡ç®—ï¼Œå¦‚æœè¿™ä¸ªé‡‘å­—å¡”å†…ä¸€ä¸ªç‰‡å…ƒè¢«æ¸²æŸ“ï¼Œå®ƒä¼šæ‰§è¡Œå…‰ç…§è®¡ç®—ã€‚é˜²æ­¢é‚£äº›ä¸å¿…è¦çš„å…‰ç…§è®¡ç®—é™ä½å¼€é”€ã€‚<br /> <strong>åŸå› </strong>ï¼šå…‰çº¿æ— æ³•åˆ°è¾¾é‚£é‡Œã€‚<br /> <strong>æ³¨æ„</strong>ï¼Œå½“å…‰çš„ä½“ç§¯ä¸ç›¸æœºçš„è¿‘å¹³é¢ç›¸äº¤åˆ™è¯¥æ–¹æ³•å¤±æ•ˆã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085747661-944531804.png" width="250" alt="loading failed, need vpn." /></center><p>3ã€PointLightä½¿ç”¨ç±»ä¼¼æ–¹æ³•ï¼ŒåŒºåˆ«åœ¨äºå®ƒè¢«æ¸²æŸ“æˆçƒä½“Meshã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085748333-84112664.png" width="250" alt="loading failed, need vpn." /></center><h3 id="åˆ†æä»€ä¹ˆæ˜¯g-buffers">åˆ†æä»€ä¹ˆæ˜¯G-Buffers</h3><p>ç¼“å­˜æ•°æ®çš„ç¼ºç‚¹å°±æ˜¯è¦å­˜å‚¨ã€‚deferredæ¸²æŸ“ä½¿ç”¨äº†multiple render textureå®ç°(MRT)ï¼Œè¿™äº›çº¹ç†å°±æ˜¯G-buffersã€‚</p><p><strong>deferredè¦æ±‚4ä¸ªG-Buffersï¼Œåˆå¹¶åæ¯ä¸ªåƒç´ æ€»ä½æ•°ï¼šLDR160ä½ï¼ŒHDR192ä½ã€‚è¿™æ¯”èµ·32ä½å¤§å¤šäº†ï¼Œæ‰€ä»¥å¯¹äºç§»åŠ¨GPUæœ‰é™åˆ¶ï¼Œæ¡Œé¢åˆ™æ²¡é—®é¢˜ã€‚</strong></p><p><strong>æ˜¯å“ªå››ä¸ªçº¹ç†ï¼Ÿ</strong></p><p>æ‰“å¼€frame Debuggeræˆ–ç‚¹å‡»Scene/top leftä¸‹æ‹‰èœå•é€‰æ‹©Deferredé€‰é¡¹</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085748906-1729642644.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085749514-1177384899.png" width="250" alt="loading failed, need vpn." /></center><p>Albedo-å¯¹åº”RT0ï¼›å…¸å‹ä»£è¡¨diffuse color<br /> Specularâ€“å¯¹åº”RT1ï¼›å…¸å‹ä»£è¡¨specular + roughness<br /> Normal-å¯¹åº”RT2ï¼›å…¸å‹ä»£è¡¨normals<br /> Emissionâ€“å¯¹åº”RT3ï¼›å…¸å‹ä»£è¡¨emission + reflection</p><h3 id="æ··åˆä½¿ç”¨deferredä¸forwardæ¸²æŸ“æ¨¡å‹">æ··åˆä½¿ç”¨Deferredä¸Forwardæ¸²æŸ“æ¨¡å‹</h3><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085750340-1204540914.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085751182-1595821136.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>åˆ†æfreamDebugger.</a></i></center> </font><p>é¦–å…ˆï¼Œæ‰§è¡Œdeferredæ¸²æŸ“G-bufferï¼Œæ•°æ®å­˜åˆ°G-bufferç¼“å†²åŒºã€‚åœ¨è¿™æ¸²æŸ“æœŸé—´ï¼Œforwardæ¨¡å¼ä¸‹çš„ç‰©ä½“ä¸å‚ä¸æ¸²æŸ“ï¼Œä¸å¯è§ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085751737-547155192.png" width="250" alt="loading failed, need vpn." /></center> <center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085752276-673585314.png" width="250" alt="loading failed, need vpn." /></center><p>æ¥ç€ï¼Œæ¸²æŸ“forward depthï¼ŒåŒæ ·å­˜åˆ°G-bufferç¼“å†²åŒºã€‚ç”±äºæ˜¯forwardæ‰€ä»¥è¾“å‡ºé»‘è‰²è½®å»“ï¼Œè¦†ç›–äº†ä¹‹å‰çš„ç‰‡å…ƒã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085752842-152103750.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085753560-1117632710.png" width="250" alt="loading failed, need vpn." /></center><h2 id="å¼€å§‹å†™deferred-shader">å¼€å§‹å†™Deferred Shader</h2><p>å¢åŠ ä¸€ä¸ªPassï¼ŒæŒ‡å®šå…‰ç…§æ ‡ç­¾Light Mode = â€œDeferredâ€ï¼Œpassçš„é¡ºåºä¸é‡è¦ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Pass</span> <span class="p">{</span>
    <span class="n">Tags</span> <span class="p">{</span>
        <span class="s">"LightMode"</span> <span class="o">=</span> <span class="s">"Deferred"</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085754350-329303799.png" width="250" alt="loading failed, need vpn." /></center><p>å®Œæ•´ç‰ˆçš„ç€è‰²</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Pass</span> <span class="p">{</span>
    <span class="n">Tags</span> <span class="p">{</span>
        <span class="s">"LightMode"</span> <span class="o">=</span> <span class="s">"Deferred"</span>
    <span class="p">}</span>

    <span class="n">CGPROGRAM</span>

    <span class="cp">#pragma target 3.0
</span>    <span class="cp">#pragma exclude_renderers nomrt//ï¼ˆå¯¹äºä¸æ”¯æŒMRTè®¾å¤‡ç¦ç”¨è¯¥passï¼‰
</span>
    <span class="cp">#pragma shader_feature _ _RENDERING_CUTOUT
</span>    <span class="cp">#pragma shader_feature _METALLIC_MAP
</span>    <span class="cp">#pragma shader_feature _ _SMOOTHNESS_ALBEDO _SMOOTHNESS_METALLIC
</span>    <span class="cp">#pragma shader_feature _NORMAL_MAP
</span>    <span class="cp">#pragma shader_feature _OCCLUSION_MAP
</span>    <span class="cp">#pragma shader_feature _EMISSION_MAP
</span>    <span class="cp">#pragma shader_feature _DETAIL_MASK
</span>    <span class="cp">#pragma shader_feature _DETAIL_ALBEDO_MAP
</span>    <span class="cp">#pragma shader_feature _DETAIL_NORMAL_MAP
</span>
    <span class="cp">#pragma vertex MyVertexProgram
</span>    <span class="cp">#pragma fragment MyFragmentProgram
</span>
    <span class="cp">#define DEFERRED_PASS
</span>
    <span class="cp">#include</span> <span class="cpf">"MyLighting_SemitransparencyShadow.cginc"</span><span class="cp">
</span>
    <span class="n">ENDCG</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="4ä¸ªg-bufferè¾“å‡º">4ä¸ªg-bufferè¾“å‡º</h3><p>è¦å¡«å……4ä¸ªç¼“å†²åŒºéœ€è¦ä¸ºFragmentæ”¯æŒä¸¤ç§è¾“å‡ºæ ¼å¼ï¼›ç„¶åä¿®æ”¹Fragmentå‡½æ•°è¿”å›å€¼ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">FragmentOutput</span> <span class="p">{</span>
<span class="cp">#ifdef DEFERRED_PASS
</span>    <span class="kt">float4</span> <span class="n">gBuffer0</span> <span class="o">:</span> <span class="n">SV_TARGET0</span><span class="p">;</span>
    <span class="kt">float4</span> <span class="n">gBuffer1</span> <span class="o">:</span> <span class="n">SV_TARGET1</span><span class="p">;</span>
    <span class="kt">float4</span> <span class="n">gBuffer2</span> <span class="o">:</span> <span class="n">SV_TARGET2</span><span class="p">;</span>
    <span class="kt">float4</span> <span class="n">gBuffer3</span> <span class="o">:</span> <span class="n">SV_TARGET3</span><span class="p">;</span>
<span class="cp">#else
</span>    <span class="kt">float4</span> <span class="n">color</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">;</span>
<span class="cp">#endif
</span><span class="p">};</span>

<span class="n">FragmentOutput</span> <span class="nf">MyFragmentProgram</span><span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">){</span>
    <span class="n">FragmentOutput</span> <span class="n">output</span><span class="p">;</span>
    <span class="n">UNITY_INITIALIZE_OUTPUT</span><span class="p">(</span><span class="n">FragmentOutput</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span><span class="c1">//ä¸åŠ è¿™å¥ä¼šæœ‰warning</span>
    <span class="cp">#ifdef DEFERRED_PASS
</span>    <span class="cp">#else
</span>        <span class="n">output</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
    <span class="cp">#endif
</span>    <span class="k">return</span> <span class="n">output</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="è®¡ç®—buffer-0">è®¡ç®—Buffer 0</h3><p>è¯¥g-Bufferä¸€èˆ¬ç”¨æ¥è®¡ç®—diffuse albedoå’Œsurface occlusionï¼Œè¿™æ˜¯ARGB32æ ¼å¼çº¹ç†ã€‚</p><p><strong>diffuseå­˜åœ¨RGBé€šé“ï¼Œocclusionå­˜åœ¨Aé€šé“</strong>ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if defined(DEFERRED_PASS)
</span>    <span class="n">output</span><span class="p">.</span><span class="n">gBuffer0</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">albedo</span><span class="p">;</span>
    <span class="n">output</span><span class="p">.</span><span class="n">gBuffer0</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">GetOcclusion</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="cp">#else
</span></code></pre></div></div><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085755050-910260994.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085755657-1285744974.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>Albedo and occlusion.</a></i></center> </font><h3 id="è®¡ç®—buffer-1">è®¡ç®—Buffer 1</h3><p>è¯¥g-Bufferä¸€èˆ¬ç”¨æ¥è®¡ç®—specular albedoå’Œsmoothnessï¼Œä¹Ÿæ˜¯ARGB32æ ¼å¼çº¹ç†ã€‚</p><p><strong>specularå­˜åœ¨RGBé€šé“ï¼Œsmoothnesså€¼å­˜åœ¨Aé€šé“</strong>ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">output</span><span class="p">.</span><span class="n">gBuffer1</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">specularTint</span><span class="p">;</span>
<span class="n">output</span><span class="p">.</span><span class="n">gBuffer1</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">GetSmoothness</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</code></pre></div></div><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085756307-1469309635.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200511085756898-570367115.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>Specular color and smoothness.</a></i></center> </font><h3 id="è®¡ç®—buffer-2">è®¡ç®—Buffer 2</h3><p>è¯¥g-BufferåŒ…å«äº†ä¸–ç•Œç©ºé—´æ³•çº¿å‘é‡ï¼Œå­˜åœ¨RGBé€šé“ï¼Œæ˜¯ä¸€ä¸ªARGB2101010æ ¼å¼çº¹ç†ã€‚Alphaå 2ä½ï¼ŒRGBå„å 10ä½ã€‚è¿™æ„å‘³ç€è¯¥å‘é‡çš„æ¯ä¸ªæ ‡é‡å 10bitsè€Œä¸æ˜¯ä¹‹å‰çš„8ä½ï¼Œä¹Ÿå°±æœ‰æ›´ç²¾ç¡®ã€‚alphaé€šé“ä¸ç”¨ï¼Œé»˜è®¤ä½1.</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">output</span><span class="p">.</span><span class="n">gBuffer2</span> <span class="o">=</span> <span class="kt">float4</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></div></div><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200512095715198-211370403.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200512095716344-858855160.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>Normals.</a></i></center> </font><h3 id="è®¡ç®—buffer-3">è®¡ç®—Buffer 3</h3><p>è¯¥g-Bufferè¢«ç”¨æ¥è®¡ç®—åœºæ™¯å…‰ç…§ï¼Œçº¹ç†æ ¼å¼ä¾èµ–äºç›¸æœºè®¾ç½®çš„HDRæˆ–LDRã€‚LDRæ˜¯ARGB2101010æ ¼å¼ã€‚HDRæ˜¯ARGBHalfæ ¼å¼ï¼Œæ¯ä¸ªé€šé“å­˜å‚¨16ä½å•ç²¾åº¦æµ®ç‚¹æ•°ï¼Œå…±64ä½ã€‚å› æ­¤HDRç‰ˆæœ¬æ¯”å…¶ä»–bufferså¤§ä¸¤å€å†…å­˜ã€‚åªç”¨åˆ°äº†RGBï¼ŒAlphaé»˜è®¤ä¸º1ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">output</span><span class="p">.</span><span class="n">gBuffer3</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
</code></pre></div></div><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200512095717065-134464069.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>é”™è¯¯çš„emission.</a></i></center> </font><p>ä¸Šé¢ä½¿ç”¨çš„coloré¢œè‰²å·²è®¡ç®—è¿‡é˜´å½±ï¼Œéœ€è¦ä½¿ç”¨DEFRRED_PASSé‡æ–°è®¡ç®—ï¼›åŒæ—¶å…³é—­<code class="language-plaintext highlighter-rouge">light.ndotlè®¡ç®—ï¼›åœ¨GetEmissionä¹Ÿè¦ä½¿ç”¨DEFRRED_PASSæ ‡ç­¾</code></p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">output</span><span class="p">.</span><span class="n">gBuffer3</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>

<span class="n">UnityLight</span> <span class="nf">CreateLight</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UnityLight</span> <span class="n">light</span><span class="p">;</span>
    <span class="cp">#if defined(DEFERRED_PASS)
</span>        <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="cp">#else
</span>        <span class="c1">//...        </span>
    <span class="cp">#endif
</span>    <span class="o">~</span><span class="n">light</span><span class="p">.</span><span class="n">ndotl</span> <span class="o">=</span> <span class="n">DotClamped</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">light</span><span class="p">.</span><span class="n">dir</span><span class="p">);</span><span class="o">~</span>
    <span class="k">return</span> <span class="n">light</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float3</span> <span class="nf">GetEmission</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="cp">#if defined(FORWARD_BASE_PASS) || defined(DEFERRED_PASS)
</span>        <span class="err">â€¦</span>
    <span class="cp">#else
</span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="cp">#endif
</span><span class="p">}</span>
</code></pre></div></div><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200512095717626-627650926.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>é”™è¯¯çš„emission.</a></i></center> </font><h3 id="ambient-light">Ambient Light</h3><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200513022711223-338108844.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>four buffers shading.</a></i></center> </font><p>è¾“å‡ºå››ä¸ªBuffersåç»“æœçœ‹èµ·æ¥è¾ƒå¥½ï¼Œä½†æ˜¯è¿˜ä¸å¤Ÿå®Œæ•´ï¼Œè¿˜ç¼ºå°‘ç¯å¢ƒå…‰ã€‚<strong>ç¯å¢ƒå…‰ä¸è‡ªå‘å…‰éƒ½æ²¡æœ‰å•ç‹¬çš„passè®¡ç®—ï¼Œéƒ½éœ€è¦åœ¨g-bufferså¡«å……åé™„åŠ åˆ°æœ€ç»ˆé¢œè‰²å€¼ä¸Šã€‚</strong>ç¯å¢ƒå…‰æ˜¯é—´æ¥å…‰ï¼Œåœ¨é—´æ¥å…‰å‡½æ•°è®¡ç®—DEFERRED_PASS</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200513022711963-2074230932.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>four buffers shading.</a></i></center> </font><h3 id="å…‰æºèŒƒå›´-ldrä¸hdråˆ†æ">å…‰æºèŒƒå›´-LDRä¸HDRåˆ†æ</h3><p>å¯¹äºInternal-DeferredShading shaderï¼ŒCameraç»„ä»¶å¯ç”¨æˆ–å…³é—­HDRï¼š</p><p>å¯ç”¨HDRï¼Œåˆ™ä¸æ‰§è¡Œpass 1ï¼Œpass 0 fragmentè¿”å›half4ç²¾åº¦ï¼Œçº¹ç†æ ¼å¼ARGBHalfã€‚æ¯ä¸ªé€šé“å­˜å‚¨16ä½å•ç²¾åº¦æµ®ç‚¹æ•°ï¼Œæ€»å…±64ä½ã€‚</p><p>å…³é—­HDRåï¼Œä½¿ç”¨LDRè®¡ç®—ç­–ç•¥ã€‚åœ¨pass 0 fragmentä¼šè¿”å›fixedç²¾åº¦ï¼Œä½¿ç”¨exp2(x)_[exp2(x)=2-x]_å¯¹æ•°ç¼–ç lightBufferï¼Œè·å–åˆ°æ›´å¤§çš„é¢œè‰²èŒƒå›´ï¼›pass 1åˆ™ä½¿ç”¨logå¯¹æ•°è§£ç bufferæ•°æ®åˆ°ä¸»çº¹ç†ä¸Šï¼Œçº¹ç†æ ¼å¼ä¸ºARGB2101010ã€‚Alphaå 2ä½ï¼ŒRGBå„å 10ä½ã€‚</p><h3 id="hdr-ä¸-ldr">HDR ä¸ LDR</h3><p>å¼€å¯HDRæ¨¡å¼ä¸‹ï¼ŒDeferredä¸Forwardç€è‰²æ•ˆæœå‡ ä¹ç›¸ä¼¼ã€‚ä½†æ˜¯åœ¨LDRæ¨¡å¼ä¸‹ï¼ŒDeferredç€è‰²å°±æ˜¯é”™è¯¯çš„ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200513022712610-2058578821.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>incorrect shading in LDR Mode.</a></i></center> </font><p>åœ¨ä¸Šå›¾æè¿°ä¸­ï¼ŒUnityä¼šä½¿ç”¨exp2(x)ç¼–ç LDRæ•°æ®ï¼Œæ‰€ä»¥å¯¹è‡ªå‘å…‰å’Œç¯å¢ƒå…‰ä¹Ÿè¦ä½¿ç”¨exp2(x)ç¼–ç ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200513022713171-753954029.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>incorrect shading in LDR Mode.</a></i></center> </font><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma multi_compile _ UNITY_HDR_ON
</span>
<span class="cp">#if defined(DEFERRED_PASS)
</span>    <span class="cp">#if !defined(UNITY_HDR_ON)
</span>        <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="nb">exp2</span><span class="p">(</span><span class="o">-</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">);</span>
    <span class="cp">#endif
</span>    <span class="err">â€¦</span>
<span class="cp">#else
</span>    <span class="n">output</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
<span class="cp">#endif
</span></code></pre></div></div><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200513022713922-1209753322.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>use exp2(x) and log in LDR.</a></i></center> </font><h2 id="deferred-reflections">Deferred Reflections</h2><p>å±•ç¤ºä¸åŒæ¸²æŸ“æ¨¡å¼ä¸‹çš„ï¼Œæ¢é’ˆç…§å°„åŒºåŸŸè¿‡æ¸¡å¯¹æ¯”ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†æ¯ä¸ªåå°„å¯æ··åˆå¤šä¸ªåå°„æ¢é’ˆã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200515120606250-2021680703.png" width="250" alt="loading failed, need vpn." /></center> <center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200515120607116-2089631344.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200515120608003-761474677.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>forward vs. deferred mode.</a></i></center> </font><h3 id="é€åƒç´ ç…§å°„">é€åƒç´ ç…§å°„</h3><p>å»¶è¿Ÿæ¨¡å¼çš„ä¸åŒä¹‹å¤„åœ¨äºï¼šæ¢æµ‹ä¸ä¼šé’ˆå¯¹æ¯ä¸ªå¯¹è±¡è¿›è¡Œæ··åˆã€‚è€Œæ˜¯æŒ‰åƒç´ æ··åˆçš„ã€‚è¿™æ˜¯ç”±internal-deferred shaderå®Œæˆè®¡ç®—ã€‚å›¾3å³å¾ˆæ˜æ˜¾ï¼Œå¤§åœ°æ¿é•œå­ï¼Œå»¶ä¼¸åˆ°ç»“æ„ä¹‹å¤–åï¼Œå®ƒçš„æ¸²æŸ“èŒƒå›´å¾ˆå°ã€‚</p><p><strong>Forwardæ¨¡å¼ä¸‹ï¼š</strong><br /> åœ°æ¿è¢«è¿«åœ¨æ•´ä¸ªè¡¨é¢ä½¿ç”¨reflectionæ¢å¤´ã€‚ç»“æœï¼ŒboxProjectionæ¢å°„åˆ°çš„æŠ•å½±åœ¨boxå¤–é¢ä¹Ÿæ˜¾ç¤ºã€‚ä¹Ÿèƒ½çœ‹è§å®ƒå’Œå…¶ä»–æ¢é’ˆæ··åœ¨ä¸€èµ·ã€‚å›¾3å·¦ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200515120608590-1131496695.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>forward reflection probes.</a></i></center> </font><p>Deferredæ¨¡å¼ä¸‹ï¼š<br /> reflectionåªæ¸²æŸ“box sizeèŒƒå›´ï¼Œæ¢å°„çš„èŒƒå›´è¢«æŠ•å°„åˆ°ä¸boxProjectionç›¸äº¤çš„é¢ç§¯ã€‚æ‰€ä»¥reflectionçš„åå°„ä¸ä¼šè¶…å‡ºç»™å®šBoxSizeèŒƒå›´ã€‚å®é™…ä¸Šï¼Œè¾¹ç¼˜æ¶ˆå¤±çš„æ—¶å€™ä¹Ÿä¼šå»¶ä¼¸ä¸€ç‚¹ã€‚å…¶ä»–ä¸¤ä¸ªæ¢å¤´ä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200515120609178-2053336560.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>deferred reflection probes.</a></i></center> </font><p>æ¸²æŸ“reflectionæ‰€ç”¨æ–¹æ³•ï¼Œä¸æ¸²æŸ“lightsç±»ä¼¼ï¼š<br /> é¦–å…ˆï¼Œä½¿ç”¨Internal-StencilWrite shaderæ¸²æŸ“box sizeå¤§å°çš„Meshå¹¶å†™å…¥<strong>æ¨¡æ¿ç¼“å†²</strong>åŒºï¼›<br /> ç„¶åï¼Œç”¨è¯¥ç¼“å†²åŒºä¸ç¨åå°†æ¸²æŸ“çš„ç‰‡å…ƒæ¯”å¯¹ï¼Œæ˜¯å¦è¦<strong>å±è”½</strong>ä½“ç§¯èŒƒå›´å¤–çš„ç‰‡å…ƒã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200516113835823-536491925.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200516113836571-1742764446.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>Draw deferred reflections.</a></i></center> </font> <center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200516113837105-1079901044.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>Importance.</a></i></center> </font><p>Importanceå†³å®šå„reflectionçš„æ¸²æŸ“å…ˆåé¡ºåºï¼›Intensityå†³å®šäº†åå°„å¼ºåº¦ï¼šé»˜è®¤ä¸º1ï¼Œæœ€å°ä¸º0ï¼Œå¤§äº1è¿‡æ›ã€‚Forwardä¸‹æ˜¯æ•´ä¸ªæ¥æ”¶é¢ç§¯ï¼›Deferredä¸‹æ˜¯ç›¸äº¤é¢ç§¯ã€‚ä¸‹é¢è°ˆBlend Distanceã€‚</p><h3 id="blend-distance">Blend Distance</h3><p>Deferredä¸‹æ¢é’ˆä½“ç§¯è¾¹ç¼˜æœ‰è¿‡æ¸¡æ··åˆï¼Œç”±Blend Distanceå†³å®šã€‚è¯¥å€¼é»˜è®¤ä¸º1ï¼Œåªæœ‰Deferredæ¨¡å¼å¯è°ƒã€‚</p><p>å¤šä¸ªprobesç›¸äº¤æ—¶ï¼Œè¾¹ç¼˜è¿‡æ¸¡æ··åˆéå¸¸æœ‰æ•ˆã€‚ä¹Ÿå¯ä»¥ç”¨æ¥å¢å¤§æ¢å°„ä½“ç§¯èŒƒå›´ã€‚</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200516113839245-749750193.gif" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>blend distance gif.</a></i></center> </font><h3 id="deferred-passä¸‹çš„åå°„">Deferred Passä¸‹çš„åå°„</h3><p>è™½ç„¶deferredå¾ˆæœ‰æ•ˆï¼Œå¹¶ä¸”æ¯ä¸ªç‰©ä½“å¯ä»¥æ··åˆä¸¤ä¸ªä»¥ä¸Šçš„æ¢é’ˆã€‚</p><p>ä¹Ÿæœ‰<strong>ç¼ºç‚¹</strong>ï¼šä¸èƒ½ä½¿ç”¨é”šé‡å†™æ¥å¼ºåˆ¶å¯¹è±¡ä½¿ç”¨ç‰¹å®šçš„åå°„æ¢æµ‹ã€‚æœ‰æ—¶è¿™æ˜¯ç¡®ä¿å¾—åˆ°æ­£ç¡®åå°„çš„å”¯ä¸€æ–¹æ³•ã€‚å¯ä»¥å…ˆç¦ç”¨å†…ç½®Deferred Refelectionï¼Œ</p><p>æ‰“å¼€frame DebuggeræŸ¥çœ‹G-Buffers RT3ï¼ŒåŒ…å«äº†Emissionå’ŒRefelection</p><center class="half"><img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200516113840651-738922493.png" width="250" alt="loading failed, need vpn." /> <img id="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender13/1692664-20200516113841329-1065907482.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>Importance.</a></i></center> </font><p>é‡‡æ ·é»‘è‰²æ¢é’ˆæ˜¯æµªè´¹ã€‚è¦ç¡®ä¿deferred passåªåœ¨æœ‰éœ€è¦æ—¶é‡‡æ ·ï¼Œç”¨UNITY_ENABLE_REFLECTION_BUFFERSæ¥æ£€æŸ¥ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UnityIndirect</span> <span class="nf">CreateIndirectLight</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">viewDir</span><span class="p">)</span> <span class="p">{</span>
    <span class="cp">#if defined(FORWARD_BASE_PASS) || defined(DEFERRED_PASS)
</span>        <span class="cp">#if defined(DEFERRED_PASS) &amp;&amp; UNITY_ENABLE_REFLECTION_BUFFERS
</span>            <span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="cp">#endif
</span>    <span class="cp">#endif
</span>    <span class="k">return</span> <span class="n">indirectLight</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div></article><hr><div class='like-post'> <a style="color:rgb(112, 40, 85);" id="likeBtn" onclick="likePost(1);"> <i class="fa fa-thumbs-o-up fa-2x" aria-hidden="true"></i> </a> <span id="likeNum">0</span><div class="text-xs text-slate-500 mx-2">çœŸè¯šç‚¹èµï¼Œæ‰‹ç•™ä½™é¦™</div></div><h2 id="similar_posts">Similar Posts</h2><ul><li class="relatedPost"> <a href="/2024/07/10/Unity_Addressable_Editor/">Unity Addressable Editorç»“æ„ </a><li class="relatedPost"> <a href="/2018/01/25/Unity_Parallax_Normals_Heightmap/">è§†å·®å’Œæ³•çº¿ã€é«˜åº¦å›¾å›é¡¾(ç¿»è¯‘äºŒå) </a><li class="relatedPost"> <a href="/2018/01/24/Unity_GPU_Instance/">Unity GPU Instance(ç¿»è¯‘åä¹) </a><li class="relatedPost"> <a href="/2018/01/23/Unity_RealTime_GI_LOD/">Unity å®æ—¶ GI & LPPV & LOD(ç¿»è¯‘åå…«) </a><li class="relatedPost"> <a href="/2018/01/21/Unity_Mix_Lighting/">Unity æ··åˆå…‰ç…§(ç¿»è¯‘åä¸ƒ) </a><li class="relatedPost"> <a href="/2018/01/19/Unity_Static_Lightting/">Unity å…‰ç…§çƒ˜ç„™(ç¿»è¯‘åå…­) </a></ul><div class="post-recent"><div class="pre"><p><strong>ä¸Šä¸€ç¯‡</strong> <a href="/2018/01/09/Unity_Shader_Transparent_2/">Unity é€æ˜æ¸²æŸ“(ç¿»è¯‘åäºŒ)</a></p></div><div class="nex"><p><strong>ä¸‹ä¸€ç¯‡</strong> <a href="/2018/01/15/Unity_Shader_Fog/">Unity Shader Fog(ç¿»è¯‘åå››)</a></p></div></div><h2 id="comments">Comments</h2><div id="vcomments"></div><script type="text/javascript"> /*è¯„è®ºç›¸å…³*/ function delayLoadValine() { new Valine({ el: '#vcomments', verify: "true", notify: "false", app_id: "JgYk2pcFa3QxhhWPhDjjoPvv-MdYXbMMI", app_key: "fjDLTSUgCNGrSKgCID672IJx", avatar: "monsterid", placeholder: "æ¬¢è¿è¯„è®ºï¼", pageSize: "10 || 10", master: "b5586e582cb181c6b0fc8b2ce828bd50", tagMeta: ["åšä¸»","å°ä¼™ä¼´","è®¿å®¢"], enableQQ: true, requiredFields: [], serverURLs: "https://leanapi.damonc.top", recordIP: "true", visitor: "true", }); $(document).ready(function(){ fetch('https://v1.hitokoto.cn/') .then(response => response.json()) .then(data => { document.getElementById("veditor").setAttribute( "placeholder", data.hitokoto+"â€”"+data.from ); setTimeout(() => { addPostVisitedTimes(); }, 1000); } ) .catch(console.error); }); } /*ç‚¹èµç›¸å…³*/ var curIpVisitRecord = null; var curPost = null; var curUrl = "https://www.damonc.top/2018/01/10/Unity_Deferred_Shading/"; function getVisitorIpAndJudge() { $.getJSON('https://api.ipify.org?format=json', function(data){ saveOrUpdateIpRecord(data.ip) }); } function saveOrUpdateIpRecord(ip) { var Visitor = AV.Object.extend("visitors_record"); var post_url = curUrl; var query = new AV.Query(Visitor); query.equalTo("visitor_ip", ip); query.equalTo("post_url", post_url); query.find().then(function(results) { if (results.length > 0) { /* if(window.console){ console.log('è¯¥IPå·²è®¿é—®è¿‡è¯¥æ–‡ç« '); }*/ curIpVisitRecord = results[0]; updateIpRecord(); refreshLikeBtn(); } else { /*if(window.console){ console.log('è¯¥IPç¬¬ä¸€æ¬¡è®¿é—®è¯¥æ–‡ç« ï¼Œä¿å­˜æ–°çš„è®¿é—®è®°å½•ï¼Œå¹¶å¢åŠ è®¿é—®æ¬¡æ•°'); }*/ addNewIpRecord(ip, post_url); } }, function(error) { addPostVisitedTimes(); }); } function addPostVisitedTimes() { var AV_Posts = AV.Object.extend("Posts"); var url = curUrl; var title = "Unity Shader å»¶è¿Ÿæ¸²æŸ“(ç¿»è¯‘åä¸‰)"; var query = new AV.Query(AV_Posts); query.equalTo("post_url", url); query.find().then(function(results) { if (results.length > 0) { curPost = results[0]; curPost.increment("visited_times"); curPost.save(); loadLikeNums(); } else { curPost = new AV_Posts(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); curPost.setACL(acl); /* End Set ACL */ curPost.set("post_title", title); curPost.set("post_url", url); curPost.set("visited_times", 1); curPost.set('like_times', 0); curPost.save(); } getVisitorIpAndJudge(); }, function(error) { console.log('Error:' + error.code + " " + error.message); }); } function showPostVisitedTimes() { var AV_Posts = AV.Object.extend("Posts"); var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(AV_Posts); query.equalTo("post_url", url); query.find().then(function(results) { if (results.length > 0) { curPost = results[0]; loadLikeNums(); } else { /*if(window.console){ console.log('å¼‚å¸¸æƒ…å†µï¼Œä¸åº”è¯¥æ²¡è®°å½•çš„'); }*/ } }, function(error) { console.log('Error:' + error.code + " " + error.message); }); } function updateIpRecord(){ var lastTime = curIpVisitRecord.updatedAt; var curTime = new Date(); var timePassed = curTime.getTime() - lastTime.getTime(); if(timePassed > 300000) { /*if(window.console){ console.log('è·ç¦»è¯¥IPä¸Šä¸€æ¬¡è®¿é—®è¯¥æ–‡ç« å·²è¶…è¿‡äº†5åˆ†é’Ÿï¼Œæ›´æ–°è®¿é—®è®°å½•ï¼Œå¹¶å¢åŠ è®¿é—®æ¬¡æ•°'); }*/ addPostVisitedTimes(); curIpVisitRecord.save(); } else { /*console.log('è¿™æ˜¯è¯¥IP 1åˆ†é’Ÿå†…é‡å¤è®¿é—®è¯¥æ–‡ç« ï¼Œä¸æ›´æ–°è®¿é—®è®°å½•ï¼Œä¸å¢åŠ è®¿é—®æ¬¡æ•°');*/ } } function addNewIpRecord(ip, post_url){ var Visitor = AV.Object.extend("visitors_record"); curIpVisitRecord = new Visitor(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); curIpVisitRecord.setACL(acl); curIpVisitRecord.set("visitor_ip", ip); curIpVisitRecord.set("post_url", post_url); curIpVisitRecord.set("like_this_post", 0); curIpVisitRecord.save(); } function loadLikeNums() { var likeTimes = curPost.get('like_times'); $("#likeNum").text(likeTimes); } function refreshLikeBtn() { var likeState = curIpVisitRecord.get('like_this_post'); if(likeState == 1){ $("#likeBtn").css("color", "red"); $("#likeBtn").attr("onclick", "likePost(-1)"); } else { $("#likeBtn").css("color", "rgb(112, 40, 85)"); $("#likeBtn").attr("onclick", "likePost(1)"); } loadLikeNums(); } function likePost(type) { if(curPost == null || curIpVisitRecord == null) { alert('å»¶è¿Ÿ10såæ‰èƒ½ç‚¹èµ, è¯·ç¨ç­‰...'); return } var newNum; var getlikeTime = curPost.get('like_times'); if(typeof getlikeTime == "undefined" || getlikeTime == null || getlikeTime == "") { newNum = parseInt(type); }else{ newNum = parseInt(type) + parseInt(getlikeTime); } curPost.set('like_times', newNum); curPost.save().then(function(curPost){ var likeThisPost = type == -1 ? 0 : 1; curIpVisitRecord.set("like_this_post", likeThisPost); curIpVisitRecord.save().then(function(){ refreshLikeBtn(); }); },function(error){ console.log('Failed to create visitor record, with error message: ' + error.message); }); } /*å¯åŠ¨æ‰§è¡Œ*/ setTimeout(() => { delayLoadValine(); }, 10000); </script></div></div><script> /** * target _blank */ (function() { var aTags = document.querySelectorAll('article a:not([id])'); for (var i = 0; i < aTags.length; i++) { var htps = aTags[i].href; if (htps.startsWith("https://")) aTags[i].setAttribute('target', '_blank'); } }()); </script> <script src="/js/pageContent.js " charset="utf-8"></script><footer class="site-footer"><div class="wrapper"><p class="description"> äº‘ä¸Šçš„æ—¥å­!</p><p class="contact"> <a href="https://github.com/bitfeng" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a> <a href="mailto:damonc@126.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></p><p> æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡ï¼Œæœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡ï¼Œæœ¬æ–‡æ€»é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡</p></div></footer><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="back-to-top"> <a href="#top" data-scroll> <i class="fa fa-arrow-up" aria-hidden="true"></i> </a></div><script src=" /js/main.js " charset="utf-8"></script> <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script> <script type="text/javascript"> smoothScroll.init({ speed: 500, easing: 'easeInOutCubic', offset: 20, }); function displayWindowSize() { var w = document.documentElement.clientWidth; var h = document.documentElement.clientHeight; var rightDiv = document.querySelector('.right'); var footer = document.querySelector('.site-footer'); if(!rightDiv || !footer){ return; } if(w <= 1700){ rightDiv.style.display='none'; footer.style.display='none'; }else{ rightDiv.style.display='block'; footer.style.display = "block"; } } window.addEventListener("resize", displayWindowSize); displayWindowSize(); </script><meta name="viewport" content="width=device-width, initial-scale=1.0"><div id="myModal" class="modal" onclick="closeModal()"> <span class="modal-content"> <img id="modalImg" src="" alt="Modal Image"><div class="prev-div" onclick="prevImage()" ><button class="btn-s prev-btn"></button></div><div class="next-div" onclick="nextImage()" ><button class="btn-s next-btn"></button></div></span></div><script> var currentImageIndex = 0; var images = document.getElementsByTagName("img"); /*ä¸ºæ¯ä¸ªå›¾ç‰‡æ ‡ç­¾æ·»åŠ ç‚¹å‡»äº‹ä»¶*/ for (var i = 0; i < images.length; i++) { if(images[i].id.startsWith("fit-picture")){ images[i].onclick = function () { openModal(this); }; } } /*æ‰“å¼€æ¨¡æ€æ¡†å¹¶æ˜¾ç¤ºæ”¾å¤§çš„å›¾ç‰‡*/ function openModal(img) { var modal = document.getElementById("myModal"); var modalImg = document.getElementById("modalImg"); modal.style.display = "block"; modalImg.src = img.src; } /*å…³é—­æ¨¡æ€æ¡†*/ function closeModal() { var modal = document.getElementById("myModal"); modal.style.display = "none"; } /*ä¸Šä¸€å¼ å›¾ç‰‡*/ function prevImage() { event.stopPropagation(); /*é˜»æ­¢äº‹ä»¶å†’æ³¡*/ currentImageIndex--; if (currentImageIndex < 0) { currentImageIndex = images.length - 1; } var modalImg = document.getElementById("modalImg"); modalImg.src = images[currentImageIndex].src; } /*ä¸‹ä¸€å¼ å›¾ç‰‡*/ function nextImage() { event.stopPropagation(); /*é˜»æ­¢äº‹ä»¶å†’æ³¡*/ currentImageIndex++; if (currentImageIndex >= images.length) { currentImageIndex = 0; } var modalImg = document.getElementById("modalImg"); modalImg.src = images[currentImageIndex].src; } </script>
