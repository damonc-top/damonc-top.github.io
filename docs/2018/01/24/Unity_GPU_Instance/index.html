<!DOCTYPE html><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="baidu-site-verification" content="code-BGVivWGmxV" /><title>Unity GPU Instance(ç¿»è¯‘åä¹)</title><meta name="description" content="æœ¬ç¯‡æ‘˜è¦ï¼š æ¸²æŸ“å¤§é‡çƒä½“-ä¼˜åŒ–DrawCall æ”¯æŒGPU-Instance ä½¿ç”¨æè´¨å±æ€§å— LOD-Groupsæ”¯æŒGPU-Instance"><link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon"><link rel="icon" href="/favicon.ico?" type="image/x-icon"><link rel="stylesheet" href="/css/main.css "><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href=" /css/font_8v3czwksspqlg14i.css "><link rel="canonical" href="https://www.damonc.top/2018/01/24/Unity_GPU_Instance/"><link rel="alternate" type="application/rss+xml" title="çˆ±ç©¿æ‹–é‹" href="https://www.damonc.top/feed.xml "> <script type="text/javascript" src=" /js/jquery_3_2_0.min.js " charset="utf-8"></script> <script type="text/javascript" src=" /js/Valine.min.js " charset="utf-8"></script> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "//hm.baidu.com/hm.js?8c087101d4768b7aa439cef954b30a8f"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> <script> (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-WN45VXRK'); </script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <scrip type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/js-polyfills/0.1.43/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><body class="custom-background"> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WN45VXRK" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><header id="top"><div class="wrapper"> <a href="/" class="brand">çˆ±ç©¿æ‹–é‹</a> <small>è‡ªç”±è‡ªåœ¨ğŸ©´</small> <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button><nav id="headerNav"><ul><li> <a href="/"> <i class="fa fa-home"></i>Home </a><li> <a href="/archive/"> <i class="fa fa-archive"></i>å½’æ¡£ </a><li> <a href="/category/"> <i class="fa fa-th-list"></i>åˆ†ç±» </a><li> <a href="/tag/"> <i class="fa fa-tags"></i>æ ‡ç­¾ </a><li> <a href="/collection/"> <i class="fa fa-bookmark"></i>æ”¶é›† </a><li> <a href="/demo/"> <i class="fa fa-play"></i>å·¥å…· </a><li> <a href="/about/"> <i class="fa fa-heart"></i>About </a></ul></nav></div></header><div class="home-right-bar"> <button class="anchor"><i class="fa fa-anchor"></i></button><div class="right"><div class="wrap"><div class="side content"><div> ç›®å½•</div><ul id="content-side" class="content-ul"><li><a href="#comments">Comments</a></ul></div></div></div></div><div class="page clearfix" post><div class="left"><h1>Unity GPU Instance(ç¿»è¯‘åä¹)</h1><div class="label"><div class="label-card"> <i class="fa fa-calendar"></i>2018-01-24</div><div class="label-card"> <i class="fa fa-user"></i>catlikecoding</div><div class="label-card"></div><div class="label-card"> <span class="categories"> <i class="fa fa-th-list"></i> <a href="/category/#ç¿»è¯‘" title="Category: ç¿»è¯‘" rel="category">ç¿»è¯‘</a> </span></div><div class="label-card"> <span class="pageTag"> <i class="fa fa-tags"></i> <b href="/tag/#Shader" title="Tag: Shader" rel="tag">Shader</b>&nbsp; <b href="/tag/#Unity3d" title="Tag: Unity3d" rel="tag">Unity3d</b> </span></div></div><hr><article itemscope itemtype="http://schema.org/BlogPosting"><ul id="markdown-toc"><li><a href="#batching-instance-æ‰¹å¤„ç†" id="markdown-toc-batching-instance-æ‰¹å¤„ç†">Batching Instance-æ‰¹å¤„ç†</a><ul><li><a href="#åˆ›å»ºå¤§é‡çƒä½“" id="markdown-toc-åˆ›å»ºå¤§é‡çƒä½“">åˆ›å»ºå¤§é‡çƒä½“</a><li><a href="#æ”¯æŒinstance" id="markdown-toc-æ”¯æŒinstance">æ”¯æŒInstance</a><li><a href="#instance-ids" id="markdown-toc-instance-ids">Instance IDs</a><li><a href="#æ‰¹å¤„ç†å¤§å°" id="markdown-toc-æ‰¹å¤„ç†å¤§å°">æ‰¹å¤„ç†å¤§å°</a><li><a href="#instance-shadows" id="markdown-toc-instance-shadows">Instance Shadows</a><li><a href="#å¤šå…‰æº" id="markdown-toc-å¤šå…‰æº">å¤šå…‰æº</a></ul><li><a href="#mixing-material-properties" id="markdown-toc-mixing-material-properties">Mixing Material Properties</a><ul><li><a href="#éšæœºç€è‰²" id="markdown-toc-éšæœºç€è‰²">éšæœºç€è‰²</a><li><a href="#æè´¨å±æ€§å—-material-property-blocks" id="markdown-toc-æè´¨å±æ€§å—-material-property-blocks">æè´¨å±æ€§å—-Material Property Blocks</a><li><a href="#property-buffers-å±æ€§ç¼“å†²åŒº" id="markdown-toc-property-buffers-å±æ€§ç¼“å†²åŒº">Property Buffers-å±æ€§ç¼“å†²åŒº</a><li><a href="#é˜´å½±" id="markdown-toc-é˜´å½±">é˜´å½±</a><li><a href="#lod-instance" id="markdown-toc-lod-instance">LOD Instance</a></ul></ul><p>æœ¬ç¯‡æ‘˜è¦ï¼š</p><ul><li>æ¸²æŸ“å¤§é‡çƒä½“-ä¼˜åŒ–DrawCall<li>æ”¯æŒGPU-Instance<li>ä½¿ç”¨æè´¨å±æ€§å—<li>LOD-Groupsæ”¯æŒGPU-Instance</ul><h2 id="batching-instance-æ‰¹å¤„ç†">Batching Instance-æ‰¹å¤„ç†</h2><p>æŒ‡ç¤ºGPUç»˜åˆ¶éœ€è¦èŠ±æ—¶é—´ï¼›å‘å…¶ä¼ é€’meshå’Œmaterialå±æ€§ä¹Ÿè¦èŠ±æ—¶é—´ã€‚<strong>ç°åœ¨å·²çŸ¥ä¸¤ç§èŠ‚çœDraw Callçš„æ–¹å¼ï¼šstatic</strong>å’Œ<a href="https://docs.unity3d.com/Manual/DrawCallBatching.html"><strong>dynamic batching</strong></a></p><p>Unityå¯ä»¥å°†å¤šä¸ªé™æ€ç‰©ä½“çš„ç½‘æ ¼åˆå¹¶ä¸ºä¸€ä¸ªæ›´å¤§çš„é™æ€ç½‘æ ¼ï¼Œä»è€Œå‡å°‘draw callã€‚ <strong>æ³¨æ„ï¼š</strong> åªæœ‰ä½¿ç”¨ç›¸åŒæè´¨çš„å¯¹è±¡æ‰èƒ½ä»¥è¿™ç§æ–¹å¼ç»„åˆã€‚ è¿™æ˜¯ä»¥å¿…é¡»å­˜å‚¨æ›´å¤šç½‘æ ¼æ•°æ®ä¸ºä»£ä»·çš„ã€‚ å¯ç”¨åŠ¨æ€æ‰¹å¤„ç†åï¼ŒUnityåœ¨è¿è¡Œæ—¶ä¼šå¯¹è§†å›¾ä¸­çš„åŠ¨æ€å¯¹è±¡æ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚ è¿™ä»…é€‚ç”¨äºå°å‹ç½‘æ ¼ç‰©ä½“ï¼Œå¦åˆ™å¼€é”€å°†å˜å¾—å¤ªå¤§ã€‚</p><p>è¿˜æœ‰å¦ä¸€ç§ç»„åˆdraw callçš„æ–¹æ³•ï¼šGPU instanceæˆ–Geometry instanceã€‚ä¸åŠ¨æ€æ‰¹å¤„ç†ä¸€æ ·ï¼Œæ­¤æ“ä½œåœ¨è¿è¡Œæ—¶é’ˆå¯¹å¯è§å¯¹è±¡ã€‚ å®ƒçš„ç›®æ ‡æ˜¯è®©GPUä¸€æ¬¡æ€§æ¸²æŸ“åŒä¸€ç½‘æ ¼çš„å¤šä¸ªå‰¯æœ¬ã€‚ å› æ­¤ï¼Œå®ƒä¸èƒ½ç»„åˆä¸åŒçš„ç½‘æ ¼æˆ–æè´¨ï¼Œä½†ä¸ä»…é™äºå°ç½‘æ ¼ã€‚</p><h3 id="åˆ›å»ºå¤§é‡çƒä½“">åˆ›å»ºå¤§é‡çƒä½“</h3><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">using</span> <span class="n">UnityEngine</span><span class="p">;</span>

<span class="kr">public</span> <span class="k">class</span> <span class="n">GPUInstancingTest</span> <span class="o">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
    <span class="kr">public</span> <span class="n">Transform</span> <span class="n">prefab</span><span class="p">;</span>
    <span class="kr">public</span> <span class="n">int</span> <span class="n">instances</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
    <span class="kr">public</span> <span class="n">float</span> <span class="n">radius</span> <span class="o">=</span> <span class="mi">50</span><span class="n">f</span><span class="p">;</span>
    <span class="c1">//å•ä½åœ†å†…éšæœºä¸€ç‚¹å¹¶æ”¾å¤§åæ ‡50å€ï¼Œç”Ÿæˆ5000ä¸ªçƒä½“</span>
    <span class="c1">//ç„¶åæŸ¥çœ‹statisticsç»Ÿè®¡çš„draw Callä¿¡æ¯</span>
    <span class="kt">void</span> <span class="n">Start</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">instances</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Transform</span> <span class="n">t</span> <span class="o">=</span> <span class="n">Instantiate</span><span class="p">(</span><span class="n">prefab</span><span class="p">);</span>
            <span class="n">t</span><span class="p">.</span><span class="n">localPosition</span> <span class="o">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">insideUnitSphere</span> <span class="o">*</span> <span class="n">radius</span><span class="p">;</span>
            <span class="n">t</span><span class="p">.</span><span class="n">SetParent</span><span class="p">(</span><span class="n">transform</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>ä½¿ç”¨forward render pathç»Ÿè®¡åˆ°çš„draw callï¼Œå»æ‰èƒŒæ™¯å’Œcamera Effectä¸¤ä¸ªdraw callï¼š</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender19/1692664-20200612010902826-821880737.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>5000 draw call.</a></i></center> </font><p>ä½†æ˜¯å½“ä½¿ç”¨cubeä»£æ›¿çƒä½“</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender19/1692664-20200612010904552-338192039.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>6 draw call.</a></i></center> </font><h3 id="æ”¯æŒinstance">æ”¯æŒInstance</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒGPU Instanceä¸ä¼šå¼€å¯ï¼Œå¿…é¡»è®¾è®¡shaderä»¥æ”¯æŒå®ƒã€‚ å³ä½¿è¿™æ ·ï¼Œä¹Ÿå¿…é¡»ä¸ºæ¯ç§ææ–™æ˜¾å¼å¯ç”¨å®ä¾‹åŒ–ã€‚ Unityçš„standardç€è‰²å™¨æœ‰ä¸€ä¸ªå¼€å…³ã€‚åƒæ ‡å‡†ç€è‰²å™¨çš„GUIä¸€æ ·ï¼Œæˆ‘ä»¬å°†ä¸ºshaderæ‰©å±•é¢æ¿åˆ›å»ºâ€œé«˜çº§é€‰é¡¹â€éƒ¨åˆ†ã€‚ å¯ä»¥é€šè¿‡è°ƒç”¨MaterialEditor.EnableInstancingFieldæ–¹æ³•æ¥æ·»åŠ åˆ‡æ¢ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">DoAdvanced</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">GUILayout</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="s">"Advanced Options"</span><span class="p">,</span> <span class="n">EditorStyles</span><span class="p">.</span><span class="n">boldLabel</span><span class="p">);</span>
    <span class="n">editor</span><span class="p">.</span><span class="n">EnableInstancingField</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>ä»…å½“shaderå®é™…æ”¯æŒinstanceæ—¶ï¼Œæ‰ä¼šæ˜¾ç¤ºè¯¥åˆ‡æ¢ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†#pragma multi_compile_instancingæŒ‡ä»¤æ·»åŠ åˆ°ç€è‰²å™¨base-passå¯ç”¨æ­¤æ”¯æŒã€‚ è¿™å°†ä¸ºä¸€äº›å…³é”®å­—å¯ç”¨ç€è‰²å™¨å˜ä½“ï¼Œè‡ªå®šä¹‰å…³é”®å­—_INSTANCING_ON_ï¼Œå…¶ä»–å…³é”®å­—ä¹Ÿå¯ä»¥ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma multi_compile_fwdbase
#pragma multi_compile_fog
#pragma multi_compile_instancing
</span></code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender19/1692664-20200612010905493-1524350499.png" width="250" alt="loading failed, need vpn." /> <img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender19/1692664-20200612010906722-1492830859.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>åˆå¹¶äº†ï¼Œä½†æ˜¯æ˜¾ç¤ºæœ‰é”™è¯¯.</a></i></center> </font><p>æ‰¹å¤„ç†æ•°é‡å·²å‡å°‘åˆ°42ï¼Œè¿™æ„å‘³ç€ç°åœ¨ä»…ç”¨40ä¸ªæ‰¹å¤„ç†å³å¯æ¸²æŸ“æ‰€æœ‰5000ä¸ªçƒä½“ã€‚å¸§é€Ÿç‡ä¹Ÿé«˜è¾¾80 fpsï¼Œä½†æ˜¯åªæœ‰å‡ ä¸ªçƒä½“å¯è§ã€‚<strong>é”™è¯¯åŸå› </strong>ï¼šè™½ç„¶5000ä¸ªçƒä½“ä»åœ¨æ¸²æŸ“ï¼Œä½†æ˜¯åœ¨åˆæ‰¹ä¸­åŒä¸€æ‰¹æ¬¡çš„æ‰€æœ‰çƒä½“çš„é¡¶ç‚¹è½¬æ¢æ—¶éƒ½ä½¿ç”¨äº†åŒä¸€ä¸ªä½ç½®ï¼šå®ƒä»¬éƒ½ä½¿ç”¨åŒä¸€æ‰¹æ¬¡ä¸­ç¬¬ä¸€ä¸ªçƒçš„è½¬æ¢çŸ©é˜µã€‚ å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸ºç°åœ¨åŒä¸€æ‰¹ä¸­æ‰€æœ‰çƒä½“çš„çŸ©é˜µéƒ½ä½œä¸ºæ•°ç»„å‘é€åˆ°GPUã€‚ åœ¨ä¸å‘ŠçŸ¥ç€è‰²å™¨è¦ä½¿ç”¨å“ªä¸ªæ•°ç»„ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œå®ƒå§‹ç»ˆä½¿ç”¨ç¬¬ä¸€ä¸ªç´¢å¼•ã€‚</p><h3 id="instance-ids">Instance IDs</h3><p>ä¸Šè¿°é”™è¯¯è§£å†³åŠæ³•ï¼šæ¯ä¸ªInstanceç›¸å¯¹åº”çš„æ•°ç»„ç´¢å¼•ç§°ä¸ºå…¶Instance IDï¼ŒGPUé€šè¿‡é¡¶ç‚¹æ•°æ®å°†å…¶ä¼ é€’åˆ°ç€è‰²å™¨çš„vertexç¨‹åºã€‚åœ¨å¤§å¤šæ•°å¹³å°ä¸Šï¼Œå®ƒæ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°ï¼Œåä¸ºinstanceIDï¼Œå…·æœ‰SV_InstanceIDè¯­ä¹‰ã€‚ æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä½¿ç”¨_UNITY_VERTEX_INPUT_INSTANCE_ID_å®å°†å…¶åŒ…å«åœ¨æˆ‘ä»¬çš„VertexDataç»“æ„ä¸­ã€‚ å®ƒåœ¨UnityCGä¸­åŒ…å«çš„_UnityInstancing.cginc_æ–‡ä»¶ä¸­å®šä¹‰ã€‚ å®ƒä¸ºæˆ‘ä»¬æä¾›äº†å®ä¾‹IDçš„æ­£ç¡®å®šä¹‰ï¼Œæˆ–è€…åœ¨æœªå¯ç”¨å®ä¾‹åŒ–æ—¶ä¸æä¾›ä»»ä½•å†…å®¹ã€‚å°†å…¶æ·»åŠ åˆ°VertexDataç»“æ„ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">VertexData</span> <span class="p">{</span>
    <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
    <span class="kt">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="nb">POSITION</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div><p>å¯ç”¨instanceåï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥åœ¨é¡¶ç‚¹ç¨‹åºä¸­è®¿é—®instanceIDã€‚ æœ‰äº†å®ƒï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å˜æ¢é¡¶ç‚¹ä½ç½®æ—¶ä½¿ç”¨æ­£ç¡®çš„çŸ©é˜µã€‚ ä½†æ˜¯ï¼ŒUnityObjectToClipPoså‡½æ•°æ²¡æœ‰çŸ©é˜µå‚æ•°ï¼Œå®ƒå‡½æ•°å†…éƒ¨å§‹ç»ˆä½¿ç”¨unity_ObjectToWorldçŸ©é˜µã€‚è¦è§£å†³æ­¤é—®é¢˜ï¼ŒUnityInstancingåŒ…å«æ–‡ä»¶ä¼šä½¿ç”¨çŸ©é˜µæ•°ç»„çš„å®è¦†ç›–unity_ObjectToWorldã€‚ <em>è¿™å¯ä»¥è¢«è®¤ä¸ºæ˜¯è‚®è„çš„å®æŠ€å·§ï¼Œä½†æ— éœ€æ›´æ”¹ç°æœ‰ç€è‰²å™¨ä»£ç å³å¯å·¥ä½œï¼Œä»è€Œç¡®ä¿äº†å‘åå…¼å®¹æ€§</em>ã€‚</p><p>è¦ä½¿å®ƒå·¥ä½œï¼Œinstanceçš„æ•°ç»„ç´¢å¼•å¿…é¡»å¯¹æ‰€æœ‰ç€è‰²å™¨ä»£ç å…¨å±€å¯ç”¨ã€‚å¿…é¡»é€šè¿‡_UNITY_SETUP_INSTANCE_ID_å®è¿›è¡Œæ‰‹åŠ¨è®¾ç½®ï¼Œè¯¥å®å¿…é¡»åœ¨vertexç¨‹åºæœ€å…ˆè®¡ç®—ï¼Œç„¶åå†æ‰§è¡Œå…¶ä»–çš„ä»£ç ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">InterpolatorsVertex</span> <span class="nf">MyVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">InterpolatorsVertex</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">UNITY_INITIALIZE_OUTPUT</span><span class="p">(</span><span class="n">Interpolators</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">UNITY_SETUP_INSTANCE_ID</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender19/1692664-20200612010908398-221325174.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>çŸ©é˜µæ›¿æ¢å†…éƒ¨å®ç°ï¼Ÿ.</a></i></center> </font><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//UnityInstancingä¸­çš„å®é™…ä»£ç è¦å¤æ‚å¾—å¤šã€‚ å®ƒè¦å¤„ç†å¹³å°å·®å¼‚ï¼Œå…¶ä»–ä½¿ç”¨å®ä¾‹åŒ–çš„æ–¹æ³•ä»¥åŠç”¨äºç«‹</span>
<span class="c1">//ä½“å£°æ¸²æŸ“çš„ç‰¹æ®Šä»£ç ï¼Œä»è€Œå¯¼è‡´é—´æ¥å®šä¹‰çš„å¤šä¸ªæ­¥éª¤ã€‚ å®ƒè¿˜å¿…é¡»é‡æ–°å®šä¹‰UnityObjectToClipPosï¼Œå› </span>
<span class="c1">//ä¸ºUnityCGé¦–å…ˆåŒ…å«UnityShaderUtilitiesã€‚</span>
<span class="c1">//ç¼“å†²åŒºå®å°†åœ¨åé¢è¯´æ˜ã€‚</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">unity_InstanceID</span><span class="p">;</span>

<span class="n">CBUFFER_START</span><span class="p">(</span><span class="n">UnityDrawCallInfo</span><span class="p">)</span>
    <span class="c1">// Where the current batch starts within the instanced arrays.</span>
    <span class="n">int</span> <span class="n">unity_BaseInstanceID</span><span class="p">;</span>
<span class="n">CBUFFER_END</span>

<span class="cp">#define UNITY_VERTEX_INPUT_INSTANCE_ID uint instanceID : SV_InstanceID;
</span>
<span class="cp">#define UNITY_SETUP_INSTANCE_ID(input) \
    unity_InstanceID = input.instanceID + unity_BaseInstanceID;
</span>
<span class="c1">// Redefine some of the built-in variables</span>
<span class="c1">// macros to make them work with instancing.</span>
<span class="n">UNITY_INSTANCING_CBUFFER_START</span><span class="p">(</span><span class="n">PerDraw0</span><span class="p">)</span>
    <span class="kt">float4x4</span> <span class="n">unity_ObjectToWorldArray</span><span class="p">[</span><span class="n">UNITY_INSTANCED_ARRAY_SIZE</span><span class="p">];</span>
    <span class="kt">float4x4</span> <span class="n">unity_WorldToObjectArray</span><span class="p">[</span><span class="n">UNITY_INSTANCED_ARRAY_SIZE</span><span class="p">];</span>
<span class="n">UNITY_INSTANCING_CBUFFER_END</span>
<span class="cp">#define unity_ObjectToWorld     unity_ObjectToWorldArray[unity_InstanceID]
#define unity_WorldToObject     unity_WorldToObjectArray[unity_InstanceID]
</span></code></pre></div></div><h3 id="æ‰¹å¤„ç†å¤§å°">æ‰¹å¤„ç†å¤§å°</h3><p>æ¯å°è®¾å¤‡ä¸ä¸€æ ·ï¼Œæœ€ç»ˆå¾—åˆ°çš„æ‰¹æ¬¡æ•°é‡å¯èƒ½ä¸å½“å‰å®éªŒå¾—åˆ°çš„æ•°é‡ä¸åŒã€‚ç°åœ¨è¿™æƒ…å†µä¸‹ï¼Œä»¥40æ‰¹æ¸²æŸ“5000ä¸ªçƒä½“å®ä¾‹ï¼Œè¿™æ„å‘³ç€æ¯æ‰¹125ä¸ªçƒä½“ã€‚</p><p>æ¯ä¸ªæ‰¹æ¬¡éƒ½éœ€è¦è‡ªå·±çš„çŸ©é˜µæ•°ç»„ã€‚ æ­¤æ•°æ®å‘é€åˆ°GPUå¹¶å­˜å‚¨åœ¨å†…å­˜ç¼“å†²åŒºä¸­ï¼Œåœ¨Direct3Dä¸­ç§°ä¸ºå¸¸é‡ç¼“å†²åŒºï¼Œåœ¨OpenGLä¸­ç§°ä¸ºç»Ÿä¸€ç¼“å†²åŒºã€‚ è¿™äº›<strong>ç¼“å†²åŒºå…·æœ‰æœ€å¤§å¤§å°</strong>ï¼Œè¿™é™åˆ¶äº†ä¸€æ‰¹ä¸­å¯ä»¥å®¹çº³å¤šå°‘ä¸ªå®ä¾‹ã€‚ å‡è®¾å°å¼æœºGPUæ¯ä¸ªç¼“å†²åŒºçš„é™åˆ¶ä¸º64KBã€‚</p><p>ä¸€ä¸ªçŸ©é˜µç”±16ä¸ªæµ®ç‚¹æ•°ç»„æˆï¼Œæ¯ä¸ªæµ®ç‚¹æ•°å‡ä¸º4ä¸ªå­—èŠ‚ã€‚ å› æ­¤ï¼Œæ¯ä¸ªçŸ©é˜µ64ä¸ªå­—èŠ‚ã€‚ æ¯ä¸ªå®ä¾‹éƒ½éœ€è¦ä¸€ä¸ªå¯¹è±¡åˆ°ä¸–ç•Œçš„è½¬æ¢çŸ©é˜µã€‚ ä½†æ˜¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªä¸–ç•Œåˆ°å¯¹è±¡çš„çŸ©é˜µæ¥è½¬æ¢æ³•çº¿å‘é‡ã€‚ å› æ­¤ï¼Œæœ€ç»ˆæ¯ä¸ªå®ä¾‹æœ‰128ä¸ªå­—èŠ‚ã€‚ è¿™å¯¼è‡´æœ€å¤§æ‰¹å¤„ç†å¤§å°ä¸ºâ€œ 64000/128 = 500â€ï¼Œè¿™åªèƒ½åœ¨10ä¸ªæ‰¹å¤„ç†ä¸­æ¸²æŸ“5000ä¸ªçƒä½“ã€‚</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å†…å­˜å•ä½æ˜¯2è¿›åˆ¶ï¼Œæ‰€ä»¥1KBè¡¨ç¤º1024å­—èŠ‚ï¼Œè€Œä¸æ˜¯1000ã€‚å› æ­¤ï¼Œ'(64 * 1024)/ 128 = 512 'ã€‚UNITY_INSTANCED_ARRAY_SIZEé»˜è®¤å®šä¹‰ä¸º500ï¼Œä½†æ‚¨å¯ä»¥ä½¿ç”¨ç¼–è¯‘å™¨æŒ‡ä»¤è¦†ç›–å®ƒã€‚ä¾‹å¦‚ï¼Œ#pragma instancing_options maxcount:512å°†æœ€å¤§å€¼è®¾ç½®ä¸º512ã€‚ä½†æ˜¯ï¼Œè¿™å°†å¯¼è‡´æ–­è¨€å¤±è´¥é”™è¯¯ï¼Œå› æ­¤å®é™…é™åˆ¶ä¸º511ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œ500å’Œ512ä¹‹é—´æ²¡æœ‰å¤ªå¤§çš„å·®åˆ«ã€‚
</code></pre></div></div><p>å³ä½¿å‡è®¾å°å¼æœºçš„æœ€å¤§å®¹é‡ä¸º64KBæˆç«‹ï¼Œä½†æ˜¯å¤§å¤šæ•°ç§»åŠ¨è®¾å¤‡çš„æœ€å¤§å®¹é‡è¿œè¿œè¾¾ä¸åˆ°64ï¼Œå¯èƒ½ä»…ä¸º16KBã€‚ Unityé€šè¿‡åœ¨é’ˆå¯¹OpenGL ES 3ï¼ŒOpenGL Coreæˆ–Metalæ—¶å°†æœ€å¤§å€¼é™¤ä»¥å››æ¥è§£å†³æ­¤é—®é¢˜ã€‚ å› ä¸ºæˆ‘åœ¨ç¼–è¾‘å™¨ä¸­ä½¿ç”¨çš„æ˜¯OpenGL Coreï¼Œæ‰€ä»¥æœ€ç»ˆçš„æœ€å¤§æ‰¹å¤„ç†å¤§å°ä¸ºâ€œ 500/4 = 125â€ã€‚</p><p>å¯ä»¥é€šè¿‡æ·»åŠ ç¼–è¯‘å™¨æŒ‡ä»¤#pragma instancing_options force_same_maxcount_for_glæ¥ç¦ç”¨æ­¤è‡ªåŠ¨å‡å°‘åŠŸèƒ½ã€‚ å¤šä¸ªinstanceé€‰é¡¹ç»„åˆåœ¨åŒä¸€æŒ‡ä»¤ä¸­ã€‚ ä½†æ˜¯ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´åœ¨éƒ¨ç½²åˆ°ç§»åŠ¨è®¾å¤‡ä¸Šæ—¶å‘ç”Ÿæ•…éšœï¼Œå› æ­¤è¯·å°å¿ƒä½¿ç”¨ã€‚</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>é‚£å‡è®¾å‡ç­‰ç¼©æ”¾é€‰é¡¹å‘¢ï¼Ÿ

å¯ä»¥ä½¿ç”¨#pragma instancing_optionsæŒ‡ç¤ºæ‰€æœ‰instanceå¯¹è±¡å…·æœ‰ç»Ÿä¸€çš„ç¼©æ”¾æ¯”ä¾‹ã€‚ è¿™æ¶ˆé™¤äº†å°†ä¸–ç•Œåˆ°å¯¹è±¡çŸ©é˜µç”¨äºæ³•çº¿è½¬æ¢çš„éœ€è¦(å°‘å­˜å‚¨ä¸€ä¸ªçŸ©é˜µ)ã€‚ è®¾ç½®æ­¤é€‰é¡¹åï¼Œè™½ç„¶UnityObjectToWorldNormalå‡½æ•°ç¡®å®ä¼šæ›´æ”¹å…¶è¡Œä¸ºï¼Œä½†å®ƒä¸ä¼šæ¶ˆé™¤ç¬¬äºŒä¸ªçŸ©é˜µæ•°ç»„ã€‚ å› æ­¤ï¼Œè‡³å°‘åœ¨Unity 2017.1.0ä¸­ï¼Œæ­¤é€‰é¡¹å®é™…ä¸Šæ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚
</code></pre></div></div><h3 id="instance-shadows">Instance Shadows</h3><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸€ç›´æ²¡æœ‰é˜´å½±ã€‚ é‡æ–°æ‰“å¼€ä¸»é˜´å½±çš„Soft shadowï¼Œå¹¶ç¡®ä¿é˜´å½±è·ç¦»è¶³ä»¥åŒ…å«æ‰€æœ‰çƒä½“</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender19/1692664-20200612010909964-776430193.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æ‰¹å¤„ç†çˆ†ç‚¸.</a></i></center> </font><p>ä¸ºå¤§é‡ç‰©ä½“æ¸²æŸ“é˜´å½±ä¼šå¢åŠ GPUè€—èƒ½ã€‚ä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æ¸²æŸ“çƒä½“é˜´å½±æ—¶ä½¿ç”¨GPU instanceã€‚åœ¨shadow caster-passä¸­æ·»åŠ instanceæŒ‡ä»¤ï¼›åŒæ—¶ä¹Ÿå¢åŠ <code class="language-plaintext highlighter-rouge">UNITY_VERTEX_INPUT_INSTANCE_ID</code> and <code class="language-plaintext highlighter-rouge">UNITY_SETUP_INSTANCE_ID</code></p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma multi_compile_shadowcaster
#pragma multi_compile_instancing
</span><span class="k">struct</span> <span class="n">VertexData</span> <span class="p">{</span>
	<span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
<span class="p">};</span>

<span class="n">InterpolatorsVertex</span> <span class="nf">MyShadowVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">InterpolatorsVertex</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">UNITY_SETUP_INSTANCE_ID</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender19/1692664-20200612010911627-1161944067.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>instanced é˜´å½±.</a></i></center> </font><h3 id="å¤šå…‰æº">å¤šå…‰æº</h3><p>æˆ‘ä»¬ä»…åœ¨base-passå’Œshadow caster-passä¸­æ·»åŠ äº†instanceæ”¯æŒã€‚ å› æ­¤ï¼Œæ‰¹å¤„ç†ä¸é€‚ç”¨äºå…¶ä»–å…‰æºã€‚ è¦éªŒè¯è¿™ä¸€ç‚¹ï¼Œåœç”¨ä¸»å…‰æºå¹¶æ·»åŠ ä¸€äº›ä¼šå½±å“å¤šä¸ªçƒä½“çš„èšå…‰ç¯æˆ–ç‚¹å…‰æºã€‚ ä¸è¦ä¸ºå®ƒä»¬æ‰“å¼€é˜´å½±ï¼Œå› ä¸ºé‚£æ ·ä¼šé™ä½å¸§é€Ÿç‡ã€‚</p><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender19/1692664-20200612010913312-1389275661.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>æ‰¹å¤„ç†çˆ†ç‚¸.</a></i></center> </font><p>ä¸Šå›¾ï¼Œå®Œå…¨ä¸æ”¯æŒå¤šå…‰æºæ‰¹å¤„ç†ã€‚ è¦å°†instanceä¸å¤šä¸ªå…‰æºç»“åˆä½¿ç”¨ï¼Œåªèƒ½åˆ‡æ¢åˆ°å»¶è¿Ÿæ¸²æŸ“è·¯å¾„ã€‚ ä¸ºæ­¤ï¼Œè¯·å°†æ‰€éœ€çš„ç¼–è¯‘å™¨æŒ‡ä»¤æ·»åŠ åˆ°ç€è‰²å™¨çš„å»¶è¿Ÿä¼ é€’ä¸­ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma multi_compile_prepassfinal
#pragma multi_compile_instancing
</span></code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender19/1692664-20200612010914967-1310775534.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>å¤šå…‰æºinstance.</a></i></center> </font><h2 id="mixing-material-properties">Mixing Material Properties</h2><p>æ‰€æœ‰æ‰¹å¤„ç†éƒ½æœ‰ä¸€ä¸ªé™åˆ¶ï¼šå®ƒä»¬ä»…é™äºå…·æœ‰ç›¸åŒææ–™çš„å¯¹è±¡ã€‚ å½“æˆ‘ä»¬å¸Œæœ›æ¸²æŸ“çš„å¯¹è±¡å…·æœ‰å¤šæ ·æ€§æ—¶ï¼Œæ­¤é™åˆ¶å°±ä¼šæˆä¸ºé—®é¢˜ã€‚</p><h3 id="éšæœºç€è‰²">éšæœºç€è‰²</h3><p>éšæœºæ”¹å˜çƒä½“çš„é¢œè‰²</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">Start</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">instances</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Transform</span> <span class="n">t</span> <span class="o">=</span> <span class="n">Instantiate</span><span class="p">(</span><span class="n">prefab</span><span class="p">);</span>
        <span class="n">t</span><span class="p">.</span><span class="n">localPosition</span> <span class="o">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">insideUnitSphere</span> <span class="o">*</span> <span class="n">radius</span><span class="p">;</span>
        <span class="n">t</span><span class="p">.</span><span class="n">SetParent</span><span class="p">(</span><span class="n">transform</span><span class="p">);</span>
        <span class="n">t</span><span class="p">.</span><span class="n">GetComponent</span><span class="o">&lt;</span><span class="n">MeshRenderer</span><span class="o">&gt;</span><span class="p">().</span><span class="n">material</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span>    <span class="kr">new</span> <span class="n">Color</span><span class="p">(</span><span class="n">Random</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Random</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Random</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender19/1692664-20200612010916576-490651101.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>çƒä½“ä¸éšæœºçš„é¢œè‰²ï¼Œæ²¡æœ‰æ‰¹é‡å’Œé˜´å½±.</a></i></center> </font><p>å³ä½¿æˆ‘ä»¬ä¸ºç‰©æ–™å¯ç”¨äº†æ‰¹å¤„ç†ï¼Œå®ƒä¹Ÿä¸å†èµ·ä½œç”¨ã€‚ç”±äºæ¯ä¸ªçƒä½“ç°åœ¨éƒ½æœ‰è‡ªå·±çš„æè´¨ï¼Œå› æ­¤æ¯ä¸ªçƒä½“çš„ç€è‰²å™¨çŠ¶æ€ä¹Ÿå¿…è¢«æ›´æ”¹ã€‚ è¿™æ˜¾ç¤ºåœ¨ç»Ÿè®¡é¢æ¿ä¸­ä¸ºSetPass call æ•°é‡ã€‚å®ƒæ›¾ç»æ˜¯æ‰€æœ‰é¢†åŸŸçš„ä¸€ä½“æœºï¼Œä½†æ˜¯ç°åœ¨æ˜¯5000ã€‚</p><h3 id="æè´¨å±æ€§å—-material-property-blocks">æè´¨å±æ€§å—-Material Property Blocks</h3><p>é™¤äº†ä¸ºæ¯ä¸ªçƒä½“åˆ›å»ºæ–°çš„æè´¨å®ä¾‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨æè´¨å±æ€§å—ã€‚ è¿™äº›æ˜¯å°çš„ä¿®æ”¹ï¼Œè®¾ç½®å±æ€§å—çš„é¢œè‰²å¹¶å°†å…¶ä¼ é€’ç»™çƒä½“çš„æ¸²æŸ“å™¨ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ†é…æè´¨çš„é¢œè‰²ã€‚</p><p><a href="http://docs.unity3d.com/Documentation/ScriptReference/MaterialPropertyBlock.html">MaterialPropertyBlock</a>;</p><h3 id="property-buffers-å±æ€§ç¼“å†²åŒº">Property Buffers-å±æ€§ç¼“å†²åŒº</h3><p>æ¸²æŸ“instanceå¯¹è±¡æ—¶ï¼ŒUnityé€šè¿‡å°†æ•°ç»„ä¼ é€’åˆ°GPUå†…å­˜æ¥ä½¿è½¬æ¢çŸ©é˜µå¯ç”¨äºGPUã€‚ Unityå¯¹å­˜å‚¨åœ¨ææ–™å±æ€§å—ä¸­çš„å±æ€§æ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚ ä½†è¿™è¦èµ·ä½œç”¨ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨shaderä¸­å®šä¹‰ä¸€ä¸ªé€‚å½“çš„ç¼“å†²åŒºã€‚</p><p>å£°æ˜instanceç¼“å†²åŒºçš„å·¥ä½œç±»ä¼¼äºåˆ›å»ºè¯¸å¦‚æ’å€¼å™¨ä¹‹ç±»çš„ç»“æ„ï¼Œä½†æ˜¯ç¡®åˆ‡çš„è¯­æ³•å› å¹³å°è€Œå¼‚ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨_UNITY_INSTANCING_CBUFFER_START_å’Œ_UNITY_INSTANCING_CBUFFER_END_å®æ¥è§£å†³å·®å¼‚ã€‚ å¯ç”¨å®ä¾‹åŒ–åï¼Œå®ƒä»¬å°†ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚</p><p>å°†_Colorå˜é‡çš„å®šä¹‰æ”¾åœ¨instanceç¼“å†²åŒºä¸­ã€‚ _UNITY_INSTANCING_CBUFFER_START_å®éœ€è¦ä¸€ä¸ªåç§°å‚æ•°ã€‚ å®é™…åç§°æ— å…³ç´§è¦ã€‚ å®ä»¥UnityInstancing_ä¸ºå…¶å‰ç¼€ï¼Œä»¥é˜²æ­¢åç§°å†²çªã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UNITY_INSTANCING_CBUFFER_START</span><span class="p">(</span><span class="n">InstanceProperties</span><span class="p">)</span>
    <span class="kt">float4</span> <span class="n">_Color</span><span class="p">;</span>
<span class="n">UNITY_INSTANCING_CBUFFER_END</span>
</code></pre></div></div><p>åƒå˜æ¢çŸ©é˜µä¸€æ ·ï¼Œå¯ç”¨instanceåï¼Œé¢œè‰²æ•°æ®ä½œä¸ºæ•°ç»„ä¸Šä¼ åˆ°GPUã€‚_UNITY_DEFINE_INSTANCED_PROP_å®ä¼šä¸ºæˆ‘ä»¬å¤„ç†æ­£ç¡®çš„å£°æ˜è¯­æ³•ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UNITY_INSTANCING_CBUFFER_START</span><span class="p">(</span><span class="n">InstanceProperties</span><span class="p">)</span>
    <span class="c1">//float4 _Color;</span>
    <span class="n">UNITY_DEFINE_INSTANCED_PROP</span><span class="p">(</span><span class="kt">float4</span><span class="p">,</span> <span class="n">_Color</span><span class="p">)</span>
<span class="n">UNITY_INSTANCING_CBUFFER_END</span>
</code></pre></div></div><p>æœ€åè¦è®¿é—®fragmentç¨‹åºä¸­çš„æ•°ç»„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨å…¶ä¸­çŸ¥é“instanceIDã€‚ å› æ­¤ï¼Œå°†å…¶æ·»åŠ åˆ°æ’å€¼å™¨ç»“æ„ä¸­ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">InterpolatorsVertex</span> <span class="p">{</span>
    <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">Interpolators</span> <span class="p">{</span>
    <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
<span class="p">};</span>
</code></pre></div></div><p>åœ¨vertexé¡¶ç‚¹ç¨‹åºä¸­ï¼Œå°†IDä»é¡¶ç‚¹æ•°æ®å¤åˆ¶åˆ°æ’å€¼å™¨ã€‚ å¯ç”¨å®ä¾‹åŒ–æ—¶ï¼Œ_UNITY_TRANSFER_INSTANCE_ID_å®å®šä¹‰æ­¤ç®€å•æ“ä½œï¼Œå¦åˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">InterpolatorsVertex</span> <span class="nf">MyVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">InterpolatorsVertex</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">UNITY_INITIALIZE_OUTPUT</span><span class="p">(</span><span class="n">Interpolators</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">UNITY_SETUP_INSTANCE_ID</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="n">UNITY_TRANSFER_INSTANCE_ID</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>åœ¨ç‰‡æ®µç¨‹åºçš„å¼€å¤´ï¼Œä½¿IDå…¨å±€å¯ç”¨ï¼Œå°±åƒåœ¨é¡¶ç‚¹ç¨‹åºä¸­ä¸€æ ·ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FragmentOutput</span> <span class="nf">MyFragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UNITY_SETUP_INSTANCE_ID</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ä¸ä½¿ç”¨instanceæ—¶ä»¥_Colorçš„å½¢å¼è®¿é—®é¢œè‰²ï¼Œè€Œåœ¨å¯ç”¨å®ä¾‹åŒ–æ—¶ä»¥_Color [unity_InstanceID]çš„å½¢å¼è®¿é—®é¢œè‰²ã€‚ ä½¿ç”¨_UNITY_ACCESS_INSTANCED_PROP_å®å¯åŒæ—¶æ”¯æŒä¸Šè¿°ä¸¤ç§è®¿é—®ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float3</span> <span class="nf">GetAlbedo</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float3</span> <span class="n">albedo</span> <span class="o">=</span>
        <span class="nb">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">).</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">UNITY_ACCESS_INSTANCED_PROP</span><span class="p">(</span><span class="n">_Color</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">float</span> <span class="nf">GetAlpha</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">UNITY_ACCESS_INSTANCED_PROP</span><span class="p">(</span><span class="n">_Color</span><span class="p">).</span><span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>æ–°ç‰ˆæœ¬å¦‚æœç¼–è¯‘æœ‰é”™è¯¯ï¼š
ä»2017.3åŠä»¥ä¸Šç‰ˆæœ¬, UNITY_ACCESS_INSTANCED_PROP macroæ”¹äº†.å®ƒéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼šbufferåï¼Œé¢œè‰²åä½¿ç”¨UNITY_ACCESS_INSTANCED_PROP(InstanceProperties, _Color).
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender19/1692664-20200612010918398-38688989.png" width="250" alt="loading failed, need vpn." /></center><p>ç°åœ¨ï¼Œæˆ‘ä»¬çš„é¢œè‰²éšæœºçš„çƒå†æ¬¡è¢«æ‰¹å¤„ç†ã€‚ æˆ‘ä»¬<strong>å¯ä»¥ç”¨ç›¸åŒçš„æ–¹å¼ä½¿å…¶ä»–å±æ€§å¯å˜ã€‚ å¯¹äºé¢œè‰²ï¼Œæµ®ç‚¹æ•°ï¼ŒçŸ©é˜µå’Œå››åˆ†é‡æµ®ç‚¹å‘é‡ï¼Œè¿™æ˜¯å¯èƒ½çš„</strong>ã€‚ <strong>å¦‚æœè¦æ”¹å˜çº¹ç†ï¼Œå¯ä»¥ä½¿ç”¨å•ç‹¬çš„çº¹ç†æ•°ç»„</strong>ï¼Œå¹¶å°†ç´¢å¼•æ·»åŠ åˆ°å®ä¾‹åŒ–ç¼“å†²åŒºã€‚å…¶ä»–å±æ€§ä¿®æ”¹ç±»ä¼¼ã€‚</p><p>å¯ä»¥åœ¨åŒä¸€ä¸ªç¼“å†²åŒºä¸­ç»„åˆå¤šä¸ªå±æ€§ï¼Œä½†è¦ç‰¢è®°å¤§å°é™åˆ¶ã€‚ è¿˜åº”æ³¨æ„ï¼Œç¼“å†²åŒºè¢«åˆ’åˆ†ä¸º32ä½å—ï¼Œå› æ­¤å•ä¸ªæµ®ç‚¹æ•°éœ€è¦ä¸å‘é‡ç›¸åŒçš„ç©ºé—´ã€‚ æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨å¤šä¸ªç¼“å†²åŒºï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€ä¸ªé™åˆ¶ï¼Œå®ƒä»¬ä¸æ˜¯å…è´¹æä¾›çš„ã€‚ å¯ç”¨instanceåï¼Œæ¯ä¸ªè¦ç¼“å†²çš„å±æ€§éƒ½å°†æˆä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå› æ­¤ä»…å¯¹éœ€è¦æ ¹æ®instanceå˜åŒ–çš„å±æ€§æ‰§è¡Œæ­¤æ“ä½œã€‚</p><h3 id="é˜´å½±">é˜´å½±</h3><p>æˆ‘ä»¬çš„é˜´å½±ä¹Ÿå–å†³äºé¢œè‰²ã€‚ è°ƒæ•´shaderé˜´å½±ä»¥ä¾¿æ¯ä¸ªå®ä¾‹ä¹Ÿå¯ä»¥æ”¯æŒå”¯ä¸€çš„é¢œè‰²ã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//float4 _Color;</span>
<span class="n">UNITY_INSTANCING_CBUFFER_START</span><span class="p">(</span><span class="n">InstanceProperties</span><span class="p">)</span>
    <span class="n">UNITY_DEFINE_INSTANCED_PROP</span><span class="p">(</span><span class="kt">float4</span><span class="p">,</span> <span class="n">_Color</span><span class="p">)</span>
<span class="n">UNITY_INSTANCING_CBUFFER_END</span>

<span class="k">struct</span> <span class="n">InterpolatorsVertex</span> <span class="p">{</span>
    <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">Interpolators</span> <span class="p">{</span>
    <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
<span class="p">};</span>
<span class="n">float</span> <span class="nf">GetAlpha</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">UNITY_ACCESS_INSTANCED_PROP</span><span class="p">(</span><span class="n">_Color</span><span class="p">).</span><span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">InterpolatorsVertex</span> <span class="nf">MyShadowVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">InterpolatorsVertex</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">UNITY_SETUP_INSTANCE_ID</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="n">UNITY_TRANSFER_INSTANCE_ID</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">float4</span> <span class="nf">MyShadowFragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="n">UNITY_SETUP_INSTANCE_ID</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="lod-instance">LOD Instance</h3><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">void</span> <span class="nf">Start</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">MaterialPropertyBlock</span> <span class="n">properties</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MaterialPropertyBlock</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">instances</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">Transform</span> <span class="n">t</span> <span class="p">=</span> <span class="nf">Instantiate</span><span class="p">(</span><span class="n">prefab</span><span class="p">);</span>
        <span class="n">t</span><span class="p">.</span><span class="n">localPosition</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">insideUnitSphere</span> <span class="p">*</span> <span class="n">radius</span><span class="p">;</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">SetParent</span><span class="p">(</span><span class="n">transform</span><span class="p">);</span>
        <span class="c1">//MaterialPropertyBlock properties = new MaterialPropertyBlock();</span>
        <span class="n">properties</span><span class="p">.</span><span class="nf">SetColor</span>
        <span class="p">(</span>
            <span class="s">"_Color"</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Color</span><span class="p">(</span><span class="n">Random</span><span class="p">.</span><span class="k">value</span><span class="p">,</span> <span class="n">Random</span><span class="p">.</span><span class="k">value</span><span class="p">,</span> <span class="n">Random</span><span class="p">.</span><span class="k">value</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="c1">//t.GetComponent&lt;MeshRenderer&gt;().SetPropertyBlock(properties);</span>
        <span class="n">MeshRenderer</span> <span class="n">r</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">MeshRenderer</span><span class="p">&gt;();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="n">r</span><span class="p">.</span><span class="nf">SetPropertyBlock</span><span class="p">(</span><span class="n">properties</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> 
        <span class="p">{</span>
            <span class="c1">//å¯¹LODå­å¯¹è±¡è®¾ç½®é¢œè‰²</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">ci</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">ci</span> <span class="p">&lt;</span> <span class="n">t</span><span class="p">.</span><span class="n">childCount</span><span class="p">;</span> <span class="n">ci</span><span class="p">++)</span> <span class="p">{</span>
                <span class="n">r</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">GetChild</span><span class="p">(</span><span class="n">ci</span><span class="p">).</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">MeshRenderer</span><span class="p">&gt;();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">r</span><span class="p">.</span><span class="nf">SetPropertyBlock</span><span class="p">(</span><span class="n">properties</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender19/1692664-20200612010919954-2006515171.png" width="250" alt="loading failed, need vpn." /></center><p>ä¸å¹¸çš„æ˜¯æ²¡æœ‰æœ‰æ•ˆçš„æ‰¹å¤„ç†ã€‚Unityèƒ½å¤Ÿå¯¹ä»¥ç›¸åŒçš„LODé¢œè‰²çƒä½“è¿›è¡Œæ‰¹å¤„ç†ï¼Œä½†æ˜¯å¦‚æœå¯ä»¥åƒå¾€å¸¸ä¸€æ ·è¿›è¡Œæ‰¹å¤„ç†ä¼šæ›´å¥½ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡ç”¨ç¼“å†²æ•°ç»„æ›¿æ¢_unity_LODFade_æ¥å®ç°ã€‚å¯ä»¥é€šè¿‡ä¸ºæ”¯æŒå®ä¾‹åŒ–çš„æ¯ä¸ªè¿‡ç¨‹æ·»åŠ lodfadeå®ä¾‹åŒ–é€‰é¡¹æ¥æŒ‡ç¤ºUnityçš„ç€è‰²å™¨ä»£ç æ‰§è¡Œæ­¤æ“ä½œã€‚</p><div class="language-hlsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma multi_compile_instancing
#pragma instancing_options lodfade
</span></code></pre></div></div><center class="half"><img class="fit-picture" loading="lazy" src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender19/1692664-20200612010921540-656727216.png" width="250" alt="loading failed, need vpn." /></center> <font size="2.5"> <center><i><a>instance LOD fading.</a></i></center> </font></article><hr><div class='like-post'> <a style="color:rgb(112, 40, 85);" id="likeBtn" onclick="likePost(1);"> <i class="fa fa-thumbs-o-up fa-2x" aria-hidden="true"></i> </a> <span id="likeNum">0</span><div class="text-xs text-slate-500 mx-2">çœŸè¯šç‚¹èµï¼Œæ‰‹ç•™ä½™é¦™</div></div><h2 id="similar_posts">Similar Posts</h2><ul><li class="relatedPost"> <a href="/2024/07/10/Unity_Addressable_Editor/">Unity Addressable Editorç»“æ„ </a><li class="relatedPost"> <a href="/2018/01/25/Unity_Parallax_Normals_Heightmap/">è§†å·®å’Œæ³•çº¿ã€é«˜åº¦å›¾å›é¡¾(ç¿»è¯‘äºŒå) </a><li class="relatedPost"> <a href="/2018/01/23/Unity_RealTime_GI_LOD/">Unity å®æ—¶ GI & LPPV & LOD(ç¿»è¯‘åå…«) </a><li class="relatedPost"> <a href="/2018/01/21/Unity_Mix_Lighting/">Unity æ··åˆå…‰ç…§(ç¿»è¯‘åä¸ƒ) </a><li class="relatedPost"> <a href="/2018/01/19/Unity_Static_Lightting/">Unity å…‰ç…§çƒ˜ç„™(ç¿»è¯‘åå…­) </a><li class="relatedPost"> <a href="/2018/01/17/Unity_Deferred_Lights/">Unity Deferred Lights-å»¶è¿Ÿå…‰ç…§(ç¿»è¯‘åäº”) </a></ul><div class="post-recent"><div class="pre"><p><strong>ä¸Šä¸€ç¯‡</strong> <a href="/2018/01/23/Unity_RealTime_GI_LOD/">Unity å®æ—¶ GI & LPPV & LOD(ç¿»è¯‘åå…«)</a></p></div><div class="nex"><p><strong>ä¸‹ä¸€ç¯‡</strong> <a href="/2018/01/25/Unity_Parallax_Normals_Heightmap/">è§†å·®å’Œæ³•çº¿ã€é«˜åº¦å›¾å›é¡¾(ç¿»è¯‘äºŒå)</a></p></div></div><h2 id="comments">Comments</h2><div id="vcomments"></div><script type="text/javascript"> /*è¯„è®ºç›¸å…³*/ function delayLoadValine() { new Valine({ el: '#vcomments', verify: "true", notify: "false", app_id: "JgYk2pcFa3QxhhWPhDjjoPvv-MdYXbMMI", app_key: "fjDLTSUgCNGrSKgCID672IJx", avatar: "monsterid", placeholder: "æ¬¢è¿è¯„è®ºï¼", pageSize: "10 || 10", master: "b5586e582cb181c6b0fc8b2ce828bd50", tagMeta: ["åšä¸»","å°ä¼™ä¼´","è®¿å®¢"], enableQQ: true, requiredFields: [], serverURLs: "https://leanapi.damonc.top", recordIP: "true", visitor: "true", }); $(document).ready(function(){ fetch('https://v1.hitokoto.cn/') .then(response => response.json()) .then(data => { document.getElementById("veditor").setAttribute( "placeholder", data.hitokoto+"â€”"+data.from ); setTimeout(() => { addPostVisitedTimes(); }, 1000); } ) .catch(console.error); }); } /*ç‚¹èµç›¸å…³*/ var curIpVisitRecord = null; var curPost = null; var curUrl = "https://www.damonc.top/2018/01/24/Unity_GPU_Instance/"; function getVisitorIpAndJudge() { $.getJSON('https://api.ipify.org?format=json', function(data){ saveOrUpdateIpRecord(data.ip) }); } function saveOrUpdateIpRecord(ip) { var Visitor = AV.Object.extend("visitors_record"); var post_url = curUrl; var query = new AV.Query(Visitor); query.equalTo("visitor_ip", ip); query.equalTo("post_url", post_url); query.find().then(function(results) { if (results.length > 0) { /* if(window.console){ console.log('è¯¥IPå·²è®¿é—®è¿‡è¯¥æ–‡ç« '); }*/ curIpVisitRecord = results[0]; updateIpRecord(); refreshLikeBtn(); } else { /*if(window.console){ console.log('è¯¥IPç¬¬ä¸€æ¬¡è®¿é—®è¯¥æ–‡ç« ï¼Œä¿å­˜æ–°çš„è®¿é—®è®°å½•ï¼Œå¹¶å¢åŠ è®¿é—®æ¬¡æ•°'); }*/ addNewIpRecord(ip, post_url); } }, function(error) { addPostVisitedTimes(); }); } function addPostVisitedTimes() { var AV_Posts = AV.Object.extend("Posts"); var url = curUrl; var title = "Unity GPU Instance(ç¿»è¯‘åä¹)"; var query = new AV.Query(AV_Posts); query.equalTo("post_url", url); query.find().then(function(results) { if (results.length > 0) { curPost = results[0]; curPost.increment("visited_times"); curPost.save(); loadLikeNums(); } else { curPost = new AV_Posts(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); curPost.setACL(acl); /* End Set ACL */ curPost.set("post_title", title); curPost.set("post_url", url); curPost.set("visited_times", 1); curPost.set('like_times', 0); curPost.save(); } getVisitorIpAndJudge(); }, function(error) { console.log('Error:' + error.code + " " + error.message); }); } function showPostVisitedTimes() { var AV_Posts = AV.Object.extend("Posts"); var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(AV_Posts); query.equalTo("post_url", url); query.find().then(function(results) { if (results.length > 0) { curPost = results[0]; loadLikeNums(); } else { /*if(window.console){ console.log('å¼‚å¸¸æƒ…å†µï¼Œä¸åº”è¯¥æ²¡è®°å½•çš„'); }*/ } }, function(error) { console.log('Error:' + error.code + " " + error.message); }); } function updateIpRecord(){ var lastTime = curIpVisitRecord.updatedAt; var curTime = new Date(); var timePassed = curTime.getTime() - lastTime.getTime(); if(timePassed > 300000) { /*if(window.console){ console.log('è·ç¦»è¯¥IPä¸Šä¸€æ¬¡è®¿é—®è¯¥æ–‡ç« å·²è¶…è¿‡äº†5åˆ†é’Ÿï¼Œæ›´æ–°è®¿é—®è®°å½•ï¼Œå¹¶å¢åŠ è®¿é—®æ¬¡æ•°'); }*/ addPostVisitedTimes(); curIpVisitRecord.save(); } else { /*console.log('è¿™æ˜¯è¯¥IP 1åˆ†é’Ÿå†…é‡å¤è®¿é—®è¯¥æ–‡ç« ï¼Œä¸æ›´æ–°è®¿é—®è®°å½•ï¼Œä¸å¢åŠ è®¿é—®æ¬¡æ•°');*/ } } function addNewIpRecord(ip, post_url){ var Visitor = AV.Object.extend("visitors_record"); curIpVisitRecord = new Visitor(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); curIpVisitRecord.setACL(acl); curIpVisitRecord.set("visitor_ip", ip); curIpVisitRecord.set("post_url", post_url); curIpVisitRecord.set("like_this_post", 0); curIpVisitRecord.save(); } function loadLikeNums() { var likeTimes = curPost.get('like_times'); $("#likeNum").text(likeTimes); } function refreshLikeBtn() { var likeState = curIpVisitRecord.get('like_this_post'); if(likeState == 1){ $("#likeBtn").css("color", "red"); $("#likeBtn").attr("onclick", "likePost(-1)"); } else { $("#likeBtn").css("color", "rgb(112, 40, 85)"); $("#likeBtn").attr("onclick", "likePost(1)"); } loadLikeNums(); } function likePost(type) { if(curPost == null || curIpVisitRecord == null) { alert('å»¶è¿Ÿ10såæ‰èƒ½ç‚¹èµ, è¯·ç¨ç­‰...'); return } var newNum; var getlikeTime = curPost.get('like_times'); if(typeof getlikeTime == "undefined" || getlikeTime == null || getlikeTime == "") { newNum = parseInt(type); }else{ newNum = parseInt(type) + parseInt(getlikeTime); } curPost.set('like_times', newNum); curPost.save().then(function(curPost){ var likeThisPost = type == -1 ? 0 : 1; curIpVisitRecord.set("like_this_post", likeThisPost); curIpVisitRecord.save().then(function(){ refreshLikeBtn(); }); },function(error){ console.log('Failed to create visitor record, with error message: ' + error.message); }); } /*å¯åŠ¨æ‰§è¡Œ*/ delayLoadValine(); </script></div></div><script> /** * target _blank */ (function() { var aTags = document.querySelectorAll('article a:not([id])'); for (var i = 0; i < aTags.length; i++) { var htps = aTags[i].href; if (htps.startsWith("https://")) aTags[i].setAttribute('target', '_blank'); } }()); </script> <script src="/js/pageContent.js " charset="utf-8"></script><footer class="site-footer"><div class="wrapper"><p class="description"> äº‘ä¸Šçš„æ—¥å­!</p><p class="contact"> <a href="https://github.com/bitfeng" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a> <a href="mailto:damonc@126.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></p><p> æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡ï¼Œæœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡ï¼Œæœ¬æ–‡æ€»é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡</p></div></footer><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="back-to-top"> <a href="#top" data-scroll> <i class="fa fa-arrow-up" aria-hidden="true"></i> </a></div><script src=" /js/main.js " charset="utf-8"></script> <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script> <script type="text/javascript"> smoothScroll.init({ speed: 500, easing: 'easeInOutCubic', offset: 20, }); function displayWindowSize() { var w = document.documentElement.clientWidth; var h = document.documentElement.clientHeight; var rightDiv = document.querySelector('.right'); var footer = document.querySelector('.site-footer'); if(!rightDiv || !footer){ return; } if(w <= 1700){ rightDiv.style.display='none'; footer.style.display='none'; }else{ rightDiv.style.display='block'; footer.style.display = "block"; } } window.addEventListener("resize", displayWindowSize); displayWindowSize(); </script>
