<!DOCTYPE html><html lang="zh-Hans"> <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>多线程编程模型篇(三) - 编程散记</title><meta name="author" content="编程散记"><meta name="description" content="多线程编程模型篇(三)"><meta name="keywords" content="Thread"><meta property="og:next_url" content="/unity3d/Unity_Assembly_Definition.html"><meta property="post-date-format" content="0"><meta property="post-date" content="2025-06-07 10:00:00 +0000" /><meta property="calendar-scale" content="year" /><meta property="calendar-scheme" content="null" /><meta property="calendar-color" content="null" /><meta property="og:title" content="多线程编程模型篇(三) - 编程散记"><meta property="og:type" content="website"><meta property="og:url" content="https://www.damonc.top/csharp/CSharp_Thread_Pattern.html"><meta property="og:baseurl" content=""><meta property="og:description" content="个人的一个技术博客站点，记录生活、工作、学习中的一些小事，以及一些比较有趣的事情，留点什么东西也挺不错的，偶尔会在这里停留。"><meta property="og:site_name" content="编程散记"><meta property="og:gray" content="false"><meta property="og:lang" content="zh-Hans"><meta name="alivestart" content="12/23/2020"><meta name="theme-color" content="#81BBFF" /><meta name="algolia-site-verification" content="5E91324370E1262B" /><title>Algolia Verification</title><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="manifest" href="/manifest.json" async><link rel="apple-touch-icon" href="/assets/img/touch/apple-touch-icon.png" /><link rel="Shortcut Icon" href="/favicon.ico"><link rel="icon" href="/favicon.ico" type="image/x-icon" /><link rel="bookmark" href="/favicon.ico" type="image/x-icon" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.min.css" async><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css" async><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown-light.min.css" async><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.min.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-themes@1.9.0/themes/prism-one-light.min.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.28.0/plugins/line-numbers/prism-line-numbers.min.css"><link rel="stylesheet" href="https://unpkg.com/@waline/client@3.3.2/dist/waline.css" async><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" async><link rel="stylesheet" href="/assets/css/app.min.css" async><body class="line-numbers" ontouchstart=""><div id="all" class="post" data-theme="default"><div class="alert-tip" id="no-previous">已经是最新一篇文章了！</div><div class="alert-tip" id="no-next">已经是最后一篇文章了！</div><input id="nm-switch" type="hidden" value="false"><header class="g-header" data-theme="default"><div class="g-logo"> <a href="/" aria-label="logo"></a></div><div id="search-toggle"></div><div id="travelling-toggle"> <a href="https://www.travellings.cn/go.html" aria-label="Travelings" target="_blank"> <svg class="icon" aria-hidden="true"> <use xlink:href="#icon-train-subway"></use> </svg> </a></div><div id="mode-toggle"> <svg class="icon icon-day" aria-hidden="true"> <use xlink:href="#icon-day"></use> </svg> <svg class="icon icon-night" aria-hidden="true"> <use xlink:href="#icon-night"></use> </svg></div><svg id="menu-toggle" class="icon-menu" aria-hidden="true"> <use xlink:href="#icon-menu"></use> </svg><nav class="g-nav"><ul><li> <a href="/" aria-label="home"> home </a><li> <a href="/blog/index.html" aria-label="blog"> blog </a><li> <a href="/archives.html" aria-label="archives"> archives </a><li> <a href="/tags.html" aria-label="tags"> tags </a><li class="dropdown"> <a class="dropdown-toggle" href="#"> about </a><ul class="dropdown-menu"><li> <a href="/feed.xml" aria-label="RSS"> RSS </a></ul><li class="travelling"> <a href="https://www.travellings.cn/go.html" aria-label="Travelings" target="_blank"> <svg class="icon" aria-hidden="true"> <use xlink:href="#icon-train-subway"></use> </svg> </a><li class="mode"> <svg class="icon day" aria-hidden="true"> <use xlink:href="#icon-day"></use> </svg> <svg class="icon night" aria-hidden="true"> <use xlink:href="#icon-night"></use> </svg><li id="search"></ul></nav></header><div class="g-banner post-header post-pattern-circuitBoard bgcolor-default post-no-cover" data-theme="default"><div class="post-wrapper"><div class="post-tags"> <a href="/%20/tags.html#Thread" class="post-tag">Thread</a></div><h1>多线程编程模型篇(三)</h1><div class="post-meta"> <span class="post-meta-item"> <svg class="icon" aria-hidden="true"> <use xlink:href="#icon-user"></use> </svg> 编程散记 </span> <time class="post-meta-item" datetime=" 25-06-07"> <svg class="icon" aria-hidden="true"> <use xlink:href="#icon-calendar"></use> </svg> <span class="create-at"></span> </time> <time class="post-meta-item" datetime=" 25-06-07"> <svg class="icon" aria-hidden="true"> <use xlink:href="#icon-update"></use> </svg> <span class="update-at"></span> </time> <span class="post-meta-item"> <svg class="icon words" aria-hidden="true"> <use xlink:href="#icon-words"></use> </svg> 本文总共 10.8k 字 </span> <span class="post-meta-item"> <svg class="icon time" aria-hidden="true"> <use xlink:href="#icon-time"></use> </svg> 阅读全文大约需要 31 分钟 </span> <span class="post-meta-item"> <svg class="icon pv" aria-hidden="true"> <use xlink:href="#icon-pv"></use> </svg> 本文总阅读量 <span id="busuanzi_value_page_pv"></span> 次 </span></div></div></div><main class="post-content visible"><h2 class="post-subtitle">多线程编程在Unity3d中的应用，多线程的几种编程模式演进。</h2><div class="container"><div class="submenu hidden"></div><div class="contents"><article class="markdown-body post"><p>  Unity有着严格的主线程限制，同时Unity的C#库一直没有得到及时的更新，导致很多C#的异步编程模式在Unity中无法使用。持续到Unity2020版本发布加入了.net 4.x正式版本的支持才有了完整的C#异步编程模型。APM、EAP、async/await异步模式都有了。</p><h2 id="apm模式">APM模式</h2><p>  APM模式是基于委托的异步编程模式，全称<code class="language-plaintext highlighter-rouge">Asynchronous Programming Model</code>，该模式的典型特征是BeginOperationName和EndOperationName，用于开始和结束异步操作OperationName。例如，FileStream类提供 BeginRead和EndRead方法。Begin方法返回一个IAsyncResult对象，调用End方法时需要传入IAsyncResult对象，End方法会返回异步操作的结果。</p><h3 id="iasyncresult对象">IAsyncResult对象</h3><p>  该方法BeginOperationName开始异步操作OperationName并返回实现IAsyncResult接口的对象。IAsyncResult对象存储有关异步作的信息。</p><table><thead><tr><th>成员<th>DESCRIPTION<tbody><tr><td>AsyncState<td>一个可选的特定于应用程序的对象，其中包含有关异步作的信息。<tr><td>AsyncWaitHandle<td>WaitHandle可用于阻止应用程序执行，直到异步操作完成。<tr><td>CompletedSynchronously<td>一个值，该值指示异步操作是否在用于调用 BeginOperationName 的线程上完成，而不是在单独的 ThreadPool 线程上完成。<tr><td>IsCompleted<td>一个表示异步操作是否已完成的值。</table><h3 id="委托异步操作">委托异步操作</h3><p>  无参无返回值的委托异步操作示例：</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">WorkerHandler</span><span class="p">();</span>
<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Worker</span><span class="p">();</span>

<span class="n">WorkerHandler</span> <span class="n">workerHandler</span> <span class="p">=</span> <span class="n">Worker</span><span class="p">;</span>

<span class="c1">//可以不用回调函数和自定义参数</span>
<span class="n">IAsyncResult</span> <span class="n">asyncResult</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">BeginInvoke</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="n">workerHandler</span><span class="p">.</span><span class="nf">EndInvoke</span><span class="p">(</span><span class="n">asyncResult</span><span class="p">);</span>
</code></pre></div></div><p>  BeginInvoke前几个参数必须与委托签名一致，最后两个参数是固定的回调函数和自定义参数，有参有返回值的委托异步操作示例：</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">delegate</span> <span class="kt">string</span> <span class="nf">WorkerHandler</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">);</span>
<span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">Worker</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">);</span>

<span class="n">WorkerHandler</span> <span class="n">workerHandler</span> <span class="p">=</span> <span class="n">Worker</span><span class="p">;</span>

<span class="c1">//BeginInvoke前几个参数必须与委托签名一致</span>
<span class="c1">//BeginInvoke最后两个参数是固定的回调函数和自定义参数</span>
<span class="n">IAsyncResult</span> <span class="n">asyncResult</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">BeginInvoke</span><span class="p">(</span><span class="s">"message"</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">EndInvoke</span><span class="p">(</span><span class="n">asyncResult</span><span class="p">);</span>
</code></pre></div></div><p>  完成回调函数与AsyncCallback委托的签名一致，自定义参数通过IAsyncResult.AsyncState属性获取，异步操作的完成回调与自定义参数示例：</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">delegate</span> <span class="kt">string</span> <span class="nf">WorkerHandler</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">);</span>
<span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">Worker</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">);</span>

<span class="n">WorkerHandler</span> <span class="n">workerHandler</span> <span class="p">=</span> <span class="n">Worker</span><span class="p">;</span>

<span class="c1">//完成回调函数与AsyncCallback委托的签名一致</span>
<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">FinishCallback</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">message</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">result</span><span class="p">.</span><span class="n">AsyncState</span><span class="p">;</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">EndInvoke</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">IAsyncResult</span> <span class="n">asyncResult</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">BeginInvoke</span><span class="p">(</span><span class="s">"message"</span><span class="p">,</span> <span class="n">FinishCallback</span><span class="p">,</span> <span class="s">"custom parameter"</span><span class="p">);</span>
</code></pre></div></div><h3 id="异步操作等待">异步操作等待</h3><p>  IAsyncResult.AsyncWaitHandle属性返回一个WaitHandle对象，可以用于阻塞当前线程，直到异步操作完成。异步操作等待示例：</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. 直接阻塞等待异步操作完成</span>
<span class="n">IAsyncResult</span> <span class="n">asyncResult</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">BeginInvoke</span><span class="p">(</span><span class="s">"message"</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">EndInvoke</span><span class="p">(</span><span class="n">asyncResult</span><span class="p">);</span>

<span class="c1">// 2. 轮询检查</span>
<span class="n">IAsyncResult</span> <span class="n">asyncResult</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">BeginInvoke</span><span class="p">(</span><span class="s">"message"</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(!</span><span class="n">asyncResult</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">100</span><span class="p">);</span> <span class="c1">// 做其他工作</span>
<span class="p">}</span>
<span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">EndInvoke</span><span class="p">(</span><span class="n">asyncResult</span><span class="p">);</span>

<span class="c1">// 3. 使用WaitHandle</span>
<span class="n">IAsyncResult</span> <span class="n">asyncResult</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">BeginInvoke</span><span class="p">(</span><span class="s">"message"</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="n">asyncResult</span><span class="p">.</span><span class="n">AsyncWaitHandle</span><span class="p">.</span><span class="nf">WaitOne</span><span class="p">();</span> <span class="c1">// 等待完成</span>
<span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">workerHandler</span><span class="p">.</span><span class="nf">EndInvoke</span><span class="p">(</span><span class="n">asyncResult</span><span class="p">);</span>
</code></pre></div></div><h2 id="eap模式">EAP模式</h2><p>  EAP模式是基于事件的异步编程模式，全称<code class="language-plaintext highlighter-rouge">Event-based Asynchronous Pattern</code>，该模式的典型特征是事件操作。它通过事件回调来处理异步操作的完成。相比APM模式，EAP模式更加用户友好，支持取消操作和进度报告。EAP模式的最小设计包含一个BeginMethodName方法和一个MethodNameCompleted事件。BeginMethodName方法启动异步操作并返回IAsyncResult对象，MethodNameCompleted事件在异步操作完成时触发。MethodNameCompletedEventArgs类派生自AsyncCompletedEventArgs，提供异步操作的结果和任何错误信息。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">MethodNameCompletedEventHandler</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span>
    <span class="n">MethodNameCompletedEventArgs</span> <span class="n">e</span><span class="p">);</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">MethodNameCompletedEventArgs</span> <span class="p">:</span>
    <span class="n">System</span><span class="p">.</span><span class="n">ComponentModel</span><span class="p">.</span><span class="n">AsyncCompletedEventArgs</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">MyReturnType</span> <span class="n">Result</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="eap模式的核心特征">EAP模式的核心特征</h3><table><thead><tr><th>方法/事件<th>说明<tbody><tr><td>MethodNameAsync<td>方法 - 启动异步操作<tr><td>MethodNameCompleted<td>事件 - 异步操作完成时触发<tr><td>MethodNameCompletedEventArgs<td>事件参数，包含结果和错误信息<tr><td>CancelAsync<td>方法 - 支持取消操作<tr><td>ProgressChanged<td>事件 - 支持进度报告</table><h3 id="实现支持eap的类">实现支持EAP的类</h3><p>  定义事件参数类MethodNameCompletedEventArgs，派生自AsyncCompletedEventArgs，提供异步操作的结果和任何错误信息。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">DownloadCompletedEventArgs</span> <span class="p">:</span> <span class="n">AsyncCompletedEventArgs</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">FilePath</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">long</span> <span class="n">BytesDownloaded</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    
    <span class="k">public</span> <span class="nf">DownloadCompletedEventArgs</span><span class="p">(</span><span class="n">Exception</span> <span class="n">error</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">cancelled</span><span class="p">,</span> 
        <span class="kt">object</span> <span class="n">userState</span><span class="p">,</span> <span class="kt">string</span> <span class="n">filePath</span><span class="p">,</span> <span class="kt">long</span> <span class="n">bytesDownloaded</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">cancelled</span><span class="p">,</span> <span class="n">userState</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">FilePath</span> <span class="p">=</span> <span class="n">filePath</span><span class="p">;</span>
        <span class="n">BytesDownloaded</span> <span class="p">=</span> <span class="n">bytesDownloaded</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">DownloadProgressChangedEventArgs</span> <span class="p">:</span> <span class="n">ProgressChangedEventArgs</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">long</span> <span class="n">BytesReceived</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">long</span> <span class="n">TotalBytesToReceive</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    
    <span class="k">public</span> <span class="nf">DownloadProgressChangedEventArgs</span><span class="p">(</span><span class="kt">int</span> <span class="n">progressPercentage</span><span class="p">,</span> <span class="kt">object</span> <span class="n">userState</span><span class="p">,</span>
        <span class="kt">long</span> <span class="n">bytesReceived</span><span class="p">,</span> <span class="kt">long</span> <span class="n">totalBytes</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">progressPercentage</span><span class="p">,</span> <span class="n">userState</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BytesReceived</span> <span class="p">=</span> <span class="n">bytesReceived</span><span class="p">;</span>
        <span class="n">TotalBytesToReceive</span> <span class="p">=</span> <span class="n">totalBytes</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>  定义支持EAP的类DownloadManager，包含MethodNameAsync方法和MethodNameCompleted事件。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. 实现EAP模式的下载器类</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">DownloadManager</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">WebClient</span> <span class="n">_webClient</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">_lockObject</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>
    
    <span class="c1">// 2. 定义事件</span>
    <span class="k">public</span> <span class="k">event</span> <span class="n">EventHandler</span><span class="p">&lt;</span><span class="n">DownloadCompletedEventArgs</span><span class="p">&gt;</span> <span class="n">DownloadCompleted</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">event</span> <span class="n">EventHandler</span><span class="p">&lt;</span><span class="n">DownloadProgressChangedEventArgs</span><span class="p">&gt;</span> <span class="n">ProgressChanged</span><span class="p">;</span>
    
    <span class="c1">// 3. 异步方法</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">,</span> <span class="kt">string</span> <span class="n">filePath</span><span class="p">,</span> <span class="kt">object</span> <span class="n">userState</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 检查是否已有操作在进行</span>
        <span class="k">lock</span> <span class="p">(</span><span class="n">_lockObject</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_webClient</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"下载操作已在进行中"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">_webClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WebClient</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="c1">// 订阅WebClient事件</span>
        <span class="n">_webClient</span><span class="p">.</span><span class="n">DownloadProgressChanged</span> <span class="p">+=</span> <span class="n">OnDownloadProgressChanged</span><span class="p">;</span>
        <span class="n">_webClient</span><span class="p">.</span><span class="n">DownloadFileCompleted</span> <span class="p">+=</span> <span class="n">OnDownloadFileCompleted</span><span class="p">;</span>
        
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="c1">// 开始异步下载</span>
            <span class="n">_webClient</span><span class="p">.</span><span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="n">filePath</span><span class="p">,</span> 
                <span class="k">new</span> <span class="n">DownloadState</span> <span class="p">{</span> <span class="n">Url</span> <span class="p">=</span> <span class="n">url</span><span class="p">,</span> <span class="n">FilePath</span> <span class="p">=</span> <span class="n">filePath</span><span class="p">,</span> <span class="n">UserState</span> <span class="p">=</span> <span class="n">userState</span> <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 如果启动失败，立即触发完成事件</span>
            <span class="nf">OnDownloadCompleted</span><span class="p">(</span><span class="k">new</span> <span class="nf">DownloadCompletedEventArgs</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">userState</span><span class="p">,</span> <span class="n">filePath</span><span class="p">,</span> <span class="m">0</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// 4. 取消方法</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">CancelAsync</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="n">_lockObject</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_webClient</span><span class="p">?.</span><span class="nf">CancelAsync</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// 5. 内部状态类</span>
    <span class="k">private</span> <span class="k">class</span> <span class="nc">DownloadState</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Url</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">FilePath</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">object</span> <span class="n">UserState</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// 6. 进度变化事件处理</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnDownloadProgressChanged</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">DownloadProgressChangedEventArgs</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">state</span> <span class="p">=</span> <span class="p">(</span><span class="n">DownloadState</span><span class="p">)</span><span class="n">e</span><span class="p">.</span><span class="n">UserState</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">args</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DownloadProgressChangedEventArgs</span><span class="p">(</span>
            <span class="n">e</span><span class="p">.</span><span class="n">ProgressPercentage</span><span class="p">,</span>
            <span class="n">state</span><span class="p">.</span><span class="n">UserState</span><span class="p">,</span>
            <span class="n">e</span><span class="p">.</span><span class="n">BytesReceived</span><span class="p">,</span>
            <span class="n">e</span><span class="p">.</span><span class="n">TotalBytesToReceive</span><span class="p">);</span>
            
        <span class="n">ProgressChanged</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// 7. 完成事件处理</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnDownloadFileCompleted</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">AsyncCompletedEventArgs</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">state</span> <span class="p">=</span> <span class="p">(</span><span class="n">DownloadState</span><span class="p">)</span><span class="n">e</span><span class="p">.</span><span class="n">UserState</span><span class="p">;</span>
        <span class="kt">long</span> <span class="n">bytesDownloaded</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(!</span><span class="n">e</span><span class="p">.</span><span class="n">Cancelled</span> <span class="p">&amp;&amp;</span> <span class="n">e</span><span class="p">.</span><span class="n">Error</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">bytesDownloaded</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileInfo</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">FilePath</span><span class="p">).</span><span class="n">Length</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">{</span> <span class="cm">/* 忽略获取文件大小的错误 */</span> <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1">// 清理资源</span>
        <span class="k">lock</span> <span class="p">(</span><span class="n">_lockObject</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_webClient</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_webClient</span><span class="p">.</span><span class="n">DownloadProgressChanged</span> <span class="p">-=</span> <span class="n">OnDownloadProgressChanged</span><span class="p">;</span>
                <span class="n">_webClient</span><span class="p">.</span><span class="n">DownloadFileCompleted</span> <span class="p">-=</span> <span class="n">OnDownloadFileCompleted</span><span class="p">;</span>
                <span class="n">_webClient</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
                <span class="n">_webClient</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1">// 触发完成事件</span>
        <span class="nf">OnDownloadCompleted</span><span class="p">(</span><span class="k">new</span> <span class="nf">DownloadCompletedEventArgs</span><span class="p">(</span>
            <span class="n">e</span><span class="p">.</span><span class="n">Error</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">Cancelled</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">UserState</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">FilePath</span><span class="p">,</span> <span class="n">bytesDownloaded</span><span class="p">));</span>
    <span class="p">}</span>
    
    <span class="c1">// 8. 安全触发完成事件的方法</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnDownloadCompleted</span><span class="p">(</span><span class="n">DownloadCompletedEventArgs</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">DownloadCompleted</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// 9. 释放资源</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="n">_lockObject</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_webClient</span><span class="p">?.</span><span class="nf">Dispose</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>  使用支持EAP的类DownloadManager，可以实现异步下载文件。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">downloader</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileDownloader</span><span class="p">();</span>
        
        <span class="c1">// 订阅事件</span>
        <span class="n">downloader</span><span class="p">.</span><span class="n">ProgressChanged</span> <span class="p">+=</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"下载进度: </span><span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">ProgressPercentage</span><span class="p">}</span><span class="s">% "</span> <span class="p">+</span>
                            <span class="s">$"(</span><span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">BytesReceived</span><span class="p">}</span><span class="s">/</span><span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">TotalBytesToReceive</span><span class="p">}</span><span class="s"> bytes)"</span><span class="p">);</span>
        <span class="p">};</span>
        
        <span class="n">downloader</span><span class="p">.</span><span class="n">DownloadCompleted</span> <span class="p">+=</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Cancelled</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"下载已取消"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Error</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"下载失败: </span><span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">Error</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"下载完成: </span><span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">FilePath</span><span class="p">}</span><span class="s">, 大小: </span><span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">BytesDownloaded</span><span class="p">}</span><span class="s"> bytes"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span>
        
        <span class="c1">// 开始异步下载</span>
        <span class="kt">string</span> <span class="n">url</span> <span class="p">=</span> <span class="s">"https://example.com/largefile.zip"</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">filePath</span> <span class="p">=</span> <span class="s">@"C:\temp\downloaded.zip"</span><span class="p">;</span>
        
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"开始下载..."</span><span class="p">);</span>
        <span class="n">downloader</span><span class="p">.</span><span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filePath</span><span class="p">,</span> <span class="s">"自定义状态对象"</span><span class="p">);</span>
        
        <span class="c1">// 模拟其他工作</span>
        <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">5000</span><span class="p">);</span>
        
        <span class="c1">// 可以取消下载</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"5秒后取消下载"</span><span class="p">);</span>
        <span class="n">downloader</span><span class="p">.</span><span class="nf">CancelAsync</span><span class="p">();</span>
        
        <span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><div class="premonition warning"><div class="header"> <svg class="icon warning" aria-hidden="true"> <use xlink:href="#icon-warning"></use> </svg><div class="title"> 不推荐EAP模式</div></div><div class="content"><p>相比于APM模式，EAP模式更加复杂，而且容易出现资源泄漏。 同时官方也不推荐使用EAP模式，改用async/await异步模式。 Unity之前大部分都是类EAP模式，现在推荐使用async/await异步模式。</p></div></div><h2 id="asyncawait异步模式">async/await异步模式</h2><p>  async/await异步模式全称<code class="language-plaintext highlighter-rouge">Async/Await</code>，该模式的典型特征是async/await关键字。async/await关键字用于声明异步方法，await关键字用于等待异步操作完成。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="nn">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="状态机">状态机</h3><p>  async/await的本质是编译器生成的状态机。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">DownloadAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"开始下载"</span><span class="p">);</span> <span class="c1">// 同步执行</span>
    
    <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
    <span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="n">url</span><span class="p">);</span> <span class="c1">// 异步等待点</span>
    
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"下载完成"</span><span class="p">);</span> <span class="c1">// 异步继续执行</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="nf">ToUpper</span><span class="p">();</span> <span class="c1">// 同步执行</span>
<span class="p">}</span>

<span class="c1">// 编译器实际生成的状态机伪代码：</span>
<span class="c1">// - 状态0：开始执行</span>
<span class="c1">// - 状态1：await之后的继续执行</span>
</code></pre></div></div><h3 id="async关键字">async关键字</h3><p>  async关键字用于声明异步方法，async关键字用于修饰方法，表示该方法是一个异步方法。如果不是异步方法就不要乱加async关键字，因为调用async方法会有显著的性能损失。同样的方法用通常的同步定义，要比加上async关键字修饰的快40-50倍。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="nn">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>  避免使用async void方法，这是非常危险的，异常处理容易忽略，处理不当容易造成进程崩溃。如果async方法返回Task，Task对象很容易监控，异常也被包装在内。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">public</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"异常"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"异常"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromException</span><span class="p">(</span><span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"异常"</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="await关键字">await关键字</h3><p>  await关键字用于等待异步操作完成。await关键字用于修饰表达式，表示该表达式是一个异步操作。异步操作完成后，控制权会返回到await语句所在的上下文。</p><h3 id="configureawait">ConfigureAwait</h3><p>  ConfigureAwait(bool continueOnCapturedContext)用于配置在等待异步操作完成时，是否继续在捕获的上下文中执行。使用ConfigureAwait(false)可以避免死锁，同时也不需要回到原始上下文减少线程切换开销。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">LibraryMethodAsync</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ✅ 不需要回到原始上下文</span>
    <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">GetDataFromApiAsync</span><span class="p">().</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">processed</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">ProcessDataAsync</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">processed</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="异常处理模式">异常处理模式</h3><p>  异步方法中使用try/catch块捕获异常，逐一展开异常，避免吞掉异常。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ✅ 正确的异常处理模式</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">SafeExecuteAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">operation</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">operation</span><span class="p">().</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="nf">Success</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="nf">Cancelled</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">TimeoutException</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="nf">Failure</span><span class="p">(</span><span class="s">$"操作超时: </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">HttpRequestException</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="nf">Failure</span><span class="p">(</span><span class="s">$"网络错误: </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 记录未预期的异常</span>
        <span class="n">Logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">"未处理的异常"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="nf">Failure</span><span class="p">(</span><span class="s">$"未知错误: </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ❌ 错误：吞掉异常</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">BadExceptionHandling</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="nf">RiskyOperation</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span>
    <span class="p">{</span>
        <span class="c1">// 静默忽略异常是危险的</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="valuetask">ValueTask</h2><p>  ValueTask是Task的轻量级版本，用于避免不必要的内存分配。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 问题场景：缓存场景下的Task分配</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetDataAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_cache</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">out</span> <span class="kt">string</span> <span class="n">cachedValue</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// ❌ 即使数据已缓存（同步可用），仍然分配Task对象</span>
        <span class="k">return</span> <span class="n">cachedValue</span><span class="p">;</span> <span class="c1">// 编译器会包装成 Task.FromResult(cachedValue)</span>
    <span class="p">}</span>
    
    <span class="c1">// 只有这里才真正需要异步</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">_database</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="使用场景分析">使用场景分析</h3><p>  缓存场景下的ValueTask使用示例：</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">readonly</span> <span class="n">ConcurrentDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;</span> <span class="n">_userCache</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>

<span class="k">public</span> <span class="k">async</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="nf">GetUserAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">userId</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_userCache</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">cachedUser</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">cachedUser</span><span class="p">;</span> <span class="c1">// 同步路径，零分配</span>
    <span class="p">}</span>
    
    <span class="kt">var</span> <span class="n">user</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_userService</span><span class="p">.</span><span class="nf">LoadUserAsync</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
    <span class="n">_userCache</span><span class="p">.</span><span class="nf">TryAdd</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">user</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>  条件异步操作的ValueTask使用示例：</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">ProcessAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useAsync</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">useAsync</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 同步处理</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="nf">ProcessSync</span><span class="p">(</span><span class="n">input</span><span class="p">));</span>
    <span class="p">}</span>
    
    <span class="c1">// 异步处理</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="nf">ProcessAsyncInternal</span><span class="p">(</span><span class="n">input</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div><p>  可能立即完成的I/O操作的ValueTask使用示例：</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">async</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">ReadAsync</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 检查缓冲区是否有数据</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_internalBuffer</span><span class="p">.</span><span class="n">Available</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">ReadFromBuffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span> <span class="c1">// 同步完成</span>
        <span class="p">}</span>
        
        <span class="c1">// 需要从网络读取</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">ReadFromNetworkAsync</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div><p>  状态机优化的ValueTask使用示例：</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">enum</span> <span class="n">AsyncState</span> <span class="p">{</span> <span class="n">NotStarted</span><span class="p">,</span> <span class="n">InProgress</span><span class="p">,</span> <span class="n">Completed</span> <span class="p">}</span>
<span class="k">private</span> <span class="n">AsyncState</span> <span class="n">_state</span> <span class="p">=</span> <span class="n">AsyncState</span><span class="p">.</span><span class="n">NotStarted</span><span class="p">;</span>
<span class="k">private</span> <span class="kt">string</span> <span class="n">_result</span><span class="p">;</span>

<span class="k">public</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetOrCreateAsync</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">_state</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">AsyncState</span><span class="p">.</span><span class="n">Completed</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">_result</span><span class="p">);</span> <span class="c1">// 立即返回</span>
            
        <span class="k">case</span> <span class="n">AsyncState</span><span class="p">.</span><span class="n">NotStarted</span><span class="p">:</span>
            <span class="n">_state</span> <span class="p">=</span> <span class="n">AsyncState</span><span class="p">.</span><span class="n">InProgress</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="nf">CreateAsync</span><span class="p">());</span> <span class="c1">// 开始异步操作</span>
            
        <span class="k">case</span> <span class="n">AsyncState</span><span class="p">.</span><span class="n">InProgress</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="nf">WaitForCompletionAsync</span><span class="p">());</span> <span class="c1">// 等待完成</span>
            
        <span class="k">default</span><span class="p">:</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><div class="post-copyright"><p> <span>版权声明：</span> 如无特别声明，本文版权归 <a href="https://www.damonc.top" class="cplink">编程散记</a> 所有，转载请注明本文链接。</p><p> （采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" class="extlinks">CC BY-NC-SA 4.0</a> 许可协议进行授权）</p><p><span>本文标题：</span>《 多线程编程模型篇(三) 》</p><p><span>本文链接：</span><a href="https://www.damonc.top/csharp/CSharp_Thread_Pattern.html" class="cplink">https://www.damonc.top/csharp/CSharp_Thread_Pattern.html</a></p><p class="tips">本文最后一次更新为 <span></span> 天前，文章中的某些内容可能已过时！</p></div></article></div><div class="table-of-contents"><div class="toc-header"><h2>目录</h2></div><div class="toc-body"><ul><li><a onclick="scrollToAdjust('apm模式')">1. APM模式</a><ul><li><a onclick="scrollToAdjust('iasyncresult对象')">1.1 IAsyncResult对象</a><li><a onclick="scrollToAdjust('委托异步操作')">1.2 委托异步操作</a><li><a onclick="scrollToAdjust('异步操作等待')">1.3 异步操作等待</a></ul><li><a onclick="scrollToAdjust('eap模式')">2. EAP模式</a><ul><li><a onclick="scrollToAdjust('eap模式的核心特征')">2.1 EAP模式的核心特征</a><li><a onclick="scrollToAdjust('实现支持eap的类')">2.2 实现支持EAP的类</a></ul><li><a onclick="scrollToAdjust('async/await异步模式')">3. async/await异步模式</a><ul><li><a onclick="scrollToAdjust('状态机')">3.1 状态机</a><li><a onclick="scrollToAdjust('async关键字')">3.2 async关键字</a><li><a onclick="scrollToAdjust('await关键字')">3.3 await关键字</a><li><a onclick="scrollToAdjust('configureawait')">3.4 ConfigureAwait</a><li><a onclick="scrollToAdjust('异常处理模式')">3.5 异常处理模式</a></ul><li><a onclick="scrollToAdjust('valuetask')">4. ValueTask</a><ul><li><a onclick="scrollToAdjust('使用场景分析')">4.1 使用场景分析</a></ul></ul></div></div></div></div><div class="social-share-wrapper"><div class="social-share"></div></div></main><section class="author-detail"><section class="post-footer-item author-card"><div class="avatar"> <img src="https://img.damonc.top/commons/avatar.png" alt=""></div><div class="author-name" rel="author">编程散记</div><div class="bio"><p>Developer & Maintainer</p></div><ul class="sns-links"><li> <a href="https://github.com/damonc-top" target="_blank" aria-label="github"> <svg class="icon" aria-hidden="true"> <use xlink:href="#icon-github"></use> </svg> </a><li> <a href="https://segmentfault.com/u/junyidebocai" target="_blank" aria-label="segmentfault"> <svg class="icon" aria-hidden="true"> <use xlink:href="#icon-segmentfault"></use> </svg> </a></ul></section><section class="post-footer-item read-next"><div class="read-next-item"> <a href="/unity3d/Unity_Assembly_Definition.html" class="read-next-link" aria-label="在Unity中模块化封装实践"></a><section> <span>在Unity中模块化封装实践</span><p>如何进行模块化封装？模块化封装有什么优缺点？</p></section></div></section><script src="https://unpkg.com/@waline/client@3.3.2/dist/waline.umd.js" async onload="initWaline()"></script> <script> function initWaline() { $(document).ready(function () { Waline.init({ el: '#waline', serverURL: "https://comments.damonc.top", reaction: "true", comment: true, locale: "{reaction0: '赞一个', reaction1: '踩一下', reaction2: '有点酷', reaction3: '看不懂', reaction4: '啥玩意', reaction5: '想睡觉'}", }); }); } </script> <script> $(document).ready(function () { if ($("#comments-switch").length > 0) { var comment_status = $("#cmn-toggle-4")[0].checked; if (comment_status) { $("#waline").addClass("active"); } else { $("#disqus_thread").addClass("active"); } $("#cmn-toggle-4").click(function () { $("#disqus_thread").toggleClass("active"); $("#waline").toggleClass("active"); }) } else { if ($("#disqus_thread").length > 0) { $("#disqus_thread").addClass("active"); } else if ($("#waline").length > 0) { $("#waline").addClass("active"); } } }) </script><section class="post-footer-item comment"><div class="comments-headline"> <svg class="icon" aria-hidden="true"> <use xlink:href="#icon-comment"></use> </svg> <span>评论</span></div></section><section class="post-footer-item comment"><div id="waline"></div></section></section><footer class="g-footer"><div class="g-container"><div class="g-left"><section class="links"> 本站由 <a href="//jekyllrb.com" target="_blank" class="extlinks">Jekyll</a> 和 基于 <a href="https://github.com/kaeyleo/jekyll-theme-H2O" target="_blank" class="extlinks">H2O主题模版</a> 强力驱动</section><section class="links">编程散记 © 2016 - 2025 <a href="https://icp.gov.moe/?keyword=20240160" target="_blank" class="extlinks">萌ICP备20240160号</a> <a href="/rss.xml" target="_blank" aria-label="Terms of Service" class="others"> <svg class="icon" aria-hidden="true"> <use xlink:href="#icon-rss"></use> </svg> RSS </a> <a href="/tos" target="_blank" aria-label="Terms of Service" class="others"> <svg class="icon" aria-hidden="true"> <use xlink:href="#icon-tos"></use> </svg> 使用条款 </a></section><section class="links"> <span id="busuanzi_container_site_pv"> <svg class="icon" aria-hidden="true"> <use xlink:href="#icon-pv"></use> </svg> 总浏览量 <span id="busuanzi_value_site_pv"></span> <b>·</b> </span> <span id="busuanzi_container_site_uv"> <svg class="icon" aria-hidden="true"> <use xlink:href="#icon-user"></use> </svg> 总访问量 <span id="busuanzi_value_site_uv"></span> </span></section><section> 本站已运行 <span class="alivetime_days"></span> 天 <span class="alivetime_hours"></span> 小时 <span class="alivetime_minutes"></span> 分 <span class="alivetime_seconds"></span> 秒</section></div><div class="g-right"><section class="badges"> <a href="https://www.foreverblog.cn/" target="_blank" class="foreverblog" aria-label="foreverblog"> <img loading="lazy" src="https://img.foreverblog.cn/logo_en_default.png" alt=""> </a> <a href="https://www.foreverblog.cn/go.html" target="_blank" class="wormhole" aria-label="wormhole"> <img loading="lazy" src="https://img.foreverblog.cn/wormhole_3.gif" alt="" title="穿梭虫洞-随机访问十年之约友链博客"> </a> <a href="https://www.travellings.cn/go.html" target="_blank" class="travelling-badge" aria-label="Travelling" rel="noopener" title="开往-友链接力"> <img loading="lazy" src="https://cdn.jsdelivr.net/gh/travellings-link/travellings/assets/logo.gif" alt="开往-友链接力"> </a> <a href="https://notbyai.fyi/" target="_blank" class="notbyAI" aria-label="notbyAI"> <img loading="lazy" src="/assets/icons/notbyAI-white.png" alt="Written by Human, Not by AI"> </a></section></div></div></footer><div class="cookie-tip"> 为了提升本站的使用体验和必要功能的正常使用，本站会使用本地 Cookie。详细请查看「 <a href="/tos.html">本站使用条款</a> 」了解更多。 <button id="accept-tos">同意</button></div><section id="tools"><div class="tool toc"> <svg class="icon b1 active" aria-hidden="true"> <use xlink:href="#icon-toc"></use> </svg> <svg class="icon b2" aria-hidden="true"> <use xlink:href="#icon-exit"></use> </svg></div></section><section id="bttb" aria-label="Scroll back to top" class="bttb"><div class="tool"> <svg class="icon top" aria-hidden="true"> <use xlink:href="#icon-top"></use> </svg></div></section></div><div class="modal"><div class="modal-content"><header> <span class="close">&times;</span></header><div class="container"></div></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js" async></script> <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.2/dayjs.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.2/plugin/customParseFormat.js"></script> <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.2/plugin/relativeTime.js"></script> <script> $(document).ready(function () { var time_formats = ['YYYY-MM-DD HH:mm:ss ZZ', 'YYYY DD MMM HH:mm:ss ZZ', 'YYYY年MM月DD日 HH:mm:ss ZZ']; function dateFormat(date, format) { var date_org = dayjs(date, time_formats[format]); var date = date_org.format(time_formats[format]); return { "date_org": date_org, "date": date } } dayjs.extend(window.dayjs_plugin_customParseFormat); dayjs.extend(window.dayjs_plugin_relativeTime); var post_date = $("meta[property='post-date']").attr('content'); var post_date_format = $("meta[property='post-date-format']").attr('content'); var local_post_date = dateFormat(post_date, post_date_format); $(".post time span.create-at").html(local_post_date["date"]); var path = "post_project/_posts/2025/downloader/2025-06-03-CSharp_Thread_Pattern.md"; var workerUrl = "https://winter-meadow-170b.damoncbl.workers.dev?" + new URLSearchParams({ path: path }); fetch(workerUrl).then(function (res) { if (!res.ok) throw new Error("worker non-200: " + res.status); return res.json(); }).then(function (commits) { if (commits && commits.length) { var update_at = dayjs(commits[0]['commit']['committer']['date']); } else { var update_at = post_date; } var local_update_at = dateFormat(update_at, post_date_format); $('.post time span.update-at').html(local_update_at["date"]); var relative_time = dayjs().diff(local_update_at["date_org"], 'day'); $(".post-copyright .tips span").append(relative_time); if (relative_time > 365) { $(".post-copyright .tips").addClass("active"); } }).catch(function () { var local_update_at = dateFormat(post_date, post_date_format); $('.post time span.update-at').html(local_update_at["date"]); }); }); </script> <script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script> <script> socialShare('.social-share', { sites: [ 'wechat', 'weibo', 'douban', 'twitter' ], wechatQrcodeTitle: "分享到微信朋友圈", wechatQrcodeHelper: '<p>扫码后点击右上角</p><p>将本文分享至朋友圈</p>' }); $("a.social-share-icon").each(function () { $(this).attr("aria-label", $(this).attr("class").split(' ')[1]) }); </script> <script src="https://cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script> <script> function scrollToAdjust(id){ var element = document.getElementById(id); var headerOffset = 90; var elementPosition = element.getBoundingClientRect().top; var offsetPosition = elementPosition + window.scrollY - headerOffset; window.scrollTo({ top: offsetPosition, behavior: "smooth" }); } </script> <script src="/assets/js/app.min.js"></script> <script src="https://at.alicdn.com/t/c/font_3046306_ujr2yq34hw.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=GTM-WN45VXRK"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'GTM-WN45VXRK'); </script> <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> <script async src="https://cdn.jsdelivr.net/npm/promise-polyfill@8.3.0/dist/polyfill.min.js"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax-full@3.2.2/es5/tex-mml-svg.min.js"></script> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ jax: ["input/TeX", "output/HTML-CSS"], tex2jax: { inlineMath: [['$', '$'], ["\\(", "\\)"]], processEscapes: true, skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'] }, "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] } }); </script> <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.min.js"></script> <script> $(document).ready(function () { var baseurl = $("meta[property='og:baseurl']").attr('content'); $("center img").each(function () { $(this).attr('data-src', $(this).attr('src')).removeAttr('src').addClass("lazyload").attr('src', baseurl + '/assets/img/loading.gif'); var strA = "<a data-fancybox='gallery' ref='gallery' href='" + $(this).attr('data-src') + "' data-caption='" + $(this).attr('alt') + "'></a>"; $(this).wrapAll(strA); var caption = $(this)[0].alt; $(this).parent().after('<span class="caption">' + caption + '</span>'); }); Fancybox.bind('[data-fancybox]', { on: { load: function(fancybox, slide) { var gray = $("meta[property='og:gray']").attr('content'); if (gray == "true") { $(".fancybox__content img").addClass("gray"); $(".carousel__track .fancybox__thumb").addClass("gray"); } } } }); }); </script> <script src="https://cdn.jsdelivr.net/npm/hotkeys-js/dist/hotkeys.min.js"></script> <script> $(document).ready(function () { var previous_url = $("meta[property='og:previous_url']").attr('content'); var next_url = $("meta[property='og:next_url']").attr('content'); hotkeys('left', function (event, handler) { event.preventDefault(); if (previous_url) { console.log('you pressed left!'); window.location.href = previous_url; } else { $("#no-previous").addClass("active"); setTimeout(function () { $("#no-previous").removeClass("active"); }, 1500); } }); hotkeys('right', function (event, handler) { event.preventDefault(); if (next_url) { console.log('you pressed right!'); window.location.href = next_url; } else { $("#no-next").addClass("active"); setTimeout(function () { $("#no-next").removeClass("active"); }, 1500); } }); }); </script> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script> <script> $(document).ready(function () { mermaid.initialize({ startOnLoad: true, theme: "default", }); mermaid.init(undefined, $('.mermaid2')); }); </script> <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script> <script> if (window.Prism) { Prism.languages.mermaid2 = Prism.languages.none || {}; } </script> <script> if ("serviceWorker" in navigator) { var env = 'development'; var isDev = env === 'development'; navigator.serviceWorker .register('/sw.js', { scope: '/' }) .then(function (reg) { if (isDev) console.log("Service worker registered for scope:", reg.scope); }) .catch(function (err) { if (isDev) console.warn("Service worker registration failed:", err); }); } </script> <script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script> <script type="text/javascript"> docsearch({ appId: "NCUJ5WJECO", apiKey: "b625a4b91a45af033cbdb526694e9e65", indexName: "damonc", lang: "zh", insights: true, debug: false, container: 'li#search', }); </script>
