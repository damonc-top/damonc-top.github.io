<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="自定义渲染管线:点光源与聚光灯 (翻译九)" /><meta name="author" content="catlikecoding" /><meta property="og:locale" content="en" /><meta name="description" content="扩展渲染管线以支持点光源和聚光灯，包含实时渲染和烘焙光照，同时实现每物体最多8个光源的限制。" /><meta property="og:description" content="扩展渲染管线以支持点光源和聚光灯，包含实时渲染和烘焙光照，同时实现每物体最多8个光源的限制。" /><link rel="canonical" href="www.damonc.top/posts/point-spot-lights/" /><meta property="og:url" content="www.damonc.top/posts/point-spot-lights/" /><meta property="og:site_name" content="仗剑天涯" /><meta property="og:image" content="https://img.damonc.top/posts/SRP/srp9/tutorial-image.jpg" /><meta property="og:image:alt" content="point and spot lights." /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-05-31T18:00:00+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://img.damonc.top/posts/SRP/srp9/tutorial-image.jpg" /><meta name="twitter:image:alt" content="point and spot lights." /><meta property="twitter:title" content="自定义渲染管线:点光源与聚光灯 (翻译九)" /><meta name="twitter:site" content="@elonmusk" /><meta name="twitter:creator" content="@catlikecoding" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"catlikecoding","url":"https://catlikecoding.com/unity/tutorials"},"dateModified":"2026-02-20T15:11:33+08:00","datePublished":"2020-05-31T18:00:00+08:00","description":"扩展渲染管线以支持点光源和聚光灯，包含实时渲染和烘焙光照，同时实现每物体最多8个光源的限制。","headline":"自定义渲染管线:点光源与聚光灯 (翻译九)","image":{"lqip":"data:image/webp;base64,UklGRloAAABXRUJQVlA4IE4AAABwAwCdASoUAAoAP3Gixlk0rCejsAgCkC4JYwAAWJPaJJwg/GgA/tzUcQ2uGfQ+y7E+3j1yvt/HKjrTv8gACoFK3hA1b4y0dnUoj7OAAAA=","alt":"point and spot lights.","url":"https://img.damonc.top/posts/SRP/srp9/tutorial-image.jpg","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"www.damonc.top/posts/point-spot-lights/"},"url":"www.damonc.top/posts/point-spot-lights/"}</script><meta name="fediverse:creator" content="@damonc@mastodon.social"><title>自定义渲染管线:点光源与聚光灯 (翻译九) | 仗剑天涯</title><link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="preconnect" href="https://fonts.loli.net" ><link rel="dns-prefetch" href="https://fonts.loli.net" ><link rel="preconnect" href="https://gstatic.loli.net" crossorigin><link rel="dns-prefetch" href="https://gstatic.loli.net" ><link rel="preconnect" href="https://fastly.jsdelivr.net" ><link rel="dns-prefetch" href="https://fastly.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script type="module" src="/assets/js/dist/theme.min.js"></script> <script> /* Apply sidebar collapsed state as early as possible to prevent flickering */ if (localStorage.getItem('sidebar-collapsed') === 'true') { document.documentElement.setAttribute('data-sidebar-collapsed', 'true'); } </script> <script defer src="https://fastly.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js,npm/mermaid@11.12.0/dist/mermaid.min.js"></script> <script type="module" defer src="/assets/js/dist/post.min.js"></script> <script src="/assets/js/data/mathjax.js"></script> <script async src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://fastly.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script> <script type="module"> window.WalinePrefix = "/pro"; import { pageviewCount } from '/assets/js/dist/waline.min.js'; pageviewCount({ serverURL: 'https://comments.damonc.top', update: true }); </script> <script type="module" defer src="/app.min.js?baseurl=&register=true" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"> <button type="button" id="sidebar-collapse-btn" class="btn" aria-label="Toggle Sidebar"> <i class="fas fa-bars-staggered"></i> </button><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="https://img.damonc.top/commons/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">仗剑天涯</a><p class="site-subtitle fst-italic mb-0">听说读写看做忘</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/damonc-top" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/elonmusk" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['damoncbl','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>自定义渲染管线:点光源与聚光灯 (翻译九)</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>自定义渲染管线:点光源与聚光灯 (翻译九)</h1><p class="post-desc fw-light mb-4">扩展渲染管线以支持点光源和聚光灯，包含实时渲染和烘焙光照，同时实现每物体最多8个光源的限制。</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1590919200" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 31, 2020 </time> </span> <span> Updated <time data-ts="1771571493" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 20, 2026 </time> </span><div class="mt-3 mb-3"> <a href="https://img.damonc.top/posts/SRP/srp9/tutorial-image.jpg" class="popup img-link preview-img blur"><img data-src="https://img.damonc.top/posts/SRP/srp9/tutorial-image.jpg" alt="point and spot lights." width="1200" height="630" data-lqip="true" src="data:image/webp;base64,UklGRloAAABXRUJQVlA4IE4AAABwAwCdASoUAAoAP3Gixlk0rCejsAgCkC4JYwAAWJPaJJwg/GgA/tzUcQ2uGfQ+y7E+3j1yvt/HKjrTv8gACoFK3hA1b4y0dnUoj7OAAAA="></a><figcaption class="text-center pt-2 pb-2">point and spot lights.</figcaption></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://catlikecoding.com/unity/tutorials">catlikecoding</a> </em> </span><div> <span> <em class="waline-pageview-count" data-path="/posts/point-spot-lights/"> <i class="fas fa-spinner fa-spin small"></i> </em> views </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="5490 words" > <em>30 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">自定义渲染管线:点光源与聚光灯 (翻译九)</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">自定义渲染管线:点光源与聚光灯 (翻译九)</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><ul><li>支持更多光源类型，而不仅限于方向光。<li>包含实时点光源和聚光灯。<li>为点光源和聚光灯烘焙光照和阴影。<li>限制每个对象最多渲染8个其他光源。</ul><hr /><h2 id="背景为什么需要更多光源类型"><span class="me-2">背景：为什么需要更多光源类型？</span><a href="#背景为什么需要更多光源类型" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>在此之前，我们只实现了方向光。方向光是一种理想化的无限远光源，它从同一方向照射到所有表面，不考虑距离。然而，真实游戏场景中的光照远比这复杂:玩家需要点燃的灯笼、汽车的前灯、舞台上的聚光灯等。这些光源都有具体的位置，光照强度随距离变化。</p><h2 id="点光源基础"><span class="me-2">点光源基础</span><a href="#点光源基础" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>点光源位于空间中的一个点，并向各个方向均匀地发射光线。光线照射到物体表面时，其方向是从接触点指向光源中心的连线。光强随距离的增加而减弱，并在特定距离处降至零。光强与光源距离的平方成反比。这被称为“平方反比定律”，与光在现实世界中的行为类似。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">光强随距离增加而减弱。射程是指光强从最大值衰减到零值的距离。</figcaption></figure><p>点光源可用于模拟场景中的灯具和其他局部光源。可以用它们来制造火花或爆炸，并以逼真的方式照亮周围环境。</p><h3 id="光源数量限制"><span class="me-2">光源数量限制</span><a href="#光源数量限制" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>与方向光类似，我们也只能支持有限数量的其他类型光源。场景中通常包含大量非方向光，因为它们的影响范围是有限的。对于任何给定帧，只有部分光源是可见的。因此，最大数量限制是针对单帧而言，而非整个场景。</p><p>如果可见光源数量超过限制，一些光源将被忽略。Unity 会根据重要性对可见光源列表进行排序，因此只要可见光源不变化，被忽略的光源也是一致的。但如果相机移动或场景变化，可能导致明显的光源突现（light popping）。</p><p>我们在 <code class="language-plaintext highlighter-rouge">Lighting</code> 类中定义最多支持 64 个其他光源：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">const</span> <span class="kt">int</span> <span class="n">maxDirLightCount</span> <span class="p">=</span> <span class="m">4</span><span class="p">,</span> <span class="n">maxOtherLightCount</span> <span class="p">=</span> <span class="m">64</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="传递光源数据到-gpu"><span class="me-2">传递光源数据到 GPU</span><a href="#传递光源数据到-gpu" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>与方向光一样，我们需要将光源数量和颜色发送到 GPU。对于其他光源类型，还需要发送位置信息。</p><p>首先在 <code class="language-plaintext highlighter-rouge">Lighting</code> 中添加着色器属性 ID 和数组字段：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span>
<span class="n">otherLightCountId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightCount"</span><span class="p">),</span>
<span class="n">otherLightColorsId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightColors"</span><span class="p">),</span>
<span class="n">otherLightPositionsId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightPositions"</span><span class="p">);</span>

<span class="k">static</span> <span class="n">Vector4</span><span class="p">[]</span>
<span class="n">otherLightColors</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="n">maxOtherLightCount</span><span class="p">],</span>
<span class="n">otherLightPositions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="n">maxOtherLightCount</span><span class="p">];</span>
</pre></table></code></div></div><p>然后在 <code class="language-plaintext highlighter-rouge">SetupLights</code> 方法中处理其他光源的计数和数据传递：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">SetupLights</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">NativeArray</span><span class="p">&lt;</span><span class="n">VisibleLight</span><span class="p">&gt;</span> <span class="n">visibleLights</span> <span class="p">=</span> <span class="n">cullingResults</span><span class="p">.</span><span class="n">visibleLights</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">dirLightCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">otherLightCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">visibleLights</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
        <span class="c1">// ... 处理光源</span>
    <span class="p">}</span>

    <span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalInt</span><span class="p">(</span><span class="n">otherLightCountId</span><span class="p">,</span> <span class="n">otherLightCount</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">otherLightCount</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalVectorArray</span><span class="p">(</span><span class="n">otherLightColorsId</span><span class="p">,</span> <span class="n">otherLightColors</span><span class="p">);</span>
        <span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalVectorArray</span><span class="p">(</span>
            <span class="n">otherLightPositionsId</span><span class="p">,</span> <span class="n">otherLightPositions</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="着色器端的数据定义"><span class="me-2">着色器端的数据定义</span><a href="#着色器端的数据定义" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在 <code class="language-plaintext highlighter-rouge">Light</code> 着色器文件中定义其他光源的最大数量和缓冲区：</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="cp">#define MAX_DIRECTIONAL_LIGHT_COUNT 4
#define MAX_OTHER_LIGHT_COUNT 64
</span>
<span class="n">CBUFFER_START</span><span class="p">(</span><span class="n">_CustomLight</span><span class="p">)</span>
    <span class="n">int</span> <span class="n">_DirectionalLightCount</span><span class="p">;</span>
    <span class="kt">float4</span> <span class="n">_DirectionalLightColors</span><span class="p">[</span><span class="n">MAX_DIRECTIONAL_LIGHT_COUNT</span><span class="p">];</span>
    <span class="kt">float4</span> <span class="n">_DirectionalLightDirections</span><span class="p">[</span><span class="n">MAX_DIRECTIONAL_LIGHT_COUNT</span><span class="p">];</span>
    <span class="kt">float4</span> <span class="n">_DirectionalLightShadowData</span><span class="p">[</span><span class="n">MAX_DIRECTIONAL_LIGHT_COUNT</span><span class="p">];</span>

    <span class="n">int</span> <span class="n">_OtherLightCount</span><span class="p">;</span>
    <span class="kt">float4</span> <span class="n">_OtherLightColors</span><span class="p">[</span><span class="n">MAX_OTHER_LIGHT_COUNT</span><span class="p">];</span>
    <span class="kt">float4</span> <span class="n">_OtherLightPositions</span><span class="p">[</span><span class="n">MAX_OTHER_LIGHT_COUNT</span><span class="p">];</span>
<span class="n">CBUFFER_END</span>
</pre></table></code></div></div><p>添加一个函数来获取其他光源的数量：</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">int</span> <span class="nf">GetOtherLightCount</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">_OtherLightCount</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="点光源设置方法"><span class="me-2">点光源设置方法</span><a href="#点光源设置方法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>创建 <code class="language-plaintext highlighter-rouge">SetupPointLight</code> 方法来设置点光源的颜色和位置：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">SetupPointLight</span> <span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="k">ref</span> <span class="n">VisibleLight</span> <span class="n">visibleLight</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">otherLightColors</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">finalColor</span><span class="p">;</span>
    <span class="n">otherLightPositions</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">localToWorldMatrix</span><span class="p">.</span><span class="nf">GetColumn</span><span class="p">(</span><span class="m">3</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="修改光源循环"><span class="me-2">修改光源循环</span><a href="#修改光源循环" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>修改 <code class="language-plaintext highlighter-rouge">SetupLights</code> 中的循环，使用 <code class="language-plaintext highlighter-rouge">switch</code> 语句区分不同类型的光源：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">visibleLights</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
    <span class="n">VisibleLight</span> <span class="n">visibleLight</span> <span class="p">=</span> <span class="n">visibleLights</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">visibleLight</span><span class="p">.</span><span class="n">lightType</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">LightType</span><span class="p">.</span><span class="n">Directional</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dirLightCount</span> <span class="p">&lt;</span> <span class="n">maxDirLightCount</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">SetupDirectionalLight</span><span class="p">(</span><span class="n">dirLightCount</span><span class="p">++,</span> <span class="k">ref</span> <span class="n">visibleLight</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">LightType</span><span class="p">.</span><span class="n">Point</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">otherLightCount</span> <span class="p">&lt;</span> <span class="n">maxOtherLightCount</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">SetupPointLight</span><span class="p">(</span><span class="n">otherLightCount</span><span class="p">++,</span> <span class="k">ref</span> <span class="n">visibleLight</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="光照计算"><span class="me-2">光照计算</span><a href="#光照计算" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在着色器中添加 <code class="language-plaintext highlighter-rouge">GetOtherLight</code> 函数来计算点光源的光照：</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">Light</span> <span class="nf">GetOtherLight</span> <span class="p">(</span><span class="n">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">Surface</span> <span class="n">surfaceWS</span><span class="p">,</span> <span class="n">ShadowData</span> <span class="n">shadowData</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Light</span> <span class="n">light</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_OtherLightColors</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">rgb</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">ray</span> <span class="o">=</span> <span class="n">_OtherLightPositions</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">surfaceWS</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">ray</span><span class="p">);</span>
    <span class="n">light</span><span class="p">.</span><span class="n">attenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">light</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在 <code class="language-plaintext highlighter-rouge">GetLighting</code> 函数中添加循环来处理其他光源：</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">GetLighting</span> <span class="p">(</span><span class="n">Surface</span> <span class="n">surfaceWS</span><span class="p">,</span> <span class="n">BRDF</span> <span class="n">brdf</span><span class="p">,</span> <span class="n">GI</span> <span class="n">gi</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ShadowData</span> <span class="n">shadowData</span> <span class="o">=</span> <span class="n">GetShadowData</span><span class="p">(</span><span class="n">surfaceWS</span><span class="p">);</span>
    <span class="n">shadowData</span><span class="p">.</span><span class="n">shadowMask</span> <span class="o">=</span> <span class="n">gi</span><span class="p">.</span><span class="n">shadowMask</span><span class="p">;</span>

    <span class="kt">float3</span> <span class="n">color</span> <span class="o">=</span> <span class="n">IndirectBRDF</span><span class="p">(</span><span class="n">surfaceWS</span><span class="p">,</span> <span class="n">brdf</span><span class="p">,</span> <span class="n">gi</span><span class="p">.</span><span class="n">diffuse</span><span class="p">,</span> <span class="n">gi</span><span class="p">.</span><span class="n">specular</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GetDirectionalLightCount</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Light</span> <span class="n">light</span> <span class="o">=</span> <span class="n">GetDirectionalLight</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">surfaceWS</span><span class="p">,</span> <span class="n">shadowData</span><span class="p">);</span>
        <span class="n">color</span> <span class="o">+=</span> <span class="n">GetLighting</span><span class="p">(</span><span class="n">surfaceWS</span><span class="p">,</span> <span class="n">brdf</span><span class="p">,</span> <span class="n">light</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">GetOtherLightCount</span><span class="p">();</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Light</span> <span class="n">light</span> <span class="o">=</span> <span class="n">GetOtherLight</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">surfaceWS</span><span class="p">,</span> <span class="n">shadowData</span><span class="p">);</span>
        <span class="n">color</span> <span class="o">+=</span> <span class="n">GetLighting</span><span class="p">(</span><span class="n">surfaceWS</span><span class="p">,</span> <span class="n">brdf</span><span class="p">,</span> <span class="n">light</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/point-lights.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/point-lights.png" alt="场景中的点光源渲染效果" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">场景中的点光源渲染效果</figcaption></figure><h2 id="距离衰减"><span class="me-2">距离衰减</span><a href="#距离衰减" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="逆平方定律"><span class="me-2">逆平方定律</span><a href="#逆平方定律" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>目前的点光源虽然可以工作，但亮度衰减不正确。光从光源发出后会散开，距离越远，光线越分散，亮度也随之降低。光照强度遵循<strong>逆平方定律</strong>：</p>\[I = \frac{i}{d^2}\]<p>其中 $i$ 是配置的强度，$d$ 是距离。这意味着在距离小于 1 的地方，强度会大于配置值——光源附近会非常亮。</p><p>在 <code class="language-plaintext highlighter-rouge">GetOtherLight</code> 中应用距离衰减：</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">float</span> <span class="n">distanceSqr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">ray</span><span class="p">,</span> <span class="n">ray</span><span class="p">),</span> <span class="mi">0</span><span class="p">.</span><span class="mo">00001</span><span class="p">);</span>
<span class="n">light</span><span class="p">.</span><span class="n">attenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="n">distanceSqr</span><span class="p">;</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/distance-attenuation.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/distance-attenuation.png" alt="距离衰减效果和曲线图" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/distance-attenuation-graph.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/distance-attenuation-graph.png" alt="距离衰减效果和曲线图" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">距离衰减效果和曲线图</figcaption></figure><h3 id="光源范围"><span class="me-2">光源范围</span><a href="#光源范围" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>虽然点光源强度随距离快速衰减，但理论上它们仍然会影响所有物体，即使距离很远。为了实际渲染，我们使用最大光源范围，超过该范围后强制将光照强度设为 0。</p><p>这样点光源被限制在一个由位置和范围定义的边界球体内。</p><p>我们不会在范围边界突然切断光照，而是使用范围衰减来平滑淡出。Unity 的通用渲染管线（URP）和光照贴图使用以下公式：</p>\[f(x) = \max\left(0, 1 - \left(\frac{d^2}{r^2}\right)^2\right)\]<p>其中 $d$ 是距离，$r$ 是光源范围。</p><h3 id="存储范围数据"><span class="me-2">存储范围数据</span><a href="#存储范围数据" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>将范围存储在位置向量的第四个分量中。存储 $1/r^2$ 而不是 $r$，以减少着色器中的计算：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">SetupPointLight</span> <span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="k">ref</span> <span class="n">VisibleLight</span> <span class="n">visibleLight</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">otherLightColors</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">finalColor</span><span class="p">;</span>
    <span class="n">Vector4</span> <span class="n">position</span> <span class="p">=</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">localToWorldMatrix</span><span class="p">.</span><span class="nf">GetColumn</span><span class="p">(</span><span class="m">3</span><span class="p">);</span>
    <span class="n">position</span><span class="p">.</span><span class="n">w</span> <span class="p">=</span> <span class="m">1f</span> <span class="p">/</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Max</span><span class="p">(</span><span class="n">visibleLight</span><span class="p">.</span><span class="n">range</span> <span class="p">*</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">range</span><span class="p">,</span> <span class="m">0.00001f</span><span class="p">);</span>
    <span class="n">otherLightPositions</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">position</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在着色器中应用范围衰减：</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">float</span> <span class="n">distanceSqr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">ray</span><span class="p">,</span> <span class="n">ray</span><span class="p">),</span> <span class="mi">0</span><span class="p">.</span><span class="mo">00001</span><span class="p">);</span>
<span class="n">float</span> <span class="n">rangeAttenuation</span> <span class="o">=</span> <span class="n">Square</span><span class="p">(</span>
    <span class="nb">saturate</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="n">Square</span><span class="p">(</span><span class="n">distanceSqr</span> <span class="o">*</span> <span class="n">_OtherLightPositions</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">w</span><span class="p">))</span>
<span class="p">);</span>
<span class="n">light</span><span class="p">.</span><span class="n">attenuation</span> <span class="o">=</span> <span class="n">rangeAttenuation</span> <span class="o">/</span> <span class="n">distanceSqr</span><span class="p">;</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/range-attenuation.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/range-attenuation.png" alt="范围衰减效果和曲线图" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/range-attenuation-graph.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/range-attenuation-graph.png" alt="范围衰减效果和曲线图" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">范围衰减效果和曲线图</figcaption></figure><h2 id="聚光灯"><span class="me-2">聚光灯</span><a href="#聚光灯" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>与点光源类似，聚光灯也具有特定的位置和范围，光线会在该范围内衰减。然而，聚光灯的照射角度受到限制，从而形成一个锥形照明区域。锥体的中心指向光源的前方（Z轴）方向。聚光灯锥体边缘的光线也会减弱。增大照射角度会增加锥体的宽度，同时也会增加这种衰减区域（称为“半影”）的大小。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/SpotLightDiagram.svg" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/SpotLightDiagram.svg" alt="光锥的宽度称为角度，光线强度从全强度到零强度变化的距离称为射程。" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">光锥的宽度称为角度，光线强度从全强度到零强度变化的距离称为射程。</figcaption></figure><h3 id="聚光灯概述"><span class="me-2">聚光灯概述</span><a href="#聚光灯概述" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>聚光灯通常用于人造光源，例如手电筒、汽车前灯和探照灯。通过脚本或动画控制方向，移动的聚光灯可以照亮场景中的一小部分区域，从而营造出戏剧性的光影效果。</p><h3 id="方向属性"><span class="me-2">方向属性</span><a href="#方向属性" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>聚光灯既有位置也有方向。需要在 <code class="language-plaintext highlighter-rouge">Lighting</code> 中添加方向属性和数组：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span>
<span class="n">otherLightCountId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightCount"</span><span class="p">),</span>
<span class="n">otherLightColorsId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightColors"</span><span class="p">),</span>
<span class="n">otherLightPositionsId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightPositions"</span><span class="p">),</span>
<span class="n">otherLightDirectionsId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightDirections"</span><span class="p">);</span>

<span class="k">static</span> <span class="n">Vector4</span><span class="p">[]</span>
<span class="n">otherLightColors</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="n">maxOtherLightCount</span><span class="p">],</span>
<span class="n">otherLightPositions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="n">maxOtherLightCount</span><span class="p">],</span>
<span class="n">otherLightDirections</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="n">maxOtherLightCount</span><span class="p">];</span>
</pre></table></code></div></div><p>创建 <code class="language-plaintext highlighter-rouge">SetupSpotLight</code> 方法，类似于 <code class="language-plaintext highlighter-rouge">SetupPointLight</code>，但额外存储光源方向：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">SetupSpotLight</span> <span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="k">ref</span> <span class="n">VisibleLight</span> <span class="n">visibleLight</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">otherLightColors</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">finalColor</span><span class="p">;</span>
    <span class="n">Vector4</span> <span class="n">position</span> <span class="p">=</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">localToWorldMatrix</span><span class="p">.</span><span class="nf">GetColumn</span><span class="p">(</span><span class="m">3</span><span class="p">);</span>
    <span class="n">position</span><span class="p">.</span><span class="n">w</span> <span class="p">=</span> <span class="m">1f</span> <span class="p">/</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Max</span><span class="p">(</span><span class="n">visibleLight</span><span class="p">.</span><span class="n">range</span> <span class="p">*</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">range</span><span class="p">,</span> <span class="m">0.00001f</span><span class="p">);</span>
    <span class="n">otherLightPositions</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">otherLightDirections</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="p">-</span><span class="n">visibleLight</span><span class="p">.</span><span class="n">localToWorldMatrix</span><span class="p">.</span><span class="nf">GetColumn</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在循环中添加聚光灯的处理分支：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">case</span> <span class="n">LightType</span><span class="p">.</span><span class="n">Spot</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">otherLightCount</span> <span class="p">&lt;</span> <span class="n">maxOtherLightCount</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">SetupSpotLight</span><span class="p">(</span><span class="n">otherLightCount</span><span class="p">++,</span> <span class="k">ref</span> <span class="n">visibleLight</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="着色器中的聚光灯衰减"><span class="me-2">着色器中的聚光灯衰减</span><a href="#着色器中的聚光灯衰减" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在缓冲区中添加方向数组，并在 <code class="language-plaintext highlighter-rouge">GetOtherLight</code> 中应用聚光灯衰减。简单做法是使用聚光灯方向和光线方向点积的饱和值：</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kt">float4</span> <span class="n">_OtherLightDirections</span><span class="p">[</span><span class="n">MAX_OTHER_LIGHT_COUNT</span><span class="p">];</span>

<span class="n">float</span> <span class="n">spotAttenuation</span> <span class="o">=</span> <span class="nb">saturate</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">_OtherLightDirections</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">xyz</span><span class="p">,</span> <span class="n">light</span><span class="p">.</span><span class="n">direction</span><span class="p">));</span>
<span class="n">light</span><span class="p">.</span><span class="n">attenuation</span> <span class="o">=</span> <span class="n">spotAttenuation</span> <span class="o">*</span> <span class="n">rangeAttenuation</span> <span class="o">/</span> <span class="n">distanceSqr</span><span class="p">;</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/spot-lights.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/spot-lights.png" alt="聚光灯效果和角度衰减" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/spot-angle-attenuation.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/spot-angle-attenuation.png" alt="聚光灯效果和角度衰减" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">聚光灯效果和角度衰减</figcaption></figure><h3 id="聚光灯角度控制"><span class="me-2">聚光灯角度控制</span><a href="#聚光灯角度控制" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>聚光灯有一个角度来控制光锥的宽度。这个角度是从中心测量的，所以 90° 角相当于上面看到的效果。除此之外，还有单独的内角（inner angle）控制光照何时开始衰减。</p><p>URP 和光照贴图使用的公式是：</p>\[\text{attenuation} = \text{saturate}\left(\frac{d - \cos(\theta_{outer})}{\cos(\theta_{inner}) - \cos(\theta_{outer})}\right)^2\]<p>其中 $d$ 是点积，$\cos(\theta_{inner})$ 和 $\cos(\theta_{outer})$ 分别是内外角度的余弦值。</p><h3 id="角度参数计算"><span class="me-2">角度参数计算</span><a href="#角度参数计算" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>定义聚光灯角度数组：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span>
<span class="n">otherLightCountId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightCount"</span><span class="p">),</span>
<span class="n">otherLightColorsId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightColors"</span><span class="p">),</span>
<span class="n">otherLightPositionsId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightPositions"</span><span class="p">),</span>
<span class="n">otherLightDirectionsId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightDirections"</span><span class="p">),</span>
<span class="n">otherLightSpotAnglesId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightSpotAngles"</span><span class="p">);</span>

<span class="k">static</span> <span class="n">Vector4</span><span class="p">[]</span>
<span class="n">otherLightColors</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="n">maxOtherLightCount</span><span class="p">],</span>
<span class="n">otherLightPositions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="n">maxOtherLightCount</span><span class="p">],</span>
<span class="n">otherLightDirections</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="n">maxOtherLightCount</span><span class="p">],</span>
<span class="n">otherLightSpotAngles</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="n">maxOtherLightCount</span><span class="p">];</span>
</pre></table></code></div></div><p>在 <code class="language-plaintext highlighter-rouge">SetupSpotLight</code> 中计算角度参数：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">SetupSpotLight</span> <span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="k">ref</span> <span class="n">VisibleLight</span> <span class="n">visibleLight</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">otherLightColors</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">finalColor</span><span class="p">;</span>
    <span class="n">Vector4</span> <span class="n">position</span> <span class="p">=</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">localToWorldMatrix</span><span class="p">.</span><span class="nf">GetColumn</span><span class="p">(</span><span class="m">3</span><span class="p">);</span>
    <span class="n">position</span><span class="p">.</span><span class="n">w</span> <span class="p">=</span> <span class="m">1f</span> <span class="p">/</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Max</span><span class="p">(</span><span class="n">visibleLight</span><span class="p">.</span><span class="n">range</span> <span class="p">*</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">range</span><span class="p">,</span> <span class="m">0.00001f</span><span class="p">);</span>
    <span class="n">otherLightPositions</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">otherLightDirections</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="p">-</span><span class="n">visibleLight</span><span class="p">.</span><span class="n">localToWorldMatrix</span><span class="p">.</span><span class="nf">GetColumn</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>

    <span class="n">Light</span> <span class="n">light</span> <span class="p">=</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">light</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">innerCos</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">Mathf</span><span class="p">.</span><span class="n">Deg2Rad</span> <span class="p">*</span> <span class="m">0.5f</span> <span class="p">*</span> <span class="n">light</span><span class="p">.</span><span class="n">innerSpotAngle</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">outerCos</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">Mathf</span><span class="p">.</span><span class="n">Deg2Rad</span> <span class="p">*</span> <span class="m">0.5f</span> <span class="p">*</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">spotAngle</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">angleRangeInv</span> <span class="p">=</span> <span class="m">1f</span> <span class="p">/</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Max</span><span class="p">(</span><span class="n">innerCos</span> <span class="p">-</span> <span class="n">outerCos</span><span class="p">,</span> <span class="m">0.001f</span><span class="p">);</span>
    <span class="n">otherLightSpotAngles</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector4</span><span class="p">(</span>
        <span class="n">angleRangeInv</span><span class="p">,</span> <span class="p">-</span><span class="n">outerCos</span> <span class="p">*</span> <span class="n">angleRangeInv</span>
    <span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p><strong>注意</strong>：内角是 Unity 的新功能。<code class="language-plaintext highlighter-rouge">VisibleLight</code> 结构体可能没有存储它，因为这会改变其大小并需要重构 Unity 内部代码。</p></blockquote><h3 id="着色器中的角度衰减"><span class="me-2">着色器中的角度衰减</span><a href="#着色器中的角度衰减" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在着色器中添加角度数组并调整衰减计算：</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kt">float4</span> <span class="n">_OtherLightDirections</span><span class="p">[</span><span class="n">MAX_OTHER_LIGHT_COUNT</span><span class="p">];</span>
<span class="kt">float4</span> <span class="n">_OtherLightSpotAngles</span><span class="p">[</span><span class="n">MAX_OTHER_LIGHT_COUNT</span><span class="p">];</span>

<span class="kt">float4</span> <span class="n">spotAngles</span> <span class="o">=</span> <span class="n">_OtherLightSpotAngles</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="n">float</span> <span class="n">spotAttenuation</span> <span class="o">=</span> <span class="n">Square</span><span class="p">(</span>
    <span class="nb">saturate</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">_OtherLightDirections</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">xyz</span><span class="p">,</span> <span class="n">light</span><span class="p">.</span><span class="n">direction</span><span class="p">)</span> <span class="o">*</span>
    <span class="n">spotAngles</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">spotAngles</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
<span class="p">);</span>
<span class="n">light</span><span class="p">.</span><span class="n">attenuation</span> <span class="o">=</span> <span class="n">spotAttenuation</span> <span class="o">*</span> <span class="n">rangeAttenuation</span> <span class="o">/</span> <span class="n">distanceSqr</span><span class="p">;</span>
</pre></table></code></div></div><p>确保点光源不受角度衰减影响：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">SetupPointLight</span> <span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="k">ref</span> <span class="n">VisibleLight</span> <span class="n">visibleLight</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">otherLightColors</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">finalColor</span><span class="p">;</span>
    <span class="n">Vector4</span> <span class="n">position</span> <span class="p">=</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">localToWorldMatrix</span><span class="p">.</span><span class="nf">GetColumn</span><span class="p">(</span><span class="m">3</span><span class="p">);</span>
    <span class="n">position</span><span class="p">.</span><span class="n">w</span> <span class="p">=</span> <span class="m">1f</span> <span class="p">/</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Max</span><span class="p">(</span><span class="n">visibleLight</span><span class="p">.</span><span class="n">range</span> <span class="p">*</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">range</span><span class="p">,</span> <span class="m">0.00001f</span><span class="p">);</span>
    <span class="n">otherLightPositions</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">otherLightSpotAngles</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector4</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/inner-outer-spot-angle-slider.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/inner-outer-spot-angle-slider.png" alt="内角外角调节滑块和不同内角效果" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/different-inner-angles.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/different-inner-angles.png" alt="内角外角调节滑块和不同内角效果" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">内角外角调节滑块和不同内角效果</figcaption></figure><h3 id="配置内角"><span class="me-2">配置内角</span><a href="#配置内角" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>默认情况下，Unity 的光源检视面板不显示内角选项。我们可以创建自定义编辑器脚本来暴露这个功能：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEditor</span><span class="p">;</span>

<span class="p">[</span><span class="n">CanEditMultipleObjects</span><span class="p">]</span>
<span class="p">[</span><span class="nf">CustomEditorForRenderPipeline</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Light</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CustomRenderPipelineAsset</span><span class="p">))]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">CustomLightEditor</span> <span class="p">:</span> <span class="n">LightEditor</span> <span class="p">{}</span>

<span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnInspectorGUI</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">base</span><span class="p">.</span><span class="nf">OnInspectorGUI</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="p">!</span><span class="n">settings</span><span class="p">.</span><span class="n">lightType</span><span class="p">.</span><span class="n">hasMultipleDifferentValues</span> <span class="p">&amp;&amp;</span>
        <span class="p">(</span><span class="n">LightType</span><span class="p">)</span><span class="n">settings</span><span class="p">.</span><span class="n">lightType</span><span class="p">.</span><span class="n">enumValueIndex</span> <span class="p">==</span> <span class="n">LightType</span><span class="p">.</span><span class="n">Spot</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="n">settings</span><span class="p">.</span><span class="nf">DrawInnerAndOuterSpotAngle</span><span class="p">();</span>
        <span class="n">settings</span><span class="p">.</span><span class="nf">ApplyModifiedProperties</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这个脚本扩展了 <code class="language-plaintext highlighter-rouge">LightEditor</code>，并使用 <code class="language-plaintext highlighter-rouge">CustomEditorForRenderPipeline</code> 属性来覆盖默认检视面板。对于聚光灯，它会显示内角-外角滑块。</p><h2 id="烘焙光照和阴影"><span class="me-2">烘焙光照和阴影</span><a href="#烘焙光照和阴影" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>本教程暂不涉及点光源和聚光灯的实时阴影，但我们将支持烘焙这些光源类型。</p><h3 id="完全烘焙"><span class="me-2">完全烘焙</span><a href="#完全烘焙" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>将点光源和聚光灯的 Mode 设置为 Baked 即可进行烘焙。注意，默认情况下它们的阴影类型设置为 None，如果需要烘焙阴影，需要更改阴影类型。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/baked-correct-falloff.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/baked-correct-falloff.png" alt="烘焙光照效果" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">烘焙光照效果</figcaption></figure><h3 id="光照衰减委托"><span class="me-2">光照衰减委托</span><a href="#光照衰减委托" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>烘焙点光源和聚光灯时，发现它们烘焙后太亮。这是因为 Unity 默认使用了不正确的光照衰减，与旧版渲染管线的结果相匹配。</p><p>我们可以通过提供一个委托（delegate）来告诉 Unity 使用不同的衰减方式。将 <code class="language-plaintext highlighter-rouge">CustomRenderPipeline</code> 改为 partial 类，并在构造函数末尾调用 <code class="language-plaintext highlighter-rouge">InitializeForEditor</code> 方法：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">CustomRenderPipeline</span> <span class="p">:</span> <span class="n">RenderPipeline</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nf">CustomRenderPipeline</span> <span class="p">(</span>
        <span class="kt">bool</span> <span class="n">useDynamicBatching</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useGPUInstancing</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useSRPBatcher</span><span class="p">,</span>
        <span class="n">ShadowSettings</span> <span class="n">shadowSettings</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nf">InitializeForEditor</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>然后创建编辑器专用的 partial 类定义这个方法：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">Unity.Collections</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.Experimental.GlobalIllumination</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">LightType</span> <span class="p">=</span> <span class="n">UnityEngine</span><span class="p">.</span><span class="n">LightType</span><span class="p">;</span>

<span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">CustomRenderPipeline</span> <span class="p">{</span>
    <span class="k">partial</span> <span class="k">void</span> <span class="nf">InitializeForEditor</span> <span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在编辑器中，我们需要重写光照贴图器设置光照数据的方式。通过提供一个委托，将数据从输入的 Light 数组传输到 <code class="language-plaintext highlighter-rouge">NativeArray&lt;LightDataGI&gt;</code> 输出：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="cp">#if UNITY_EDITOR
</span><span class="k">static</span> <span class="n">Lightmapping</span><span class="p">.</span><span class="n">RequestLightsDelegate</span> <span class="n">lightsDelegate</span> <span class="p">=</span>
<span class="p">(</span><span class="n">Light</span><span class="p">[]</span> <span class="n">lights</span><span class="p">,</span> <span class="n">NativeArray</span><span class="p">&lt;</span><span class="n">LightDataGI</span><span class="p">&gt;</span> <span class="n">output</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">lightData</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LightDataGI</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">lights</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
        <span class="n">Light</span> <span class="n">light</span> <span class="p">=</span> <span class="n">lights</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">light</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">LightType</span><span class="p">.</span><span class="n">Directional</span><span class="p">:</span>
                <span class="kt">var</span> <span class="n">directionalLight</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DirectionalLight</span><span class="p">();</span>
                <span class="n">LightmapperUtils</span><span class="p">.</span><span class="nf">Extract</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="k">ref</span> <span class="n">directionalLight</span><span class="p">);</span>
                <span class="n">lightData</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="k">ref</span> <span class="n">directionalLight</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">LightType</span><span class="p">.</span><span class="n">Point</span><span class="p">:</span>
                <span class="kt">var</span> <span class="n">pointLight</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PointLight</span><span class="p">();</span>
                <span class="n">LightmapperUtils</span><span class="p">.</span><span class="nf">Extract</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="k">ref</span> <span class="n">pointLight</span><span class="p">);</span>
                <span class="n">lightData</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="k">ref</span> <span class="n">pointLight</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">LightType</span><span class="p">.</span><span class="n">Spot</span><span class="p">:</span>
                <span class="kt">var</span> <span class="n">spotLight</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SpotLight</span><span class="p">();</span>
                <span class="n">LightmapperUtils</span><span class="p">.</span><span class="nf">Extract</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="k">ref</span> <span class="n">spotLight</span><span class="p">);</span>
                <span class="c1">// Unity 2022+ 可以设置聚光灯内角和衰减</span>
                <span class="n">spotLight</span><span class="p">.</span><span class="n">innerConeAngle</span> <span class="p">=</span> <span class="n">light</span><span class="p">.</span><span class="n">innerSpotAngle</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Deg2Rad</span><span class="p">;</span>
                <span class="n">spotLight</span><span class="p">.</span><span class="n">angularFalloff</span> <span class="p">=</span> <span class="n">AngularFalloffType</span><span class="p">.</span><span class="n">AnalyticAndInnerAngle</span><span class="p">;</span>
                <span class="n">lightData</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="k">ref</span> <span class="n">spotLight</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">LightType</span><span class="p">.</span><span class="n">Area</span><span class="p">:</span>
                <span class="kt">var</span> <span class="n">rectangleLight</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RectangleLight</span><span class="p">();</span>
                <span class="n">LightmapperUtils</span><span class="p">.</span><span class="nf">Extract</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="k">ref</span> <span class="n">rectangleLight</span><span class="p">);</span>
                <span class="n">rectangleLight</span><span class="p">.</span><span class="n">mode</span> <span class="p">=</span> <span class="n">LightMode</span><span class="p">.</span><span class="n">Baked</span><span class="p">;</span>
                <span class="n">lightData</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="k">ref</span> <span class="n">rectangleLight</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="p">:</span>
                <span class="n">lightData</span><span class="p">.</span><span class="nf">InitNoBake</span><span class="p">(</span><span class="n">light</span><span class="p">.</span><span class="nf">GetInstanceID</span><span class="p">());</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// 关键：设置正确的衰减类型</span>
        <span class="n">lightData</span><span class="p">.</span><span class="n">falloff</span> <span class="p">=</span> <span class="n">FalloffType</span><span class="p">.</span><span class="n">InverseSquared</span><span class="p">;</span>
        <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">lightData</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif
</span></pre></table></code></div></div><p>创建编辑器版本的 <code class="language-plaintext highlighter-rouge">InitializeForEditor</code> 方法来注册这个委托：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="cp">#if UNITY_EDITOR
</span><span class="k">partial</span> <span class="k">void</span> <span class="nf">InitializeForEditor</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">Lightmapping</span><span class="p">.</span><span class="nf">SetDelegate</span><span class="p">(</span><span class="n">lightsDelegate</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif
</span></pre></table></code></div></div><p>当渲染管线被销毁时，需要清理并重置委托：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Dispose</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">disposing</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">base</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">(</span><span class="n">disposing</span><span class="p">);</span>
    <span class="err">#</span><span class="k">if</span> <span class="n">UNITY_EDITOR</span>
    <span class="n">Lightmapping</span><span class="p">.</span><span class="nf">ResetDelegate</span><span class="p">();</span>
    <span class="err">#</span><span class="n">endif</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/baked-correct-falloff.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/baked-correct-falloff.png" alt="使用正确衰减烘焙的效果" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">使用正确衰减烘焙的效果</figcaption></figure><h3 id="阴影遮罩"><span class="me-2">阴影遮罩</span><a href="#阴影遮罩" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>点光源和聚光灯的阴影也可以烘焙到阴影遮罩中，只需将它们的 Mode 设置为 Mixed。每个光源会获得一个通道，与方向光类似。但由于它们的范围是有限的，多个光源可以共用同一个通道，只要它们不重叠。因此阴影遮罩可以支持任意数量的光源，但每个像素最多只能有四个。</p><p>如果多个光源重叠并试图使用同一通道，最不重要的光源将被强制切换到 Baked 模式，直到不再冲突。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/shadow-mask.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/shadow-mask.png" alt="带有点光源和聚光灯的阴影遮罩" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">带有点光源和聚光灯的阴影遮罩</figcaption></figure><h4 id="实现阴影遮罩支持"><span class="me-2">实现阴影遮罩支持</span><a href="#实现阴影遮罩支持" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>在 <code class="language-plaintext highlighter-rouge">Shadows</code> 中添加 <code class="language-plaintext highlighter-rouge">ReserveOtherShadows</code> 方法：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="n">Vector4</span> <span class="nf">ReserveOtherShadows</span> <span class="p">(</span><span class="n">Light</span> <span class="n">light</span><span class="p">,</span> <span class="kt">int</span> <span class="n">visibleLightIndex</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">light</span><span class="p">.</span><span class="n">shadows</span> <span class="p">!=</span> <span class="n">LightShadows</span><span class="p">.</span><span class="n">None</span> <span class="p">&amp;&amp;</span> <span class="n">light</span><span class="p">.</span><span class="n">shadowStrength</span> <span class="p">&gt;</span> <span class="m">0f</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LightBakingOutput</span> <span class="n">lightBaking</span> <span class="p">=</span> <span class="n">light</span><span class="p">.</span><span class="n">bakingOutput</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">lightBaking</span><span class="p">.</span><span class="n">lightmapBakeType</span> <span class="p">==</span> <span class="n">LightmapBakeType</span><span class="p">.</span><span class="n">Mixed</span> <span class="p">&amp;&amp;</span>
            <span class="n">lightBaking</span><span class="p">.</span><span class="n">mixedLightingMode</span> <span class="p">==</span> <span class="n">MixedLightingMode</span><span class="p">.</span><span class="n">Shadowmask</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="n">useShadowMask</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Vector4</span><span class="p">(</span>
                <span class="n">light</span><span class="p">.</span><span class="n">shadowStrength</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span>
                <span class="n">lightBaking</span><span class="p">.</span><span class="n">occlusionMaskChannel</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">Vector4</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="p">-</span><span class="m">1f</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在 <code class="language-plaintext highlighter-rouge">Lighting</code> 中添加阴影数据属性和数组：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span>
<span class="n">otherLightCountId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightCount"</span><span class="p">),</span>
<span class="n">otherLightColorsId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightColors"</span><span class="p">),</span>
<span class="n">otherLightPositionsId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightPositions"</span><span class="p">),</span>
<span class="n">otherLightDirectionsId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightDirections"</span><span class="p">),</span>
<span class="n">otherLightSpotAnglesId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightSpotAngles"</span><span class="p">),</span>
<span class="n">otherLightShadowDataId</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="nf">PropertyToID</span><span class="p">(</span><span class="s">"_OtherLightShadowData"</span><span class="p">);</span>

<span class="k">static</span> <span class="n">Vector4</span><span class="p">[]</span>
<span class="n">otherLightColors</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="n">maxOtherLightCount</span><span class="p">],</span>
<span class="n">otherLightPositions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="n">maxOtherLightCount</span><span class="p">],</span>
<span class="n">otherLightDirections</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="n">maxOtherLightCount</span><span class="p">],</span>
<span class="n">otherLightSpotAngles</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="n">maxOtherLightCount</span><span class="p">],</span>
<span class="n">otherLightShadowData</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="n">maxOtherLightCount</span><span class="p">];</span>
</pre></table></code></div></div><p>在 <code class="language-plaintext highlighter-rouge">SetupLights</code> 中传递阴影数据到 GPU：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalVectorArray</span><span class="p">(</span>
    <span class="n">otherLightSpotAnglesId</span><span class="p">,</span> <span class="n">otherLightSpotAngles</span>
<span class="p">);</span>
<span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalVectorArray</span><span class="p">(</span>
    <span class="n">otherLightShadowDataId</span><span class="p">,</span> <span class="n">otherLightShadowData</span>
<span class="p">);</span>
</pre></table></code></div></div><p>在 <code class="language-plaintext highlighter-rouge">SetupPointLight</code> 和 <code class="language-plaintext highlighter-rouge">SetupSpotLight</code> 中配置阴影数据：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">SetupPointLight</span> <span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="k">ref</span> <span class="n">VisibleLight</span> <span class="n">visibleLight</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="n">Light</span> <span class="n">light</span> <span class="p">=</span> <span class="n">visibleLight</span><span class="p">.</span><span class="n">light</span><span class="p">;</span>
    <span class="n">otherLightShadowData</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">shadows</span><span class="p">.</span><span class="nf">ReserveOtherShadows</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">void</span> <span class="nf">SetupSpotLight</span> <span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="k">ref</span> <span class="n">VisibleLight</span> <span class="n">visibleLight</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="n">otherLightShadowData</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">shadows</span><span class="p">.</span><span class="nf">ReserveOtherShadows</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="着色器中的阴影遮罩"><span class="me-2">着色器中的阴影遮罩</span><a href="#着色器中的阴影遮罩" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>在 <code class="language-plaintext highlighter-rouge">Shadows</code> 中添加 <code class="language-plaintext highlighter-rouge">OtherShadowData</code> 结构体和 <code class="language-plaintext highlighter-rouge">GetOtherShadowAttenuation</code> 函数：</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">OtherShadowData</span> <span class="p">{</span>
    <span class="n">float</span> <span class="n">strength</span><span class="p">;</span>
    <span class="n">int</span> <span class="n">shadowMaskChannel</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">float</span> <span class="nf">GetOtherShadowAttenuation</span> <span class="p">(</span>
    <span class="n">OtherShadowData</span> <span class="n">other</span><span class="p">,</span> <span class="n">ShadowData</span> <span class="n">global</span><span class="p">,</span> <span class="n">Surface</span> <span class="n">surfaceWS</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="cp">#if !defined(_RECEIVE_SHADOWS)
</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="cp">#endif
</span>    <span class="n">float</span> <span class="n">shadow</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">strength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">shadow</span> <span class="o">=</span> <span class="n">GetBakedShadow</span><span class="p">(</span>
            <span class="n">global</span><span class="p">.</span><span class="n">shadowMask</span><span class="p">,</span> <span class="n">other</span><span class="p">.</span><span class="n">shadowMaskChannel</span><span class="p">,</span> <span class="n">other</span><span class="p">.</span><span class="n">strength</span>
        <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">shadow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">shadow</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在 <code class="language-plaintext highlighter-rouge">Light</code> 中添加阴影数据并将其纳入衰减计算：</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="n">CBUFFER_START</span><span class="p">(</span><span class="n">_CustomLight</span><span class="p">)</span>
    <span class="c1">// ...</span>
    <span class="kt">float4</span> <span class="n">_OtherLightShadowData</span><span class="p">[</span><span class="n">MAX_OTHER_LIGHT_COUNT</span><span class="p">];</span>
<span class="n">CBUFFER_END</span>

<span class="n">OtherShadowData</span> <span class="nf">GetOtherShadowData</span> <span class="p">(</span><span class="n">int</span> <span class="n">lightIndex</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">OtherShadowData</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">data</span><span class="p">.</span><span class="n">strength</span> <span class="o">=</span> <span class="n">_OtherLightShadowData</span><span class="p">[</span><span class="n">lightIndex</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
    <span class="n">data</span><span class="p">.</span><span class="n">shadowMaskChannel</span> <span class="o">=</span> <span class="n">_OtherLightShadowData</span><span class="p">[</span><span class="n">lightIndex</span><span class="p">].</span><span class="n">w</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Light</span> <span class="nf">GetOtherLight</span> <span class="p">(</span><span class="n">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">Surface</span> <span class="n">surfaceWS</span><span class="p">,</span> <span class="n">ShadowData</span> <span class="n">shadowData</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="n">OtherShadowData</span> <span class="n">otherShadowData</span> <span class="o">=</span> <span class="n">GetOtherShadowData</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
    <span class="n">light</span><span class="p">.</span><span class="n">attenuation</span> <span class="o">=</span>
        <span class="n">GetOtherShadowAttenuation</span><span class="p">(</span><span class="n">otherShadowData</span><span class="p">,</span> <span class="n">shadowData</span><span class="p">,</span> <span class="n">surfaceWS</span><span class="p">)</span> <span class="o">*</span>
        <span class="n">spotAttenuation</span> <span class="o">*</span> <span class="n">rangeAttenuation</span> <span class="o">/</span> <span class="n">distanceSqr</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">light</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/baked-correct-falloff.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/baked-correct-falloff.png" alt="带有烘焙阴影的点光源和聚光灯" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">带有烘焙阴影的点光源和聚光灯</figcaption></figure><h2 id="每物体光源数量限制"><span class="me-2">每物体光源数量限制</span><a href="#每物体光源数量限制" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="为什么需要限制"><span class="me-2">为什么需要限制？</span><a href="#为什么需要限制" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>目前，所有可见光源都会对每个渲染的片元进行评估。这对于方向光来说是可以接受的，但对于范围外的其他光源来说是不必要的工作。通常每个点光源或聚光灯只影响一小部分片元，因此做了大量无用功，会显著影响性能。</p><p>为了支持大量光源并保持良好性能，我们必须减少每个片元评估的光源数量。最简单的方法是使用 Unity 的每物体光源索引（per-object light indices）。</p><h3 id="工作原理"><span class="me-2">工作原理</span><a href="#工作原理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Unity 会确定每个对象受哪些光源影响，并将此信息发送到 GPU。然后在渲染每个对象时，我们只需要评估相关的光源，忽略其余的。因此，光源是按对象而非按片元确定的。这对于小物体效果很好，但对于大物体不太理想，因为如果一个光源只影响物体的一小部分，它将对整个表面进行评估。此外，每个对象能影响的光源数量有限制，所以大物体更容易缺少某些光照。</p><p>由于每物体光源索引并不完美且可能遗漏一些光照，我们将使其可选。这样也可以轻松比较两种方式的视觉效果和性能。</p><blockquote><p><strong>历史问题</strong>：Unity 的每物体光源索引代码在 Unity 2018 年后曾多次损坏，有时持续数月，导致许多 bug。这也是将其设为可选的原因之一。</p></blockquote><h3 id="每物体光源数据"><span class="me-2">每物体光源数据</span><a href="#每物体光源数据" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在 <code class="language-plaintext highlighter-rouge">CameraRenderer.DrawVisibleGeometry</code> 中添加布尔参数来指示是否使用每物体光源模式：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">DrawVisibleGeometry</span> <span class="p">(</span>
    <span class="kt">bool</span> <span class="n">useDynamicBatching</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useGPUInstancing</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useLightsPerObject</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">PerObjectData</span> <span class="n">lightsPerObjectFlags</span> <span class="p">=</span> <span class="n">useLightsPerObject</span> <span class="p">?</span>
        <span class="n">PerObjectData</span><span class="p">.</span><span class="n">LightData</span> <span class="p">|</span> <span class="n">PerObjectData</span><span class="p">.</span><span class="n">LightIndices</span> <span class="p">:</span>
        <span class="n">PerObjectData</span><span class="p">.</span><span class="n">None</span><span class="p">;</span>
    <span class="c1">// ... 设置其他 perObjectData</span>
    <span class="kt">var</span> <span class="n">drawingSettings</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DrawingSettings</span><span class="p">(</span>
        <span class="n">unlitShaderTagId</span><span class="p">,</span> <span class="n">sortingSettings</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="n">perObjectData</span> <span class="p">=</span>
            <span class="n">PerObjectData</span><span class="p">.</span><span class="n">ReflectionProbes</span> <span class="p">|</span>
            <span class="n">PerObjectData</span><span class="p">.</span><span class="n">Lightmaps</span> <span class="p">|</span> <span class="n">PerObjectData</span><span class="p">.</span><span class="n">ShadowMask</span> <span class="p">|</span>
            <span class="n">PerObjectData</span><span class="p">.</span><span class="n">LightProbe</span> <span class="p">|</span> <span class="n">PerObjectData</span><span class="p">.</span><span class="n">OcclusionProbe</span> <span class="p">|</span>
            <span class="n">PerObjectData</span><span class="p">.</span><span class="n">LightProbeProxyVolume</span> <span class="p">|</span>
            <span class="n">PerObjectData</span><span class="p">.</span><span class="n">OcclusionProbeProxyVolume</span> <span class="p">|</span>
            <span class="n">lightsPerObjectFlags</span>
    <span class="p">};</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>将参数传递给 <code class="language-plaintext highlighter-rouge">Render</code> 方法：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">void</span> <span class="nf">Render</span> <span class="p">(</span>
    <span class="n">ScriptableRenderContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Camera</span> <span class="n">camera</span><span class="p">,</span>
    <span class="kt">bool</span> <span class="n">useDynamicBatching</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useGPUInstancing</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useLightsPerObject</span><span class="p">,</span>
    <span class="n">ShadowSettings</span> <span class="n">shadowSettings</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nf">DrawVisibleGeometry</span><span class="p">(</span>
        <span class="n">useDynamicBatching</span><span class="p">,</span> <span class="n">useGPUInstancing</span><span class="p">,</span> <span class="n">useLightsPerObject</span>
    <span class="p">);</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在 <code class="language-plaintext highlighter-rouge">CustomRenderPipeline</code> 中跟踪这个模式：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kt">bool</span> <span class="n">useDynamicBatching</span><span class="p">,</span> <span class="n">useGPUInstancing</span><span class="p">,</span> <span class="n">useLightsPerObject</span><span class="p">;</span>
<span class="n">ShadowSettings</span> <span class="n">shadowSettings</span><span class="p">;</span>

<span class="k">public</span> <span class="nf">CustomRenderPipeline</span> <span class="p">(</span>
    <span class="kt">bool</span> <span class="n">useDynamicBatching</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useGPUInstancing</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useSRPBatcher</span><span class="p">,</span>
    <span class="kt">bool</span> <span class="n">useLightsPerObject</span><span class="p">,</span> <span class="n">ShadowSettings</span> <span class="n">shadowSettings</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">shadowSettings</span> <span class="p">=</span> <span class="n">shadowSettings</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">useDynamicBatching</span> <span class="p">=</span> <span class="n">useDynamicBatching</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">useGPUInstancing</span> <span class="p">=</span> <span class="n">useGPUInstancing</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">useLightsPerObject</span> <span class="p">=</span> <span class="n">useLightsPerObject</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// 在 Render 方法中传递</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">cameras</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
    <span class="n">renderer</span><span class="p">.</span><span class="nf">Render</span><span class="p">(</span>
        <span class="n">context</span><span class="p">,</span> <span class="n">cameras</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="n">useDynamicBatching</span><span class="p">,</span> <span class="n">useGPUInstancing</span><span class="p">,</span> <span class="n">useLightsPerObject</span><span class="p">,</span>
        <span class="n">shadowSettings</span>
    <span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在 <code class="language-plaintext highlighter-rouge">CustomRenderPipelineAsset</code> 中添加开关选项：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
<span class="kt">bool</span>
<span class="n">useDynamicBatching</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
<span class="n">useGPUInstancing</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
<span class="n">useSRPBatcher</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
<span class="n">useLightsPerObject</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

<span class="k">protected</span> <span class="k">override</span> <span class="n">RenderPipeline</span> <span class="nf">CreatePipeline</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">CustomRenderPipeline</span><span class="p">(</span>
        <span class="n">useDynamicBatching</span><span class="p">,</span> <span class="n">useGPUInstancing</span><span class="p">,</span> <span class="n">useSRPBatcher</span><span class="p">,</span>
        <span class="n">useLightsPerObject</span><span class="p">,</span> <span class="n">shadows</span>
    <span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="清理光源索引"><span class="me-2">清理光源索引</span><a href="#清理光源索引" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Unity 会为每个对象创建一个所有活动光源的列表，按重要性排序。这个列表包含所有光源，无论它们是否可见，也包括方向光。我们需要清理这个列表，只保留可见的非方向光索引。</p><p>在 <code class="language-plaintext highlighter-rouge">Lighting.SetupLights</code> 中处理：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">void</span> <span class="nf">Setup</span> <span class="p">(</span>
    <span class="n">ScriptableRenderContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">CullingResults</span> <span class="n">cullingResults</span><span class="p">,</span>
    <span class="n">ShadowSettings</span> <span class="n">shadowSettings</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useLightsPerObject</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nf">SetupLights</span><span class="p">(</span><span class="n">useLightsPerObject</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">void</span> <span class="nf">SetupLights</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">useLightsPerObject</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NativeArray</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">indexMap</span> <span class="p">=</span> <span class="n">useLightsPerObject</span> <span class="p">?</span>
        <span class="n">cullingResults</span><span class="p">.</span><span class="nf">GetLightIndexMap</span><span class="p">(</span><span class="n">Allocator</span><span class="p">.</span><span class="n">Temp</span><span class="p">)</span> <span class="p">:</span> <span class="k">default</span><span class="p">;</span>

    <span class="n">NativeArray</span><span class="p">&lt;</span><span class="n">VisibleLight</span><span class="p">&gt;</span> <span class="n">visibleLights</span> <span class="p">=</span> <span class="n">cullingResults</span><span class="p">.</span><span class="n">visibleLights</span><span class="p">;</span>
    <span class="c1">// ...</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">visibleLights</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">newIndex</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
        <span class="n">VisibleLight</span> <span class="n">visibleLight</span> <span class="p">=</span> <span class="n">visibleLights</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">visibleLight</span><span class="p">.</span><span class="n">lightType</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// ... 处理方向光</span>
            <span class="k">case</span> <span class="n">LightType</span><span class="p">.</span><span class="n">Point</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">otherLightCount</span> <span class="p">&lt;</span> <span class="n">maxOtherLightCount</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">newIndex</span> <span class="p">=</span> <span class="n">otherLightCount</span><span class="p">;</span>
                    <span class="nf">SetupPointLight</span><span class="p">(</span><span class="n">otherLightCount</span><span class="p">++,</span> <span class="k">ref</span> <span class="n">visibleLight</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">LightType</span><span class="p">.</span><span class="n">Spot</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">otherLightCount</span> <span class="p">&lt;</span> <span class="n">maxOtherLightCount</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">newIndex</span> <span class="p">=</span> <span class="n">otherLightCount</span><span class="p">;</span>
                    <span class="nf">SetupSpotLight</span><span class="p">(</span><span class="n">otherLightCount</span><span class="p">++,</span> <span class="k">ref</span> <span class="n">visibleLight</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">useLightsPerObject</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">indexMap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">newIndex</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 消除不可见光源的索引</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">useLightsPerObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">visibleLights</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">indexMap</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
            <span class="n">indexMap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">cullingResults</span><span class="p">.</span><span class="nf">SetLightIndexMap</span><span class="p">(</span><span class="n">indexMap</span><span class="p">);</span>
        <span class="n">indexMap</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>根据是否使用每物体光源来启用或禁用着色器关键字：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">string</span> <span class="n">lightsPerObjectKeyword</span> <span class="p">=</span> <span class="s">"_LIGHTS_PER_OBJECT"</span><span class="p">;</span>

<span class="k">void</span> <span class="nf">SetupLights</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">useLightsPerObject</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">useLightsPerObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="n">Shader</span><span class="p">.</span><span class="nf">EnableKeyword</span><span class="p">(</span><span class="n">lightsPerObjectKeyword</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">Shader</span><span class="p">.</span><span class="nf">DisableKeyword</span><span class="p">(</span><span class="n">lightsPerObjectKeyword</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="使用光源索引"><span class="me-2">使用光源索引</span><a href="#使用光源索引" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在 Lit 着色器的 CustomLit Pass 中添加多编译指令：</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="cp">#pragma multi_compile _ _LIGHTS_PER_OBJECT
</span></pre></table></code></div></div><p>所需数据是 <code class="language-plaintext highlighter-rouge">UnityPerDraw</code> 缓冲区的一部分，由两个 real4 值组成，定义在 <code class="language-plaintext highlighter-rouge">unity_WorldTransformParams</code> 之后：</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">real4</span> <span class="n">unity_WorldTransformParams</span><span class="p">;</span>
<span class="n">real4</span> <span class="n">unity_LightData</span><span class="p">;</span>
<span class="n">real4</span> <span class="n">unity_LightIndices</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</pre></table></code></div></div><p>在 <code class="language-plaintext highlighter-rouge">GetLighting</code> 中使用替代循环来处理其他光源：</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="cp">#if defined(_LIGHTS_PER_OBJECT)
</span><span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">unity_LightData</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">int</span> <span class="n">lightIndex</span> <span class="o">=</span> <span class="n">unity_LightIndices</span><span class="p">[(</span><span class="n">uint</span><span class="p">)</span><span class="n">j</span> <span class="o">/</span> <span class="mi">4</span><span class="p">][(</span><span class="n">uint</span><span class="p">)</span><span class="n">j</span> <span class="o">%</span> <span class="mi">4</span><span class="p">];</span>
    <span class="n">Light</span> <span class="n">light</span> <span class="o">=</span> <span class="n">GetOtherLight</span><span class="p">(</span><span class="n">lightIndex</span><span class="p">,</span> <span class="n">surfaceWS</span><span class="p">,</span> <span class="n">shadowData</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">+=</span> <span class="n">GetLighting</span><span class="p">(</span><span class="n">surfaceWS</span><span class="p">,</span> <span class="n">brdf</span><span class="p">,</span> <span class="n">light</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else
</span><span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">GetOtherLightCount</span><span class="p">();</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Light</span> <span class="n">light</span> <span class="o">=</span> <span class="n">GetOtherLight</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">surfaceWS</span><span class="p">,</span> <span class="n">shadowData</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">+=</span> <span class="n">GetLighting</span><span class="p">(</span><span class="n">surfaceWS</span><span class="p">,</span> <span class="n">brdf</span><span class="p">,</span> <span class="n">light</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif
</span></pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/max-8-per-object.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/max-8-per-object.png" alt="每物体8个光源限制和开关" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/lights-per-object-toggle.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/lights-per-object-toggle.png" alt="每物体8个光源限制和开关" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">每物体8个光源限制和开关</figcaption></figure><h3 id="性能注意事项"><span class="me-2">性能注意事项</span><a href="#性能注意事项" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>需要注意的是，启用每物体光源后 GPU 实例化效率会降低，因为只有光源数量和索引列表匹配的对象才能被分组。SRP Batcher 不受影响，因为每个对象仍然获得自己的优化绘制调用。</p><h2 id="总结"><span class="me-2">总结</span><a href="#总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>在本教程中，我成功实现了：</p><ol><li><strong>点光源支持</strong> - 添加了位置属性和距离衰减计算<li><strong>聚光灯支持</strong> - 添加了方向控制和角度衰减，包括内角和外角<li><strong>光源范围</strong> - 实现了基于范围的光照衰减<li><strong>烘焙光照</strong> - 为点光源和聚光灯添加了烘焙支持，包括正确的衰减类型<li><strong>阴影遮罩</strong> - 支持混合模式光源的阴影遮罩<li><strong>每物体光源限制</strong> - 实现了每物体最多8个光源的限制，大幅优化性能<li><strong>自定义编辑器</strong> - 暴露了聚光灯的内角配置选项</ol><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp9/all-lights.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp9/all-lights.png" alt="所有光源类型汇总" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">所有光源类型汇总</figcaption></figure><hr /><p>下一篇翻译文章<a href="../">点光源和聚光灯阴影</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/unity3d/">Unity3D</a>, <a href="/categories/scriptrenderpipeline/">ScriptRenderPipeline</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/srp/" class="post-tag no-text-decoration" >SRP</a> <a href="/tags/point-light/" class="post-tag no-text-decoration" >Point Light</a> <a href="/tags/spot-light/" class="post-tag no-text-decoration" >Spot Light</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B8%B2%E6%9F%93%E7%AE%A1%E7%BA%BF:%E7%82%B9%E5%85%89%E6%BA%90%E4%B8%8E%E8%81%9A%E5%85%89%E7%81%AF%20(%E7%BF%BB%E8%AF%91%E4%B9%9D)%20-%20%E4%BB%97%E5%89%91%E5%A4%A9%E6%B6%AF&url=www.damonc.top%2Fposts%2Fpoint-spot-lights%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B8%B2%E6%9F%93%E7%AE%A1%E7%BA%BF:%E7%82%B9%E5%85%89%E6%BA%90%E4%B8%8E%E8%81%9A%E5%85%89%E7%81%AF%20(%E7%BF%BB%E8%AF%91%E4%B9%9D)%20-%20%E4%BB%97%E5%89%91%E5%A4%A9%E6%B6%AF&u=www.damonc.top%2Fposts%2Fpoint-spot-lights%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=www.damonc.top%2Fposts%2Fpoint-spot-lights%2F&text=%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B8%B2%E6%9F%93%E7%AE%A1%E7%BA%BF:%E7%82%B9%E5%85%89%E6%BA%90%E4%B8%8E%E8%81%9A%E5%85%89%E7%81%AF%20(%E7%BF%BB%E8%AF%91%E4%B9%9D)%20-%20%E4%BB%97%E5%89%91%E5%A4%A9%E6%B6%AF" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/particles/">粒子系统：颜色和深度纹理</a><li class="text-truncate lh-lg"> <a href="/posts/color-grading/">Unity自定义渲染管线13：色彩分级</a><li class="text-truncate lh-lg"> <a href="/posts/post-processing/">自定义渲染管线:后处理 (翻译十一)</a><li class="text-truncate lh-lg"> <a href="/posts/hdr/">自定义渲染管线:HDR (翻译十二)</a><li class="text-truncate lh-lg"> <a href="/posts/point-spot-light-shadow/">自定义渲染管线:点光源与聚光灯阴影 (翻译十)</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/shader/">Shader</a> <a class="post-tag btn btn-outline-primary" href="/tags/srp/">SRP</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai/">AI</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli-agent/">CLI Agent</a> <a class="post-tag btn btn-outline-primary" href="/tags/best-practices/">Best Practices</a> <a class="post-tag btn btn-outline-primary" href="/tags/bloom/">Bloom</a> <a class="post-tag btn btn-outline-primary" href="/tags/point-light/">Point Light</a> <a class="post-tag btn btn-outline-primary" href="/tags/post-processing/">Post Processing</a> <a class="post-tag btn btn-outline-primary" href="/tags/shadows/">Shadows</a> <a class="post-tag btn btn-outline-primary" href="/tags/spot-light/">Spot Light</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/point-spot-light-shadow/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1593511200" data-df="ll" > Jun 30, 2020 </time><h4 class="pt-0 my-2">自定义渲染管线:点光源与聚光灯阴影 (翻译十)</h4><div class="text-muted"><p>为点光源和聚光灯添加实时阴影支持，使用透视投影渲染和采样阴影，并使用自定义立方体贴图。</p></div></div></a></article><article class="col"> <a href="/posts/particles/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1606406400" data-df="ll" > Nov 27, 2020 </time><h4 class="pt-0 my-2">粒子系统：颜色和深度纹理</h4><div class="text-muted"><p>深入探索Unity粒子系统的渲染技术，包括翻书动画、近距离淡入淡出、软粒子和扭曲效果的实现原理与实践。</p></div></div></a></article><article class="col"> <a href="/posts/multiple-camera/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1603641600" data-df="ll" > Oct 26, 2020 </time><h4 class="pt-0 my-2">自定义渲染管线:多摄像机渲染 (翻译十四)</h4><div class="text-muted"><p>深入探讨Unity自定义渲染管线中的多摄像机渲染技术，包括分屏渲染、摄像机混合以及渲染层遮罩的实现。</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/complex-maps/" class="btn btn-outline-primary" aria-label="Older" ><p>自定义管线:遮罩、细节与法线贴图 (翻译八)</p></a> <a href="/posts/point-spot-light-shadow/" class="btn btn-outline-primary" aria-label="Newer" ><p>自定义渲染管线:点光源与聚光灯阴影 (翻译十)</p></a></nav><div id="waline-container" class="mt-5 pt-4" style="border-top: 1px dashed #ccc; padding-top: 20px;"><div id="waline"></div></div><link rel="stylesheet" href="/assets/css/waline.css"> <script type="module"> window.WalinePrefix = "/pro"; const observer = new IntersectionObserver((entries) => { if (entries[0].isIntersecting) { observer.disconnect(); import('/assets/js/dist/waline.min.js').then(({ init }) => { init({ el: '#waline', serverURL: 'https://comments.damonc.top', dark: 'html[data-mode="dark"]', emoji: [ 'https://fastly.jsdelivr.net/npm/@waline/emojis@1.4.0/qq' ], reaction: true, pageview: false }); }); } }); observer.observe(document.getElementById('waline-container')); </script><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2026</time> <a href="https://github.com/damonc-top">仗剑天涯</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>The blog is powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/shader/">Shader</a> <a class="post-tag btn btn-outline-primary" href="/tags/srp/">SRP</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai/">AI</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli-agent/">CLI Agent</a> <a class="post-tag btn btn-outline-primary" href="/tags/best-practices/">Best Practices</a> <a class="post-tag btn btn-outline-primary" href="/tags/bloom/">Bloom</a> <a class="post-tag btn btn-outline-primary" href="/tags/point-light/">Point Light</a> <a class="post-tag btn btn-outline-primary" href="/tags/post-processing/">Post Processing</a> <a class="post-tag btn btn-outline-primary" href="/tags/shadows/">Shadows</a> <a class="post-tag btn btn-outline-primary" href="/tags/spot-light/">Spot Light</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
