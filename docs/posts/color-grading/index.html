<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Unity自定义渲染管线13：色彩分级" /><meta name="author" content="afeng" /><meta property="og:locale" content="en" /><meta name="description" content="通过色彩分级调整图像的颜色，复制 URP/HDRP 的多种色彩分级工具，并使用色彩查找表（LUT）来优化性能。" /><meta property="og:description" content="通过色彩分级调整图像的颜色，复制 URP/HDRP 的多种色彩分级工具，并使用色彩查找表（LUT）来优化性能。" /><link rel="canonical" href="www.damonc.top/posts/color-grading/" /><meta property="og:url" content="www.damonc.top/posts/color-grading/" /><meta property="og:site_name" content="仗剑天涯" /><meta property="og:image" content="https://img.damonc.top/posts/SRP/srp13color-grading/tutorial-image.jpg" /><meta property="og:image:alt" content="调整色彩以营造氛围" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-09-29T10:00:00+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://img.damonc.top/posts/SRP/srp13color-grading/tutorial-image.jpg" /><meta name="twitter:image:alt" content="调整色彩以营造氛围" /><meta property="twitter:title" content="Unity自定义渲染管线13：色彩分级" /><meta name="twitter:site" content="@elonmusk" /><meta name="twitter:creator" content="@afeng" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"afeng","url":"https://github.com/damonc-top/"},"dateModified":"2026-02-20T20:23:29+08:00","datePublished":"2020-09-29T10:00:00+08:00","description":"通过色彩分级调整图像的颜色，复制 URP/HDRP 的多种色彩分级工具，并使用色彩查找表（LUT）来优化性能。","headline":"Unity自定义渲染管线13：色彩分级","image":{"lqip":"data:image/webp;base64,UklGRlAAAABXRUJQVlA4IEQAAACwAwCdASoUAAoAP3Ggx1k0q6gjsAgCkC4JQBWABFKUVjVP7r8yAADeV7m8rufikN0GSeCaRi3ha9p18I1FaR9DyRwAAA==","alt":"调整色彩以营造氛围","url":"https://img.damonc.top/posts/SRP/srp13color-grading/tutorial-image.jpg","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"www.damonc.top/posts/color-grading/"},"url":"www.damonc.top/posts/color-grading/"}</script><meta name="fediverse:creator" content="@damonc@mastodon.social"><title>Unity自定义渲染管线13：色彩分级 | 仗剑天涯</title><link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="preconnect" href="https://fonts.loli.net" ><link rel="dns-prefetch" href="https://fonts.loli.net" ><link rel="preconnect" href="https://gstatic.loli.net" crossorigin><link rel="dns-prefetch" href="https://gstatic.loli.net" ><link rel="preconnect" href="https://fastly.jsdelivr.net" ><link rel="dns-prefetch" href="https://fastly.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script type="module" src="/assets/js/dist/theme.min.js"></script> <script> /* Apply sidebar collapsed state as early as possible to prevent flickering */ if (localStorage.getItem('sidebar-collapsed') === 'true') { document.documentElement.setAttribute('data-sidebar-collapsed', 'true'); } </script> <script defer src="https://fastly.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js"></script> <script type="module" defer src="/assets/js/dist/post.min.js"></script> <script src="/assets/js/data/mathjax.js"></script> <script async src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://fastly.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script> <script type="module"> window.WalinePrefix = "/pro"; import { pageviewCount } from '/assets/js/dist/waline.min.js'; pageviewCount({ serverURL: 'https://comments.damonc.top', update: true }); </script> <script type="module" defer src="/app.min.js?baseurl=&register=true" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"> <button type="button" id="sidebar-collapse-btn" class="btn" aria-label="Toggle Sidebar"> <i class="fas fa-bars-staggered"></i> </button><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="https://img.damonc.top/commons/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">仗剑天涯</a><p class="site-subtitle fst-italic mb-0">听说读写看做忘</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/damonc-top" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/elonmusk" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['damoncbl','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Unity自定义渲染管线13：色彩分级</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Unity自定义渲染管线13：色彩分级</h1><p class="post-desc fw-light mb-4">通过色彩分级调整图像的颜色，复制 URP/HDRP 的多种色彩分级工具，并使用色彩查找表（LUT）来优化性能。</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1601344800" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Sep 29, 2020 </time> </span> <span> Updated <time data-ts="1771590209" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 20, 2026 </time> </span><div class="mt-3 mb-3"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/tutorial-image.jpg" class="popup img-link preview-img blur"><img data-src="https://img.damonc.top/posts/SRP/srp13color-grading/tutorial-image.jpg" alt="调整色彩以营造氛围" width="1200" height="630" data-lqip="true" src="data:image/webp;base64,UklGRlAAAABXRUJQVlA4IEQAAACwAwCdASoUAAoAP3Ggx1k0q6gjsAgCkC4JQBWABFKUVjVP7r8yAADeV7m8rufikN0GSeCaRi3ha9p18I1FaR9DyRwAAA=="></a><figcaption class="text-center pt-2 pb-2">调整色彩以营造氛围</figcaption></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/damonc-top/">afeng</a> </em> </span><div> <span> <em class="waline-pageview-count" data-path="/posts/color-grading/"> <i class="fas fa-spinner fa-spin small"></i> </em> views </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="8294 words" > <em>46 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Unity自定义渲染管线13：色彩分级</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Unity自定义渲染管线13：色彩分级</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><ul><li>执行色彩分级。<li>复制多个URP/HDRP色彩分级工具。<li>使用色彩LUT。</ul><hr /><h2 id="色彩调整"><span class="me-2">色彩调整</span><a href="#色彩调整" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>目前我们只对最终图像应用色调映射，将 HDR 色彩映射到可见的 LDR 范围。但这并不是调整图像色彩的唯一原因。对于视频、照片和数字图像，色彩调整大致分为三个步骤：</p><ol><li><strong>色彩校正（Color Correction）</strong>：旨在使图像与我们观察场景时看到的内容相匹配，补偿媒介的局限性。<li><strong>色彩分级（Color Grading）</strong>：为了达到所需的外观或感觉，这种外观不需要与原始场景匹配，也不需要是真实的。这两个步骤通常会合并成一个色彩分级步骤。<li><strong>色调映射（Tone Mapping）</strong>：将 HDR 色彩映射到显示范围。</ol><p>仅应用色调映射时，图像往往会变得不那么丰富多彩，除非它非常明亮。ACES 会稍微增加暗色的对比度，但它不能替代色彩分级。本教程使用中性（Neutral）色调映射作为基础。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/without-adjustments.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/without-adjustments.png" alt="没有色彩调整的图像，使用中性色调映射" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">没有色彩调整的图像，使用中性色调映射</figcaption></figure><h3 id="在色调映射之前进行色彩分级"><span class="me-2">在色调映射之前进行色彩分级</span><a href="#在色调映射之前进行色彩分级" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>色彩分级发生在色调映射之前。在 <code class="language-plaintext highlighter-rouge">PostFXStackPasses</code> 中，在色调映射通道之前添加一个函数。最初只需将色彩分量限制为 60。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">ColorGrade</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">60</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在色调映射通道中调用此函数，而不是在那里限制色彩。还要添加一个新的通道，用于无色调映射但有色彩分级的情况。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kt">float4</span> <span class="nf">ToneMappingNonePassFragment</span> <span class="p">(</span><span class="n">Varyings</span> <span class="n">input</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="kt">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">GetSource</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">screenUV</span><span class="p">);</span>
    <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">ColorGrade</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float4</span> <span class="nf">ToneMappingACESPassFragment</span> <span class="p">(</span><span class="n">Varyings</span> <span class="n">input</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="kt">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">GetSource</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">screenUV</span><span class="p">);</span>
    <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">ColorGrade</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">);</span>
    <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">AcesTonemap</span><span class="p">(</span><span class="n">unity_to_ACES</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float4</span> <span class="nf">ToneMappingNeutralPassFragment</span> <span class="p">(</span><span class="n">Varyings</span> <span class="n">input</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="kt">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">GetSource</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">screenUV</span><span class="p">);</span>
    <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">ColorGrade</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">);</span>
    <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">NeutralTonemap</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float4</span> <span class="nf">ToneMappingReinhardPassFragment</span> <span class="p">(</span><span class="n">Varyings</span> <span class="n">input</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="kt">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">GetSource</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">screenUV</span><span class="p">);</span>
    <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">ColorGrade</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">);</span>
    <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">/=</span> <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在着色器和 <code class="language-plaintext highlighter-rouge">PostFXStack.Pass</code> 枚举中添加相同的通道，放在其他色调映射通道之前。然后调整 <code class="language-plaintext highlighter-rouge">PostFXStack.DoToneMapping</code>，使 None 模式使用自己的通道而不是 Copy。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">DoToneMapping</span><span class="p">(</span><span class="kt">int</span> <span class="n">sourceId</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PostFXSettings</span><span class="p">.</span><span class="n">ToneMappingSettings</span><span class="p">.</span><span class="n">Mode</span> <span class="n">mode</span> <span class="p">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">ToneMapping</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
    <span class="n">Pass</span> <span class="n">pass</span> <span class="p">=</span> <span class="n">Pass</span><span class="p">.</span><span class="n">ToneMappingNone</span> <span class="p">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mode</span><span class="p">;</span>
    <span class="nf">Draw</span><span class="p">(</span><span class="n">sourceId</span><span class="p">,</span> <span class="n">BuiltinRenderTextureType</span><span class="p">.</span><span class="n">CameraTarget</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">ToneMappingSettings.Mode</code> 枚举现在必须从零开始。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">struct</span> <span class="nc">ToneMappingSettings</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">enum</span> <span class="n">Mode</span> <span class="p">{</span> <span class="n">None</span><span class="p">,</span> <span class="n">ACES</span><span class="p">,</span> <span class="n">Neutral</span><span class="p">,</span> <span class="n">Reinhard</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">Mode</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="设置"><span class="me-2">设置</span><a href="#设置" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>我们将复制 URP 和 HDRP 的色彩调整（Color Adjustments）后处理工具的功能。第一步是在 <code class="language-plaintext highlighter-rouge">PostFXSettings</code> 中为其添加一个配置结构体。我添加了 <code class="language-plaintext highlighter-rouge">using System</code>，因为我们还需要多次添加 <code class="language-plaintext highlighter-rouge">Serializable</code> 特性。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="p">[</span><span class="nf">CreateAssetMenu</span><span class="p">(</span><span class="n">menuName</span> <span class="p">=</span> <span class="s">"Rendering/Custom Post FX Settings"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">PostFXSettings</span> <span class="p">:</span> <span class="n">ScriptableObject</span> <span class="p">{</span>
    <span class="p">....</span>

    <span class="p">[</span><span class="n">Serializable</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">struct</span> <span class="nc">ColorAdjustmentsSettings</span> <span class="p">{}</span>

    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
    <span class="n">ColorAdjustmentsSettings</span> <span class="n">colorAdjustments</span> <span class="p">=</span> <span class="k">default</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">ColorAdjustmentsSettings</span> <span class="n">ColorAdjustments</span> <span class="p">=&gt;</span> <span class="n">colorAdjustments</span><span class="p">;</span>

    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><p>URP 和 HDRP 的色彩分级功能是相同的。我们将按相同的顺序添加相同的配置选项：</p><ol><li><strong>Post Exposure</strong>（后期曝光）：无约束的浮点数<li><strong>Contrast</strong>（对比度）：滑块范围从 -100 到 100<li><strong>Color Filter</strong>（色彩滤镜）：不带 alpha 的 HDR 色彩<li><strong>Hue Shift</strong>（色调偏移）：滑块范围从 -180° 到 +180°<li><strong>Saturation</strong>（饱和度）：滑块范围从 -100 到 100</ol><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">struct</span> <span class="nc">ColorAdjustmentsSettings</span> <span class="p">{</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">postExposure</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">Range</span><span class="p">(-</span><span class="m">100f</span><span class="p">,</span> <span class="m">100f</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">contrast</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">ColorUsage</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">)]</span>
    <span class="k">public</span> <span class="n">Color</span> <span class="n">colorFilter</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">Range</span><span class="p">(-</span><span class="m">180f</span><span class="p">,</span> <span class="m">180f</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">hueShift</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">Range</span><span class="p">(-</span><span class="m">100f</span><span class="p">,</span> <span class="m">100f</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">saturation</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>默认值都是零，但色彩滤镜应该是白色。这些设置不会改变图像。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">ColorAdjustmentsSettings</span> <span class="n">colorAdjustments</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ColorAdjustmentsSettings</span> <span class="p">{</span>
    <span class="n">colorFilter</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">white</span>
<span class="p">};</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/settings.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/settings.png" alt="色彩调整设置" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">色彩调整设置</figcaption></figure><p>我们同时进行色彩分级和色调映射，因此将 <code class="language-plaintext highlighter-rouge">PostFXStack.DoToneMapping</code> 重构重命名为 <code class="language-plaintext highlighter-rouge">DoColorGradingAndToneMapping</code>。我们还将在这里多次访问 <code class="language-plaintext highlighter-rouge">PostFXSettings</code> 的内部类型，因此添加 <code class="language-plaintext highlighter-rouge">using static PostFXSettings</code> 以保持代码简短。然后添加一个 <code class="language-plaintext highlighter-rouge">ConfigureColorAdjustments</code> 方法，在其中获取色彩调整设置，并在 <code class="language-plaintext highlighter-rouge">DoColorGradingAndToneMapping</code> 的开头调用它。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.Rendering</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">static</span> <span class="n">PostFXSettings</span><span class="p">;</span>

<span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">PostFXStack</span> <span class="p">{</span>
    <span class="p">....</span>

    <span class="k">void</span> <span class="nf">ConfigureColorAdjustments</span> <span class="p">()</span> <span class="p">{</span>
        <span class="n">ColorAdjustmentsSettings</span> <span class="n">colorAdjustments</span> <span class="p">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">ColorAdjustments</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">DoColorGradingAndToneMapping</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sourceId</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">ConfigureColorAdjustments</span><span class="p">();</span>
        <span class="n">ToneMappingSettings</span><span class="p">.</span><span class="n">Mode</span> <span class="n">mode</span> <span class="p">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">ToneMapping</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
        <span class="n">Pass</span> <span class="n">pass</span> <span class="p">=</span> <span class="n">Pass</span><span class="p">.</span><span class="n">ToneMappingNone</span> <span class="p">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mode</span><span class="p">;</span>
        <span class="nf">Draw</span><span class="p">(</span><span class="n">sourceId</span><span class="p">,</span> <span class="n">BuiltinRenderTextureType</span><span class="p">.</span><span class="n">CameraTarget</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><aside class="collapsible-aside"><h3>using static 做什么？</h3><div><p>它类似于使用命名空间，但用于类型。它使类或结构体的所有常量、静态成员和类型成员可以直接访问，而无需完全限定它们。</p></div></aside><p>我们可以为色彩调整设置一个着色器向量和色彩。色彩调整向量的分量是曝光、对比度、色调偏移和饱和度。曝光以档位（stops）为单位测量，这意味着我们必须将 2 提高到配置的曝光值的幂。还要将对比度和饱和度转换为 0–2 范围，将色调偏移转换为 -1–1。滤镜必须在线性色彩空间中。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">ColorAdjustmentsSettings</span> <span class="n">colorAdjustments</span> <span class="p">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">ColorAdjustments</span><span class="p">;</span>
<span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalVector</span><span class="p">(</span><span class="n">colorAdjustmentsId</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector4</span><span class="p">(</span>
    <span class="n">Mathf</span><span class="p">.</span><span class="nf">Pow</span><span class="p">(</span><span class="m">2f</span><span class="p">,</span> <span class="n">colorAdjustments</span><span class="p">.</span><span class="n">postExposure</span><span class="p">),</span>
    <span class="n">colorAdjustments</span><span class="p">.</span><span class="n">contrast</span> <span class="p">*</span> <span class="m">0.01f</span> <span class="p">+</span> <span class="m">1f</span><span class="p">,</span>
    <span class="n">colorAdjustments</span><span class="p">.</span><span class="n">hueShift</span> <span class="p">*</span> <span class="p">(</span><span class="m">1f</span> <span class="p">/</span> <span class="m">360f</span><span class="p">),</span>
    <span class="n">colorAdjustments</span><span class="p">.</span><span class="n">saturation</span> <span class="p">*</span> <span class="m">0.01f</span> <span class="p">+</span> <span class="m">1f</span>
<span class="p">));</span>
<span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalColor</span><span class="p">(</span><span class="n">colorFilterId</span><span class="p">,</span> <span class="n">colorAdjustments</span><span class="p">.</span><span class="n">colorFilter</span><span class="p">.</span><span class="n">linear</span><span class="p">);</span>
</pre></table></code></div></div><h3 id="后期曝光"><span class="me-2">后期曝光</span><a href="#后期曝光" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在着色器端，添加向量和色彩。我们将把每个调整放在自己的函数中，从后期曝光开始。创建一个 <code class="language-plaintext highlighter-rouge">ColorGradePostExposure</code> 函数，将色彩与曝光值相乘。然后在 <code class="language-plaintext highlighter-rouge">ColorGrade</code> 中限制色彩后应用曝光。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kt">float4</span> <span class="n">_ColorAdjustments</span><span class="p">;</span>
<span class="kt">float4</span> <span class="n">_ColorFilter</span><span class="p">;</span>

<span class="kt">float3</span> <span class="nf">ColorGradePostExposure</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">color</span> <span class="o">*</span> <span class="n">_ColorAdjustments</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float3</span> <span class="nf">ColorGrade</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">60</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradePostExposure</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/post-exposure-minus-2.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/post-exposure-minus-2.png" alt="后期曝光 -2 和 2" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/post-exposure-plus-2.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/post-exposure-plus-2.png" alt="后期曝光 -2 和 2" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">后期曝光 -2 和 2</figcaption></figure><p>后期曝光的理念是模仿相机的曝光，但在所有其他后处理效果之后、所有其他色彩分级之前应用。它是一个非真实的艺术工具，可用于在不影响其他效果（如光晕）的情况下调整曝光。</p><h3 id="对比度"><span class="me-2">对比度</span><a href="#对比度" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>第二个调整是对比度。我们通过从色彩中减去均匀的中灰色，然后按对比度缩放，再将中灰色添加回去来应用它。使用 <code class="language-plaintext highlighter-rouge">ACEScc_MIDGRAY</code> 作为灰色值。</p><aside class="collapsible-aside"><h3>什么是 ACEScc？</h3><div><p>ACEScc 是 ACES 色彩空间的对数子集。中灰色值为 0.4135884。</p></div></aside><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">ColorGradingContrast</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">color</span> <span class="o">-</span> <span class="n">ACEScc_MIDGRAY</span><span class="p">)</span> <span class="o">*</span> <span class="n">_ColorAdjustments</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">ACEScc_MIDGRAY</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float3</span> <span class="nf">ColorGrade</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">60</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradePostExposure</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingContrast</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>为了获得最佳效果，此转换在 Log C 而不是线性色彩空间中完成。我们可以使用 Color Core Library 文件中的 <code class="language-plaintext highlighter-rouge">LinearToLogC</code> 函数从线性转换到 Log C，并使用 <code class="language-plaintext highlighter-rouge">LogCToLinear</code> 函数转换回来。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">ColorGradingContrast</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">LinearToLogC</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">color</span> <span class="o">-</span> <span class="n">ACEScc_MIDGRAY</span><span class="p">)</span> <span class="o">*</span> <span class="n">_ColorAdjustments</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">ACEScc_MIDGRAY</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">LogCToLinear</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/linear-logc.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/linear-logc.png" alt="线性和 Log C" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/logc.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/logc.png" alt="线性和 Log C" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">线性和 Log C</figcaption></figure><p>当对比度增加时，这可能会导致色彩分量为负，这会干扰后续的调整。因此，在 <code class="language-plaintext highlighter-rouge">ColorGrade</code> 中调整对比度后消除负值。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingContrast</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
<span class="n">color</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/contrast-minus-50.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/contrast-minus-50.png" alt="对比度 -50 和 50" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/contrast-plus-50.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/contrast-plus-50.png" alt="对比度 -50 和 50" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">对比度 -50 和 50</figcaption></figure><h3 id="色彩滤镜"><span class="me-2">色彩滤镜</span><a href="#色彩滤镜" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>色彩滤镜接下来，只需将其与色彩相乘。它对负值也适用，因此我们可以在消除负值之前应用它。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">ColorGradeColorFilter</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">color</span> <span class="o">*</span> <span class="n">_ColorFilter</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float3</span> <span class="nf">ColorGrade</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">60</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradePostExposure</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingContrast</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradeColorFilter</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/color-filter.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/color-filter.png" alt="浅青色滤镜，消除大部分红光" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">浅青色滤镜，消除大部分红光</figcaption></figure><h3 id="色调偏移"><span class="me-2">色调偏移</span><a href="#色调偏移" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>URP 和 HDRP 在色彩滤镜之后执行色调偏移，我们将使用相同的调整顺序。色彩的色调通过 <code class="language-plaintext highlighter-rouge">RgbToHsv</code> 将色彩格式从 RGB 转换为 HSV，将色调偏移添加到 H，然后通过 <code class="language-plaintext highlighter-rouge">HsvToRgb</code> 转换回来进行调整。因为色调定义在 0–1 色轮上，所以如果超出范围，我们必须将其环绕。我们可以使用 <code class="language-plaintext highlighter-rouge">RotateHue</code>，将调整后的色调、零和 1 作为参数传递。这必须在消除负值后进行。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">ColorGradingHueShift</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">RgbToHsv</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">hue</span> <span class="o">=</span> <span class="n">color</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">_ColorAdjustments</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
    <span class="n">color</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">RotateHue</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">HsvToRgb</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">float3</span> <span class="nf">ColorGrade</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">60</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradePostExposure</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingContrast</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradeColorFilter</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingHueShift</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/hue-shift.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/hue-shift.png" alt="180° 色调偏移" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">180° 色调偏移</figcaption></figure><h3 id="饱和度"><span class="me-2">饱和度</span><a href="#饱和度" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>最后一个调整是饱和度。首先使用 <code class="language-plaintext highlighter-rouge">Luminance</code> 函数获取色彩的亮度。然后像对比度一样计算结果，但使用亮度而不是中灰色，并且不在 Log C 中。这同样会产生负值，因此从 <code class="language-plaintext highlighter-rouge">ColorGrade</code> 的最终结果中删除这些负值。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">ColorGradingSaturation</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float</span> <span class="n">luminance</span> <span class="o">=</span> <span class="n">Luminance</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">color</span> <span class="o">-</span> <span class="n">luminance</span><span class="p">)</span> <span class="o">*</span> <span class="n">_ColorAdjustments</span><span class="p">.</span><span class="n">w</span> <span class="o">+</span> <span class="n">luminance</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float3</span> <span class="nf">ColorGrade</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">60</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradePostExposure</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingContrast</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradeColorFilter</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingHueShift</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingSaturation</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/saturation-minus-100.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/saturation-minus-100.png" alt="饱和度 -100 和 100" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/saturation-plus-100.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/saturation-plus-100.png" alt="饱和度 -100 和 100" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">饱和度 -100 和 100</figcaption></figure><h2 id="更多控制"><span class="me-2">更多控制</span><a href="#更多控制" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>色彩调整工具不是 URP 和 HDRP 提供的唯一色彩分级选项。我们将再次复制 Unity 的方法，添加对更多工具的支持。</p><h3 id="白平衡"><span class="me-2">白平衡</span><a href="#白平衡" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>白平衡工具可以调整图像的感知温度。它有两个滑块，范围为 -100–100。第一个是 Temperature（温度），用于使图像更冷或更暖。第二个是 Tint（色调），用于调整温度偏移后的色彩。在 <code class="language-plaintext highlighter-rouge">PostFXSettings</code> 中为其添加一个设置结构体，默认值为零。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">Serializable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">WhiteBalanceSettings</span> <span class="p">{</span>
    <span class="p">[</span><span class="nf">Range</span><span class="p">(-</span><span class="m">100f</span><span class="p">,</span> <span class="m">100f</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">tint</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
<span class="n">WhiteBalanceSettings</span> <span class="n">whiteBalance</span> <span class="p">=</span> <span class="k">default</span><span class="p">;</span>

<span class="k">public</span> <span class="n">WhiteBalanceSettings</span> <span class="n">WhiteBalance</span> <span class="p">=&gt;</span> <span class="n">whiteBalance</span><span class="p">;</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/white-balance-settings.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/white-balance-settings.png" alt="白平衡设置" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">白平衡设置</figcaption></figure><p>我们可以使用单个向量着色器属性，可以通过调用 Core Library 中的 <code class="language-plaintext highlighter-rouge">ColorUtils.ColorBalanceToLMSCoeffs</code> 来获取它，传入温度和色调。在 <code class="language-plaintext highlighter-rouge">PostFXStack</code> 中的专用配置方法中设置它，并在 <code class="language-plaintext highlighter-rouge">DoColorGradingAndToneMapping</code> 中的 <code class="language-plaintext highlighter-rouge">ConfigureColorAdjustments</code> 之后调用。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">ConfigureWhiteBalance</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">WhiteBalanceSettings</span> <span class="n">whiteBalance</span> <span class="p">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">WhiteBalance</span><span class="p">;</span>
    <span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalVector</span><span class="p">(</span><span class="n">whiteBalanceId</span><span class="p">,</span> <span class="n">ColorUtils</span><span class="p">.</span><span class="nf">ColorBalanceToLMSCoeffs</span><span class="p">(</span>
        <span class="n">whiteBalance</span><span class="p">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">whiteBalance</span><span class="p">.</span><span class="n">tint</span>
    <span class="p">));</span>
<span class="p">}</span>

<span class="k">void</span> <span class="nf">DoColorGradingAndToneMapping</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sourceId</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">ConfigureColorAdjustments</span><span class="p">();</span>
    <span class="nf">ConfigureWhiteBalance</span><span class="p">();</span>
    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在着色器端，我们通过在 LMS 色彩空间中将色彩与向量相乘来应用白平衡。我们可以使用 <code class="language-plaintext highlighter-rouge">LinearToLMS</code> 和 <code class="language-plaintext highlighter-rouge">LMSToLinear</code> 函数进行转换。在后期曝光之后和对比度之前应用它。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kt">float4</span> <span class="n">_ColorAdjustments</span><span class="p">;</span>
<span class="kt">float4</span> <span class="n">_ColorFilter</span><span class="p">;</span>
<span class="kt">float4</span> <span class="n">_WhiteBalance</span><span class="p">;</span>

<span class="kt">float3</span> <span class="nf">ColorGradePostExposure</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span> <span class="p">....</span> <span class="p">}</span>

<span class="kt">float3</span> <span class="nf">ColorGradeWhiteBalance</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">LinearToLMS</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">*=</span> <span class="n">_WhiteBalance</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">LMSToLinear</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">....</span>

<span class="kt">float3</span> <span class="nf">ColorGrade</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">60</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradePostExposure</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradeWhiteBalance</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingContrast</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><aside class="collapsible-aside"><h3>什么是 LMS 色彩空间？</h3><div><p>它将色彩描述为人眼中三种感光锥细胞类型的响应。</p></div></aside><p>冷温度使图像变蓝，而暖温度使图像变黄。通常使用小调整，但我展示极端值以使效果明显。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/temperature-minus-100.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/temperature-minus-100.png" alt="温度 -100 和 100" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/temperature-plus-100.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/temperature-plus-100.png" alt="温度 -100 和 100" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">温度 -100 和 100</figcaption></figure><p>色调可用于补偿不需要的色彩平衡，将图像推向绿色或洋红色。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/tint-minus-100.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/tint-minus-100.png" alt="色调 -100 和 100" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/tint-plus-100.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/tint-plus-100.png" alt="色调 -100 和 100" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">色调 -100 和 100</figcaption></figure><h3 id="分离色调"><span class="me-2">分离色调</span><a href="#分离色调" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>分离色调工具用于分别为图像的阴影和高光着色。一个典型的例子是将阴影推向冷蓝色，将高光推向暖橙色。</p><p>为其创建一个设置结构体，包含两个不带 alpha 的 LDR 色彩，用于阴影和高光。它们的默认值是灰色。还包括一个 -100–100 范围的 balance（平衡）滑块，默认值为零。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">Serializable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">SplitToningSettings</span> <span class="p">{</span>
    <span class="p">[</span><span class="nf">ColorUsage</span><span class="p">(</span><span class="k">false</span><span class="p">)]</span>
    <span class="k">public</span> <span class="n">Color</span> <span class="n">shadows</span><span class="p">,</span> <span class="n">highlights</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">Range</span><span class="p">(-</span><span class="m">100f</span><span class="p">,</span> <span class="m">100f</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">balance</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
<span class="n">SplitToningSettings</span> <span class="n">splitToning</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SplitToningSettings</span> <span class="p">{</span>
    <span class="n">shadows</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">gray</span><span class="p">,</span>
    <span class="n">highlights</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">gray</span>
<span class="p">};</span>

<span class="k">public</span> <span class="n">SplitToningSettings</span> <span class="n">SplitToning</span> <span class="p">=&gt;</span> <span class="n">splitToning</span><span class="p">;</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/split-toning-settings.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/split-toning-settings.png" alt="分离色调设置" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">分离色调设置</figcaption></figure><p>在 <code class="language-plaintext highlighter-rouge">PostFXStack</code> 中将两种色彩发送到着色器，保持它们在伽马空间中。balance 值可以存储在其中一种色彩的第四个分量中，缩放到 -1–1 范围。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">ConfigureSplitToning</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">SplitToningSettings</span> <span class="n">splitToning</span> <span class="p">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">SplitToning</span><span class="p">;</span>
    <span class="n">Color</span> <span class="n">splitColor</span> <span class="p">=</span> <span class="n">splitToning</span><span class="p">.</span><span class="n">shadows</span><span class="p">;</span>
    <span class="n">splitColor</span><span class="p">.</span><span class="n">a</span> <span class="p">=</span> <span class="n">splitToning</span><span class="p">.</span><span class="n">balance</span> <span class="p">*</span> <span class="m">0.01f</span><span class="p">;</span>
    <span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalColor</span><span class="p">(</span><span class="n">splitToningShadowsId</span><span class="p">,</span> <span class="n">splitColor</span><span class="p">);</span>
    <span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalColor</span><span class="p">(</span><span class="n">splitToningHighlightsId</span><span class="p">,</span> <span class="n">splitToning</span><span class="p">.</span><span class="n">highlights</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">void</span> <span class="nf">DoColorGradingAndToneMapping</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sourceId</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">ConfigureColorAdjustments</span><span class="p">();</span>
    <span class="nf">ConfigureWhiteBalance</span><span class="p">();</span>
    <span class="nf">ConfigureSplitToning</span><span class="p">();</span>
    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在着色器端，我们将在近似伽马空间中执行分离色调，事先将色彩提高到 2.2 的倒数，之后提高到 2.2。这样做是为了匹配 Adobe 产品的分离色调。调整在色彩滤镜之后、消除负值之后进行。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kt">float4</span> <span class="n">_WhiteBalance</span><span class="p">;</span>
<span class="kt">float4</span> <span class="n">_SplitToningShadows</span><span class="p">,</span> <span class="n">_SplitToningHighlights</span><span class="p">;</span>

<span class="p">....</span>

<span class="kt">float3</span> <span class="nf">ColorGradeSplitToning</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">PositivePow</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="mi">2</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">PositivePow</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">2</span><span class="p">.</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">....</span>

<span class="kt">float3</span> <span class="nf">ColorGrade</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">....</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradeColorFilter</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradeSplitToning</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><p>我们通过在色彩和阴影色调之间执行柔光混合，然后是高光色调来应用色调。我们可以使用 <code class="language-plaintext highlighter-rouge">SoftLight</code> 函数两次。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">ColorGradeSplitToning</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">PositivePow</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="mi">2</span><span class="p">);</span>
    <span class="kt">float3</span> <span class="n">shadows</span> <span class="o">=</span> <span class="n">_SplitToningShadows</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">highlights</span> <span class="o">=</span> <span class="n">_SplitToningHighlights</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">SoftLight</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">shadows</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">SoftLight</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">highlights</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">PositivePow</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">2</span><span class="p">.</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>我们通过在混合之前在中性 0.5 和它们自身之间插值色调来将色调限制在各自的区域。对于高光，我们基于饱和亮度加上 balance 来执行此操作，再次饱和。对于阴影，我们使用反向。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">float</span> <span class="n">t</span> <span class="o">=</span> <span class="nb">saturate</span><span class="p">(</span><span class="n">Luminance</span><span class="p">(</span><span class="nb">saturate</span><span class="p">(</span><span class="n">color</span><span class="p">))</span> <span class="o">+</span> <span class="n">_SplitToningShadows</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
<span class="kt">float3</span> <span class="n">shadows</span> <span class="o">=</span> <span class="nb">lerp</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">_SplitToningShadows</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="n">t</span><span class="p">);</span>
<span class="kt">float3</span> <span class="n">highlights</span> <span class="o">=</span> <span class="nb">lerp</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">_SplitToningHighlights</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
<span class="n">color</span> <span class="o">=</span> <span class="n">SoftLight</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">shadows</span><span class="p">);</span>
<span class="n">color</span> <span class="o">=</span> <span class="n">SoftLight</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">highlights</span><span class="p">);</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/split-toning-blue-orange.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/split-toning-blue-orange.png" alt="使用蓝色和橙色的分离色调，以及无调整的对比" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">使用蓝色和橙色的分离色调，以及无调整的对比</figcaption></figure><h3 id="通道混合器"><span class="me-2">通道混合器</span><a href="#通道混合器" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>我们将支持的另一个工具是通道混合器。它允许你组合输入 RGB 值以创建新的 RGB 值。例如，你可以交换 R 和 G，从 G 中减去 B，或将 G 添加到 R 以将绿色推向黄色。</p><p>混合器本质上是一个 3×3 转换矩阵，默认为单位矩阵。我们可以使用三个 Vector3 值，用于红色、绿色和蓝色配置。Unity 的控件为每种色彩显示一个单独的选项卡，每个输入通道有 -100–100 滑块，但我们将直接显示向量。行用于输出色彩，XYZ 列是 RGB 输入。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">Serializable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">ChannelMixerSettings</span> <span class="p">{</span>
    <span class="k">public</span> <span class="n">Vector3</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
<span class="n">ChannelMixerSettings</span> <span class="n">channelMixer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ChannelMixerSettings</span> <span class="p">{</span>
    <span class="n">red</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">right</span><span class="p">,</span>
    <span class="n">green</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">up</span><span class="p">,</span>
    <span class="n">blue</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">forward</span>
<span class="p">};</span>

<span class="k">public</span> <span class="n">ChannelMixerSettings</span> <span class="n">ChannelMixer</span> <span class="p">=&gt;</span> <span class="n">channelMixer</span><span class="p">;</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/channel-mixer-settings.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/channel-mixer-settings.png" alt="通道混合器设置为单位矩阵" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">通道混合器设置为单位矩阵</figcaption></figure><p>将这三个向量发送到 GPU。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">ConfigureChannelMixer</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">ChannelMixerSettings</span> <span class="n">channelMixer</span> <span class="p">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">ChannelMixer</span><span class="p">;</span>
    <span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalVector</span><span class="p">(</span><span class="n">channelMixerRedId</span><span class="p">,</span> <span class="n">channelMixer</span><span class="p">.</span><span class="n">red</span><span class="p">);</span>
    <span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalVector</span><span class="p">(</span><span class="n">channelMixerGreenId</span><span class="p">,</span> <span class="n">channelMixer</span><span class="p">.</span><span class="n">green</span><span class="p">);</span>
    <span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalVector</span><span class="p">(</span><span class="n">channelMixerBlueId</span><span class="p">,</span> <span class="n">channelMixer</span><span class="p">.</span><span class="n">blue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">void</span> <span class="nf">DoColorGradingAndToneMapping</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sourceId</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">....</span>
    <span class="nf">ConfigureSplitToning</span><span class="p">();</span>
    <span class="nf">ConfigureChannelMixer</span><span class="p">();</span>
    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在着色器中执行矩阵乘法。在分离色调之后执行此操作。之后再次消除负值，因为负权重可能会产生负色彩通道。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kt">float4</span> <span class="n">_SplitToningShadows</span><span class="p">,</span> <span class="n">_SplitToningHighlights</span><span class="p">;</span>
<span class="kt">float4</span> <span class="n">_ChannelMixerRed</span><span class="p">,</span> <span class="n">_ChannelMixerGreen</span><span class="p">,</span> <span class="n">_ChannelMixerBlue</span><span class="p">;</span>

<span class="p">....</span>

<span class="kt">float3</span> <span class="nf">ColorGradingChannelMixer</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">mul</span><span class="p">(</span>
        <span class="kt">float3x3</span><span class="p">(</span><span class="n">_ChannelMixerRed</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">_ChannelMixerGreen</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">_ChannelMixerBlue</span><span class="p">.</span><span class="n">rgb</span><span class="p">),</span>
        <span class="n">color</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="kt">float3</span> <span class="nf">ColorGrade</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">....</span>
    <span class="n">ColorGradeSplitToning</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingChannelMixer</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingHueShift</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/mixed-channels-inspector.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/mixed-channels-inspector.png" alt="绿色在 GB 之间分割，蓝色在 RGB 之间分割" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/mixed-channels-scene.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/mixed-channels-scene.png" alt="绿色在 GB 之间分割，蓝色在 RGB 之间分割" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">绿色在 GB 之间分割，蓝色在 RGB 之间分割</figcaption></figure><h3 id="阴影中间调高光"><span class="me-2">阴影、中间调、高光</span><a href="#阴影中间调高光" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>我们将支持的最后一个工具是阴影、中间调、高光（Shadows Midtones Highlights）。它的工作方式类似于分离色调，但它还允许调整中间调，并将阴影和高光区域分离，使它们可配置。</p><p>Unity 的控件显示色轮和区域权重的可视化，但我们将使用三个 HDR 色彩字段和四个滑块，用于阴影和高光过渡区域的起点和终点。阴影强度从起点减少到终点，而高光强度从起点增加到终点。我们将使用 0–2 范围，以便可以稍微进入 HDR。色彩默认为白色，我们将使用与 Unity 相同的区域默认值，即阴影为 0–0.3，高光为 0.55–1。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">Serializable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">ShadowsMidtonesHighlightsSettings</span> <span class="p">{</span>
    <span class="p">[</span><span class="nf">ColorUsage</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">)]</span>
    <span class="k">public</span> <span class="n">Color</span> <span class="n">shadows</span><span class="p">,</span> <span class="n">midtones</span><span class="p">,</span> <span class="n">highlights</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">2f</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">shadowsStart</span><span class="p">,</span> <span class="n">shadowsEnd</span><span class="p">,</span> <span class="n">highlightsStart</span><span class="p">,</span> <span class="n">highLightsEnd</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
<span class="n">ShadowsMidtonesHighlightsSettings</span>
    <span class="n">shadowsMidtonesHighlights</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ShadowsMidtonesHighlightsSettings</span> <span class="p">{</span>
    <span class="n">shadows</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">white</span><span class="p">,</span>
    <span class="n">midtones</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">white</span><span class="p">,</span>
    <span class="n">highlights</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">white</span><span class="p">,</span>
    <span class="n">shadowsEnd</span> <span class="p">=</span> <span class="m">0.3f</span><span class="p">,</span>
    <span class="n">highlightsStart</span> <span class="p">=</span> <span class="m">0.55f</span><span class="p">,</span>
    <span class="n">highLightsEnd</span> <span class="p">=</span> <span class="m">1f</span>
<span class="p">};</span>

<span class="k">public</span> <span class="n">ShadowsMidtonesHighlightsSettings</span> <span class="n">ShadowsMidtonesHighlights</span> <span class="p">=&gt;</span>
    <span class="n">shadowsMidtonesHighlights</span><span class="p">;</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/shadows-midtones-highlights-settings.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/shadows-midtones-highlights-settings.png" alt="阴影、中间调、高光设置" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">阴影、中间调、高光设置</figcaption></figure><aside class="collapsible-aside"><h3>为什么我们不能使用色轮？</h3><div><p>Unity 没有可以包含在编辑器中的默认色轮编辑器小部件。URP 和 HDRP 都包含自己的（虽然等效）版本。区域的 GUI 也是自定义的。</p></div></aside><p>将三种色彩发送到 GPU，转换为线性空间。区域范围可以打包在单个向量中。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">ConfigureShadowsMidtonesHighlights</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">ShadowsMidtonesHighlightsSettings</span> <span class="n">smh</span> <span class="p">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">ShadowsMidtonesHighlights</span><span class="p">;</span>
    <span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalColor</span><span class="p">(</span><span class="n">smhShadowsId</span><span class="p">,</span> <span class="n">smh</span><span class="p">.</span><span class="n">shadows</span><span class="p">.</span><span class="n">linear</span><span class="p">);</span>
    <span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalColor</span><span class="p">(</span><span class="n">smhMidtonesId</span><span class="p">,</span> <span class="n">smh</span><span class="p">.</span><span class="n">midtones</span><span class="p">.</span><span class="n">linear</span><span class="p">);</span>
    <span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalColor</span><span class="p">(</span><span class="n">smhHighlightsId</span><span class="p">,</span> <span class="n">smh</span><span class="p">.</span><span class="n">highlights</span><span class="p">.</span><span class="n">linear</span><span class="p">);</span>
    <span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalVector</span><span class="p">(</span><span class="n">smhRangeId</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector4</span><span class="p">(</span>
        <span class="n">smh</span><span class="p">.</span><span class="n">shadowsStart</span><span class="p">,</span> <span class="n">smh</span><span class="p">.</span><span class="n">shadowsEnd</span><span class="p">,</span> <span class="n">smh</span><span class="p">.</span><span class="n">highlightsStart</span><span class="p">,</span> <span class="n">smh</span><span class="p">.</span><span class="n">highLightsEnd</span>
    <span class="p">));</span>
<span class="p">}</span>

<span class="k">void</span> <span class="nf">DoColorGradingAndToneMapping</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sourceId</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">ConfigureColorAdjustments</span><span class="p">();</span>
    <span class="nf">ConfigureWhiteBalance</span><span class="p">();</span>
    <span class="nf">ConfigureSplitToning</span><span class="p">();</span>
    <span class="nf">ConfigureChannelMixer</span><span class="p">();</span>
    <span class="nf">ConfigureShadowsMidtonesHighlights</span><span class="p">();</span>
    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在着色器中，我们将色彩分别乘以三种色彩，每种色彩都按自己的权重缩放，然后求和结果。权重基于亮度。阴影权重从 1 开始，并在其起点和终点之间使用 <code class="language-plaintext highlighter-rouge">smoothstep</code> 函数减少到零。高光权重从零增加到一。中间调权重等于 1 减去其他两个权重。这个想法是阴影和高光区域不重叠——或者只是一点点——因此中间调权重永远不会变为负数。然而，我们在检查器中不强制执行此操作，就像我们不强制起点在终点之前一样。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kt">float4</span> <span class="n">_ChannelMixerRed</span><span class="p">,</span> <span class="n">_ChannelMixerGreen</span><span class="p">,</span> <span class="n">_ChannelMixerBlue</span><span class="p">;</span>
<span class="kt">float4</span> <span class="n">_SMHShadows</span><span class="p">,</span> <span class="n">_SMHMidtones</span><span class="p">,</span> <span class="n">_SMHHighlights</span><span class="p">,</span> <span class="n">_SMHRange</span><span class="p">;</span>

<span class="p">....</span>

<span class="kt">float3</span> <span class="nf">ColorGradingShadowsMidtonesHighlights</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float</span> <span class="n">luminance</span> <span class="o">=</span> <span class="n">Luminance</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">shadowsWeight</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="nb">smoothstep</span><span class="p">(</span><span class="n">_SMHRange</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">_SMHRange</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">luminance</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">highlightsWeight</span> <span class="o">=</span> <span class="nb">smoothstep</span><span class="p">(</span><span class="n">_SMHRange</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">_SMHRange</span><span class="p">.</span><span class="n">w</span><span class="p">,</span> <span class="n">luminance</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">midtonesWeight</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="n">shadowsWeight</span> <span class="o">-</span> <span class="n">highlightsWeight</span><span class="p">;</span>
    <span class="k">return</span>
        <span class="n">color</span> <span class="o">*</span> <span class="n">_SMHShadows</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">shadowsWeight</span> <span class="o">+</span>
        <span class="n">color</span> <span class="o">*</span> <span class="n">_SMHMidtones</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">midtonesWeight</span> <span class="o">+</span>
        <span class="n">color</span> <span class="o">*</span> <span class="n">_SMHHighlights</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">highlightsWeight</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float3</span> <span class="nf">ColorGrade</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">....</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingChannelMixer</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingShadowsMidtonesHighlights</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/shadows-midtones-highlights-adjusted.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/shadows-midtones-highlights-adjusted.png" alt="蓝色阴影、粉色中间调和黄色高光" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">蓝色阴影、粉色中间调和黄色高光</figcaption></figure><p>Unity 控件的色轮工作方式相同，只是它们限制输入色彩并允许更精确的拖动。使用 HVS 色彩选择器模式调整色彩，以在没有约束的情况下模仿此功能。</p><aside class="collapsible-aside"><h3>色彩曲线工具和 Lift Gamma Gain 工具呢？</h3><div><p>色彩曲线是一个强大的工具，可以用于许多效果，包括对除单一色彩之外的所有内容进行去饱和。但是，它依赖于自定义曲线编辑器，重现起来会有很多工作。因此本教程不包括它。</p><p>Unity 的 Lift Gamma Gain 工具与阴影、中间调、高光的工作方式类似，但不太直观，并且依赖于在对色彩应用缩放-偏移-幂调整之前进行一些转换。所以我只包括了其中一个。</p></div></aside><h3 id="aces-色彩空间"><span class="me-2">ACES 色彩空间</span><a href="#aces-色彩空间" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>当使用 ACES 色调映射时，Unity 在 ACES 色彩空间而不是线性色彩空间中执行大部分色彩分级，以产生更好的结果。让我们也这样做。</p><p>后期曝光和白平衡始终在线性空间中应用。对比度是它发散的地方。向 <code class="language-plaintext highlighter-rouge">ColorGradingContrast</code> 添加一个布尔参数 <code class="language-plaintext highlighter-rouge">useACES</code>。如果使用 ACES，首先从线性转换到 ACES，然后转换到 ACEScc 色彩空间，而不是转换到 Log C。我们可以通过 <code class="language-plaintext highlighter-rouge">unity_to_ACES</code> 和 <code class="language-plaintext highlighter-rouge">ACES_to_ACEScc</code> 来实现。调整对比度后，通过 <code class="language-plaintext highlighter-rouge">ACEScc_to_ACES</code> 和 <code class="language-plaintext highlighter-rouge">ACES_to_ACEScg</code> 转换到 ACEScg，而不是返回到线性空间。</p><aside class="collapsible-aside"><h3>什么是 ACEScg？</h3><div><p>ACEScg 是 ACES 色彩空间的线性子集。</p></div></aside><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">ColorGradingContrast</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">,</span> <span class="n">bool</span> <span class="n">useACES</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">useACES</span> <span class="o">?</span> <span class="n">ACES_to_ACEScc</span><span class="p">(</span><span class="n">unity_to_ACES</span><span class="p">(</span><span class="n">color</span><span class="p">))</span> <span class="o">:</span> <span class="n">LinearToLogC</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">color</span> <span class="o">-</span> <span class="n">ACEScc_MIDGRAY</span><span class="p">)</span> <span class="o">*</span> <span class="n">_ColorAdjustments</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">ACEScc_MIDGRAY</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">useACES</span> <span class="o">?</span> <span class="n">ACES_to_ACEScg</span><span class="p">(</span><span class="n">ACEScc_to_ACES</span><span class="p">(</span><span class="n">color</span><span class="p">))</span> <span class="o">:</span> <span class="n">LogCToLinear</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>从现在开始，在色彩分级对比度步骤之后，我们要么处于线性空间，要么处于 ACEScg 色彩空间。一切仍然以相同的方式工作，只是在 ACEScg 空间中应该使用 <code class="language-plaintext highlighter-rouge">AcesLuminance</code> 计算亮度。引入一个 <code class="language-plaintext highlighter-rouge">Luminance</code> 函数变体，该函数根据是否使用 ACES 调用正确的函数。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">float</span> <span class="nf">Luminance</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">,</span> <span class="n">bool</span> <span class="n">useACES</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">useACES</span> <span class="o">?</span> <span class="n">AcesLuminance</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">:</span> <span class="n">Luminance</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">ColorGradeSplitToning</code> 使用亮度，给它一个 <code class="language-plaintext highlighter-rouge">useACES</code> 参数并将其传递给 <code class="language-plaintext highlighter-rouge">Luminance</code>。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">ColorGradeSplitToning</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">,</span> <span class="n">bool</span> <span class="n">useACES</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">PositivePow</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">t</span> <span class="o">=</span> <span class="nb">saturate</span><span class="p">(</span><span class="n">Luminance</span><span class="p">(</span><span class="nb">saturate</span><span class="p">(</span><span class="n">color</span><span class="p">),</span> <span class="n">useACES</span><span class="p">)</span> <span class="o">+</span> <span class="n">_SplitToningShadows</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><p>对 <code class="language-plaintext highlighter-rouge">ColorGradingShadowsMidtonesHighlights</code> 做同样的事情。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">ColorGradingShadowsMidtonesHighlights</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">,</span> <span class="n">bool</span> <span class="n">useACES</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float</span> <span class="n">luminance</span> <span class="o">=</span> <span class="n">Luminance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">useACES</span><span class="p">);</span>
    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><p>以及 <code class="language-plaintext highlighter-rouge">ColorGradingSaturation</code>。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">ColorGradingSaturation</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">,</span> <span class="n">bool</span> <span class="n">useACES</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float</span> <span class="n">luminance</span> <span class="o">=</span> <span class="n">Luminance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">useACES</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">luminance</span> <span class="o">+</span> <span class="n">_ColorAdjustments</span><span class="p">.</span><span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">color</span> <span class="o">-</span> <span class="n">luminance</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>然后也将参数添加到 <code class="language-plaintext highlighter-rouge">ColorGrade</code>，这次默认设置为 false。将其传递给需要它的函数。当适当时，最终色彩应通过 <code class="language-plaintext highlighter-rouge">ACEScg_to_ACES</code> 转换为 ACES 色彩空间。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">ColorGrade</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">,</span> <span class="n">bool</span> <span class="n">useACES</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">60</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradePostExposure</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradeWhiteBalance</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingContrast</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">useACES</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradeColorFilter</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">ColorGradeSplitToning</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">useACES</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingChannelMixer</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingShadowsMidtonesHighlights</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">useACES</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingHueShift</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">ColorGradingSaturation</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">useACES</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">useACES</span> <span class="o">?</span> <span class="n">ACEScg_to_ACES</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">:</span> <span class="n">color</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>现在调整 <code class="language-plaintext highlighter-rouge">ToneMappingACESPassFragment</code>，使其指示它使用 ACES。由于 <code class="language-plaintext highlighter-rouge">ColorGrade</code> 的结果将处于 ACES 色彩空间，因此可以直接传递给 <code class="language-plaintext highlighter-rouge">ACESTonemap</code>。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kt">float4</span> <span class="nf">ToneMappingACESPassFragment</span> <span class="p">(</span><span class="n">Varyings</span> <span class="n">input</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="kt">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">GetSource</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">screenUV</span><span class="p">);</span>
    <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">ColorGrade</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
    <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">AcesTonemap</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>为了说明差异，这里是使用 ACES 色调映射并增加对比度以及调整阴影、中间调和高光的比较。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/aces-linear.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/aces-linear.png" alt="ACES 色调映射，在 ACES 和线性色彩空间中进行色彩分级" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/aces-aces.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/aces-aces.png" alt="ACES 色调映射，在 ACES 和线性色彩空间中进行色彩分级" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">ACES 色调映射，在 ACES 和线性色彩空间中进行色彩分级</figcaption></figure><h2 id="lut"><span class="me-2">LUT</span><a href="#lut" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>对每个像素执行所有色彩分级步骤是很多工作。我们可以制作许多变体，仅应用改变某些东西的步骤，但这需要大量关键字或通道。我们可以做的是将色彩分级烘焙到查找表（LUT）中，并对其进行采样以转换色彩。LUT 是一个 3D 纹理，通常为 32×32×32。填充该纹理并稍后对其进行采样的工作量远少于直接对整个图像执行色彩分级。URP 和 HDRP 使用相同的方法。</p><h3 id="lut-分辨率"><span class="me-2">LUT 分辨率</span><a href="#lut-分辨率" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>通常，色彩 LUT 分辨率为 32 就足够了，但让我们使其可配置。这是一个质量设置，我们将添加到 <code class="language-plaintext highlighter-rouge">CustomRenderPipelineAsset</code>，然后用于所有色彩分级。我们将使用一个枚举来提供 16、32 和 64 作为选项，然后将其作为整数传递给管线构造函数。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">enum</span> <span class="n">ColorLUTResolution</span> <span class="p">{</span> <span class="n">_16</span> <span class="p">=</span> <span class="m">16</span><span class="p">,</span> <span class="n">_32</span> <span class="p">=</span> <span class="m">32</span><span class="p">,</span> <span class="n">_64</span> <span class="p">=</span> <span class="m">64</span> <span class="p">}</span>

<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
<span class="n">ColorLUTResolution</span> <span class="n">colorLUTResolution</span> <span class="p">=</span> <span class="n">ColorLUTResolution</span><span class="p">.</span><span class="n">_32</span><span class="p">;</span>

<span class="k">protected</span> <span class="k">override</span> <span class="n">RenderPipeline</span> <span class="nf">CreatePipeline</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">CustomRenderPipeline</span><span class="p">(</span>
        <span class="n">allowHDR</span><span class="p">,</span> <span class="n">useDynamicBatching</span><span class="p">,</span> <span class="n">useGPUInstancing</span><span class="p">,</span> <span class="n">useSRPBatcher</span><span class="p">,</span>
        <span class="n">useLightsPerObject</span><span class="p">,</span> <span class="n">shadows</span><span class="p">,</span> <span class="n">postFXSettings</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">colorLUTResolution</span>
    <span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><aside class="collapsible-aside"><h3>为什么不允许任意分辨率？</h3><div><p>URP 和 HDRP 允许最多 65 的任意 LUT 分辨率，但对于我们将使用的方法，当不使用 2 的幂时，LUT 采样可能会出错。</p></div></aside><p>在 <code class="language-plaintext highlighter-rouge">CustomRenderPipeline</code> 中跟踪色彩 LUT 分辨率，并将其传递给 <code class="language-plaintext highlighter-rouge">CameraRenderer.Render</code> 方法。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">colorLUTResolution</span><span class="p">;</span>

<span class="k">public</span> <span class="nf">CustomRenderPipeline</span> <span class="p">(</span>
    <span class="p">....</span>
    <span class="n">PostFXSettings</span> <span class="n">postFXSettings</span><span class="p">,</span> <span class="kt">int</span> <span class="n">colorLUTResolution</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">colorLUTResolution</span> <span class="p">=</span> <span class="n">colorLUTResolution</span><span class="p">;</span>
    <span class="p">....</span>
<span class="p">}</span>

<span class="p">....</span>

<span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Render</span> <span class="p">(</span>
    <span class="n">ScriptableRenderContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Camera</span><span class="p">&gt;</span> <span class="n">cameras</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">cameras</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
        <span class="n">renderer</span><span class="p">.</span><span class="nf">Render</span><span class="p">(</span>
            <span class="n">context</span><span class="p">,</span> <span class="n">cameras</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">allowHDR</span><span class="p">,</span>
            <span class="n">useDynamicBatching</span><span class="p">,</span> <span class="n">useGPUInstancing</span><span class="p">,</span> <span class="n">useLightsPerObject</span><span class="p">,</span>
            <span class="n">shadowSettings</span><span class="p">,</span> <span class="n">postFXSettings</span><span class="p">,</span> <span class="n">colorLUTResolution</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>将其传递给 <code class="language-plaintext highlighter-rouge">PostFXStack.Setup</code>。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">void</span> <span class="nf">Render</span> <span class="p">(</span>
    <span class="n">ScriptableRenderContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Camera</span> <span class="n">camera</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">allowHDR</span><span class="p">,</span>
    <span class="kt">bool</span> <span class="n">useDynamicBatching</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useGPUInstancing</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">useLightsPerObject</span><span class="p">,</span>
    <span class="n">ShadowSettings</span> <span class="n">shadowSettings</span><span class="p">,</span> <span class="n">PostFXSettings</span> <span class="n">postFXSettings</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">colorLUTResolution</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="p">....</span>
    <span class="n">postFXStack</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">camera</span><span class="p">,</span> <span class="n">postFXSettings</span><span class="p">,</span> <span class="n">useHDR</span><span class="p">,</span> <span class="n">colorLUTResolution</span><span class="p">);</span>
    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">PostFXStack</code> 跟踪它。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">colorLUTResolution</span><span class="p">;</span>

<span class="p">....</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">Setup</span> <span class="p">(</span>
    <span class="n">ScriptableRenderContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Camera</span> <span class="n">camera</span><span class="p">,</span> <span class="n">PostFXSettings</span> <span class="n">settings</span><span class="p">,</span>
    <span class="kt">bool</span> <span class="n">useHDR</span><span class="p">,</span> <span class="kt">int</span> <span class="n">colorLUTResolution</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">colorLUTResolution</span> <span class="p">=</span> <span class="n">colorLUTResolution</span><span class="p">;</span>
    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/color-lut-resolution.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/color-lut-resolution.png" alt="色彩 LUT 分辨率" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">色彩 LUT 分辨率</figcaption></figure><h3 id="渲染到-2d-lut-纹理"><span class="me-2">渲染到 2D LUT 纹理</span><a href="#渲染到-2d-lut-纹理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>LUT 是 3D 的，但常规着色器无法渲染到 3D 纹理。因此，我们将使用宽 2D 纹理来模拟 3D 纹理，通过将 2D 切片放在一行中。因此，LUT 纹理的高度等于配置的分辨率，其宽度等于分辨率的平方。使用该大小获取临时渲染纹理，使用默认 HDR 格式。在 <code class="language-plaintext highlighter-rouge">DoColorGradingAndToneMapping</code> 中配置色彩分级后执行此操作。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nf">ConfigureShadowsMidtonesHighlights</span><span class="p">();</span>

<span class="kt">int</span> <span class="n">lutHeight</span> <span class="p">=</span> <span class="n">colorLUTResolution</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">lutWidth</span> <span class="p">=</span> <span class="n">lutHeight</span> <span class="p">*</span> <span class="n">lutHeight</span><span class="p">;</span>
<span class="n">buffer</span><span class="p">.</span><span class="nf">GetTemporaryRT</span><span class="p">(</span>
    <span class="n">colorGradingLUTId</span><span class="p">,</span> <span class="n">lutWidth</span><span class="p">,</span> <span class="n">lutHeight</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span>
    <span class="n">FilterMode</span><span class="p">.</span><span class="n">Bilinear</span><span class="p">,</span> <span class="n">RenderTextureFormat</span><span class="p">.</span><span class="n">DefaultHDR</span>
<span class="p">);</span>
</pre></table></code></div></div><p>从现在开始，我们将色彩分级和色调映射都渲染到 LUT。相应地重命名现有的色调映射通道，因此 <code class="language-plaintext highlighter-rouge">ToneMappingNone</code> 变为 <code class="language-plaintext highlighter-rouge">ColorGradingNone</code>，依此类推。然后使用适当的通道绘制到 LUT 而不是相机目标。之后，将源复制到相机目标以获取未调整的图像作为最终结果，并释放 LUT。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">ToneMappingSettings</span><span class="p">.</span><span class="n">Mode</span> <span class="n">mode</span> <span class="p">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">ToneMapping</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
<span class="n">Pass</span> <span class="n">pass</span> <span class="p">=</span> <span class="n">Pass</span><span class="p">.</span><span class="n">ColorGradingNone</span> <span class="p">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mode</span><span class="p">;</span>
<span class="nf">Draw</span><span class="p">(</span><span class="n">sourceId</span><span class="p">,</span> <span class="n">colorGradingLUTId</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>

<span class="nf">Draw</span><span class="p">(</span><span class="n">sourceId</span><span class="p">,</span> <span class="n">BuiltinRenderTextureType</span><span class="p">.</span><span class="n">CameraTarget</span><span class="p">,</span> <span class="n">Pass</span><span class="p">.</span><span class="n">Copy</span><span class="p">);</span>
<span class="n">buffer</span><span class="p">.</span><span class="nf">ReleaseTemporaryRT</span><span class="p">(</span><span class="n">colorGradingLUTId</span><span class="p">);</span>
</pre></table></code></div></div><p>我们现在绕过了色彩分级和色调映射，但帧调试器显示我们在最终复制之前绘制了图像的扁平化版本。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/flattened-image.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/flattened-image.png" alt="扁平化图像" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">扁平化图像</figcaption></figure><h3 id="lut-色彩矩阵"><span class="me-2">LUT 色彩矩阵</span><a href="#lut-色彩矩阵" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>要创建适当的 LUT，我们需要用色彩转换矩阵填充它。我们通过调整色彩分级通道函数来使用从 UV 坐标派生的色彩，而不是采样源纹理来实现。添加一个 <code class="language-plaintext highlighter-rouge">GetColorGradedLUT</code>，它获取色彩并立即执行色彩分级。然后通道函数只需在其上应用色调映射。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">GetColorGradedLUT</span> <span class="p">(</span><span class="kt">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="n">bool</span> <span class="n">useACES</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float3</span> <span class="n">color</span> <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ColorGrade</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">useACES</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">float4</span> <span class="nf">ColorGradingNonePassFragment</span> <span class="p">(</span><span class="n">Varyings</span> <span class="n">input</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="kt">float3</span> <span class="n">color</span> <span class="o">=</span> <span class="n">GetColorGradedLUT</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">screenUV</span><span class="p">);</span>
    <span class="k">return</span> <span class="kt">float4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">float4</span> <span class="nf">ColorGradingACESPassFragment</span> <span class="p">(</span><span class="n">Varyings</span> <span class="n">input</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="kt">float3</span> <span class="n">color</span> <span class="o">=</span> <span class="n">GetColorGradedLUT</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">screenUV</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">AcesTonemap</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="k">return</span> <span class="kt">float4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">float4</span> <span class="nf">ColorGradingNeutralPassFragment</span> <span class="p">(</span><span class="n">Varyings</span> <span class="n">input</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="kt">float3</span> <span class="n">color</span> <span class="o">=</span> <span class="n">GetColorGradedLUT</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">screenUV</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">NeutralTonemap</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="k">return</span> <span class="kt">float4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">float4</span> <span class="nf">ColorGradingReinhardPassFragment</span> <span class="p">(</span><span class="n">Varyings</span> <span class="n">input</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="kt">float3</span> <span class="n">color</span> <span class="o">=</span> <span class="n">GetColorGradedLUT</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">screenUV</span><span class="p">);</span>
    <span class="n">color</span> <span class="o">/=</span> <span class="n">color</span> <span class="o">+</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="kt">float4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>我们可以通过 <code class="language-plaintext highlighter-rouge">GetLutStripValue</code> 函数找到 LUT 输入色彩。它需要 UV 坐标和一个我们需要发送到 GPU 的色彩分级 lut 参数向量。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kt">float4</span> <span class="n">_ColorGradingLUTParameters</span><span class="p">;</span>

<span class="kt">float3</span> <span class="nf">GetColorGradedLUT</span> <span class="p">(</span><span class="kt">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="n">bool</span> <span class="n">useACES</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float3</span> <span class="n">color</span> <span class="o">=</span> <span class="n">GetLutStripValue</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">_ColorGradingLUTParameters</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ColorGrade</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">useACES</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>四个向量参数值是 LUT 高度、0.5 除以宽度、0.5 除以高度，以及高度除以其自身减一。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">buffer</span><span class="p">.</span><span class="nf">GetTemporaryRT</span><span class="p">(</span>
    <span class="n">colorGradingLUTId</span><span class="p">,</span> <span class="n">lutWidth</span><span class="p">,</span> <span class="n">lutHeight</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span>
    <span class="n">FilterMode</span><span class="p">.</span><span class="n">Bilinear</span><span class="p">,</span> <span class="n">RenderTextureFormat</span><span class="p">.</span><span class="n">DefaultHDR</span>
<span class="p">);</span>
<span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalVector</span><span class="p">(</span><span class="n">colorGradingLUTParametersId</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector4</span><span class="p">(</span>
    <span class="n">lutHeight</span><span class="p">,</span> <span class="m">0.5f</span> <span class="p">/</span> <span class="n">lutWidth</span><span class="p">,</span> <span class="m">0.5f</span> <span class="p">/</span> <span class="n">lutHeight</span><span class="p">,</span> <span class="n">lutHeight</span> <span class="p">/</span> <span class="p">(</span><span class="n">lutHeight</span> <span class="p">-</span> <span class="m">1f</span><span class="p">)</span>
<span class="p">));</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/lut-none.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/lut-none.png" alt="没有色彩分级的 LUT，使用无、ACES 和 Reinhard 色调映射" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/lut-aces.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/lut-aces.png" alt="没有色彩分级的 LUT，使用无、ACES 和 Reinhard 色调映射" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/lut-reinhard.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/lut-reinhard.png" alt="没有色彩分级的 LUT，使用无、ACES 和 Reinhard 色调映射" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">没有色彩分级的 LUT，使用无、ACES 和 Reinhard 色调映射</figcaption></figure><aside class="collapsible-aside"><h3>URP 不是单独进行色调映射吗？</h3><div><p>URP 将色彩分级和色调映射都烘焙到 LUT 中用于 HDR 渲染，但对于 LDR 渲染则单独进行色调映射。但是，色调映射对 LDR 渲染没有多大意义，所以我没有给它特殊处理。</p><p>除此之外，URP 对 LDR LUT 使用 LDR RBGA 格式，但我总是使用相同的默认 HDR 格式以保持简单。</p><p>Unity 还将后期曝光保留在 LUT 之外，但我只是将所有内容都放入其中。</p></div></aside><h3 id="log-c-lut"><span class="me-2">Log C LUT</span><a href="#log-c-lut" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>我们得到的 LUT 矩阵处于线性色彩空间中，并且仅覆盖 0–1 范围。为了支持 HDR，我们必须扩展此范围。我们可以通过将输入色彩解释为处于 Log C 空间中来实现。这将范围扩展到略低于 59。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/linear-logc.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/linear-logc.png" alt="存储的线性和 Log C 强度" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">存储的线性和 Log C 强度</figcaption></figure><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">GetColorGradedLUT</span> <span class="p">(</span><span class="kt">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="n">bool</span> <span class="n">useACES</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float3</span> <span class="n">color</span> <span class="o">=</span> <span class="n">GetLutStripValue</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">_ColorGradingLUTParameters</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ColorGrade</span><span class="p">(</span><span class="n">LogCToLinear</span><span class="p">(</span><span class="n">color</span><span class="p">),</span> <span class="n">useACES</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/lut-logc-none.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/lut-logc-none.png" alt="LogC 色彩，使用无、ACES 和 Reinhard 色调映射" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/lut-logc-aces.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/lut-logc-aces.png" alt="LogC 色彩，使用无、ACES 和 Reinhard 色调映射" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/lut-logc-reinhard.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/lut-logc-reinhard.png" alt="LogC 色彩，使用无、ACES 和 Reinhard 色调映射" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">LogC 色彩，使用无、ACES 和 Reinhard 色调映射</figcaption></figure><p>与线性空间相比，Log C 为最暗的值添加了更多分辨率。它在大约 0.5 处超过线性值。之后，强度迅速上升，因此矩阵分辨率大大降低。这是覆盖 HDR 值所需的，但如果我们不需要这些值，最好坚持使用线性空间，否则几乎一半的分辨率被浪费了。向着色器添加一个布尔值来控制这一点。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">bool</span> <span class="n">_ColorGradingLUTInLogC</span><span class="p">;</span>

<span class="kt">float3</span> <span class="nf">GetColorGradedLUT</span> <span class="p">(</span><span class="kt">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="n">bool</span> <span class="n">useACES</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float3</span> <span class="n">color</span> <span class="o">=</span> <span class="n">GetLutStripValue</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">_ColorGradingLUTParameters</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ColorGrade</span><span class="p">(</span><span class="n">_ColorGradingLUTInLogC</span> <span class="o">?</span> <span class="n">LogCToLinear</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">:</span> <span class="n">color</span><span class="p">,</span> <span class="n">useACES</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>仅当使用 HDR 并应用色调映射时才启用 Log C 模式。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">ToneMappingSettings</span><span class="p">.</span><span class="n">Mode</span> <span class="n">mode</span> <span class="p">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">ToneMapping</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
<span class="n">Pass</span> <span class="n">pass</span> <span class="p">=</span> <span class="n">Pass</span><span class="p">.</span><span class="n">ColorGradingNone</span> <span class="p">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mode</span><span class="p">;</span>
<span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalFloat</span><span class="p">(</span>
    <span class="n">colorGradingLUTInLogId</span><span class="p">,</span> <span class="n">useHDR</span> <span class="p">&amp;&amp;</span> <span class="n">pass</span> <span class="err">\</span><span class="p">!=</span> <span class="n">Pass</span><span class="p">.</span><span class="n">ColorGradingNone</span> <span class="p">?</span> <span class="m">1f</span> <span class="p">:</span> <span class="m">0f</span>
<span class="p">);</span>
<span class="nf">Draw</span><span class="p">(</span><span class="n">sourceId</span><span class="p">,</span> <span class="n">colorGradingLUTId</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
</pre></table></code></div></div><p>因为我们不再依赖渲染的图像，所以不再需要将范围限制为 60。它已经被 LUT 的范围限制了。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">ColorGrade</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">,</span> <span class="n">bool</span> <span class="n">useACES</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//color = min(color, 60.0);</span>
    <span class="p">....</span>
<span class="p">}</span>
</pre></table></code></div></div><aside class="collapsible-aside"><h3>我们仍然需要为 LUT 通道指定源纹理吗？</h3><div><p>我们不使用它，但 Draw 期望一个源，所以我们仍然必须传递一些东西给它。</p></div></aside><h3 id="最终通道"><span class="me-2">最终通道</span><a href="#最终通道" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>要应用 LUT，我们引入一个新的最终通道。它所需要做的就是获取源色彩并将色彩分级 LUT 应用于它。在单独的 <code class="language-plaintext highlighter-rouge">ApplyColorGradingLUT</code> 函数中执行此操作。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="nf">ApplyColorGradingLUT</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float4</span> <span class="nf">FinalPassFragment</span> <span class="p">(</span><span class="n">Varyings</span> <span class="n">input</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="kt">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">GetSource</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">screenUV</span><span class="p">);</span>
    <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">ApplyColorGradingLUT</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>我们可以通过 <code class="language-plaintext highlighter-rouge">ApplyLut2D</code> 函数应用 LUT，该函数负责将 2D LUT 条解释为 3D 纹理。它需要 LUT 纹理和采样器状态作为参数，然后是饱和输入色彩——根据需要在线性或 Log C 空间中——最后是一个参数向量，尽管这次只有三个分量。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">TEXTURE2D</span><span class="p">(</span><span class="n">_ColorGradingLUT</span><span class="p">);</span>

<span class="kt">float3</span> <span class="nf">ApplyColorGradingLUT</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ApplyLut2D</span><span class="p">(</span>
        <span class="n">TEXTURE2D_ARGS</span><span class="p">(</span><span class="n">_ColorGradingLUT</span><span class="p">,</span> <span class="n">sampler_linear_clamp</span><span class="p">),</span>
        <span class="nb">saturate</span><span class="p">(</span><span class="n">_ColorGradingLUTInLogC</span> <span class="o">?</span> <span class="n">LinearToLogC</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">:</span> <span class="n">color</span><span class="p">),</span>
        <span class="n">_ColorGradingLUTParameters</span><span class="p">.</span><span class="n">xyz</span>
    <span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在这种情况下，参数值是 1 除以 LUT 宽度、1 除以高度以及高度减一。在最终绘制之前设置这些值，现在使用最终通道。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">buffer</span><span class="p">.</span><span class="nf">SetGlobalVector</span><span class="p">(</span><span class="n">colorGradingLUTParametersId</span><span class="p">,</span>
    <span class="k">new</span> <span class="nf">Vector4</span><span class="p">(</span><span class="m">1f</span> <span class="p">/</span> <span class="n">lutWidth</span><span class="p">,</span> <span class="m">1f</span> <span class="p">/</span> <span class="n">lutHeight</span><span class="p">,</span> <span class="n">lutHeight</span> <span class="p">-</span> <span class="m">1f</span><span class="p">)</span>
<span class="p">);</span>

<span class="nf">Draw</span><span class="p">(</span><span class="n">sourceId</span><span class="p">,</span> <span class="n">BuiltinRenderTextureType</span><span class="p">.</span><span class="n">CameraTarget</span><span class="p">,</span> <span class="n">Pass</span><span class="p">.</span><span class="n">Final</span><span class="p">);</span>
<span class="n">buffer</span><span class="p">.</span><span class="nf">ReleaseTemporaryRT</span><span class="p">(</span><span class="n">colorGradingLUTId</span><span class="p">);</span>
</pre></table></code></div></div><aside class="collapsible-aside"><h3>我们必须每帧重新创建 LUT 吗？</h3><div><p>仅对 LUT 纹理进行色彩分级和色调映射已经比对渲染图像的所有像素分别进行处理要少得多的工作。进一步的优化是缓存 LUT。但是，确定是否需要刷新 LUT 可能会变得复杂，特别是当支持每个相机的不同设置或混合设置时。因此，我们坚持每次渲染相机时重新创建 LUT 的简单方法。URP 和 HDRP 也是这样做的。</p></div></aside><h3 id="lut-色带"><span class="me-2">LUT 色带</span><a href="#lut-色带" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>虽然我们现在使用 LUT 进行色彩分级和色调映射，但结果应该与以前相同。但是，由于 LUT 具有有限的分辨率，并且我们使用双线性插值对其进行采样，因此它将原本平滑的色彩过渡转换为线性色带。这对于分辨率 32 的 LUT 通常不明显，但在具有极端 HDR 色彩梯度的区域中，色带可能会变得可见。一个例子是上一个教程的色调映射场景中强度为 200 的聚光灯的衰减，它照亮了一个均匀的白色表面。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/banding-16.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/banding-16.png" alt="色带，LUT 分辨率 16 和 32" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/banding-32.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/banding-32.png" alt="色带，LUT 分辨率 16 和 32" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">色带，LUT 分辨率 16 和 32</figcaption></figure><p>可以通过暂时切换到 <code class="language-plaintext highlighter-rouge">sampler_point_clamp</code> 采样器状态来使色带非常明显。这会关闭我们 LUT 的 2D 切片内的插值。相邻切片之间仍然存在插值，因为 <code class="language-plaintext highlighter-rouge">ApplyLut2D</code> 通过采样两个切片并在它们之间混合来模拟 3D 纹理。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:2px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/banding-clamp-16.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/banding-clamp-16.png" alt="点采样，LUT 分辨率 16 和 32" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/SRP/srp13color-grading/banding-clamp-32.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/SRP/srp13color-grading/banding-clamp-32.png" alt="点采样，LUT 分辨率 16 和 32" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">点采样，LUT 分辨率 16 和 32</figcaption></figure><p>如果色带太明显，你可以将分辨率提高到 64，但色彩的一点变化通常足以隐藏它。如果你在非常微妙的色彩过渡中寻找色带伪影，你更有可能发现由于 8 位帧缓冲区限制而导致的色带，这不是由 LUT 引起的，可以通过抖动来缓解，但那是另一个话题。</p><hr /><p><strong>翻译完成！</strong> 本篇文章涵盖了：</p><ol><li><strong>色彩调整</strong>：后期曝光、对比度、色彩滤镜、色调偏移、饱和度<li><strong>更多控制</strong>：白平衡、分离色调、通道混合器、阴影/中间调/高光<li><strong>ACES 色彩空间</strong>：在 ACES 色彩空间中进行更好的色彩分级<li><strong>LUT 优化</strong>：使用查找表（LUT）来提高性能，支持可配置的分辨率和 Log C 空间</ol><p>下一个教程是<a href="../multiple-camera">多摄像机</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/unity3d/">Unity3D</a>, <a href="/categories/scriptrenderpipeline/">ScriptRenderPipeline</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/srp/" class="post-tag no-text-decoration" >SRP</a> <a href="/tags/colorgrading/" class="post-tag no-text-decoration" >ColorGrading</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Unity%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B8%B2%E6%9F%93%E7%AE%A1%E7%BA%BF13%EF%BC%9A%E8%89%B2%E5%BD%A9%E5%88%86%E7%BA%A7%20-%20%E4%BB%97%E5%89%91%E5%A4%A9%E6%B6%AF&url=www.damonc.top%2Fposts%2Fcolor-grading%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Unity%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B8%B2%E6%9F%93%E7%AE%A1%E7%BA%BF13%EF%BC%9A%E8%89%B2%E5%BD%A9%E5%88%86%E7%BA%A7%20-%20%E4%BB%97%E5%89%91%E5%A4%A9%E6%B6%AF&u=www.damonc.top%2Fposts%2Fcolor-grading%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=www.damonc.top%2Fposts%2Fcolor-grading%2F&text=Unity%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B8%B2%E6%9F%93%E7%AE%A1%E7%BA%BF13%EF%BC%9A%E8%89%B2%E5%BD%A9%E5%88%86%E7%BA%A7%20-%20%E4%BB%97%E5%89%91%E5%A4%A9%E6%B6%AF" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/particles/">粒子系统：颜色和深度纹理</a><li class="text-truncate lh-lg"> <a href="/posts/color-grading/">Unity自定义渲染管线13：色彩分级</a><li class="text-truncate lh-lg"> <a href="/posts/post-processing/">自定义渲染管线:后处理 (翻译十一)</a><li class="text-truncate lh-lg"> <a href="/posts/hdr/">自定义渲染管线:HDR (翻译十二)</a><li class="text-truncate lh-lg"> <a href="/posts/point-spot-light-shadow/">自定义渲染管线:点光源与聚光灯阴影 (翻译十)</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/shader/">Shader</a> <a class="post-tag btn btn-outline-primary" href="/tags/srp/">SRP</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai/">AI</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli-agent/">CLI Agent</a> <a class="post-tag btn btn-outline-primary" href="/tags/best-practices/">Best Practices</a> <a class="post-tag btn btn-outline-primary" href="/tags/bloom/">Bloom</a> <a class="post-tag btn btn-outline-primary" href="/tags/point-light/">Point Light</a> <a class="post-tag btn btn-outline-primary" href="/tags/post-processing/">Post Processing</a> <a class="post-tag btn btn-outline-primary" href="/tags/shadows/">Shadows</a> <a class="post-tag btn btn-outline-primary" href="/tags/spot-light/">Spot Light</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/particles/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1606406400" data-df="ll" > Nov 27, 2020 </time><h4 class="pt-0 my-2">粒子系统：颜色和深度纹理</h4><div class="text-muted"><p>深入探索Unity粒子系统的渲染技术，包括翻书动画、近距离淡入淡出、软粒子和扭曲效果的实现原理与实践。</p></div></div></a></article><article class="col"> <a href="/posts/multiple-camera/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1603641600" data-df="ll" > Oct 26, 2020 </time><h4 class="pt-0 my-2">自定义渲染管线:多摄像机渲染 (翻译十四)</h4><div class="text-muted"><p>深入探讨Unity自定义渲染管线中的多摄像机渲染技术，包括分屏渲染、摄像机混合以及渲染层遮罩的实现。</p></div></div></a></article><article class="col"> <a href="/posts/hdr/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1597593600" data-df="ll" > Aug 17, 2020 </time><h4 class="pt-0 my-2">自定义渲染管线:HDR (翻译十二)</h4><div class="text-muted"><p>实现高动态范围渲染、散射和高动态范围映射</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/hdr/" class="btn btn-outline-primary" aria-label="Older" ><p>自定义渲染管线:HDR (翻译十二)</p></a> <a href="/posts/multiple-camera/" class="btn btn-outline-primary" aria-label="Newer" ><p>自定义渲染管线:多摄像机渲染 (翻译十四)</p></a></nav><div id="waline-container" class="mt-5 pt-4" style="border-top: 1px dashed #ccc; padding-top: 20px;"><div id="waline"></div></div><link rel="stylesheet" href="/assets/css/waline.css"> <script type="module"> window.WalinePrefix = "/pro"; const observer = new IntersectionObserver((entries) => { if (entries[0].isIntersecting) { observer.disconnect(); import('/assets/js/dist/waline.min.js').then(({ init }) => { init({ el: '#waline', serverURL: 'https://comments.damonc.top', dark: 'html[data-mode="dark"]', emoji: [ 'https://fastly.jsdelivr.net/npm/@waline/emojis@1.4.0/qq' ], reaction: true, pageview: false }); }); } }); observer.observe(document.getElementById('waline-container')); </script><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2026</time> <a href="https://github.com/damonc-top">仗剑天涯</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>The blog is powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/shader/">Shader</a> <a class="post-tag btn btn-outline-primary" href="/tags/srp/">SRP</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai/">AI</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli-agent/">CLI Agent</a> <a class="post-tag btn btn-outline-primary" href="/tags/best-practices/">Best Practices</a> <a class="post-tag btn btn-outline-primary" href="/tags/bloom/">Bloom</a> <a class="post-tag btn btn-outline-primary" href="/tags/point-light/">Point Light</a> <a class="post-tag btn btn-outline-primary" href="/tags/post-processing/">Post Processing</a> <a class="post-tag btn btn-outline-primary" href="/tags/shadows/">Shadows</a> <a class="post-tag btn btn-outline-primary" href="/tags/spot-light/">Spot Light</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
