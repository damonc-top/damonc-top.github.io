<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Unity Deferred Lights-延迟光照(翻译十五)" /><meta name="author" content="catlikecoding" /><meta property="og:locale" content="en" /><meta name="description" content="本篇摘要： 自定义灯光渲染 解码LDR颜色 增加独立Pass渲染光 支持方向光、点光源、聚光灯 手动采样阴影纹理" /><meta property="og:description" content="本篇摘要： 自定义灯光渲染 解码LDR颜色 增加独立Pass渲染光 支持方向光、点光源、聚光灯 手动采样阴影纹理" /><link rel="canonical" href="www.damonc.top/posts/Unity_Deferred_Lights/" /><meta property="og:url" content="www.damonc.top/posts/Unity_Deferred_Lights/" /><meta property="og:site_name" content="仗剑天涯" /><meta property="og:image" content="https://img.damonc.top/posts/2018/month1/catRender15/tutorial-image.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-01-17T20:00:00+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://img.damonc.top/posts/2018/month1/catRender15/tutorial-image.png" /><meta property="twitter:title" content="Unity Deferred Lights-延迟光照(翻译十五)" /><meta name="twitter:site" content="@elonmusk" /><meta name="twitter:creator" content="@catlikecoding" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"catlikecoding","url":"https://catlikecoding.com/unity/tutorials"},"dateModified":"2026-02-15T00:29:02+08:00","datePublished":"2018-01-17T20:00:00+08:00","description":"本篇摘要： 自定义灯光渲染 解码LDR颜色 增加独立Pass渲染光 支持方向光、点光源、聚光灯 手动采样阴影纹理","headline":"Unity Deferred Lights-延迟光照(翻译十五)","image":{"lqip":"data:image/webp;base64,UklGRloAAABXRUJQVlA4IE4AAABwAwCdASoUAAoAP3Ggxlk0q6gjsAgCkC4JYwAAW5rtI0OYZAAA/rvD6nDsQpIMCyoW76RaM7lViJLpB1UhCHRilOfV6cqVq6I1oYAAAAA=","url":"https://img.damonc.top/posts/2018/month1/catRender15/tutorial-image.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"www.damonc.top/posts/Unity_Deferred_Lights/"},"url":"www.damonc.top/posts/Unity_Deferred_Lights/"}</script><meta name="fediverse:creator" content="@damonc@mastodon.social"><title>Unity Deferred Lights-延迟光照(翻译十五) | 仗剑天涯</title><link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script type="module" src="/assets/js/dist/theme.min.js"></script> <script> /* Apply sidebar collapsed state as early as possible to prevent flickering */ if (localStorage.getItem('sidebar-collapsed') === 'true') { document.documentElement.setAttribute('data-sidebar-collapsed', 'true'); } </script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js,npm/mermaid@11.12.0/dist/mermaid.min.js"></script> <script type="module" defer src="/assets/js/dist/post.min.js"></script> <script src="/assets/js/data/mathjax.js"></script> <script async src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script> <script type="module"> window.WalinePrefix = "/pro"; import { pageviewCount } from '/assets/js/dist/waline.min.js'; pageviewCount({ serverURL: 'https://comments.damonc.top', update: true }); </script> <script type="module" defer src="/app.min.js?baseurl=&register=true" ></script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7166721253489246" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"> <button type="button" id="sidebar-collapse-btn" class="btn" aria-label="Toggle Sidebar"> <i class="fas fa-bars-staggered"></i> </button><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="https://img.damonc.top/commons/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">仗剑天涯</a><p class="site-subtitle fst-italic mb-0">听说读写看做忘摊手</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/damonc-top" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/elonmusk" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['damoncbl','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Unity Deferred Lights-延迟光照(翻译十五)</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Unity Deferred Lights-延迟光照(翻译十五)</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1516190400" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jan 17, 2018 </time> </span> <span> Updated <time data-ts="1771086542" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 15, 2026 </time> </span><div class="mt-3 mb-3"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/tutorial-image.png" class="popup img-link preview-img blur"><img data-src="https://img.damonc.top/posts/2018/month1/catRender15/tutorial-image.png" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/webp;base64,UklGRloAAABXRUJQVlA4IE4AAABwAwCdASoUAAoAP3Ggxlk0q6gjsAgCkC4JYwAAW5rtI0OYZAAA/rvD6nDsQpIMCyoW76RaM7lViJLpB1UhCHRilOfV6cqVq6I1oYAAAAA="></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://catlikecoding.com/unity/tutorials">catlikecoding</a> </em> </span><div> <span> <em class="waline-pageview-count" data-path="/posts/Unity_Deferred_Lights/"> <i class="fas fa-spinner fa-spin small"></i> </em> views </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="5720 words" > <em>31 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Unity Deferred Lights-延迟光照(翻译十五)</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Unity Deferred Lights-延迟光照(翻译十五)</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><p>本篇摘要：</p><ul><li>自定义灯光渲染<li>解码LDR颜色<li>增加独立Pass渲染光<li>支持方向光、点光源、聚光灯<li>手动采样阴影纹理</ul><h2 id="光照light-shader"><span class="me-2">光照Light Shader</span><a href="#光照light-shader" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>在G-Buffers填充完毕后，然后渲染光。本篇先介绍Unity是如何渲染光，以及实现自己的渲染光的Shader。在Edit / Project Settings / Graphics 去掉默认的Shader。</p><h3 id="using-a-custom-shader"><span class="me-2">Using a Custom Shader</span><a href="#using-a-custom-shader" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>每个deferred光都是在一个独立的Pass修改屏幕图像(后处理Image)完成渲染。创建一个Shader然后指定到Built-In shader settings</p><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200519084812390-1178609122.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200519084812390-1178609122.png" alt="修改内置的Shader" width="100%" height="auto" loading="lazy"></a></div></div><h3 id="第二个passa-second-pass"><span class="me-2">第二个PassA Second Pass</span><a href="#第二个passa-second-pass" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>修改之后，编辑器大量报错.</p><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200519084812964-728132925.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200519084812964-728132925.png" alt="least 2 passes" width="100%" height="auto" loading="lazy"></a></div></div><p>先简单复制第一个Pass解决错误，结果是屏幕内除了天空盒外所有物体被渲染成黑色了。这是因为使用了stencil-buffer。</p><p><strong>报错的原因</strong>：为什么需要第二个Pass？</p><ul><li>当HDR禁用时，光照数据会被使用对数编码计算，然后在(第二个)最终的pass解码该数据。所以必须要增加Pass。<em>当禁用HDR时就能调用第二个Pass，但此时天空也变黑了。</em></ul><h3 id="avoiding-the-sky"><span class="me-2">Avoiding the Sky</span><a href="#avoiding-the-sky" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>当在LDR（HDR禁用）模式，天空变黑了。这是因为转换过程中没有正确使用stencil-buffer模板掩码。在<strong>第二个Pass中配置</strong>：应该只渲染不属于背景的片段，可通过_StencilNonBackground提供适当的模板值。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">Pass</span>
<span class="p">{</span>
    <span class="n">Stencil</span>
    <span class="p">{</span>
        <span class="n">Ref</span><span class="p">[</span><span class="n">_StencilNonBackground</span><span class="p">]</span>
        <span class="n">ReadMask</span><span class="p">[</span><span class="n">_StencilNonBackground</span><span class="p">]</span>
        <span class="n">CompBack</span> <span class="n">Equal</span>
        <span class="n">CompFront</span> <span class="n">Equal</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="颜色转换converting-colors"><span class="me-2">颜色转换Converting Colors</span><a href="#颜色转换converting-colors" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在第二个Pass的light-buffer转换光照数据，方法就似Fog shader：用输入源的Image UV坐标采样buffer来绘制一个覆盖全屏的quad</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">VertexData</span> <span class="p">{</span>
    <span class="kt">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="nb">POSITION</span><span class="p">;</span>
    <span class="kt">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="nb">TEXCOORD0</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">Interpolators</span> <span class="p">{</span>
    <span class="kt">float4</span> <span class="n">pos</span> <span class="o">:</span> <span class="nb">SV_POSITION</span><span class="p">;</span>
    <span class="kt">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="nb">TEXCOORD0</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">Interpolators</span> <span class="nf">VertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Interpolators</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">i</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>该light buffer通过名为_LightBuffer变量提供给Shader</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">sampler2D</span> <span class="n">_LightBuffer</span><span class="p">;</span>
<span class="c1">//...</span>
<span class="kt">float4</span> <span class="nf">FragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_LightBuffer</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>LDR颜色使用指数编码: $2^{-C}$，使用对数解码 $-log2^C$</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">return</span> <span class="o">-</span><span class="nb">log2</span><span class="p">(</span><span class="nb">tex2D</span><span class="p">(</span><span class="n">_LightBuffer</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">));</span>
</pre></table></code></div></div><h2 id="directional-lights"><span class="me-2">Directional Lights</span><a href="#directional-lights" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>新增一个cginc文件，引入第一个pass。要把渲染的光照增加到图像上，必须确保不能擦除已渲染的图像，因此改变混合模式要完全合并源颜色和目标颜色。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Blend</span> <span class="n">One</span> <span class="n">One</span>
</pre></table></code></div></div><p>也需要所有可能的光照配置shader variants变体，该编译指令：multi_compile_lightpass会创建所有包含的变体。然后再增加一个HDR_ON的指令。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="cp">#pragma multi_compile_lightpass
#pragma multi_compile _ UNITY_HDR_ON
</span></pre></table></code></div></div><h3 id="g-buffer-uv-coordinates"><span class="me-2">G-Buffer UV Coordinates</span><a href="#g-buffer-uv-coordinates" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>需要用UV坐标从G-buffers采样，不幸的是，该light pass通道unity不支持提供该坐标。解决办法：从clip-space传递过来，使用ComputeScreenPos函数计算，返回一个float4的齐次坐标。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">v2f</span> <span class="nf">VertexProgram</span><span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">)</span>  
<span class="p">{</span>  
     <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>  
     <span class="n">o</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>  
     <span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">ComputeScreenPos</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">pos</span><span class="p">);</span>  
     <span class="k">return</span> <span class="n">o</span><span class="p">;</span>  
<span class="p">}</span>
</pre></table></code></div></div><p>然后在fragment就能计算最终的2D坐标。必须在fragment计算。见翻译7</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">fixed4</span> <span class="nf">FragmentProgram</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
<span class="p">{</span>
    <span class="kt">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="o">/</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="坐标转换world-position"><span class="me-2">坐标转换World Position</span><a href="#坐标转换world-position" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>与上篇deferred fog中相似，需要计算从相机到片元的距离：从相机原点发射射线通过片元(给定方向)到达far-plane，然后再用fragment深度缩放射线。用该方法<strong>重建片元的世界坐标</strong>。</p><ol><li>首先。对于方向光，从quad的四顶点发出的射线作为法向量提供。所以可以通过顶点程序对射线进行插值。</ol><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">VertexData</span> <span class="p">{</span>
    <span class="kt">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="nb">POSITION</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">normal</span> <span class="o">:</span> <span class="nb">NORMAL</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">Interpolators</span> <span class="p">{</span>
    <span class="kt">float4</span> <span class="n">pos</span> <span class="o">:</span> <span class="nb">SV_POSITION</span><span class="p">;</span>
    <span class="kt">float4</span> <span class="n">uv</span> <span class="o">:</span> <span class="nb">TEXCOORD0</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">ray</span> <span class="o">:</span> <span class="nb">TEXCOORD1</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">Interpolators</span> <span class="nf">VertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Interpolators</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">i</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">ComputeScreenPos</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">pos</span><span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">ray</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>其次。在fragment函数通过采样_CameraDepthTexture纹理和线性化计算可以得到depth值，类似于deferred fog计算</ol><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c1">//Unity提供的声明函数，等于 sampler2D _CameraDepthTexture; 定义在UnityCG</span>
<span class="n">UNITY_DECLARE_DEPTH_TEXTURE</span><span class="p">(</span><span class="n">_CameraDepthTexture</span><span class="p">);</span>

<span class="kt">float4</span> <span class="nf">FragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span> <span class="p">{</span>
    <span class="kt">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="o">/</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">SAMPLE_DEPTH_TEXTURE</span><span class="p">(</span><span class="n">_CameraDepthTexture</span><span class="p">,</span> <span class="n">uv</span><span class="p">);</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">Linear01Depth</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>然后。与deferred fog最大的不同：fog shader需要射线到达far plane；而本shader的射线只能到达near plane。所以必须要缩放射线以便它能达到far-plane：缩放射线使Z坐标变为1，并与远平面距离相乘。</ol><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">depth</span> <span class="o">=</span> <span class="n">Linear01Depth</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
<span class="kt">float3</span> <span class="n">rayToFarPlane</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">ray</span> <span class="o">*</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span> <span class="o">/</span> <span class="n">i</span><span class="p">.</span><span class="n">ray</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
</pre></table></code></div></div><ol><li>再接着。按深度值缩放射线一次得到一个坐标。该射线被定义在视图空间，它是camera的本地空间。因此，射线也以片段在视图空间中的坐标结束。</ol><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="n">rayToFarPlane</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">ray</span> <span class="o">*</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span> <span class="o">/</span> <span class="n">i</span><span class="p">.</span><span class="n">ray</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="kt">float3</span> <span class="n">viewPos</span> <span class="o">=</span> <span class="n">rayToFarPlane</span> <span class="o">*</span> <span class="n">depth</span><span class="p">;</span>
</pre></table></code></div></div><ol><li>最后。再使用unity_CameraToWorld内置矩阵从view视图空间转换到world世界坐标，该矩阵定义在ShaderVariables.cginc</ol><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="n">viewPos</span> <span class="o">=</span> <span class="n">rayToFarPlane</span> <span class="o">*</span> <span class="n">depth</span><span class="p">;</span>
<span class="kt">float3</span> <span class="n">worldPos</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">unity_CameraToWorld</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">viewPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="读取g-buff-reading-g-buffer-data"><span class="me-2">读取G-Buff Reading G-Buffer Data</span><a href="#读取g-buff-reading-g-buffer-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>获取World Pos后。通过访问G-buffer检索properties，该buffer可从内置的_CamearGBufferTexture变量获取</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">sampler2D</span> <span class="n">_CameraGBufferTexture0</span><span class="p">;</span>
<span class="n">sampler2D</span> <span class="n">_CameraGBufferTexture1</span><span class="p">;</span>
<span class="n">sampler2D</span> <span class="n">_CameraGBufferTexture2</span><span class="p">;</span>
</pre></table></code></div></div><p>在上一篇Defferred Shading中也手动计算过G-buffer,这次直接读取_CameraGBufferTexture现成的albedo、specular、smoothness、normal</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="n">worldPos</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">unity_CameraToWorld</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">viewPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
<span class="kt">float3</span> <span class="n">albedo</span> <span class="o">=</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_CameraGBufferTexture0</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
<span class="kt">float3</span> <span class="n">specularTint</span> <span class="o">=</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_CameraGBufferTexture1</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span><span class="c1">//合并</span>
<span class="kt">float3</span> <span class="n">smoothness</span> <span class="o">=</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_CameraGBufferTexture1</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">a</span><span class="p">;</span><span class="c1">//合并</span>
<span class="kt">float3</span> <span class="n">normal</span> <span class="o">=</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_CameraGBufferTexture2</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">rgb</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="计算brd-computing-brdf"><span class="me-2">计算BRD Computing BRDF</span><a href="#计算brd-computing-brdf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>引入BRDF函数，定义在UnityPBSLighting.cginc中</p><p>首先计算视野方向</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="n">worldPos</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">unity_CameraToWorld</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">viewPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
<span class="kt">float3</span> <span class="n">viewDir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">_WorldSpaceCameraPos</span> <span class="o">-</span> <span class="n">worldPos</span><span class="p">);</span>
</pre></table></code></div></div><p>其次是表面反射，这可从specular颜色获取，使用SpecularStrength函数提取。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">//...</span>
<span class="n">float</span> <span class="n">oneMinusReflectivity</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">SpecularStrength</span><span class="p">(</span><span class="n">specularTint</span><span class="p">);</span>
</pre></table></code></div></div><p>然后传递光照数据，初始化直接光和间接光</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">float</span> <span class="n">oneMinusReflectivity</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">SpecularStrength</span><span class="p">(</span><span class="n">specularTint</span><span class="p">);</span>
<span class="c1">//...</span>
<span class="n">UnityLight</span> <span class="n">light</span><span class="p">;</span>
<span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">UnityIndirect</span> <span class="n">indirectLight</span><span class="p">;</span>
<span class="n">indirectLight</span><span class="p">.</span><span class="n">diffuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></table></code></div></div><p>最后计算最终的颜色</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">indirectLight</span><span class="p">.</span><span class="n">specular</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">UNITY_BRDF_PBS</span>
<span class="p">(</span>
    <span class="n">albedo</span><span class="p">,</span> <span class="n">specularTint</span><span class="p">,</span> <span class="n">oneMinusReflectivity</span><span class="p">,</span> <span class="n">smoothness</span><span class="p">,</span>
    <span class="n">normal</span><span class="p">,</span> <span class="n">viewDir</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">indirectLight</span>
<span class="p">);</span>
<span class="k">return</span> <span class="n">color</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="光源配置-configuring-the-light"><span class="me-2">光源配置 Configuring the Light</span><a href="#光源配置-configuring-the-light" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>因为间接光呈现的是黑色的，在这里不适用。但是直接光必须被配置成与当前渲染的光相匹配。对于方向光，需要它的颜色和方向。这两个变量可以通过_LightColor和_LightDir变量获得。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kt">float4</span> <span class="n">_LightColor</span><span class="p">,</span> <span class="n">_LightDir</span><span class="p">;</span>

<span class="n">UnityLight</span> <span class="nf">CreateLight</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">UnityLight</span> <span class="n">light</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">_LightDir</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">light</span><span class="p">;</span>
<span class="p">}</span>

    <span class="n">UnityLight</span> <span class="n">light</span> <span class="o">=</span> <span class="n">CreateLight</span><span class="p">();</span>
<span class="c1">//    light.color = 0;</span>
<span class="c1">//    light.dir = 0;</span>
</pre></table></code></div></div><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011132912-1838344751.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011132912-1838344751.png" alt="光照方向错误" width="100%" height="auto" loading="lazy"></a></div></div><p>计算得到最终的光照，但光的方向错误了。原因：_LightDir是光到表面的方向。在CreateLight计算中需要表面到光的方向</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">_LightDir</span><span class="p">;</span>
</pre></table></code></div></div><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011133845-1557873589.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011133845-1557873589.png" alt="正确，没有阴影" width="100%" height="auto" loading="lazy"></a></div></div><h3 id="阴影-shadows"><span class="me-2">阴影 Shadows</span><a href="#阴影-shadows" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在自己的cginc文件中，我们依靠AutoLight中的宏来确定由阴影引起的光衰减。 不幸的是，该文件在编写时并没有考虑到延迟的光线。 现在将自己进行阴影采样，可通过_ShadowMapTexture变量访问阴影贴图。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">sampler2D</span> <span class="n">_ShadowMapTexture</span><span class="p">;</span>
</pre></table></code></div></div><p>但是，我们不能随意声明此变量。 它已经在UnityShadowLibrary中为点和聚光灯阴影定义了它。 因此，我们不应该自己定义它，除非使用方向光阴影。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="cp">#if defined (SHADOWS_SCREEN)
</span>    <span class="n">sampler2D</span> <span class="n">_ShadowMapTexture</span><span class="p">;</span>
<span class="cp">#endif
</span></pre></table></code></div></div><p>要应用方向光阴影，需要采样阴影纹理并使用它来减弱光色即可。 在CreateLight中计算就需要把UV坐标参数。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">UnityLight</span> <span class="nf">CreateLight</span> <span class="p">(</span><span class="kt">float2</span> <span class="n">uv</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UnityLight</span> <span class="n">light</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">_LightDir</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_ShadowMapTexture</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">shadowAttenuation</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">light</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">UnityLight</span> <span class="n">light</span> <span class="o">=</span> <span class="n">CreateLight</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>
</pre></table></code></div></div><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011134639-175464244.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011134639-175464244.png" alt="有阴影的方向光" width="100%" height="auto" loading="lazy"></a></div></div><p>当然，这仅在定向光启用了阴影时才有效。 如果不是，则阴影衰减始终为1。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">float</span> <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#if defined(SHADOWS_SCREEN)
</span>    <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_ShadowMapTexture</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
<span class="cp">#endif
</span><span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">shadowAttenuation</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="fading-shadows"><span class="me-2">Fading Shadows</span><a href="#fading-shadows" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>阴影贴图应该是有限的，它覆盖的面积越大，阴影的分辨率越低。 Unity提供了绘制阴影的最大距离，此距离可以通过_Edit / Project Settings / Quality_进行调整。</p><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011135350-727795272.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011135350-727795272.png" alt="阴影距离配置" width="100%" height="auto" loading="lazy"></a></div></div><p>当阴影几乎快达到了该限定距离就会淡出，Unity内置的shader是这样设定并计算。由于我将手动采样该阴影纹理，当到达纹理的边缘时阴影会被截取，结果是阴影虽然消失了，但有被急剧切割的生硬画面。</p><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011136133-1319763420.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011136133-1319763420.png" alt="长、短距离阴影对比" width="100%" height="auto" loading="lazy"></a></div></div><p>要渐隐阴影，<strong>首先</strong>要知道的是阴影完全消失的距离。该距离又依赖于阴影投射方向。在Stable Fit模式下，以map的中心点呈球面形开始渐隐消失阴影；在Close Fit模式它是依赖于视野深度。</p><p>UnityComputeShadowFadeDistance函数能计算出正确距离，它需要两个参数：world pos 和 view depth；<strong>然后</strong>返回距离A。 注意：该距离A是从阴影纹理的中心点位置或者未更改的视野深度开始计算的。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">UnityLight</span> <span class="nf">CreateLight</span> <span class="p">(</span><span class="kt">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">worldPos</span><span class="p">,</span> <span class="n">float</span> <span class="n">viewZ</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UnityLight</span> <span class="n">light</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">_LightDir</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="cp">#if defined(SHADOWS_SCREEN)
</span>        <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_ShadowMapTexture</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
        <span class="n">float</span> <span class="n">shadowFadeDistance</span> <span class="o">=</span> <span class="n">UnityComputeShadowFadeDistance</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="n">viewZ</span><span class="p">);</span>
    <span class="cp">#endif
</span>    <span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">shadowAttenuation</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">light</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>阴影应该是快要接近渐隐距离时开始消失，一旦到达就完全消失。UnityComputeShadowFade函数计算合适的消失因子。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">float</span> <span class="n">shadowFadeDistance</span> <span class="o">=</span> <span class="n">UnityComputeShadowFadeDistance</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="n">viewZ</span><span class="p">);</span>
<span class="n">float</span> <span class="n">shadowFade</span> <span class="o">=</span> <span class="n">UnityComputeShadowFade</span><span class="p">(</span><span class="n">shadowFadeDistance</span><span class="p">);</span>
</pre></table></code></div></div><p><em>UnityComputeShadowFade</em> 定义在UnityShadowLibrary.cginc，见下：</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">float</span> <span class="nf">UnityComputeShadowFadeDistance</span> <span class="p">(</span><span class="kt">float3</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">float</span> <span class="n">z</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float</span> <span class="n">sphereDist</span> <span class="o">=</span> <span class="nb">distance</span><span class="p">(</span><span class="n">wpos</span><span class="p">,</span> <span class="n">unity_ShadowFadeCenterAndType</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">lerp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">sphereDist</span><span class="p">,</span> <span class="n">unity_ShadowFadeCenterAndType</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">half</span> <span class="nf">UnityComputeShadowFade</span><span class="p">(</span><span class="n">float</span> <span class="n">fadeDist</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">saturate</span><span class="p">(</span><span class="n">fadeDist</span> <span class="o">*</span> <span class="n">_LightShadowData</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">_LightShadowData</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>阴影渐隐值范围是[0, 1]，该值决定了阴影要消失多少。实际的消失值可以加到阴影衰减之上并限定在[0, 1]之内</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">float</span> <span class="n">shadowFade</span> <span class="o">=</span> <span class="n">UnityComputeShadowFade</span><span class="p">(</span><span class="n">shadowFadeDistance</span><span class="p">);</span>
<span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="nb">saturate</span><span class="p">(</span><span class="n">shadowAttenuation</span> <span class="o">+</span> <span class="n">shadowFade</span><span class="p">);</span>
</pre></table></code></div></div><p>最后，提供世界坐标和视图深度在片元程序中创建光照。视图深度是片元在视图空间中的位置的Z分量。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">UnityLight</span> <span class="n">light</span> <span class="o">=</span> <span class="n">CreateLight</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">worldPos</span><span class="p">,</span> <span class="n">viewPos</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
</pre></table></code></div></div><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011136822-531625316.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011136822-531625316.png" alt="阴影渐隐" width="100%" height="auto" loading="lazy"></a></div></div><h3 id="light-cookies"><span class="me-2">Light Cookies</span><a href="#light-cookies" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>支持Cookies纹理，使用变量 _LightTexture0 访问；同时还要从world-space转换到light-space，最后采样。转换矩阵使用 _unity_WorldToLight 矩阵变量</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">sampler2D</span> <span class="n">_LightTexture0</span><span class="p">;</span>
<span class="kt">float4x4</span> <span class="n">unity_WorldToLight</span><span class="p">;</span>
</pre></table></code></div></div><p>在 <em>CreateLight</em>，使用上述矩阵变量转换world-space到light-space；然后使用转换后的坐标采样cookie纹理。cookie也要衰减，需要单独定义并使用。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">_LightDir</span><span class="p">;</span>
<span class="n">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">float</span> <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#if defined(DIRECTIONAL_COOKIE)
</span>    <span class="kt">float2</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xy</span><span class="p">;</span>
    <span class="n">attenuation</span> <span class="o">*=</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="n">uvCookie</span><span class="p">).</span><span class="n">w</span><span class="p">;</span>
<span class="cp">#endif
</span>    <span class="c1">//...</span>
<span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="p">(</span><span class="n">attenuation</span> <span class="o">*</span> <span class="n">shadowAttenuation</span><span class="p">);</span>
</pre></table></code></div></div><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011137698-104613306.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011137698-104613306.png" alt="带有cookie的方向光" width="100%" height="auto" loading="lazy"></a></div></div><p>整体结果似乎可以，但是观察边缘似乎有硬边</p><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011138369-1638016260.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011138369-1638016260.png" alt="硬边过渡" width="100%" height="auto" loading="lazy"></a></div></div><p>相邻片元的cookie坐标的巨大差异就会导致该问题出现。在这种情况下，GPU选择的mipmap级别对于最近的表面是low level。解决办法之一就是：在采样mip映射时应用偏移。<a href="http://aras-p.info/blog/2010/01/07/screenspace-vs-mip-mapping/">大v的总结</a></p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">attenuation</span> <span class="o">*=</span> <span class="nb">tex2Dbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>
</pre></table></code></div></div><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011138941-1152817269.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011138941-1152817269.png" alt="偏移采样" width="100%" height="auto" loading="lazy"></a></div></div><h3 id="支持ldr-supporting-ldr"><span class="me-2">支持LDR Supporting LDR</span><a href="#支持ldr-supporting-ldr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>上述只支持HDR，现在来支持LDR。步骤如下：</p><p>首先，编码后的LDR颜色要乘如light-buffer，而不是加法。这可以用：Blend DstColor Zero实现。<strong>注意</strong>只用该Blend mode会引起HDR的错误。所以需要灵活配置：Blend [_SrcBlend] [_DstBlend]</p><p>然后，使用 $2^{-c}$ 函数解码</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kt">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">UNITY_BRDF_PBS</span><span class="p">(</span>
        <span class="n">albedo</span><span class="p">,</span> <span class="n">specularTint</span><span class="p">,</span> <span class="n">oneMinusReflectivity</span><span class="p">,</span> <span class="n">smoothness</span><span class="p">,</span>
        <span class="n">normal</span><span class="p">,</span> <span class="n">viewDir</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">indirectLight</span>
<span class="p">);</span>
    <span class="cp">#if !defined(UNITY_HDR_ON)
</span>        <span class="n">color</span> <span class="o">=</span> <span class="nb">exp2</span><span class="p">(</span><span class="o">-</span><span class="n">color</span><span class="p">);</span>
    <span class="cp">#endif
</span><span class="k">return</span> <span class="n">color</span><span class="p">;</span>
</pre></table></code></div></div><h2 id="聚光源-spotlights"><span class="me-2">聚光源 Spotlights</span><a href="#聚光源-spotlights" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>因为方向光会影响到场景内所有物体，所以被画成全屏quad。相比之下，聚光灯只会影响位于圆锥体内的部分物体。通常不需要计算整个图像的聚光灯光照，将绘制一个与聚光灯的影响范围相匹配的金字塔体。</p><h3 id="drawing-a-pyramid"><span class="me-2">Drawing a Pyramid</span><a href="#drawing-a-pyramid" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>禁用方向灯，改用聚光灯。因为着色器只对方向光正确工作，那么现在的结果会出现错误。但是它仍可以让你看到金字塔的哪些部分被渲染了。</p><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011139705-601577612.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011139705-601577612.png" alt="渲染范围" width="100%" height="auto" loading="lazy"></a></div></div><p>根据上图，金字塔是作为一个普通的3D对象呈现的。它的背面被剔除，所以我们可以看到金字塔的正面。只有当它前面没有东西的时候，它才会被画出来。除此之外，还添加了一个pass，用于设置模板缓冲区，以将绘图限制为位于金字塔卷内的片段。您可以通过frame-debugger来验证。</p><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011140292-1380890338.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011140292-1380890338.png" alt="剔除方式" width="100%" height="auto" loading="lazy"></a></div></div><p>这意味着我们的着色器的culling和z-test设置被否弃了。 因此将其从着色器中删除。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">Blend</span> <span class="p">[</span><span class="n">_SrcBlend</span><span class="p">]</span> <span class="p">[</span><span class="n">_DstBlend</span><span class="p">]</span>
<span class="c1">//Cull Off</span>
<span class="c1">//ZTest Always</span>
<span class="n">ZWrite</span> <span class="n">Off</span>
</pre></table></code></div></div><p>当聚光灯的体积距离相机足够远时，此方法适用。 但是，当聚光灯离摄像机太近时，它会失败。 发生这种情况时，相机可能会进入了该体积内。 甚至有可能将近平面的一部分置于其内部，而将其余部分置于其外部，与近平面相交了。 在这些情况下，模板缓冲区不能用于限制渲染。</p><p>仍然渲染光照的技巧是绘制金字塔的内表面，而不是金字塔的外表面。 这是通过渲染其背面而不是其正面来完成的。 而且，仅当这些表面最终位于已渲染的表面之后时才渲染它们。 这种方法还涵盖了聚光灯体积内的所有片段。 但这最终导致渲染了太多的碎片，因为通常金字塔的通常隐藏部分也将被渲染。 因此，仅在必要时执行。</p><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011141041-480459935.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011141041-480459935.png" alt="当靠近相机时，要绘制背面才正确" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011141704-455701372.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011141704-455701372.png" alt="当靠近相机时，要绘制背面才正确" width="100%" height="auto" loading="lazy"></a></div></div><h3 id="支持多光源-supporting-multiple-light-types"><span class="me-2">支持多光源 Supporting Multiple Light Types</span><a href="#支持多光源-supporting-multiple-light-types" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>目前，CreateLight只能用于方向光。让我们确保特定于方向灯的代码只在适当的时候使用。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="n">UnityLight</span> <span class="nf">CreateLight</span> <span class="p">(</span><span class="kt">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">worldPos</span><span class="p">,</span> <span class="n">float</span> <span class="n">viewZ</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UnityLight</span> <span class="n">light</span><span class="p">;</span>
    <span class="c1">//light.dir = -_LightDir;</span>
    <span class="n">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="cp">#if defined(DIRECTIONAL) || defined(DIRECTIONAL_COOKIE)
</span>        <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">_LightDir</span><span class="p">;</span>

        <span class="cp">#if defined(DIRECTIONAL_COOKIE)
</span>            <span class="kt">float2</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xy</span><span class="p">;</span>
            <span class="n">attenuation</span> <span class="o">*=</span> <span class="nb">tex2Dbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>
        <span class="cp">#endif
</span>
        <span class="cp">#if defined(SHADOWS_SCREEN)
</span>            <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_ShadowMapTexture</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
            <span class="n">float</span> <span class="n">shadowFadeDistance</span> <span class="o">=</span> <span class="n">UnityComputeShadowFadeDistance</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="n">viewZ</span><span class="p">);</span>
            <span class="n">float</span> <span class="n">shadowFade</span> <span class="o">=</span> <span class="n">UnityComputeShadowFade</span><span class="p">(</span><span class="n">shadowFadeDistance</span><span class="p">);</span>
            <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="nb">saturate</span><span class="p">(</span><span class="n">shadowAttenuation</span> <span class="o">+</span> <span class="n">shadowFade</span><span class="p">);</span>
        <span class="cp">#endif
</span>    <span class="cp">#else
</span>        <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="cp">#endif
</span>
    <span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="p">(</span><span class="n">attenuation</span> <span class="o">*</span> <span class="n">shadowAttenuation</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">light</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>尽管阴影衰落基于方向阴影贴图，但是其他类型的阴影也应该会被渐隐。 这样可以确保所有阴影都以相同的方式渐隐，而不仅仅是某些阴影。 因此，只要有阴影，阴影淡入淡出代码便适用于所有灯光。 因此，让我们将该代码移到特定于光源的块之外。</p><p>我们可以使用布尔值来控制是否使用阴影淡出代码。由于布尔值是一个常数值，如果它仍然为假，代码将被删除。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="n">UnityLight</span> <span class="nf">CreateLight</span> <span class="p">(</span><span class="kt">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">worldPos</span><span class="p">,</span> <span class="n">float</span> <span class="n">viewZ</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UnityLight</span> <span class="n">light</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">shadowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="cp">#if defined(DIRECTIONAL) || defined(DIRECTIONAL_COOKIE)
</span>        <span class="c1">//省略代码</span>
        <span class="cp">#if defined(SHADOWS_SCREEN)
</span>            <span class="n">shadowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_ShadowMapTexture</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
        <span class="c1">// float shadowFadeDistance = UnityComputeShadowFadeDistance(worldPos, viewZ);</span>
        <span class="c1">// float shadowFade = UnityComputeShadowFade(shadowFadeDistance);</span>
        <span class="c1">// shadowAttenuation = saturate(shadowAttenuation + shadowFade);</span>
        <span class="cp">#endif
</span>    <span class="cp">#else
</span>        <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="cp">#endif
</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">shadowed</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">float</span> <span class="n">shadowFadeDistance</span> <span class="o">=</span> <span class="n">UnityComputeShadowFadeDistance</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="n">viewZ</span><span class="p">);</span>
        <span class="n">float</span> <span class="n">shadowFade</span> <span class="o">=</span> <span class="n">UnityComputeShadowFade</span><span class="p">(</span><span class="n">shadowFadeDistance</span><span class="p">);</span>
        <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="nb">saturate</span><span class="p">(</span><span class="n">shadowAttenuation</span> <span class="o">+</span> <span class="n">shadowFade</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">light</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="p">(</span><span class="n">attenuation</span> <span class="o">*</span> <span class="n">shadowAttenuation</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">light</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>非方向灯光都有一个position变量。它通过内置的 _LightPos提供。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">float4</span> <span class="n">_LightColor</span><span class="p">,</span> <span class="n">_LightDir</span><span class="p">,</span> <span class="n">_LightPos</span><span class="p">;</span>
</pre></table></code></div></div><p>现在可以确定聚光灯的光向量得出光方向。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="cp">#else
</span>    <span class="kt">float3</span> <span class="n">lightVec</span> <span class="o">=</span> <span class="n">_LightPos</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">worldPos</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">lightVec</span><span class="p">);</span>
<span class="cp">#endif
</span></pre></table></code></div></div><h3 id="world-position-agin"><span class="me-2">World Position Agin</span><a href="#world-position-agin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>结果为黑色，似乎光线方向不正确。 发生这种情况是因为聚光灯的世界位置计算不正确。 当我们在场景中的某个地方渲染金字塔时，不像方向光那样渲染全屏quad将光线存储在normal通道中。 而必须是经由Vertex-Program从顶点的位置发射射线，通过将顶点的pos转换到view-space完成计算，为此，我们可以使用UnityObjectToViewPos函数。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">i</span><span class="p">.</span><span class="n">ray</span> <span class="o">=</span> <span class="n">UnityObjectToViewPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
</pre></table></code></div></div><p>然而，这会产生方向错误的光线。我们要消去它们的X和Y坐标。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">i</span><span class="p">.</span><span class="n">ray</span> <span class="o">=</span> <span class="n">UnityObjectToViewPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">)</span> <span class="o">*</span> <span class="nf">float3</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></table></code></div></div><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011142595-16646437.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527011142595-16646437.png" alt="正确的世界位置" width="100%" height="auto" loading="lazy"></a></div></div><p>再次看看UnityObjectToViewPos内部实现</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">inline</span> <span class="kt">float3</span> <span class="nf">UnityObjectToViewPos</span> <span class="p">(</span><span class="k">in</span> <span class="kt">float3</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_V</span><span class="p">,</span> <span class="nb">mul</span><span class="p">(</span><span class="n">unity_ObjectToWorld</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">))).</span><span class="n">xyz</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>当渲染方向光时，应该只使用顶点法线。当渲染非方向灯以外的光几何时，需要把顶点pos转到view-space计算。Unity通过 _LightAsQuad 变量告诉我们正在处理哪种情况。</p><p>如果 _LightAsQuad 被设为1，则处理的是方向光quad并且可以使用法线。否则，我们必须使用UnityObjectToViewPos。插值好过if ==&gt; from + (to – from) * t, t为1直接使用法线，为0直接计算到view-space</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">i</span><span class="p">.</span><span class="n">ray</span> <span class="o">=</span> <span class="nb">lerp</span>
<span class="p">(</span>
    <span class="n">UnityObjectToViewPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">)</span> <span class="o">*</span> <span class="nf">float3</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span>
    <span class="n">_LightAsQuad</span>
<span class="p">);</span>
</pre></table></code></div></div><h3 id="锥形衰减-cookie-attenuation"><span class="me-2">锥形衰减 Cookie Attenuation</span><a href="#锥形衰减-cookie-attenuation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>聚光灯的锥形衰减是通过cookie纹理创建的，无论是默认的圆形还是定制的cookie。我们可以从复制定向光的cookie代码，仿照着写。也是存储在 _LightTexture0</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kt">float3</span> <span class="n">lightVec</span> <span class="o">=</span> <span class="n">_LightPos</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">worldPos</span><span class="p">;</span>
<span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">lightVec</span><span class="p">);</span>
<span class="kt">float2</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xy</span><span class="p">;</span>
<span class="n">attenuation</span> <span class="o">*=</span> <span class="nb">tex2Dbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>
</pre></table></code></div></div><p>但是，聚光灯Cookie越远离灯光位置，它就会变得越大。 这是由于通过透视变换造成的。 因此，矩阵乘法会产生4D齐次坐标。 为了得到规则的2D坐标，我们必须将X and Y除以W。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kt">float4</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
<span class="n">uvCookie</span><span class="p">.</span><span class="n">xy</span> <span class="o">/=</span> <span class="n">uvCookie</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="n">attenuation</span> <span class="o">*=</span> <span class="nb">tex2Dbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>
</pre></table></code></div></div><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527012302994-353496315.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527012302994-353496315.png" alt="cookie衰减" width="100%" height="auto" loading="lazy"></a></div></div><p>上图实际上产生了两个光锥，一个向前一个向后。 后向圆锥通常在渲染区域之外结束，但这并不能保证。我们只需要前向锥，它对应于负的W坐标。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">attenuation</span> <span class="o">*=</span> <span class="nb">tex2Dbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>
<span class="n">attenuation</span> <span class="o">*=</span> <span class="n">uvCookie</span><span class="p">.</span><span class="n">w</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="距离衰减-distance-attenuation"><span class="me-2">距离衰减 Distance Attenuation</span><a href="#距离衰减-distance-attenuation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>聚光灯发出的光也会根据距离衰减。此衰减存储在查找纹理中，可通过 _LightTextureB0 使用该纹理。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">sampler2D</span> <span class="n">_LightTexture0</span><span class="p">,</span> <span class="n">_LightTextureB0</span><span class="p">;</span>
</pre></table></code></div></div><p>纹理被设计成必须使用光的距离的平方，并按光的范围进行缩放，作为UV进行采样。范围存储在 _LightPos的第四个分量中。采样得到的纹理应该使用哪个通道在不同的平台，由 _UNITY_ATTEN_CHANNEL 宏定义。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">lightVec</span><span class="p">);</span>
<span class="n">attenuation</span> <span class="o">*=</span> <span class="nb">tex2D</span>
<span class="p">(</span>
    <span class="n">_LightTextureB0</span><span class="p">,</span>
    <span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">lightVec</span><span class="p">,</span> <span class="n">lightVec</span><span class="p">)</span> <span class="o">*</span> <span class="n">_LightPos</span><span class="p">.</span><span class="n">w</span><span class="p">).</span><span class="n">rr</span>
<span class="p">).</span><span class="n">UNITY_ATTEN_CHANNEL</span><span class="p">;</span>
<span class="kt">float4</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</pre></table></code></div></div><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527085923716-1558484014.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527085923716-1558484014.png" alt="cookie 和 distance衰减" width="100%" height="auto" loading="lazy"></a></div></div><h3 id="shadows"><span class="me-2">Shadows</span><a href="#shadows" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>当聚光灯有阴影时，定义SHADOWS_DEPTH关键字。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">//在CreateLight中</span>
<span class="kt">float4</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
<span class="n">uvCookie</span><span class="p">.</span><span class="n">xy</span> <span class="o">/=</span> <span class="n">uvCookie</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="n">attenuation</span> <span class="o">*=</span> <span class="nb">tex2Dbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>

<span class="cp">#if defined(SHADOWS_DEPTH)
</span>    <span class="n">shadowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#endif
</span></pre></table></code></div></div><p>聚光灯和方向灯使用相同的变量来采样阴影贴图。在聚光灯的情况下，可以使用内置UnitySampleShadowmap来处理采样硬阴影或软阴影的细节。参数：阴影空间中的片元位置。unity_WorldToShadow_(4x4)_矩阵中第一个数组可以用来将世界空间转换为阴影空间。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">shadowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">UnitySampleShadowmap</span><span class="p">(</span>
    <span class="nb">mul</span><span class="p">(</span><span class="n">unity_WorldToShadow</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kt">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="p">);</span>
</pre></table></code></div></div><h3 id="点光源-point-lights"><span class="me-2">点光源 Point Lights</span><a href="#点光源-point-lights" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>点光源使用与聚光灯相同的光向量、方向和距离衰减。这样他们就可以共享代码.应该只在定义SPOT关键字时使用spotlight代码的其余部分。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="cp">#if defined(DIRECTIONAL) || defined(DIRECTIONAL_COOKIE)
</span>    <span class="c1">//...</span>
<span class="cp">#else
</span>    <span class="kt">float3</span> <span class="n">lightVec</span> <span class="o">=</span> <span class="n">_LightPos</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">worldPos</span><span class="p">;</span>
    <span class="n">light</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">lightVec</span><span class="p">);</span>

    <span class="n">attenuation</span> <span class="o">*=</span> <span class="nb">tex2D</span><span class="p">(</span>
        <span class="n">_LightTextureB0</span><span class="p">,</span>
        <span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">lightVec</span><span class="p">,</span> <span class="n">lightVec</span><span class="p">)</span> <span class="o">*</span> <span class="n">_LightPos</span><span class="p">.</span><span class="n">w</span><span class="p">).</span><span class="n">rr</span>
    <span class="p">).</span><span class="n">UNITY_ATTEN_CHANNEL</span><span class="p">;</span>

    <span class="cp">#if defined(SPOT)
</span>        <span class="kt">float4</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
        <span class="n">uvCookie</span><span class="p">.</span><span class="n">xy</span> <span class="o">/=</span> <span class="n">uvCookie</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
        <span class="n">attenuation</span> <span class="o">*=</span>
            <span class="nb">tex2Dbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>
        <span class="n">attenuation</span> <span class="o">*=</span> <span class="n">uvCookie</span><span class="p">.</span><span class="n">w</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cp">#if defined(SHADOWS_DEPTH)
</span>            <span class="n">shadowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">UnitySampleShadowmap</span><span class="p">(</span>
                <span class="nb">mul</span><span class="p">(</span><span class="n">unity_WorldToShadow</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kt">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">);</span>
        <span class="cp">#endif
</span>    <span class="cp">#endif
#endif
</span></pre></table></code></div></div><p>这已经足够让点光源工作了。它们被渲染成和聚光灯一样的效果，除了渲染范围使用的是球形而不是锥形。</p><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527085924576-1982519938.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527085924576-1982519938.png" alt="高亮" width="100%" height="auto" loading="lazy"></a></div></div><h3 id="shadows-1"><span class="me-2">Shadows</span><a href="#shadows-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>点光源的阴影存储在一个CubeMap。内置UnitySampleShadowmap可采样。参数：光的方向。一个从光到表面的向量。它是光的相反方向。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="cp">#if defined(SPOT)
</span><span class="c1">//...</span>
<span class="cp">#else
</span>    <span class="cp">#if defined(SHADOWS_CUBE)
</span>        <span class="n">shadowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">UnitySampleShadowmap</span><span class="p">(</span><span class="o">-</span><span class="n">lightVec</span><span class="p">);</span>
    <span class="cp">#endif
#endif
</span></pre></table></code></div></div><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527085925412-308331709.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527085925412-308331709.png" alt="点光源阴影" width="100%" height="auto" loading="lazy"></a></div></div><h3 id="cookies"><span class="me-2">Cookies</span><a href="#cookies" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Point light cookie也可以通过 _LightTexture0获得。需要的是一个cubeMap映射，而不是常规的纹理。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c1">//sampler2D _LightTexture0, _LightTextureB0;</span>
<span class="cp">#if defined(POINT_COOKIE)
</span>    <span class="n">samplerCUBE</span> <span class="n">_LightTexture0</span><span class="p">;</span>
<span class="cp">#else
</span>    <span class="n">sampler2D</span> <span class="n">_LightTexture0</span><span class="p">;</span>
<span class="cp">#endif
</span>
<span class="n">sampler2D</span> <span class="n">_LightTextureB0</span><span class="p">;</span>
<span class="kt">float4x4</span> <span class="n">unity_WorldToLight</span><span class="p">;</span>
</pre></table></code></div></div><p>要对cookie进行采样，请将片段的world-space转换为light-space，并使用光照空间对立方体映射进行采样。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="cp">#else
</span>    <span class="cp">#if defined(POINT_COOKIE)
</span>        <span class="kt">float3</span> <span class="n">uvCookie</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">unity_WorldToLight</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
        <span class="n">attenuation</span> <span class="o">*=</span> <span class="nb">texCUBEbias</span><span class="p">(</span><span class="n">_LightTexture0</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">uvCookie</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">)).</span><span class="n">w</span><span class="p">;</span>
    <span class="cp">#endif
</span>
    <span class="cp">#if defined(SHADOWS_CUBE)
</span>        <span class="n">shadowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="n">UnitySampleShadowmap</span><span class="p">(</span><span class="o">-</span><span class="n">lightVec</span><span class="p">);</span>
    <span class="cp">#endif
#endif
</span></pre></table></code></div></div><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin:1rem 0;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527085926193-2066682458.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender15/1692664-20200527085926193-2066682458.png" alt="点光源cookie" width="100%" height="auto" loading="lazy"></a></div></div><h3 id="skipping-shadows"><span class="me-2">Skipping Shadows</span><a href="#skipping-shadows" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>现在，我们可以使用自己的着色器渲染所有动态光源。 尽管我们目前并未对优化进行太多关注，但仍有一项潜在的大型优化<strong>值得考虑</strong>：<strong>最终超出阴影渐隐距离的片元将不会被阴影化</strong>。 但是现在仍在采样它们的阴影，这可能很昂贵。 我们可以通过基于阴影衰落因 子进行 _UNITY_BRANCH_分支来避免这种情况。 它接近1，那么我们可以完全跳过阴影衰减。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">shadowed</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float</span> <span class="n">shadowFadeDistance</span> <span class="o">=</span> <span class="n">UnityComputeShadowFadeDistance</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="n">viewZ</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">shadowFade</span> <span class="o">=</span> <span class="n">UnityComputeShadowFade</span><span class="p">(</span><span class="n">shadowFadeDistance</span><span class="p">);</span>
    <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="nb">saturate</span><span class="p">(</span><span class="n">shadowAttenuation</span> <span class="o">+</span> <span class="n">shadowFade</span><span class="p">);</span>
    <span class="n">UNITY_BRANCH</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">shadowFade</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>但是，即使用了 _UNITY_BRANCH_分支它本身也很昂贵。除了靠近阴影区域的边缘，所有碎片都落在阴影区域的内部或外部。 但这仅在GPU可以利用这一点的情况下才重要。 在这种情况下，使用HLSLSupport.cginc定义UNITY_FAST_COHERENT_DYNAMIC_BRANCHING宏。</p><div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="cp">#if defined(UNITY_FAST_COHERENT_DYNAMIC_BRANCHING)
</span>    <span class="n">UNITY_BRANCH</span>
    <span class="nf">if</span> <span class="p">(</span><span class="n">shadowFade</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif
</span></pre></table></code></div></div><p>即使这样，仅当阴影需要多个纹理样本时才值得使用。 <strong>对于柔和的聚光灯和点光源阴影，进一步使用用SHADOWS_SOFT关键字指示</strong>。 而方向光阴影始终只需要单个纹理，因此它性能很便宜。</p>\[射线对应的Z值 ={射线击中物体时的长度\over射线总长度}\]<div class="language-hlsl highlighter-rouge"><div class="code-header"> <span data-label-text="Hlsl"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="cp">#if defined(UNITY_FAST_COHERENT_DYNAMIC_BRANCHING) &amp;&amp; defined(SHADOWS_SOFT)
</span>    <span class="n">UNITY_BRANCH</span>
    <span class="nf">if</span> <span class="p">(</span><span class="n">shadowFade</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">shadowAttenuation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif
</span></pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/unity3d/">Unity3D</a>, <a href="/categories/shader/">Shader</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/shader/" class="post-tag no-text-decoration" >Shader</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Unity%20Deferred%20Lights-%E5%BB%B6%E8%BF%9F%E5%85%89%E7%85%A7(%E7%BF%BB%E8%AF%91%E5%8D%81%E4%BA%94)%20-%20%E4%BB%97%E5%89%91%E5%A4%A9%E6%B6%AF&url=www.damonc.top%2Fposts%2FUnity_Deferred_Lights%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Unity%20Deferred%20Lights-%E5%BB%B6%E8%BF%9F%E5%85%89%E7%85%A7(%E7%BF%BB%E8%AF%91%E5%8D%81%E4%BA%94)%20-%20%E4%BB%97%E5%89%91%E5%A4%A9%E6%B6%AF&u=www.damonc.top%2Fposts%2FUnity_Deferred_Lights%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=www.damonc.top%2Fposts%2FUnity_Deferred_Lights%2F&text=Unity%20Deferred%20Lights-%E5%BB%B6%E8%BF%9F%E5%85%89%E7%85%A7(%E7%BF%BB%E8%AF%91%E5%8D%81%E4%BA%94)%20-%20%E4%BB%97%E5%89%91%E5%A4%A9%E6%B6%AF" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/Unity_Multi_Light/">Unity 基础光照多光源采样(翻译五)</a><li class="text-truncate lh-lg"> <a href="/posts/Unity_Advance_Texture/">Unity 纹理高级用法(翻译六)</a><li class="text-truncate lh-lg"> <a href="/posts/Unity_Shadows/">Unity Shadow 阴影(翻译七)</a><li class="text-truncate lh-lg"> <a href="/posts/Unity_Reflection/">Unity Reflection 反射(翻译八)</a><li class="text-truncate lh-lg"> <a href="/posts/Unity_ShaderGUI_Extension_1/">Unity Shader GUI 扩展一(翻译九)</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/shader/">Shader</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai/">AI</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli-agent/">CLI Agent</a> <a class="post-tag btn btn-outline-primary" href="/tags/best-practices/">Best Practices</a> <a class="post-tag btn btn-outline-primary" href="/tags/architecture/">Architecture</a> <a class="post-tag btn btn-outline-primary" href="/tags/configuration/">Configuration</a> <a class="post-tag btn btn-outline-primary" href="/tags/context-engine/">Context Engine</a> <a class="post-tag btn btn-outline-primary" href="/tags/git-worktree/">git-worktree</a> <a class="post-tag btn btn-outline-primary" href="/tags/mcp/">MCP</a> <a class="post-tag btn btn-outline-primary" href="/tags/multi-agent/">Multi-agent</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/Unity_ShaderGUI_Extension_2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1515333600" data-df="ll" > Jan 7, 2018 </time><h4 class="pt-0 my-2">Unity Shader GUI 扩展二(翻译十)</h4><div class="text-muted"><p>本篇摘要: 把自身阴影烘焙进材质 增加细节纹理部分 支持更丰富的shader变体 一次编辑多个材质球 遮挡区域的Self-Shading 美术能够创作非常复杂丰富的表面纹理，它只是一个视错觉。为了增强表面纹理视觉真实感，引入Self-Shading。 如何增强呢？通常我们使用了法线来增强模型表面的凹凸层次感，法线带来的视觉增强是第一步，但是法线只适用于采样直接光照下...</p></div></div></a></article><article class="col"> <a href="/posts/Unity_ShaderGUI_Extension_1/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1515326400" data-df="ll" > Jan 7, 2018 </time><h4 class="pt-0 my-2">Unity Shader GUI 扩展一(翻译九)</h4><div class="text-muted"><p>选中当前材质后，若材质使用的Shader调用了GUI拓展，则会自动读取该Shader的所有属性。通过重实现OnGUI函数后，获取其参数地址就能读取。</p></div></div></a></article><article class="col"> <a href="/posts/Unity_Reflection/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1515240000" data-df="ll" > Jan 6, 2018 </time><h4 class="pt-0 my-2">Unity Reflection 反射(翻译八)</h4><div class="text-muted"><p>一块完美的镜子是不会发生漫反射，但现在我们自己的Shader包含的光照：环境光、漫反射、高光反射、纹理、阴影，结果看起来蛮好。但是当把Metallic设为1，Smoothness设位0.95，看起来很亮就很不自然了。从下图看尽管颜色是白色但整个表面都是黑色，只有一个很小的高亮点。这个亮点形成1是光源的入射，2朝向观察者的反射。</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/UNity_Shader_Fog/" class="btn btn-outline-primary" aria-label="Older" ><p>Unity Shader Fog(翻译十四)</p></a> <a href="/posts/Unity_Static_Lightting/" class="btn btn-outline-primary" aria-label="Newer" ><p>Unity 光照烘焙(翻译十六)</p></a></nav><section id="google-ads-bottom" class="mt-5 mb-4"><div class="container-fluid px-0"><div class="row g-3 justify-content-center"><div class="col-lg-6 d-none d-lg-block"><div class="google-ads-container-bottom"> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7166721253489246" data-ad-slot="7646545514" data-ad-format="rectangle" data-full-width-responsive="false"> </ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></div></div><div class="col-lg-6 d-none d-lg-block"><div class="google-ads-container-bottom"> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7166721253489246" data-ad-slot="7646545514" data-ad-format="rectangle" data-full-width-responsive="false"> </ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></div></div><div class="col-md-8 col-lg-12 d-none d-md-block d-lg-none"><div class="google-ads-container-bottom"> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7166721253489246" data-ad-slot="7646545514" data-ad-format="horizontal" data-full-width-responsive="true"> </ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></div></div><div class="col-12 d-md-none"><div class="google-ads-container-bottom"> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7166721253489246" data-ad-slot="7646545514" data-ad-format="auto" data-full-width-responsive="true"> </ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></div></div></div></div></section><style> #google-ads-bottom .google-ads-container-bottom { min-height: 250px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); } #google-ads-bottom .google-ads-container-bottom:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.15); } @media (max-width: 767.98px) { #google-ads-bottom .google-ads-container-bottom { min-height: 200px; margin: 0 1rem; } } @media (min-width: 768px) and (max-width: 991.98px) { #google-ads-bottom .google-ads-container-bottom { min-height: 280px; margin: 0 2rem; } } @media (min-width: 992px) { #google-ads-bottom .google-ads-container-bottom { min-height: 280px; max-width: 336px; margin: 0 auto; } }</style><div id="waline-container" class="mt-5 pt-4" style="border-top: 1px dashed #ccc; padding-top: 20px;"><div id="waline"></div></div><link rel="stylesheet" href="/assets/css/waline.css"> <script type="module"> window.WalinePrefix = "/pro"; import { init } from '/assets/js/dist/waline.min.js'; init({ el: '#waline', serverURL: 'https://comments.damonc.top', dark: 'html[data-mode="dark"]', emoji: [ '//unpkg.com/@waline/emojis@1.4.0/qq', '//unpkg.com/@waline/emojis@1.4.0/tw-emoji', '//unpkg.com/@waline/emojis@1.4.0/soul-emoji' ], reaction: true, pageview: false }); </script><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2026</time> <a href="https://github.com/damonc-top">仗剑天涯</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>The blog is powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/shader/">Shader</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai/">AI</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli-agent/">CLI Agent</a> <a class="post-tag btn btn-outline-primary" href="/tags/best-practices/">Best Practices</a> <a class="post-tag btn btn-outline-primary" href="/tags/architecture/">Architecture</a> <a class="post-tag btn btn-outline-primary" href="/tags/configuration/">Configuration</a> <a class="post-tag btn btn-outline-primary" href="/tags/context-engine/">Context Engine</a> <a class="post-tag btn btn-outline-primary" href="/tags/git-worktree/">git-worktree</a> <a class="post-tag btn btn-outline-primary" href="/tags/mcp/">MCP</a> <a class="post-tag btn btn-outline-primary" href="/tags/multi-agent/">Multi-agent</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
