<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="三平面映射(翻译二十七)" /><meta name="author" content="catlikecoding" /><meta property="og:locale" content="en" /><meta name="description" content="移除对 UV 和切线的依赖 支持通用曲面方法 使用平面投影 混合三种映射方式" /><meta property="og:description" content="移除对 UV 和切线的依赖 支持通用曲面方法 使用平面投影 混合三种映射方式" /><link rel="canonical" href="www.damonc.top/posts/triplanar-mapping/" /><meta property="og:url" content="www.damonc.top/posts/triplanar-mapping/" /><meta property="og:site_name" content="仗剑天涯" /><meta property="og:image" content="https://img.damonc.top/posts/2018/month1/catRender27/image_01.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-02-01T09:44:33+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://img.damonc.top/posts/2018/month1/catRender27/image_01.png" /><meta property="twitter:title" content="三平面映射(翻译二十七)" /><meta name="twitter:site" content="@elonmusk" /><meta name="twitter:creator" content="@catlikecoding" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"catlikecoding","url":"https://catlikecoding.com/unity/tutorials"},"dateModified":"2026-02-18T22:55:36+08:00","datePublished":"2018-02-01T09:44:33+08:00","description":"移除对 UV 和切线的依赖 支持通用曲面方法 使用平面投影 混合三种映射方式","headline":"三平面映射(翻译二十七)","image":{"lqip":"data:image/webp;base64,UklGRkQAAABXRUJQVlA4IDgAAABQAwCdASoUAAoAP3Ggxli0q6ejsAgCkC4JY2R5TsyXqR8jAAD+0L8ctkFJOW8Ua6CMN8fS1hcAAA==","url":"https://img.damonc.top/posts/2018/month1/catRender27/image_01.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"www.damonc.top/posts/triplanar-mapping/"},"url":"www.damonc.top/posts/triplanar-mapping/"}</script><meta name="fediverse:creator" content="@damonc@mastodon.social"><title>三平面映射(翻译二十七) | 仗剑天涯</title><link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="preconnect" href="https://fonts.loli.net" ><link rel="dns-prefetch" href="https://fonts.loli.net" ><link rel="preconnect" href="https://gstatic.loli.net" crossorigin><link rel="dns-prefetch" href="https://gstatic.loli.net" ><link rel="preconnect" href="https://fastly.jsdelivr.net" ><link rel="dns-prefetch" href="https://fastly.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script type="module" src="/assets/js/dist/theme.min.js"></script> <script> /* Apply sidebar collapsed state as early as possible to prevent flickering */ if (localStorage.getItem('sidebar-collapsed') === 'true') { document.documentElement.setAttribute('data-sidebar-collapsed', 'true'); } </script> <script defer src="https://fastly.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js"></script> <script type="module" defer src="/assets/js/dist/post.min.js"></script> <script src="/assets/js/data/mathjax.js"></script> <script async src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://fastly.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script> <script type="module"> window.WalinePrefix = "/pro"; import { pageviewCount } from '/assets/js/dist/waline.min.js'; pageviewCount({ serverURL: 'https://comments.damonc.top', update: true }); </script> <script type="module" defer src="/app.min.js?baseurl=&register=true" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"> <button type="button" id="sidebar-collapse-btn" class="btn" aria-label="Toggle Sidebar"> <i class="fas fa-bars-staggered"></i> </button><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="https://img.damonc.top/commons/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">仗剑天涯</a><p class="site-subtitle fst-italic mb-0">听说读写看做忘</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/damonc-top" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/elonmusk" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['damoncbl','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>三平面映射(翻译二十七)</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>三平面映射(翻译二十七)</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1517449473" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 1, 2018 </time> </span> <span> Updated <time data-ts="1771426536" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 18, 2026 </time> </span><div class="mt-3 mb-3"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_01.png" class="popup img-link preview-img blur"><img data-src="https://img.damonc.top/posts/2018/month1/catRender27/image_01.png" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/webp;base64,UklGRkQAAABXRUJQVlA4IDgAAABQAwCdASoUAAoAP3Ggxli0q6ejsAgCkC4JY2R5TsyXqR8jAAD+0L8ctkFJOW8Ua6CMN8fS1hcAAA=="></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://catlikecoding.com/unity/tutorials">catlikecoding</a> </em> </span><div> <span> <em class="waline-pageview-count" data-path="/posts/triplanar-mapping/"> <i class="fas fa-spinner fa-spin small"></i> </em> views </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="11495 words" > <em>63 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">三平面映射(翻译二十七)</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">三平面映射(翻译二十七)</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><ul><li>移除对 UV 和切线的依赖<li>支持通用曲面方法<li>使用平面投影<li>混合三种映射方式</ul><hr /><h2 id="1-无-uv-坐标的纹理化"><span class="me-2">1. 无 UV 坐标的纹理化</span><a href="#1-无-uv-坐标的纹理化" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>通常进行纹理映射的方法是使用网格中每个顶点存储的 UV 坐标。但这并不是唯一的方法。有时，根本没有可用的 UV 坐标。例如，在处理任意形状的程序化几何体时。在运行时创建地形或洞穴系统时，通常无法为适当的纹理展开生成 UV 坐标。在这种情况下，我们必须使用另一种方法将纹理映射到表面上。其中一种方法就是<strong>三平面映射 (Triplanar Mapping)</strong>。</p><p>到目前为止，我们一直假设 UV 坐标是可用的。我们的 <code class="language-plaintext highlighter-rouge">My Lighting Input</code> 和 <code class="language-plaintext highlighter-rouge">My Lighting</code> 着色器包含文件都依赖于它们。虽然我们可以创建不依赖于顶点 UV 的替代方案，但如果能让当前的文件在有无 UV 的情况下都能工作会更方便。这需要一些改动。</p><p>我们将保持当前的方法作为默认方案，但在定义了 <code class="language-plaintext highlighter-rouge">NO_DEFAULT_UV</code> 时切换到无 UV 模式。</p><h3 id="11-不使用默认-uv"><span class="me-2">1.1 不使用默认 UV</span><a href="#11-不使用默认-uv" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>当网格数据不包含 UV 时，我们就没有 UV 可以从顶点传递到片段程序。因此，让 <code class="language-plaintext highlighter-rouge">My Lighting Input</code> 中的 UV 插值器的存在取决于 <code class="language-plaintext highlighter-rouge">NO_DEFAULT_UV</code>。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">InterpolatorsVertex</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="err">#</span><span class="k">if</span> <span class="p">!</span><span class="nf">defined</span><span class="p">(</span><span class="n">NO_DEFAULT_UV</span><span class="p">)</span>
        <span class="n">float4</span> <span class="n">uv</span> <span class="p">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
    <span class="err">#</span><span class="n">endif</span>
    <span class="p">...</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">Interpolators</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="err">#</span><span class="k">if</span> <span class="p">!</span><span class="nf">defined</span><span class="p">(</span><span class="n">NO_DEFAULT_UV</span><span class="p">)</span>
        <span class="n">float4</span> <span class="n">uv</span> <span class="p">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
    <span class="err">#</span><span class="n">endif</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre></table></code></div></div><p>有多个函数假设插值器始终包含 UV，因此我们必须确保它们能继续工作和编译。我们将通过在插值器声明下方引入一个新的 <code class="language-plaintext highlighter-rouge">GetDefaultUV</code> 函数来实现这一点。当没有 UV 可用时，它将简单地返回零，否则返回常规 UV。</p><p>我们还将允许通过定义 <code class="language-plaintext highlighter-rouge">UV_FUNCTION</code> 来提供替代方法，以防万一。这类似于 <code class="language-plaintext highlighter-rouge">ALBEDO_FUNCTION</code>，但覆盖必须在包含 <code class="language-plaintext highlighter-rouge">My Lighting Input</code> 之前定义。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">float4</span> <span class="nf">GetDefaultUV</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">NO_DEFAULT_UV</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">float4</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
    <span class="err">#</span><span class="k">else</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
    <span class="err">#</span><span class="n">endif</span>
<span class="p">}</span>

<span class="cp">#if !defined(UV_FUNCTION)
</span>    <span class="err">#</span><span class="n">define</span> <span class="n">UV_FUNCTION</span> <span class="n">GetDefaultUV</span>
<span class="cp">#endif
</span></pre></table></code></div></div><p>现在我们可以将所有使用 <code class="language-plaintext highlighter-rouge">i.uv</code> 的地方更改为 <code class="language-plaintext highlighter-rouge">UV_FUNCTION(i)</code>。我只展示了 <code class="language-plaintext highlighter-rouge">GetDetailMask</code> 的更改，但它适用于所有 getter 函数。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kt">float</span> <span class="nf">GetDetailMask</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">#</span><span class="k">if</span> <span class="nf">defined</span> <span class="p">(</span><span class="n">_DETAIL_MASK</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_DetailMask</span><span class="p">,</span> <span class="nf">UV_FUNCTION</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">xy</span><span class="p">).</span><span class="n">a</span><span class="p">;</span>
    <span class="err">#</span><span class="k">else</span>
        <span class="k">return</span> <span class="m">1</span><span class="p">;</span>
    <span class="err">#</span><span class="n">endif</span>
<span class="p">}</span>
</pre></table></code></div></div><p>接下来是 <code class="language-plaintext highlighter-rouge">My Lighting</code>，我们必须确保在没有 UV 可用时跳过顶点程序中所有与 UV 相关的操作。这适用于纹理坐标变换，也适用于默认的顶点位移方法。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">InterpolatorsVertex</span> <span class="nf">MyVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="err">#</span><span class="k">if</span> <span class="p">!</span><span class="nf">defined</span><span class="p">(</span><span class="n">NO_DEFAULT_UV</span><span class="p">)</span>
        <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="p">=</span> <span class="nf">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
        <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span> <span class="p">=</span> <span class="nf">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_DetailTex</span><span class="p">);</span>

        <span class="err">#</span><span class="k">if</span> <span class="n">VERTEX_DISPLACEMENT</span>
            <span class="kt">float</span> <span class="n">displacement</span> <span class="p">=</span> <span class="nf">tex2Dlod</span><span class="p">(</span><span class="n">_DisplacementMap</span><span class="p">,</span> <span class="nf">float4</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">)).</span><span class="n">g</span><span class="p">;</span>
            <span class="n">displacement</span> <span class="p">=</span> <span class="p">(</span><span class="n">displacement</span> <span class="p">-</span> <span class="m">0.5</span><span class="p">)</span> <span class="p">*</span> <span class="n">_DisplacementStrength</span><span class="p">;</span>
            <span class="n">v</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
            <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">.</span><span class="n">xyz</span> <span class="p">+=</span> <span class="n">v</span><span class="p">.</span><span class="n">normal</span> <span class="p">*</span> <span class="n">displacement</span><span class="p">;</span>
        <span class="err">#</span><span class="n">endif</span>
    <span class="err">#</span><span class="n">endif</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>视差效果（Parallax effect）也依赖于默认 UV，因此在 UV 不可用时跳过它。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">ApplyParallax</span> <span class="p">(</span><span class="n">inout</span> <span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">_PARALLAX_MAP</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="nf">defined</span><span class="p">(</span><span class="n">NO_DEFAULT_UV</span><span class="p">)</span>
        <span class="p">...</span>
    <span class="err">#</span><span class="n">endif</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="12-收集表面属性"><span class="me-2">1.2 收集表面属性</span><a href="#12-收集表面属性" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>没有 UV，必须有另一种方法来确定用于光照的表面属性。为了使其尽可能通用，我们的包含文件不应该关心这些属性是如何获得的。我们只需要一种通用的方法来提供表面属性。我们可以使用类似于 Unity 表面着色器（Surface Shaders）的方法，依靠一个函数来设置所有表面属性。</p><p>创建一个新的 <code class="language-plaintext highlighter-rouge">MySurface.cginc</code> 包含文件。在其中定义一个 <code class="language-plaintext highlighter-rouge">SurfaceData</code> 结构体，包含光照所需的所有表面属性：反照率（albedo）、发射（emission）、法线（normal）、Alpha、金属度（metallic）、遮蔽（occlusion）和光滑度（smoothness）。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="cp">#if !defined(MY_SURFACE_INCLUDED)
#define MY_SURFACE_INCLUDED
</span>
<span class="k">struct</span> <span class="nc">SurfaceData</span> <span class="p">{</span>
    <span class="n">float3</span> <span class="n">albedo</span><span class="p">,</span> <span class="n">emission</span><span class="p">,</span> <span class="n">normal</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">metallic</span><span class="p">,</span> <span class="n">occlusion</span><span class="p">,</span> <span class="n">smoothness</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif
</span></pre></table></code></div></div><p>我们把它放在一个单独的文件中，这样其他代码就可以在包含任何其他文件之前使用它。但我们的文件也会依赖它，所以把它包含在 <code class="language-plaintext highlighter-rouge">My Lighting Input</code> 中。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="err">#</span><span class="n">include</span> <span class="s">"UnityPBSLighting.cginc"</span>
<span class="err">#</span><span class="n">include</span> <span class="s">"AutoLight.cginc"</span>
<span class="err">#</span><span class="n">include</span> <span class="s">"MySurface.cginc"</span>
</pre></table></code></div></div><p>在 <code class="language-plaintext highlighter-rouge">My Lighting</code> 中，在 <code class="language-plaintext highlighter-rouge">MyFragmentProgram</code> 的开头、<code class="language-plaintext highlighter-rouge">ApplyParallax</code> 之后和使用 Alpha 之前，使用默认函数设置一个新的 <code class="language-plaintext highlighter-rouge">SurfaceData surface</code> 变量。然后更改 Alpha 代码以依赖 <code class="language-plaintext highlighter-rouge">surface.alpha</code> 而不是调用 <code class="language-plaintext highlighter-rouge">GetAlpha</code>。同时移动 <code class="language-plaintext highlighter-rouge">InitializeFragmentNormal</code>，以便在配置表面之前处理法线向量。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="n">FragmentOutput</span> <span class="nf">MyFragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">UNITY_SETUP_INSTANCE_ID</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">LOD_FADE_CROSSFADE</span><span class="p">)</span>
        <span class="nf">UnityApplyDitherCrossFade</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">vpos</span><span class="p">);</span>
    <span class="err">#</span><span class="n">endif</span>

    <span class="nf">ApplyParallax</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

    <span class="nf">InitializeFragmentNormal</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

    <span class="n">SurfaceData</span> <span class="n">surface</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="nf">ALBEDO_FUNCTION</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">alpha</span> <span class="p">=</span> <span class="nf">GetAlpha</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">emission</span> <span class="p">=</span> <span class="nf">GetEmission</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">metallic</span> <span class="p">=</span> <span class="nf">GetMetallic</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">occlusion</span> <span class="p">=</span> <span class="nf">GetOcclusion</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">smoothness</span> <span class="p">=</span> <span class="nf">GetSmoothness</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

    <span class="kt">float</span> <span class="n">alpha</span> <span class="p">=</span> <span class="n">surface</span><span class="p">.</span><span class="n">alpha</span><span class="p">;</span>
    <span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">_RENDERING_CUTOUT</span><span class="p">)</span>
        <span class="nf">clip</span><span class="p">(</span><span class="n">alpha</span> <span class="p">-</span> <span class="n">_Cutoff</span><span class="p">);</span>
    <span class="err">#</span><span class="n">endif</span>
    
    <span class="c1">// InitializeFragmentNormal(i);</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>现在在确定片段颜色时，依赖 <code class="language-plaintext highlighter-rouge">surface</code> 而不是再次调用 getter 函数。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">float3</span> <span class="n">albedo</span> <span class="p">=</span> <span class="nf">DiffuseAndSpecularFromMetallic</span><span class="p">(</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">albedo</span><span class="p">,</span> <span class="n">surface</span><span class="p">.</span><span class="n">metallic</span><span class="p">,</span> <span class="n">specularTint</span><span class="p">,</span> <span class="n">oneMinusReflectivity</span>
<span class="p">);</span>
<span class="p">...</span>
<span class="n">float4</span> <span class="n">color</span> <span class="p">=</span> <span class="nf">UNITY_BRDF_PBS</span><span class="p">(</span>
    <span class="n">albedo</span><span class="p">,</span> <span class="n">specularTint</span><span class="p">,</span>
    <span class="n">oneMinusReflectivity</span><span class="p">,</span> <span class="n">surface</span><span class="p">.</span><span class="n">smoothness</span><span class="p">,</span>
    <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">viewDir</span><span class="p">,</span>
    <span class="nf">CreateLight</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nf">CreateIndirectLight</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">viewDir</span><span class="p">)</span>
<span class="p">);</span>
<span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="p">+=</span> <span class="n">surface</span><span class="p">.</span><span class="n">emission</span><span class="p">;</span>
</pre></table></code></div></div><p>以及在填充延迟渲染的 G-buffers 时：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="cp">#if defined(DEFERRED_PASS)
</span>    <span class="err">#</span><span class="k">if</span> <span class="p">!</span><span class="nf">defined</span><span class="p">(</span><span class="n">UNITY_HDR_ON</span><span class="p">)</span>
        <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="p">=</span> <span class="nf">exp2</span><span class="p">(-</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">);</span>
    <span class="err">#</span><span class="n">endif</span>
    <span class="n">output</span><span class="p">.</span><span class="n">gBuffer0</span><span class="p">.</span><span class="n">rgb</span> <span class="p">=</span> <span class="n">albedo</span><span class="p">;</span>
    <span class="n">output</span><span class="p">.</span><span class="n">gBuffer0</span><span class="p">.</span><span class="n">a</span> <span class="p">=</span> <span class="n">surface</span><span class="p">.</span><span class="n">occlusion</span><span class="p">;</span>
    <span class="n">output</span><span class="p">.</span><span class="n">gBuffer1</span><span class="p">.</span><span class="n">rgb</span> <span class="p">=</span> <span class="n">specularTint</span><span class="p">;</span>
    <span class="n">output</span><span class="p">.</span><span class="n">gBuffer1</span><span class="p">.</span><span class="n">a</span> <span class="p">=</span> <span class="n">surface</span><span class="p">.</span><span class="n">smoothness</span><span class="p">;</span>
    <span class="n">output</span><span class="p">.</span><span class="n">gBuffer2</span> <span class="p">=</span> <span class="nf">float4</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">*</span> <span class="m">0.5</span> <span class="p">+</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
    <span class="n">output</span><span class="p">.</span><span class="n">gBuffer3</span> <span class="p">=</span> <span class="n">color</span><span class="p">;</span>
    <span class="p">...</span>
<span class="cp">#endif
</span></pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">CreateIndirectLight</code> 函数也使用了 getter 函数，因此给它添加一个 <code class="language-plaintext highlighter-rouge">SurfaceData</code> 参数并改用该参数。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">UnityIndirect</span> <span class="nf">CreateIndirectLight</span> <span class="p">(</span>
    <span class="n">Interpolators</span> <span class="n">i</span><span class="p">,</span> <span class="n">float3</span> <span class="n">viewDir</span><span class="p">,</span> <span class="n">SurfaceData</span> <span class="n">surface</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">FORWARD_BASE_PASS</span><span class="p">)</span> <span class="p">||</span> <span class="nf">defined</span><span class="p">(</span><span class="n">DEFERRED_PASS</span><span class="p">)</span>
        <span class="p">...</span>
        <span class="n">float3</span> <span class="n">reflectionDir</span> <span class="p">=</span> <span class="nf">reflect</span><span class="p">(-</span><span class="n">viewDir</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
        <span class="n">Unity_GlossyEnvironmentData</span> <span class="n">envData</span><span class="p">;</span>
        <span class="n">envData</span><span class="p">.</span><span class="n">roughness</span> <span class="p">=</span> <span class="m">1</span> <span class="p">-</span> <span class="n">surface</span><span class="p">.</span><span class="n">smoothness</span><span class="p">;</span>
        <span class="p">...</span>
        <span class="kt">float</span> <span class="n">occlusion</span> <span class="p">=</span> <span class="n">surface</span><span class="p">.</span><span class="n">occlusion</span><span class="p">;</span>
        <span class="p">...</span>
    <span class="err">#</span><span class="n">endif</span>
    <span class="k">return</span> <span class="n">indirectLight</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>然后在 <code class="language-plaintext highlighter-rouge">MyFragmentProgram</code> 中为其调用添加 <code class="language-plaintext highlighter-rouge">surface</code> 作为参数。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nf">CreateLight</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nf">CreateIndirectLight</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">viewDir</span><span class="p">,</span> <span class="n">surface</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="13-定制表面"><span class="me-2">1.3 定制表面</span><a href="#13-定制表面" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>为了能够更改表面数据的获取方式，我们将再次允许定义自定义函数。这个函数需要输入才能工作。默认情况下，那是 UV 坐标，主 UV 和细节 UV 都打包在一个 <code class="language-plaintext highlighter-rouge">float4</code> 中。替代输入可以是位置和法线向量。在我们的 <code class="language-plaintext highlighter-rouge">Surface</code> 文件中添加一个包含所有这些输入的 <code class="language-plaintext highlighter-rouge">SurfaceParameters</code> 结构体。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">SurfaceData</span> <span class="p">{</span>
    <span class="n">float3</span> <span class="n">albedo</span><span class="p">,</span> <span class="n">emission</span><span class="p">,</span> <span class="n">normal</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">metallic</span><span class="p">,</span> <span class="n">occlusion</span><span class="p">,</span> <span class="n">smoothness</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">SurfaceParameters</span> <span class="p">{</span>
    <span class="n">float3</span> <span class="n">normal</span><span class="p">,</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">float4</span> <span class="n">uv</span><span class="p">;</span>
<span class="p">};</span>
</pre></table></code></div></div><p>回到 <code class="language-plaintext highlighter-rouge">My Lighting</code>，调整 <code class="language-plaintext highlighter-rouge">MyFragmentProgram</code>，使其在定义了 <code class="language-plaintext highlighter-rouge">SURFACE_FUNCTION</code> 时使用不同的方式设置表面数据。在这种情况下，用法线向量填充 <code class="language-plaintext highlighter-rouge">surface</code> 并将所有其他值设置为默认值。然后创建表面参数并调用自定义表面函数。它的参数是 <code class="language-plaintext highlighter-rouge">surface</code>（作为 <code class="language-plaintext highlighter-rouge">inout</code> 参数）和参数结构体。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="n">SurfaceData</span> <span class="n">surface</span><span class="p">;</span>
<span class="cp">#if defined(SURFACE_FUNCTION)
</span>    <span class="n">surface</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">emission</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">metallic</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">occlusion</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">smoothness</span> <span class="p">=</span> <span class="m">0.5</span><span class="p">;</span>

    <span class="n">SurfaceParameters</span> <span class="n">sp</span><span class="p">;</span>
    <span class="n">sp</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">;</span>
    <span class="n">sp</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">worldPos</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
    <span class="n">sp</span><span class="p">.</span><span class="n">uv</span> <span class="p">=</span> <span class="nf">UV_FUNCTION</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

    <span class="nf">SURFACE_FUNCTION</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
<span class="cp">#else
</span>    <span class="n">surface</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="nf">ALBEDO_FUNCTION</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">alpha</span> <span class="p">=</span> <span class="nf">GetAlpha</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">emission</span> <span class="p">=</span> <span class="nf">GetEmission</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">metallic</span> <span class="p">=</span> <span class="nf">GetMetallic</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">occlusion</span> <span class="p">=</span> <span class="nf">GetOcclusion</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">smoothness</span> <span class="p">=</span> <span class="nf">GetSmoothness</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="cp">#endif
</span></pre></table></code></div></div><p>由于 <code class="language-plaintext highlighter-rouge">SURFACE_FUNCTION</code> 可能会更改表面法线，之后将其赋回给 <code class="language-plaintext highlighter-rouge">i.normal</code>。这样我们就不需要更改所有使用 <code class="language-plaintext highlighter-rouge">i.normal</code> 的代码。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="cp">#if defined(SURFACE_FUNCTION)
</span>    <span class="p">...</span>
<span class="cp">#else
</span>    <span class="p">...</span>
<span class="cp">#endif
</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">surface</span><span class="p">.</span><span class="n">normal</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="14-无切线空间"><span class="me-2">1.4 无切线空间</span><a href="#14-无切线空间" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>请注意，与 Unity 的表面着色器方法不同，我们是在世界空间（而非切线空间）中使用法线向量。如果我们想在 <code class="language-plaintext highlighter-rouge">SURFACE_FUNCTION</code> 中使用切线空间法线映射，那么我们必须自己显式地执行此操作。我们还可以支持更多关于法线在调用 <code class="language-plaintext highlighter-rouge">SURFACE_FUNCTION</code> 前后应如何处理的配置选项，但我们在本教程中不会这样做。</p><p>我们要做的，是在不使用切线时能够关闭默认的切线空间法线映射方法。这样在不使用切线时可以节省工作。我们通过仅在默认法线映射或视差映射处于活动状态时打开切线空间来实现这一点。在 <code class="language-plaintext highlighter-rouge">My Lighting Input</code> 中用一个方便的 <code class="language-plaintext highlighter-rouge">REQUIRES_TANGENT_SPACE</code> 宏来表示。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="cp">#if defined(_NORMAL_MAP) || defined(_DETAIL_NORMAL_MAP) || defined(_PARALLAX_MAP)
</span>    <span class="err">#</span><span class="n">define</span> <span class="n">REQUIRES_TANGENT_SPACE</span> <span class="m">1</span>
    <span class="err">#</span><span class="n">define</span> <span class="n">TESSELLATION_TANGENT</span> <span class="m">1</span>
<span class="cp">#endif
#define TESSELLATION_UV1 1
#define TESSELLATION_UV2 1
</span></pre></table></code></div></div><p>现在我们只需在需要时包含切向和副法线向量插值器。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">InterpolatorsVertex</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="err">#</span><span class="k">if</span> <span class="n">REQUIRES_TANGENT_SPACE</span>
        <span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">BINORMAL_PER_FRAGMENT</span><span class="p">)</span>
            <span class="n">float4</span> <span class="n">tangent</span> <span class="p">:</span> <span class="n">TEXCOORD2</span><span class="p">;</span>
        <span class="err">#</span><span class="k">else</span>
            <span class="n">float3</span> <span class="n">tangent</span> <span class="p">:</span> <span class="n">TEXCOORD2</span><span class="p">;</span>
            <span class="n">float3</span> <span class="n">binormal</span> <span class="p">:</span> <span class="n">TEXCOORD3</span><span class="p">;</span>
        <span class="err">#</span><span class="n">endif</span>
    <span class="err">#</span><span class="n">endif</span>
    <span class="p">...</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">Interpolators</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="err">#</span><span class="k">if</span> <span class="n">REQUIRES_TANGENT_SPACE</span>
        <span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">BINORMAL_PER_FRAGMENT</span><span class="p">)</span>
            <span class="n">float4</span> <span class="n">tangent</span> <span class="p">:</span> <span class="n">TEXCOORD2</span><span class="p">;</span>
        <span class="err">#</span><span class="k">else</span>
            <span class="n">float3</span> <span class="n">tangent</span> <span class="p">:</span> <span class="n">TEXCOORD2</span><span class="p">;</span>
            <span class="n">float3</span> <span class="n">binormal</span> <span class="p">:</span> <span class="n">TEXCOORD3</span><span class="p">;</span>
        <span class="err">#</span><span class="n">endif</span>
    <span class="err">#</span><span class="n">endif</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre></table></code></div></div><p>在 <code class="language-plaintext highlighter-rouge">My Lighting</code> 中，我们可以跳过在 <code class="language-plaintext highlighter-rouge">MyVertexProgram</code> 中设置这些向量。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">InterpolatorsVertex</span> <span class="nf">MyVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="err">#</span><span class="k">if</span> <span class="n">REQUIRES_TANGENT_SPACE</span>
        <span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">BINORMAL_PER_FRAGMENT</span><span class="p">)</span>
            <span class="n">i</span><span class="p">.</span><span class="n">tangent</span> <span class="p">=</span> <span class="nf">float4</span><span class="p">(</span><span class="nf">UnityObjectToWorldDir</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">),</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
        <span class="err">#</span><span class="k">else</span>
            <span class="n">i</span><span class="p">.</span><span class="n">tangent</span> <span class="p">=</span> <span class="nf">UnityObjectToWorldDir</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
            <span class="n">i</span><span class="p">.</span><span class="n">binormal</span> <span class="p">=</span> <span class="nf">CreateBinormal</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
        <span class="err">#</span><span class="n">endif</span>
    <span class="err">#</span><span class="n">endif</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在没有切线空间的情况下，<code class="language-plaintext highlighter-rouge">InitializeFragmentNormal</code> 简化为仅对插值法线进行归一化。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">InitializeFragmentNormal</span><span class="p">(</span><span class="n">inout</span> <span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">#</span><span class="k">if</span> <span class="n">REQUIRES_TANGENT_SPACE</span>
        <span class="n">float3</span> <span class="n">tangentSpaceNormal</span> <span class="p">=</span> <span class="nf">GetTangentSpaceNormal</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">BINORMAL_PER_FRAGMENT</span><span class="p">)</span>
            <span class="n">float3</span> <span class="n">binormal</span> <span class="p">=</span> <span class="nf">CreateBinormal</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
        <span class="err">#</span><span class="k">else</span>
            <span class="n">float3</span> <span class="n">binormal</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">binormal</span><span class="p">;</span>
        <span class="err">#</span><span class="n">endif</span>
        
        <span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span>
            <span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="n">i</span><span class="p">.</span><span class="n">tangent</span> <span class="p">+</span>
            <span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">y</span> <span class="p">*</span> <span class="n">binormal</span> <span class="p">+</span>
            <span class="n">tangentSpaceNormal</span><span class="p">.</span><span class="n">z</span> <span class="p">*</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span>
        <span class="p">);</span>
    <span class="err">#</span><span class="k">else</span>
        <span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
    <span class="err">#</span><span class="n">endif</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="15-三平面着色器"><span class="me-2">1.5 三平面着色器</span><a href="#15-三平面着色器" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>我们所有的着色器仍然有效，但现在可以使用我们的包含文件而不使用切线空间，并使用替代表面数据。让我们创建一个新的着色器来利用这一点。首先，创建一个新的 <code class="language-plaintext highlighter-rouge">MyTriplanarMapping.cginc</code> 包含文件。让它定义 <code class="language-plaintext highlighter-rouge">NO_DEFAULT_UV</code>，然后包含 <code class="language-plaintext highlighter-rouge">Surface.cginc</code>。实际上，由于我们将使用 <code class="language-plaintext highlighter-rouge">My Lighting Input</code> 中已经定义的 <code class="language-plaintext highlighter-rouge">_MainTex</code> 属性，请改为包含该文件。然后创建一个带有 <code class="language-plaintext highlighter-rouge">inout SurfaceData surface</code> 参数和常规 <code class="language-plaintext highlighter-rouge">SurfaceParameters parameters</code> 参数的 <code class="language-plaintext highlighter-rouge">MyTriplanarSurfaceFunction</code>。目前，只需让它使用法线来设置反照率。将此函数定义为 <code class="language-plaintext highlighter-rouge">SURFACE_FUNCTION</code>。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="cp">#if !defined(MY_TRIPLANAR_MAPPING_INCLUDED)
#define MY_TRIPLANAR_MAPPING_INCLUDED
</span>
<span class="cp">#define NO_DEFAULT_UV
</span>
<span class="err">#</span><span class="n">include</span> <span class="s">"My Lighting Input.cginc"</span>

<span class="k">void</span> <span class="nf">MyTriPlanarSurfaceFunction</span> <span class="p">(</span>
    <span class="n">inout</span> <span class="n">SurfaceData</span> <span class="n">surface</span><span class="p">,</span> <span class="n">SurfaceParameters</span> <span class="n">parameters</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">.</span><span class="n">normal</span> <span class="p">*</span> <span class="m">0.5</span> <span class="p">+</span> <span class="m">0.5</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SURFACE_FUNCTION MyTriPlanarSurfaceFunction
</span>
<span class="cp">#endif
</span></pre></table></code></div></div><p>创建一个使用此包含文件而不是 <code class="language-plaintext highlighter-rouge">My Lighting Input</code> 的新着色器。我们将制作一个不带透明度的最小化着色器，支持通常的渲染管线，外加雾效和实例化。这是带有前向基础（forward base）和附加（additive）通道的着色器。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="n">Shader</span> <span class="s">"Custom/Triplanar Mapping"</span> <span class="p">{</span>
    <span class="n">Properties</span> <span class="p">{</span>
        <span class="nf">_MainTex</span> <span class="p">(</span><span class="s">"Albedo"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">}</span>
    <span class="n">SubShader</span> <span class="p">{</span>
        <span class="n">Pass</span> <span class="p">{</span>
            <span class="n">Tags</span> <span class="p">{</span> <span class="s">"LightMode"</span> <span class="p">=</span> <span class="s">"ForwardBase"</span> <span class="p">}</span>
            <span class="n">CGPROGRAM</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">target</span> <span class="m">3.0</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">multi_compile_fwdbase</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">multi_compile_fog</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">multi_compile_instancing</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">vertex</span> <span class="n">MyVertexProgram</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">fragment</span> <span class="n">MyFragmentProgram</span>
            <span class="err">#</span><span class="n">define</span> <span class="n">FORWARD_BASE_PASS</span>
            <span class="err">#</span><span class="n">include</span> <span class="s">"MyTriplanarMapping.cginc"</span>
            <span class="err">#</span><span class="n">include</span> <span class="s">"My Lighting.cginc"</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>
        <span class="n">Pass</span> <span class="p">{</span>
            <span class="n">Tags</span> <span class="p">{</span> <span class="s">"LightMode"</span> <span class="p">=</span> <span class="s">"ForwardAdd"</span> <span class="p">}</span>
            <span class="n">Blend</span> <span class="n">One</span> <span class="n">One</span>
            <span class="n">ZWrite</span> <span class="n">Off</span>
            <span class="n">CGPROGRAM</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">target</span> <span class="m">3.0</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">multi_compile_fwdadd_fullshadows</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">multi_compile_fog</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">vertex</span> <span class="n">MyVertexProgram</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">fragment</span> <span class="n">MyFragmentProgram</span>
            <span class="err">#</span><span class="n">include</span> <span class="s">"MyTriplanarMapping.cginc"</span>
            <span class="err">#</span><span class="n">include</span> <span class="s">"My Lighting.cginc"</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这里是延迟渲染（deferred）和阴影投射（shadow caster）通道。请注意，阴影通道不需要特殊处理，因为它不关心不透明几何体的表面属性。我们目前还没有添加光照贴图（lightmapping）支持，所以目前没有 meta 通道。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="n">Shader</span> <span class="s">"Custom/Triplanar Mapping"</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">SubShader</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="n">Pass</span> <span class="p">{</span>
            <span class="n">Tags</span> <span class="p">{</span> <span class="s">"LightMode"</span> <span class="p">=</span> <span class="s">"Deferred"</span> <span class="p">}</span>
            <span class="n">CGPROGRAM</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">target</span> <span class="m">3.0</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">exclude_renderers</span> <span class="n">nomrt</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">multi_compile_prepassfinal</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">multi_compile_instancing</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">vertex</span> <span class="n">MyVertexProgram</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">fragment</span> <span class="n">MyFragmentProgram</span>
            <span class="err">#</span><span class="n">define</span> <span class="n">DEFERRED_PASS</span>
            <span class="err">#</span><span class="n">include</span> <span class="s">"MyTriplanarMapping.cginc"</span>
            <span class="err">#</span><span class="n">include</span> <span class="s">"My Lighting.cginc"</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>
        <span class="n">Pass</span> <span class="p">{</span>
            <span class="n">Tags</span> <span class="p">{</span> <span class="s">"LightMode"</span> <span class="p">=</span> <span class="s">"ShadowCaster"</span> <span class="p">}</span>
            <span class="n">CGPROGRAM</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">target</span> <span class="m">3.0</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">multi_compile_shadowcaster</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">multi_compile_instancing</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">vertex</span> <span class="n">MyShadowVertexProgram</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">fragment</span> <span class="n">MyShadowFragmentProgram</span>
            <span class="err">#</span><span class="n">include</span> <span class="s">"My Shadows.cginc"</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>使用我们的新着色器创建一个材质并尝试一下。我使用了旧的测试纹理作为材质的主纹理，虽然此时它还没有被用到。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_02.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_02.png" alt="使用法线作为反照率的三平面映射材质" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_03.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_03.png" alt="使用法线作为反照率的三平面映射材质" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">使用法线作为反照率的三平面映射材质</figcaption></figure><h2 id="2-三平面纹理化"><span class="me-2">2. 三平面纹理化</span><a href="#2-三平面纹理化" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>当顶点 UV 坐标不可用时，我们如何执行纹理映射？我们必须使用替代方案。唯一可行的方法是使用世界位置——或者可能是对象空间位置——作为纹理映射的替代 UV 坐标来源。</p><h3 id="21-基于位置的纹理映射"><span class="me-2">2.1 基于位置的纹理映射</span><a href="#21-基于位置的纹理映射" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>片段的世界位置是一个 3D 向量，但常规纹理映射是在 2D 中完成的。所以我们必须选择两个维度作为 UV 坐标，这意味着我们将纹理映射到 3D 空间的一个平面上。最明显的选择是使用 XY 坐标。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">parameters</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_04.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_04.png" alt="使用位置 XY 作为 UV 坐标" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">使用位置 XY 作为 UV 坐标</figcaption></figure><blockquote><p><strong>使用 3D 纹理呢？</strong></p><p>这也是可能的，但 3D 纹理需要更多的存储空间，并且很难做得好看。</p></blockquote><p>结果是我们看到纹理沿 Z 轴投影。但这并不是唯一可能的方向。我们还可以通过改用 XZ 坐标来沿 Y 轴投影。这对应于纹理化地形时常用的平面纹理映射。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">parameters</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">xz</span><span class="p">);</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_05.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_05.png" alt="使用位置 XZ 作为 UV 坐标" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">使用位置 XZ 作为 UV 坐标</figcaption></figure><p>第三个选项是通过使用 YZ 坐标沿 X 投影。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">parameters</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">yz</span><span class="p">);</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_06.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_06.png" alt="使用位置 YZ 作为 UV 坐标" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">使用位置 YZ 作为 UV 坐标</figcaption></figure><p>但是当我们使用 YZ 时，纹理最终会旋转 90°。为了保持预期的方向，我们必须改用 ZY。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">parameters</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">zy</span><span class="p">);</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_07.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_07.png" alt="使用位置 ZY 作为 UV 坐标" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">使用位置 ZY 作为 UV 坐标</figcaption></figure><h3 id="22-合并所有三个映射"><span class="me-2">2.2 合并所有三个映射</span><a href="#22-合并所有三个映射" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>当表面主要与投影轴对齐时，单平面映射效果很好，但在不对齐时看起来很糟糕。当沿一个轴的效果不好时，沿另一个轴的效果可能会更好。因此，支持所有三个映射是有用的，这需要我们提供三对不同的 UV 坐标。</p><p>让我们保持确定这些 UV 坐标的逻辑独立。创建一个包含所有三个轴坐标对的 <code class="language-plaintext highlighter-rouge">TriplanarUV</code> 结构体。然后制作一个 <code class="language-plaintext highlighter-rouge">GetTriplanarUV</code> 函数，根据表面参数设置 UV。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">TriplanarUV</span> <span class="p">{</span>
    <span class="n">float2</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">TriplanarUV</span> <span class="nf">GetTriplanarUV</span> <span class="p">(</span><span class="n">SurfaceParameters</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">TriplanarUV</span> <span class="n">triUV</span><span class="p">;</span>
    <span class="n">float3</span> <span class="n">p</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
    <span class="n">triUV</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">zy</span><span class="p">;</span>
    <span class="n">triUV</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">xz</span><span class="p">;</span>
    <span class="n">triUV</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">xy</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">triUV</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在 <code class="language-plaintext highlighter-rouge">MyTriPlanarSurfaceFunction</code> 中使用此函数，并对所有三个投影进行采样。最终的反照率变为它们的平均值。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">MyTriPlanarSurfaceFunction</span> <span class="p">(</span>
    <span class="n">inout</span> <span class="n">SurfaceData</span> <span class="n">surface</span><span class="p">,</span> <span class="n">SurfaceParameters</span> <span class="n">parameters</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">TriplanarUV</span> <span class="n">triUV</span> <span class="p">=</span> <span class="nf">GetTriplanarUV</span><span class="p">(</span><span class="n">parameters</span><span class="p">);</span>
    <span class="n">float3</span> <span class="n">albedoX</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">x</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
    <span class="n">float3</span> <span class="n">albedoY</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
    <span class="n">float3</span> <span class="n">albedoZ</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">z</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="p">(</span><span class="n">albedoX</span> <span class="p">+</span> <span class="n">albedoY</span> <span class="p">+</span> <span class="n">albedoZ</span><span class="p">)</span> <span class="p">/</span> <span class="m">3</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_08.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_08.png" alt="对三个映射取平均值" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">对三个映射取平均值</figcaption></figure><h3 id="23-基于法线的混合"><span class="me-2">2.3 基于法线的混合</span><a href="#23-基于法线的混合" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>我们现在总是得到最好的投影，但也得到了另外两个。我们不能只使用最好的那个，因为在“最好”突然发生变化的地方会出现接缝。但我们可以做的是在它们之间进行平滑混合。</p><p>首选的映射是与表面方向最一致的映射，这由表面法线指示。因此，我们可以用法线来定义所有三个投影的权重。我们必须使用法线向量的绝对值，因为表面可能面向负方向。此外，权重的总和必须为 1，因此我们必须通过除以它们的总和来对它们进行归一化。创建一个新函数来计算这些权重。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">float3</span> <span class="nf">GetTriplanarWeights</span> <span class="p">(</span><span class="n">SurfaceParameters</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float3</span> <span class="n">triW</span> <span class="p">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">triW</span> <span class="p">/</span> <span class="p">(</span><span class="n">triW</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">triW</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">triW</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>现在我们可以通过权重来调制每个映射的贡献。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">MyTriPlanarSurfaceFunction</span> <span class="p">(</span>
    <span class="n">inout</span> <span class="n">SurfaceData</span> <span class="n">surface</span><span class="p">,</span> <span class="n">SurfaceParameters</span> <span class="n">parameters</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">float3</span> <span class="n">triW</span> <span class="p">=</span> <span class="nf">GetTriplanarWeights</span><span class="p">(</span><span class="n">parameters</span><span class="p">);</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="n">albedoX</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">albedoY</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">albedoZ</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_09.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_09.png" alt="混合三个映射" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">混合三个映射</figcaption></figure><h3 id="24-镜像映射"><span class="me-2">2.4 镜像映射</span><a href="#24-镜像映射" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>现在最可能的投影是最强的。在轴对齐的表面上，我们最终只能看到单个映射。轴对齐的立方体在所有面上看起来都不错，除了其中一半最终使用了镜像映射。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_10.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_10.png" alt="纹理在另一面被镜像了" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">纹理在另一面被镜像了</figcaption></figure><p>当纹理被镜像时，并不总是一个问题，但当使用上面带有数字的测试纹理时就很明显了。因此，让我们确保纹理永远不会被镜像。我们通过在适当的时候取负 U 坐标来实现。在 X 映射的情况下，即 <code class="language-plaintext highlighter-rouge">normal.x</code> 为负时。同样，对于 Y 投影，当 <code class="language-plaintext highlighter-rouge">normal.y</code> 为负时。对于 Z 则相反。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="n">TriplanarUV</span> <span class="nf">GetTriplanarUV</span> <span class="p">(</span><span class="n">SurfaceParameters</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">TriplanarUV</span> <span class="n">triUV</span><span class="p">;</span>
    <span class="n">float3</span> <span class="n">p</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
    <span class="n">triUV</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">zy</span><span class="p">;</span>
    <span class="n">triUV</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">xz</span><span class="p">;</span>
    <span class="n">triUV</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">xy</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">x</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">triUV</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="p">-</span><span class="n">triUV</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">y</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="p">-</span><span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">z</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">triUV</span><span class="p">.</span><span class="n">z</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="p">-</span><span class="n">triUV</span><span class="p">.</span><span class="n">z</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">triUV</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_11.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_11.png" alt="不再镜像" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">不再镜像</figcaption></figure><p>请注意，这会在每个映射维度为零的地方产生接缝，但这没关系，因为它们的权重在那里也是零。</p><h3 id="25-偏移映射"><span class="me-2">2.5 偏移映射</span><a href="#25-偏移映射" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>因为我们是在表面上投影三次相同的纹理，最终可能会出现明显的重复。这在球体上可能非常明显。你可以移动它，直到出现如下图所示的纹理对齐。从左到右，你可以看到序列 44, 45, 40, 44, 45, 40，即使完整序列是 40–45。在它下面你可以看到 34, 35, 30, 34, 35, 30。垂直方向你可以看到 44 和 45 重复。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_12.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_12.png" alt="对齐的映射" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">对齐的映射</figcaption></figure><p>我们可以通过偏移投影来消除此类重复。如果我们垂直移动 X 映射 1/2，那么我们就在 X 和 Z 之间消除了它们。同样，如果我们水平移动 X 映射 1/2，那么就在 Y 和 Z 之间消除了它们。X 和 Y 映射不对齐，所以我们不必担心它们。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">TriplanarUV</span> <span class="nf">GetTriplanarUV</span> <span class="p">(</span><span class="n">SurfaceParameters</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">triUV</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">y</span> <span class="p">+=</span> <span class="m">0.5</span><span class="p">;</span>
    <span class="n">triUV</span><span class="p">.</span><span class="n">z</span><span class="p">.</span><span class="n">x</span> <span class="p">+=</span> <span class="m">0.5</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">triUV</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_13.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_13.png" alt="偏移映射" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">偏移映射</figcaption></figure><p>我们使用 1/2 作为偏移量，因为那是最大值。在我们的测试纹理的情况下，它打破了数字序列，但保持了块对齐。如果我们使用的纹理具有三个而不是六个明显的条带，偏移 1/3 效果会更好。通常，三平面映射是针对地形纹理完成的，对于这些纹理，你不需要担心精确对齐。</p><h2 id="3-其他表面属性"><span class="me-2">3. 其他表面属性</span><a href="#3-其他表面属性" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>除了反照率，还有更多的表面属性可以存储在映射中。例如，对于我们的电路材料，我们还有金属度、遮蔽、光滑度和法线贴图。我们也来支持这些。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_14.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_14.png" alt="仅使用电路反照率贴图" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">仅使用电路反照率贴图</figcaption></figure><h3 id="31-mos-贴图"><span class="me-2">3.1 MOS 贴图</span><a href="#31-mos-贴图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>使用三平面映射时，我们使用三个不同的投影对贴图进行采样。这使着色器中的纹理采样量增加了三倍。为了保持可控性，我们应该旨在最小化每个投影的采样量。我们可以通过在一个贴图中存储多个表面属性来实现。我们的电路材料已经有这样一个贴图，在 R 通道存储金属度，在 G 通道存储遮蔽，在 A 通道存储光滑度。所以这就是一个金属度-遮蔽-光滑度贴图，简称 MOS 贴图。我们将在三平面着色器中依赖这样的 MOS 贴图，因此添加一个属性。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">Properties</span> <span class="p">{</span>
    <span class="nf">_MainTex</span> <span class="p">(</span><span class="s">"Albedo"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">[</span><span class="n">NoTilingOffset</span><span class="p">]</span> <span class="nf">_MOSMap</span> <span class="p">(</span><span class="s">"MOS"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_15.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_15.png" alt="带有电路 MOS 贴图的材质" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">带有电路 MOS 贴图的材质</figcaption></figure><p>为此贴图添加一个变量——因为它在 <code class="language-plaintext highlighter-rouge">My Lighting Input</code> 中没有定义——然后像反照率贴图一样对其采样三次。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="n">sampler2D</span> <span class="n">_MOSMap</span><span class="p">;</span>
<span class="p">...</span>
<span class="k">void</span> <span class="nf">MyTriPlanarSurfaceFunction</span> <span class="p">(</span>
    <span class="n">inout</span> <span class="n">SurfaceData</span> <span class="n">surface</span><span class="p">,</span> <span class="n">SurfaceParameters</span> <span class="n">parameters</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">TriplanarUV</span> <span class="n">triUV</span> <span class="p">=</span> <span class="nf">GetTriplanarUV</span><span class="p">(</span><span class="n">parameters</span><span class="p">);</span>
    <span class="n">float3</span> <span class="n">albedoX</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">x</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
    <span class="n">float3</span> <span class="n">albedoY</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
    <span class="n">float3</span> <span class="n">albedoZ</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">z</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
    <span class="n">float4</span> <span class="n">mosX</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MOSMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
    <span class="n">float4</span> <span class="n">mosY</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MOSMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="n">float4</span> <span class="n">mosZ</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MOSMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>使用三平面权重混合 MOS 数据，然后使用结果设置表面。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="n">albedoX</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">albedoY</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">albedoZ</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="n">float4</span> <span class="n">mos</span> <span class="p">=</span> <span class="n">mosX</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">mosY</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">mosZ</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="n">surface</span><span class="p">.</span><span class="n">metallic</span> <span class="p">=</span> <span class="n">mos</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="n">surface</span><span class="p">.</span><span class="n">occlusion</span> <span class="p">=</span> <span class="n">mos</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="n">surface</span><span class="p">.</span><span class="n">smoothness</span> <span class="p">=</span> <span class="n">mos</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_16.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_16.png" alt="使用电路 MOS 贴图" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">使用电路 MOS 贴图</figcaption></figure><h3 id="32-法线贴图"><span class="me-2">3.2 法线贴图</span><a href="#32-法线贴图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>也添加对法线贴图的支持。我们不能将其打包在另一个贴图中，因此它需要自己的属性。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">Properties</span> <span class="p">{</span>
    <span class="nf">_MainTex</span> <span class="p">(</span><span class="s">"Albedo"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">[</span><span class="n">NoTilingOffset</span><span class="p">]</span> <span class="nf">_MOSMap</span> <span class="p">(</span><span class="s">"MOS"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">[</span><span class="n">NoTilingOffset</span><span class="p">]</span> <span class="nf">_NormalMap</span> <span class="p">(</span><span class="s">"Normals"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_17.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_17.png" alt="带有电路法线贴图的材质" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">带有电路法线贴图的材质</figcaption></figure><p>采样该贴图三次，并为每个轴解包法线。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">MyTriPlanarSurfaceFunction</span> <span class="p">(</span>
    <span class="n">inout</span> <span class="n">SurfaceData</span> <span class="n">surface</span><span class="p">,</span> <span class="n">SurfaceParameters</span> <span class="n">parameters</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">float4</span> <span class="n">mosX</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MOSMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
    <span class="n">float4</span> <span class="n">mosY</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MOSMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="n">float4</span> <span class="n">mosZ</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MOSMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
    <span class="n">float3</span> <span class="n">tangentNormalX</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">x</span><span class="p">));</span>
    <span class="n">float3</span> <span class="n">tangentNormalY</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>
    <span class="n">float3</span> <span class="n">tangentNormalZ</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">z</span><span class="p">));</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>我们可以像混合其他数据一样混合法线，只需将其归一化即可。但是，这仅对世界空间法线有效，而我们采样的是切线空间法线。让我们首先假设可以直接将它们用作世界空间法线，看看会发生什么。为了更明显，再次将法线用于反照率。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">float3</span> <span class="n">tangentNormalX</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">x</span><span class="p">));</span>
<span class="n">float3</span> <span class="n">tangentNormalY</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>
<span class="n">float3</span> <span class="n">tangentNormalZ</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">z</span><span class="p">));</span>
<span class="n">float3</span> <span class="n">worldNormalX</span> <span class="p">=</span> <span class="n">tangentNormalX</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">worldNormalY</span> <span class="p">=</span> <span class="n">tangentNormalY</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">worldNormalZ</span> <span class="p">=</span> <span class="n">tangentNormalZ</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">triW</span> <span class="p">=</span> <span class="nf">GetTriplanarWeights</span><span class="p">(</span><span class="n">parameters</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">surface</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span>
    <span class="n">worldNormalX</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">worldNormalY</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">worldNormalZ</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">z</span>
<span class="p">);</span>
<span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="n">surface</span><span class="p">.</span><span class="n">normal</span> <span class="p">*</span> <span class="m">0.5</span> <span class="p">+</span> <span class="m">0.5</span><span class="p">;</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_18.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_18.png" alt="切线空间中的投影法线" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">切线空间中的投影法线</figcaption></figure><p>最终的法线向量是不正确的。切线空间法线在 Z 通道中存储了它们的局部上方向——远离表面——因此结果主要是蓝色的。这与 Z 投影的 XYZ 方向匹配，但不匹配其他两个。</p><p>在 Y 投影的情况下，上方向对应于 Y，而不是 Z。所以我们必须交换 Y 和 Z 以将切线空间转换为世界空间。同样，我们必须为 X 投影交换 X 和 Z。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">float3</span> <span class="n">tangentNormalX</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">x</span><span class="p">));</span>
<span class="n">float3</span> <span class="n">tangentNormalY</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>
<span class="n">float3</span> <span class="n">tangentNormalZ</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">z</span><span class="p">));</span>
<span class="n">float3</span> <span class="n">worldNormalX</span> <span class="p">=</span> <span class="n">tangentNormalX</span><span class="p">.</span><span class="n">zyx</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">worldNormalY</span> <span class="p">=</span> <span class="n">tangentNormalY</span><span class="p">.</span><span class="n">xzy</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">worldNormalZ</span> <span class="p">=</span> <span class="n">tangentNormalZ</span><span class="p">;</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_19.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_19.png" alt="世界空间中的投影法线" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">世界空间中的投影法线</figcaption></figure><p>因为我们取负了 X 坐标以防止镜像，所以我们也必须对切线空间法线向量执行此操作。否则它们仍然会被镜像。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">float3</span> <span class="n">tangentNormalX</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">x</span><span class="p">));</span>
<span class="n">float3</span> <span class="n">tangentNormalY</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>
<span class="n">float3</span> <span class="n">tangentNormalZ</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">z</span><span class="p">));</span>
<span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">x</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tangentNormalX</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="p">-</span><span class="n">tangentNormalX</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">y</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tangentNormalY</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="p">-</span><span class="n">tangentNormalY</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">z</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tangentNormalZ</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="p">-</span><span class="n">tangentNormalZ</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">float3</span> <span class="n">worldNormalX</span> <span class="p">=</span> <span class="n">tangentNormalX</span><span class="p">.</span><span class="n">zyx</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">worldNormalY</span> <span class="p">=</span> <span class="n">tangentNormalY</span><span class="p">.</span><span class="n">xzy</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">worldNormalZ</span> <span class="p">=</span> <span class="n">tangentNormalZ</span><span class="p">;</span>
</pre></table></code></div></div><p>在这些情况下，我们还必须翻转法线的上方向，因为它们指向内部。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">x</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tangentNormalX</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="p">-</span><span class="n">tangentNormalX</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">tangentNormalX</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="p">-</span><span class="n">tangentNormalX</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">y</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tangentNormalY</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="p">-</span><span class="n">tangentNormalY</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">tangentNormalY</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="p">-</span><span class="n">tangentNormalY</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">z</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tangentNormalZ</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="p">-</span><span class="n">tangentNormalZ</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="n">tangentNormalZ</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="p">-</span><span class="n">tangentNormalZ</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_20.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_20.png" alt="取消镜像并翻转的法线" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">取消镜像并翻转的法线</figcaption></figure><h3 id="33-与表面法线混合"><span class="me-2">3.3 与表面法线混合</span><a href="#33-与表面法线混合" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>虽然法线向量现在已与它们的投影正确对齐，但它们与实际表面法线没有关系。例如，球体最终得到的法线就像立方体一样。这并不直接明显，因为我们根据实际表面法线平滑地混合这些法线，但当我们调整混合时，情况会变得更糟。</p><p>通常，我们会依赖切线到世界变换矩阵来使法线适合几何体表面。但对于我们的三个投影，我们没有这样的矩阵。我们可以做的替代方案是在每个投影法线和表面法线之间进行混合，使用 <strong>whiteout blending</strong>。我们可以使用 <code class="language-plaintext highlighter-rouge">BlendNormals</code> 函数，但它也会对结果进行归一化。这有点过头了，考虑到我们混合了三个结果，然后再次对该结果进行归一化。所以让我们制作我们自己的变体，不进行每次投影的归一化。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">float3</span> <span class="nf">BlendTriplanarNormal</span> <span class="p">(</span><span class="n">float3</span> <span class="n">mappedNormal</span><span class="p">,</span> <span class="n">float3</span> <span class="n">surfaceNormal</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float3</span> <span class="n">n</span><span class="p">;</span>
    <span class="n">n</span><span class="p">.</span><span class="n">xy</span> <span class="p">=</span> <span class="n">mappedNormal</span><span class="p">.</span><span class="n">xy</span> <span class="p">+</span> <span class="n">surfaceNormal</span><span class="p">.</span><span class="n">xy</span><span class="p">;</span>
    <span class="n">n</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="n">mappedNormal</span><span class="p">.</span><span class="n">z</span> <span class="p">*</span> <span class="n">surfaceNormal</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p><strong>whiteout blending 是如何工作的？</strong></p><p>在《Rendering 6, Bumpiness》中有描述。</p></blockquote><p>Whiteout blending 假设 Z 指向上方。因此将表面法线转换为投影空间，在该切线空间中执行混合，然后将结果转换回世界空间。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">float3</span> <span class="n">worldNormalX</span> <span class="p">=</span> <span class="nf">BlendTriplanarNormal</span><span class="p">(</span><span class="n">tangentNormalX</span><span class="p">,</span> <span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">zyx</span><span class="p">).</span><span class="n">zyx</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">worldNormalY</span> <span class="p">=</span> <span class="nf">BlendTriplanarNormal</span><span class="p">(</span><span class="n">tangentNormalY</span><span class="p">,</span> <span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">xzy</span><span class="p">).</span><span class="n">xzy</span><span class="p">;</span>
<span class="n">float3</span> <span class="n">worldNormalZ</span> <span class="p">=</span> <span class="nf">BlendTriplanarNormal</span><span class="p">(</span><span class="n">tangentNormalZ</span><span class="p">,</span> <span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_21.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_21.png" alt="不正确的法线混合" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">不正确的法线混合</figcaption></figure><p>对于面向负方向的表面，这会出错，因为那样我们最终会乘以两个负 Z 值，从而翻转最终 Z 的符号。我们可以通过使用其中一个 Z 值的绝对值来解决此问题。但这相当于一开始就不取负采样的 Z 组件，因此我们可以直接移除那段代码。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">x</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tangentNormalX</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="p">-</span><span class="n">tangentNormalX</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="c1">// tangentNormalX.z = -tangentNormalX.z;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">y</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tangentNormalY</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="p">-</span><span class="n">tangentNormalY</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="c1">// tangentNormalY.z = -tangentNormalY.z;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">z</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tangentNormalZ</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="p">-</span><span class="n">tangentNormalZ</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// else {</span>
<span class="c1">//     tangentNormalZ.z = -tangentNormalZ.z;</span>
<span class="c1">// }</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_22.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_22.png" alt="正确的法线混合" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">正确的法线混合</figcaption></figure><p>生成的法线向量现在偏向于原始表面法线。虽然这并不完美，但通常足够了。你可以更进一步，完全放弃采样的 Z 组件，仅使用原始 Z 组件。这被称为 UDN 混合，在使用 DXT5nm 压缩时更便宜，因为不需要重建 Z 组件，但它会降低非对齐表面的法线强度。</p><p>法线贴图功能正常后，恢复原始反照率，这样我们就可以看到完整的电路材料。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="c1">// surface.albedo = surface.normal * 0.5 + 0.5;</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_23.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_23.png" alt="使用所有电路贴图" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">使用所有电路贴图</figcaption></figure><h3 id="34-缩放贴图"><span class="me-2">3.4 缩放贴图</span><a href="#34-缩放贴图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>最后，让我们能够缩放贴图。通常，这是通过单个纹理的平铺和偏移值完成的，但这对于三平面映射没有太大意义。偏移量不太有用，非均匀缩放也是。因此，改用单个缩放属性。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">Properties</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="nf">_MainTex</span> <span class="p">(</span><span class="s">"Albedo"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="nf">_MOSMap</span> <span class="p">(</span><span class="s">"MOS"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="nf">_NormalMap</span> <span class="p">(</span><span class="s">"Normals"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    
    <span class="nf">_MapScale</span> <span class="p">(</span><span class="s">"Map Scale"</span><span class="p">,</span> <span class="n">Float</span><span class="p">)</span> <span class="p">=</span> <span class="m">1</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_24.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_24.png" alt="带有贴图缩放的材质" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">带有贴图缩放的材质</figcaption></figure><p>添加所需的贴图缩放变量，并在确定 UV 坐标时使用它来缩放位置。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kt">float</span> <span class="n">_MapScale</span><span class="p">;</span>
<span class="k">struct</span> <span class="nc">TriplanarUV</span> <span class="p">{</span>
    <span class="n">float2</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">TriplanarUV</span> <span class="nf">GetTriplanarUV</span> <span class="p">(</span><span class="n">SurfaceParameters</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">TriplanarUV</span> <span class="n">triUV</span><span class="p">;</span>
    <span class="n">float3</span> <span class="n">p</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">.</span><span class="n">position</span> <span class="p">*</span> <span class="n">_MapScale</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_25.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_25.png" alt="使用双倍贴图缩放" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">使用双倍贴图缩放</figcaption></figure><h2 id="4-调整混合权重"><span class="me-2">4. 调整混合权重</span><a href="#4-调整混合权重" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>最终的表面数据是通过使用原始表面法线在三个映射之间进行混合找到的。到目前为止，我们一直直接用法线，仅取其绝对值并对结果进行归一化，使权重的总和为 1。这是最直接的方法，但也可以通过各种方式微调权重。</p><h3 id="41-混合偏移"><span class="me-2">4.1 混合偏移</span><a href="#41-混合偏移" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>更改权重计算的第一种方法是引入偏移（offset）。如果我们从所有权重中减去相同的量，那么较小的权重比大的权重受到的影响更大，这会改变它们的相对重要性。它们甚至可能变成负值。添加一个混合偏移属性来实现这一点。</p><p>我们必须确保并非所有权重都变成负值，因此最大偏移量应小于最大可能的最小权重，即当法线向量的所有三个分量相等时。那是 $\sqrt{1/3}$，约为 0.577，但我们就用 0.5 作为最大值，0.25 作为默认值。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nf">_MapScale</span> <span class="p">(</span><span class="s">"Map Scale"</span><span class="p">,</span> <span class="n">Float</span><span class="p">)</span> <span class="p">=</span> <span class="m">1</span>
<span class="nf">_BlendOffset</span> <span class="p">(</span><span class="s">"Blend Offset"</span><span class="p">,</span> <span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0.5</span><span class="p">))</span> <span class="p">=</span> <span class="m">0.25</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_26.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_26.png" alt="带有混合偏移的材质" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">带有混合偏移的材质</figcaption></figure><p>在对权重进行归一化之前减去偏移量，看看效果如何。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kt">float</span> <span class="n">_BlendOffset</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">float3</span> <span class="nf">GetTriplanarWeights</span> <span class="p">(</span><span class="n">SurfaceParameters</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float3</span> <span class="n">triW</span> <span class="p">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
    <span class="n">triW</span> <span class="p">=</span> <span class="n">triW</span> <span class="p">-</span> <span class="n">_BlendOffset</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">triW</span> <span class="p">/</span> <span class="p">(</span><span class="n">triW</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">triW</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">triW</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_27.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_27.png" alt="不正确的偏移用法" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">不正确的偏移用法</figcaption></figure><p>当混合权重保持正值时看起来不错，但负权重最终会从最终数据中减去。为了防止这种情况，在归一化之前对权重进行饱和处理（clamp）。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">triW</span> <span class="p">=</span> <span class="nf">saturate</span><span class="p">(</span><span class="n">triW</span> <span class="p">-</span> <span class="n">_BlendOffset</span><span class="p">);</span>
</pre></table></code></div></div><p>结果是偏移量越高，混合区域越小。为了更清楚地看到混合如何变化，将权重用于反照率。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">MyTriPlanarSurfaceFunction</span> <span class="p">(</span>
    <span class="n">inout</span> <span class="n">SurfaceData</span> <span class="n">surface</span><span class="p">,</span> <span class="n">SurfaceParameters</span> <span class="n">parameters</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="n">triW</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_28.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_28.png" alt="调整偏移量" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">调整偏移量</figcaption></figure><h3 id="42-混合指数"><span class="me-2">4.2 混合指数</span><a href="#42-混合指数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>另一种缩小混合区域的方法是通过幂运算（exponentiation），在归一化之前将权重提高到大于 1 的某个幂次。这类似于偏移，但是非线性的。为此添加一个着色器属性，使用任意最大值 8 和默认值 2。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nf">_BlendOffset</span> <span class="p">(</span><span class="s">"Blend Offset"</span><span class="p">,</span> <span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0.5</span><span class="p">))</span> <span class="p">=</span> <span class="m">0.25</span>
<span class="nf">_BlendExponent</span> <span class="p">(</span><span class="s">"Blend Exponent"</span><span class="p">,</span> <span class="nf">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">8</span><span class="p">))</span> <span class="p">=</span> <span class="m">2</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_29.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_29.png" alt="带有混合指数的材质" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">带有混合指数的材质</figcaption></figure><p>使用 <code class="language-plaintext highlighter-rouge">pow</code> 函数在偏移后应用指数。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kt">float</span> <span class="n">_BlendOffset</span><span class="p">,</span> <span class="n">_BlendExponent</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">float3</span> <span class="nf">GetTriplanarWeights</span> <span class="p">(</span><span class="n">SurfaceParameters</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float3</span> <span class="n">triW</span> <span class="p">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
    <span class="n">triW</span> <span class="p">=</span> <span class="nf">saturate</span><span class="p">(</span><span class="n">triW</span> <span class="p">-</span> <span class="n">_BlendOffset</span><span class="p">);</span>
    <span class="n">triW</span> <span class="p">=</span> <span class="nf">pow</span><span class="p">(</span><span class="n">triW</span><span class="p">,</span> <span class="n">_BlendExponent</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">triW</span> <span class="p">/</span> <span class="p">(</span><span class="n">triW</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">triW</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">triW</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_30.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_30.png" alt="调整指数" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">调整指数</figcaption></figure><p>你最终可能会同时使用这两种方法来调整混合权重。如果你定下最终指数为 2、4 或 8，则可以硬编码几次乘法而不是依赖 <code class="language-plaintext highlighter-rouge">pow</code>。</p><h3 id="43-基于高度的混合"><span class="me-2">4.3 基于高度的混合</span><a href="#43-基于高度的混合" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>除了依靠原始表面法线，我们还可以让表面数据影响混合。如果表面数据包含高度，那么可以将其计入权重。我们的 MOS 贴图仍然有一个未使用的通道，因此可以将它们转换为 MOHS 贴图，包含金属度、遮蔽、高度和光滑度数据。这里是电路材料的这样一张图。它与 MOS 图相同，但在蓝色通道中包含高度数据。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_31.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_31.png" alt="电路 MOHS 贴图" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">电路 MOHS 贴图</figcaption></figure><p>将我们的 MOS 属性重命名为 MOHS 并分配新纹理。确保其 sRGB 导入复选框已禁用。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="nf">_MainTex</span> <span class="p">(</span><span class="s">"Albedo"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="nf">_MOHSMap</span> <span class="p">(</span><span class="s">"MOHS"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="nf">_NormalMap</span> <span class="p">(</span><span class="s">"Normals"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_32.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_32.png" alt="现在带有 MOHS 贴图的材质" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">现在带有 MOHS 贴图的材质</figcaption></figure><p>同时也重命名变量。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="n">sampler2D</span> <span class="n">_MOHSMap</span><span class="p">;</span>
<span class="p">...</span>
<span class="k">void</span> <span class="nf">MyTriPlanarSurfaceFunction</span> <span class="p">(</span>
    <span class="n">inout</span> <span class="n">SurfaceData</span> <span class="n">surface</span><span class="p">,</span> <span class="n">SurfaceParameters</span> <span class="n">parameters</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">float4</span> <span class="n">mohsX</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MOHSMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
    <span class="n">float4</span> <span class="n">mohsY</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MOHSMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="n">float4</span> <span class="n">mohsZ</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MOHSMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="n">float4</span> <span class="n">mohs</span> <span class="p">=</span> <span class="n">mohsX</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">mohsY</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">mohsZ</span> <span class="p">*</span> <span class="n">triW</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">metallic</span> <span class="p">=</span> <span class="n">mohs</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">occlusion</span> <span class="p">=</span> <span class="n">mohs</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">smoothness</span> <span class="p">=</span> <span class="n">mohs</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>给 <code class="language-plaintext highlighter-rouge">GetTriplanarWeights</code> 添加三个高度值的参数。让我们首先尝试直接使用高度，在幂运算之前替换法线向量。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">float3</span> <span class="nf">GetTriplanarWeights</span> <span class="p">(</span>
    <span class="n">SurfaceParameters</span> <span class="n">parameters</span><span class="p">,</span> <span class="kt">float</span> <span class="n">heightX</span><span class="p">,</span> <span class="kt">float</span> <span class="n">heightY</span><span class="p">,</span> <span class="kt">float</span> <span class="n">heightZ</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">float3</span> <span class="n">triW</span> <span class="p">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
    <span class="n">triW</span> <span class="p">=</span> <span class="nf">saturate</span><span class="p">(</span><span class="n">triW</span> <span class="p">-</span> <span class="n">_BlendOffset</span><span class="p">);</span>
    <span class="n">triW</span> <span class="p">=</span> <span class="nf">float3</span><span class="p">(</span><span class="n">heightX</span><span class="p">,</span> <span class="n">heightY</span><span class="p">,</span> <span class="n">heightZ</span><span class="p">);</span>
    <span class="n">triW</span> <span class="p">=</span> <span class="nf">pow</span><span class="p">(</span><span class="n">triW</span><span class="p">,</span> <span class="n">_BlendExponent</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">triW</span> <span class="p">/</span> <span class="p">(</span><span class="n">triW</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">triW</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">triW</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>然后在调用函数时添加高度作为参数。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">float3</span> <span class="n">triW</span> <span class="p">=</span> <span class="nf">GetTriplanarWeights</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">mohsX</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">mohsY</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">mohsZ</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_33.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_33.png" alt="仅基于高度的混合" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">仅基于高度的混合</figcaption></figure><p>仅使用高度并不能给我们有用的结果，但可以清楚地看到金色电路条最高，因此主导了混合。现在将高度与它们各自的权重相乘。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">triW</span> <span class="p">*=</span> <span class="nf">float3</span><span class="p">(</span><span class="n">heightX</span><span class="p">,</span> <span class="n">heightY</span><span class="p">,</span> <span class="n">heightZ</span><span class="p">);</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_34.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_34.png" alt="与高度相乘" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">与高度相乘</figcaption></figure><p>这看起来好多了，但高度的影响仍然非常强。调节这一点很有用，因此在着色器中添加“混合高度强度（Blend Height Strength）”属性。在最大强度下，它可能会完全消除某些权重，这不应该发生。因此将强度的范围限制在 0–0.99，默认值为 0.5。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nf">_BlendOffset</span> <span class="p">(</span><span class="s">"Blend Offset"</span><span class="p">,</span> <span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0.5</span><span class="p">))</span> <span class="p">=</span> <span class="m">0.25</span>
<span class="nf">_BlendExponent</span> <span class="p">(</span><span class="s">"Blend Exponent"</span><span class="p">,</span> <span class="nf">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">8</span><span class="p">))</span> <span class="p">=</span> <span class="m">2</span>
<span class="nf">_BlendHeightStrength</span> <span class="p">(</span><span class="s">"Blend Height Strength"</span><span class="p">,</span> <span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0.99</span><span class="p">))</span> <span class="p">=</span> <span class="m">0.5</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_35.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_35.png" alt="带有混合高度强度的材质" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">带有混合高度强度的材质</figcaption></figure><p>通过在 1 和高度之间进行插值来应用强度，使用强度作为插值因子。然后将权重与该结果相乘。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kt">float</span> <span class="n">_BlendOffset</span><span class="p">,</span> <span class="n">_BlendExponent</span><span class="p">,</span> <span class="n">_BlendHeightStrength</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">float3</span> <span class="nf">GetTriplanarWeights</span> <span class="p">(</span>
    <span class="n">SurfaceParameters</span> <span class="n">parameters</span><span class="p">,</span> <span class="kt">float</span> <span class="n">heightX</span><span class="p">,</span> <span class="kt">float</span> <span class="n">heightY</span><span class="p">,</span> <span class="kt">float</span> <span class="n">heightZ</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">float3</span> <span class="n">triW</span> <span class="p">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
    <span class="n">triW</span> <span class="p">=</span> <span class="nf">saturate</span><span class="p">(</span><span class="n">triW</span> <span class="p">-</span> <span class="n">_BlendOffset</span><span class="p">);</span>
    <span class="n">triW</span> <span class="p">*=</span> <span class="nf">lerp</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="nf">float3</span><span class="p">(</span><span class="n">heightX</span><span class="p">,</span> <span class="n">heightY</span><span class="p">,</span> <span class="n">heightZ</span><span class="p">),</span> <span class="n">_BlendHeightStrength</span><span class="p">);</span>
    <span class="n">triW</span> <span class="p">=</span> <span class="nf">pow</span><span class="p">(</span><span class="n">triW</span><span class="p">,</span> <span class="n">_BlendExponent</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">triW</span> <span class="p">/</span> <span class="p">(</span><span class="n">triW</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">triW</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">triW</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>使用高度与偏移量结合效果最好，可以限制它们的影响范围。除此之外，更高的指数会使效果更明显。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_36.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_36.png" alt="调整高度强度" width="100%" height="auto" loading="lazy"></a></div><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_37.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_37.png" alt="调整高度强度" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">调整高度强度</figcaption></figure><p>最后，恢复反照率以查看完整材质上的混合设置效果。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="c1">// surface.albedo = triW;</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_38.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_38.png" alt="所有混合设置在最小 vs 最大时的对比" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">所有混合设置在最小 vs 最大时的对比</figcaption></figure><h2 id="5-自定义着色器-gui"><span class="me-2">5. 自定义着色器 GUI</span><a href="#5-自定义着色器-gui" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>我们没有使用为其他着色器创建的着色器 GUI 类，因为它不适用于我们的三平面着色器。它依赖于我们的三平面着色器所没有的属性。虽然我们可以让 <code class="language-plaintext highlighter-rouge">MyLightingShaderGUI</code> 也支持这个着色器，但最好还是保持简单并创建一个新类。</p><h3 id="51-基类"><span class="me-2">5.1 基类</span><a href="#51-基类" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>与其复制我们可以重用的 <code class="language-plaintext highlighter-rouge">MyLightingShaderGUI</code> 的基本功能，不如创建一个共同的基类供两个 GUI 扩展。让我们将其命名为 <code class="language-plaintext highlighter-rouge">MyBaseShaderGUI</code>。将 <code class="language-plaintext highlighter-rouge">MyLightingShaderGUI</code> 中的所有通用代码放入其中，省略其余部分。让所有应该直接提供给其子类的内容都设为 <code class="language-plaintext highlighter-rouge">protected</code>。这允许类本身及其子类访问，但其他地方不能访问。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="c1">//using UnityEngine.Rendering;</span>
<span class="k">using</span> <span class="nn">UnityEditor</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">MyBaseShaderGUI</span> <span class="p">:</span> <span class="n">ShaderGUI</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">GUIContent</span> <span class="n">staticLabel</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GUIContent</span><span class="p">();</span>
    <span class="k">protected</span> <span class="n">Material</span> <span class="n">target</span><span class="p">;</span>
    <span class="k">protected</span> <span class="n">MaterialEditor</span> <span class="n">editor</span><span class="p">;</span>
    <span class="n">MaterialProperty</span><span class="p">[]</span> <span class="n">properties</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnGUI</span> <span class="p">(</span>
        <span class="n">MaterialEditor</span> <span class="n">editor</span><span class="p">,</span> <span class="n">MaterialProperty</span><span class="p">[]</span> <span class="n">properties</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">target</span> <span class="p">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">target</span> <span class="k">as</span> <span class="n">Material</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">editor</span> <span class="p">=</span> <span class="n">editor</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">properties</span> <span class="p">=</span> <span class="n">properties</span><span class="p">;</span>
        <span class="c1">// DoRenderingMode();</span>
        <span class="c1">// ...</span>
        <span class="c1">// DoAdvanced();</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="n">MaterialProperty</span> <span class="nf">FindProperty</span> <span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">FindProperty</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">properties</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="n">GUIContent</span> <span class="nf">MakeLabel</span> <span class="p">(</span><span class="kt">string</span> <span class="n">text</span><span class="p">,</span> <span class="kt">string</span> <span class="n">tooltip</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="n">GUIContent</span> <span class="nf">MakeLabel</span> <span class="p">(</span>
        <span class="n">MaterialProperty</span> <span class="n">property</span><span class="p">,</span> <span class="kt">string</span> <span class="n">tooltip</span> <span class="p">=</span> <span class="k">null</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">void</span> <span class="nf">SetKeyword</span> <span class="p">(</span><span class="kt">string</span> <span class="n">keyword</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="kt">bool</span> <span class="nf">IsKeywordEnabled</span> <span class="p">(</span><span class="kt">string</span> <span class="n">keyword</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">target</span><span class="p">.</span><span class="nf">IsKeywordEnabled</span><span class="p">(</span><span class="n">keyword</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">void</span> <span class="nf">RecordAction</span> <span class="p">(</span><span class="kt">string</span> <span class="n">label</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">editor</span><span class="p">.</span><span class="nf">RegisterPropertyChangeUndo</span><span class="p">(</span><span class="n">label</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>让 <code class="language-plaintext highlighter-rouge">MyLightingShaderGUI</code> 继承 <code class="language-plaintext highlighter-rouge">MyBaseShaderGUI</code> 而不是直接继承 <code class="language-plaintext highlighter-rouge">ShaderGUI</code>。然后从中删除现在属于其基类一部分的所有代码。不再在 <code class="language-plaintext highlighter-rouge">OnGUI</code> 中自己设置变量，而是通过调用 <code class="language-plaintext highlighter-rouge">base.OnGUI</code> 将其委托给基类的 <code class="language-plaintext highlighter-rouge">OnGUI</code> 方法。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">MyLightingShaderGUI</span> <span class="p">:</span> <span class="n">MyBaseShaderGUI</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnGUI</span> <span class="p">(</span>
        <span class="n">MaterialEditor</span> <span class="n">editor</span><span class="p">,</span> <span class="n">MaterialProperty</span><span class="p">[]</span> <span class="n">properties</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// this.target = editor.target as Material;</span>
        <span class="c1">// this.editor = editor;</span>
        <span class="c1">// this.properties = properties;</span>
        <span class="k">base</span><span class="p">.</span><span class="nf">OnGUI</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">properties</span><span class="p">);</span>
        <span class="nf">DoRenderingMode</span><span class="p">();</span>
        <span class="p">...</span>
        <span class="nf">DoAdvanced</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="52-三平面着色器-gui"><span class="me-2">5.2 三平面着色器 GUI</span><a href="#52-三平面着色器-gui" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>添加一个新的 <code class="language-plaintext highlighter-rouge">MyTriplanarShaderGUI</code> 类来创建我们三平面着色器的 GUI。让它继承 <code class="language-plaintext highlighter-rouge">MyBaseShaderGUI</code>。给它一个 <code class="language-plaintext highlighter-rouge">OnGUI</code> 方法，在其中调用 <code class="language-plaintext highlighter-rouge">base.OnGUI</code>，然后显示贴图缩放属性。使用独立的方法来处理贴图、混合和其他设置。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEditor</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">MyTriplanarShaderGUI</span> <span class="p">:</span> <span class="n">MyBaseShaderGUI</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnGUI</span> <span class="p">(</span>
        <span class="n">MaterialEditor</span> <span class="n">editor</span><span class="p">,</span> <span class="n">MaterialProperty</span><span class="p">[]</span> <span class="n">properties</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">base</span><span class="p">.</span><span class="nf">OnGUI</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">properties</span><span class="p">);</span>
        <span class="n">editor</span><span class="p">.</span><span class="nf">ShaderProperty</span><span class="p">(</span><span class="nf">FindProperty</span><span class="p">(</span><span class="s">"_MapScale"</span><span class="p">),</span> <span class="nf">MakeLabel</span><span class="p">(</span><span class="s">"Map Scale"</span><span class="p">));</span>
        <span class="nf">DoMaps</span><span class="p">();</span>
        <span class="nf">DoBlending</span><span class="p">();</span>
        <span class="nf">DoOtherSettings</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">DoMaps</span> <span class="p">()</span> <span class="p">{}</span>
    <span class="k">void</span> <span class="nf">DoBlending</span> <span class="p">()</span> <span class="p">{}</span>
    <span class="k">void</span> <span class="nf">DoOtherSettings</span> <span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>声明此类为我们三平面着色器的自定义编辑器。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">Shader</span> <span class="s">"Custom/Triplanar Mapping"</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">CustomEditor</span> <span class="s">"MyTriplanarShaderGUI"</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_39.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_39.png" alt="仅显示贴图缩放" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">仅显示贴图缩放</figcaption></figure><h3 id="53-贴图"><span class="me-2">5.3 贴图</span><a href="#53-贴图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>为贴图部分创建一个标签，然后在单行上显示三个纹理属性。为 MOHS 贴图提供提示工具，以解释每个通道应包含的内容。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">DoMaps</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">GUILayout</span><span class="p">.</span><span class="nf">Label</span><span class="p">(</span><span class="s">"Maps"</span><span class="p">,</span> <span class="n">EditorStyles</span><span class="p">.</span><span class="n">boldLabel</span><span class="p">);</span>
    
    <span class="n">editor</span><span class="p">.</span><span class="nf">TexturePropertySingleLine</span><span class="p">(</span>
        <span class="nf">MakeLabel</span><span class="p">(</span><span class="s">"Albedo"</span><span class="p">),</span> <span class="nf">FindProperty</span><span class="p">(</span><span class="s">"_MainTex"</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="n">editor</span><span class="p">.</span><span class="nf">TexturePropertySingleLine</span><span class="p">(</span>
        <span class="nf">MakeLabel</span><span class="p">(</span>
            <span class="s">"MOHS"</span><span class="p">,</span>
            <span class="s">"Metallic (R) Occlusion (G) Height (B) Smoothness (A)"</span>
        <span class="p">),</span>
        <span class="nf">FindProperty</span><span class="p">(</span><span class="s">"_MOHSMap"</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="n">editor</span><span class="p">.</span><span class="nf">TexturePropertySingleLine</span><span class="p">(</span>
        <span class="nf">MakeLabel</span><span class="p">(</span><span class="s">"Normals"</span><span class="p">),</span> <span class="nf">FindProperty</span><span class="p">(</span><span class="s">"_NormalMap"</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_40.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_40.png" alt="贴图 GUI" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">贴图 GUI</figcaption></figure><h3 id="54-混合"><span class="me-2">5.4 混合</span><a href="#54-混合" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>混合部分很简单，只需一个标签和三个属性。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">DoBlending</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">GUILayout</span><span class="p">.</span><span class="nf">Label</span><span class="p">(</span><span class="s">"Blending"</span><span class="p">,</span> <span class="n">EditorStyles</span><span class="p">.</span><span class="n">boldLabel</span><span class="p">);</span>
    <span class="n">editor</span><span class="p">.</span><span class="nf">ShaderProperty</span><span class="p">(</span><span class="nf">FindProperty</span><span class="p">(</span><span class="s">"_BlendOffset"</span><span class="p">),</span> <span class="nf">MakeLabel</span><span class="p">(</span><span class="s">"Offset"</span><span class="p">));</span>
    <span class="n">editor</span><span class="p">.</span><span class="nf">ShaderProperty</span><span class="p">(</span>
        <span class="nf">FindProperty</span><span class="p">(</span><span class="s">"_BlendExponent"</span><span class="p">),</span> <span class="nf">MakeLabel</span><span class="p">(</span><span class="s">"Exponent"</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="n">editor</span><span class="p">.</span><span class="nf">ShaderProperty</span><span class="p">(</span>
        <span class="nf">FindProperty</span><span class="p">(</span><span class="s">"_BlendHeightStrength"</span><span class="p">),</span> <span class="nf">MakeLabel</span><span class="p">(</span><span class="s">"Height Strength"</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_41.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_41.png" alt="混合 GUI" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">混合 GUI</figcaption></figure><h3 id="55-其他设置"><span class="me-2">5.5 其他设置</span><a href="#55-其他设置" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>对于其他设置，通过调用 <code class="language-plaintext highlighter-rouge">MaterialEditor.RenderQueueField</code> 允许自定义渲染队列。同时也能够切换 GPU 实例化。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">DoOtherSettings</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">GUILayout</span><span class="p">.</span><span class="nf">Label</span><span class="p">(</span><span class="s">"Other Settings"</span><span class="p">,</span> <span class="n">EditorStyles</span><span class="p">.</span><span class="n">boldLabel</span><span class="p">);</span>
    <span class="n">editor</span><span class="p">.</span><span class="nf">RenderQueueField</span><span class="p">();</span>
    <span class="n">editor</span><span class="p">.</span><span class="nf">EnableInstancingField</span><span class="p">();</span> 
<span class="p">}</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_42.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_42.png" alt="其他设置 GUI" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">其他设置 GUI</figcaption></figure><h2 id="6-独立的顶部贴图"><span class="me-2">6. 独立的顶部贴图</span><a href="#6-独立的顶部贴图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>通常，你不希望外观完全统一。最明显的例子是地形，其中水平表面——那些指向上的，而不是向下的——可以是草地，而所有其他表面可以是岩石。你甚至可能想将三平面映射与纹理溅射（texture splatting）相结合，但那很昂贵，因为需要更多的纹理采样。替代方法是依靠贴花（decals）、其他细节对象或顶点颜色来增加多样性。</p><h3 id="61-更多贴图"><span class="me-2">6.1 更多贴图</span><a href="#61-更多贴图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>为了支持独立的顶部贴图，我们需要添加三个替代贴图属性。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="nf">_MainTex</span> <span class="p">(</span><span class="s">"Albedo"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="nf">_MOHSMap</span> <span class="p">(</span><span class="s">"MOHS"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="nf">_NormalMap</span> <span class="p">(</span><span class="s">"Normals"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="nf">_TopMainTex</span> <span class="p">(</span><span class="s">"Top Albedo"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="nf">_TopMOHSMap</span> <span class="p">(</span><span class="s">"Top MOHS"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="nf">_TopNormalMap</span> <span class="p">(</span><span class="s">"Top Normals"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
</pre></table></code></div></div><p>并非总是需要独立的顶部贴图，因此我们将其设为一个着色器特性，使用 <code class="language-plaintext highlighter-rouge">_SEPARATE_TOP_MAPS</code> 关键字。除了阴影通道外，为所有通道添加对它的支持。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="cp">#pragma target 3.0
#pragma shader_feature _SEPARATE_TOP_MAPS
</span></pre></table></code></div></div><p>将这些额外的贴图添加到我们的着色器 GUI 中。使用顶部反照率贴图来确定是否应设置该关键字。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="k">void</span> <span class="nf">DoMaps</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">GUILayout</span><span class="p">.</span><span class="nf">Label</span><span class="p">(</span><span class="s">"Top Maps"</span><span class="p">,</span> <span class="n">EditorStyles</span><span class="p">.</span><span class="n">boldLabel</span><span class="p">);</span>
    <span class="n">MaterialProperty</span> <span class="n">topAlbedo</span> <span class="p">=</span> <span class="nf">FindProperty</span><span class="p">(</span><span class="s">"_TopMainTex"</span><span class="p">);</span>
    <span class="n">Texture</span> <span class="n">topTexture</span> <span class="p">=</span> <span class="n">topAlbedo</span><span class="p">.</span><span class="n">textureValue</span><span class="p">;</span>
    <span class="n">EditorGUI</span><span class="p">.</span><span class="nf">BeginChangeCheck</span><span class="p">();</span>
    <span class="n">editor</span><span class="p">.</span><span class="nf">TexturePropertySingleLine</span><span class="p">(</span><span class="nf">MakeLabel</span><span class="p">(</span><span class="s">"Albedo"</span><span class="p">),</span> <span class="n">topAlbedo</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">EditorGUI</span><span class="p">.</span><span class="nf">EndChangeCheck</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="n">topTexture</span> <span class="p">!=</span> <span class="n">topAlbedo</span><span class="p">.</span><span class="n">textureValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">SetKeyword</span><span class="p">(</span><span class="s">"_SEPARATE_TOP_MAPS"</span><span class="p">,</span> <span class="n">topAlbedo</span><span class="p">.</span><span class="n">textureValue</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">editor</span><span class="p">.</span><span class="nf">TexturePropertySingleLine</span><span class="p">(</span>
        <span class="nf">MakeLabel</span><span class="p">(</span>
            <span class="s">"MOHS"</span><span class="p">,</span>
            <span class="s">"Metallic (R) Occlusion (G) Height (B) Smoothness (A)"</span>
        <span class="p">),</span>
        <span class="nf">FindProperty</span><span class="p">(</span><span class="s">"_TopMOHSMap"</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="n">editor</span><span class="p">.</span><span class="nf">TexturePropertySingleLine</span><span class="p">(</span>
        <span class="nf">MakeLabel</span><span class="p">(</span><span class="s">"Normals"</span><span class="p">),</span> <span class="nf">FindProperty</span><span class="p">(</span><span class="s">"_TopNormalMap"</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="n">GUILayout</span><span class="p">.</span><span class="nf">Label</span><span class="p">(</span><span class="s">"Maps"</span><span class="p">,</span> <span class="n">EditorStyles</span><span class="p">.</span><span class="n">boldLabel</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="62-使用大理石"><span class="me-2">6.2 使用大理石</span><a href="#62-使用大理石" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>要查看实际运行中的独立顶部贴图，我们需要另一组纹理。我们可以使用大理石反照率和法线贴图。这里是配套的 MOHS 贴图。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_43.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_43.png" alt="大理石 MOHS 贴图" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">大理石 MOHS 贴图</figcaption></figure><p>顶部使用电路——因为它是绿色的，所以有点像草——其余部分使用大理石。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_44.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_44.png" alt="顶部为电路，其余为大理石" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">顶部为电路，其余为大理石</figcaption></figure><p>由于着色器还不了解顶部贴图，我们目前只能看到大理石。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_45.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_45.png" alt="仅显示大理石" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">仅显示大理石</figcaption></figure><h3 id="63-启用顶部贴图"><span class="me-2">6.3 启用顶部贴图</span><a href="#63-启用顶部贴图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>向 <code class="language-plaintext highlighter-rouge">MyTriplanarMapping</code> 添加所需的采样器变量。在所有纹理采样后，检查关键字是否在 <code class="language-plaintext highlighter-rouge">MyTriPlanarSurfaceFunction</code> 中定义。如果是，添加代码以用顶部贴图的采样覆盖 Y 投影的数据。但仅对向上的表面执行此操作，即表面法线具有正 Y 分量时。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">sampler2D</span> <span class="n">_TopMainTex</span><span class="p">,</span> <span class="n">_TopMOHSMap</span><span class="p">,</span> <span class="n">_TopNormalMap</span><span class="p">;</span>
<span class="p">...</span>
<span class="k">void</span> <span class="nf">MyTriPlanarSurfaceFunction</span> <span class="p">(</span>
    <span class="n">inout</span> <span class="n">SurfaceData</span> <span class="n">surface</span><span class="p">,</span> <span class="n">SurfaceParameters</span> <span class="n">parameters</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">float3</span> <span class="n">tangentNormalZ</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">z</span><span class="p">));</span>
    <span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">_SEPARATE_TOP_MAPS</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">y</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">albedoY</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_TopMainTex</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
            <span class="n">mohsY</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_TopMOHSMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
            <span class="n">tangentNormalY</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_TopNormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="err">#</span><span class="n">endif</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p><strong>如果所有表面都指向上的话？</strong></p><p>在典型的基于高度图的地形网格的情况下，所有表面法线都保证指向向上。因此，不需要检查法线的 Y 分量是否为正，可以省略。</p></blockquote><p>这导致着色器会根据 Y 投影对常规贴图或顶部贴图进行采样。在我们的案例中，我们在大理石顶部得到了一个电路层。通常它是草、沙或雪。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_46.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_46.png" alt="顶部电路" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">顶部电路</figcaption></figure><p>默认混合设置在投影之间产生相当平滑的混合，在电路和大理石交汇的地方看起来不太好。指数设为 8 会导致更突然的过渡，这更适合这些材料。也可以为顶部贴图支持不同的混合设置，但高度混合已经允许通过 MOHS 贴图进行大量控制。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_47.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_47.png" alt="指数设为 8" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">指数设为 8</figcaption></figure><h3 id="64-稍后解包"><span class="me-2">6.4 稍后解包</span><a href="#64-稍后解包" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>虽然着色器编译器使用 if-else 方法聪明地采样顶部或常规贴图，但它在解包法线方面不够聪明。它不能假设 <code class="language-plaintext highlighter-rouge">UnpackNormal</code> 的两次使用可以合并。为了帮助编译器，我们可以推迟解包原始法线，直到选择贴图之后。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">float3</span> <span class="n">tangentNormalX</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">x</span><span class="p">));</span>
<span class="c1">// float3 tangentNormalY = UnpackNormal(tex2D(_NormalMap, triUV.y));</span>
<span class="n">float4</span> <span class="n">rawNormalY</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="n">float3</span> <span class="n">tangentNormalZ</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_NormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">z</span><span class="p">));</span>
<span class="cp">#if defined(_SEPARATE_TOP_MAPS)
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">y</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">albedoY</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_TopMainTex</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
        <span class="n">mohsY</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_TopMOHSMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
        <span class="c1">// tangentNormalY = UnpackNormal(tex2D(_TopNormalMap, triUV.y));</span>
        <span class="n">rawNormalY</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_TopNormalMap</span><span class="p">,</span> <span class="n">triUV</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif
</span><span class="n">float3</span> <span class="n">tangentNormalY</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="n">rawNormalY</span><span class="p">);</span>
</pre></table></code></div></div><h2 id="7-光照贴图-lightmapping"><span class="me-2">7. 光照贴图 (Lightmapping)</span><a href="#7-光照贴图-lightmapping" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>我们的三平面着色器还没有完成，因为它还不支持光照贴图。它可以接收烘培光照，但它并不对其做出贡献。通过将所有对象设为静态并将方向光切换到烘培模式最容易看到这一点。等待烘培完成，然后通过将场景视图模式从“着色（Shaded）”切换到“烘培全局光照 / 反照率（Baked Global Illumination / Albedo）”来检查烘培的反照率。所有使用三平面映射的对象都变成了黑色。</p><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_48.png" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_48.png" alt="光照贴图使用黑色反照率" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">光照贴图使用黑色反照率</figcaption></figure><p>要支持光照贴图，我们必须向着色器添加一个 meta 通道，它必须依赖 <code class="language-plaintext highlighter-rouge">My Lightmapping</code> 而不是 <code class="language-plaintext highlighter-rouge">My Lighting</code>。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">Pass</span> <span class="p">{</span>
    <span class="n">Tags</span> <span class="p">{</span> <span class="s">"LightMode"</span> <span class="p">=</span> <span class="s">"Meta"</span> <span class="p">}</span>
    <span class="n">Cull</span> <span class="n">Off</span>
    <span class="n">CGPROGRAM</span>
    <span class="err">#</span><span class="n">pragma</span> <span class="n">vertex</span> <span class="n">MyLightmappingVertexProgram</span>
    <span class="err">#</span><span class="n">pragma</span> <span class="n">fragment</span> <span class="n">MyLightmappingFragmentProgram</span>
    <span class="err">#</span><span class="n">pragma</span> <span class="n">shader_feature</span> <span class="n">_SEPARATE_TOP_MAPS</span>
    <span class="err">#</span><span class="n">include</span> <span class="s">"MyTriplanarMapping.cginc"</span>
    <span class="err">#</span><span class="n">include</span> <span class="s">"My Lightmapping.cginc"</span>
    <span class="n">ENDCG</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="71-使用表面数据"><span class="me-2">7.1 使用表面数据</span><a href="#71-使用表面数据" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>为了让 <code class="language-plaintext highlighter-rouge">My Lightmapping</code> 配合我们的三平面方法工作，它也必须支持新的表面方法。为了方便，让它包含 <code class="language-plaintext highlighter-rouge">My Lighting Input</code> 并删除所有现在重复的变量、插值器和 getter 函数。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c1">//#include "UnityPBSLighting.cginc"</span>
<span class="err">#</span><span class="n">include</span> <span class="s">"My Lighting Input.cginc"</span>
<span class="err">#</span><span class="n">include</span> <span class="s">"UnityMetaPass.cginc"</span>
<span class="c1">//float4 _Color;</span>
<span class="c1">//...</span>
<span class="c1">//</span>
<span class="c1">//float3 GetEmission (Interpolators i) {</span>
<span class="c1">// ...</span>
<span class="c1">//}</span>
<span class="n">Interpolators</span> <span class="nf">MyLightmappingVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
<span class="n">float4</span> <span class="nf">MyLightmappingFragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>像 <code class="language-plaintext highlighter-rouge">My Lighting</code> 一样，它必须定义默认的反照率函数。并且它应该在 <code class="language-plaintext highlighter-rouge">MyLightmappingFragmentProgram</code> 中使用相同的表面方法，除了它只关心反照率、发射、金属度和光滑度。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="cp">#if !defined(ALBEDO_FUNCTION)
</span>    <span class="err">#</span><span class="n">define</span> <span class="n">ALBEDO_FUNCTION</span> <span class="n">GetAlbedo</span>
<span class="cp">#endif
</span>
<span class="n">float4</span> <span class="nf">MyLightmappingFragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="n">SurfaceData</span> <span class="n">surface</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">emission</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">metallic</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">occlusion</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
    <span class="n">surface</span><span class="p">.</span><span class="n">smoothness</span> <span class="p">=</span> <span class="m">0.5</span><span class="p">;</span>
    <span class="err">#</span><span class="k">if</span> <span class="nf">defined</span><span class="p">(</span><span class="n">SURFACE_FUNCTION</span><span class="p">)</span>
        <span class="n">SurfaceParameters</span> <span class="n">sp</span><span class="p">;</span>
        <span class="n">sp</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">;</span>
        <span class="n">sp</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">worldPos</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
        <span class="n">sp</span><span class="p">.</span><span class="n">uv</span> <span class="p">=</span> <span class="nf">UV_FUNCTION</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="nf">SURFACE_FUNCTION</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
    <span class="err">#</span><span class="k">else</span>
        <span class="n">surface</span><span class="p">.</span><span class="n">albedo</span> <span class="p">=</span> <span class="nf">ALBEDO_FUNCTION</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">surface</span><span class="p">.</span><span class="n">emission</span> <span class="p">=</span> <span class="nf">GetEmission</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">surface</span><span class="p">.</span><span class="n">metallic</span> <span class="p">=</span> <span class="nf">GetMetallic</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">surface</span><span class="p">.</span><span class="n">smoothness</span> <span class="p">=</span> <span class="nf">GetSmoothness</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="err">#</span><span class="n">endif</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>用新的表面数据替换 getter 函数的旧用法。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">float4</span> <span class="nf">MyLightmappingFragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="p">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">UnityMetaInput</span> <span class="n">surfaceData</span><span class="p">;</span>
    <span class="n">surfaceData</span><span class="p">.</span><span class="n">Emission</span> <span class="p">=</span> <span class="n">surface</span><span class="p">.</span><span class="n">emission</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">oneMinusReflectivity</span><span class="p">;</span>
    <span class="n">surfaceData</span><span class="p">.</span><span class="n">Albedo</span> <span class="p">=</span> <span class="nf">DiffuseAndSpecularFromMetallic</span><span class="p">(</span>
        <span class="n">surface</span><span class="p">.</span><span class="n">albedo</span><span class="p">,</span> <span class="n">surface</span><span class="p">.</span><span class="n">metallic</span><span class="p">,</span>
        <span class="n">surfaceData</span><span class="p">.</span><span class="n">SpecularColor</span><span class="p">,</span> <span class="n">oneMinusReflectivity</span>
    <span class="p">);</span>
    <span class="kt">float</span> <span class="n">roughness</span> <span class="p">=</span> <span class="nf">SmoothnessToRoughness</span><span class="p">(</span><span class="n">surface</span><span class="p">.</span><span class="n">smoothness</span><span class="p">)</span> <span class="p">*</span> <span class="m">0.5</span><span class="p">;</span>
    <span class="n">surfaceData</span><span class="p">.</span><span class="n">Albedo</span> <span class="p">+=</span> <span class="n">surfaceData</span><span class="p">.</span><span class="n">SpecularColor</span> <span class="p">*</span> <span class="n">roughness</span><span class="p">;</span>
    <span class="k">return</span> <span class="nf">UnityMetaFragment</span><span class="p">(</span><span class="n">surfaceData</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="72-包含相关输入"><span class="me-2">7.2 包含相关输入</span><a href="#72-包含相关输入" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>插值器现在还包括法线和世界位置向量，因此应该在 <code class="language-plaintext highlighter-rouge">MyLightMappingVertexProgram</code> 中设置它们。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">Interpolators</span> <span class="nf">MyLightmappingVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Interpolators</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">i</span><span class="p">.</span><span class="n">pos</span> <span class="p">=</span> <span class="nf">UnityMetaVertexPosition</span><span class="p">(</span>
        <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">uv1</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">uv2</span><span class="p">,</span> <span class="n">unity_LightmapST</span><span class="p">,</span> <span class="n">unity_DynamicLightmapST</span>
    <span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">UnityObjectToWorldNormal</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">worldPos</span><span class="p">.</span><span class="n">xyz</span> <span class="p">=</span> <span class="nf">mul</span><span class="p">(</span><span class="n">unity_ObjectToWorld</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="p">=</span> <span class="nf">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span> <span class="p">=</span> <span class="nf">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_DetailTex</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这些向量通常不需要，所以我们可以在不需要时跳过计算它们，只需改用虚拟常量。我们可以定义两个宏 <code class="language-plaintext highlighter-rouge">META_PASS_NEEDS_NORMALS</code> 和 <code class="language-plaintext highlighter-rouge">META_PASS_NEEDS_POSITION</code> 来指示是否需要它们。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="cp">#if defined(META_PASS_NEEDS_NORMALS)
</span>    <span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">UnityObjectToWorldNormal</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
<span class="cp">#else
</span>    <span class="n">i</span><span class="p">.</span><span class="n">normal</span> <span class="p">=</span> <span class="nf">float3</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
<span class="cp">#endif
</span>
<span class="cp">#if defined(META_PASS_NEEDS_POSITION)
</span>    <span class="n">i</span><span class="p">.</span><span class="n">worldPos</span><span class="p">.</span><span class="n">xyz</span> <span class="p">=</span> <span class="nf">mul</span><span class="p">(</span><span class="n">unity_ObjectToWorld</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
<span class="cp">#else
</span>    <span class="n">i</span><span class="p">.</span><span class="n">worldPos</span><span class="p">.</span><span class="n">xyz</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="cp">#endif
</span></pre></table></code></div></div><p>此外，仅在需要时包含 UV 坐标。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="cp">#if !defined(NO_DEFAULT_UV)
</span>    <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="p">=</span> <span class="nf">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span> <span class="p">=</span> <span class="nf">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_DetailTex</span><span class="p">);</span>
<span class="cp">#endif
</span></pre></table></code></div></div><h3 id="73-三平面光照贴图"><span class="me-2">7.3 三平面光照贴图</span><a href="#73-三平面光照贴图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>剩下要做的就是声明我们的三平面着色器在其 meta 通道中同时需要法线和位置数据。一旦完成并且光照再次烘培，反照率将正确显示在场景视图中。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="cp">#pragma shader_feature _SEPARATE_TOP_MAPS
#define META_PASS_NEEDS_NORMALS
#define META_PASS_NEEDS_POSITION
</span><span class="err">#</span><span class="n">include</span> <span class="s">"MyTriplanarMapping.cginc"</span>
<span class="err">#</span><span class="n">include</span> <span class="s">"My Lightmapping.cginc"</span>
</pre></table></code></div></div><figure style="margin:1rem 0;"><div style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;"><div style="flex:0 1 auto;min-width:150px;max-width:300px;"> <a href="https://img.damonc.top/posts/2018/month1/catRender27/image_50.jpg" class="popup img-link shimmer" class="img-link shimmer" ><img src="https://img.damonc.top/posts/2018/month1/catRender27/image_50.jpg" alt="正确光照贴图的反照率" width="100%" height="auto" loading="lazy"></a></div></div><figcaption class="text-center pt-2 pb-2" style="font-size:0.8em;color:var(--text-color-secondary);">正确光照贴图的反照率</figcaption></figure><p>现在我们的三平面着色器已完全正常工作。你可以将其作为你自己工作的基础，根据需要进行扩展、微调和调整。</p><aside class="collapsible-aside"><h3>光照贴图数据似乎不依赖于世界空间？</h3><div><p>确实，当进行光照贴图时，我们最终使用的是对象空间而不是世界空间。发生这种情况是因为 Unity 没有为 meta 通道设置对象到世界的变换矩阵。其结果是 meta 通道仅对位于原点且没有旋转或缩放调整的对象正确工作。因此它适用于典型的地形，但不适用于其他事物。对于其他对象，它仍然是可行的，只要材料大多是统一的并且顶部正确对齐（如果使用了独立贴图）。</p></div></aside></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/unity3d/">Unity3D</a>, <a href="/categories/rendering/">Rendering</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/shader/" class="post-tag no-text-decoration" >Shader</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%E4%B8%89%E5%B9%B3%E9%9D%A2%E6%98%A0%E5%B0%84(%E7%BF%BB%E8%AF%91%E4%BA%8C%E5%8D%81%E4%B8%83)%20-%20%E4%BB%97%E5%89%91%E5%A4%A9%E6%B6%AF&url=www.damonc.top%2Fposts%2Ftriplanar-mapping%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%E4%B8%89%E5%B9%B3%E9%9D%A2%E6%98%A0%E5%B0%84(%E7%BF%BB%E8%AF%91%E4%BA%8C%E5%8D%81%E4%B8%83)%20-%20%E4%BB%97%E5%89%91%E5%A4%A9%E6%B6%AF&u=www.damonc.top%2Fposts%2Ftriplanar-mapping%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=www.damonc.top%2Fposts%2Ftriplanar-mapping%2F&text=%E4%B8%89%E5%B9%B3%E9%9D%A2%E6%98%A0%E5%B0%84(%E7%BF%BB%E8%AF%91%E4%BA%8C%E5%8D%81%E4%B8%83)%20-%20%E4%BB%97%E5%89%91%E5%A4%A9%E6%B6%AF" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/particles/">粒子系统：颜色和深度纹理</a><li class="text-truncate lh-lg"> <a href="/posts/color-grading/">Unity自定义渲染管线13：色彩分级</a><li class="text-truncate lh-lg"> <a href="/posts/post-processing/">自定义渲染管线:后处理 (翻译十一)</a><li class="text-truncate lh-lg"> <a href="/posts/hdr/">自定义渲染管线:HDR (翻译十二)</a><li class="text-truncate lh-lg"> <a href="/posts/point-spot-light-shadow/">自定义渲染管线:点光源与聚光灯阴影 (翻译十)</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/shader/">Shader</a> <a class="post-tag btn btn-outline-primary" href="/tags/srp/">SRP</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai/">AI</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli-agent/">CLI Agent</a> <a class="post-tag btn btn-outline-primary" href="/tags/best-practices/">Best Practices</a> <a class="post-tag btn btn-outline-primary" href="/tags/bloom/">Bloom</a> <a class="post-tag btn btn-outline-primary" href="/tags/point-light/">Point Light</a> <a class="post-tag btn btn-outline-primary" href="/tags/post-processing/">Post Processing</a> <a class="post-tag btn btn-outline-primary" href="/tags/shadows/">Shadows</a> <a class="post-tag btn btn-outline-primary" href="/tags/spot-light/">Spot Light</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/Unity_ShaderGUI_Extension_2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1515333600" data-df="ll" > Jan 7, 2018 </time><h4 class="pt-0 my-2">Unity Shader GUI 扩展二(翻译十)</h4><div class="text-muted"><p>本篇摘要: 把自身阴影烘焙进材质 增加细节纹理部分 支持更丰富的shader变体 一次编辑多个材质球 遮挡区域的Self-Shading 美术能够创作非常复杂丰富的表面纹理，它只是一个视错觉。为了增强表面纹理视觉真实感，引入Self-Shading。 如何增强呢？通常我们使用了法线来增强模型表面的凹凸层次感，法线带来的视觉增强是第一步，但是法线只适用于采样直接光...</p></div></div></a></article><article class="col"> <a href="/posts/Unity_ShaderGUI_Extension_1/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1515326400" data-df="ll" > Jan 7, 2018 </time><h4 class="pt-0 my-2">Unity Shader GUI 扩展一(翻译九)</h4><div class="text-muted"><p>选中当前材质后，若材质使用的Shader调用了GUI拓展，则会自动读取该Shader的所有属性。通过重实现OnGUI函数后，获取其参数地址就能读取。</p></div></div></a></article><article class="col"> <a href="/posts/Unity_Reflection/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1515240000" data-df="ll" > Jan 6, 2018 </time><h4 class="pt-0 my-2">Unity Reflection 反射(翻译八)</h4><div class="text-muted"><p>一块完美的镜子是不会发生漫反射，但现在我们自己的Shader包含的光照：环境光、漫反射、高光反射、纹理、阴影，结果看起来蛮好。但是当把Metallic设为1，Smoothness设位0.95，看起来很亮就很不自然了。从下图看尽管颜色是白色但整个表面都是黑色，只有一个很小的高亮点。这个亮点形成1是光源的入射，2朝向观察者的反射。</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/unity-fxaa/" class="btn btn-outline-primary" aria-label="Older" ><p>FXAA像素平滑(翻译二十六)</p></a> <a href="/posts/custom-render-pipeline/" class="btn btn-outline-primary" aria-label="Newer" ><p>自定义渲染管线:初识渲染流程 (翻译一)</p></a></nav><div id="waline-container" class="mt-5 pt-4" style="border-top: 1px dashed #ccc; padding-top: 20px;"><div id="waline"></div></div><link rel="stylesheet" href="/assets/css/waline.css"> <script type="module"> window.WalinePrefix = "/pro"; const observer = new IntersectionObserver((entries) => { if (entries[0].isIntersecting) { observer.disconnect(); import('/assets/js/dist/waline.min.js').then(({ init }) => { init({ el: '#waline', serverURL: 'https://comments.damonc.top', dark: 'html[data-mode="dark"]', emoji: [ 'https://fastly.jsdelivr.net/npm/@waline/emojis@1.4.0/qq' ], reaction: true, pageview: false }); }); } }); observer.observe(document.getElementById('waline-container')); </script><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2026</time> <a href="https://github.com/damonc-top">仗剑天涯</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>The blog is powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/shader/">Shader</a> <a class="post-tag btn btn-outline-primary" href="/tags/srp/">SRP</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai/">AI</a> <a class="post-tag btn btn-outline-primary" href="/tags/cli-agent/">CLI Agent</a> <a class="post-tag btn btn-outline-primary" href="/tags/best-practices/">Best Practices</a> <a class="post-tag btn btn-outline-primary" href="/tags/bloom/">Bloom</a> <a class="post-tag btn btn-outline-primary" href="/tags/point-light/">Point Light</a> <a class="post-tag btn btn-outline-primary" href="/tags/post-processing/">Post Processing</a> <a class="post-tag btn btn-outline-primary" href="/tags/shadows/">Shadows</a> <a class="post-tag btn btn-outline-primary" href="/tags/spot-light/">Spot Light</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
